{
  "author": {
    "id": "ImproperSubset",
    "display_name": "ImproperSubset",
    "type": "User",
    "avatar_url": "https://avatars.githubusercontent.com/u/1039371?v=4",
    "url": "https://github.com/ImproperSubset",
    "bio": null,
    "stats": {
      "total_marketplaces": 1,
      "total_plugins": 2,
      "total_commands": 0,
      "total_skills": 21,
      "total_stars": 0,
      "total_forks": 0
    }
  },
  "marketplaces": [
    {
      "name": "hh-agentics",
      "version": null,
      "description": "HouseHudson agentic AI plugins: governance skills for AI code assistants and Foundry VTT development patterns",
      "owner_info": {
        "name": "ImproperSubset",
        "email": "impropersubset@users.noreply.github.com"
      },
      "keywords": [],
      "repo_full_name": "ImproperSubset/hh-agentics",
      "repo_url": "https://github.com/ImproperSubset/hh-agentics",
      "repo_description": "HouseHudson agentic AI plugins: governance skills for AI code assistants and Foundry VTT development patterns",
      "homepage": null,
      "signals": {
        "stars": 0,
        "forks": 0,
        "pushed_at": "2026-01-15T03:41:43Z",
        "created_at": "2026-01-04T18:53:30Z",
        "license": null
      },
      "file_tree": [
        {
          "path": ".claude-plugin",
          "type": "tree",
          "size": null
        },
        {
          "path": ".claude-plugin/marketplace.json",
          "type": "blob",
          "size": 1891
        },
        {
          "path": "cc-governance",
          "type": "tree",
          "size": null
        },
        {
          "path": "cc-governance/.claude-plugin",
          "type": "tree",
          "size": null
        },
        {
          "path": "cc-governance/.claude-plugin/plugin.json",
          "type": "blob",
          "size": 716
        },
        {
          "path": "cc-governance/hooks",
          "type": "tree",
          "size": null
        },
        {
          "path": "cc-governance/hooks/hooks.json",
          "type": "blob",
          "size": 972
        },
        {
          "path": "cc-governance/skills",
          "type": "tree",
          "size": null
        },
        {
          "path": "cc-governance/skills/cc-development-workflow",
          "type": "tree",
          "size": null
        },
        {
          "path": "cc-governance/skills/cc-development-workflow/SKILL.md",
          "type": "blob",
          "size": 11641
        },
        {
          "path": "cc-governance/skills/cc-plugin-extensions",
          "type": "tree",
          "size": null
        },
        {
          "path": "cc-governance/skills/cc-plugin-extensions/SKILL.md",
          "type": "blob",
          "size": 4368
        },
        {
          "path": "cc-governance/skills/documentation-management",
          "type": "tree",
          "size": null
        },
        {
          "path": "cc-governance/skills/documentation-management/SKILL.md",
          "type": "blob",
          "size": 13452
        },
        {
          "path": "cc-governance/skills/git-branching-strategy",
          "type": "tree",
          "size": null
        },
        {
          "path": "cc-governance/skills/git-branching-strategy/SKILL.md",
          "type": "blob",
          "size": 13323
        },
        {
          "path": "fvtt-dev",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/.claude-plugin",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/.claude-plugin/plugin.json",
          "type": "blob",
          "size": 1218
        },
        {
          "path": "fvtt-dev/skills",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/skills/fvtt-active-effects",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/skills/fvtt-active-effects/SKILL.md",
          "type": "blob",
          "size": 9601
        },
        {
          "path": "fvtt-dev/skills/fvtt-applications",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/skills/fvtt-applications/SKILL.md",
          "type": "blob",
          "size": 9804
        },
        {
          "path": "fvtt-dev/skills/fvtt-canvas",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/skills/fvtt-canvas/SKILL.md",
          "type": "blob",
          "size": 9790
        },
        {
          "path": "fvtt-dev/skills/fvtt-chat-messages",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/skills/fvtt-chat-messages/SKILL.md",
          "type": "blob",
          "size": 9486
        },
        {
          "path": "fvtt-dev/skills/fvtt-combat",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/skills/fvtt-combat/SKILL.md",
          "type": "blob",
          "size": 9340
        },
        {
          "path": "fvtt-dev/skills/fvtt-compendiums",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/skills/fvtt-compendiums/SKILL.md",
          "type": "blob",
          "size": 8268
        },
        {
          "path": "fvtt-dev/skills/fvtt-data-migrations",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/skills/fvtt-data-migrations/SKILL.md",
          "type": "blob",
          "size": 19392
        },
        {
          "path": "fvtt-dev/skills/fvtt-data-storage",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/skills/fvtt-data-storage/SKILL.md",
          "type": "blob",
          "size": 11004
        },
        {
          "path": "fvtt-dev/skills/fvtt-dice-rolls",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/skills/fvtt-dice-rolls/SKILL.md",
          "type": "blob",
          "size": 11249
        },
        {
          "path": "fvtt-dev/skills/fvtt-error-handling",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/skills/fvtt-error-handling/SKILL.md",
          "type": "blob",
          "size": 16418
        },
        {
          "path": "fvtt-dev/skills/fvtt-hooks",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/skills/fvtt-hooks/SKILL.md",
          "type": "blob",
          "size": 9442
        },
        {
          "path": "fvtt-dev/skills/fvtt-localization",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/skills/fvtt-localization/SKILL.md",
          "type": "blob",
          "size": 9242
        },
        {
          "path": "fvtt-dev/skills/fvtt-performance-safe-updates",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/skills/fvtt-performance-safe-updates/SKILL.md",
          "type": "blob",
          "size": 13650
        },
        {
          "path": "fvtt-dev/skills/fvtt-sheets",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/skills/fvtt-sheets/SKILL.md",
          "type": "blob",
          "size": 13921
        },
        {
          "path": "fvtt-dev/skills/fvtt-sockets",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/skills/fvtt-sockets/SKILL.md",
          "type": "blob",
          "size": 11454
        },
        {
          "path": "fvtt-dev/skills/fvtt-v13-migration",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/skills/fvtt-v13-migration/SKILL.md",
          "type": "blob",
          "size": 8469
        },
        {
          "path": "fvtt-dev/skills/fvtt-version-compat",
          "type": "tree",
          "size": null
        },
        {
          "path": "fvtt-dev/skills/fvtt-version-compat/SKILL.md",
          "type": "blob",
          "size": 19089
        }
      ],
      "files": {
        ".claude-plugin/marketplace.json": "{\n  \"$schema\": \"https://anthropic.com/claude-code/marketplace.schema.json\",\n  \"name\": \"hh-agentics\",\n  \"description\": \"HouseHudson agentic AI plugins: governance skills for AI code assistants and Foundry VTT development patterns\",\n  \"owner\": {\n    \"name\": \"ImproperSubset\",\n    \"email\": \"impropersubset@users.noreply.github.com\"\n  },\n  \"plugins\": [\n    {\n      \"name\": \"cc-governance\",\n      \"description\": \"Reusable governance skills and hooks for AI code assistants: delegation policies, development workflows, documentation management, git branching, plugin extensions, and automatic skill activation\",\n      \"version\": \"1.2.4\",\n      \"author\": {\n        \"name\": \"ImproperSubset\",\n        \"email\": \"impropersubset@users.noreply.github.com\"\n      },\n      \"source\": \"./cc-governance\",\n      \"category\": \"productivity\",\n      \"homepage\": \"https://github.com/ImproperSubset/hh-agentics\",\n      \"repository\": \"https://github.com/ImproperSubset/hh-agentics\",\n      \"license\": \"MIT\",\n      \"keywords\": [\"governance\", \"workflow\", \"documentation\", \"git\", \"best-practices\"]\n    },\n    {\n      \"name\": \"fvtt-dev\",\n      \"description\": \"Comprehensive skills for Foundry VTT module development: V13 migration, multi-client safety, version compatibility, data migrations, error handling, hooks, data storage, sheets, dice rolling, sockets, active effects, canvas, localization, compendiums, combat, chat messages, and applications\",\n      \"version\": \"1.10.0\",\n      \"author\": {\n        \"name\": \"ImproperSubset\",\n        \"email\": \"impropersubset@users.noreply.github.com\"\n      },\n      \"source\": \"./fvtt-dev\",\n      \"category\": \"development\",\n      \"homepage\": \"https://github.com/ImproperSubset/hh-agentics\",\n      \"repository\": \"https://github.com/ImproperSubset/hh-agentics\",\n      \"license\": \"MIT\",\n      \"keywords\": [\"foundry-vtt\", \"fvtt\", \"module-development\", \"v13\", \"game-system\"]\n    }\n  ]\n}\n",
        "cc-governance/.claude-plugin/plugin.json": "{\n  \"name\": \"cc-governance\",\n  \"version\": \"1.2.4\",\n  \"description\": \"Reusable governance skills and hooks for AI code assistants: delegation policies, development workflows, documentation management, git branching, plugin extensions, and automatic skill activation\",\n  \"author\": {\n    \"name\": \"ImproperSubset\",\n    \"email\": \"impropersubset@users.noreply.github.com\"\n  },\n  \"repository\": \"https://github.com/ImproperSubset/hh-agentics\",\n  \"license\": \"MIT\",\n  \"keywords\": [\"governance\", \"workflow\", \"documentation\", \"git\", \"best-practices\"],\n  \"skills\": [\n    \"./skills/cc-development-workflow\",\n    \"./skills/cc-plugin-extensions\",\n    \"./skills/documentation-management\",\n    \"./skills/git-branching-strategy\"\n  ]\n}\n",
        "cc-governance/hooks/hooks.json": "{\n  \"description\": \"Governance hooks for tracking visibility\",\n  \"hooks\": {\n    \"SessionStart\": [\n      {\n        \"hooks\": [\n          {\n            \"type\": \"command\",\n            \"command\": \"MSG=\\\"\\\"; PROJECT_ACTIVE=\\\"$CLAUDE_PROJECT_DIR/docs/tracking/ACTIVE.md\\\"; META_DIR=\\\"$HOME/git/hh-meta/tracking\\\"; if [ -f \\\"$PROJECT_ACTIVE\\\" ]; then MSG=\\\"ğŸ“ Project tracking: docs/tracking/ACTIVE.md\\\"; fi; if [ -d \\\"$META_DIR\\\" ]; then [ -n \\\"$MSG\\\" ] && MSG=\\\"$MSG | \\\"; MSG=\\\"${MSG}ğŸ“ Cross-project: ~/git/hh-meta/tracking/\\\"; fi; if [ -n \\\"$MSG\\\" ]; then echo \\\"{\\\\\\\"systemMessage\\\\\\\": \\\\\\\"$MSG\\\\\\\"}\\\"; fi\",\n            \"timeout\": 5\n          }\n        ]\n      }\n    ],\n    \"SubagentStop\": [\n      {\n        \"hooks\": [\n          {\n            \"type\": \"command\",\n            \"command\": \"echo '{\\\"systemMessage\\\": \\\"ğŸ“‹ Subagent completed: '$CLAUDE_SUBAGENT_TYPE' (model: '$CLAUDE_SUBAGENT_MODEL')\\\"}'\",\n            \"timeout\": 5\n          }\n        ]\n      }\n    ]\n  }\n}\n",
        "cc-governance/skills/cc-development-workflow/SKILL.md": "---\nname: cc-development-workflow\ndescription: This skill should be used when starting any feature or bug fix, exploring unfamiliar code, making commits or PRs, or when unsure which agent or approach to use. Covers agent routing, git discipline, testing workflow, and proactive quality practices.\n---\n\n# Development Workflow\n\n**Purpose:** Establish efficient, high-quality development practices using AI code assistant agents and tools.\n\n**Category:** Meta-Skill (Development Process)\n\n---\n\n## When to Use This Skill\n\nThis skill applies **throughout the entire development lifecycle**:\n\n- Starting any new feature or bug fix\n- Exploring unfamiliar code\n- Making architectural decisions\n- Committing changes\n- Creating pull requests\n- Reviewing code quality\n\n**Triggers:**\n- User requests a new feature\n- User asks \"where is...\" or \"how does...\" questions\n- You're about to implement without planning\n- You're about to commit changes\n- User asks for a PR\n\n---\n\n## Core Principle\n\n**Use the right tool for the job.** Don't do manually what specialized agents can do better.\n\n---\n\n## Workflow 1: New Feature Development\n\n### Triggers\n- \"Add...\", \"Build...\", \"Create...\", \"Implement [new thing]\"\n- User describes functionality that doesn't exist yet\n\n### Decision Point: Should I use `/feature-dev`?\n\n**Use `/feature-dev` if:**\n- âœ… Feature requires multiple files\n- âœ… Unclear how it should integrate with existing code\n- âœ… Need to understand existing patterns first\n- âœ… User hasn't specified exact implementation approach\n\n**Skip `/feature-dev` if:**\n- âŒ Trivial change (typo fix, single-line tweak)\n- âŒ User provided extremely detailed implementation instructions\n- âŒ Pure research/exploration task (use code-explorer instead)\n\n### Workflow\n\n**If using `/feature-dev`:**\n\n```\n1. Invoke Skill tool with skill=\"feature-dev:feature-dev\"\n2. Let the feature-dev workflow handle:\n   - Codebase exploration\n   - Clarifying questions\n   - Architecture design\n   - Implementation\n   - Code review\n3. Done - feature-dev handles end-to-end\n```\n\n**If NOT using `/feature-dev` (simple change):**\n\n```\n1. Read relevant files to understand current implementation\n2. Ask clarifying questions if anything is ambiguous\n3. Implement the change\n4. Run build/lint/tests\n5. Consider code-reviewer agent for non-trivial changes\n```\n\n**Anti-pattern:**\n```\nâŒ User: \"Add a new selector component\"\n   Assistant: *immediately starts writing code*\n\nâœ… User: \"Add a new selector component\"\n   Assistant: \"I'll use /feature-dev to explore the codebase,\n              understand existing patterns, and design the implementation.\"\n```\n\n---\n\n## Workflow 2: Code Exploration & Understanding\n\n### Triggers\n- \"Where is...\", \"Explain how X works\", \"Map the project\", \"Find usage of...\"\n- Questions about code structure or flow\n\n### Decision Point: Manual search vs code-explorer?\n\n**Use code-explorer agent if:**\n- âœ… Question requires understanding code flow across multiple files\n- âœ… Need to trace execution paths\n- âœ… \"How does X work?\" questions\n- âœ… Finding all usages of a pattern\n\n**Manual search (Glob/Grep) if:**\n- âœ… Needle query - looking for specific file/class/function name\n- âœ… You know exactly what to search for\n- âœ… Single-file investigation\n\n### Workflow\n\n**For exploration (use code-explorer):**\n\n```\n1. Launch Task tool with subagent_type=\"Explore\"\n2. Provide clear question: \"How does authentication work?\"\n3. Specify thoroughness: \"medium\" or \"very thorough\"\n4. Read files identified by agent\n5. Summarize findings\n```\n\n**For needle queries (manual search):**\n\n```\n1. Use Glob for file patterns: \"**/*auth*.js\"\n2. Use Grep for code patterns: \"getUser.*session\"\n3. Read matched files\n4. Provide answer\n```\n\n---\n\n## Workflow 3: Architecture & Planning\n\n### Triggers\n- \"Plan...\", \"Design...\", \"Refactor strategy\", \"How should I structure...\"\n- Before implementing non-trivial features\n\n### Decision Point: Should I enter plan mode?\n\n**Use EnterPlanMode if ANY of:**\n- âœ… New feature with multiple valid approaches\n- âœ… Architectural decisions required\n- âœ… Changes affect multiple files (3+)\n- âœ… Unclear requirements need exploration first\n- âœ… User preferences matter for implementation approach\n\n**Skip plan mode if:**\n- âŒ Single-line fix\n- âŒ User provided very specific instructions\n- âŒ Pure research task\n\n### Workflow\n\n```\n1. Use EnterPlanMode tool\n2. In plan mode:\n   a. Explore codebase thoroughly\n   b. Understand existing patterns\n   c. Identify decision points\n   d. Use AskUserQuestion for clarifications\n   e. Design implementation approach\n   f. Write plan to plan file\n   g. Use ExitPlanMode\n3. Wait for user approval\n4. Implement according to approved plan\n```\n\n---\n\n## Workflow 4: Code Quality & Review\n\n### Triggers\n- Completed non-trivial implementation\n- Before creating PR\n- User asks \"review this\"\n\n### Decision Point: When to use code-reviewer?\n\n**Use code-reviewer proactively when:**\n- âœ… Just completed a feature (before user asks)\n- âœ… Added >50 lines of new code\n- âœ… Modified critical paths (update handlers, hooks, migrations)\n- âœ… About to create PR\n- âœ… Touched performance-sensitive code\n\n**Workflow**\n\n```\n1. Complete implementation\n2. Launch Task tool with subagent_type=\"pr-review-toolkit:code-reviewer\"\n3. Specify files to review (usually unstaged git diff)\n4. Review agent findings\n5. Fix high-priority issues\n6. Commit changes\n```\n\n---\n\n## Workflow 5: Version Control & Commits\n\n### Triggers\n- User asks to commit changes\n- User asks to create PR\n- Feature is complete and tested\n\n### Git Discipline Rules\n\n**NEVER:**\n- âŒ Run raw `git commit` via Bash without crafted message\n- âŒ Skip commit message template (must include attribution)\n- âŒ Commit without running git status + git diff first\n- âŒ Commit files with secrets (.env, credentials)\n- âŒ Use `--no-verify` to skip hooks (unless user explicitly requests)\n- âŒ Force push to main/master\n\n**ALWAYS:**\n- âœ… Use Skill tool for commits: `skill=\"commit-commands:commit\"`\n- âœ… Run `git status` and `git diff` in parallel first\n- âœ… Draft commit message based on actual changes (not assumptions)\n- âœ… Follow commit message style from git log\n- âœ… Include attribution footer\n- âœ… Verify no unintended files are staged\n\n### Commit Workflow\n\n```\n1. Run in parallel:\n   - git status (see untracked files)\n   - git diff (see staged + unstaged changes)\n   - git log -10 --oneline (see commit style)\n\n2. Analyze changes and draft commit message:\n   - Type: feat/fix/refactor/docs/chore/test\n   - Summary: What changed and why (focus on \"why\", not \"what\")\n   - Keep under 72 characters for summary line\n\n3. Stage relevant files (git add)\n\n4. Commit with proper message and attribution\n\n5. Run git status after commit to verify success\n```\n\n---\n\n## Workflow 6: External Knowledge & Research\n\n### Triggers\n- Uncertain about API usage\n- Need current information (library versions, recent changes)\n- User asks about external tools/libraries\n\n### Decision Point: Search vs Assume\n\n**ALWAYS search (don't assume) for:**\n- âœ… Framework API usage (changes between versions)\n- âœ… Recent library features\n- âœ… Browser compatibility issues\n- âœ… Security best practices\n- âœ… Anything you're unsure about\n\n**Safe to assume (from training):**\n- âœ… JavaScript/ES6 syntax\n- âœ… General web development patterns\n- âœ… Git fundamentals\n- âœ… Common npm commands\n\n### Workflow\n\n```\n1. Identify knowledge gap\n2. Use WebSearch or documentation tools\n3. Cite sources in response\n4. Apply findings to implementation\n```\n\n---\n\n## Workflow 7: Testing & Verification\n\n### Triggers\n- After implementing any feature\n- Before committing\n- Before creating PR\n\n### Testing Checklist\n\n**Minimum (ALWAYS):**\n```\n1. Build (if applicable)\n2. Lint (if applicable)\n3. Describe what to test manually\n```\n\n### Workflow\n\n```\n1. Implement feature\n2. Run build/lint commands\n3. Describe manual testing steps\n4. If update handlers involved:\n   - Review safety checklist\n   - Recommend appropriate tests\n```\n\n---\n\n## Decision Trees\n\n### \"Should I use an agent?\"\n\n```\nFeature request\nâ”œâ”€ Trivial (1-5 lines)? â†’ Implement directly\nâ”œâ”€ Exploration needed? â†’ code-explorer\nâ”œâ”€ Architecture decision? â†’ feature-dev (includes exploration + planning)\nâ”œâ”€ Just planning? â†’ EnterPlanMode\nâ””â”€ Implementation done? â†’ code-reviewer (proactive)\n\nCode question\nâ”œâ”€ Needle query (know what to find)? â†’ Glob/Grep\nâ”œâ”€ \"How does X work?\" â†’ code-explorer\nâ””â”€ \"Where is X?\" â†’ code-explorer\n\nCommit/PR\nâ”œâ”€ Ready to commit? â†’ Use commit skill (never raw git)\nâ”œâ”€ Ready for PR? â†’ Analyze full diff, draft description\nâ””â”€ Unsure if ready? â†’ code-reviewer first\n```\n\n### \"Should I search or assume?\"\n\n```\nKnowledge question\nâ”œâ”€ Framework API? â†’ SEARCH (changes between versions)\nâ”œâ”€ Recent library features? â†’ SEARCH\nâ”œâ”€ Security concern? â†’ SEARCH\nâ”œâ”€ Browser compatibility? â†’ SEARCH\nâ”œâ”€ Basic JavaScript? â†’ Assume (from training)\nâ””â”€ Git basics? â†’ Assume\n```\n\n---\n\n## Anti-Patterns to Avoid\n\n### 1. Skipping Exploration\n\n**Problem:** Implementing without understanding existing patterns\n\n```\nâŒ User: \"Add a new field component\"\n   Assistant: *immediately writes new code from scratch*\n\nâœ… User: \"Add a new field component\"\n   Assistant: *uses code-explorer to understand existing patterns first*\n```\n\n### 2. Manual Work Over Agents\n\n**Problem:** Doing manually what agents do better\n\n```\nâŒ User: \"Where are errors handled?\"\n   Assistant: *manually greps for \"error\", reads 3 files*\n\nâœ… User: \"Where are errors handled?\"\n   Assistant: *launches code-explorer to trace error handling comprehensively*\n```\n\n### 3. Assuming Knowledge\n\n**Problem:** Using outdated or incorrect API information\n\n```\nâŒ Assistant: \"I'll use the deprecated API pattern\"\n\nâœ… Assistant: \"Let me verify the current API pattern...\"\n```\n\n### 4. Sloppy Commits\n\n**Problem:** Raw git commands, poor messages, no attribution\n\n```\nâŒ Assistant: *runs bash* `git commit -m \"fix\"`\n\nâœ… Assistant: *uses commit skill*\n   Assistant: *analyzes changes, drafts message, includes attribution*\n```\n\n### 5. No Testing Guidance\n\n**Problem:** Declaring done without verification steps\n\n```\nâŒ Assistant: \"Feature complete!\"\n\nâœ… Assistant: \"Feature complete. To test:\n   1. Run the build\n   2. Open the application\n   3. Verify the new feature works\"\n```\n\n---\n\n## Quick Reference Checklist\n\n### Starting Work\n- [ ] Is this a feature? â†’ Consider `/feature-dev`\n- [ ] Is this exploration? â†’ Use `code-explorer`\n- [ ] Is this complex? â†’ Use `EnterPlanMode`\n- [ ] Do I need external knowledge? â†’ Search first\n\n### During Implementation\n- [ ] Reading existing code before modifying\n- [ ] Following existing patterns\n- [ ] Using project conventions\n\n### Before Committing\n- [ ] Run build (if applicable)\n- [ ] Run lint (if applicable)\n- [ ] Proactive code review (if non-trivial)\n- [ ] Git status + git diff reviewed\n- [ ] Commit message drafted with attribution\n- [ ] Testing guidance provided\n\n### Creating PR\n- [ ] Analyzed FULL diff (not just latest commit)\n- [ ] PR description drafted with test plan\n- [ ] Build and lint passing\n\n---\n\n## Success Criteria\n\nYou're following this workflow correctly when:\n\n- âœ… Features are explored before implementing\n- âœ… Code is reviewed proactively (before user asks)\n- âœ… Commits are clean with proper messages\n- âœ… PRs include comprehensive descriptions\n- âœ… Testing guidance is always provided\n- âœ… External knowledge is verified, not assumed\n- âœ… Specialized agents are used appropriately\n\n---\n\n**Last Updated:** 2026-01-04\n**Status:** Active - use throughout development lifecycle\n",
        "cc-governance/skills/cc-plugin-extensions/SKILL.md": "---\nname: cc-plugin-extensions\ndescription: This skill should be used when the user asks to \"install a plugin\", \"extend a plugin\", \"create a .local.md file\", \"add project context for a plugin\", \"customize plugin for this project\", or mentions project-specific paths, conventions, or workflows that relate to an installed plugin. Covers the .local.md extension pattern for bridging general plugin skills to specific codebases.\n---\n\n# Plugin Extension Pattern\n\nExtend marketplace plugins with project-specific context using `.local.md` files. These files bridge general plugin skills to a specific codebase.\n\n## When to Use This Skill\n\nApply this skill when:\n- Installing a marketplace plugin in a project\n- A plugin skill is generic but project-specific guidance is needed\n- Documenting project-specific file paths, conventions, or workflows that relate to a plugin\n- Setting up a new project that uses existing plugins\n\n### Key Distinction\n`.local.md` files are **agent context** (for Claude), not human documentation (like READMEs or guides). Treat them like CLAUDE.md in purpose.\n\n## The Pattern\n\n### File Location and Naming\n\n```\n.claude/<plugin-name>.local.md\n```\n\nExamples:\n- `.claude/cc-governance-skills.local.md`\n- `.claude/fvtt-skills.local.md`\n\n### Structure\n\n```markdown\n---\nplugin: <plugin-name>\nproject: <project-name>\n---\n\n# <Plugin Name> - Project-Specific Context\n\nThis file extends the `<plugin-name>` plugin with <project>-specific information.\n\n## <Section relevant to plugin's skills>\n\n<Project-specific details>\n```\n\n### YAML Frontmatter\n\n| Field | Purpose |\n|-------|---------|\n| `plugin` | Name of the marketplace plugin being extended |\n| `project` | Name of the current project |\n\n## What Belongs in Extension Files\n\n### DO Include\n\n1. **File paths** - Where plugin patterns are implemented in this project\n   ```markdown\n   | Skill | Implementation Files |\n   |-------|---------------------|\n   | `fvtt-performance-safe-updates` | `scripts/lib/update-queue.js`, `scripts/hooks.js` |\n   ```\n\n2. **Project conventions** - How general patterns apply here\n   ```markdown\n   ### Actor Types\n   - `character` - Player characters\n   - `crew` - Crew sheets\n   ```\n\n3. **Workflows** - Project-specific processes\n   ```markdown\n   ### Git Workflow\n   - Feature branches â†’ PR to `upstream/rc-1.1.0`\n   - Use `--head ImproperSubset:branch-name` for cross-fork PRs\n   ```\n\n4. **Build commands** - Project-specific tooling\n   ```markdown\n   ## Build Commands\n   npm run build:css         # Compile SCSS\n   npm run lint:css          # Stylelint\n   ```\n\n5. **Reminders** - Project-specific gotchas related to plugin skills\n   ```markdown\n   ### Multi-Client Development\n   Every update handler MUST have:\n   1. Ownership guard\n   2. No-op check\n   3. Batched updates\n   ```\n\n### DON'T Include\n\n- Content that should be in the plugin itself (general patterns)\n- Personal preferences (those stay gitignored in `settings.local.json`)\n- Information unrelated to the plugin's skills\n\n## Version Control\n\n### Check In (Project Context)\nCommit extension files containing project-specific context to the repository. This ensures all contributors using the plugins get the enhanced context.\n\n```gitignore\n# .gitignore - DON'T ignore project context\n# .claude/*.local.md  <-- Remove this line\n```\n\n### Gitignore (Personal Preferences)\nGitignore only personal settings:\n\n```gitignore\n# .gitignore\n.claude/settings.local.json\n```\n\n## Example: Complete Extension File\n\n```markdown\n---\nplugin: fvtt-skills\nproject: my-foundry-module\n---\n\n# FVTT Skills - Project-Specific Context\n\nThis file extends the `fvtt-skills` plugin with my-foundry-module-specific information.\n\n## File Paths\n\n| Skill | Implementation Files |\n|-------|---------------------|\n| `fvtt-performance-safe-updates` | `scripts/lib/update-queue.js` |\n| `fvtt-version-compat` | `scripts/compat.js` |\n\n## Project Conventions\n\n### Document Types\n- `character` - Player characters\n- `npc` - Non-player characters\n\n### Flag Namespace\n```javascript\nactor.getFlag(\"my-foundry-module\", \"flagName\")\n```\n\n## Build Commands\n```bash\nnpm run build    # Build module\nnpm run test     # Run tests\n```\n```\n\n## When NOT to Create Extension Files\n\n- Plugin is used without project-specific customization\n- Information belongs in CLAUDE.md (not plugin-specific)\n- Content is personal preference (use `settings.local.json`)\n",
        "cc-governance/skills/documentation-management/SKILL.md": "---\nname: documentation-management\ndescription: This skill should be used when creating a new .md file, completing an analysis or audit, deciding whether to archive or delete docs, or when uncertain if something should be documented. Covers document types, naming conventions, the \"Link Test\", and when to extract patterns to skills.\n---\n\n# Documentation Management\n\nMaintain clean, useful documentation by following clear guidelines for what to create, how to name it, where to put it, and when to archive or delete it.\n\n## When to Use This Skill\n\nInvoke this skill when:\n\n### âœ… Creating Documentation\n- About to create a new .md file\n- Completing an analysis or audit\n- Documenting a decision or design\n- Uncertain if something should be documented\n\n### âœ… Maintaining Documentation\n- Reviewing existing docs for relevance\n- Deciding whether to archive or delete\n- Organizing documentation structure\n- Creating index/README files\n\n### âœ… Meta Questions\n- \"Should I document this?\"\n- \"Where does this doc belong?\"\n- \"Is this still useful or just clutter?\"\n- \"What should I name this file?\"\n\n## The Problem: Documentation Clutter\n\n### What Happens Without Clear Policies\n\n```\nTimeline:\nT0: Create ANALYSIS.md during investigation\nT1: Create FIX_PLAN.md with proposed changes\nT2: Implement fixes, create skills encoding patterns\nT3: Create ANOTHER_ANALYSIS.md for different issue\nT4: Months later...\n  â†“\ndocs/ directory has 20+ files\n  â†“\nGeneric names: ANALYSIS.md, AUDIT.md, PLAN.md\nNo dates, no clear relevance\n  â†“\nCan't tell what's current vs historical\nCan't tell what's useful vs clutter\n  â†“\nNew developers overwhelmed\nNobody links to these docs\nNobody maintains them\n```\n\n**Result:** Documentation becomes write-only. Nobody reads it, nobody trusts it.\n\n## Solution: Documentation Policy\n\n### Three Core Principles\n\n1. **Be ruthless** - If you wouldn't link to it in README, delete it\n2. **Be explicit** - Names and structure should make purpose obvious\n3. **Extract to skills** - Repeatable patterns become skills, then delete source docs\n\n## Document Types & Decision Tree\n\n### Type 1: Active Reference Guides\n\n**Purpose:** Timeless reference documentation that developers actively use\n\n**Characteristics:**\n- Referenced frequently during development\n- Explains HOW to do something\n- Doesn't become outdated (or gets updated when it does)\n- Would link to it in project README\n\n**Naming:** `{topic}-guide.md`\n\n**Location:** `docs/guides/`\n\n**Lifecycle:** Keep forever, update as needed\n\n**Test:** \"Would a new developer need this to work on the project?\"\n\n### Type 2: Architecture Documentation\n\n**Purpose:** Explain system design, structure, and \"why\" decisions\n\n**Characteristics:**\n- Explains WHY the system works this way\n- Documents design decisions and trade-offs\n- Helps understand the big picture\n- Relatively stable (architecture doesn't change often)\n\n**Naming:** `{COMPONENT}_ARCHITECTURE.md` or `{COMPONENT}_DESIGN.md`\n\n**Location:** `docs/architecture/`\n\n**Lifecycle:** Keep forever, update when architecture changes\n\n**Test:** \"Does this explain why the system is structured this way?\"\n\n### Type 3: Architecture Decision Records (ADRs)\n\n**Purpose:** Document important decisions to prevent re-litigation\n\n**Characteristics:**\n- Point-in-time decision with context\n- Answers: What was decided? Why? What were alternatives?\n- Immutable (never updated, new ADR if decision changes)\n- Dated to show when decision was made\n\n**Naming:** `YYYY-MM-DD-{decision-title}.md`\n\n**Location:** `docs/decisions/`\n\n**Lifecycle:** Keep forever (shows evolution of thinking)\n\n**Test:** \"Would this prevent someone from proposing we re-do something we already tried?\"\n\n**Template:**\n```markdown\n# {Title of Decision}\n\n**Date:** YYYY-MM-DD\n**Status:** Accepted | Superseded by ADR-XXX\n**Context:** What problem are we solving?\n**Decision:** What did we decide to do?\n**Alternatives Considered:**\n- Option A: Pros/Cons\n- Option B: Pros/Cons\n**Consequences:** What are the implications?\n**References:** Links to related issues, PRs, discussions\n```\n\n### Type 4: Skills\n\n**Purpose:** Encode repeatable patterns and workflows\n\n**Characteristics:**\n- Actionable, step-by-step guidance\n- Repeatable workflow\n- Clear triggers for when to use\n- Checklists and decision trees\n\n**Naming:** `{descriptive-name}/SKILL.md`\n\n**Location:** `.claude/skills/{skill-name}/`\n\n**Lifecycle:** Keep forever, update as patterns evolve\n\n**Test:** \"Will I do this task more than once? Does it have clear steps?\"\n\n### Type 5: Historical Audits/Analysis\n\n**Purpose:** Document completed investigations and fixes\n\n**Characteristics:**\n- Point-in-time snapshot of a problem\n- \"Here's what we found and fixed\"\n- Useful context for understanding why code exists\n- BUT: Often superseded by skills or code comments\n\n**Naming:** `YYYY-MM-DD-{audit-name}.md`\n\n**Location:** `docs/archive/` (if kept at all)\n\n**Lifecycle:**\n- **Option A:** Delete if lessons are encoded in skills\n- **Option B:** Archive with date if decision context is valuable\n\n**Test:** \"Does this provide context that isn't captured elsewhere?\"\n\n### Type 6: Working Documents\n\n**Purpose:** Temporary analysis during active development\n\n**Characteristics:**\n- Created during investigation\n- Helps organize thoughts\n- Not meant to be permanent\n- Serves as input to final docs (skills, ADRs, guides)\n\n**Naming:** `YYYY-MM-DD-WIP-{topic}.md` or just work in memory/notes\n\n**Location:** Root directory (temporary) or don't create at all\n\n**Lifecycle:**\n- **Delete immediately** after final doc is created\n- **Never commit** if just for organizing thoughts\n- **Convert** to skill/ADR/guide, then delete working doc\n\n**Test:** \"Will this still be useful a month from now?\" (If no, delete it)\n\n### Type 7: Session Tracking Documents\n\n**Purpose:** Persistent tracking of active work and deferred ideas across sessions\n\nThere are TWO tracking locations - project-specific and cross-project:\n\n#### Project-Specific Tracking (`docs/tracking/`)\n\nFor work tied to a specific project:\n\n**Files:**\n- `docs/tracking/ACTIVE.md` - Current work in progress for THIS project\n- `docs/tracking/BACKLOG.md` - Deferred ideas for THIS project\n\n**Use when:**\n- Bug fixes, features, refactoring for this codebase\n- Project-specific TODOs and technical debt\n- Items that only make sense in this project's context\n\n#### Cross-Project Tracking (`~/git/hh-meta/tracking/`)\n\nFor ideas, notes, and backlog that span projects or aren't project-specific:\n\n**Files:**\n- `tracking/IDEAS.md` - Future features, exploration ideas, \"what if\" thoughts\n- `tracking/BACKLOG.md` - Deferred work with context for later pickup\n- `tracking/PROJECTS.md` - Active projects overview and status\n- `tracking/NOTES.md` - Learnings, decisions, patterns discovered\n\n**Use when:**\n- Idea applies to multiple projects\n- General learning or pattern worth remembering\n- Meta-level tracking (project statuses, cross-cutting concerns)\n- Not sure which project it belongs to\n\n#### Decision: Project vs Cross-Project\n\n```\nIs this tied to a specific project's codebase?\n  â†“ YES â†’ Project tracking (docs/tracking/)\n  â†“ NO\nIs this a general idea, learning, or cross-cutting concern?\n  â†“ YES â†’ Cross-project tracking (~/git/hh-meta/tracking/)\n  â†“ UNCLEAR â†’ ASK THE USER where it should go\n```\n\n**IMPORTANT:** When unclear whether something is project-specific or cross-project, ASK the user: \"Should I track this in the project's docs/tracking/ or in hh-meta for cross-project visibility?\"\n\n**Characteristics:**\n- Persistent across sessions (unlike TodoWrite which is ephemeral)\n- Provides continuity when resuming work\n- Separates \"what we're doing\" from \"what we might do\"\n- Cross-project tracking is backed up to GitHub (private repo)\n\n**Lifecycle:** Permanent files, content updated as work progresses\n\n**Test:** \"Is this tracking active work or deferred ideas?\" (If yes, use tracking docs)\n\n## The Decision Tree\n\n### Should I Create Documentation?\n\n```\nNew information/analysis â†’ Should this be documented?\n  â†“\nQ1: Is this a repeatable pattern/workflow?\n  â†“ YES\n  â†’ Create SKILL\n  â†’ Delete working notes\n\n  â†“ NO\nQ2: Is this explaining HOW to do something?\n  â†“ YES\n  â†’ Create GUIDE (docs/guides/)\n  â†’ Permanent\n\n  â†“ NO\nQ3: Is this explaining WHY the system is designed this way?\n  â†“ YES\n  â†’ Create ARCHITECTURE doc (docs/architecture/)\n  â†’ Permanent\n\n  â†“ NO\nQ4: Is this a decision we might re-litigate?\n  â†“ YES\n  â†’ Create ADR (docs/decisions/YYYY-MM-DD-*.md)\n  â†’ Permanent\n\n  â†“ NO\nQ5: Is this tracking active work or deferred ideas?\n  â†“ YES\n  â†’ Q5a: Is this project-specific?\n    â†“ YES â†’ Update docs/tracking/ (ACTIVE.md or BACKLOG.md)\n    â†“ NO  â†’ Update ~/git/hh-meta/tracking/ (IDEAS, BACKLOG, NOTES, or PROJECTS)\n    â†“ UNCLEAR â†’ ASK USER where it should go\n  â†’ Persistent across sessions\n\n  â†“ NO\nQ6: Is this just organizing thoughts or temporary analysis?\n  â†“ YES\n  â†’ Don't create file OR create WIP doc\n  â†’ Delete after extracting to skill/guide/ADR\n  â†’ NEVER commit working docs to repo\n\n  â†“ NO\n  â†’ Don't document it\n```\n\n## Directory Structure\n\n### Recommended Organization\n\n```\n/\nâ”œâ”€â”€ README.md                    # Project overview\nâ”œâ”€â”€ CONTRIBUTING.md              # Development guidelines\nâ”œâ”€â”€ CLAUDE.md                    # AI assistant guidance\nâ”‚\nâ”œâ”€â”€ docs/\nâ”‚   â”œâ”€â”€ README.md               # INDEX of all documentation\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ guides/                 # Active reference (HOW)\nâ”‚   â”‚   â”œâ”€â”€ styling-guide.md\nâ”‚   â”‚   â”œâ”€â”€ api-guide.md\nâ”‚   â”‚   â””â”€â”€ testing-guide.md\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ architecture/           # System design (WHY structure)\nâ”‚   â”‚   â”œâ”€â”€ component-architecture.md\nâ”‚   â”‚   â””â”€â”€ data-flow-design.md\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ decisions/              # ADRs (WHY decisions)\nâ”‚   â”‚   â”œâ”€â”€ 2025-11-15-approach-selection.md\nâ”‚   â”‚   â””â”€â”€ 2025-12-01-cache-strategy.md\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ tracking/               # Session continuity\nâ”‚   â”‚   â”œâ”€â”€ ACTIVE.md           # Current work in progress\nâ”‚   â”‚   â””â”€â”€ BACKLOG.md          # Deferred ideas (access on demand)\nâ”‚   â”‚\nâ”‚   â””â”€â”€ archive/                # Historical (optional)\nâ”‚       â””â”€â”€ 2025-10-15-performance-audit.md\nâ”‚\nâ””â”€â”€ .claude/skills/             # Repeatable patterns\n    â”œâ”€â”€ README.md               # Skills index\n    â”œâ”€â”€ documentation-management/  â† This skill!\n    â””â”€â”€ ...\n```\n\n## Naming Conventions\n\n### Active Reference Guides\n\n**Pattern:** `{topic}-guide.md`\n\n**Examples:**\n- `dialog-compatibility-guide.md`\n- `performance-update-guide.md`\n- `template-authoring-guide.md`\n\n**Why:** Descriptive, timeless, sorts alphabetically by topic\n\n### Architecture Docs\n\n**Pattern:** `{component}-architecture.md` or `{component}-design.md`\n\n**Examples:**\n- `scss-architecture.md`\n- `data-flow-design.md`\n- `sheet-registration-design.md`\n\n**Why:** Clear that it's about system design, not a how-to guide\n\n### Architecture Decision Records\n\n**Pattern:** `YYYY-MM-DD-{short-title}.md`\n\n**Examples:**\n- `2025-11-15-virtual-lists-over-drag-drop.md`\n- `2025-12-01-redis-vs-memory-cache.md`\n- `2025-12-20-inline-styles-for-shadow-dom.md`\n\n**Why:** Sorts chronologically, immediately clear when decision was made\n\n## Lifecycle Management\n\n### When to Archive\n\n**Trigger:** Audit is complete, problem is solved, lessons are encoded\n\n**Process:**\n1. Check if lessons are captured in skills\n2. If yes: Move to `docs/archive/` with date\n3. If lessons aren't encoded anywhere: Consider creating skill first\n\n### When to Delete\n\n**Trigger:** Document served its purpose, value is captured elsewhere\n\n**Safe to Delete:**\n- Working documents after final doc is created\n- Audits where ALL lessons are in skills\n- Analysis that led to code but has no ongoing reference value\n- Anything you wouldn't link to in README\n\n**The \"Link Test\":**\n```\nQuestion: Would you add a link to this doc in docs/README.md?\n\nNO â†’ Delete it\nMAYBE â†’ Archive with date\nYES â†’ Keep in active location\n```\n\n### When to Extract to Skill\n\n**Trigger:** Identified a repeatable pattern with clear steps\n\n**Process:**\n1. Audit/analysis identifies a pattern\n2. Create skill encoding the pattern\n3. Delete or archive the source audit/analysis\n4. Update docs/README.md to link to skill\n\n## Quick Checklist\n\nBefore creating documentation:\n\n- [ ] Identified document type (guide, architecture, ADR, skill, working doc)\n- [ ] Applied \"Link Test\" - Would I link to this in README?\n- [ ] Used correct naming convention for type\n- [ ] Placed in correct directory\n- [ ] If working doc: Added WIP prefix or kept local (don't commit)\n- [ ] If supersedes old doc: Deleted or archived old doc\n- [ ] Updated docs/README.md index (if keeping)\n\nBefore committing documentation:\n\n- [ ] Removed any WIP/temporary docs\n- [ ] Archived completed audits (if keeping at all)\n- [ ] Deleted working documents that served their purpose\n- [ ] Updated index files\n\nPeriodic maintenance (monthly):\n\n- [ ] Review docs/ for relevance\n- [ ] Delete outdated guides or update them\n- [ ] Archive completed audits\n- [ ] Check for patterns to extract to skills\n- [ ] Update docs/README.md\n\n## References\n\n- Example ADR format: [Architecture Decision Records](https://adr.github.io/)\n- Documentation best practices: [Divio Documentation System](https://documentation.divio.com/)\n\n---\n\n**Last Updated**: 2026-01-04\n",
        "cc-governance/skills/git-branching-strategy/SKILL.md": "---\nname: git-branching-strategy\ndescription: This skill should be used when starting new feature work, mid-feature when wanting to add unrelated changes, when a branch has grown beyond 20 commits, or when unsure whether to create a new branch. Covers one-feature-one-branch rule, branch size targets, and when to split branches.\n---\n\n# Git Branching Strategy\n\nPrevent monster branches by following disciplined branching and merge practices.\n\n## When to Use This Skill\n\nInvoke this skill when:\n\n### âœ… Starting New Work\n- About to implement a new feature\n- Planning to fix a bug\n- Starting refactoring work\n- Adding documentation\n\n### âš ï¸ Mid-Feature Warning Signs\n- Thinking \"while I'm here, I'll also...\"\n- Wanting to add unrelated functionality\n- Branch has grown beyond 20 commits\n- Multiple unrelated files changed\n- Changes would be difficult to understand\n\n### ğŸ¯ Decision Points\n- Unsure whether to create new branch or continue current\n- Wondering if branch is getting too large\n- Considering adding \"just one more thing\"\n- Ready to merge but branch feels messy\n\n---\n\n## âš ï¸ Pre-Implementation Checklist\n\n**BEFORE writing ANY code, answer these questions:**\n\n### 1. Is this non-trivial work?\n\n**Non-trivial = ANY of these:**\n- âœ… Changes **>2 files**\n- âœ… Refactoring existing code\n- âœ… Adding new features/functionality\n- âœ… Implementing planned tasks\n- âœ… Bug fixes requiring changes to multiple components\n\n**Trivial = ALL of these:**\n- âŒ Fixing typo in single file\n- âŒ Updating documentation only (markdown, comments)\n- âŒ One-line fix in single file\n\n### 2. If Non-Trivial â†’ CREATE FEATURE BRANCH\n\n```bash\n# Ensure main branch is up to date\ngit checkout main\ngit pull origin main\n\n# Create feature branch (choose appropriate prefix)\ngit checkout -b feature/descriptive-name    # For new features\ngit checkout -b refactor/descriptive-name   # For refactoring\ngit checkout -b fix/descriptive-name        # For bug fixes\n```\n\n**Examples:**\n- `feature/user-authentication` - New auth implementation\n- `refactor/error-handling` - Standardize error handling\n- `fix/login-redirect` - Fix login redirect bug\n\n### 3. Golden Rule\n\n**When in doubt, use a feature branch.**\n\nFeature branches provide:\n- ğŸ“ Documentation of what changed and why\n- ğŸ“Š Clear history of feature development\n- ğŸ”„ Easy to revert if needed\n- ğŸ§ª Isolated testing before merge\n\n---\n\n## The Problem: Monster Branches\n\n### What Happens\n\n**Timeline:**\n- Started as \"add feature X\"\n- Grew to include features Y, Z, refactoring, and bug fixes\n- **100+ commits**, multiple intertwined features\n- Difficult to review, hard to merge, risky to revert\n\n**Symptoms:**\n- âŒ Multiple distinct features mixed together\n- âŒ Hard to describe what the branch does in one sentence\n- âŒ Changes span unrelated systems\n- âŒ Commit history is difficult to follow\n- âŒ Rolling back one feature means losing others\n\n**Consequences:**\n- Long-lived branch diverges from main\n- Merge conflicts accumulate\n- Testing becomes all-or-nothing\n- Can't ship features incrementally\n- Hard to isolate bugs introduced\n\n## Solution: Small, Focused Branches\n\n### The Golden Rule\n\n**One feature, one branch, one merge.**\n\nIf you can't describe the branch in a single sentence without using \"and\", it's too big.\n\n### Good Examples\n\nâœ… **Good:** `feat/user-auth` - \"Add basic user authentication\"\nâœ… **Good:** `feat/smart-fields` - \"Implement smart field system\"\nâœ… **Good:** `fix/race-condition` - \"Fix optimistic update race condition\"\nâœ… **Good:** `refactor/scss-modules` - \"Convert SCSS to module system\"\nâœ… **Good:** `docs/contributing` - \"Add contributing guidelines\"\n\n### Bad Examples\n\nâŒ **Bad:** `feat/improvements` - Too vague, likely includes unrelated changes\nâŒ **Bad:** `fix/various-bugs` - Multiple unrelated fixes should be separate branches\nâŒ **Bad:** `wip/stuff` - Not descriptive, suggests unfocused work\n\n## Branch Size Guidelines\n\n### Target Size\n\n**Ideal:** 5-15 commits, 1-5 files changed significantly\n**Acceptable:** Up to 30 commits, up to 10 files\n**Too Large:** 50+ commits, 20+ files\n\n**Exception:** Large refactors that are purely mechanical\n\n### Commit Count Checkpoints\n\n```\n5 commits â†’ Normal feature pace\n10 commits â†’ Check: Am I still focused on one feature?\n20 commits â†’ WARNING: Consider splitting or wrapping up\n30 commits â†’ CRITICAL: Finish and merge, or split into multiple branches\n50+ commits â†’ MONSTER: This should have been 3-5 separate branches\n```\n\n### When Branch Size is Justified\n\nâœ… **Acceptable large branches:**\n- Pure refactoring (converting styles, modularization)\n- Data migrations (changing structure across many files)\n- Framework version upgrades (mechanical API changes)\n- Initial feature implementation with tests and docs\n\nâŒ **Unacceptable large branches:**\n- Multiple unrelated features\n- Feature + \"while I'm here\" improvements\n- Feature + unrelated bug fixes\n- Feature + refactoring that isn't required for feature\n\n## Decision Tree: New Branch or Continue?\n\n### Question 1: Is this change related to current branch?\n\n```\nNew change â†’ Related to current feature?\n  â†“ YES (same system, same goal)\n  â†’ Continue current branch\n\n  â†“ NO (different system, different goal)\n  â†’ Question 2\n```\n\n### Question 2: Is current branch ready to merge?\n\n```\nCurrent branch â†’ Ready to merge?\n  â†“ YES (feature complete, tests pass)\n  â†’ Merge current, then new branch for new work\n\n  â†“ NO (feature incomplete)\n  â†’ Question 3\n```\n\n### Question 3: Is new work required for current feature?\n\n```\nNew work â†’ Required for current feature to work?\n  â†“ YES (dependency)\n  â†’ Continue current branch\n\n  â†“ NO (nice-to-have, improvement, unrelated)\n  â†’ Stash current, new branch, finish new, resume current\n```\n\n## Branch Naming Conventions\n\n### Format\n\n```\n<type>/<short-description>\n```\n\n### Types\n\n- **feat/** - New feature or enhancement\n- **fix/** - Bug fix\n- **refactor/** - Code restructuring without behavior change\n- **docs/** - Documentation only\n- **test/** - Adding or fixing tests\n- **chore/** - Build, tooling, dependencies\n\n### Examples\n\n```\nfeat/user-auth\nfeat/smart-fields\nfeat/dashboard\nfix/login-redirect\nfix/memory-leak\nrefactor/scss-modules\nrefactor/modularization\ndocs/contributing\ndocs/api-guide\nchore/update-deps\n```\n\n### Avoid\n\nâŒ `feature/` - Use `feat/` (shorter)\nâŒ `bugfix/` - Use `fix/` (shorter)\nâŒ `wip/` - Work in progress is implied, use descriptive name\nâŒ `my-branch` - Not descriptive\nâŒ `feat/add-feature` - Redundant \"add\"\n\n## Branch Lifecycle\n\n### 1. Plan and Scope\n\n**Before creating branch:**\n- [ ] Can I describe this in one sentence?\n- [ ] Is this the smallest useful increment?\n- [ ] Does this depend on other incomplete work?\n- [ ] Will this take more than 30 commits?\n\n**If >30 commits expected:** Break into smaller features first.\n\n### 2. Create Branch\n\n```bash\n# From main (or integration branch)\ngit checkout main\ngit pull origin main\n\n# Create feature branch\ngit checkout -b feat/descriptive-name\n```\n\n### 3. Work on Feature\n\n**Commit discipline:**\n- Small, focused commits\n- Clear commit messages\n- Commit related changes together\n- Don't mix formatting with logic changes\n\n**Check progress regularly:**\n```bash\n# How many commits?\ngit log main..HEAD --oneline | wc -l\n\n# How many files changed?\ngit diff main --stat\n\n# Am I still focused?\ngit log --oneline -10  # Review recent commits\n```\n\n### 4. Recognize When to Split\n\n**Warning signs:**\n- Commit messages use \"and\" frequently\n- Multiple unrelated `// TODO` comments\n- You've forgotten what early commits did\n- Summary of changes needs 3+ bullet points for unrelated changes\n\n**How to split:**\n\n```bash\n# Option A: Finish current, branch for next\ngit commit -m \"Complete X feature\"\n# Merge feat/x\ngit checkout -b feat/y  # Start next feature\n\n# Option B: Stash incomplete, branch for urgent work\ngit stash\ngit checkout -b fix/urgent-bug\n# Fix and merge\ngit checkout feat/original\ngit stash pop\n```\n\n### 5. Prepare for Merge\n\n**Before merging:**\n```bash\n# Rebase on latest main\ngit fetch origin\ngit rebase origin/main\n\n# Review all changes\ngit diff origin/main\n\n# Check commit history is clean\ngit log origin/main..HEAD --oneline\n\n# Run tests if applicable\nnpm test  # or your test command\n```\n\n### 6. Merge to Main\n\n```bash\n# Switch to main and merge\ngit checkout main\ngit pull origin main\ngit merge --no-ff feat/descriptive-name\n\n# Push to remote\ngit push origin main\n\n# Delete local branch\ngit branch -d feat/descriptive-name\n```\n\n**Note:** `--no-ff` creates a merge commit even for fast-forward merges, preserving branch history.\n\n## Commit Message Conventions\n\n### Format\n\n```\n<type>: <short description>\n\n<optional body>\n\n<optional footer>\n```\n\n### Types\n\nSame as branch types:\n- **feat:** - New feature\n- **fix:** - Bug fix\n- **refactor:** - Code restructuring\n- **docs:** - Documentation\n- **test:** - Tests\n- **chore:** - Build/tooling\n\n### Guidelines\n\n**Good commit messages:**\n```\nfeat: Add smart field system with lookups\n\nImplements interactive fields that open selection dialogs\nfiltered by context. Includes helper and click handler integration.\n\nCloses #42\n```\n\n**Bad commit messages:**\n```\nâŒ \"Updates\"\nâŒ \"Fix stuff\"\nâŒ \"WIP\"\nâŒ \"More changes\"\nâŒ \"Final commit (hopefully)\"\n```\n\n### Commit Message Best Practices\n\n- **Present tense:** \"Add feature\" not \"Added feature\"\n- **Imperative mood:** \"Fix bug\" not \"Fixes bug\"\n- **Capitalize first word:** \"Add feature\" not \"add feature\"\n- **No period at end:** \"Add feature\" not \"Add feature.\"\n- **Body explains why, not what:** Code shows what, message explains why\n\n## When to Split an Existing Branch\n\n### Recognize the Need\n\n**You should split if:**\n- Branch has 40+ commits and isn't done\n- You can't summarize the changes coherently\n- Rolling back would lose multiple independent features\n- Commit history mixes unrelated changes\n\n### How to Split\n\n**Strategy A: Extract Completed Features**\n\n```bash\n# Current branch: feat/massive (50 commits)\n# Goal: Extract first feature into separate branch\n\n# 1. Create new branch from main\ngit checkout main\ngit checkout -b feat/extracted-feature\n\n# 2. Cherry-pick relevant commits\ngit log feat/massive --oneline  # Find commit SHAs\ngit cherry-pick abc123 def456 ghi789\n\n# 3. Merge the extracted feature\ngit checkout main\ngit merge --no-ff feat/extracted-feature\ngit push origin main\ngit branch -d feat/extracted-feature\n\n# 4. Rebase massive branch to remove duplicates\ngit checkout feat/massive\ngit rebase main\n```\n\n**Strategy B: Start Fresh, Reference Old**\n\n```bash\n# Current branch: feat/massive (too messy to salvage)\n\n# 1. Create new branch from main\ngit checkout main\ngit checkout -b feat/feature-1-clean\n\n# 2. Manually apply changes from massive branch\n# (Copy files, make clean commits)\n\n# 3. Repeat for each feature\ngit checkout main\ngit checkout -b feat/feature-2-clean\n\n# 4. Abandon feat/massive after all features extracted\ngit branch -D feat/massive\n```\n\n## Quick Checklist\n\n### Before Starting Work\n\n- [ ] One sentence description of what I'm building\n- [ ] Checked if this should be separate from current branch\n- [ ] Created appropriately named branch from main\n- [ ] Estimated this will take <30 commits\n\n### During Work\n\n- [ ] Commit messages are clear and focused\n- [ ] Not mixing unrelated changes in same commit\n- [ ] Checking commit count every 5-10 commits\n- [ ] Resisting \"while I'm here\" temptations\n\n### Before Merging\n\n- [ ] Branch has <30 commits (or justifiable if larger)\n- [ ] All commits are related to the same feature\n- [ ] Rebased on latest main\n- [ ] Can describe changes in 1-3 sentences\n- [ ] Commit history is clean and logical\n- [ ] Tests pass (if applicable)\n\n### Danger Signs (Stop and Split)\n\n- [ ] âš ï¸ More than 30 commits\n- [ ] âš ï¸ Changed more than 15 unrelated files\n- [ ] âš ï¸ Commit messages have \"also\", \"and\", \"while here\"\n- [ ] âš ï¸ Can't remember what early commits did\n- [ ] âš ï¸ Summary needs multiple unrelated bullet points\n\n## Common Scenarios\n\n### \"I'm halfway through feature X, noticed bug Y\"\n\n**If bug blocks feature X:**\nâ†’ Fix in current branch\n\n**If bug is unrelated:**\nâ†’ Stash current work, create `fix/bug-y`, merge it, resume feature X\n\n### \"I want to add feature B while working on feature A\"\n\n**If B is required for A:**\nâ†’ Continue current branch\n\n**If B is independent:**\nâ†’ Finish A first, then branch for B\n\n**If B is urgent and A is incomplete:**\nâ†’ Stash A, branch for B, merge B, resume A\n\n### \"My branch has 40 commits, should I split?\"\n\n**Yes.** Options:\n1. Extract completed portions into separate branches (cherry-pick)\n2. Finish current branch as-is, vow to split next time\n3. Start fresh with clean branches for each feature\n\n### \"I made formatting changes along with feature changes\"\n\n**Separate them:**\n```bash\n# Approach 1: Amend last commit to remove formatting\ngit reset HEAD~1\ngit add <feature files only>\ngit commit -m \"feat: add feature\"\ngit add <formatting files>\ngit commit -m \"chore: format code\"\n\n# Approach 2: Split into two branches\n# - Branch 1: Formatting only (refactor/format-cleanup) - merge first\n# - Branch 2: Feature only (feat/my-feature) - merge after\n```\n\n---\n\n**Remember:** When in doubt, split it out. Smaller branches are easier to understand, safer to merge, and faster to ship.\n\n---\n\n**Last Updated**: 2026-01-05\n",
        "fvtt-dev/.claude-plugin/plugin.json": "{\n  \"name\": \"fvtt-dev\",\n  \"version\": \"1.10.0\",\n  \"description\": \"Comprehensive skills for Foundry VTT module development: V13 migration, multi-client safety, version compatibility, data migrations, error handling, hooks, data storage, sheets, dice rolling, sockets, active effects, canvas, localization, compendiums, combat, chat messages, and applications\",\n  \"author\": {\n    \"name\": \"ImproperSubset\",\n    \"email\": \"impropersubset@users.noreply.github.com\"\n  },\n  \"repository\": \"https://github.com/ImproperSubset/hh-agentics\",\n  \"license\": \"MIT\",\n  \"keywords\": [\"foundry-vtt\", \"fvtt\", \"module-development\", \"v13\", \"game-system\"],\n  \"skills\": [\n    \"./skills/fvtt-active-effects\",\n    \"./skills/fvtt-applications\",\n    \"./skills/fvtt-canvas\",\n    \"./skills/fvtt-chat-messages\",\n    \"./skills/fvtt-combat\",\n    \"./skills/fvtt-compendiums\",\n    \"./skills/fvtt-data-migrations\",\n    \"./skills/fvtt-data-storage\",\n    \"./skills/fvtt-dice-rolls\",\n    \"./skills/fvtt-error-handling\",\n    \"./skills/fvtt-hooks\",\n    \"./skills/fvtt-localization\",\n    \"./skills/fvtt-performance-safe-updates\",\n    \"./skills/fvtt-sheets\",\n    \"./skills/fvtt-sockets\",\n    \"./skills/fvtt-v13-migration\",\n    \"./skills/fvtt-version-compat\"\n  ]\n}\n",
        "fvtt-dev/skills/fvtt-active-effects/SKILL.md": "---\nname: fvtt-active-effects\ndescription: This skill should be used when creating or applying Active Effects, working with effect changes and modes (ADD, MULTIPLY, OVERRIDE, CUSTOM), implementing duration tracking for combat, or handling effect transfer from items to actors.\n---\n\n# Foundry VTT Active Effects\n\n**Domain:** Foundry VTT Module/System Development\n**Status:** Production-Ready\n**Last Updated:** 2026-01-05\n\n## Overview\n\nActive Effects automatically modify Actor data through a changes array. They're the primary mechanism for buffs, debuffs, equipment bonuses, and temporary conditions.\n\n### When to Use This Skill\n\n- Creating equipment bonuses that modify actor stats\n- Implementing buff/debuff spells with duration\n- Setting up status conditions (prone, stunned, etc.)\n- Using CUSTOM mode for complex calculations\n- Managing effect transfer from items to actors\n\n## ActiveEffect Structure\n\n### Core Properties\n\n```javascript\n{\n  name: \"Shield of Faith\",\n  img: \"icons/magic/defensive/shield.png\",\n  disabled: false,\n  transfer: true,           // Transfer from item to actor\n  origin: \"Item.abc123\",    // Source reference\n  statuses: [\"blessed\"],    // Status identifiers\n  changes: [\n    {\n      key: \"system.attributes.ac.bonus\",\n      mode: 2,              // ADD\n      value: \"2\"\n    }\n  ],\n  duration: {\n    seconds: 600,           // 10 minutes\n    rounds: null,\n    turns: null,\n    combat: null,\n    startTime: null,\n    startRound: null,\n    startTurn: null\n  }\n}\n```\n\n## Effect Modes\n\n### CONST.ACTIVE_EFFECT_MODES\n\n| Mode | Value | Behavior |\n|------|-------|----------|\n| CUSTOM | 0 | System-specific logic via hook |\n| ADD | 1 | Sum numbers, concat strings |\n| MULTIPLY | 2 | Multiply numeric values |\n| OVERRIDE | 3 | Replace value entirely |\n| UPGRADE | 4 | Use if value > current |\n| DOWNGRADE | 5 | Use if value < current |\n\n### Mode Examples\n\n```javascript\n// ADD - most common\n{ key: \"system.attributes.ac.bonus\", mode: 2, value: \"2\" }\n\n// MULTIPLY - percentage bonuses\n{ key: \"system.attributes.movement.walk\", mode: 2, value: \"1.5\" }\n\n// OVERRIDE - fixed values\n{ key: \"system.attributes.ac.calc\", mode: 3, value: \"natural\" }\n\n// UPGRADE - only if better\n{ key: \"system.abilities.str.value\", mode: 4, value: \"19\" }\n\n// DOWNGRADE - only if worse\n{ key: \"system.abilities.dex.value\", mode: 5, value: \"4\" }\n```\n\n## Effect Application Timing\n\n### prepareData Order\n\n```javascript\n// Actor.prepareData() execution:\n1. this.data.reset()              // Reset to source\n2. this.prepareBaseData()         // Basic setup\n3. this.prepareEmbeddedDocuments() // Effects apply HERE\n4. this.prepareDerivedData()      // Calculate derived values\n```\n\n**Critical:** Effects apply in step 3, so they cannot modify values created in step 4.\n\n### Solution: Initialize in prepareBaseData\n\n```javascript\nprepareBaseData() {\n  // Initialize values that effects will target\n  this.system.attributes.ac.bonus = 0;\n  this.system.modifiers.all = [];\n}\n\nprepareDerivedData() {\n  // Use modified values here\n  const ac = this.system.attributes.ac.base +\n             this.system.attributes.ac.bonus;\n}\n```\n\n## CUSTOM Mode\n\nFor complex calculations, use mode 0 with the `applyActiveEffect` hook:\n\n```javascript\nHooks.on(\"applyActiveEffect\", (actor, change, current, delta, changes) => {\n  // Only handle our custom keys\n  if (!change.key.startsWith(\"system.custom.\")) return;\n\n  switch (change.key) {\n    case \"system.custom.damageReduction\":\n      // Stack damage reduction multiplicatively\n      const existing = current || 1;\n      changes[change.key] = existing * (1 - delta);\n      break;\n\n    case \"system.custom.attackBonus\":\n      // Add with diminishing returns\n      const bonus = current || 0;\n      changes[change.key] = bonus + Math.floor(delta / (1 + bonus / 10));\n      break;\n  }\n});\n```\n\n### Hook Parameters\n\n- **actor**: The Actor receiving the effect\n- **change**: The EffectChangeData object\n- **current**: Current value at the key\n- **delta**: Parsed change value (already type-converted)\n- **changes**: Accumulator - modify this to apply changes\n\n## Duration Tracking\n\n### Combat Duration\n\n```javascript\nconst combatEffect = {\n  name: \"Haste\",\n  changes: [...],\n  duration: {\n    rounds: 10,\n    combat: game.combat?.id,\n    startRound: game.combat?.round,\n    startTurn: game.combat?.turn\n  }\n};\n\nawait actor.createEmbeddedDocuments(\"ActiveEffect\", [combatEffect]);\n```\n\n### World Time Duration\n\n```javascript\nconst timedEffect = {\n  name: \"Poison\",\n  changes: [...],\n  duration: {\n    seconds: 3600,  // 1 hour\n    startTime: game.time.worldTime\n  }\n};\n```\n\n### Checking Remaining Duration\n\n```javascript\n// Combat-based\nconst remaining = effect.duration.rounds -\n  (game.combat.round - effect.duration.startRound);\n\n// Time-based\nconst elapsed = game.time.worldTime - effect.duration.startTime;\nconst remaining = effect.duration.seconds - elapsed;\n```\n\n## Effect Transfer\n\n### Legacy Mode (Default)\n\nEffects are copied from Item to Actor when embedded:\n\n```javascript\n// Default: CONFIG.ActiveEffect.legacyTransferral = true\n// Effect is duplicated to actor.effects\n```\n\n### Modern Mode (Recommended)\n\nEffects stay on Item but apply to parent Actor:\n\n```javascript\n// In system init:\nCONFIG.ActiveEffect.legacyTransferral = false;\n\n// Benefits:\n// - Edit effects without re-adding items\n// - Cleaner data model\n// - Effects removed when item removed\n```\n\n### Transfer Property\n\n```javascript\n{\n  name: \"Magic Sword Bonus\",\n  transfer: true,   // Apply to actor (default)\n  // transfer: false  // Stay on item only\n  changes: [...]\n}\n```\n\n## Common Patterns\n\n### Equipment Bonus\n\n```javascript\nconst magicArmorEffect = {\n  name: \"+2 Armor\",\n  img: \"icons/equipment/chest/plate.png\",\n  transfer: true,\n  changes: [\n    {\n      key: \"system.attributes.ac.bonus\",\n      mode: 2,  // ADD\n      value: \"2\"\n    }\n  ]\n};\n\nawait item.createEmbeddedDocuments(\"ActiveEffect\", [magicArmorEffect]);\n```\n\n### Temporary Buff\n\n```javascript\nasync function applyBless(actor) {\n  await actor.createEmbeddedDocuments(\"ActiveEffect\", [{\n    name: \"Bless\",\n    img: \"icons/magic/holy/prayer.png\",\n    statuses: [\"blessed\"],\n    changes: [\n      { key: \"system.bonuses.attack\", mode: 2, value: \"1d4\" },\n      { key: \"system.bonuses.save\", mode: 2, value: \"1d4\" }\n    ],\n    duration: {\n      rounds: 10,\n      combat: game.combat?.id,\n      startRound: game.combat?.round\n    }\n  }]);\n}\n```\n\n### Status Condition\n\n```javascript\nconst proneEffect = {\n  name: \"Prone\",\n  img: \"icons/svg/falling.svg\",\n  statuses: [\"prone\"],\n  changes: [\n    { key: \"system.attributes.ac.bonus\", mode: 2, value: \"-4\" }\n  ],\n  flags: {\n    core: { statusId: \"prone\" }\n  }\n};\n```\n\n### Formula-Based Value\n\n```javascript\n{\n  key: \"system.attributes.ac.bonus\",\n  mode: 2,\n  value: \"@abilities.dex.mod\"  // Roll data reference\n}\n```\n\n## Common Pitfalls\n\n### 1. Targeting Derived Values\n\n```javascript\n// WRONG - calculated in prepareDerivedData, too late\n{ key: \"system.attributes.ac.value\", ... }\n\n// CORRECT - target the bonus that feeds into calculation\n{ key: \"system.attributes.ac.bonus\", ... }\n```\n\n### 2. Modifying Items Directly\n\n```javascript\n// WRONG - effects cannot modify embedded items\n{ key: \"items.0.system.damage\", ... }\n\n// CORRECT - modify actor data only\n{ key: \"system.bonuses.weaponDamage\", ... }\n```\n\n### 3. Forgetting to Initialize\n\n```javascript\n// WRONG - bonus undefined, effect fails\nprepareDerivedData() {\n  this.system.ac.total = this.system.ac.base + this.system.ac.bonus;\n}\n\n// CORRECT - initialize in prepareBaseData\nprepareBaseData() {\n  this.system.ac.bonus = 0;\n}\n```\n\n### 4. String vs Number Values\n\n```javascript\n// Effect values are always strings in the changes array\n{ key: \"system.hp.bonus\", mode: 2, value: \"10\" }\n\n// ADD mode parses to number automatically\n// For CUSTOM mode, parse manually:\nconst numValue = Number(change.value);\n```\n\n### 5. Checking Effect Active State\n\n```javascript\n// Always check before processing\nfor (const effect of actor.effects) {\n  if (!effect.active) continue;  // Skip disabled\n  // Process effect...\n}\n\n// Or use the filtered collection\nfor (const effect of actor.appliedEffects) {\n  // Only active effects\n}\n```\n\n### 6. Duration Display Lag\n\n```javascript\n// UI may not update in real-time\n// Close/reopen sheet to see accurate duration\n// Or force refresh:\nawait effect.updateDuration();\n```\n\n## Finding Valid Keys\n\n```javascript\n// Discover available data paths:\nconst paths = Object.keys(\n  foundry.utils.flattenObject(game.system.model.Actor.character)\n);\nconsole.log(paths);\n\n// Or inspect a specific actor:\nconsole.log(Object.keys(\n  foundry.utils.flattenObject(actor.system)\n));\n```\n\n## Implementation Checklist\n\n- [ ] Initialize effect targets in `prepareBaseData()`\n- [ ] Use correct mode for the modification type\n- [ ] Set `transfer: true` for item effects that apply to actors\n- [ ] Include duration for temporary effects\n- [ ] Add statuses array for conditions\n- [ ] Implement CUSTOM mode hook for complex logic\n- [ ] Check `effect.active` before processing\n- [ ] Test with multiple stacking effects\n- [ ] Verify effects removed when source removed\n\n## References\n\n- [ActiveEffect API](https://foundryvtt.com/api/classes/foundry.documents.ActiveEffect.html)\n- [Active Effects Primer](https://foundryvtt.wiki/en/development/guides/active-effects)\n- [V11 Active Effects Changes](https://foundryvtt.com/article/v11-active-effects/)\n- [applyActiveEffect Hook](https://foundryvtt.com/api/functions/hookEvents.applyActiveEffect.html)\n\n---\n\n**Last Updated:** 2026-01-05\n**Status:** Production-Ready\n**Maintainer:** ImproperSubset\n",
        "fvtt-dev/skills/fvtt-applications/SKILL.md": "---\nname: fvtt-applications\ndescription: This skill should be used when creating custom windows with ApplicationV2, building forms with FormApplication, using Dialog for prompts, understanding the render lifecycle, or migrating from Application v1 to ApplicationV2.\n---\n\n# Foundry VTT Applications\n\n**Domain:** Foundry VTT Module/System Development\n**Status:** Production-Ready\n**Last Updated:** 2026-01-05\n\n## Overview\n\nApplications are the window/dialog system in Foundry. ApplicationV2 (V12+) is the modern framework replacing the legacy Application v1 (deprecated, removed in V16).\n\n### When to Use This Skill\n\n- Creating custom UI windows\n- Building data entry forms\n- Showing confirmation dialogs\n- Understanding render lifecycle\n- Migrating v1 applications to v2\n\n## ApplicationV2 Basics\n\n### Minimal Application\n\n```javascript\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\nclass MyWindow extends HandlebarsApplicationMixin(ApplicationV2) {\n  static DEFAULT_OPTIONS = {\n    id: \"my-window\",\n    classes: [\"my-module\"],\n    position: { width: 400, height: \"auto\" },\n    window: {\n      title: \"My Window\",\n      icon: \"fas fa-gear\"\n    }\n  };\n\n  static PARTS = {\n    main: {\n      template: \"modules/my-module/templates/window.hbs\"\n    }\n  };\n\n  async _prepareContext(options) {\n    return {\n      message: \"Hello World\"\n    };\n  }\n}\n\n// Usage\nnew MyWindow().render(true);\n```\n\n### Form Application\n\n```javascript\nclass MyForm extends HandlebarsApplicationMixin(ApplicationV2) {\n  static DEFAULT_OPTIONS = {\n    id: \"my-form\",\n    tag: \"form\",  // CRITICAL for form handling\n    window: { title: \"Settings\" },\n    position: { width: 500 },\n    form: {\n      handler: MyForm.#onSubmit,\n      submitOnChange: false,\n      closeOnSubmit: true\n    }\n  };\n\n  static PARTS = {\n    form: {\n      template: \"modules/my-module/templates/form.hbs\"\n    }\n  };\n\n  async _prepareContext() {\n    return {\n      settings: this.settings\n    };\n  }\n\n  static async #onSubmit(event, form, formData) {\n    const data = foundry.utils.expandObject(formData.object);\n    console.log(\"Submitted:\", data);\n    // Process form data\n  }\n}\n```\n\n## DialogV2\n\n### Confirmation Dialog\n\n```javascript\nconst confirmed = await foundry.applications.api.DialogV2.confirm({\n  window: { title: \"Confirm\" },\n  content: \"<p>Delete this item?</p>\"\n});\n\nif (confirmed) {\n  await item.delete();\n}\n```\n\n### Input Prompt\n\n```javascript\nconst name = await foundry.applications.api.DialogV2.prompt({\n  window: { title: \"Enter Name\" },\n  content: \"<p>What is your character's name?</p>\",\n  label: \"Submit\"\n});\n```\n\n### Custom Buttons\n\n```javascript\nconst result = await foundry.applications.api.DialogV2.wait({\n  window: { title: \"Choose Action\" },\n  content: \"<p>What would you like to do?</p>\",\n  buttons: [{\n    icon: \"fas fa-check\",\n    label: \"Accept\",\n    action: \"accept\"\n  }, {\n    icon: \"fas fa-times\",\n    label: \"Decline\",\n    action: \"decline\"\n  }]\n});\n\nif (result === \"accept\") {\n  // Handle accept\n}\n```\n\n### Form Dialog\n\n```javascript\nconst data = await foundry.applications.api.DialogV2.prompt({\n  window: { title: \"Configure\" },\n  content: `\n    <div class=\"form-group\">\n      <label>Name</label>\n      <input type=\"text\" name=\"name\" value=\"\">\n    </div>\n    <div class=\"form-group\">\n      <label>Level</label>\n      <input type=\"number\" name=\"level\" value=\"1\">\n    </div>\n  `,\n  ok: {\n    callback: (event, button, dialog) => {\n      const form = dialog.querySelector(\"form\");\n      return new FormDataExtended(form).object;\n    }\n  }\n});\n```\n\n## Render Lifecycle\n\n### Key Methods\n\n```javascript\nclass MyApp extends HandlebarsApplicationMixin(ApplicationV2) {\n  // Prepare data for template\n  async _prepareContext(options) {\n    return { items: this.items };\n  }\n\n  // Prepare data for specific part\n  async _preparePartContext(partId, context) {\n    if (partId === \"list\") {\n      context.sortedItems = this.sortItems(context.items);\n    }\n    return context;\n  }\n\n  // After first render only\n  async _onFirstRender(context, options) {\n    this.setupInitialState();\n  }\n\n  // After every render\n  async _onRender(context, options) {\n    this.attachEventListeners();\n  }\n}\n```\n\n### Lifecycle Order\n\n```\nrender(true) called\n  â†’ _preRender()\n  â†’ _prepareContext()\n  â†’ _preparePartContext() (per part)\n  â†’ Template rendering\n  â†’ _onFirstRender() (first time only)\n  â†’ _onRender()\n  â†’ Hook: renderMyApp\n```\n\n## Event Handling\n\n### Static Actions (Recommended)\n\n```javascript\nclass MyApp extends HandlebarsApplicationMixin(ApplicationV2) {\n  static DEFAULT_OPTIONS = {\n    actions: {\n      delete: MyApp.#onDelete,\n      edit: MyApp.#onEdit\n    }\n  };\n\n  static async #onDelete(event, target) {\n    const itemId = target.dataset.itemId;\n    await this.deleteItem(itemId);\n  }\n\n  static #onEdit(event, target) {\n    const itemId = target.dataset.itemId;\n    this.editItem(itemId);\n  }\n}\n```\n\nTemplate:\n```handlebars\n<button type=\"button\" data-action=\"delete\" data-item-id=\"{{item.id}}\">\n  Delete\n</button>\n```\n\n### Manual Listeners in _onRender\n\n```javascript\nasync _onRender(context, options) {\n  this.element.querySelector(\".custom-button\")\n    ?.addEventListener(\"click\", this._onCustomClick.bind(this));\n}\n\n_onCustomClick(event) {\n  event.preventDefault();\n  // Handle click\n}\n```\n\n## Multi-Part Templates\n\n### PARTS Configuration\n\n```javascript\nstatic PARTS = {\n  header: {\n    template: \"modules/my-mod/templates/header.hbs\"\n  },\n  tabs: {\n    template: \"templates/generic/tab-navigation.hbs\"\n  },\n  content: {\n    template: \"modules/my-mod/templates/content.hbs\",\n    scrollable: [\"\"]  // Enable scroll preservation\n  },\n  footer: {\n    template: \"modules/my-mod/templates/footer.hbs\"\n  }\n};\n```\n\n### Tab Navigation\n\n```javascript\nstatic PARTS = {\n  tabs: { template: \"templates/generic/tab-navigation.hbs\" },\n  details: { template: \"templates/details.hbs\" },\n  inventory: { template: \"templates/inventory.hbs\" }\n};\n\nstatic TABS = {\n  primary: {\n    tabs: [\n      { id: \"details\", label: \"Details\" },\n      { id: \"inventory\", label: \"Inventory\" }\n    ],\n    initial: \"details\"\n  }\n};\n\nasync _prepareContext(options) {\n  const context = await super._prepareContext(options);\n  context.tabs = this._prepareTabs();\n  return context;\n}\n\nasync _preparePartContext(partId, context) {\n  if ([\"details\", \"inventory\"].includes(partId)) {\n    context.tab = context.tabs[partId];\n  }\n  return context;\n}\n```\n\n## Legacy FormApplication (V1)\n\nFor maintenance of existing code only:\n\n```javascript\nclass LegacyForm extends FormApplication {\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      id: \"legacy-form\",\n      title: \"Legacy Form\",\n      template: \"modules/my-mod/templates/form.hbs\",\n      width: 400,\n      closeOnSubmit: true\n    });\n  }\n\n  getData() {\n    return { data: this.object };\n  }\n\n  async _updateObject(event, formData) {\n    await this.object.update(formData);\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n    html.find(\".button\").click(this._onClick.bind(this));\n  }\n}\n```\n\n## Common Pitfalls\n\n### 1. Missing tag: \"form\"\n\n```javascript\n// WRONG - form submission won't work\nstatic DEFAULT_OPTIONS = {\n  form: { handler: MyApp.#onSubmit }\n};\n\n// CORRECT\nstatic DEFAULT_OPTIONS = {\n  tag: \"form\",\n  form: { handler: MyApp.#onSubmit }\n};\n```\n\n### 2. Button Submits Form\n\n```html\n<!-- WRONG - triggers form submission -->\n<button>Click Me</button>\n\n<!-- CORRECT - won't submit form -->\n<button type=\"button\">Click Me</button>\n```\n\n### 3. DialogV2 Re-render\n\n```javascript\n// WRONG - DialogV2 cannot re-render\nconst dialog = new DialogV2({...});\nawait dialog.render(true);\nawait dialog.render(true);  // Error!\n\n// CORRECT - use ApplicationV2 for re-renderable windows\nclass MyDialog extends HandlebarsApplicationMixin(ApplicationV2) {}\n```\n\n### 4. Async in _prepareContext\n\n```javascript\n// Always await async operations\nasync _prepareContext(options) {\n  const data = await this.loadData();  // OK\n  return { data };\n}\n```\n\n### 5. Losing this Context\n\n```javascript\n// WRONG - loses context\nthis.element.addEventListener(\"click\", this._onClick);\n\n// CORRECT - bind context\nthis.element.addEventListener(\"click\", this._onClick.bind(this));\n\n// Or use arrow function\nthis.element.addEventListener(\"click\", (e) => this._onClick(e));\n```\n\n### 6. Form Spacing Issues\n\n```handlebars\n{{!-- Use standard-form class --}}\n<div class=\"standard-form\">\n  <div class=\"form-group\">\n    <label>Field</label>\n    <input type=\"text\" name=\"field\">\n  </div>\n</div>\n```\n\n## Implementation Checklist\n\n### ApplicationV2\n- [ ] Extend `HandlebarsApplicationMixin(ApplicationV2)`\n- [ ] Define `static DEFAULT_OPTIONS` with id, classes, position\n- [ ] Define `static PARTS` for templates\n- [ ] Implement `_prepareContext()` for template data\n- [ ] Set `tag: \"form\"` for form applications\n- [ ] Define `form.handler` for form submission\n- [ ] Use `data-action` attributes with static actions\n- [ ] Use `type=\"button\"` on non-submit buttons\n\n### DialogV2\n- [ ] Use `DialogV2.confirm()` for yes/no prompts\n- [ ] Use `DialogV2.prompt()` for text input\n- [ ] Use `DialogV2.wait()` for custom buttons\n- [ ] Remember DialogV2 cannot re-render\n\n## References\n\n- [ApplicationV2 API](https://foundryvtt.com/api/classes/foundry.applications.api.ApplicationV2.html)\n- [DialogV2 API](https://foundryvtt.com/api/classes/foundry.applications.api.DialogV2.html)\n- [ApplicationV2 Wiki](https://foundryvtt.wiki/en/development/api/applicationv2)\n- [Conversion Guide](https://foundryvtt.wiki/en/development/guides/applicationV2-conversion-guide)\n- [FormApplication (Legacy)](https://foundryvtt.com/api/classes/foundry.appv1.api.FormApplication.html)\n\n---\n\n**Last Updated:** 2026-01-05\n**Status:** Production-Ready\n**Maintainer:** ImproperSubset\n",
        "fvtt-dev/skills/fvtt-canvas/SKILL.md": "---\nname: fvtt-canvas\ndescription: This skill should be used when working with the Foundry canvas, PIXI.js rendering, canvas layers, placeable objects (tokens, tiles, drawings), render flags for performance, or canvas lifecycle hooks like canvasReady.\n---\n\n# Foundry VTT Canvas & PIXI.js\n\n**Domain:** Foundry VTT Module/System Development\n**Status:** Production-Ready\n**Last Updated:** 2026-01-05\n\n## Overview\n\nThe Foundry canvas is a WebGL-powered HTML5 canvas using PIXI.js for rendering. Understanding the layer architecture and PIXI basics is essential for visual customizations.\n\n### When to Use This Skill\n\n- Adding custom visual elements to the canvas\n- Extending token/tile rendering\n- Working with canvas layers\n- Optimizing render performance\n- Handling canvas lifecycle events\n\n## Canvas Architecture\n\n### Layer Hierarchy (Bottom to Top)\n\n**Primary Group:**\n- Background Layer - Scene backdrop\n- Token Layer - Characters and creatures\n- Tile Layer - Props and decorations\n- Foreground Layer - Overlay images\n- Weather Layer - Environmental effects\n- Effects/Lighting - Vision and lighting\n\n**Interface Group:**\n- Walls Layer - Movement/sight blocking\n- Sounds Layer - Audio zones\n- Drawings Layer - User markup\n- Templates Layer - Spell areas\n- Notes Layer - Journal pins\n- Controls Layer - Selection UI\n- Grid Layer - Grid overlay\n\n### Accessing Layers\n\n```javascript\ncanvas.tokens      // TokenLayer\ncanvas.tiles       // TileLayer\ncanvas.drawings    // DrawingsLayer\ncanvas.templates   // TemplatesLayer\ncanvas.walls       // WallsLayer\ncanvas.lighting    // LightingLayer\ncanvas.sounds      // SoundsLayer\ncanvas.notes       // NotesLayer\ncanvas.grid        // GridLayer\n\ncanvas.primary     // PrimaryCanvasGroup\ncanvas.interface   // InterfaceCanvasGroup\ncanvas.environment // EnvironmentCanvasGroup\n```\n\n## PIXI.js Basics\n\n### Containers\n\nGroup objects together:\n\n```javascript\nconst group = new PIXI.Container();\ngroup.addChild(sprite1);\ngroup.addChild(sprite2);\n\n// Position the group (moves all children)\ngroup.position.set(100, 100);\ngroup.rotation = Math.PI / 4;\n\ncanvas.tokens.addChild(group);\n```\n\n### Sprites\n\nDisplay images:\n\n```javascript\nconst sprite = PIXI.Sprite.from(\"path/to/image.png\");\n\n// Use anchor for rotation center (0-1 percentage)\nsprite.anchor.set(0.5);  // Center\n\nsprite.position.set(100, 100);\nsprite.width = 50;\nsprite.height = 50;\nsprite.rotation = Math.PI / 4;  // Radians\nsprite.alpha = 0.8;\nsprite.tint = 0xFF0000;  // Red tint\n```\n\n### Graphics\n\nDraw shapes programmatically:\n\n```javascript\nconst graphics = new PIXI.Graphics();\n\n// Filled rectangle\ngraphics.beginFill(0x0000FF, 0.5);  // Blue, 50% alpha\ngraphics.drawRect(0, 0, 100, 100);\ngraphics.endFill();\n\n// Stroked circle\ngraphics.lineStyle(2, 0xFF0000);  // 2px red line\ngraphics.drawCircle(50, 50, 25);\n\n// Polygon\ngraphics.beginFill(0x00FF00);\ngraphics.drawPolygon([0, 0, 50, 100, 100, 0]);\ngraphics.endFill();\n\ncanvas.drawings.addChild(graphics);\n```\n\n### Visual Effects\n\n```javascript\n// Transparency\nsprite.alpha = 0.5;\n\n// Color tint (multiply)\nsprite.tint = 0xFF0000;  // Red\nsprite.tint = 0xFFFFFF;  // No change (white)\n\n// Blend modes\nsprite.blendMode = PIXI.BLEND_MODES.ADD;       // Glow effect\nsprite.blendMode = PIXI.BLEND_MODES.MULTIPLY;  // Darken\nsprite.blendMode = PIXI.BLEND_MODES.SCREEN;    // Lighten\n\n// Filters (use sparingly - performance impact)\nconst blur = new PIXI.BlurFilter();\nblur.blur = 10;\nsprite.filters = [blur];\n```\n\n### Masking\n\n```javascript\n// Graphics mask\nconst mask = new PIXI.Graphics();\nmask.beginFill(0xFFFFFF);\nmask.drawCircle(50, 50, 50);\nmask.endFill();\n\ncontainer.mask = mask;\ncontainer.addChild(contentToMask);\n```\n\n## Placeable Objects\n\n### Common Placeables\n\n- **Token** - Actor representation\n- **Tile** - Static artwork\n- **Drawing** - User shapes\n- **Note** - Journal pin\n- **Wall** - Blocking segment\n- **AmbientLight** - Light source\n- **AmbientSound** - Audio emitter\n- **MeasuredTemplate** - Area indicator\n\n### PlaceableObject Properties\n\n```javascript\nconst token = canvas.tokens.get(tokenId);\n\ntoken.document    // TokenDocument\ntoken.scene       // Parent Scene\ntoken.isOwner     // Ownership check\n\n// Permission checks\ntoken.can(\"update\")\ntoken.can(\"delete\")\ntoken.can(\"control\")\n```\n\n### PlaceableObject Methods\n\n```javascript\n// Control\ntoken.control();           // Select\ntoken.release();           // Deselect\nawait token.rotate(45);    // Rotate by degrees\n\n// Rendering\nawait token.draw();        // Full redraw\ntoken.refresh();           // Incremental update\n```\n\n## Render Flags\n\nOptimize updates by specifying what changed:\n\n### Token Render Flags\n\n```javascript\ntoken.renderFlags.set({\n  refreshPosition: true,    // X/Y changed\n  refreshSize: true,        // Width/height changed\n  refreshRotation: true,    // Angle changed\n  refreshBars: true,        // HP bars changed\n  refreshEffects: true,     // Status icons changed\n  refreshBorder: true,      // Selection border\n  refreshVisibility: true,  // Vision state\n  refreshElevation: true,   // Z-axis display\n  refreshNameplate: true,   // Name display\n  redraw: true              // Complete redraw\n});\n```\n\n### Why Use Render Flags\n\n```javascript\n// BAD - full redraw every time\ntoken.draw();\ntoken.draw();\ntoken.draw();\n\n// GOOD - batch incremental updates\ntoken.renderFlags.set({ refreshPosition: true });\ntoken.renderFlags.set({ refreshBars: true });\n// Updates happen efficiently in next render cycle\n```\n\n## Canvas Lifecycle\n\n### Initialization Order\n\n```\ninit\n  â†’ setup\n    â†’ canvasConfig\n      â†’ canvasInit\n        â†’ ready\n          â†’ canvasReady\n```\n\n### Key Hooks\n\n```javascript\n// Canvas fully ready - safe to access all layers\nHooks.on(\"canvasReady\", (canvas) => {\n  console.log(\"Scene:\", canvas.scene.name);\n  console.log(\"Tokens:\", canvas.tokens.placeables.length);\n});\n\n// Canvas being torn down\nHooks.on(\"canvasTearDown\", (canvas) => {\n  // Clean up custom elements\n});\n\n// Canvas panned/zoomed\nHooks.on(\"canvasPan\", (canvas, position) => {\n  console.log(\"New center:\", position.x, position.y);\n  console.log(\"Scale:\", position.scale);\n});\n```\n\n### Waiting for Canvas\n\n```javascript\n// Promise-based\nawait canvas.ready;\n\n// Hook-based\nHooks.once(\"canvasReady\", () => {\n  // Safe to interact\n});\n```\n\n## Common Patterns\n\n### Add Custom Layer Element\n\n```javascript\nHooks.on(\"canvasReady\", () => {\n  const marker = new PIXI.Graphics();\n  marker.beginFill(0xFF0000);\n  marker.drawCircle(0, 0, 20);\n  marker.endFill();\n  marker.position.set(500, 500);\n\n  canvas.interface.addChild(marker);\n});\n```\n\n### Extend Token Rendering\n\n```javascript\nclass CustomToken extends Token {\n  async _draw() {\n    await super._draw();\n\n    // Add custom aura\n    const aura = new PIXI.Graphics();\n    aura.beginFill(0x00FF00, 0.2);\n    aura.drawCircle(0, 0, this.w);\n    aura.endFill();\n\n    this.addChildAt(aura, 0);  // Behind token\n  }\n}\n\n// Register\nCONFIG.Token.objectClass = CustomToken;\n```\n\n### Coordinate Conversion\n\n```javascript\n// Client (viewport) to canvas coordinates\nconst canvasCoords = canvas.canvasCoordinatesFromClient({\n  x: event.clientX,\n  y: event.clientY\n});\n\n// Canvas to client coordinates\nconst clientCoords = canvas.clientCoordinatesFromCanvas({\n  x: 500,\n  y: 500\n});\n```\n\n### Pan and Zoom\n\n```javascript\n// Instant pan\nawait canvas.pan({ x: 1000, y: 1000 });\n\n// Animated pan\nawait canvas.animatePan({\n  x: 1000,\n  y: 1000,\n  scale: 1.5,\n  duration: 1000\n});\n\n// Center on controlled token\nawait canvas.recenter();\n```\n\n## Common Pitfalls\n\n### 1. Accessing Canvas Before Ready\n\n```javascript\n// WRONG - canvas not initialized\nHooks.on(\"init\", () => {\n  canvas.tokens.placeables;  // undefined!\n});\n\n// CORRECT - wait for canvasReady\nHooks.on(\"canvasReady\", () => {\n  canvas.tokens.placeables;  // works\n});\n```\n\n### 2. Direct DOM Manipulation\n\n```javascript\n// WRONG - breaks PIXI rendering\nelement.style.transform = \"rotate(45deg)\";\n\n// CORRECT - use PIXI properties\nsprite.angle = 45;  // degrees\nsprite.rotation = Math.PI / 4;  // radians\n```\n\n### 3. Wrong Canvas Group\n\n```javascript\n// WRONG - bypasses layer hierarchy\ncanvas.app.stage.addChild(myGraphics);\n\n// CORRECT - add to appropriate group\ncanvas.interface.addChild(myGraphics);\n```\n\n### 4. Excessive Filters\n\n```javascript\n// BAD - major performance hit\nobject.filters = [blur, color, displacement, glow];\n\n// BETTER - minimal filters, combine effects\nobject.filters = [combinedEffect];\n```\n\n### 5. Not Cleaning Up\n\n```javascript\n// Remember to remove custom elements\nHooks.on(\"canvasTearDown\", () => {\n  myCustomElement.destroy();\n});\n```\n\n### 6. Forgetting Anchor/Pivot\n\n```javascript\n// Rotation around top-left (default)\nsprite.rotation = Math.PI / 4;\n\n// Rotation around center (usually desired)\nsprite.anchor.set(0.5);\nsprite.rotation = Math.PI / 4;\n```\n\n## Implementation Checklist\n\n- [ ] Wait for `canvasReady` before canvas access\n- [ ] Add elements to correct canvas group/layer\n- [ ] Use PIXI properties, not DOM manipulation\n- [ ] Set anchor/pivot for rotation center\n- [ ] Use render flags for efficient updates\n- [ ] Clean up custom elements on `canvasTearDown`\n- [ ] Use filters sparingly\n- [ ] Test at different zoom levels\n- [ ] Handle scene changes gracefully\n\n## References\n\n- [Canvas API](https://foundryvtt.com/api/classes/foundry.canvas.Canvas.html)\n- [Canvas Wiki](https://foundryvtt.wiki/en/development/api/canvas)\n- [PIXI.js Guide](https://foundryvtt.wiki/en/development/guides/pixi)\n- [PlaceableObject API](https://foundryvtt.com/api/classes/foundry.canvas.placeables.PlaceableObject.html)\n- [Token API](https://foundryvtt.com/api/classes/foundry.canvas.placeables.Token.html)\n- [PixiJS Documentation](https://pixijs.io/guides/)\n\n---\n\n**Last Updated:** 2026-01-05\n**Status:** Production-Ready\n**Maintainer:** ImproperSubset\n",
        "fvtt-dev/skills/fvtt-chat-messages/SKILL.md": "---\nname: fvtt-chat-messages\ndescription: This skill should be used when creating chat messages, sending roll results to chat, configuring speakers, implementing whispers and roll modes, or hooking into chat message rendering.\n---\n\n# Foundry VTT Chat Messages\n\n**Domain:** Foundry VTT Module/System Development\n**Status:** Production-Ready\n**Last Updated:** 2026-01-05\n\n## Overview\n\nChatMessage documents display in the chat log and handle rolls, whispers, and player communication. Understanding message creation and hooks is essential for game system features.\n\n### When to Use This Skill\n\n- Creating chat messages programmatically\n- Sending dice roll results to chat\n- Configuring message speakers\n- Implementing whispers and roll modes\n- Adding custom rendering to messages\n\n## ChatMessage Structure\n\n### Core Fields\n\n```javascript\n{\n  _id: \"documentId\",\n  author: \"userId\",           // Who created the message\n  content: \"<p>HTML</p>\",     // Message content\n  flavor: \"Roll description\", // Flavor text for rolls\n  speaker: {                  // Who is \"speaking\"\n    scene: \"sceneId\",\n    actor: \"actorId\",\n    token: \"tokenId\",\n    alias: \"Display Name\"\n  },\n  whisper: [\"userId\"],        // Private recipients\n  blind: false,               // GM-only visibility\n  rolls: [],                  // Dice roll data\n  sound: \"audio/path.ogg\",    // Sound to play\n  flags: {}                   // Custom data\n}\n```\n\n## Creating Messages\n\n### Simple Text Message\n\n```javascript\nawait ChatMessage.create({\n  content: \"Hello, world!\"\n});\n```\n\n### Message with Speaker\n\n```javascript\nawait ChatMessage.create({\n  content: \"I attack the dragon!\",\n  speaker: ChatMessage.getSpeaker({ actor: myActor })\n});\n```\n\n### HTML Content\n\n```javascript\nawait ChatMessage.create({\n  content: `\n    <h2>Critical Hit!</h2>\n    <p>You deal <strong>24</strong> damage.</p>\n  `,\n  speaker: ChatMessage.getSpeaker({ token: myToken })\n});\n```\n\n### With Custom Flags\n\n```javascript\nawait ChatMessage.create({\n  content: \"Attack roll\",\n  flags: {\n    \"my-module\": {\n      rollType: \"attack\",\n      targetId: target.id\n    }\n  }\n});\n```\n\n## Roll Messages\n\n### Using Roll.toMessage() (Recommended)\n\n```javascript\nconst roll = new Roll(\"1d20 + @mod\", { mod: 5 });\nawait roll.evaluate();\n\nawait roll.toMessage({\n  speaker: ChatMessage.getSpeaker({ actor }),\n  flavor: \"Attack Roll\"\n});\n```\n\n### With Roll Mode\n\n```javascript\nawait roll.toMessage({\n  speaker: ChatMessage.getSpeaker({ actor }),\n  flavor: \"Stealth Check\"\n}, {\n  rollMode: game.settings.get(\"core\", \"rollMode\")\n});\n```\n\n### Multiple Rolls\n\n```javascript\nconst attackRoll = new Roll(\"1d20 + 5\");\nconst damageRoll = new Roll(\"2d6 + 3\");\n\nawait attackRoll.evaluate();\nawait damageRoll.evaluate();\n\nawait ChatMessage.create({\n  speaker: ChatMessage.getSpeaker({ actor }),\n  flavor: \"Attack and Damage\",\n  rolls: [attackRoll, damageRoll]\n});\n```\n\n## Speaker Configuration\n\n### getSpeaker()\n\n```javascript\n// From controlled token (default)\nconst speaker = ChatMessage.getSpeaker();\n\n// From specific actor\nconst speaker = ChatMessage.getSpeaker({ actor: myActor });\n\n// From specific token\nconst speaker = ChatMessage.getSpeaker({ token: myToken });\n\n// Custom alias\nconst speaker = ChatMessage.getSpeaker({ alias: \"The Narrator\" });\n```\n\n### Speaker Structure\n\n```javascript\n{\n  scene: \"sceneId\",      // Scene where speaker is\n  actor: \"actorId\",      // Actor document ID\n  token: \"tokenId\",      // Token document ID\n  alias: \"Display Name\"  // Fallback name\n}\n```\n\n### Get Speaker's Actor\n\n```javascript\nconst actor = ChatMessage.getSpeakerActor(message.speaker);\n```\n\n## Whispers and Roll Modes\n\n### Roll Modes\n\n| Mode | Visibility | Command |\n|------|------------|---------|\n| Public | Everyone | `/publicroll` |\n| GM | Roller + GMs | `/gmroll` |\n| Blind | GMs only | `/blindroll` |\n| Self | Roller only | `/selfroll` |\n\n### Apply Roll Mode\n\n```javascript\n// Get current setting\nconst rollMode = game.settings.get(\"core\", \"rollMode\");\n\n// Apply to roll\nawait roll.toMessage({\n  speaker: ChatMessage.getSpeaker({ actor })\n}, {\n  rollMode: rollMode\n});\n```\n\n### Whisper to Specific Users\n\n```javascript\n// Single user\nawait ChatMessage.create({\n  content: \"Secret message\",\n  whisper: [targetUserId]\n});\n\n// Multiple users\nawait ChatMessage.create({\n  content: \"Group secret\",\n  whisper: [user1Id, user2Id]\n});\n\n// All GMs\nawait ChatMessage.create({\n  content: \"GM only\",\n  whisper: game.users.filter(u => u.isGM).map(u => u.id)\n});\n```\n\n### Blind Messages\n\n```javascript\n// GM sees content, others see \"???\"\nawait ChatMessage.create({\n  content: \"Secret roll result: 15\",\n  blind: true,\n  whisper: game.users.filter(u => u.isGM).map(u => u.id)\n});\n```\n\n## Chat Hooks\n\n### renderChatMessageHTML (V13+)\n\n```javascript\nHooks.on(\"renderChatMessageHTML\", (message, html, context) => {\n  // message: ChatMessage document\n  // html: HTMLElement\n  // context: Rendering context\n\n  // Add custom styling\n  if (message.flags[\"my-module\"]?.critical) {\n    html.classList.add(\"critical-hit\");\n  }\n\n  // Add buttons\n  const button = document.createElement(\"button\");\n  button.textContent = \"Apply Damage\";\n  button.addEventListener(\"click\", () => applyDamage(message));\n  html.querySelector(\".message-content\").append(button);\n});\n```\n\n### preCreateChatMessage\n\n```javascript\nHooks.on(\"preCreateChatMessage\", (message, data, options, userId) => {\n  // Modify before creation\n  message.updateSource({\n    content: data.content + \" (modified)\"\n  });\n\n  // Return false to cancel\n  return true;\n});\n```\n\n### createChatMessage\n\n```javascript\nHooks.on(\"createChatMessage\", (message, options, userId) => {\n  // After creation, for all clients\n  console.log(\"New message:\", message.content);\n});\n```\n\n### chatMessage\n\n```javascript\nHooks.on(\"chatMessage\", (chatLog, messageText, chatData) => {\n  // When user sends message via input\n  // Return false to prevent default handling\n\n  if (messageText.startsWith(\"/custom\")) {\n    handleCustomCommand(messageText);\n    return false;\n  }\n});\n```\n\n## Common Patterns\n\n### Roll with Button\n\n```javascript\nasync function attackRoll(actor, target) {\n  const roll = new Roll(\"1d20 + @mod\", actor.getRollData());\n  await roll.evaluate();\n\n  await roll.toMessage({\n    speaker: ChatMessage.getSpeaker({ actor }),\n    flavor: `Attack vs ${target.name}`,\n    flags: {\n      \"my-system\": {\n        type: \"attack\",\n        targetId: target.id,\n        total: roll.total\n      }\n    }\n  });\n}\n\n// Handle button clicks\nHooks.on(\"renderChatMessageHTML\", (message, html) => {\n  const flags = message.flags[\"my-system\"];\n  if (flags?.type !== \"attack\") return;\n\n  html.querySelector(\".apply-damage\")?.addEventListener(\"click\", () => {\n    const target = game.actors.get(flags.targetId);\n    // Apply damage logic\n  });\n});\n```\n\n### Collapsible Details\n\n```javascript\nawait ChatMessage.create({\n  content: `\n    <div class=\"roll-result\">\n      <h3>Attack Roll: 18</h3>\n      <details>\n        <summary>Details</summary>\n        <p>Base: 1d20 = 13</p>\n        <p>Modifier: +5</p>\n      </details>\n    </div>\n  `\n});\n```\n\n### Sound with Message\n\n```javascript\nawait ChatMessage.create({\n  content: \"The bell tolls...\",\n  sound: \"sounds/bell.ogg\"\n});\n```\n\n## Common Pitfalls\n\n### 1. Forgetting Roll Evaluation\n\n```javascript\n// WRONG - total is undefined\nconst roll = new Roll(\"1d20\");\nawait roll.toMessage();  // roll.total undefined!\n\n// CORRECT\nconst roll = new Roll(\"1d20\");\nawait roll.evaluate();\nawait roll.toMessage();\n```\n\n### 2. Wrong Speaker Token\n\n```javascript\n// WRONG - uses first controlled token\nChatMessage.getSpeaker();\n\n// CORRECT - specify the token\nChatMessage.getSpeaker({ token: specificToken });\n```\n\n### 3. Whisper vs Roll Mode Conflict\n\n```javascript\n// Roll messages override whisper with rollMode\n// Use rollMode for roll messages:\nawait roll.toMessage({}, {\n  rollMode: \"gmroll\"  // Not whisper: [...]\n});\n```\n\n### 4. Ignoring Roll Mode Setting\n\n```javascript\n// WRONG - always public\nawait roll.toMessage();\n\n// CORRECT - respect user setting\nawait roll.toMessage({}, {\n  rollMode: game.settings.get(\"core\", \"rollMode\")\n});\n```\n\n### 5. Message Update Timing\n\n```javascript\n// Updating too fast causes UI issues\n// Wait for notification to fade (~3 seconds)\nconst msg = await ChatMessage.create({ content: \"Loading...\" });\nsetTimeout(() => {\n  msg.update({ content: \"Done!\" });\n}, 3500);\n```\n\n### 6. Not Checking Visibility\n\n```javascript\n// Check if message is visible to current user\nif (!message.visible) return;\n\n// Check if content is visible (not just presence)\nif (message.isContentVisible) {\n  // Safe to read content\n}\n```\n\n## Implementation Checklist\n\n- [ ] Use `ChatMessage.getSpeaker()` for proper speaker\n- [ ] Always `await roll.evaluate()` before toMessage\n- [ ] Respect `game.settings.get(\"core\", \"rollMode\")`\n- [ ] Use `renderChatMessageHTML` hook for customization\n- [ ] Store custom data in flags, not content\n- [ ] Handle whisper recipients appropriately\n- [ ] Test all roll modes (public, GM, blind, self)\n- [ ] Add sound effects where appropriate\n\n## References\n\n- [ChatMessage API](https://foundryvtt.com/api/classes/foundry.documents.ChatMessage.html)\n- [Chat Messages Article](https://foundryvtt.com/article/chat/)\n- [Roll API](https://foundryvtt.com/api/classes/foundry.dice.Roll.html)\n- [renderChatMessageHTML Hook](https://foundryvtt.com/api/functions/hookEvents.renderChatMessageHTML.html)\n\n---\n\n**Last Updated:** 2026-01-05\n**Status:** Production-Ready\n**Maintainer:** ImproperSubset\n",
        "fvtt-dev/skills/fvtt-combat/SKILL.md": "---\nname: fvtt-combat\ndescription: This skill should be used when working with the Combat tracker, Combatant documents, initiative rolling and sorting, turn/round management, or implementing combat hooks like combatStart, combatTurn, and combatRound.\n---\n\n# Foundry VTT Combat System\n\n**Domain:** Foundry VTT Module/System Development\n**Status:** Production-Ready\n**Last Updated:** 2026-01-05\n\n## Overview\n\nFoundry's combat system manages turn-based encounters through Combat and Combatant documents. Understanding the combat lifecycle is essential for game system development.\n\n### When to Use This Skill\n\n- Implementing initiative rolling formulas\n- Managing turn order and round progression\n- Hooking into combat events\n- Extending combat behavior for game systems\n- Creating combat-related UI features\n\n## Combat Document\n\n### Core Properties\n\n```javascript\ngame.combat            // Active combat encounter\ngame.combats           // All combat encounters\ngame.combats.active    // Currently active combat\n\n// Combat properties\ncombat.round           // Current round number\ncombat.turn            // Current turn index\ncombat.active          // Is combat started?\ncombat.combatants      // EmbeddedCollection of Combatants\ncombat.combatant       // Current turn's Combatant\ncombat.scene           // Linked Scene\n```\n\n### Combat Methods\n\n```javascript\n// Start/end combat\nawait combat.startCombat();\nawait combat.endCombat();\n\n// Navigation\nawait combat.nextTurn();\nawait combat.previousTurn();\nawait combat.nextRound();\nawait combat.previousRound();\n\n// Initiative\nawait combat.rollInitiative([\"combatantId\"]);\nawait combat.rollAll();    // Roll for all\nawait combat.rollNPC();    // Roll for NPCs only\nawait combat.resetAll();   // Clear all initiative\n```\n\n## Combatant Document\n\n### Core Properties\n\n```javascript\ncombatant.actor        // Associated Actor\ncombatant.token        // Token data (not Token instance)\ncombatant.initiative   // Initiative value\ncombatant.active       // Is current turn?\ncombatant.defeated     // Defeated status\ncombatant.hidden       // Hidden from players?\ncombatant.players      // Owning players\n```\n\n### Combatant Methods\n\n```javascript\n// Roll initiative for this combatant\nawait combatant.rollInitiative();\n\n// Get Roll without rolling\nconst roll = combatant.getInitiativeRoll();\nconst customRoll = combatant.getInitiativeRoll(\"1d20+5\");\n```\n\n## Initiative\n\n### Roll Initiative\n\n```javascript\n// Single combatant\nawait combat.rollInitiative(\"combatantId\");\n\n// Multiple combatants\nawait combat.rollInitiative([\"id1\", \"id2\"]);\n\n// With options\nawait combat.rollInitiative([\"id1\"], {\n  formula: \"1d20 + @abilities.dex.mod\",\n  messageOptions: { flavor: \"Initiative\" },\n  updateTurn: true\n});\n```\n\n### Custom Initiative Formula\n\nOverride in your system's Combatant class:\n\n```javascript\nclass MyCombatant extends Combatant {\n  _getInitiativeFormula() {\n    const actor = this.actor;\n    if (!actor) return \"1d20\";\n\n    // System-specific formula\n    return `1d20 + @abilities.dex.mod + @initiative.bonus`;\n  }\n}\n\n// Register\nCONFIG.Combatant.documentClass = MyCombatant;\n```\n\n### Custom Sort Order\n\n```javascript\nclass MyCombat extends Combat {\n  _sortCombatants(a, b) {\n    // Higher initiative first\n    const initA = a.initiative ?? -Infinity;\n    const initB = b.initiative ?? -Infinity;\n    if (initA !== initB) return initB - initA;\n\n    // Tie-breaker: alphabetical\n    return a.name.localeCompare(b.name);\n  }\n}\n\nCONFIG.Combat.documentClass = MyCombat;\n```\n\n## Combat Hooks\n\n### combatStart\n\n```javascript\nHooks.on(\"combatStart\", (combat, updateData) => {\n  console.log(`Combat started: Round ${updateData.round}`);\n});\n```\n\n### combatTurn\n\n```javascript\nHooks.on(\"combatTurn\", (combat, updateData, updateOptions) => {\n  const combatant = combat.combatants.contents[updateData.turn];\n  console.log(`${combatant.name}'s turn`);\n\n  // updateOptions.direction: 1 (forward) or -1 (backward)\n});\n```\n\n### combatRound\n\n```javascript\nHooks.on(\"combatRound\", (combat, updateData, updateOptions) => {\n  console.log(`Round ${updateData.round} started`);\n});\n```\n\n### updateCombat\n\n```javascript\nHooks.on(\"updateCombat\", (combat, changes, options, userId) => {\n  if (\"turn\" in changes) {\n    console.log(\"Turn changed\");\n  }\n  if (\"round\" in changes) {\n    console.log(\"Round changed\");\n  }\n});\n```\n\n## Extending Combat\n\n### Workflow Methods\n\nOverride these for system-specific behavior:\n\n```javascript\nclass MyCombat extends Combat {\n  // Called at start of each turn\n  async _onStartTurn(combatant) {\n    await super._onStartTurn(combatant);\n\n    // Decrement duration effects\n    const actor = combatant.actor;\n    if (actor) {\n      await this._decrementEffects(actor);\n    }\n  }\n\n  // Called at end of each turn\n  async _onEndTurn(combatant) {\n    await super._onEndTurn(combatant);\n\n    // Process end-of-turn effects\n  }\n\n  // Called at start of each round\n  async _onStartRound() {\n    await super._onStartRound();\n\n    // Reset per-round resources\n    for (const c of this.combatants) {\n      await c.actor?.resetRoundResources?.();\n    }\n  }\n\n  // Called at end of each round\n  async _onEndRound() {\n    await super._onEndRound();\n  }\n\n  async _decrementEffects(actor) {\n    for (const effect of actor.effects) {\n      if (effect.duration.rounds) {\n        const remaining = effect.duration.rounds - 1;\n        if (remaining <= 0) {\n          await effect.delete();\n        } else {\n          await effect.update({ \"duration.rounds\": remaining });\n        }\n      }\n    }\n  }\n}\n\nCONFIG.Combat.documentClass = MyCombat;\n```\n\n### GM-Only Execution\n\nWorkflow methods only run for one GM. Handle player-side logic with hooks:\n\n```javascript\n// This runs for all clients\nHooks.on(\"combatTurn\", (combat, update, options) => {\n  // Player-safe logic here\n});\n```\n\n## Common Patterns\n\n### Get Current Combatant\n\n```javascript\nfunction getCurrentCombatant() {\n  const combat = game.combat;\n  if (!combat?.started) return null;\n  return combat.combatant;\n}\n```\n\n### Check If Actor's Turn\n\n```javascript\nfunction isActorsTurn(actor) {\n  const combat = game.combat;\n  if (!combat?.started) return false;\n  return combat.combatant?.actor?.id === actor.id;\n}\n```\n\n### Add Token to Combat\n\n```javascript\nasync function addToCombat(token) {\n  let combat = game.combat;\n\n  // Create combat if none exists\n  if (!combat) {\n    combat = await Combat.create({ scene: token.scene.id });\n  }\n\n  // Add combatant\n  await combat.createEmbeddedDocuments(\"Combatant\", [{\n    tokenId: token.id,\n    actorId: token.actor?.id,\n    sceneId: token.scene.id\n  }]);\n}\n```\n\n### Skip Defeated Combatants\n\n```javascript\nclass MyCombat extends Combat {\n  async nextTurn() {\n    let next = this.turn + 1;\n    let round = this.round;\n\n    // Skip defeated\n    while (this.combatants.contents[next]?.defeated) {\n      next++;\n      if (next >= this.combatants.size) {\n        next = 0;\n        round++;\n      }\n    }\n\n    return this.update({ turn: next, round });\n  }\n}\n```\n\n## Common Pitfalls\n\n### 1. Empty Combat Errors\n\n```javascript\n// WRONG - errors with no combatants\nconst combat = await Combat.create({ scene: sceneId });\nawait combat.startCombat();  // Error!\n\n// CORRECT - add combatants first\nconst combat = await Combat.create({\n  scene: sceneId,\n  combatants: [{ tokenId: token1.id }]\n});\nawait combat.startCombat();\n```\n\n### 2. Token vs TokenDocument\n\n```javascript\n// combatant.token is TokenDocument data, not Token\nconst tokenData = combatant.token;  // Plain object\n\n// To get actual Token instance:\nconst token = canvas.tokens.get(combatant.tokenId);\n```\n\n### 3. Null Initiative\n\n```javascript\n// Initiative can be null before rolling\nconst init = combatant.initiative;  // Could be null\n\n// Handle null in comparisons\nconst sortedInit = init ?? -Infinity;\n```\n\n### 4. Workflow Method Timing\n\n```javascript\n// _onStartTurn runs AFTER the turn changes\n// Use hooks if you need to act BEFORE\nHooks.on(\"preUpdateCombat\", (combat, changes) => {\n  // Runs before any combat update\n});\n```\n\n### 5. Linked vs Unlinked Tokens\n\n```javascript\n// Be aware of token linking\nif (combatant.token.actorLink) {\n  // Changes affect the base Actor\n} else {\n  // Changes only affect this token's synthetic actor\n}\n```\n\n### 6. Multiple GM Execution\n\n```javascript\n// Workflow methods only run for one GM\n// Don't rely on them for all-client logic\n\n// Use hooks for all-client execution\nHooks.on(\"combatTurn\", () => {\n  // Runs on all clients\n});\n```\n\n## Implementation Checklist\n\n- [ ] Register custom Combat/Combatant classes in CONFIG\n- [ ] Override `_getInitiativeFormula()` for system formula\n- [ ] Implement `_sortCombatants()` for custom ordering\n- [ ] Use workflow methods for GM-only automation\n- [ ] Use hooks for all-client logic\n- [ ] Handle null initiative values\n- [ ] Check `combat.started` before accessing turn data\n- [ ] Consider defeated/hidden combatants\n- [ ] Test with multiple GMs connected\n\n## References\n\n- [Combat API](https://foundryvtt.com/api/classes/foundry.documents.Combat.html)\n- [Combatant API](https://foundryvtt.com/api/classes/foundry.documents.Combatant.html)\n- [Combat Encounters Article](https://foundryvtt.com/article/combat/)\n- [Hook Events](https://foundryvtt.com/api/modules/hookEvents.html)\n\n---\n\n**Last Updated:** 2026-01-05\n**Status:** Production-Ready\n**Maintainer:** ImproperSubset\n",
        "fvtt-dev/skills/fvtt-compendiums/SKILL.md": "---\nname: fvtt-compendiums\ndescription: This skill should be used when creating compendium packs, registering packs in manifests, importing/exporting documents, querying pack contents, or using the CLI for pack management and version control workflows.\n---\n\n# Foundry VTT Compendium Packs\n\n**Domain:** Foundry VTT Module/System Development\n**Status:** Production-Ready\n**Last Updated:** 2026-01-05\n\n## Overview\n\nCompendium packs store pre-built content (actors, items, journal entries, etc.) for distribution with modules and systems. Understanding pack management is essential for content creation.\n\n### When to Use This Skill\n\n- Creating content packs for distribution\n- Registering packs in module/system manifests\n- Importing/exporting documents programmatically\n- Setting up version control workflows with CLI\n- Querying and searching pack contents\n\n## Pack Registration\n\n### Manifest Configuration\n\n```json\n{\n  \"id\": \"my-module\",\n  \"packs\": [\n    {\n      \"name\": \"monsters\",\n      \"label\": \"Monsters\",\n      \"type\": \"Actor\",\n      \"path\": \"./packs/monsters\",\n      \"system\": \"dnd5e\"\n    },\n    {\n      \"name\": \"items\",\n      \"label\": \"Magic Items\",\n      \"type\": \"Item\",\n      \"path\": \"./packs/items\"\n    }\n  ]\n}\n```\n\n### Valid Document Types\n\n- `Actor` - Characters, NPCs, creatures\n- `Item` - Equipment, spells, features\n- `JournalEntry` - Lore, handouts\n- `RollTable` - Random tables\n- `Scene` - Maps and encounters\n- `Macro` - Executable scripts\n- `Playlist` - Audio collections\n- `Cards` - Card decks\n- `Adventure` - Mixed content bundles\n\n### Directory Structure\n\n```\nmy-module/\nâ”œâ”€â”€ module.json\nâ”œâ”€â”€ packs/\nâ”‚   â”œâ”€â”€ monsters/     # LevelDB folder (V11+)\nâ”‚   â””â”€â”€ items/\nâ””â”€â”€ src/\n    â””â”€â”€ packs/        # JSON/YAML source (for version control)\n```\n\n## Accessing Packs\n\n### Get Pack Reference\n\n```javascript\nconst pack = game.packs.get(\"my-module.monsters\");\n\n// Check properties\nconsole.log(pack.locked);    // Edit lock status\nconsole.log(pack.visible);   // User visibility\nconsole.log(pack.metadata);  // Pack configuration\n```\n\n### Load Index (Lightweight)\n\n```javascript\n// Get minimal cached data\nconst index = await pack.getIndex();\n\nfor (const entry of index) {\n  console.log(entry._id, entry.name);\n}\n```\n\n### Get Single Document\n\n```javascript\nconst actor = await pack.getDocument(documentId);\nconsole.log(actor.name, actor.system);\n```\n\n### Get Multiple Documents\n\n```javascript\n// All documents (expensive for large packs)\nconst allDocs = await pack.getDocuments();\n\n// Filtered query\nconst npcs = await pack.getDocuments({ type: \"npc\" });\n```\n\n### Search Contents\n\n```javascript\nconst results = await pack.search({\n  query: \"dragon\",\n  fields: [\"name\", \"system.description\"]\n});\n```\n\n## Import/Export\n\n### Import Document to World\n\n```javascript\n// From pack to world\nconst pack = game.packs.get(\"my-module.monsters\");\nconst doc = await pack.getDocument(docId);\nconst imported = await Actor.create(doc.toObject());\n```\n\n### Export Document to Pack\n\n```javascript\n// Requires unlocked pack\nconst pack = game.packs.get(\"my-module.monsters\");\n\nif (!pack.locked) {\n  await pack.importDocument(existingActor);\n}\n```\n\n### Bulk Import\n\n```javascript\nawait pack.importAll({\n  folderName: \"Imported Monsters\",\n  keepId: true  // Preserve document IDs\n});\n```\n\n## CLI Workflow\n\n### Installation\n\n```bash\nnpm install @foundryvtt/foundryvtt-cli --save-dev\n```\n\n### Extract for Version Control\n\n```bash\n# Unpack to JSON/YAML\nfvtt package unpack -n \"monsters\" \\\n  --outputDirectory \"./src/packs/monsters\" \\\n  --yaml \\\n  --folders \\\n  --omitVolatile\n```\n\n### Repack for Distribution\n\n```bash\n# Pack back to LevelDB\nfvtt package pack -n \"monsters\" \\\n  --inputDirectory \"./src/packs/monsters\" \\\n  --outputDirectory \"./packs\"\n```\n\n### Programmatic API\n\n```javascript\nimport { extractPack, compilePack } from \"@foundryvtt/foundryvtt-cli\";\n\n// Extract\nawait extractPack({\n  packName: \"monsters\",\n  outputDir: \"./src/packs\",\n  yaml: true,\n  omitVolatile: true\n});\n\n// Compile\nawait compilePack({\n  packName: \"monsters\",\n  inputDir: \"./src/packs\",\n  outputDir: \"./packs\"\n});\n```\n\n## Version Control Setup\n\n### Git Attributes\n\n```gitattributes\n# Treat LevelDB as binary\npacks/** binary\n```\n\n### Recommended Workflow\n\n1. **Development**: Edit JSON/YAML in `src/packs/`\n2. **Build**: Run `fvtt package pack` before commit\n3. **Commit**: Include both source and compiled packs\n4. **Release**: LevelDB packs ready for distribution\n\n### Volatile Fields\n\nThese fields change on access and should be omitted:\n\n```javascript\n// Use --omitVolatile flag\n_stats.createdTime\n_stats.modifiedTime\n_stats.lastModifiedBy\n_stats.systemVersion\n_stats.coreVersion\n```\n\n## Common Patterns\n\n### Safe Pack Modification\n\n```javascript\nasync function addToPack(packId, documentData) {\n  const pack = game.packs.get(packId);\n\n  if (pack.locked) {\n    ui.notifications.warn(\"Pack is locked\");\n    return null;\n  }\n\n  return await pack.importDocument(\n    new Actor(documentData)\n  );\n}\n```\n\n### Filter Index by Name\n\n```javascript\nasync function findByName(packId, searchName) {\n  const pack = game.packs.get(packId);\n  const index = await pack.getIndex();\n\n  return index.filter(entry =>\n    entry.name.toLowerCase().includes(searchName.toLowerCase())\n  );\n}\n```\n\n### Import with Folder\n\n```javascript\nasync function importWithFolder(packId, folderName) {\n  const pack = game.packs.get(packId);\n\n  // Create folder if needed\n  let folder = game.folders.find(f =>\n    f.name === folderName && f.type === pack.metadata.type\n  );\n\n  if (!folder) {\n    folder = await Folder.create({\n      name: folderName,\n      type: pack.metadata.type\n    });\n  }\n\n  // Import all to folder\n  const docs = await pack.getDocuments();\n  for (const doc of docs) {\n    const data = doc.toObject();\n    data.folder = folder.id;\n    await doc.constructor.create(data);\n  }\n}\n```\n\n## Common Pitfalls\n\n### 1. Forgetting Async/Await\n\n```javascript\n// WRONG - returns promise, not document\nconst doc = pack.getDocument(id);\nconsole.log(doc.name);  // undefined!\n\n// CORRECT\nconst doc = await pack.getDocument(id);\nconsole.log(doc.name);  // \"Dragon\"\n```\n\n### 2. Modifying Locked Packs\n\n```javascript\n// WRONG - will fail silently or error\nawait pack.importDocument(actor);\n\n// CORRECT - check lock first\nif (!pack.locked) {\n  await pack.importDocument(actor);\n} else {\n  ui.notifications.warn(\"Unlock the pack first\");\n}\n```\n\n### 3. Loading All Documents\n\n```javascript\n// BAD - memory issues with large packs\nconst all = await pack.getDocuments();\n\n// BETTER - use index for listings\nconst index = await pack.getIndex();\n// Only load specific documents when needed\n```\n\n### 4. User Data Overwrite\n\n```javascript\n// WARNING: Module updates overwrite pack contents\n// Never store user-created content in module packs\n// Use world compendiums for user content\n```\n\n### 5. Missing System Field\n\n```javascript\n// WRONG - pack won't work with system\n{\n  \"name\": \"items\",\n  \"type\": \"Item\",\n  \"path\": \"./packs/items\"\n}\n\n// CORRECT - include system for typed content\n{\n  \"name\": \"items\",\n  \"type\": \"Item\",\n  \"path\": \"./packs/items\",\n  \"system\": \"dnd5e\"\n}\n```\n\n### 6. Wrong Pack Path\n\n```javascript\n// V11+ uses folders, not .db files\n// WRONG\n\"path\": \"./packs/monsters.db\"\n\n// CORRECT\n\"path\": \"./packs/monsters\"\n```\n\n## Implementation Checklist\n\n- [ ] Register packs in manifest with correct type\n- [ ] Include `system` field for system-specific content\n- [ ] Use folders (not .db files) for V11+ packs\n- [ ] Set up CLI for version control workflow\n- [ ] Use `--omitVolatile` when extracting for git\n- [ ] Check `pack.locked` before modifications\n- [ ] Use index for listings, documents for details\n- [ ] Test import/export in fresh world\n- [ ] Add `.gitattributes` for binary packs\n\n## References\n\n- [Compendium Packs Article](https://foundryvtt.com/article/compendium/)\n- [CompendiumCollection API](https://foundryvtt.com/api/classes/client.CompendiumCollection.html)\n- [Content Packaging Guide](https://foundryvtt.com/article/packaging-guide/)\n- [V11 LevelDB Changes](https://foundryvtt.com/article/v11-leveldb-packs/)\n- [CLI Package](https://www.npmjs.com/package/@foundryvtt/foundryvtt-cli)\n\n---\n\n**Last Updated:** 2026-01-05\n**Status:** Production-Ready\n**Maintainer:** ImproperSubset\n",
        "fvtt-dev/skills/fvtt-data-migrations/SKILL.md": "---\nname: fvtt-data-migrations\ndescription: This skill should be used when moving data between storage locations, changing data structures, renaming fields, or removing deprecated data. Covers schema versioning, safe migration methods, the Foundry unset operator, and idempotent migrations.\n---\n\n# Foundry VTT Data Migrations\n\nImplement safe, version-controlled data migrations for Foundry VTT modules when changing data structures or storage locations.\n\n## When to Use This Skill\n\nInvoke this skill when implementing changes that require migrating existing user data:\n\n### âœ… ALWAYS Create Migration For:\n\n1. **Moving data between storage locations:**\n   - `actor.system.field` â†’ `actor.flags.myModule.field`\n   - `actor.system.field` â†’ embedded item\n   - Flag namespace changes\n\n2. **Changing data structures:**\n   - Array â†’ Object/Map\n   - Object â†’ Array\n   - Flat structure â†’ nested structure\n   - Renaming properties\n\n3. **Changing data types:**\n   - String â†’ Number\n   - Boolean â†’ String (enum)\n   - Single value â†’ Array\n   - Null semantics changes\n\n4. **Removing deprecated data:**\n   - Cleaning up orphaned flags\n   - Removing obsolete system fields\n   - Purging invalid data\n\n5. **Foundry version compatibility:**\n   - API changes between Foundry versions\n   - Deprecation of core fields\n\n### âŒ NO Migration Needed For:\n\n1. **Additive changes only:**\n   - Adding NEW optional fields (with defaults)\n   - Adding NEW features that don't touch existing data\n   - UI-only changes (CSS, templates without data changes)\n\n2. **Non-breaking changes:**\n   - Adding new flags alongside existing ones\n   - Extending data without modifying existing structure\n   - Backwards-compatible additions\n\n## Foundry Migration System Overview\n\n### Schema Version Pattern\n\nFoundry modules track data structure versions using a `schemaVersion` setting:\n\n```javascript\n// In settings.js - register the version tracker\ngame.settings.register(\"my-module\", \"schemaVersion\", {\n  name: \"Schema Version\",\n  scope: \"world\",        // World-level (not per-client)\n  config: false,         // Hidden from UI\n  type: Number,\n  default: 0,            // 0 = never migrated\n});\n```\n\n**How it works:**\n1. New worlds start at version 0\n2. Each migration increments the version (1, 2, 3...)\n3. Migration runs ONCE per world, on first `ready` hook\n4. If `currentVersion >= targetVersion`, migration is skipped\n\n### Migration Lifecycle\n\n```\nWorld Created (v0)\n    â†“\nFirst Load â†’ ready hook\n    â†“\nMigration.migrate() called\n    â†“\nCheck: currentVersion (0) < targetVersion (1)?\n    â†“ YES\nRun migration steps\n    â†“\nSet schemaVersion = 1\n    â†“\nShow completion notification\n    â†“\nFuture loads: currentVersion (1) >= targetVersion (1) â†’ SKIP\n```\n\n## Step-by-Step Migration Workflow\n\n### Step 1: Identify the Breaking Change\n\n**Ask yourself:**\n- What data structure is changing?\n- Where is the old data stored? (system field? flag? embedded doc?)\n- Where will the new data be stored?\n- What transformation is needed?\n\n**Example scenarios:**\n\n```javascript\n// Scenario A: Moving system field to flag\nOLD: actor.system[\"background-details\"]\nNEW: actor.flags[\"bitd-alternate-sheets\"].background_details\n\n// Scenario B: Changing structure\nOLD: actor.flags.myModule[\"equipped-items\"] = [{ id: \"abc\" }, { id: \"def\" }]\nNEW: actor.flags.myModule[\"equipped-items\"] = { \"abc\": {...}, \"def\": {...} }\n\n// Scenario C: Cleaning up orphaned data\nOLD: actor.flags.myModule.abilityProgress = { \"Reflexes\": 2, \"abc123\": 1 }\nNEW: actor.flags.myModule.abilityProgress = { \"abc123\": 1 }  // Remove name-based keys\n```\n\n### Step 2: Increment Target Schema Version\n\n**In `scripts/migration.js`:**\n\n```javascript\nexport class Migration {\n    static async migrate() {\n        const currentVersion = game.settings.get(MODULE_ID, \"schemaVersion\") || 0;\n        const targetVersion = 2;  // â† INCREMENT THIS (was 1, now 2)\n\n        if (currentVersion < targetVersion) {\n            // ... migration logic\n        }\n    }\n}\n```\n\n**Version numbering:**\n- Start: `targetVersion = 1` (first migration)\n- Each new migration: increment by 1 (2, 3, 4...)\n- Never skip numbers\n- Never decrement\n\n### Step 3: Create Migration Method\n\n**Add a new static method to `Migration` class:**\n\n```javascript\nstatic async migrateFieldName(actor) {\n    const oldValue = foundry.utils.getProperty(actor, \"system.old-field\");\n    const newValue = actor.getFlag(MODULE_ID, \"new_field\");\n\n    // Check if migration needed\n    if (!oldValue) return;  // No old data to migrate\n    if (newValue) {\n        // New data already exists - just clean up old\n        await actor.update({ \"system.-=old-field\": null });\n        return;\n    }\n\n    // Perform migration\n    const updates = {};\n    updates[`flags.${MODULE_ID}.new_field`] = oldValue;\n    updates[\"system.-=old-field\"] = null;\n\n    await actor.update(updates);\n    console.log(`[MyModule] Migrated old-field for ${actor.name}`);\n}\n```\n\n**Migration method naming:**\n- `migrate{FeatureName}` - Descriptive of what's being migrated\n- Examples: `migrateEquippedItems`, `migrateAbilityProgress`, `migrateLegacyFields`\n\n### Step 4: Call Migration Method in migrate()\n\n**Add to the migration sequence:**\n\n```javascript\nstatic async migrate() {\n    const currentVersion = game.settings.get(MODULE_ID, \"schemaVersion\") || 0;\n    const targetVersion = 2;\n\n    if (currentVersion < targetVersion) {\n        ui.notifications.info(\n            \"My Module: Migrating data, please wait...\"\n        );\n\n        for (const actor of game.actors) {\n            if (actor.type !== \"character\") continue;\n\n            // Step 1: Existing migration\n            await this.migrateEquippedItems(actor);\n\n            // Step 2: NEW migration (add here)\n            await this.migrateFieldName(actor);\n        }\n\n        await game.settings.set(MODULE_ID, \"schemaVersion\", targetVersion);\n        ui.notifications.info(\"My Module: Migration complete.\");\n    }\n}\n```\n\n**Order considerations:**\n- Dependencies first (if migration B relies on migration A, run A first)\n- Independent migrations can be in any order\n- Comment the purpose of each step\n\n### Step 5: Test Migration\n\n**Testing checklist:**\n\n1. **Create test world with OLD data structure:**\n   - Use console to create old-format data: `game.actors.getName(\"Test\").update({ \"system.old-field\": \"test\" })`\n   - Verify old data exists\n\n2. **Trigger migration:**\n   - Reload world (triggers `ready` hook)\n   - Watch console for migration logs\n   - Check for errors\n\n3. **Verify migration results:**\n   - Check new data exists: `game.actors.getName(\"Test\").getFlag(\"my-module\", \"new_field\")`\n   - Check old data removed: `game.actors.getName(\"Test\").system[\"old-field\"]` (should be undefined)\n   - Verify notification appeared\n\n4. **Verify migration runs ONCE:**\n   - Reload world again\n   - Check console - should NOT see migration logs (already at target version)\n\n5. **Test with multiple actors:**\n   - Create several test actors with old data\n   - Verify all migrate correctly\n\n## Safe Migration Patterns\n\n### Pattern 1: System Field â†’ Flag\n\n```javascript\nstatic async migrateLegacyFields(actor) {\n    const updates = {};\n    let changed = false;\n\n    // Get old and new locations\n    const oldValue = foundry.utils.getProperty(actor, \"system.old-field\");\n    const newValue = actor.getFlag(MODULE_ID, \"new_field\");\n\n    if (oldValue && !newValue) {\n        // Old exists, new doesn't - migrate\n        updates[`flags.${MODULE_ID}.new_field`] = oldValue;\n        updates[\"system.-=old-field\"] = null;\n        changed = true;\n    } else if (oldValue && newValue) {\n        // Both exist - favor new, clean up old\n        updates[\"system.-=old-field\"] = null;\n        changed = true;\n    }\n\n    if (changed) {\n        await actor.update(updates);\n        console.log(`[MyModule] Migrated old-field for ${actor.name}`);\n    }\n}\n```\n\n**Key points:**\n- Check both old and new locations\n- Handle case where both exist (favor new)\n- Handle case where only old exists (migrate)\n- Batch updates into single `actor.update()` call\n\n### Pattern 2: Array â†’ Object/Map\n\n```javascript\nstatic async migrateEquippedItems(actor) {\n    const equipped = actor.getFlag(MODULE_ID, \"equipped-items\");\n\n    // Check if still in old format (array)\n    if (Array.isArray(equipped)) {\n        const newMap = {};\n        for (const item of equipped) {\n            if (item && item.id) {\n                newMap[item.id] = item;\n            }\n        }\n\n        await actor.setFlag(MODULE_ID, \"equipped-items\", newMap);\n        console.log(`[MyModule] Migrated equipped items for ${actor.name}`);\n    }\n}\n```\n\n**Key points:**\n- Use `Array.isArray()` to detect old format\n- Transform data structure\n- Handle null/undefined items gracefully\n- Use `setFlag()` to replace entire structure\n\n### Pattern 3: Clean Up Orphaned Data\n\n```javascript\nstatic async migrateAbilityProgress(actor) {\n    const progressMap = actor.getFlag(MODULE_ID, \"abilityProgress\") || {};\n    if (foundry.utils.isEmpty(progressMap)) return;\n\n    let changed = false;\n    const updates = {};\n\n    for (const [key, value] of Object.entries(progressMap)) {\n        // Foundry IDs are always 16 characters\n        if (key.length !== 16) {\n            // This is likely a name-based key (orphaned) - remove it\n            updates[`flags.${MODULE_ID}.abilityProgress.-=${key}`] = null;\n            changed = true;\n        }\n    }\n\n    if (changed) {\n        await actor.update(updates);\n        console.log(`[MyModule] Cleaned orphaned flags for ${actor.name}`);\n    }\n}\n```\n\n**Key points:**\n- Use heuristics to identify orphaned data (length, format, etc.)\n- Use `-=` syntax to remove specific keys: `\"flags.module.field.-=keyToRemove\"`\n- Log what was cleaned for debugging\n\n### Pattern 4: Batch Multiple Field Migrations\n\n```javascript\nstatic async migrateLegacyFields(actor) {\n    const updates = {};\n    let changed = false;\n\n    // Migration 1: background-details\n    const oldDetails = foundry.utils.getProperty(actor, \"system.background-details\");\n    const newDetails = actor.getFlag(MODULE_ID, \"background_details\");\n    if (oldDetails && !newDetails) {\n        updates[`flags.${MODULE_ID}.background_details`] = oldDetails;\n        updates[\"system.-=background-details\"] = null;\n        changed = true;\n    }\n\n    // Migration 2: vice-purveyor\n    const oldPurveyor = foundry.utils.getProperty(actor, \"system.vice-purveyor\");\n    const newPurveyor = actor.getFlag(MODULE_ID, \"vice_purveyor\");\n    if (oldPurveyor && !newPurveyor) {\n        updates[`flags.${MODULE_ID}.vice_purveyor`] = oldPurveyor;\n        updates[\"system.-=vice-purveyor\"] = null;\n        changed = true;\n    }\n\n    // Single batched update for all changes\n    if (changed) {\n        await actor.update(updates);\n        console.log(`[MyModule] Migrated legacy fields for ${actor.name}`);\n    }\n}\n```\n\n**Key points:**\n- Accumulate all updates in single `updates` object\n- Single `actor.update()` call at the end\n- More efficient than multiple sequential updates\n\n## Foundry Document Update Syntax\n\n### Setting Values\n\n```javascript\nupdates[\"system.field\"] = newValue;                 // Set system field\nupdates[`flags.${MODULE_ID}.field`] = newValue;     // Set flag\nupdates[\"system.nested.deep.field\"] = newValue;     // Set nested field\n```\n\n### Removing Fields (Unset)\n\n```javascript\nupdates[\"system.-=oldField\"] = null;                // Remove system field\nupdates[`flags.${MODULE_ID}.-=oldFlag`] = null;     // Remove flag\nupdates[\"flags.module.map.-=keyName\"] = null;       // Remove map key\n```\n\n**The `-=` syntax:**\n- Foundry's special unset operator\n- Completely removes the field from the document\n- Different from setting to `null` or `undefined` (which leaves the key)\n\n### Using foundry.utils.getProperty\n\n```javascript\n// Safe nested property access (returns undefined if any level missing)\nconst value = foundry.utils.getProperty(actor, \"system.deep.nested.field\");\n\n// vs direct access (throws if intermediate property missing)\nconst value = actor.system.deep.nested.field;  // Error if 'deep' undefined!\n```\n\n## Actor Iteration Patterns\n\n### By Actor Type\n\n```javascript\nfor (const actor of game.actors) {\n    if (actor.type !== \"character\") continue;  // Only migrate characters\n    await this.migrateCharacterFields(actor);\n}\n```\n\n### All Actor Types\n\n```javascript\nfor (const actor of game.actors) {\n    // Migrate all actors regardless of type\n    await this.migrateCommonFields(actor);\n}\n```\n\n### Specific Types Only\n\n```javascript\nfor (const actor of game.actors) {\n    if (actor.type === \"character\") {\n        await this.migrateCharacterFields(actor);\n    } else if (actor.type === \"crew\") {\n        await this.migrateCrewFields(actor);\n    }\n}\n```\n\n## User Notifications\n\n```javascript\n// Start notification\nui.notifications.info(\"My Module: Migrating data, please wait...\");\n\n// After migration completes\nui.notifications.info(\"My Module: Migration complete.\");\n\n// Error notification (if migration fails)\nui.notifications.error(\"My Module: Migration failed. See console for details.\");\n```\n\n**When to notify:**\n- Always show start notification (sets user expectation)\n- Always show completion notification\n- Show error notification if any migration fails\n- Keep messages concise and actionable\n\n## Console Logging\n\n```javascript\n// Per-actor migration success\nconsole.log(`[MyModule] Migrated equipped items for ${actor.name}`);\n\n// Overall migration start\nconsole.log(\"[MyModule] Starting migration to schema v2\");\n\n// Debug information\nconsole.log(`[MyModule] Found ${Object.keys(progressMap).length} progress entries`);\n```\n\n**Logging best practices:**\n- Use module prefix: `[MyModule]`\n- Include actor name for per-actor logs\n- Use `console.log` for success (not `console.error`)\n- Log meaningful progress (not every check, just actions taken)\n\n## Common Migration Scenarios\n\n### Scenario: Renaming a Flag\n\n```javascript\nstatic async renameFlag(actor) {\n    const oldValue = actor.getFlag(MODULE_ID, \"oldName\");\n    const newValue = actor.getFlag(MODULE_ID, \"newName\");\n\n    if (oldValue && !newValue) {\n        await actor.setFlag(MODULE_ID, \"newName\", oldValue);\n        await actor.unsetFlag(MODULE_ID, \"oldName\");\n        console.log(`[MyModule] Renamed flag for ${actor.name}`);\n    }\n}\n```\n\n### Scenario: Combining Multiple Flags\n\n```javascript\nstatic async combineFlags(actor) {\n    const flag1 = actor.getFlag(MODULE_ID, \"flag1\");\n    const flag2 = actor.getFlag(MODULE_ID, \"flag2\");\n    const combined = actor.getFlag(MODULE_ID, \"combined\");\n\n    if ((flag1 || flag2) && !combined) {\n        const newValue = {\n            part1: flag1 || {},\n            part2: flag2 || {}\n        };\n\n        const updates = {};\n        updates[`flags.${MODULE_ID}.combined`] = newValue;\n        updates[`flags.${MODULE_ID}.-=flag1`] = null;\n        updates[`flags.${MODULE_ID}.-=flag2`] = null;\n\n        await actor.update(updates);\n        console.log(`[MyModule] Combined flags for ${actor.name}`);\n    }\n}\n```\n\n### Scenario: Migrating Embedded Documents\n\n```javascript\nstatic async migrateItemData(actor) {\n    const updates = [];\n\n    for (const item of actor.items) {\n        if (item.type === \"ability\") {\n            const oldField = item.system.oldField;\n            if (oldField) {\n                updates.push({\n                    _id: item.id,\n                    \"system.newField\": oldField,\n                    \"system.-=oldField\": null\n                });\n            }\n        }\n    }\n\n    if (updates.length > 0) {\n        await actor.updateEmbeddedDocuments(\"Item\", updates);\n        console.log(`[MyModule] Migrated ${updates.length} items for ${actor.name}`);\n    }\n}\n```\n\n## Error Handling\n\n```javascript\nstatic async migrate() {\n    const currentVersion = game.settings.get(MODULE_ID, \"schemaVersion\") || 0;\n    const targetVersion = 2;\n\n    if (currentVersion < targetVersion) {\n        ui.notifications.info(\"My Module: Migrating data, please wait...\");\n\n        try {\n            for (const actor of game.actors) {\n                if (actor.type !== \"character\") continue;\n\n                // Wrap each migration in try-catch to prevent one failure from blocking others\n                try {\n                    await this.migrateEquippedItems(actor);\n                    await this.migrateAbilityProgress(actor);\n                } catch (err) {\n                    console.error(`[MyModule] Migration failed for ${actor.name}:`, err);\n                    ui.notifications.warn(`Migration failed for ${actor.name} - see console`);\n                }\n            }\n\n            // Update version even if some actors failed\n            await game.settings.set(MODULE_ID, \"schemaVersion\", targetVersion);\n            ui.notifications.info(\"My Module: Migration complete.\");\n\n        } catch (err) {\n            console.error(\"[MyModule] Critical migration error:\", err);\n            ui.notifications.error(\"My Module: Migration failed. See console for details.\");\n        }\n    }\n}\n```\n\n**Error handling strategies:**\n- Wrap entire migration in try-catch\n- Optionally wrap per-actor migrations to continue on individual failures\n- Always log errors with context (actor name, migration step)\n- Set schemaVersion even if some migrations fail (prevents infinite retry loop)\n\n## Testing Migration with Console\n\n### Create Test Data (Old Format)\n\n```javascript\n// In browser console\nconst actor = game.actors.getName(\"Test Character\");\n\n// Set old system field\nawait actor.update({ \"system.old-field\": \"test value\" });\n\n// Set old array-based flag\nawait actor.setFlag(\"my-module\", \"equipped-items\", [{ id: \"abc123\" }]);\n\n// Verify old data\nconsole.log(actor.system[\"old-field\"]);  // \"test value\"\nconsole.log(actor.getFlag(\"my-module\", \"equipped-items\"));  // [{ id: \"abc123\" }]\n```\n\n### Trigger Migration Manually\n\n```javascript\n// Force schemaVersion back to 0\nawait game.settings.set(\"my-module\", \"schemaVersion\", 0);\n\n// Run migration\nawait Migration.migrate();\n\n// Check results\nconst actor = game.actors.getName(\"Test Character\");\nconsole.log(actor.getFlag(\"my-module\", \"new_field\"));  // \"test value\"\nconsole.log(actor.system[\"old-field\"]);  // undefined (removed)\n```\n\n## Quick Checklist\n\nBefore committing migration code:\n\n- [ ] Incremented `targetVersion` in `migrate()` method\n- [ ] Created migration method with descriptive name (`migrate{FeatureName}`)\n- [ ] Checked both old and new data locations (handle both-exist case)\n- [ ] Batched updates into single `actor.update()` call\n- [ ] Used `-=` syntax to remove old fields\n- [ ] Added console logging with module prefix and actor name\n- [ ] Called migration method in `migrate()` sequence\n- [ ] Added user notifications (start + complete)\n- [ ] Tested migration with test world containing old data\n- [ ] Verified migration runs ONCE (doesn't re-run on reload)\n- [ ] Tested with multiple actors\n- [ ] Documented migration in PR description\n\n## References\n\n- Migration implementation: `scripts/migration.js`\n- Schema version registration: `scripts/settings.js`\n- Migration trigger: `scripts/module.js` (ready hook)\n- Testing guidelines: `CONTRIBUTING.md` line 56\n\nFor BitD Alternate Sheets module:\n- Schema version registered in `scripts/settings.js` line 59\n- Migration triggered in `scripts/module.js` line 43 (ready hook)\n- Current target version: Check `scripts/migration.js` line 6\n- Typical actor types: `character`, `crew`, `npc`\n",
        "fvtt-dev/skills/fvtt-data-storage/SKILL.md": "---\nname: fvtt-data-storage\ndescription: This skill should be used when choosing between flags, settings, or files for data storage, implementing document flags, registering module settings, handling file uploads, or migrating data between storage types. Covers namespacing, scope types, and performance optimization.\n---\n\n# Foundry VTT Data Storage\n\n**Domain:** Foundry VTT Module/System Development\n**Status:** Production-Ready\n**Last Updated:** 2026-01-04\n\n## Overview\n\nFoundry VTT provides three primary storage mechanisms: Flags (document-attached), Settings (global config), and Files (external storage). Choosing the wrong method is a common source of bugs and performance issues.\n\n### When to Use This Skill\n\n- Deciding where to store module/system data\n- Implementing document-specific custom properties\n- Creating module configuration options\n- Handling large datasets that impact performance\n- Migrating data between storage types\n\n### Quick Decision Matrix\n\n| Need | Use | Why |\n|------|-----|-----|\n| Data on specific document | **Flags** | Travels with document, respects permissions |\n| Global module config | **Settings** (world) | Synced to all clients, GM-controlled |\n| Per-device preference | **Settings** (client) | localStorage, user-specific |\n| Large datasets | **Files** | No performance impact on documents |\n| Export/import data | **Files** | Portable, shareable |\n\n## Flags\n\nFlags attach key-value data to Documents (Actors, Items, Scenes, etc.).\n\n### Basic Usage\n\n```javascript\n// Set a flag\nawait actor.setFlag('my-module', 'customProperty', { value: 42 });\n\n// Get a flag\nconst data = actor.getFlag('my-module', 'customProperty');\n// data === { value: 42 }\n\n// Delete a flag\nawait actor.unsetFlag('my-module', 'customProperty');\n\n// Direct access (read-only)\nconst value = actor.flags['my-module']?.customProperty;\n```\n\n### Namespacing\n\nAlways use your module ID as the scope:\n\n```javascript\n// CORRECT - Uses module ID\nawait doc.setFlag('my-module-id', 'flagName', value);\n\n// WRONG - Generic scope causes collisions\nawait doc.setFlag('world', 'flagName', value);\n```\n\n### Batch Updates\n\n```javascript\n// BAD - Three database writes\nawait actor.setFlag('myModule', 'flag1', value1);\nawait actor.setFlag('myModule', 'flag2', value2);\nawait actor.setFlag('myModule', 'flag3', value3);\n\n// GOOD - Single database write\nawait actor.update({\n  'flags.myModule.flag1': value1,\n  'flags.myModule.flag2': value2,\n  'flags.myModule.flag3': value3\n});\n```\n\n### Nested Flag Operations\n\n```javascript\n// Delete nested key (V10+)\nawait doc.unsetFlag('myModule', 'todos.completedItem');\n\n// Alternative: Foundry deletion syntax\nawait doc.setFlag('myModule', 'todos', { '-=completedItem': null });\n```\n\n### Pitfalls\n\n**1. Periods in Object Keys Break getFlag:**\n\n```javascript\n// BROKEN - Period in key causes issues\nawait doc.setFlag('myModule', 'data', { 'some.key': 'value' });\nconst result = doc.getFlag('myModule', 'data');\n// result !== { 'some.key': 'value' } - Data corrupted!\n\n// WORKAROUND - Use class instance (treated as complex object)\nclass MyData {\n  constructor(data) { Object.assign(this, data); }\n}\nawait doc.setFlag('myModule', 'data', new MyData({ 'some.key': 'value' }));\n```\n\n**2. Inactive Module Throws Error:**\n\n```javascript\n// UNSAFE - Throws if module not installed\nconst value = doc.getFlag('optional-module', 'flag');\n\n// SAFE - Handle missing module\nconst value = doc.flags['optional-module']?.flag ?? defaultValue;\n```\n\n## Settings\n\nSettings store global configuration with different scopes.\n\n### Scope Types\n\n| Scope | Storage | Editable By | Synced | Use For |\n|-------|---------|-------------|--------|---------|\n| `client` | localStorage | Any user | No | UI prefs, device settings |\n| `world` | Database | GM only | Yes | Module config, rules |\n| `user` (V13+) | Database | That user | Yes | Per-user cross-device |\n\n### Registration\n\n```javascript\nHooks.once('init', () => {\n  // Client setting - per-device\n  game.settings.register('myModule', 'theme', {\n    name: 'UI Theme',\n    hint: 'Select your preferred theme',\n    scope: 'client',\n    config: true,\n    type: String,\n    choices: {\n      light: 'Light',\n      dark: 'Dark'\n    },\n    default: 'light',\n    onChange: value => applyTheme(value)\n  });\n\n  // World setting - shared, GM-only\n  game.settings.register('myModule', 'enableFeature', {\n    name: 'Enable Feature',\n    hint: 'Turns on the special feature for all users',\n    scope: 'world',\n    config: true,\n    type: Boolean,\n    default: false,\n    requiresReload: true  // V10+ prompts user to reload\n  });\n});\n```\n\n### Hidden Settings with Menus\n\nFor complex config, hide the setting and use a FormApplication:\n\n```javascript\n// 1. Register menu button\ngame.settings.registerMenu('myModule', 'configMenu', {\n  name: 'Advanced Configuration',\n  label: 'Configure',\n  icon: 'fas fa-cog',\n  type: MyConfigApp,\n  restricted: true  // GM only\n});\n\n// 2. Register hidden backing setting\ngame.settings.register('myModule', 'config', {\n  scope: 'world',\n  config: false,  // Hidden from settings UI\n  type: Object,\n  default: { option1: true, threshold: 10 }\n});\n\n// 3. Access in FormApplication\nclass MyConfigApp extends FormApplication {\n  getData() {\n    return game.settings.get('myModule', 'config');\n  }\n\n  async _updateObject(event, formData) {\n    await game.settings.set('myModule', 'config',\n      foundry.utils.expandObject(formData)\n    );\n  }\n}\n```\n\n### Setting Types\n\n```javascript\n// Choices dropdown\ngame.settings.register('myModule', 'mode', {\n  type: String,\n  choices: { a: 'Option A', b: 'Option B' },\n  default: 'a'\n});\n\n// Number with range slider\ngame.settings.register('myModule', 'volume', {\n  type: Number,\n  range: { min: 0, max: 100, step: 5 },\n  default: 50\n});\n\n// File picker\ngame.settings.register('myModule', 'backgroundImage', {\n  type: String,\n  filePicker: 'image',  // 'audio', 'video', 'any'\n  default: ''\n});\n\n// DataModel for validation (recommended)\ngame.settings.register('myModule', 'validated', {\n  type: MyDataModel,\n  default: {}\n});\n```\n\n### onChange Behavior\n\n```javascript\n// Client scope: fires only on this client\ngame.settings.register('myModule', 'clientSetting', {\n  scope: 'client',\n  onChange: value => {\n    // Only runs locally\n  }\n});\n\n// World scope: fires on ALL clients\ngame.settings.register('myModule', 'worldSetting', {\n  scope: 'world',\n  onChange: value => {\n    // Runs everywhere when GM changes it\n    // Re-fetch to ensure consistency\n    const current = game.settings.get('myModule', 'worldSetting');\n  }\n});\n```\n\n## Files\n\nUse file storage for large datasets or exportable data.\n\n### When to Use Files\n\n- Data > 100KB that would slow document operations\n- Export/import functionality\n- Asset management (images, audio)\n- Sharing data between worlds\n\n### FilePicker Upload\n\n```javascript\n// Upload a file\nconst file = new File(\n  [JSON.stringify(data, null, 2)],\n  'export.json',\n  { type: 'application/json' }\n);\n\nawait FilePicker.upload(\n  'data',           // source: 'data', 'public', 's3'\n  'myModule/data',  // target directory\n  file,\n  {},\n  { notify: true }\n);\n```\n\n### Reading Files\n\n```javascript\n// Fetch and parse JSON\nasync function loadData(path) {\n  const response = await fetch(path);\n  if (!response.ok) throw new Error(`Failed to load ${path}`);\n  return response.json();\n}\n\nconst data = await loadData('modules/myModule/data/config.json');\n```\n\n### Lazy Loading Pattern\n\nStore file reference in flag, load on demand:\n\n```javascript\n// Store reference\nawait actor.setFlag('myModule', 'dataFile', 'myModule/data/actor-123.json');\n\n// Load when needed\nasync function getActorData(actor) {\n  const path = actor.getFlag('myModule', 'dataFile');\n  if (!path) return null;\n  return loadData(path);\n}\n```\n\n## Common Mistakes\n\n### Wrong: Flags for Module Config\n\n```javascript\n// BAD - Config doesn't belong on a random document\nawait game.user.setFlag('myModule', 'globalConfig', config);\n\n// GOOD - Use world setting\ngame.settings.register('myModule', 'globalConfig', {\n  scope: 'world',\n  config: false,\n  type: Object\n});\n```\n\n### Wrong: Large Data in Flags\n\n```javascript\n// BAD - Slows every actor update\nawait actor.setFlag('myModule', 'history', arrayWith10000Entries);\n\n// GOOD - Store in file, reference in flag\nconst file = new File([JSON.stringify(history)], `${actor.id}-history.json`);\nawait FilePicker.upload('data', 'myModule/history', file);\nawait actor.setFlag('myModule', 'historyFile', `myModule/history/${actor.id}-history.json`);\n```\n\n### Wrong: Client Setting for Shared State\n\n```javascript\n// BAD - Each user sees different value\ngame.settings.register('myModule', 'gameRule', {\n  scope: 'client',  // Wrong scope!\n  type: Boolean\n});\n\n// GOOD - World scope for shared rules\ngame.settings.register('myModule', 'gameRule', {\n  scope: 'world',\n  type: Boolean\n});\n```\n\n## Migration Between Storage Types\n\n### Flag to Setting\n\n```javascript\nHooks.once('ready', async () => {\n  const version = game.settings.get('myModule', 'schemaVersion') ?? 0;\n\n  if (version < 2) {\n    // Collect data from actor flags\n    const migrated = {};\n    for (const actor of game.actors) {\n      const old = actor.getFlag('myModule', 'oldData');\n      if (old) {\n        migrated[actor.id] = old;\n        await actor.unsetFlag('myModule', 'oldData');\n      }\n    }\n\n    // Store in setting\n    await game.settings.set('myModule', 'migratedData', migrated);\n    await game.settings.set('myModule', 'schemaVersion', 2);\n\n    ui.notifications.info('MyModule: Migration complete');\n  }\n});\n```\n\n### Setting to File (Large Data)\n\n```javascript\nasync function migrateToFile() {\n  const largeData = game.settings.get('myModule', 'bigSetting');\n\n  // Export to file\n  const file = new File(\n    [JSON.stringify(largeData, null, 2)],\n    'migrated-data.json',\n    { type: 'application/json' }\n  );\n  await FilePicker.upload('data', 'myModule', file);\n\n  // Update setting to path reference\n  await game.settings.set('myModule', 'dataPath', 'myModule/migrated-data.json');\n  await game.settings.set('myModule', 'bigSetting', null);\n}\n```\n\n## Implementation Checklist\n\n- [ ] Use module ID as flag scope (never 'world' or generic names)\n- [ ] Register settings in `init` hook\n- [ ] Use `scope: 'world'` for shared config, `scope: 'client'` for preferences\n- [ ] Batch flag updates with `document.update()` when setting multiple\n- [ ] Use files for data > 100KB\n- [ ] Handle missing flags/settings with defaults\n- [ ] Add `requiresReload: true` for settings that need refresh (V10+)\n- [ ] Use DataModel for setting validation when possible\n\n## References\n\n- [Flags API](https://foundryvtt.wiki/en/development/api/flags)\n- [Settings API](https://foundryvtt.wiki/en/development/api/settings)\n- [Handling Data Guide](https://foundryvtt.wiki/en/development/guides/handling-data)\n- [FilePicker API](https://foundryvtt.com/api/classes/foundry.applications.apps.FilePicker.html)\n\n---\n\n**Last Updated:** 2026-01-04\n**Status:** Production-Ready\n**Maintainer:** ImproperSubset\n",
        "fvtt-dev/skills/fvtt-dice-rolls/SKILL.md": "---\nname: fvtt-dice-rolls\ndescription: This skill should be used when implementing dice rolling, creating Roll formulas, sending rolls to chat with toMessage, preparing getRollData, creating custom dice types, or handling roll modifiers like advantage/disadvantage. Covers Roll class, evaluation, and common patterns.\n---\n\n# Foundry VTT Dice Rolls\n\n**Domain:** Foundry VTT Module/System Development\n**Status:** Production-Ready\n**Last Updated:** 2026-01-04\n\n## Overview\n\nFoundry VTT provides a powerful dice rolling system built around the `Roll` class. Understanding this system is essential for implementing game mechanics.\n\n### When to Use This Skill\n\n- Creating roll formulas with variable substitution\n- Implementing attack rolls, damage rolls, saving throws\n- Sending rolls to chat with proper speaker/flavor\n- Preparing actor/item roll data with getRollData()\n- Creating custom dice types for specific game systems\n- Using roll modifiers (keep, drop, explode, reroll)\n\n## Roll Class Basics\n\n### Constructor\n\n```javascript\nconst roll = new Roll(formula, data, options);\n```\n\n- `formula`: Dice expression string (e.g., \"2d20kh + @prof\")\n- `data`: Object for @ variable substitution\n- `options`: Optional configuration\n\n```javascript\nconst roll = new Roll(\"2d20kh + @prof + @strMod\", {\n  prof: 2,\n  strMod: 4\n});\n```\n\n### Formula Syntax\n\n```javascript\n// Basic dice\n\"1d20\"          // Roll one d20\n\"4d6\"           // Roll four d6\n\n// Variables with @ syntax\n\"1d20 + @abilities.str.mod\"\n\"1d20 + @prof\"\n\n// Nested paths\n\"@classes.barbarian.levels\"\n\"@abilities.dex.mod\"\n\n// Parenthetical (dynamic dice count)\n\"(@level)d6\"    // Roll [level] d6s\n\n// Dice pools\n\"{4d6kh3, 4d6kh3, 4d6kh3}\"  // Multiple separate rolls\n```\n\n## Roll Evaluation\n\n### Async evaluate() - REQUIRED\n\n```javascript\nconst roll = new Roll(\"1d20 + 5\");\nawait roll.evaluate();\n\nconsole.log(roll.result);  // \"15 + 5\"\nconsole.log(roll.total);   // 20\n```\n\n**Critical:** `roll.total` is undefined until evaluated.\n\n### Evaluation Options\n\n```javascript\nawait roll.evaluate({\n  maximize: true,    // All dice roll max value\n  minimize: true,    // All dice roll min value\n  allowStrings: true // Don't error on string terms\n});\n```\n\n### Sync Evaluation (Deterministic Only)\n\n```javascript\n// Only for maximize/minimize (deterministic)\nroll.evaluateSync({ strict: true });\n\n// With strict: false, non-deterministic = 0\nroll.evaluateSync({ strict: false });\n```\n\n## Roll.toMessage()\n\nSends a roll to chat as a ChatMessage.\n\n### Basic Usage\n\n```javascript\nawait roll.toMessage();\n```\n\n### With Options\n\n```javascript\nawait roll.toMessage({\n  speaker: ChatMessage.getSpeaker({ actor: this.actor }),\n  flavor: \"Attack Roll\",\n  user: game.user.id\n}, {\n  rollMode: game.settings.get(\"core\", \"rollMode\")\n});\n```\n\n### Roll Modes\n\n| Mode | Command | Visibility |\n|------|---------|------------|\n| Public | `/roll` | Everyone |\n| GM | `/gmroll` | Roller + GM |\n| Blind | `/blindroll` | GM only |\n| Self | `/selfroll` | Roller only |\n\n**Always respect user's roll mode:**\n```javascript\nrollMode: game.settings.get(\"core\", \"rollMode\")\n```\n\n## getRollData()\n\nPrepares data context for roll formulas.\n\n### Actor getRollData()\n\n```javascript\ngetRollData() {\n  // Always return a COPY\n  const data = foundry.utils.deepClone(this.system);\n\n  // Add shortcuts\n  data.lvl = data.details.level;\n\n  // Flatten ability mods for easy access\n  for (const [key, ability] of Object.entries(data.abilities)) {\n    data[key] = ability.mod;  // @str, @dex, etc.\n  }\n\n  return data;\n}\n```\n\n### Item getRollData()\n\nMerge item and actor data:\n\n```javascript\ngetRollData() {\n  const data = foundry.utils.deepClone(this.system);\n\n  if (!this.actor) return data;\n\n  // Merge actor's roll data\n  return foundry.utils.mergeObject(\n    this.actor.getRollData(),\n    data\n  );\n}\n```\n\n### Debugging Roll Data\n\n```javascript\n// In console with token selected:\nconsole.log(canvas.tokens.controlled[0].actor.getRollData());\n```\n\n## Roll Modifiers\n\n### Keep/Drop\n\n```javascript\n\"4d6kh3\"   // Keep 3 highest (ability scores)\n\"4d6kl3\"   // Keep 3 lowest\n\"4d6dh1\"   // Drop 1 highest\n\"4d6dl1\"   // Drop 1 lowest\n\"2d20kh\"   // Advantage (keep highest)\n\"2d20kl\"   // Disadvantage (keep lowest)\n```\n\n### Exploding Dice\n\n```javascript\n\"5d10x\"    // Explode on max (10)\n\"5d10x8\"   // Explode on 8+\n\"2d10xo\"   // Explode once per die\n```\n\n### Reroll\n\n```javascript\n\"1d20r1\"    // Reroll 1s (once)\n\"1d20r<3\"   // Reroll below 3 (once)\n\"1d20rr<3\"  // Recursive reroll while < 3\n```\n\n### Count Successes\n\n```javascript\n\"10d6cs>4\"  // Count successes > 4\n\"10d6cf<2\"  // Count failures < 2\n```\n\n### Min/Max\n\n```javascript\n\"1d20min10\"  // Minimum result 10\n\"1d20max15\"  // Maximum result 15\n```\n\n## Common Patterns\n\n### Attack Roll\n\n```javascript\nasync rollAttack() {\n  const rollData = this.actor.getRollData();\n\n  const parts = [\"1d20\"];\n  if (this.system.proficient) parts.push(\"@prof\");\n  if (this.system.ability) parts.push(`@${this.system.ability}.mod`);\n  if (this.system.attackBonus) parts.push(this.system.attackBonus);\n\n  const formula = parts.join(\" + \");\n  const roll = new Roll(formula, rollData);\n  await roll.evaluate();\n\n  return roll.toMessage({\n    speaker: ChatMessage.getSpeaker({ actor: this.actor }),\n    flavor: `${this.name} - Attack Roll`,\n    rollMode: game.settings.get(\"core\", \"rollMode\")\n  });\n}\n```\n\n### Damage Roll (with Critical)\n\n```javascript\nasync rollDamage(critical = false) {\n  const rollData = this.actor.getRollData();\n\n  let formula = this.system.damage.formula;\n\n  // Add ability mod\n  if (this.system.damage.ability) {\n    formula += ` + @${this.system.damage.ability}.mod`;\n  }\n\n  // Double dice on critical\n  if (critical) {\n    formula = formula.replace(/(\\d+)d(\\d+)/g, (m, num, faces) => {\n      return `${num * 2}d${faces}`;\n    });\n  }\n\n  const roll = new Roll(formula, rollData);\n  await roll.evaluate();\n\n  return roll.toMessage({\n    speaker: ChatMessage.getSpeaker({ actor: this.actor }),\n    flavor: `${this.name} - ${critical ? \"Critical \" : \"\"}Damage`,\n    rollMode: game.settings.get(\"core\", \"rollMode\")\n  });\n}\n```\n\n### Ability Check with Advantage/Disadvantage\n\n```javascript\nasync rollAbility(abilityId, { advantage = false, disadvantage = false } = {}) {\n  const rollData = this.actor.getRollData();\n\n  let dieFormula = \"1d20\";\n  if (advantage && !disadvantage) dieFormula = \"2d20kh\";\n  if (disadvantage && !advantage) dieFormula = \"2d20kl\";\n\n  const formula = `${dieFormula} + @abilities.${abilityId}.mod`;\n  const roll = new Roll(formula, rollData);\n  await roll.evaluate();\n\n  return roll.toMessage({\n    speaker: ChatMessage.getSpeaker({ actor: this.actor }),\n    flavor: `${CONFIG.abilities[abilityId]} Check`,\n    rollMode: game.settings.get(\"core\", \"rollMode\")\n  });\n}\n```\n\n### Sheet Rollable Button\n\n```javascript\n// In activateListeners\nhtml.on(\"click\", \".rollable\", this._onRoll.bind(this));\n\nasync _onRoll(event) {\n  event.preventDefault();\n  const element = event.currentTarget;\n  const { roll: formula, label } = element.dataset;\n\n  if (!formula) return;\n\n  const roll = new Roll(formula, this.actor.getRollData());\n  await roll.evaluate();\n\n  return roll.toMessage({\n    speaker: ChatMessage.getSpeaker({ actor: this.actor }),\n    flavor: label || \"Roll\",\n    rollMode: game.settings.get(\"core\", \"rollMode\")\n  });\n}\n```\n\n**Template:**\n```html\n<a class=\"rollable\" data-roll=\"1d20 + @str\" data-label=\"Strength Check\">\n  <i class=\"fas fa-dice-d20\"></i> Roll\n</a>\n```\n\n## Custom Dice\n\n### Custom Die Class\n\n```javascript\nexport class StressDie extends foundry.dice.terms.Die {\n  static DENOMINATION = \"s\";  // Use as \"1ds\"\n\n  async evaluate(options = {}) {\n    await super.evaluate(options);\n\n    // Custom logic: explode on 6, panic on 1\n    for (const result of this.results) {\n      if (result.result === 6) result.exploded = true;\n      if (result.result === 1) result.panic = true;\n    }\n\n    return this;\n  }\n}\n```\n\n### Custom Roll Class\n\n```javascript\nexport class CustomRoll extends Roll {\n  static CHAT_TEMPLATE = \"systems/mysystem/templates/roll.hbs\";\n\n  get successes() {\n    return this.dice.reduce((sum, die) => {\n      return sum + die.results.filter(r => r.success).length;\n    }, 0);\n  }\n}\n```\n\n### Registration\n\n```javascript\nHooks.once(\"init\", () => {\n  CONFIG.Dice.terms.s = StressDie;\n  CONFIG.Dice.rolls.push(CustomRoll);\n});\n```\n\n**Critical:** Register custom rolls or they won't reconstruct from chat messages.\n\n## Common Pitfalls\n\n### 1. Using total Before evaluate()\n\n```javascript\n// WRONG - total is undefined\nconst roll = new Roll(\"1d20\");\nconsole.log(roll.total);  // undefined!\n\n// CORRECT\nconst roll = new Roll(\"1d20\");\nawait roll.evaluate();\nconsole.log(roll.total);  // 15\n```\n\n### 2. Ignoring Roll Mode\n\n```javascript\n// WRONG - always public\nroll.toMessage();\n\n// CORRECT - respects user setting\nroll.toMessage({}, {\n  rollMode: game.settings.get(\"core\", \"rollMode\")\n});\n```\n\n### 3. Modifying getRollData() Return\n\n```javascript\n// WRONG - modifies document data\ngetRollData() {\n  return this.system;  // Direct reference!\n}\n\n// CORRECT - return a copy\ngetRollData() {\n  return foundry.utils.deepClone(this.system);\n}\n```\n\n### 4. Stale Roll Data\n\n```javascript\n// WRONG - data captured once\nconst rollData = this.actor.getRollData();\n// ...actor updates...\nnew Roll(\"1d20 + @prof\", rollData);  // Stale!\n\n// CORRECT - get fresh data\nnew Roll(\"1d20 + @prof\", this.actor.getRollData());\n```\n\n### 5. Unvalidated User Input\n\n```javascript\n// UNSAFE\nconst roll = new Roll(userInput);\n\n// SAFER - validate first\nif (!Roll.validate(userInput)) {\n  ui.notifications.error(\"Invalid roll formula\");\n  return;\n}\nconst roll = new Roll(userInput, rollData);\n```\n\n### 6. Forgetting to Register Custom Rolls\n\n```javascript\n// WRONG - rolls break on reload\nclass MyRoll extends Roll {}\n\n// CORRECT - register with CONFIG\nclass MyRoll extends Roll {}\nCONFIG.Dice.rolls.push(MyRoll);\n```\n\n### 7. Async in preCreate Hooks\n\n```javascript\n// PROBLEMATIC - hooks can't reliably await\nHooks.on(\"preCreateItem\", async (doc, data) => {\n  const roll = new Roll(\"1d20\");\n  await roll.evaluate();  // May fail!\n});\n\n// BETTER - use onCreate\nHooks.on(\"createItem\", async (doc, options, userId) => {\n  if (userId !== game.user.id) return;\n  const roll = new Roll(\"1d20\");\n  await roll.evaluate();  // Safe\n});\n```\n\n## Implementation Checklist\n\n- [ ] Always `await roll.evaluate()` before accessing `roll.total`\n- [ ] Use `getRollData()` returning a deep clone\n- [ ] Pass `rollMode: game.settings.get(\"core\", \"rollMode\")` to toMessage\n- [ ] Use `ChatMessage.getSpeaker({ actor })` for proper speaker\n- [ ] Validate user-provided formulas with `Roll.validate()`\n- [ ] Register custom Roll/Die classes in CONFIG.Dice\n- [ ] Add flavor text describing the roll\n- [ ] Use @ syntax for variable substitution in formulas\n\n## References\n\n- [Roll API](https://foundryvtt.com/api/classes/foundry.dice.Roll.html)\n- [Roll Wiki](https://foundryvtt.wiki/en/development/api/roll)\n- [Dice Modifiers](https://foundryvtt.com/article/dice-modifiers/)\n- [Advanced Dice](https://foundryvtt.com/article/dice-advanced/)\n- [Dice in V12+](https://foundryvtt.wiki/en/development/guides/dice-in-v12)\n\n---\n\n**Last Updated:** 2026-01-04\n**Status:** Production-Ready\n**Maintainer:** ImproperSubset\n",
        "fvtt-dev/skills/fvtt-error-handling/SKILL.md": "---\nname: fvtt-error-handling\ndescription: This skill should be used when adding error handling to catch blocks, standardizing error handling across a codebase, or ensuring proper UX with user messages vs technical logs. Covers NotificationOptions, Hooks.onError, and preventing console noise.\n---\n\n# Foundry VTT Error Handling Patterns\n\n**Domain:** Foundry VTT V12/V13 Error Handling\n**Status:** Production-Ready (Verified against V13 API)\n**Last Updated:** 2025-12-31\n\n---\n\n## Overview\n\nThis skill provides **production-ready error handling patterns** for Foundry VTT modules, using the documented V13 APIs: `NotificationOptions` and `Hooks.onError`.\n\n### When to Use This Skill\n\n- Adding error handling to catch blocks in Foundry modules\n- Standardizing error handling across a codebase\n- Ensuring proper UX (user messages vs technical logs)\n- Preventing console noise and double-logging\n- Enabling ecosystem compatibility (other modules can listen to your errors)\n\n### Core Principle\n\n**Always separate error funnel from user notification:**\n\n- **Error funnel** (`Hooks.onError`): Logs stack traces, triggers ecosystem hooks, provides structured data\n- **User notification** (`ui.notifications.*`): Clean, sanitized messages with full UX control\n\n**Why separation matters:**\n1. `Hooks.onError` mutates `error.message` when `msg` is provided (see Foundry GitHub #6669)\n2. `clean: true` only works in NotificationOptions, not Hooks.onError\n3. User sees only your controlled message, not technical details\n4. Explicit control over console logging (`console: false` prevents double-logging)\n\n---\n\n## Quick Reference: Four Error Patterns\n\n| Pattern | Error Funnel | User Notification | Use Case |\n|---------|--------------|-------------------|----------|\n| **User-facing** | Hooks.onError (`notify: null`) | ui.notifications.error | Unexpected failures |\n| **Expected validation** | _(none)_ | ui.notifications.warn | User input errors |\n| **Developer-only** | Hooks.onError (`notify: null`) | _(none)_ | Diagnostic logging |\n| **High-frequency** | Throttled Hooks.onError | Throttled ui.notifications.warn | Render loops, hooks |\n\n---\n\n## Pattern 1: User-Facing Failures\n\n**Use for:** Unexpected errors, operations that failed, critical failures\n\n```javascript\n} catch (err) {\n  // Preserve original error as cause when wrapping non-Errors\n  const error = err instanceof Error ? err : new Error(String(err), { cause: err });\n\n  // Error funnel: stack traces + ecosystem hooks (no UI)\n  Hooks.onError(`YourModule.${contextDescription}`, error, {\n    msg: \"[YourModule]\",\n    log: \"error\",\n    notify: null,  // No UI from hook\n    data: { contextDescription, userFacingDescription }  // Structured context\n  });\n\n  // Fully controlled user message (sanitized, no console - already logged)\n  ui.notifications.error(`[YourModule] ${userFacingDescription}`, {\n    clean: true,\n    console: false  // Hooks.onError already logged\n  });\n}\n```\n\n**Key points:**\n- User sees only `userFacingDescription` (no technical details leaked)\n- Stack trace logged via Hooks.onError (full Error object)\n- Ecosystem visibility (other modules can listen to `Hooks.on(\"error\", ...)`)\n- Structured `data` for debugging and hook subscribers\n- Explicit `console: false` prevents double-logging\n\n---\n\n## Pattern 2: Expected Validation / Recoverable Issues\n\n**Use for:** User input errors, missing data, expected validation failures\n\n```javascript\n} catch (err) {\n  const message = `[YourModule] ${userFacingDescription}`;\n  ui.notifications.warn(message, {\n    clean: true,\n    console: false  // Expected failures - no console noise\n  });\n}\n```\n\n**Key points:**\n- Uses `warn` severity (not `error`) for expected cases\n- Simpler than Hooks.onError (no error funnel needed for routine validation)\n- `console: false` avoids noise for common user-driven failures\n- **Optional**: Gate console logging behind debug flag:\n  ```javascript\n  console: game.settings.get(\"your-module\", \"enableProfiling\")\n  ```\n\n---\n\n## Pattern 3: Developer-Only Errors\n\n**Use for:** Diagnostic logging, internal errors that don't need user notification\n\n```javascript\n} catch (err) {\n  const error = err instanceof Error ? err : new Error(String(err), { cause: err });\n  Hooks.onError(`YourModule.${contextDescription}`, error, {\n    msg: \"[YourModule]\",\n    log: \"error\",\n    notify: null,  // Log only, no UI spam\n    data: { contextDescription }  // Structured context for debugging\n  });\n}\n```\n\n**Key points:**\n- Uses error funnel (consistency) but no notification\n- Stack traces logged for developers\n- No UI spam for internal diagnostics\n- **Alternative**: Use `console.error(...)` for truly isolated cases (but lose ecosystem hooks)\n\n---\n\n## Pattern 4: High-Frequency Errors\n\n**Use for:** Render loops, hooks, event handlers that might error repeatedly\n\n```javascript\n// Module-scoped throttle (outside class/function)\nconst errorThrottles = new Map();\n\n// In catch block:\n} catch (err) {\n  const throttleKey = contextDescription;\n  const lastError = errorThrottles.get(throttleKey) || 0;\n\n  // Throttle: 5 second window per context\n  if (Date.now() - lastError > 5000) {\n    const error = err instanceof Error ? err : new Error(String(err), { cause: err });\n\n    // Error funnel (no UI)\n    Hooks.onError(`YourModule.${contextDescription}`, error, {\n      msg: \"[YourModule]\",\n      log: \"warn\",\n      notify: null,  // No UI from hook\n      data: { contextDescription, userFacingDescription }\n    });\n\n    // Separate controlled notification (console: false prevents double-logging)\n    ui.notifications.warn(`[YourModule] ${userFacingDescription}`, {\n      clean: true,\n      console: false  // Already logged via Hooks.onError\n    });\n\n    errorThrottles.set(throttleKey, Date.now());\n  }\n}\n```\n\n**Key points:**\n- Throttles to prevent notification queue flood\n- Module-scoped Map prevents spam across multiple instances\n- Uses `warn` severity for non-critical repeated errors\n- Separates error funnel (logs only) from user notification\n- Explicit `console: false` prevents double-logging\n\n---\n\n## Decision Tree: Classifying Errors\n\n**Ask these questions:**\n\n1. **Is this unexpected?** (system failure, unhandled case, critical error)\n   â†’ **Pattern 1**: User-facing failures\n\n2. **Is this expected validation?** (user input error, missing required data)\n   â†’ **Pattern 2**: Expected validation\n\n3. **Is this diagnostic-only?** (internal state, no user impact)\n   â†’ **Pattern 3**: Developer-only\n\n4. **Could this fire repeatedly?** (render loop, hook, event handler)\n   â†’ **Pattern 4**: High-frequency throttled\n\n---\n\n## Foundry-Specific Gotchas\n\n### 1. `Hooks.onError` Mutates Error Objects\n\n**Critical**: `Hooks.onError` modifies `error.message` when `msg` is provided:\n\n```javascript\n// Internal Foundry implementation (from GitHub #6669):\nif (msg) err.message = `${msg}: ${err.message}`;\n```\n\n**This is why we separate funnel from notification:**\n- Error funnel gets the Error object (stack traces preserved)\n- User notification uses clean string (no mutation affects UX)\n\n**Always normalize to Error objects:**\n```javascript\nconst error = err instanceof Error ? err : new Error(String(err), { cause: err });\n```\n\n### 2. `console` Default Behavior Not Documented\n\n**Issue**: Foundry V13 docs don't explicitly state the default value for `NotificationOptions.console`.\n\n**Evidence**: API examples show `{ console: false }` to suppress logging, implying default is `true`.\n\n**Best practice**: Be explicit to prevent double-logging and future-proof against default changes:\n```javascript\nui.notifications.error(message, {\n  clean: true,\n  console: false  // Explicit is better than implicit\n});\n```\n\n### 3. `notify` String Values Are Undocumented\n\n**Issue**: `Hooks.onError` accepts `notify: null | string`, but valid string values aren't enumerated in V13 API docs.\n\n**Your assumption**: `notify` accepts `\"error\"`, `\"warn\"`, `\"info\"` (like `ui.notifications.*` methods)\n\n**Reality**: Likely correct but NOT explicitly documented.\n\n**Best practice**: Use `notify: null` + separate `ui.notifications.*` for full control:\n```javascript\n// Avoid relying on undocumented notify strings\nHooks.onError(..., { notify: null });  // Error funnel only\nui.notifications.error(...);           // Separate notification\n```\n\n### 4. `clean: true` Only Works in NotificationOptions\n\n**Issue**: `{ clean: true }` sanitizes untrusted input, but ONLY in `ui.notifications.*`.\n\n**Does NOT work in `Hooks.onError`**: The `msg` parameter is NOT sanitized by Hooks.onError.\n\n**Best practice**:\n- Keep `msg` in Hooks.onError generic (module prefix only): `msg: \"[YourModule]\"`\n- Put user/document data in separate `ui.notifications.*` call with `{ clean: true }`\n\n```javascript\n// âŒ Bad - untrusted data in Hooks.onError msg\nHooks.onError(..., { msg: `[Module] ${userInput}` });  // Not sanitized!\n\n// âœ… Good - untrusted data in ui.notifications with clean: true\nHooks.onError(..., { msg: \"[Module]\", notify: null });\nui.notifications.error(`[Module] ${userInput}`, { clean: true });\n```\n\n### 5. `{ cause: err }` Has Excellent Support\n\n**Good news**: Error `cause` parameter (ES2022) is widely supported:\n- Available since September 2021 (4+ years)\n- Foundry V13 minimum: Chromium 122, Firefox 127, Electron 33+\n- **Safe to use** in all Foundry V13+ environments\n\n**Usage**:\n```javascript\nconst error = err instanceof Error ? err : new Error(String(err), { cause: err });\n```\n\nPreserves original error context for debugging in modern browsers.\n\n---\n\n## Implementation Checklist\n\nWhen adding error handling to your module:\n\n### 1. Audit All Catch Blocks\n```bash\ngrep -r \"} catch\" scripts/\n```\n\n### 2. Classify Each Error\n- [ ] Unexpected failure? â†’ Pattern 1 (user-facing)\n- [ ] Expected validation? â†’ Pattern 2 (expected validation)\n- [ ] Diagnostic only? â†’ Pattern 3 (developer-only)\n- [ ] High-frequency? â†’ Pattern 4 (throttled)\n\n### 3. Replace Patterns\n- [ ] `console.log` â†’ `console.error` or Hooks.onError (minimum fix)\n- [ ] Manual notification + console â†’ Hooks.onError (`notify: null`) + ui.notifications.*\n- [ ] Expected failures â†’ `ui.notifications.warn` with `console: false`\n- [ ] Use `{ clean: true }` on ui.notifications.* for user/document data\n- [ ] **Default to `console: false`** (prevents noise + double-logging)\n- [ ] **Never** put untrusted strings in Hooks.onError `msg` (it's a prefix only)\n- [ ] **Always** separate error funnel from user notification\n- [ ] Preserve original error: `new Error(String(err), { cause: err })`\n- [ ] Add structured `data` to Hooks.onError for debugging\n- [ ] Throttle errors in render loops/hooks (prevent UI spam)\n\n### 4. Test Error Paths\n- [ ] Verify user-facing errors show clean message (no technical details leaked)\n- [ ] Verify stack traces in console (Error objects via Hooks.onError)\n- [ ] Verify `warn` severity used for expected validation errors\n- [ ] Check that diagnostic errors don't spam UI (Hooks.onError with `notify: null`)\n- [ ] Test throttling for high-frequency error paths (5 second window)\n- [ ] Verify no double-logging (Hooks.onError + ui.notifications with `console: false`)\n- [ ] Verify structured `data` appears in error hooks for debugging\n\n---\n\n## Verification Notes\n\n**Verified against Foundry V13 API** (2025-12-31):\n\n### âœ… Documented and Correct\n\n- **`NotificationOptions.console`**: Optional boolean - \"Whether to log the message to the console\"\n- **`NotificationOptions.clean`**: Optional boolean - \"Whether to clean the provided message string as untrusted user input\"\n- **`Hooks.onError` signature**:\n  ```typescript\n  static onError(\n    location: string,\n    error: Error,\n    options?: {\n      data?: object;\n      log?: null | string;\n      msg?: string;\n      notify?: null | string;\n    }\n  ): void\n  ```\n- **All four parameters documented**:\n  - `msg`: String - \"A message which should prefix the resulting error or notification\"\n  - `log`: null | string - \"The level at which to log the error to console (if at all)\"\n  - `notify`: null | string - \"The level at which to spawn a notification in the UI (if at all)\"\n  - `data`: object - \"Additional data to pass to the hook subscribers\"\n- **Notification types**: `\"info\"`, `\"warn\"`, `\"error\"` (all documented)\n- **`notify: null`**: Explicitly documented as valid (suppresses UI notification)\n- **`{ cause: err }`**: Excellent browser support (ES2022, 4+ years available)\n\n### âš ï¸ Undocumented Behaviors\n\n- `console` default value not explicitly stated (defensive `console: false` recommended)\n- `notify` string values not enumerated (use `notify: null` + separate notifications)\n- `Hooks.onError` mutates `error.message` (normalize to Error objects, separate funnel from notification)\n\n---\n\n## Benefits of This Approach\n\n- **Foundry-native**: Uses only documented NotificationOptions and Hooks.onError APIs\n- **Full UX control**: Always separates error funnel from user message (no technical leaks)\n- **Stack traces**: Error objects via Hooks.onError include full stack traces in console\n- **Preserves context**: `{ cause: err }` retains original error when wrapping non-Errors\n- **Structured debugging**: `data` parameter provides context to hook subscribers and debugging\n- **Ecosystem-compatible**: Error funnel allows other modules to listen to your errors\n- **Better UX**: Severity discipline (warn vs error) + throttling prevents notification spam\n- **Sanitization**: `{ clean: true }` on ui.notifications.* prevents XSS from error messages\n- **No double-logging**: Explicit `console: false` prevents duplicate entries\n- **Reduced console noise**: Expected validation errors don't clutter console by default\n- **Consistent pattern**: All errors use same \"funnel + notification\" approach\n- **Robust throttling**: Module-scoped Map prevents spam across multiple instances\n- **Future-proof**: Uses only documented Foundry V13 error handling mechanisms\n\n---\n\n## Optional Enhancement: Localization\n\nFor published modules, consider localizing error messages:\n\n```javascript\nconst message = game.i18n.format(\"YOUR_MODULE.Error.FailedToAddItem\", {\n  error: err.message\n});\nui.notifications.error(message, { clean: true, console: false });\n```\n\n**Note**: If using `game.i18n.format`, the `format` function returns a sanitized string, so `clean: true` may be redundant (but harmless).\n\n---\n\n## References\n\n### Foundry V13 API Documentation\n- [NotificationOptions Interface](https://foundryvtt.com/api/interfaces/foundry.NotificationOptions.html)\n- [Hooks.onError Method](https://foundryvtt.com/api/classes/foundry.helpers.Hooks.html)\n- [Notifications Class](https://foundryvtt.com/api/classes/foundry.applications.ui.Notifications.html)\n\n### GitHub Issues\n- [Hooks.onError Implementation #6669](https://github.com/foundryvtt/foundryvtt/issues/6669) - Documents error.message mutation behavior\n\n### Browser APIs\n- [Error.cause - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error/cause)\n- [Can I Use: Error.cause](https://caniuse.com/mdn-javascript_builtins_error_cause)\n\n### Related Skills\n- `foundry-vtt-performance-safe-updates` - Multi-client update safety patterns\n- `foundry-vtt-dialog-compat` - DialogV2 Shadow DOM patterns\n- `foundry-vtt-version-compat` - API compatibility layer patterns\n\n---\n\n## Example: Real-World Usage\n\n```javascript\n// In blades-alternate-actor-sheet.js\nimport { queueUpdate } from \"./lib/update-queue.js\";\n\nasync _onItemCreate(event) {\n  event.preventDefault();\n  const itemType = event.currentTarget.dataset.itemType;\n\n  try {\n    // Attempt to create item\n    const itemData = {\n      name: `New ${itemType}`,\n      type: itemType,\n      system: {}\n    };\n\n    await queueUpdate(async () => {\n      await this.actor.createEmbeddedDocuments(\"Item\", [itemData]);\n    });\n\n    ui.notifications.info(`[BitD-Alt] Created new ${itemType}`);\n\n  } catch (err) {\n    // Pattern 1: User-facing failure\n    const error = err instanceof Error ? err : new Error(String(err), { cause: err });\n\n    Hooks.onError(\"BitD-Alt.ItemCreate\", error, {\n      msg: \"[BitD-Alt]\",\n      log: \"error\",\n      notify: null,\n      data: { itemType, actorId: this.actor.id }\n    });\n\n    ui.notifications.error(`[BitD-Alt] Failed to create ${itemType}`, {\n      clean: true,\n      console: false\n    });\n  }\n}\n```\n\n---\n\n**Last Updated:** 2025-12-31\n**Status:** Production-Ready (Verified against Foundry V13 API)\n**Maintainer:** Claude Code (BitD Alternate Sheets)\n",
        "fvtt-dev/skills/fvtt-hooks/SKILL.md": "---\nname: fvtt-hooks\ndescription: This skill should be used when registering hooks, creating custom hooks for module APIs, debugging hook execution, handling async in hooks, or preventing memory leaks from unclean hook removal. Covers Hooks.on/once/call/callAll, lifecycle order, and common pitfalls.\n---\n\n# Foundry VTT Hooks\n\n**Domain:** Foundry VTT Module/System Development\n**Status:** Production-Ready\n**Last Updated:** 2026-01-04\n\n## Overview\n\nFoundry VTT uses an event-driven architecture where hooks allow modules to intercept and respond to VTT workflows. Understanding hooks is fundamental to all Foundry development.\n\n### When to Use This Skill\n\n- Registering event handlers for document changes\n- Creating module APIs that other packages can consume\n- Debugging hook execution order\n- Preventing memory leaks from orphaned hooks\n- Understanding async limitations in hooks\n\n### Core Concepts\n\n| Method | Purpose | Cancellable | Persists |\n|--------|---------|-------------|----------|\n| `Hooks.on(name, fn)` | Register persistent listener | N/A | Yes |\n| `Hooks.once(name, fn)` | Register one-time listener | N/A | No |\n| `Hooks.call(name, ...args)` | Trigger hook (stoppable) | Yes | N/A |\n| `Hooks.callAll(name, ...args)` | Trigger hook (all run) | No | N/A |\n| `Hooks.off(name, id)` | Unregister by ID | N/A | N/A |\n\n## Lifecycle Hooks (Execution Order)\n\nThese fire once per client connection, in this order:\n\n```\ninit â†’ i18nInit â†’ setup â†’ ready\n```\n\n| Hook | When | Use For |\n|------|------|---------|\n| `init` | Foundry initializing | Register sheets, settings, CONFIG |\n| `i18nInit` | Translations loaded | Localization-dependent setup |\n| `setup` | Before Documents/UI/Canvas | Pre-game state setup |\n| `ready` | Game fully ready | World initialization, game data access |\n\n```javascript\n// Correct registration order\nHooks.once(\"init\", () => {\n  // Register settings\n  game.settings.register(\"my-module\", \"mySetting\", { /* ... */ });\n\n  // Register document sheets\n  DocumentSheetConfig.registerSheet(Actor, \"my-module\", MyActorSheet, {\n    makeDefault: true\n  });\n});\n\nHooks.once(\"ready\", () => {\n  // Safe to access game.actors, game.users, etc.\n  console.log(`${game.actors.size} actors in world`);\n});\n```\n\n## Document Hooks\n\nAll document types follow this pattern:\n\n| Hook | Trigger Method | Can Cancel |\n|------|---------------|------------|\n| `preCreate{Doc}` | `Hooks.call` | Yes |\n| `create{Doc}` | `Hooks.callAll` | No |\n| `preUpdate{Doc}` | `Hooks.call` | Yes |\n| `update{Doc}` | `Hooks.callAll` | No |\n| `preDelete{Doc}` | `Hooks.call` | Yes |\n| `delete{Doc}` | `Hooks.callAll` | No |\n\n```javascript\n// Prevent update if condition met\nHooks.on(\"preUpdateActor\", (actor, change, options, userId) => {\n  if (change.system?.hp?.value < 0) {\n    ui.notifications.warn(\"HP cannot be negative\");\n    return false; // Cancels the update\n  }\n});\n\n// React after update\nHooks.on(\"updateActor\", (actor, change, options, userId) => {\n  if (change.system?.hp?.value === 0) {\n    ChatMessage.create({ content: `${actor.name} has fallen!` });\n  }\n});\n```\n\n## Render Hooks\n\nRender hooks fire for the entire inheritance chain:\n\n```javascript\n// renderActorSheet â†’ renderDocumentSheet â†’ renderFormApplication â†’ renderApplication\n\n// ApplicationV1 signature\nHooks.on(\"renderActorSheet\", (app, html, data) => {\n  html.find(\".header\").append(\"<button>Custom</button>\");\n});\n\n// ApplicationV2 signature (V12+)\nHooks.on(\"renderActorSheetV2\", (app, html, context, options) => {\n  // html is the rendered element\n});\n```\n\n## Common Pitfalls\n\n### 1. Async Functions Cannot Cancel Hooks\n\n**CRITICAL:** Hooks never await callbacks. Async functions return a Promise, not `false`.\n\n```javascript\n// WRONG - Won't prevent the update!\nHooks.on(\"preUpdateActor\", async (actor, change, options, userId) => {\n  const allowed = await someAsyncCheck();\n  if (!allowed) return false; // Returns Promise, not false!\n});\n\n// CORRECT - Synchronous check for cancellation\nHooks.on(\"preUpdateActor\", (actor, change, options, userId) => {\n  if (!someCondition) return false; // Actually prevents update\n});\n```\n\n### 2. Memory Leaks from Orphaned Hooks\n\nHooks keep references to callbacks, preventing garbage collection:\n\n```javascript\n// BAD - Hook persists after app closes\nclass MyApp extends Application {\n  constructor() {\n    super();\n    Hooks.on(\"updateActor\", this._onUpdate.bind(this));\n  }\n}\n\n// GOOD - Store ID and clean up\nclass MyApp extends Application {\n  constructor() {\n    super();\n    this._hookId = Hooks.on(\"updateActor\", this._onUpdate.bind(this));\n  }\n\n  close(options) {\n    Hooks.off(\"updateActor\", this._hookId);\n    return super.close(options);\n  }\n}\n```\n\n### 3. Object Mutation vs Re-assignment\n\nObjects are passed by reference - mutation works, re-assignment doesn't:\n\n```javascript\n// WORKS - Mutation affects original\nHooks.on(\"preUpdateActor\", (actor, change, options, userId) => {\n  change.name = \"Modified\"; // Changes the actual update\n});\n\n// DOESN'T WORK - Re-assignment breaks reference\nHooks.on(\"preUpdateActor\", (actor, change, options, userId) => {\n  change = { name: \"New\" }; // Local variable only!\n});\n```\n\n### 4. Hooks Fire Per-Client\n\nEach client runs hooks independently. Check userId to avoid duplicate actions:\n\n```javascript\n// BAD - All clients try to create the item\nHooks.on(\"createActor\", (actor, options, userId) => {\n  actor.createEmbeddedDocuments(\"Item\", [itemData]);\n});\n\n// GOOD - Only triggering client acts\nHooks.on(\"createActor\", (actor, options, userId) => {\n  if (userId !== game.user.id) return;\n  actor.createEmbeddedDocuments(\"Item\", [itemData]);\n});\n```\n\n### 5. Hook Context (this) Issues\n\n```javascript\n// WRONG - Can't unregister by function reference\nHooks.on(\"updateActor\", this.onUpdate);\nHooks.off(\"updateActor\", this.onUpdate); // Fails!\n\n// WRONG - bind() creates new function each time\nHooks.on(\"updateActor\", this.onUpdate.bind(this));\nHooks.off(\"updateActor\", this.onUpdate.bind(this)); // Different function!\n\n// CORRECT - Use hook ID\nthis._hookId = Hooks.on(\"updateActor\", this.onUpdate.bind(this));\nHooks.off(\"updateActor\", this._hookId); // Works\n```\n\n## Creating Custom Hooks for Module APIs\n\n### Basic Pattern\n\n```javascript\n// my-module.js\nHooks.once(\"init\", () => {\n  const api = {\n    registerExtension: (config) => { /* ... */ },\n    doAction: (data) => { /* ... */ }\n  };\n\n  // Expose API\n  game.modules.get(\"my-module\").api = api;\n\n  // Announce readiness\n  Hooks.callAll(\"myModuleReady\", api);\n});\n\n// Other modules consume it\nHooks.once(\"myModuleReady\", (api) => {\n  api.registerExtension({ name: \"My Extension\" });\n});\n```\n\n### Allowing Cancellation\n\n```javascript\nclass MySystem {\n  static performAction(data) {\n    // Allow other modules to prevent action\n    const allowed = Hooks.call(\"myModule.beforeAction\", data);\n    if (allowed === false) return null;\n\n    const result = this._doWork(data);\n\n    // Notify completion (cannot be cancelled)\n    Hooks.callAll(\"myModule.afterAction\", result);\n\n    return result;\n  }\n}\n```\n\n### Naming Convention\n\nUse namespaced names: `moduleName.eventName`\n- `combatTracker.turnChanged`\n- `tokenMagic.effectApplied`\n- `myModule.ready`\n\n## Debugging Hooks\n\n### Enable Debug Mode\n\n```javascript\n// In browser console\nCONFIG.debug.hooks = true;\n\n// Toggle macro\nCONFIG.debug.hooks = !CONFIG.debug.hooks;\nconsole.warn(\"Hook debugging:\", CONFIG.debug.hooks);\n```\n\n### Debug Specific Hook\n\n```javascript\n// Log arguments for a specific hook once\nHooks.once(\"updateActor\", (...args) => console.log(\"updateActor args:\", args));\n```\n\n### Developer Mode Module\n\nUse the [Developer Mode](https://foundryvtt.com/packages/lib-dev-mode/) module for persistent debug flag management without shipping debug code.\n\n## Implementation Checklist\n\n- [ ] Use `Hooks.once` for init/setup/ready (not `Hooks.on`)\n- [ ] Store hook IDs for any persistent hooks\n- [ ] Clean up hooks in `close()` or destruction methods\n- [ ] Check `userId === game.user.id` before document operations\n- [ ] Never use async for `pre*` hooks that need cancellation\n- [ ] Mutate objects, don't re-assign them\n- [ ] Use namespaced names for custom hooks\n- [ ] Use `Hooks.call` for cancellable events, `Hooks.callAll` for notifications\n\n## Quick Reference: Common Hook Signatures\n\n```javascript\n// Document hooks\nHooks.on(\"preCreateActor\", (document, data, options, userId) => {});\nHooks.on(\"createActor\", (document, options, userId) => {});\nHooks.on(\"preUpdateActor\", (document, change, options, userId) => {});\nHooks.on(\"updateActor\", (document, change, options, userId) => {});\nHooks.on(\"preDeleteActor\", (document, options, userId) => {});\nHooks.on(\"deleteActor\", (document, options, userId) => {});\n\n// Render hooks (V1)\nHooks.on(\"renderActorSheet\", (app, html, data) => {});\n\n// Render hooks (V2)\nHooks.on(\"renderActorSheetV2\", (app, html, context, options) => {});\n\n// Canvas hooks\nHooks.on(\"canvasReady\", (canvas) => {});\nHooks.on(\"canvasPan\", (canvas, position) => {});\n```\n\n## References\n\n- [Hooks API Documentation](https://foundryvtt.com/api/classes/foundry.helpers.Hooks.html)\n- [Hook Events Reference](https://foundryvtt.com/api/modules/hookEvents.html)\n- [Community Wiki: Hooks](https://foundryvtt.wiki/en/development/api/hooks)\n- [Community Wiki: Hooks Listening & Calling](https://foundryvtt.wiki/en/development/guides/Hooks_Listening_Calling)\n\n---\n\n**Last Updated:** 2026-01-04\n**Status:** Production-Ready\n**Maintainer:** ImproperSubset\n",
        "fvtt-dev/skills/fvtt-localization/SKILL.md": "---\nname: fvtt-localization\ndescription: This skill should be used when implementing internationalization (i18n), creating language files, using game.i18n.localize/format, adding template localization helpers, or following best practices for translatable strings.\n---\n\n# Foundry VTT Localization\n\n**Domain:** Foundry VTT Module/System Development\n**Status:** Production-Ready\n**Last Updated:** 2026-01-05\n\n## Overview\n\nFoundry VTT uses JSON language files for internationalization. All user-facing text should be localized to support translation.\n\n### When to Use This Skill\n\n- Creating language files for modules/systems\n- Using localize/format in JavaScript code\n- Adding localization to templates\n- Following naming conventions for translatable strings\n- Handling pluralization and interpolation\n\n## Language File Structure\n\n### Basic Format\n\n```json\n{\n  \"MYMODULE.Title\": \"My Module\",\n  \"MYMODULE.Settings.Enable\": \"Enable Feature\",\n  \"MYMODULE.Settings.EnableHint\": \"Turn this feature on or off\",\n  \"MYMODULE.Dialog.Confirm\": \"Are you sure?\",\n  \"MYMODULE.Button.Save\": \"Save\",\n  \"MYMODULE.Button.Cancel\": \"Cancel\"\n}\n```\n\n### Namespace Convention\n\nUse your package ID as prefix to avoid conflicts:\n\n```json\n{\n  \"MYSYSTEM.Actor.HP\": \"Hit Points\",\n  \"MYSYSTEM.Actor.AC\": \"Armor Class\",\n  \"MYSYSTEM.Item.Weight\": \"Weight\"\n}\n```\n\n### Document Type Labels\n\n```json\n{\n  \"TYPES\": {\n    \"Actor\": {\n      \"character\": \"Character\",\n      \"npc\": \"Non-Player Character\",\n      \"vehicle\": \"Vehicle\"\n    },\n    \"Item\": {\n      \"weapon\": \"Weapon\",\n      \"armor\": \"Armor\",\n      \"spell\": \"Spell\"\n    }\n  }\n}\n```\n\n## Manifest Registration\n\n### module.json / system.json\n\n```json\n{\n  \"id\": \"my-module\",\n  \"languages\": [\n    {\n      \"lang\": \"en\",\n      \"name\": \"English\",\n      \"path\": \"lang/en.json\"\n    },\n    {\n      \"lang\": \"es\",\n      \"name\": \"EspaÃ±ol\",\n      \"path\": \"lang/es.json\"\n    },\n    {\n      \"lang\": \"fr\",\n      \"name\": \"FranÃ§ais\",\n      \"path\": \"lang/fr.json\"\n    }\n  ]\n}\n```\n\n### Language Codes\n\nUse ISO 639-1 (2-letter) or ISO 639-2 (3-letter) codes:\n- `en` - English\n- `es` - Spanish\n- `fr` - French\n- `de` - German\n- `ja` - Japanese\n- `zh` - Chinese\n\n## JavaScript API\n\n### game.i18n.localize()\n\nSimple string lookup:\n\n```javascript\nconst title = game.i18n.localize(\"MYMODULE.Title\");\n// Returns: \"My Module\"\n\n// Missing key returns the key itself\nconst missing = game.i18n.localize(\"MYMODULE.Missing\");\n// Returns: \"MYMODULE.Missing\"\n```\n\n### game.i18n.format()\n\nString interpolation with variables:\n\n```json\n{\n  \"MYMODULE.Welcome\": \"Welcome, {name}!\",\n  \"MYMODULE.ItemCount\": \"You have {count} items\",\n  \"MYMODULE.Comparison\": \"{item1} vs {item2}\"\n}\n```\n\n```javascript\ngame.i18n.format(\"MYMODULE.Welcome\", { name: \"Alice\" });\n// Returns: \"Welcome, Alice!\"\n\ngame.i18n.format(\"MYMODULE.ItemCount\", { count: 5 });\n// Returns: \"You have 5 items\"\n\ngame.i18n.format(\"MYMODULE.Comparison\", {\n  item1: \"Sword\",\n  item2: \"Axe\"\n});\n// Returns: \"Sword vs Axe\"\n```\n\n### game.i18n.has()\n\nCheck if translation exists:\n\n```javascript\n// Check with English fallback\nif (game.i18n.has(\"MYMODULE.Feature\")) {\n  // Key exists (in current language OR English)\n}\n\n// Check without fallback\nif (game.i18n.has(\"MYMODULE.Feature\", false)) {\n  // Key exists in current language only\n}\n```\n\n### game.i18n.getListFormatter()\n\nFormat lists according to locale:\n\n```javascript\nconst formatter = game.i18n.getListFormatter({\n  style: \"long\",       // \"long\", \"short\", \"narrow\"\n  type: \"conjunction\"  // \"conjunction\", \"disjunction\"\n});\n\nformatter.format([\"apples\", \"oranges\", \"bananas\"]);\n// English: \"apples, oranges, and bananas\"\n// Spanish: \"manzanas, naranjas y plÃ¡tanos\"\n```\n\n## Template Localization\n\n### Basic Usage\n\n```handlebars\n<h1>{{localize \"MYMODULE.Title\"}}</h1>\n\n<button>{{localize \"MYMODULE.Button.Save\"}}</button>\n\n<!-- In attributes, use single quotes -->\n<input placeholder=\"{{localize 'MYMODULE.Placeholder'}}\">\n\n<a title=\"{{localize 'MYMODULE.Tooltip'}}\">Hover me</a>\n```\n\n### With Variables\n\n```handlebars\n{{localize \"MYMODULE.Welcome\" name=user.name}}\n\n{{localize \"MYMODULE.ItemCount\" count=items.length}}\n```\n\n### Dynamic Keys\n\n```handlebars\n{{localize (concat \"MYMODULE.Status.\" statusKey)}}\n```\n\n## Pluralization\n\nFoundry has no built-in pluralization. Handle manually:\n\n### Separate Keys Approach\n\n```json\n{\n  \"MYMODULE.Item.One\": \"1 item\",\n  \"MYMODULE.Item.Many\": \"{count} items\"\n}\n```\n\n```javascript\nfunction localizeCount(count) {\n  const key = count === 1\n    ? \"MYMODULE.Item.One\"\n    : \"MYMODULE.Item.Many\";\n  return game.i18n.format(key, { count });\n}\n```\n\n### Language-Aware Pluralization\n\n```javascript\n// For complex languages, use multiple keys\nconst key = count === 0 ? \"Zero\"\n          : count === 1 ? \"One\"\n          : count < 5 ? \"Few\"\n          : \"Many\";\n\nreturn game.i18n.format(`MYMODULE.Items.${key}`, { count });\n```\n\n## Best Practices\n\n### Key Naming\n\n```json\n{\n  // Good - specific and hierarchical\n  \"MYSYS.CharacterSheet.Abilities.Strength\": \"Strength\",\n  \"MYSYS.CharacterSheet.Abilities.Dexterity\": \"Dexterity\",\n  \"MYSYS.Dialog.ConfirmDelete.Title\": \"Confirm Deletion\",\n  \"MYSYS.Dialog.ConfirmDelete.Message\": \"Delete {name}?\",\n\n  // Bad - vague and conflict-prone\n  \"MYSYS.Label\": \"Label\",\n  \"MYSYS.Title\": \"Title\",\n  \"MYSYS.Button\": \"Button\"\n}\n```\n\n### Word Order for Translation\n\n```json\n{\n  // Good - translator can reorder\n  \"MYMODULE.Message\": \"The {adjective} {noun} is here\",\n\n  // Bad - forces English word order\n  \"MYMODULE.Prefix\": \"The\",\n  \"MYMODULE.Suffix\": \"is here\"\n}\n```\n\n### Context-Specific Strings\n\n```json\n{\n  // Good - separate by context\n  \"MYSYS.Button.Save.Settings\": \"Save Settings\",\n  \"MYSYS.Ability.Save.Fortitude\": \"Fortitude Save\",\n\n  // Bad - ambiguous\n  \"MYSYS.Save\": \"Save\"\n}\n```\n\n### What to Localize\n\n**Do localize:**\n- UI labels and headings\n- Button text\n- Dialog titles and messages\n- Error/notification messages\n- Placeholders and hints\n- Document type names\n\n**Don't localize:**\n- User-entered content\n- Code identifiers\n- Technical paths/URLs\n- Data that users create\n\n## Common Patterns\n\n### Settings Registration\n\n```javascript\ngame.settings.register(\"my-module\", \"enableFeature\", {\n  name: game.i18n.localize(\"MYMODULE.Settings.Enable\"),\n  hint: game.i18n.localize(\"MYMODULE.Settings.EnableHint\"),\n  scope: \"world\",\n  type: Boolean,\n  default: true\n});\n```\n\n### Dialog with Localization\n\n```javascript\nnew Dialog({\n  title: game.i18n.localize(\"MYMODULE.Dialog.Title\"),\n  content: game.i18n.format(\"MYMODULE.Dialog.Content\", {\n    name: item.name\n  }),\n  buttons: {\n    confirm: {\n      label: game.i18n.localize(\"MYMODULE.Button.Confirm\"),\n      callback: () => { /* ... */ }\n    },\n    cancel: {\n      label: game.i18n.localize(\"MYMODULE.Button.Cancel\")\n    }\n  }\n}).render(true);\n```\n\n### Notification\n\n```javascript\nui.notifications.info(\n  game.i18n.format(\"MYMODULE.Notification.Created\", {\n    type: item.type,\n    name: item.name\n  })\n);\n```\n\n## Common Pitfalls\n\n### 1. Concatenating Strings\n\n```javascript\n// WRONG - breaks translation\nconst msg = game.i18n.localize(\"MYMOD.The\") + \" \" +\n            name + \" \" +\n            game.i18n.localize(\"MYMOD.IsReady\");\n\n// CORRECT - use format with placeholders\nconst msg = game.i18n.format(\"MYMOD.ItemReady\", { name });\n```\n\n### 2. Hardcoded Text\n\n```javascript\n// WRONG\nui.notifications.info(\"Character saved!\");\n\n// CORRECT\nui.notifications.info(game.i18n.localize(\"MYMOD.CharacterSaved\"));\n```\n\n### 3. Missing Fallback Check\n\n```javascript\n// Be defensive with dynamic keys\nconst key = `MYMOD.Status.${status}`;\nconst label = game.i18n.has(key)\n  ? game.i18n.localize(key)\n  : status;  // Fallback to raw value\n```\n\n### 4. Template Quote Issues\n\n```handlebars\n<!-- WRONG - breaks attribute -->\n<input title=\"{{localize \"MYMOD.Tip\"}}\">\n\n<!-- CORRECT - use single quotes inside -->\n<input title=\"{{localize 'MYMOD.Tip'}}\">\n```\n\n### 5. Forgetting Manifest Entry\n\n```json\n// Don't forget to register in manifest!\n{\n  \"languages\": [\n    { \"lang\": \"en\", \"name\": \"English\", \"path\": \"lang/en.json\" }\n  ]\n}\n```\n\n## Directory Structure\n\n```\nmy-module/\nâ”œâ”€â”€ module.json\nâ”œâ”€â”€ lang/\nâ”‚   â”œâ”€â”€ en.json      # Required - fallback language\nâ”‚   â”œâ”€â”€ es.json\nâ”‚   â”œâ”€â”€ fr.json\nâ”‚   â””â”€â”€ de.json\nâ”œâ”€â”€ templates/\nâ”‚   â””â”€â”€ sheet.hbs\nâ””â”€â”€ scripts/\n    â””â”€â”€ main.js\n```\n\n## Implementation Checklist\n\n- [ ] Create `lang/en.json` with all strings\n- [ ] Register languages in manifest\n- [ ] Use namespaced keys (MODNAME.Category.Key)\n- [ ] Use `localize()` for simple strings\n- [ ] Use `format()` for strings with variables\n- [ ] Use single quotes in template attributes\n- [ ] Avoid string concatenation\n- [ ] Provide context-specific keys\n- [ ] Handle pluralization with separate keys\n- [ ] Test with different languages\n\n## References\n\n- [Localization API](https://foundryvtt.com/api/classes/foundry.helpers.Localization.html)\n- [Localization Article](https://foundryvtt.com/article/localization/)\n- [Localization Wiki](https://foundryvtt.wiki/en/development/api/localization)\n- [Best Practices](https://foundryvtt.wiki/en/development/guides/localization/localization-best-practices)\n\n---\n\n**Last Updated:** 2026-01-05\n**Status:** Production-Ready\n**Maintainer:** ImproperSubset\n",
        "fvtt-dev/skills/fvtt-performance-safe-updates/SKILL.md": "---\nname: fvtt-performance-safe-updates\ndescription: This skill should be used when adding features that update actors or items, implementing hook handlers, modifying update logic, or replacing embedded documents. Covers ownership guards, no-op checks, batched updates, queueUpdate wrapper, atomic document operations, and letting Foundry handle renders automatically for multi-client sync.\n---\n\n# Foundry VTT Performance-Safe Updates\n\nEnsure document updates in Foundry VTT modules don't cause multi-client update storms or render cascades.\n\n## When to Use This Skill\n\nInvoke this skill when implementing ANY of the following in a Foundry VTT module:\n- Adding a new feature that updates actors or items\n- Modifying existing update logic\n- Adding UI elements that trigger document changes\n- Implementing hook handlers that respond to document changes\n- Replacing or swapping embedded documents (abilities, items, effects)\n\n## Core Problem\n\nFoundry VTT runs in multi-client sessions where hooks fire on ALL connected clients. Without proper guards:\n- Every client triggers duplicate updates (2-10x redundant database writes)\n- Update storms occur when updates trigger more updates across clients\n- UI flickers when delete+create patterns cause \"empty state\" renders between operations\n- Performance degrades exponentially with number of connected clients\n\n## The Performance-Safe Pattern\n\n### Step 1: Ownership Guards\n\n**Before any document update, ask: \"Should this run on every client?\"**\n\n```javascript\n// âŒ BAD: Runs on every connected client\nHooks.on(\"deleteItem\", (item, options, userId) => {\n  item.parent.update({ \"system.someField\": newValue });\n});\n\n// âœ… GOOD: Only owner/GM performs the update\nHooks.on(\"deleteItem\", (item, options, userId) => {\n  if (!item.parent?.isOwner) return;\n  item.parent.update({ \"system.someField\": newValue });\n});\n```\n\n**Common ownership checks:**\n- `item.isOwner` - Current user owns this item\n- `item.parent?.isOwner` - Current user owns the parent (actor/container)\n- `actor.isOwner` - Current user owns this actor\n- `game.user.isGM` - Current user is the GM\n\n**Use GM-only guards for:**\n- World-level changes\n- Compendium updates\n- Global settings modifications\n\n### Step 2: Skip No-Op Updates\n\n**Before calling update, check if the value actually changes:**\n\n```javascript\n// âŒ BAD: Always updates, even if value unchanged\nawait actor.update({ \"system.selected_load_level\": newLevel });\n\n// âœ… GOOD: Skip if already set\nif (actor.system.selected_load_level === newLevel) return;\nawait actor.update({ \"system.selected_load_level\": newLevel });\n```\n\n**For flag-based updates:**\n\n```javascript\n// âœ… Skip if flag already matches target state\nconst currentProgress = actor.getFlag('bitd-alternate-sheets', 'abilityProgress') || {};\nif (currentProgress[abilityId] === targetValue) return;\n\nawait actor.setFlag('bitd-alternate-sheets', 'abilityProgress', {\n  ...currentProgress,\n  [abilityId]: targetValue\n});\n```\n\n### Step 3: Batch Multiple Updates\n\n**Combine multiple field changes into a single update call:**\n\n```javascript\n// âŒ BAD: Three separate updates (3x hooks, 3x database writes)\nawait actor.update({ \"system.harm.level1.value\": \"Bruised\" });\nawait actor.update({ \"system.stress.value\": 5 });\nawait actor.update({ \"system.xp.value\": 3 });\n\n// âœ… GOOD: Single batched update\nawait actor.update({\n  \"system.harm.level1.value\": \"Bruised\",\n  \"system.stress.value\": 5,\n  \"system.xp.value\": 3\n});\n```\n\n### Step 4: Use queueUpdate Wrapper\n\n**Wrap ALL document updates in queueUpdate to prevent concurrent update collisions:**\n\n```javascript\nimport { queueUpdate } from \"./update-queue.js\";\n\n// âœ… Prevents race conditions in multi-client sessions\nawait queueUpdate(async () => {\n  await this.actor.update(updates);\n});\n```\n\n**What queueUpdate does:**\n- Ensures updates execute sequentially, not concurrently\n- Prevents \"lost update\" race conditions\n- Automatically handles update conflicts\n\n**When to use:**\n- ANY actor.update() call\n- ANY updateEmbeddedDocuments() call\n- Batch operations that modify multiple documents\n\n### Step 5: Atomic Embedded Document Updates\n\n**When replacing embedded documents (items, effects), NEVER use delete+create:**\n\n```javascript\n// âŒ BAD: Delete + Create causes UI flicker and race conditions\nawait actor.deleteEmbeddedDocuments(\"Item\", [oldItemId]);\nawait actor.createEmbeddedDocuments(\"Item\", [newItemData]);\n// UI renders \"empty state\" between these calls!\n\n// âœ… GOOD: Update in place (atomic operation)\nawait actor.updateEmbeddedDocuments(\"Item\", [{\n  _id: oldItemId,\n  name: newItemData.name,\n  img: newItemData.img,\n  system: newItemData.system\n}]);\n```\n\n**Use cases:**\n- Swapping crew abilities\n- Changing hunting grounds\n- Replacing playbook items\n- Updating item references\n\n### Step 6: Guard Rerenders in Hooks\n\n**Only rerender sheets that are owned and currently visible:**\n\n```javascript\n// âŒ BAD: Rerenders ALL character sheets (including closed/unowned)\nHooks.on(\"renderBladesClockSheet\", (sheet, html, data) => {\n  game.actors.forEach(actor => {\n    actor.sheet.render(false);\n  });\n});\n\n// âœ… GOOD: Only rerender owned, open sheets\nHooks.on(\"renderBladesClockSheet\", (sheet, html, data) => {\n  game.actors.forEach(actor => {\n    if (actor.isOwner && actor.sheet.rendered) {\n      actor.sheet.render(false);\n    }\n  });\n});\n```\n\n### Step 7: Let Foundry Handle Renders (Avoid { render: false })\n\n**Default behavior:** When `document.update()` is called, Foundry automatically re-renders all registered sheets on ALL connected clients. This is the correct behavior for multi-client synchronization.\n\n**Understanding Foundry's render flow:**\n\nWhen `document.update()` is called, Foundry:\n1. Sends update to server\n2. Broadcasts change to all clients\n3. Fires `updateActor`/`updateItem` hooks on each client\n4. Automatically calls `render()` on sheets registered in `doc.apps`\n\n**Critical:** The `{ render: false }` option suppresses step 4 on **ALL clients**, not just the initiating client. This breaks multi-client synchronization.\n\n```javascript\n// âŒ BAD: Suppresses render on ALL clients, breaking multi-client sync\nawait actor.update({ \"system.value\": newValue }, { render: false });\n// Other players' sheets won't update!\n\n// âœ… GOOD: Let Foundry handle renders automatically\nawait queueUpdate(async () => {\n  await actor.update({ \"system.value\": newValue });\n});\n// All clients re-render automatically, staying in sync\n```\n\n**Only exception - Data Migrations in getData():**\n\nWhen migrating data inside `getData()`, you must suppress render to prevent infinite loops:\n\n```javascript\n// In getData() - migration MUST suppress render to avoid infinite loop\nasync getData() {\n  // Detect old data format that needs migration\n  if (this.actor.system.oldField !== undefined) {\n    queueUpdate(() => this.actor.update({\n      \"system.newField\": this.actor.system.oldField,\n      \"system.-=oldField\": null\n    }, { render: false }));\n  }\n  // ... rest of getData\n}\n```\n\n**With proper caching, Foundry sheet renders are fast (~2-3ms).** There's no need for \"optimistic UI\" patterns that manipulate DOM before/after updates.\n\n### Step 8: Use the safeUpdate Helper\n\n**Combine all guards into a single helper:**\n\n```javascript\n/**\n * Safely updates a document with ownership and no-op guards.\n * Lets Foundry handle re-renders automatically for multi-client sync.\n */\nexport async function safeUpdate(doc, updateData, options = {}) {\n  // 1. Ownership guard - only owner should update\n  if (!doc?.isOwner) return false;\n\n  // 2. Empty update guard\n  const entries = Object.entries(updateData || {});\n  if (entries.length === 0) return false;\n\n  // 3. No-op detection - skip if values unchanged\n  const hasChange = entries.some(([key, value]) => {\n    // Objects always treated as changes (too complex to deep-compare)\n    if (value !== null && typeof value === \"object\") return true;\n    const currentValue = foundry.utils.getProperty(doc, key);\n    return currentValue !== value;\n  });\n  if (!hasChange) return false;\n\n  // 4. Queued update - let Foundry handle renders\n  await queueUpdate(async () => {\n    await doc.update(updateData, options);\n  });\n  return true;\n}\n```\n\n**Usage:**\n\n```javascript\n// Standard pattern: handles all guards, Foundry re-renders all clients\nawait safeUpdate(doc, { \"system.value\": newValue });\n\n// Only use render: false for data migrations in getData()\nawait safeUpdate(doc, migrationData, { render: false });\n```\n\n### Step 9: Debounce High-Frequency Handlers\n\n**For handlers that run frequently (keyup, mousemove), add debouncing:**\n\n```javascript\nimport { debounce } from \"./utils.js\";\n\n// âŒ BAD: Updates on every keystroke\nhtml.find(\"input\").on(\"keyup\", async (ev) => {\n  await actor.update({ \"system.notes\": ev.target.value });\n});\n\n// âœ… GOOD: Debounce to reduce update frequency\nhtml.find(\"input\").on(\"keyup\", debounce(async (ev) => {\n  await queueUpdate(async () => {\n    await actor.update({ \"system.notes\": ev.target.value });\n  });\n}, 300));\n```\n\n## Quick Checklist for New Code\n\nBefore submitting any code that updates documents, verify:\n\n- [ ] **Ownership Guard**: Added `if (!item.parent?.isOwner) return;` or `if (!game.user.isGM) return;` where appropriate\n- [ ] **No-Op Check**: Skip update if current value already matches target value\n- [ ] **Batched**: Multiple field changes combined into single update object\n- [ ] **Queued**: Update wrapped in `queueUpdate(async () => { ... })`\n- [ ] **Atomic**: Used `updateEmbeddedDocuments()` instead of delete+create for replacements\n- [ ] **Rerender Guards**: Only rerender owned and currently open sheets\n- [ ] **No Render Suppression**: NOT using `{ render: false }` (breaks multi-client sync)\n- [ ] **Debounced**: High-frequency handlers (keyup, mousemove) use debouncing\n\n## Common Patterns by Feature Type\n\n### Adding a Toggle (checkbox, button)\n\n```javascript\nhtml.find(\".toggle-something\").on(\"click\", async (ev) => {\n  const currentValue = this.actor.system.someFlag;\n  const newValue = !currentValue;\n\n  // Skip if unchanged\n  if (currentValue === newValue) return;\n\n  await queueUpdate(async () => {\n    await this.actor.update({ \"system.someFlag\": newValue });\n  });\n  // No manual render - hook handles it\n});\n```\n\n### Implementing a Hook Handler\n\n```javascript\nHooks.on(\"deleteItem\", (item, options, userId) => {\n  // Guard: Only owner performs side effects\n  if (!item.parent?.isOwner) return;\n\n  // Check if update needed\n  const needsUpdate = /* your logic */;\n  if (!needsUpdate) return;\n\n  // Perform update\n  queueUpdate(async () => {\n    await item.parent.update({ /* changes */ });\n  });\n});\n```\n\n### Swapping Embedded Documents\n\n```javascript\nasync replaceAbility(oldAbilityId, newAbilityData) {\n  const oldAbility = this.actor.items.get(oldAbilityId);\n  if (!oldAbility) return;\n\n  // Update in place (atomic)\n  await queueUpdate(async () => {\n    await this.actor.updateEmbeddedDocuments(\"Item\", [{\n      _id: oldAbilityId,\n      name: newAbilityData.name,\n      img: newAbilityData.img,\n      system: newAbilityData.system\n    }]);\n  });\n}\n```\n\n## Anti-Patterns to Avoid\n\n### âŒ Update Storms\n```javascript\n// Every client updates, causing N Ã— clients database writes\nHooks.on(\"deleteItem\", (item) => {\n  item.parent.update({ ... });  // Missing ownership guard!\n});\n```\n\n### âŒ Render Cascades\n```javascript\n// Rerenders ALL sheets, including unowned/closed\nHooks.on(\"updateActor\", (actor) => {\n  game.actors.forEach(a => a.sheet.render(false));\n});\n```\n\n### âŒ Delete + Create Race Conditions\n```javascript\n// UI flickers; race condition between delete and create\nawait actor.deleteEmbeddedDocuments(\"Item\", [id]);\nawait actor.createEmbeddedDocuments(\"Item\", [data]);\n```\n\n### âŒ Redundant No-Op Updates\n```javascript\n// Updates even if value unchanged (wasted database writes)\nawait actor.update({ \"system.xp\": actor.system.xp });\n```\n\n### âŒ Render Suppression (Breaks Multi-Client Sync)\n```javascript\n// Suppresses render on ALL connected clients, not just initiating client!\nawait actor.update({ \"system.value\": newValue }, { render: false });\n// Other players' sheets won't update - they'll see stale data\n```\n\n### âŒ Optimistic UI DOM Manipulation\n```javascript\n// DOM manipulation before persist causes desync if update fails\ncheckbox.checked = newValue;  // Update DOM first (optimistic)\nawait actor.update({ \"system.equipped\": newValue });  // Then persist\n// If update fails, DOM shows wrong state; other clients may not sync\n```\n\n## Testing Multi-Client Performance\n\nAfter implementing updates, test with multiple clients:\n\n1. **Open two browser windows** (or use incognito mode)\n2. **Log in as different users** (or same user, different tabs)\n3. **Perform the action** (toggle, update, swap)\n4. **Check browser console** in both windows for:\n   - Duplicate update logs\n   - Error messages\n   - Unexpected rerenders\n5. **Verify in database** that only one update occurred (not N Ã— clients)\n\n## References\n\n- [Foundry VTT API - Document#update](https://foundryvtt.com/api/classes/foundry.abstract.Document.html#update) - Official update options including `render`\n- [dnd5e System](https://github.com/foundryvtt/dnd5e) - Uses `{ render: false }` pattern extensively in migrations\n- Update queue pattern: prevents concurrent update collisions\n- Atomic updates: `updateEmbeddedDocuments` vs delete+create\n\n**Implementation notes:**\n- The `queueUpdate` and `safeUpdate` helpers typically live in a utils module\n- Clock handlers and other UI interactions belong in dedicated feature modules\n- The exact file locations are project-specific; the patterns are what matter\n\n---\n\n**Last Updated:** 2026-01-14\n",
        "fvtt-dev/skills/fvtt-sheets/SKILL.md": "---\nname: fvtt-sheets\ndescription: This skill should be used when creating or extending ActorSheet/ItemSheet classes, implementing getData or _prepareContext, binding events with activateListeners, handling drag/drop, or migrating from ApplicationV1 to ApplicationV2. Covers both legacy V1 and modern V2 patterns.\n---\n\n# Foundry VTT Sheets\n\n**Domain:** Foundry VTT Module/System Development\n**Status:** Production-Ready\n**Last Updated:** 2026-01-04\n\n## Overview\n\nDocument sheets (ActorSheet, ItemSheet) are the primary UI for interacting with game entities. Foundry supports two patterns: legacy ApplicationV1 (until V16) and modern ApplicationV2 (V12+).\n\n### When to Use This Skill\n\n- Creating custom character or item sheets\n- Extending existing sheet classes\n- Adding interactivity (rolls, item management)\n- Implementing drag/drop functionality\n- Migrating V1 sheets to V2\n\n### V1 vs V2 Quick Comparison\n\n| Aspect | V1 (Legacy) | V2 (Modern) |\n|--------|-------------|-------------|\n| Config | `static get defaultOptions()` | `static DEFAULT_OPTIONS` |\n| Data | `getData()` | `async _prepareContext()` |\n| Events | `activateListeners(html)` | `static actions` + `_onRender()` |\n| Templates | Single template | Multi-part PARTS system |\n| Re-render | Full sheet | Partial by part |\n| Support | Until V16 | Current standard |\n\n## ApplicationV1 Sheets\n\n### Basic Structure\n\n```javascript\nexport class MyActorSheet extends ActorSheet {\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: [\"my-system\", \"sheet\", \"actor\"],\n      template: \"systems/my-system/templates/actor-sheet.hbs\",\n      width: 600,\n      height: 600,\n      tabs: [{\n        navSelector: \".sheet-tabs\",\n        contentSelector: \".sheet-body\",\n        initial: \"description\"\n      }],\n      dragDrop: [{\n        dragSelector: \".item-list .item\",\n        dropSelector: null\n      }]\n    });\n  }\n\n  // Dynamic template based on actor type\n  get template() {\n    return `systems/my-system/templates/actor-${this.actor.type}-sheet.hbs`;\n  }\n}\n```\n\n### getData() - Preparing Template Context\n\n```javascript\ngetData() {\n  const context = super.getData();\n  const actorData = this.actor.toObject(false);\n\n  // Add data to context\n  context.system = actorData.system;\n  context.flags = actorData.flags;\n  context.items = actorData.items;\n\n  // Organize items by type\n  context.weapons = context.items.filter(i => i.type === \"weapon\");\n  context.spells = context.items.filter(i => i.type === \"spell\");\n\n  // Enrich HTML (sync in V1)\n  context.enrichedBio = TextEditor.enrichHTML(\n    this.actor.system.biography,\n    { secrets: this.actor.isOwner, async: false }\n  );\n\n  return context;\n}\n```\n\n**Key Points:**\n- Context has NO automatic relation to document data\n- Everything template needs MUST be explicitly added\n- `{{system.hp.value}}` reads from context\n- `name=\"system.hp.value\"` writes to document\n\n### activateListeners() - Event Binding\n\n```javascript\nactivateListeners(html) {\n  // ALWAYS call super first\n  super.activateListeners(html);\n\n  // Skip if not editable\n  if (!this.isEditable) return;\n\n  // Roll handlers\n  html.on(\"click\", \".rollable\", this._onRoll.bind(this));\n\n  // Item management\n  html.on(\"click\", \".item-create\", this._onItemCreate.bind(this));\n  html.on(\"click\", \".item-edit\", this._onItemEdit.bind(this));\n  html.on(\"click\", \".item-delete\", this._onItemDelete.bind(this));\n}\n\nasync _onRoll(event) {\n  event.preventDefault();\n  const element = event.currentTarget;\n  const { rollType, formula, label } = element.dataset;\n\n  const roll = new Roll(formula, this.actor.getRollData());\n  await roll.evaluate();\n  roll.toMessage({\n    speaker: ChatMessage.getSpeaker({ actor: this.actor }),\n    flavor: label\n  });\n}\n\nasync _onItemCreate(event) {\n  event.preventDefault();\n  const type = event.currentTarget.dataset.type;\n  await this.actor.createEmbeddedDocuments(\"Item\", [{\n    name: `New ${type.capitalize()}`,\n    type: type\n  }]);\n}\n\nasync _onItemDelete(event) {\n  event.preventDefault();\n  const li = $(event.currentTarget).closest(\".item\");\n  const item = this.actor.items.get(li.data(\"itemId\"));\n  await item.delete();\n  li.slideUp(200, () => this.render(false));\n}\n```\n\n### Drag & Drop (V1)\n\n```javascript\n// Automatic via defaultOptions\nstatic get defaultOptions() {\n  return foundry.utils.mergeObject(super.defaultOptions, {\n    dragDrop: [{\n      dragSelector: \".item-list .item\",\n      dropSelector: null\n    }]\n  });\n}\n\n// Override handlers as needed\n_onDragStart(event) {\n  const li = event.currentTarget;\n  const item = this.actor.items.get(li.dataset.itemId);\n  event.dataTransfer.setData(\"text/plain\", JSON.stringify(item.toDragData()));\n}\n\nasync _onDrop(event) {\n  const data = TextEditor.getDragEventData(event);\n\n  if (data.type === \"Item\") {\n    return this._onDropItem(event, data);\n  }\n}\n\nasync _onDropItem(event, data) {\n  if (!this.actor.isOwner) return false;\n  const item = await Item.implementation.fromDropData(data);\n\n  // Prevent dropping on self\n  if (this.actor.uuid === item.parent?.uuid) return;\n\n  return this.actor.createEmbeddedDocuments(\"Item\", [item.toObject()]);\n}\n```\n\n### Tab Navigation (V1)\n\n```html\n<!-- Template structure -->\n<nav class=\"sheet-tabs\">\n  <a class=\"item\" data-tab=\"description\">Description</a>\n  <a class=\"item\" data-tab=\"items\">Items</a>\n</nav>\n\n<section class=\"sheet-body\">\n  <div class=\"tab\" data-group=\"primary\" data-tab=\"description\">\n    <!-- Description content -->\n  </div>\n  <div class=\"tab\" data-group=\"primary\" data-tab=\"items\">\n    <!-- Items content -->\n  </div>\n</section>\n```\n\n## ApplicationV2 Sheets\n\n### Basic Structure\n\n```javascript\nclass MyActorSheet extends foundry.applications.api.HandlebarsApplicationMixin(\n  foundry.applications.sheets.ActorSheetV2\n) {\n  static DEFAULT_OPTIONS = {\n    classes: [\"my-system\", \"sheet\", \"actor\"],\n    tag: \"form\",\n    window: {\n      resizable: true\n    },\n    position: {\n      width: 600,\n      height: 600\n    },\n    actions: {\n      rollSkill: this.#onRollSkill,\n      createItem: this.#onCreateItem,\n      deleteItem: this.#onDeleteItem\n    }\n  }\n\n  static PARTS = {\n    header: {\n      template: \"systems/my-system/templates/actor/header.hbs\"\n    },\n    tabs: {\n      template: \"templates/generic/tab-navigation.hbs\"\n    },\n    description: {\n      template: \"systems/my-system/templates/actor/description.hbs\",\n      scrollable: [\"\"]\n    },\n    items: {\n      template: \"systems/my-system/templates/actor/items.hbs\",\n      scrollable: [\"\"]\n    }\n  }\n\n  static TABS = {\n    primary: {\n      tabs: [\n        { id: \"description\" },\n        { id: \"items\" }\n      ],\n      labelPrefix: \"MYSYS.TAB\",\n      initial: \"description\"\n    }\n  }\n}\n```\n\n### _prepareContext() - Async Data Preparation\n\n```javascript\nasync _prepareContext(options) {\n  const context = await super._prepareContext(options);\n\n  // Add tabs\n  context.tabs = this._prepareTabs(this.tabGroups.primary);\n\n  // Add system data\n  context.system = this.document.system;\n\n  // Organize items\n  context.weapons = this.document.items.filter(i => i.type === \"weapon\");\n  context.spells = this.document.items.filter(i => i.type === \"spell\");\n\n  // Enrich HTML (MUST be async in V2)\n  context.enrichedBio = await TextEditor.enrichHTML(\n    this.document.system.biography,\n    { async: true, relativeTo: this.document }\n  );\n\n  return context;\n}\n\nasync _preparePartContext(partId, context) {\n  switch (partId) {\n    case \"description\":\n    case \"items\":\n      context.tab = context.tabs[partId];\n      break;\n  }\n  return context;\n}\n```\n\n### Static Actions (V2 Event Handling)\n\n```javascript\nstatic DEFAULT_OPTIONS = {\n  actions: {\n    rollSkill: this.#onRollSkill,\n    createItem: this.#onCreateItem,\n    deleteItem: this.#onDeleteItem\n  }\n}\n\n// Action handlers MUST be static with # prefix\nstatic #onRollSkill(event, target) {\n  // 'this' is the application instance\n  // 'target' is the clicked element\n  const skillId = target.dataset.skillId;\n  const skill = this.document.system.skills[skillId];\n\n  const roll = new Roll(\"1d20 + @mod\", { mod: skill.value });\n  roll.evaluate().then(r => {\n    r.toMessage({\n      speaker: ChatMessage.getSpeaker({ actor: this.document }),\n      flavor: `${skill.label} Check`\n    });\n  });\n}\n\nstatic async #onCreateItem(event, target) {\n  const type = target.dataset.type;\n  await this.document.createEmbeddedDocuments(\"Item\", [{\n    name: `New ${type.capitalize()}`,\n    type: type\n  }]);\n}\n\nstatic async #onDeleteItem(event, target) {\n  const itemId = target.closest(\"[data-item-id]\").dataset.itemId;\n  const item = this.document.items.get(itemId);\n  await item.delete();\n}\n```\n\nTemplate usage:\n```html\n<button type=\"button\" data-action=\"rollSkill\" data-skill-id=\"athletics\">\n  Roll Athletics\n</button>\n```\n\n### Tab Navigation (V2)\n\nFour required elements:\n\n**1. Static PARTS with tab templates**\n**2. Static TABS configuration**\n**3. Prepare tabs in _prepareContext**\n**4. Set tab in _preparePartContext**\n\n```html\n<!-- Tab content template - MUST include data-group, data-tab, and {{tab.cssClass}} -->\n<div class=\"tab-content {{tab.cssClass}}\" data-group=\"primary\" data-tab=\"description\">\n  <!-- Content -->\n</div>\n```\n\n### Drag & Drop (V2)\n\nActorSheetV2 provides automatic drag/drop for items. Just use:\n\n```html\n<li class=\"item draggable\" data-item-id=\"{{item._id}}\">\n  <!-- Item content -->\n</li>\n```\n\nFor base ApplicationV2, manual setup required:\n\n```javascript\n#dragDrop;\n\nconstructor(options = {}) {\n  super(options);\n  this.#dragDrop = this.options.dragDrop.map(d => {\n    d.permissions = {\n      dragstart: this._canDragStart.bind(this),\n      drop: this._canDragDrop.bind(this)\n    };\n    d.callbacks = {\n      dragstart: this._onDragStart.bind(this),\n      drop: this._onDrop.bind(this)\n    };\n    return new foundry.applications.ux.DragDrop(d);\n  });\n}\n\n_onRender(context, options) {\n  this.#dragDrop.forEach(d => d.bind(this.element));\n}\n```\n\n## Common Pitfalls\n\n### 1. Forgetting super.activateListeners()\n\n```javascript\n// WRONG - breaks base functionality\nactivateListeners(html) {\n  html.on(\"click\", \".rollable\", this._onRoll.bind(this));\n}\n\n// CORRECT\nactivateListeners(html) {\n  super.activateListeners(html);\n  html.on(\"click\", \".rollable\", this._onRoll.bind(this));\n}\n```\n\n### 2. Context Binding Issues\n\n```javascript\n// WRONG - loses 'this' context\nhtml.on(\"click\", \".rollable\", this._onRoll);\n\n// CORRECT\nhtml.on(\"click\", \".rollable\", this._onRoll.bind(this));\n```\n\n### 3. Memory Leaks from Global Listeners\n\n```javascript\n// WRONG - binds globally on every render\nactivateListeners(html) {\n  super.activateListeners(html);\n  $(document).on(\"click\", this._onClick.bind(this));\n}\n\n// CORRECT - namespace and unbind first\nactivateListeners(html) {\n  super.activateListeners(html);\n  $(document).off(\"click.mysheet\").on(\"click.mysheet\", this._onClick.bind(this));\n}\n\n// Clean up on close\nclose(options) {\n  $(document).off(\"click.mysheet\");\n  return super.close(options);\n}\n```\n\n### 4. V2 Static Action Mistakes\n\n```javascript\n// WRONG - action handler isn't static\nstatic DEFAULT_OPTIONS = {\n  actions: {\n    roll: this._onRoll  // Error!\n  }\n}\n\n// CORRECT - use static private method\nstatic DEFAULT_OPTIONS = {\n  actions: {\n    roll: this.#onRoll\n  }\n}\n\nstatic #onRoll(event, target) {\n  // ...\n}\n```\n\n### 5. V2 Partial Re-render Hook Multiplication\n\n```javascript\n// PROBLEM - element added multiple times\nHooks.on(\"renderMySheet\", (app, html, data) => {\n  html.append(\"<div class='custom'></div>\");\n});\n\n// SOLUTION - check if exists\nHooks.on(\"renderMySheet\", (app, html, data) => {\n  if (!html.querySelector(\".custom\")) {\n    html.append(\"<div class='custom'></div>\");\n  }\n});\n```\n\n### 6. Form Data Type Mismatches\n\n```html\n<!-- WRONG - saves as string -->\n<input type=\"text\" name=\"system.level\" value=\"{{system.level}}\"/>\n\n<!-- CORRECT - saves as number -->\n<input type=\"text\" name=\"system.level\" value=\"{{system.level}}\" data-dtype=\"Number\"/>\n\n<!-- Checkbox must use checked helper -->\n<input type=\"checkbox\" name=\"system.equipped\" {{checked system.equipped}}/>\n```\n\n### 7. Async in V1 vs V2\n\n```javascript\n// V1 - getData is sync, use async: false\ngetData() {\n  context.enrichedBio = TextEditor.enrichHTML(bio, { async: false });\n  return context;\n}\n\n// V2 - _prepareContext is async, use async: true\nasync _prepareContext(options) {\n  context.enrichedBio = await TextEditor.enrichHTML(bio, { async: true });\n  return context;\n}\n```\n\n## Implementation Checklist\n\n### V1 Sheet\n- [ ] Extend ActorSheet or ItemSheet\n- [ ] Define `static get defaultOptions()` with template, classes, tabs\n- [ ] Implement `getData()` returning context object\n- [ ] Call `super.activateListeners(html)` first\n- [ ] Check `this.isEditable` before binding edit controls\n- [ ] Use `.bind(this)` for all event handlers\n- [ ] Clean up global event listeners in `close()`\n\n### V2 Sheet\n- [ ] Extend ActorSheetV2 with HandlebarsApplicationMixin\n- [ ] Define `static DEFAULT_OPTIONS` with `tag: \"form\"`\n- [ ] Define `static PARTS` for each template section\n- [ ] Define `static TABS` if using tabs\n- [ ] Implement `async _prepareContext()` with `await super._prepareContext()`\n- [ ] Implement `_preparePartContext()` for tab data\n- [ ] Use `static actions` with `#` prefix handlers\n- [ ] Use `.draggable` class and `data-item-id` for drag/drop\n\n## References\n\n- [ActorSheet V1 Tutorial](https://foundryvtt.wiki/en/development/guides/SD-tutorial/SD07-Extending-the-ActorSheet-class)\n- [ApplicationV2 Guide](https://foundryvtt.wiki/en/development/api/applicationv2)\n- [V2 Conversion Guide](https://foundryvtt.wiki/en/development/guides/applicationV2-conversion-guide)\n- [ActorSheetV2 API](https://foundryvtt.com/api/classes/foundry.applications.sheets.ActorSheetV2.html)\n- [Tabs in AppV2](https://foundryvtt.wiki/en/development/guides/Tabs-and-Templates/Tabs-in-AppV2)\n\n---\n\n**Last Updated:** 2026-01-04\n**Status:** Production-Ready\n**Maintainer:** ImproperSubset\n",
        "fvtt-dev/skills/fvtt-sockets/SKILL.md": "---\nname: fvtt-sockets\ndescription: This skill should be used when implementing multiplayer synchronization, using game.socket.emit/on, creating executeAsGM patterns for privileged operations, broadcasting events between clients, or avoiding common pitfalls like race conditions and duplicate execution.\n---\n\n# Foundry VTT Sockets & Multiplayer\n\n**Domain:** Foundry VTT Module/System Development\n**Status:** Production-Ready\n**Last Updated:** 2026-01-04\n\n## Overview\n\nFoundry VTT uses Socket.io for real-time communication between server and clients. Understanding socket patterns is essential for multiplayer-safe code.\n\n### When to Use This Skill\n\n- Broadcasting events to other connected clients\n- Implementing GM-delegated operations for players\n- Synchronizing non-document state across clients\n- Creating animations/effects visible to all players\n- Avoiding duplicate execution in hooks\n\n## Socket Setup\n\n### Manifest Configuration\n\nRequest socket access in your manifest:\n\n```json\n{\n  \"id\": \"my-module\",\n  \"socket\": true\n}\n```\n\n### Event Naming\n\nEach package gets ONE event namespace:\n- **Modules:** `module.{module-id}`\n- **Systems:** `system.{system-id}`\n\nMultiplex event types with structured data:\n\n```javascript\nconst SOCKET_NAME = \"module.my-module\";\n\ngame.socket.emit(SOCKET_NAME, {\n  type: \"playAnimation\",\n  payload: { tokenId: \"abc123\", effect: \"fire\" }\n});\n```\n\n### Registration Timing\n\nRegister listeners after `game.socket` is available:\n\n```javascript\nHooks.once(\"init\", () => {\n  game.socket.on(\"module.my-module\", handleSocketMessage);\n});\n\nfunction handleSocketMessage(data) {\n  switch (data.type) {\n    case \"playAnimation\":\n      playTokenAnimation(data.payload);\n      break;\n    case \"syncState\":\n      updateLocalState(data.payload);\n      break;\n  }\n}\n```\n\n## Basic Socket Patterns\n\n### Emit to All Other Clients\n\n```javascript\nfunction broadcastAnimation(tokenId, effect) {\n  game.socket.emit(\"module.my-module\", {\n    type: \"playAnimation\",\n    tokenId,\n    effect\n  });\n}\n```\n\n**Critical:** Emitting client does NOT receive its own broadcast.\n\n### Self-Invoke Pattern\n\nAlways call handler locally when emitting:\n\n```javascript\nfunction triggerEffect(tokenId, effect) {\n  const data = { type: \"effect\", tokenId, effect };\n\n  // Execute locally\n  handleEffect(data);\n\n  // Broadcast to others\n  game.socket.emit(\"module.my-module\", data);\n}\n\nfunction handleEffect(data) {\n  const token = canvas.tokens.get(data.tokenId);\n  token?.animate({ alpha: 0.5 }, { duration: 500 });\n}\n\n// Socket listener (for other clients)\nHooks.once(\"init\", () => {\n  game.socket.on(\"module.my-module\", (data) => {\n    if (data.type === \"effect\") handleEffect(data);\n  });\n});\n```\n\n## ExecuteAsGM Pattern\n\nPlayers often need GM-authorized operations (damage enemies, modify world data).\n\n### Native Socket Approach\n\n```javascript\nconst SOCKET_NAME = \"module.my-module\";\n\nHooks.once(\"init\", () => {\n  game.socket.on(SOCKET_NAME, async (data) => {\n    // Only active GM handles this\n    if (game.user !== game.users.activeGM) return;\n\n    if (data.type === \"damageActor\") {\n      const actor = game.actors.get(data.actorId);\n      if (actor) {\n        const newHp = actor.system.hp.value - data.damage;\n        await actor.update({ \"system.hp.value\": Math.max(0, newHp) });\n      }\n    }\n  });\n});\n\n// Player calls this\nfunction requestDamage(actorId, damage) {\n  game.socket.emit(SOCKET_NAME, {\n    type: \"damageActor\",\n    actorId,\n    damage\n  });\n}\n```\n\n**Limitations:**\n- No return value\n- Manual GM check required\n- Fails silently if no GM connected\n\n### Socketlib Approach (Recommended)\n\nSocketlib handles multiple GMs, return values, and error cases.\n\n**Dependency (module.json):**\n```json\n{\n  \"relationships\": {\n    \"requires\": [{\n      \"id\": \"socketlib\",\n      \"type\": \"module\"\n    }]\n  }\n}\n```\n\n**Registration:**\n```javascript\nlet socket;\n\nHooks.once(\"socketlib.ready\", () => {\n  socket = socketlib.registerModule(\"my-module\");\n\n  // Register callable functions\n  socket.register(\"damageActor\", damageActor);\n  socket.register(\"getActorData\", getActorData);\n});\n\nasync function damageActor(actorId, damage) {\n  const actor = game.actors.get(actorId);\n  if (!actor) return { success: false, error: \"Actor not found\" };\n\n  const newHp = Math.max(0, actor.system.hp.value - damage);\n  await actor.update({ \"system.hp.value\": newHp });\n  return { success: true, newHp };\n}\n\nfunction getActorData(actorId) {\n  return game.actors.get(actorId)?.toObject() ?? null;\n}\n```\n\n**Usage:**\n```javascript\n// Execute on GM client, get return value\nasync function applyDamage(actorId, damage) {\n  try {\n    const result = await socket.executeAsGM(\"damageActor\", actorId, damage);\n    if (result.success) {\n      ui.notifications.info(`Damage applied. HP now: ${result.newHp}`);\n    }\n  } catch (error) {\n    ui.notifications.error(\"No GM connected to process damage\");\n  }\n}\n```\n\n## Socketlib Methods\n\n| Method | Target | Awaitable | Use Case |\n|--------|--------|-----------|----------|\n| `executeAsGM(fn, ...args)` | One GM | Yes | Privileged operations |\n| `executeAsUser(fn, userId, ...args)` | Specific user | Yes | Player-specific actions |\n| `executeForEveryone(fn, ...args)` | All clients | No | Broadcast effects |\n| `executeForOthers(fn, ...args)` | All except self | No | Sync without local call |\n| `executeForAllGMs(fn, ...args)` | All GMs | No | GM notifications |\n| `executeForUsers(fn, ids[], ...args)` | Listed users | No | Targeted messages |\n\n### ExecuteForEveryone Example\n\n```javascript\n// Trigger animation on ALL clients\nfunction playGlobalEffect(effectData) {\n  socket.executeForEveryone(\"renderEffect\", effectData);\n}\n\n// Registered function\nfunction renderEffect(data) {\n  canvas.effects.playEffect(data);\n}\n```\n\n### ExecuteAsUser Example\n\n```javascript\n// Ask specific player for input\nasync function promptPlayer(userId, question) {\n  try {\n    return await socket.executeAsUser(\"showDialog\", userId, question);\n  } catch {\n    return null; // Player disconnected\n  }\n}\n\n// Registered function\nasync function showDialog(question) {\n  return new Promise(resolve => {\n    new Dialog({\n      title: question,\n      buttons: {\n        yes: { label: \"Yes\", callback: () => resolve(true) },\n        no: { label: \"No\", callback: () => resolve(false) }\n      }\n    }).render(true);\n  });\n}\n```\n\n## Data Synchronization\n\n### Document Updates (Automatic)\n\nFoundry syncs document updates automatically:\n\n```javascript\n// Syncs to all clients\nawait actor.update({ \"system.hp.value\": 50 });\n\n// Does NOT sync (in-memory only)\nactor.system.hp.value = 50;\n```\n\n### Non-Document State\n\nUse sockets for custom state:\n\n```javascript\nlet combatState = {};\n\nHooks.once(\"socketlib.ready\", () => {\n  socket.register(\"syncCombatState\", (state) => {\n    combatState = state;\n    Hooks.callAll(\"combatStateChanged\", state);\n  });\n});\n\nfunction updateCombatState(newState) {\n  combatState = newState;\n  socket.executeForEveryone(\"syncCombatState\", newState);\n}\n```\n\n### Ownership Considerations\n\nOnly owners can update documents:\n\n```javascript\n// Player cannot update enemy\nawait enemyActor.update({ ... }); // Permission denied!\n\n// Must delegate to GM\nawait socket.executeAsGM(\"updateEnemy\", enemyId, changes);\n```\n\n## Common Pitfalls\n\n### 1. Emitter Doesn't Receive Broadcast\n\n```javascript\n// WRONG - emitter never sees this\ngame.socket.on(\"module.my-module\", playSound);\ngame.socket.emit(\"module.my-module\", { sound: \"bell.wav\" });\n// Sound plays for others, NOT for emitter!\n\n// CORRECT - call locally AND emit\nplaySound({ sound: \"bell.wav\" });\ngame.socket.emit(\"module.my-module\", { sound: \"bell.wav\" });\n```\n\n### 2. Duplicate Execution in Hooks\n\n```javascript\n// WRONG - runs on ALL clients\nHooks.on(\"deleteItem\", (item) => {\n  item.parent.update({ \"system.count\": item.parent.items.length });\n});\n\n// CORRECT - only owner executes\nHooks.on(\"deleteItem\", (item) => {\n  if (!item.parent?.isOwner) return;\n  item.parent.update({ \"system.count\": item.parent.items.length });\n});\n```\n\n### 3. Race Conditions with Multiple GMs\n\n```javascript\n// RISKY - activeGM can change during async\ngame.socket.on(name, async (data) => {\n  if (game.user !== game.users.activeGM) return;\n  await actor.update({ ... }); // Another GM might be active now!\n});\n\n// SAFE - socketlib guarantees atomic execution\nawait socket.executeAsGM(\"updateActor\", actorId, data);\n```\n\n### 4. No Permission Check on Handlers\n\n```javascript\n// VULNERABLE - any player can trigger\ngame.socket.on(name, (data) => {\n  game.actors.get(data.id).update({ \"system.hp\": 9999 });\n});\n\n// SAFE - validate permissions\ngame.socket.on(name, (data) => {\n  const actor = game.actors.get(data.id);\n  if (!actor?.isOwner && !game.user.isGM) return;\n  actor.update({ \"system.hp\": data.hp });\n});\n```\n\n### 5. No GM Connected\n\n```javascript\n// WRONG - silent failure\nsocket.executeAsGM(\"doThing\", data);\n\n// CORRECT - handle error\ntry {\n  await socket.executeAsGM(\"doThing\", data);\n} catch {\n  ui.notifications.warn(\"A GM must be connected for this action\");\n}\n```\n\n### 6. Update Storms\n\n```javascript\n// WRONG - N clients = N updates\nHooks.on(\"updateActor\", (actor, changes) => {\n  actor.update({ \"system.modified\": Date.now() });\n});\n\n// CORRECT - only owner updates\nHooks.on(\"updateActor\", (actor, changes) => {\n  if (!actor.isOwner) return;\n  if (changes.system?.modified) return; // Prevent loop\n  actor.update({ \"system.modified\": Date.now() });\n});\n```\n\n## Best Practices\n\n### 1. Use Structured Events\n\n```javascript\n// Good - clear, maintainable\ngame.socket.emit(SOCKET_NAME, {\n  type: \"applyEffect\",\n  targetId: token.id,\n  effectType: \"fire\",\n  duration: 3000\n});\n```\n\n### 2. Batch Updates\n\n```javascript\n// Bad - 3 updates\nawait actor.update({ \"system.hp\": 10 });\nawait actor.update({ \"system.mp\": 5 });\nawait actor.update({ \"system.status\": \"hurt\" });\n\n// Good - 1 update\nawait actor.update({\n  \"system.hp\": 10,\n  \"system.mp\": 5,\n  \"system.status\": \"hurt\"\n});\n```\n\n### 3. Skip No-Op Updates\n\n```javascript\nconst newHp = calculateHp(actor);\nif (actor.system.hp.value === newHp) return;\nawait actor.update({ \"system.hp.value\": newHp });\n```\n\n### 4. Document Socket Messages\n\n```javascript\n/**\n * Socket: module.my-module\n *\n * @event applyDamage\n * @param {string} actorId - Target actor\n * @param {number} damage - Damage amount\n * @param {string} type - Damage type (fire, cold, etc.)\n */\n```\n\n### 5. Prefer Socketlib for Complex Operations\n\nNative sockets for simple broadcasts. Socketlib when you need:\n- Return values\n- Multiple GM handling\n- Permission-based execution\n- Error handling\n\n## Implementation Checklist\n\n- [ ] Add `\"socket\": true` to manifest\n- [ ] Use correct namespace (`module.X` or `system.X`)\n- [ ] Register listeners in `init` hook\n- [ ] Use structured event data with `type` field\n- [ ] Call handler locally when emitting (self-invoke pattern)\n- [ ] Check ownership in document operation hooks\n- [ ] Use socketlib for GM-delegated operations\n- [ ] Handle \"no GM connected\" errors\n- [ ] Batch related updates\n- [ ] Skip no-op updates\n- [ ] Test with multiple connected clients\n\n## References\n\n- [Sockets Wiki](https://foundryvtt.wiki/en/development/api/sockets)\n- [Game.socket API](https://foundryvtt.com/api/classes/foundry.Game.html)\n- [Socketlib Package](https://foundryvtt.com/packages/socketlib)\n- [Socketlib GitHub](https://github.com/manuelVo/foundryvtt-socketlib)\n\n---\n\n**Last Updated:** 2026-01-04\n**Status:** Production-Ready\n**Maintainer:** ImproperSubset\n",
        "fvtt-dev/skills/fvtt-v13-migration/SKILL.md": "---\nname: fvtt-v13-migration\ndescription: This skill should be used when the user asks to \"migrate to V13\", \"upgrade to Foundry V13\", \"update module for V13\", \"fix V13 compatibility\", \"convert to ESM\", \"use DataModel\", or mentions V13-specific patterns like hook signature changes, actor.system vs actor.data.data, or Application V2. Provides comprehensive Foundry VTT V13 development patterns and migration guidance.\n---\n\n# Foundry VTT V13 Development Guide\n\n**Domain:** Foundry VTT Module/System Development\n**Status:** Production-Ready\n**Last Updated:** 2026-01-05\n\n## Overview\n\nThis guide covers V13-specific patterns and migration from earlier versions. For modules targeting V13, follow these guidelines.\n\n### When to Use This Skill\n\n- Migrating a module/system from V12 or earlier to V13\n- Converting CommonJS (`require`) to ESM (`import`/`export`)\n- Implementing DataModel for structured data\n- Updating deprecated patterns (`actor.data.data` to `actor.system`)\n- Fixing hook signature changes after V13 upgrade\n- Setting up V13-compatible manifest configuration\n\n## Core Architecture Principles\n\n### Use DataModel for Structured Data\n**ALWAYS** use `foundry.abstract.DataModel` for defining data structures instead of plain JavaScript objects. DataModels provide:\n- Built-in validation and type coercion\n- Schema definition with `DataSchema`\n- Automatic data preparation lifecycle\n- Integration with Foundry's document system\n\nExample:\n```javascript\nclass MyModuleData extends foundry.abstract.DataModel {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n    return {\n      name: new fields.StringField({ required: true, blank: false }),\n      value: new fields.NumberField({ initial: 0, min: 0 }),\n      enabled: new fields.BooleanField({ initial: true })\n    };\n  }\n}\n```\n\n### ESM Modules Only\nFoundry V13 uses **ECMAScript Modules (ESM)** exclusively. Your code must:\n- Use `import` and `export` statements (NO `require()`)\n- Declare `\"esmodules\"` in your manifest (NOT `\"scripts\"`)\n- Use `.js` extensions in import paths when importing relative files\n\nExample manifest entry:\n```json\n{\n  \"esmodules\": [\"scripts/module.js\"],\n  \"scripts\": []\n}\n```\n\n### Internationalization (i18n)\n**ALWAYS** use `game.i18n.localize()` or `game.i18n.format()` for user-facing text. Never hardcode English strings.\n\n```javascript\n// BAD\nui.notifications.info(\"Item created successfully\");\n\n// GOOD\nui.notifications.info(game.i18n.localize(\"MYMODULE.Notifications.ItemCreated\"));\n\n// For dynamic values\nconst message = game.i18n.format(\"MYMODULE.Notifications.ItemCreatedWithName\", {\n  name: itemName\n});\n```\n\nLocalization files go in `lang/en.json`:\n```json\n{\n  \"MYMODULE.Notifications.ItemCreated\": \"Item created successfully\",\n  \"MYMODULE.Notifications.ItemCreatedWithName\": \"Item {name} created successfully\"\n}\n```\n\n## Common V13 Pitfalls\n\n### Hook Arguments Have Changed\nMany hooks in V13 have different argument signatures than V12. Always check the current API documentation.\n\n**Example: `createToken` Hook**\n```javascript\n// V12 (OLD - WRONG in V13)\nHooks.on(\"createToken\", (scene, tokenData, options, userId) => { });\n\n// V13 (CORRECT)\nHooks.on(\"createToken\", (tokenDocument, options, userId) => { });\n```\n\n### Document vs Data\nV13 distinguishes between Document classes (e.g., `Actor`, `Item`) and their data models:\n- Access document properties directly: `actor.name`, `item.system`\n- Use `actor.system` to access system-specific data defined in your DataModel\n- Avoid accessing `actor.data.data` (deprecated pattern from V10)\n\n```javascript\n// BAD (V10 pattern)\nconst hp = actor.data.data.attributes.hp.value;\n\n// GOOD (V13 pattern)\nconst hp = actor.system.attributes.hp.value;\n```\n\n### Active Effects Structure\nActive Effects in V13 use a cleaner structure:\n- Effects are stored in `document.effects` (EffectCollection)\n- Use `await actor.createEmbeddedDocuments(\"ActiveEffect\", [effectData])`\n- Effect changes use `key` (path to property) and `mode` (add, multiply, override, etc.)\n\n```javascript\nconst effectData = {\n  name: game.i18n.localize(\"MYMODULE.Effects.Blessed\"),\n  icon: \"icons/magic/light/beam-rays-yellow.webp\",\n  changes: [{\n    key: \"system.attributes.ac.bonus\",\n    mode: CONST.ACTIVE_EFFECT_MODES.ADD,\n    value: \"2\"\n  }],\n  duration: { rounds: 10 }\n};\n\nawait actor.createEmbeddedDocuments(\"ActiveEffect\", [effectData]);\n```\n\n### Canvas Rendering Layers\nV13 has reorganized canvas layers. Use the correct layer references:\n- `canvas.tokens` - TokenLayer\n- `canvas.tiles` - TilesLayer\n- `canvas.lighting` - LightingLayer\n- `canvas.grid` - GridLayer\n\n### Dialog API Updates\nDialog construction now prefers Application V2 patterns in some contexts, but classic Dialogs still work:\n\n```javascript\nnew Dialog({\n  title: game.i18n.localize(\"MYMODULE.Dialog.Title\"),\n  content: `<p>${game.i18n.localize(\"MYMODULE.Dialog.Content\")}</p>`,\n  buttons: {\n    yes: {\n      icon: '<i class=\"fas fa-check\"></i>',\n      label: game.i18n.localize(\"MYMODULE.Dialog.Confirm\"),\n      callback: () => { /* action */ }\n    },\n    no: {\n      icon: '<i class=\"fas fa-times\"></i>',\n      label: game.i18n.localize(\"MYMODULE.Dialog.Cancel\")\n    }\n  },\n  default: \"yes\"\n}).render(true);\n```\n\n## Data Field Types Reference\n\nWhen defining DataModel schemas, use these field types from `foundry.data.fields`:\n\n- `StringField` - Text data\n- `NumberField` - Numeric values (integers or floats)\n- `BooleanField` - True/false values\n- `ObjectField` - Nested objects\n- `ArrayField` - Arrays of values\n- `SchemaField` - Nested DataModel schema\n- `HTMLField` - Sanitized HTML content\n- `FilePathField` - File paths (images, sounds, etc.)\n- `ColorField` - Color values (hex strings)\n- `AngleField` - Angles in degrees\n- `AlphaField` - Alpha transparency (0-1)\n\n## Best Practices\n\n1. **Always await async operations** - Most Foundry operations are async\n2. **Check for user permissions** - Use `game.user.isGM` or document permission checks\n3. **Use `fromUuidSync()` or `fromUuid()`** - For reliable document references\n4. **Leverage Hooks** - Don't override core behavior, extend it via hooks\n5. **Handle errors gracefully** - Wrap operations in try/catch and show user-friendly messages\n6. **Test with multiple users** - Permission and rendering issues often appear in multi-user scenarios\n7. **Follow Foundry's module conventions** - Use proper manifest structure, versioning, and compatibility flags\n\n## Manifest Requirements\n\nYour `module.json` or `system.json` must declare V13 compatibility:\n\n```json\n{\n  \"id\": \"my-module\",\n  \"title\": \"My Module\",\n  \"version\": \"1.0.0\",\n  \"compatibility\": {\n    \"minimum\": \"13\",\n    \"verified\": \"13\",\n    \"maximum\": \"13\"\n  },\n  \"esmodules\": [\"scripts/init.js\"],\n  \"languages\": [\n    {\n      \"lang\": \"en\",\n      \"name\": \"English\",\n      \"path\": \"lang/en.json\"\n    }\n  ]\n}\n```\n\n## Development Workflow\n\n1. Enable \"Developer Mode\" in Foundry settings for better error messages\n2. Use browser DevTools Console for debugging\n3. Use `console.log()` liberally, or set up proper logging with `CONFIG.debug`\n4. Test in a fresh world to avoid conflicts with other modules\n5. Use `CONFIG.debug.hooks = true` to see all hook executions\n\nRemember: When in doubt, check the official Foundry VTT V13 API documentation at https://foundryvtt.com/api/\n\n## Implementation Checklist\n\n### Module Structure\n- [ ] Manifest declares `\"esmodules\"` (not `\"scripts\"`)\n- [ ] All imports use ESM syntax with `.js` extensions\n- [ ] Compatibility set to minimum V13\n\n### Data Patterns\n- [ ] DataModel classes define schemas with `defineSchema()`\n- [ ] Access system data via `document.system` (not `data.data`)\n- [ ] Active Effects use correct change structure\n\n### Code Quality\n- [ ] All user-facing strings use `game.i18n.localize()`\n- [ ] Hook callbacks use V13 argument signatures\n- [ ] Async operations are properly awaited\n- [ ] Permissions checked before privileged operations\n\n### Testing\n- [ ] Module loads without console errors\n- [ ] DataModel validation works correctly\n- [ ] Hooks fire with expected arguments\n- [ ] Multi-user scenarios tested\n\n## References\n\n- [Foundry VTT V13 API](https://foundryvtt.com/api/)\n- [DataModel API](https://foundryvtt.com/api/classes/foundry.abstract.DataModel.html)\n- [Migration Guide](https://foundryvtt.wiki/en/development/guides/v13-migration)\n- [ESM in Foundry](https://foundryvtt.wiki/en/development/guides/esm)\n\n---\n\n**Last Updated:** 2026-01-05\n**Status:** Production-Ready\n**Maintainer:** ImproperSubset\n",
        "fvtt-dev/skills/fvtt-version-compat/SKILL.md": "---\nname: fvtt-version-compat\ndescription: This skill should be used when importing Foundry classes, registering sheets, loading templates, enriching HTML, or using any Foundry API that has moved to namespaces. Covers compat wrappers, deferred sheet registration, and the modern-first fallback pattern.\n---\n\n# Foundry VTT Version Compatibility (V12/V13/V15+)\n\nUse compatibility wrappers to avoid deprecation warnings when APIs move from globals to namespaces across Foundry versions.\n\n## When to Use This Skill\n\nInvoke this skill when:\n\n### âœ… Use Compat Wrappers For:\n\n- **Importing Foundry classes** - ActorSheet, ItemSheet, TextEditor\n- **Registering sheets** - Actor sheets, item sheets, document sheets\n- **Loading templates** - Handlebars template loading\n- **Enriching HTML** - TextEditor.enrichHTML for journal content\n- **Generating IDs** - randomID() for unique identifiers\n- **Any Foundry API** - That has moved or will move to namespaces\n\n### âŒ Don't Use Compat Wrappers For:\n\n- **Stable globals** - `game`, `ui`, `CONFIG`, `Hooks`\n- **Project-specific code** - Your own classes and functions\n- **One-off migrations** - If only targeting a single Foundry version\n- **Styling/layout** - CSS and templates (not API drift)\n\n## The Problem: API Migration Across Versions\n\n### What Changed Across Foundry Versions\n\n**Foundry V11/V12 (Legacy):**\n```javascript\n// APIs available as globals\nActorSheet\nItemSheet\nTextEditor.enrichHTML()\nloadTemplates()\nrenderTemplate()\nrandomID()\nActors.registerSheet()\n```\n\n**Foundry V13+ (Namespaced):**\n```javascript\n// APIs moved to namespaces\nfoundry.appv1.sheets.ActorSheet\nfoundry.appv1.sheets.ItemSheet\nfoundry.applications.ux.TextEditor.implementation.enrichHTML()\nfoundry.applications.handlebars.loadTemplates()\nfoundry.applications.handlebars.renderTemplate()\nfoundry.utils.randomID()\nfoundry.applications.api.DocumentSheetConfig.registerSheet()\n```\n\n**Foundry V15+ (Legacy Removed):**\n```\nGlobals will be REMOVED entirely\n  â†“\nDirect global access will break\n  â†“\nMust use namespaced APIs only\n```\n\n### Why This Breaks Code\n\n```javascript\n// âŒ This worked in V11/V12, will BREAK in V15+\nimport { ActorSheet } from \"somewhere\";  // No longer a global!\n\nclass MySheet extends ActorSheet {\n  // ...\n}\n\n// âŒ This throws deprecation warnings in V13\nTextEditor.enrichHTML(content, options);\n\n// âŒ This will stop working in V15\nActors.registerSheet(\"my-module\", MySheet, { makeDefault: true });\n```\n\n## Solution: Compatibility Wrappers\n\n### Three Core Patterns\n\n1. **Try modern first, fallback to legacy** - Nullish coalescing (`??`)\n2. **Cache resolved classes** - Avoid repeated lookups\n3. **Throw clear errors** - Don't silently fail if neither exists\n\n## Step-by-Step Implementation\n\n### Step 1: Create Compatibility Module\n\n**File:** `scripts/compat.js`\n\n```javascript\n/**\n * Compatibility helpers for Foundry V12/V13/V15+\n * Prefer modern namespaced APIs, fallback to legacy globals\n */\n\n/**\n * Get ActorSheet class (modern or legacy)\n * @returns {class} ActorSheet constructor\n */\nexport function getActorSheetClass() {\n  // Try V13+ namespace first\n  const modern = foundry?.appv1?.sheets?.ActorSheet;\n  if (modern) return modern;\n\n  // Fallback to V11/V12 global\n  if (typeof ActorSheet !== 'undefined') return ActorSheet;\n\n  throw new Error(\"Unable to resolve ActorSheet class\");\n}\n\n/**\n * Get ItemSheet class (modern or legacy)\n * @returns {class} ItemSheet constructor\n */\nexport function getItemSheetClass() {\n  return foundry?.appv1?.sheets?.ItemSheet ?? ItemSheet;\n}\n\n/**\n * Enrich HTML content (journal entries, descriptions)\n * @param {string} content - Raw HTML/markdown content\n * @param {object} options - Enrichment options\n * @returns {Promise<string>} Enriched HTML\n */\nexport function enrichHTML(content, options = {}) {\n  // Try V13+ namespace\n  const textEditor = foundry?.applications?.ux?.TextEditor?.implementation;\n\n  if (textEditor?.enrichHTML) {\n    return textEditor.enrichHTML(content, options);\n  }\n\n  // Fallback to V11/V12 global\n  if (typeof TextEditor !== 'undefined' && TextEditor.enrichHTML) {\n    return TextEditor.enrichHTML(content, options);\n  }\n\n  throw new Error(\"Unable to resolve TextEditor.enrichHTML\");\n}\n\n/**\n * Generate random ID\n * @returns {string} Random ID\n */\nexport function generateRandomId() {\n  const randomIdFn = foundry?.utils?.randomID ?? randomID;\n\n  if (!randomIdFn) {\n    throw new Error(\"Unable to resolve randomID generator\");\n  }\n\n  return randomIdFn();\n}\n```\n\n**Pattern:**\n```javascript\n// Template for adding new compat functions\nexport function getAPIClass() {\n  // 1. Try modern namespace\n  const modern = foundry?.path?.to?.API;\n  if (modern) return modern;\n\n  // 2. Fallback to legacy global\n  if (typeof LegacyGlobal !== 'undefined') return LegacyGlobal;\n\n  // 3. Throw clear error\n  throw new Error(\"Unable to resolve API\");\n}\n```\n\n### Step 2: Sheet Registration Compatibility\n\n**File:** `scripts/compat-helpers.js`\n\n```javascript\nimport { getActorSheetClass, getItemSheetClass } from \"./compat.js\";\n\n// Cache DocumentSheetConfig to avoid repeated lookups\nlet cachedSheetConfig;\n\n/**\n * Get DocumentSheetConfig (modern V13+) or null\n * @returns {object|null}\n */\nfunction getSheetConfig() {\n  if (cachedSheetConfig) return cachedSheetConfig;\n\n  // Try multiple V13+ namespace locations\n  const apiConfig =\n    foundry?.applications?.apps?.DocumentSheetConfig ??\n    foundry?.applications?.config?.DocumentSheetConfig ??\n    foundry?.applications?.api?.DocumentSheetConfig;\n\n  cachedSheetConfig = apiConfig ?? null;\n  return cachedSheetConfig;\n}\n\n/**\n * Get legacy Actors collection (V11/V12)\n * @returns {object}\n */\nfunction getActorsCollectionLegacy() {\n  return foundry?.documents?.collections?.Actors ?? Actors;\n}\n\n/**\n * Get legacy Items collection (V11/V12)\n * @returns {object}\n */\nfunction getItemsCollectionLegacy() {\n  return foundry?.documents?.collections?.Items ?? Items;\n}\n\n/**\n * Register actor sheet (compatible across versions)\n * @param {string} namespace - Module ID\n * @param {class} sheetClass - Sheet constructor\n * @param {object} options - Registration options\n */\nexport function registerActorSheet(namespace, sheetClass, options = {}) {\n  const sheetConfig = getSheetConfig();\n\n  // Try V13+ API\n  if (sheetConfig?.registerSheet) {\n    return sheetConfig.registerSheet(\n      CONFIG.Actor.documentClass,\n      namespace,\n      sheetClass,\n      options\n    );\n  }\n\n  // Fallback to V11/V12 API\n  return getActorsCollectionLegacy()?.registerSheet?.(\n    namespace,\n    sheetClass,\n    options\n  );\n}\n\n/**\n * Unregister actor sheet (compatible across versions)\n */\nexport function unregisterActorSheet(namespace, sheetClass) {\n  const sheetConfig = getSheetConfig();\n\n  if (sheetConfig?.unregisterSheet) {\n    return sheetConfig.unregisterSheet(\n      CONFIG.Actor.documentClass,\n      namespace,\n      sheetClass\n    );\n  }\n\n  return getActorsCollectionLegacy()?.unregisterSheet?.(namespace, sheetClass);\n}\n\n/**\n * Register item sheet (compatible across versions)\n */\nexport function registerItemSheet(namespace, sheetClass, options = {}) {\n  const sheetConfig = getSheetConfig();\n\n  if (sheetConfig?.registerSheet) {\n    return sheetConfig.registerSheet(\n      CONFIG.Item.documentClass,\n      namespace,\n      sheetClass,\n      options\n    );\n  }\n\n  return getItemsCollectionLegacy()?.registerSheet?.(\n    namespace,\n    sheetClass,\n    options\n  );\n}\n\n/**\n * Unregister item sheet (compatible across versions)\n */\nexport function unregisterItemSheet(namespace, sheetClass) {\n  const sheetConfig = getSheetConfig();\n\n  if (sheetConfig?.unregisterSheet) {\n    return sheetConfig.unregisterSheet(\n      CONFIG.Item.documentClass,\n      namespace,\n      sheetClass\n    );\n  }\n\n  return getItemsCollectionLegacy()?.unregisterSheet?.(namespace, sheetClass);\n}\n```\n\n### Step 3: Template Loading Compatibility\n\n```javascript\n/**\n * Load Handlebars templates (compatible across versions)\n * @param {Array<string>} paths - Template paths\n * @returns {Promise}\n */\nexport function loadHandlebarsTemplates(paths) {\n  // Try V13+ namespace\n  const loader = foundry?.applications?.handlebars?.loadTemplates;\n\n  if (loader) {\n    return loader(paths);\n  }\n\n  // Fallback to V11/V12 global\n  if (typeof loadTemplates !== 'undefined') {\n    return loadTemplates(paths);\n  }\n\n  throw new Error(\"Unable to resolve Handlebars template loader\");\n}\n\n/**\n * Render Handlebars template (compatible across versions)\n * @param {string} path - Template path\n * @param {object} data - Template data\n * @returns {Promise<string>}\n */\nexport function renderHandlebarsTemplate(path, data) {\n  // Try V13+ namespace\n  const renderer = foundry?.applications?.handlebars?.renderTemplate;\n\n  if (renderer) {\n    return renderer(path, data);\n  }\n\n  // Fallback to V11/V12 global\n  if (typeof renderTemplate !== 'undefined') {\n    return renderTemplate(path, data);\n  }\n\n  throw new Error(\"Unable to resolve Handlebars template renderer\");\n}\n```\n\n### Step 4: Use Compat Wrappers in Your Code\n\n**File:** `scripts/module.js` (Entry point)\n\n```javascript\nimport { registerActorSheet, registerItemSheet } from \"./compat-helpers.js\";\nimport { loadHandlebarsTemplates } from \"./compat-helpers.js\";\nimport { BladesAlternateActorSheet } from \"./blades-alternate-actor-sheet.js\";\nimport { BladesAlternateItemSheet } from \"./blades-alternate-item-sheet.js\";\n\nconst MODULE_ID = \"my-module\";\n\nHooks.once(\"init\", async function() {\n  console.log(\"My Module | Initializing\");\n\n  // Load templates (compat)\n  await loadHandlebarsTemplates([\n    \"modules/my-module/templates/actor-sheet.html\",\n    \"modules/my-module/templates/item-sheet.html\",\n  ]);\n});\n\nHooks.once(\"ready\", async function() {\n  // Register sheets (compat)\n  // Why ready hook? V13+ requires DocumentSheetConfig to be available\n  // which isn't ready during init\n\n  registerActorSheet(\n    MODULE_ID,\n    BladesAlternateActorSheet,\n    {\n      types: [\"character\"],\n      makeDefault: true,\n      label: \"Alternate Character Sheet\"\n    }\n  );\n\n  registerItemSheet(\n    MODULE_ID,\n    BladesAlternateItemSheet,\n    {\n      types: [\"item\"],\n      makeDefault: false,\n      label: \"Alternate Item Sheet\"\n    }\n  );\n});\n```\n\n**File:** `scripts/blades-alternate-actor-sheet.js`\n\n```javascript\nimport { getActorSheetClass } from \"./compat.js\";\nimport { enrichHTML } from \"./compat.js\";\n\n// Get base class via compat wrapper\nconst ActorSheet = getActorSheetClass();\n\nexport class BladesAlternateActorSheet extends ActorSheet {\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: [\"bitd-alt\", \"sheet\", \"actor\"],\n      template: \"modules/my-module/templates/actor-sheet.html\",\n      width: 900,\n      height: 800,\n    });\n  }\n\n  async getData() {\n    const data = await super.getData();\n\n    // Enrich description (compat)\n    if (data.actor.system.description) {\n      data.enrichedDescription = await enrichHTML(\n        data.actor.system.description,\n        { secrets: data.editable }\n      );\n    }\n\n    return data;\n  }\n}\n```\n\n## Compatibility Patterns\n\n### Pattern 1: Simple Class Resolution\n\n```javascript\n// Get class, throw if not found\nexport function getAPIClass() {\n  const api = foundry?.new?.path?.API ?? LegacyGlobalAPI;\n\n  if (!api) {\n    throw new Error(\"Unable to resolve API\");\n  }\n\n  return api;\n}\n```\n\n### Pattern 2: Cached Resolution\n\n```javascript\n// Cache expensive lookups\nlet cachedConfig;\n\nfunction getConfig() {\n  if (cachedConfig) return cachedConfig;\n\n  const config =\n    foundry?.new?.path?.Config ??\n    foundry?.another?.path?.Config ??\n    LegacyConfig;\n\n  cachedConfig = config ?? null;\n  return cachedConfig;\n}\n```\n\n### Pattern 3: Method Delegation\n\n```javascript\n// Wrap methods that moved\nexport function someMethod(...args) {\n  const api = foundry?.new?.path?.API?.implementation;\n\n  if (api?.someMethod) {\n    return api.someMethod(...args);\n  }\n\n  if (typeof LegacyAPI !== 'undefined' && LegacyAPI.someMethod) {\n    return LegacyAPI.someMethod(...args);\n  }\n\n  throw new Error(\"Unable to resolve someMethod\");\n}\n```\n\n### Pattern 4: Optional Chaining for Safety\n\n```javascript\n// Use ?. to safely traverse nested paths\nexport function getDeepAPI() {\n  return (\n    foundry?.level1?.level2?.level3?.API ??\n    OldGlobal?.level1?.API ??\n    LegacyAPI\n  );\n}\n```\n\n## Why Defer Sheet Registration to `ready` Hook?\n\n### The Problem\n\n```javascript\n// âŒ BAD: Registering in init hook\nHooks.once(\"init\", function() {\n  registerActorSheet(MODULE_ID, MySheet, { ... });\n});\n\n// Result in V13+:\n// Error: DocumentSheetConfig is not available yet!\n```\n\n### The Solution\n\n```javascript\n// âœ… GOOD: Register in ready hook\nHooks.once(\"ready\", function() {\n  registerActorSheet(MODULE_ID, MySheet, { ... });\n});\n```\n\n**Why?**\n- V11/V12: Sheet registration works in `init` hook (globals available)\n- V13+: `DocumentSheetConfig` isn't initialized until after `init`\n- V15+: Legacy globals won't exist, must use `DocumentSheetConfig`\n\n**Solution:** Always register sheets in `ready` hook for V13+ compatibility\n\n## Common Use Cases\n\n### Use Case 1: Extend Base Sheet Class\n\n```javascript\nimport { getActorSheetClass } from \"./compat.js\";\n\nconst ActorSheet = getActorSheetClass();\n\nexport class MyActorSheet extends ActorSheet {\n  // No deprecation warnings!\n}\n```\n\n### Use Case 2: Enrich Journal Content\n\n```javascript\nimport { enrichHTML } from \"./compat.js\";\n\nasync function displayJournalEntry(content) {\n  const enriched = await enrichHTML(content, {\n    secrets: game.user.isGM,\n    documents: true,\n    links: true,\n  });\n\n  return enriched;\n}\n```\n\n### Use Case 3: Load Templates on Init\n\n```javascript\nimport { loadHandlebarsTemplates } from \"./compat-helpers.js\";\n\nHooks.once(\"init\", async function() {\n  await loadHandlebarsTemplates([\n    \"modules/my-module/templates/actor-sheet.html\",\n    \"modules/my-module/templates/parts/abilities.html\",\n    \"modules/my-module/templates/parts/items.html\",\n  ]);\n});\n```\n\n### Use Case 4: Generate Unique IDs\n\n```javascript\nimport { generateRandomId } from \"./compat.js\";\n\nfunction createNewItem() {\n  const item = {\n    _id: generateRandomId(),\n    name: \"New Item\",\n    type: \"item\",\n  };\n\n  return item;\n}\n```\n\n## Adding New Compat Functions\n\n### Recipe for New API\n\n1. **Identify the move**\n   - V11/V12 global: `OldAPI`\n   - V13+ namespace: `foundry.new.path.NewAPI`\n\n2. **Add compat function**\n   ```javascript\n   export function getNewAPI() {\n     return foundry?.new?.path?.NewAPI ?? OldAPI;\n   }\n   ```\n\n3. **Update imports**\n   ```javascript\n   // Before\n   import { OldAPI } from \"somewhere\";\n\n   // After\n   import { getNewAPI } from \"./compat.js\";\n   const OldAPI = getNewAPI();\n   ```\n\n4. **Test across versions**\n   - V11: Should use legacy global\n   - V13: Should use modern namespace\n   - No deprecation warnings in either\n\n## API Migration Checklist\n\nCommon APIs that have moved or will move:\n\n- [ ] `ActorSheet` â†’ `foundry.appv1.sheets.ActorSheet`\n- [ ] `ItemSheet` â†’ `foundry.appv1.sheets.ItemSheet`\n- [ ] `TextEditor.enrichHTML` â†’ `foundry.applications.ux.TextEditor.implementation.enrichHTML`\n- [ ] `loadTemplates` â†’ `foundry.applications.handlebars.loadTemplates`\n- [ ] `renderTemplate` â†’ `foundry.applications.handlebars.renderTemplate`\n- [ ] `randomID` â†’ `foundry.utils.randomID`\n- [ ] `Actors.registerSheet` â†’ `DocumentSheetConfig.registerSheet`\n- [ ] `Items.registerSheet` â†’ `DocumentSheetConfig.registerSheet`\n- [ ] `Dialog` â†’ `DialogV2` (see dialog-compat skill)\n\n## Testing Across Versions\n\n### Manual Testing\n\n```\n1. Test in Foundry V11 (if supporting)\n   - Check console for errors\n   - Verify sheets register correctly\n   - Confirm templates load\n\n2. Test in Foundry V12\n   - Same checks as V11\n   - Look for deprecation warnings\n\n3. Test in Foundry V13+\n   - No deprecation warnings\n   - All features work\n   - Modern APIs used (check network/console)\n```\n\n### Console Verification\n\n```javascript\n// In browser console, verify which API is being used\n\n// V11/V12 - Should use globals\nconsole.log(typeof ActorSheet !== 'undefined');  // true\n\n// V13+ - Should use namespaces\nconsole.log(foundry?.appv1?.sheets?.ActorSheet);  // class ActorSheet\n```\n\n## Common Pitfalls\n\n### âŒ Pitfall 1: Using Globals Directly\n\n```javascript\n// BAD: Will throw deprecation warnings in V13, break in V15\nclass MySheet extends ActorSheet {\n  // ...\n}\n```\n\n**Fix:** Use compat wrapper\n\n```javascript\n// GOOD\nimport { getActorSheetClass } from \"./compat.js\";\nconst ActorSheet = getActorSheetClass();\n\nclass MySheet extends ActorSheet {\n  // ...\n}\n```\n\n### âŒ Pitfall 2: Registering Sheets in Init Hook\n\n```javascript\n// BAD: Breaks in V13+\nHooks.once(\"init\", function() {\n  Actors.registerSheet(MODULE_ID, MySheet, { ... });\n});\n```\n\n**Fix:** Use ready hook + compat wrapper\n\n```javascript\n// GOOD\nimport { registerActorSheet } from \"./compat-helpers.js\";\n\nHooks.once(\"ready\", function() {\n  registerActorSheet(MODULE_ID, MySheet, { ... });\n});\n```\n\n### âŒ Pitfall 3: Not Handling Multiple Namespace Locations\n\n```javascript\n// BAD: Assumes single namespace location\nexport function getConfig() {\n  return foundry?.applications?.api?.Config ?? LegacyConfig;\n}\n\n// Problem: Config might be in different namespace!\n```\n\n**Fix:** Check multiple locations\n\n```javascript\n// GOOD\nexport function getConfig() {\n  return (\n    foundry?.applications?.api?.Config ??\n    foundry?.applications?.apps?.Config ??\n    foundry?.applications?.config?.Config ??\n    LegacyConfig\n  );\n}\n```\n\n### âŒ Pitfall 4: Silent Fallback Failures\n\n```javascript\n// BAD: Returns undefined if both fail\nexport function getAPI() {\n  return foundry?.new?.API ?? OldAPI;\n}\n\n// Calling code will crash with cryptic error later\n```\n\n**Fix:** Throw clear error\n\n```javascript\n// GOOD\nexport function getAPI() {\n  const api = foundry?.new?.API ?? OldAPI;\n\n  if (!api) {\n    throw new Error(\"Unable to resolve API - unsupported Foundry version?\");\n  }\n\n  return api;\n}\n```\n\n## Quick Checklist\n\nBefore using Foundry APIs:\n\n- [ ] Identified if API has moved to namespace\n- [ ] Created compat wrapper function\n- [ ] Used compat wrapper instead of direct global\n- [ ] Moved sheet registration to `ready` hook\n- [ ] Cached expensive lookups (configs, classes)\n- [ ] Threw clear errors if API not found\n- [ ] Tested in V12 and V13+ (if targeting both)\n- [ ] No deprecation warnings in console\n\n## References\n\n- Implementation: `scripts/compat.js` - Core compatibility wrappers\n- Helpers: `scripts/compat-helpers.js` - Sheet registration, template loading\n- Guide: `docs/compat-helpers-guide.md` - Usage examples\n- Foundry API Docs: [Application V1 Migration](https://foundryvtt.com/article/v11-api-migration/)\n\nFor BitD Alternate Sheets:\n- All sheet classes extend via `getActorSheetClass()` / `getItemSheetClass()`\n- Sheet registration happens in `ready` hook via `registerActorSheet()`\n- Template loading uses `loadHandlebarsTemplates()` in `init` hook\n- HTML enrichment uses `enrichHTML()` wrapper\n- Supports Foundry V12 minimum, tested through V13\n- Prepared for V15+ when legacy globals are removed\n"
      },
      "plugins": [
        {
          "name": "cc-governance",
          "description": "Reusable governance skills and hooks for AI code assistants: delegation policies, development workflows, documentation management, git branching, plugin extensions, and automatic skill activation",
          "version": "1.2.4",
          "author": {
            "name": "ImproperSubset",
            "email": "impropersubset@users.noreply.github.com"
          },
          "source": "./cc-governance",
          "category": "productivity",
          "homepage": "https://github.com/ImproperSubset/hh-agentics",
          "repository": "https://github.com/ImproperSubset/hh-agentics",
          "license": "MIT",
          "keywords": [
            "governance",
            "workflow",
            "documentation",
            "git",
            "best-practices"
          ],
          "categories": [
            "best-practices",
            "documentation",
            "git",
            "governance",
            "productivity",
            "workflow"
          ],
          "install_commands": [
            "/plugin marketplace add ImproperSubset/hh-agentics",
            "/plugin install cc-governance@hh-agentics"
          ]
        },
        {
          "name": "fvtt-dev",
          "description": "Comprehensive skills for Foundry VTT module development: V13 migration, multi-client safety, version compatibility, data migrations, error handling, hooks, data storage, sheets, dice rolling, sockets, active effects, canvas, localization, compendiums, combat, chat messages, and applications",
          "version": "1.10.0",
          "author": {
            "name": "ImproperSubset",
            "email": "impropersubset@users.noreply.github.com"
          },
          "source": "./fvtt-dev",
          "category": "development",
          "homepage": "https://github.com/ImproperSubset/hh-agentics",
          "repository": "https://github.com/ImproperSubset/hh-agentics",
          "license": "MIT",
          "keywords": [
            "foundry-vtt",
            "fvtt",
            "module-development",
            "v13",
            "game-system"
          ],
          "categories": [
            "development",
            "foundry-vtt",
            "fvtt",
            "game-system",
            "module-development",
            "v13"
          ],
          "install_commands": [
            "/plugin marketplace add ImproperSubset/hh-agentics",
            "/plugin install fvtt-dev@hh-agentics"
          ]
        }
      ]
    }
  ]
}