{
  "author": {
    "id": "gruckion",
    "display_name": "Stephen Rayner",
    "avatar_url": "https://avatars.githubusercontent.com/u/4559650?u=25e53ef4693e82a6ff47662787b1fd3735557cfb&v=4"
  },
  "marketplaces": [
    {
      "name": "cwd-tracker-marketplace",
      "version": null,
      "description": "CWD Tracker plugin for Claude Code",
      "repo_full_name": "gruckion/claude-code-cwd-tracker",
      "repo_url": "https://github.com/gruckion/claude-code-cwd-tracker",
      "repo_description": "Claude Code plugin that fixes the working directory tracking bug after cd commands",
      "signals": {
        "stars": 0,
        "forks": 0,
        "pushed_at": "2026-01-21T15:22:28Z"
      },
      "files": {
        ".claude-plugin/marketplace.json": "{\n  \"name\": \"cwd-tracker-marketplace\",\n  \"owner\": {\n    \"name\": \"gruckion\"\n  },\n  \"metadata\": {\n    \"description\": \"CWD Tracker plugin for Claude Code\",\n    \"version\": \"1.0.0\",\n    \"pluginRoot\": \"..\"\n  },\n  \"plugins\": [\n    {\n      \"name\": \"cwd-tracker\",\n      \"description\": \"Fixes the working directory tracking bug by notifying Claude when CWD changes\",\n      \"version\": \"1.0.0\",\n      \"author\": {\n        \"name\": \"gruckion\"\n      },\n      \"source\": \".\",\n      \"category\": \"bug-fixes\",\n      \"tags\": [\n        \"cwd\",\n        \"working-directory\",\n        \"bash\",\n        \"hooks\"\n      ],\n      \"keywords\": [\n        \"cwd\",\n        \"bash\",\n        \"hooks\",\n        \"bug-fix\",\n        \"working-directory\"\n      ]\n    }\n  ]\n}\n",
        ".claude-plugin/plugin.json": "{\n  \"name\": \"cwd-tracker\",\n  \"version\": \"1.0.0\",\n  \"description\": \"Fixes the working directory tracking bug in Claude Code by notifying Claude when the CWD changes after cd commands\",\n  \"author\": {\n    \"name\": \"gruckion\",\n    \"url\": \"https://github.com/gruckion\"\n  },\n  \"homepage\": \"https://github.com/gruckion/claude-code-cwd-tracker\",\n  \"repository\": \"https://github.com/gruckion/claude-code-cwd-tracker\",\n  \"license\": \"MIT\",\n  \"keywords\": [\"cwd\", \"working-directory\", \"bash\", \"hooks\", \"bug-fix\"]\n}\n",
        "README.md": "# Claude Code CWD Tracker\n\nA Claude Code plugin that fixes the working directory tracking bug. When Claude runs `cd` commands, it loses track of where it is—this hook tells it.\n\n## The Problem\n\nWhen Claude Code runs a Bash command containing `cd` (e.g., `mkdir -p foo && cd foo && npm pack`), the shell's working directory changes, but **Claude is never informed**. The system prompt's `<env>Working directory: X</env>` is static—set at session start and never updated.\n\nThis causes Claude to:\n- Construct wrong absolute paths in subsequent tool calls\n- Try to `cd` into directories it's already in\n- Use Search/Grep tools with non-existent paths\n\n**This bug has been reported 24+ times** in GitHub issues [#1669](https://github.com/anthropics/claude-code/issues/1669), [#4100](https://github.com/anthropics/claude-code/issues/4100), [#11067](https://github.com/anthropics/claude-code/issues/11067), [#14122](https://github.com/anthropics/claude-code/issues/14122), and others.\n\n### Example of the Bug\n\n```\nYou: \"Download the package and extract it\"\n\nClaude runs: mkdir -p myproject && cd myproject && npm pack @some/package\n✓ Works fine - Claude is now IN myproject/\n\nClaude runs: cd myproject && tar -xzf package.tgz\n✗ ERROR: \"no such file or directory: myproject\"\n  (Claude tried to cd into a directory it's already in)\n\nClaude runs: ls /original/path/package.tgz\n✗ ERROR: file not found\n  (File is actually at /original/path/myproject/package.tgz)\n```\n\n## The Solution\n\nThis plugin uses Claude Code's **hook system** to detect when the working directory changes and notify Claude via the tool output. Claude then knows exactly where it is and constructs correct paths.\n\n### How It Works\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│  Claude runs: mkdir -p foo && cd foo && touch file.txt         │\n└─────────────────────────────────────────────────────────────────┘\n                              │\n                              ▼\n┌─────────────────────────────────────────────────────────────────┐\n│  PostToolUse hook fires after Bash command completes            │\n│  Hook receives JSON with current cwd from Claude Code           │\n└─────────────────────────────────────────────────────────────────┘\n                              │\n                              ▼\n┌─────────────────────────────────────────────────────────────────┐\n│  Hook compares current cwd against stored previous cwd          │\n│  Previous: /home/user/project                                   │\n│  Current:  /home/user/project/foo                               │\n└─────────────────────────────────────────────────────────────────┘\n                              │\n                              ▼\n┌─────────────────────────────────────────────────────────────────┐\n│  CWD changed! Hook outputs to stderr + exits with code 2        │\n│  \"Note: Working directory changed from '...' to '...'\"          │\n└─────────────────────────────────────────────────────────────────┘\n                              │\n                              ▼\n┌─────────────────────────────────────────────────────────────────┐\n│  Claude receives notification in tool result                    │\n│  Claude now knows it's in /home/user/project/foo                │\n│  Subsequent commands use correct paths                          │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n**Key insight**: Claude Code's hook system feeds `stderr` + exit code 2 back to the LLM. Exit code 0 with stdout is only shown in the transcript (invisible to Claude).\n\n## Tech Stack\n\n- **Language**: Bash\n- **Dependencies**: Python 3 (for JSON parsing)\n- **Claude Code Version**: 2.x+ (requires hook support)\n- **Platform**: macOS, Linux (anywhere Bash runs)\n\n## Prerequisites\n\n- Claude Code CLI installed\n- Python 3 (usually pre-installed on macOS/Linux)\n- Bash shell\n\n## Installation\n\n### Option 1: Plugin Marketplace (Recommended)\n\nThe easiest way to install is via Claude Code's plugin system:\n\n```bash\n# Add the marketplace\n/plugin marketplace add gruckion/claude-code-cwd-tracker\n\n# Install the plugin\n/plugin install cwd-tracker\n```\n\nThat's it! The plugin is now active. On session start, you'll see:\n```\n✓ CWD Tracker loaded: Working directory changes will be tracked\n```\n\n### Option 2: Manual Installation\n\nIf you prefer manual installation:\n\n#### 1. Create the hooks directory\n\n```bash\nmkdir -p ~/.claude/hooks\n```\n\n#### 2. Download the hook script\n\n```bash\ncurl -o ~/.claude/hooks/cwd-notify.sh \\\n  https://raw.githubusercontent.com/gruckion/claude-code-cwd-tracker/main/scripts/cwd-notify.sh\n```\n\nOr clone the repository:\n\n```bash\ngit clone https://github.com/gruckion/claude-code-cwd-tracker.git\ncp claude-code-cwd-tracker/scripts/cwd-notify.sh ~/.claude/hooks/\n```\n\n#### 3. Make it executable\n\n```bash\nchmod +x ~/.claude/hooks/cwd-notify.sh\n```\n\n#### 4. Configure Claude Code\n\nAdd the hook to your `~/.claude/settings.json`:\n\n```json\n{\n  \"hooks\": {\n    \"PostToolUse\": [\n      {\n        \"matcher\": \"Bash\",\n        \"hooks\": [\n          {\n            \"type\": \"command\",\n            \"command\": \"~/.claude/hooks/cwd-notify.sh\"\n          }\n        ]\n      }\n    ]\n  }\n}\n```\n\nIf you already have a `settings.json`, merge the hooks section with your existing configuration.\n\n#### 5. Restart Claude Code\n\nThe hook takes effect on new sessions.\n\n## Commands\n\nWhen installed as a plugin, you get these slash commands:\n\n### `/cwd-tracker:verify`\n\nTest if CWD tracking is working correctly. Runs an automated verification sequence.\n\n```\n> /cwd-tracker:verify\n\n✓ CWD tracking is working correctly\n```\n\n### `/cwd-tracker:status`\n\nShow current CWD tracking state and diagnostics.\n\n```\n> /cwd-tracker:status\n\n=== CWD Tracker Status ===\nState file: /tmp/claude-cwd-state\nLast tracked CWD: /Users/you/project/subdir\nCurrent CWD: /Users/you/project/subdir\n```\n\n## Verification\n\n### Testing the Fix\n\nRun this sequence to verify the hook is working:\n\n```bash\n# 1. Clear any existing state\nrm -f /tmp/claude-cwd-state\n\n# 2. Start a new Claude Code session and ask Claude to run:\nmkdir -p testdir && cd testdir && touch marker.txt\n```\n\n**Expected if FIXED:**\n- You see a notification: `Note: Working directory changed from '/your/path' to '/your/path/testdir'`\n- Claude knows it's in `testdir`\n- Running `ls marker.txt` works\n- Running `cd testdir` fails with \"no such file or directory\" (Claude understands why)\n\n**Expected if BROKEN:**\n- No notification after the command\n- Claude thinks it's still in the parent directory\n- Claude might try `cd testdir && ls marker.txt` unnecessarily\n- Claude uses wrong absolute paths\n\n### Checking Hook Status\n\nAfter any Bash command, you should see in the Claude Code output:\n```\nPostToolUse:Bash hook succeeded\n```\n\nIf the working directory changed, you'll also see the notification in the tool result.\n\n## Architecture\n\n### Plugin Structure\n\n```\nclaude-code-cwd-tracker/\n├── .claude-plugin/\n│   ├── plugin.json        # Plugin metadata\n│   └── marketplace.json   # Marketplace registration\n├── hooks/\n│   └── hooks.json         # Hook configuration\n├── scripts/\n│   └── cwd-notify.sh      # The hook script\n├── commands/\n│   ├── verify.md          # /cwd-tracker:verify command\n│   └── status.md          # /cwd-tracker:status command\n├── README.md\n└── LICENSE\n```\n\n### Runtime Files\n\n```\n/tmp/\n└── claude-cwd-state       # Stores last known cwd (auto-created)\n```\n\n### Hook Script Flow\n\n```bash\n┌──────────────────────────────────────────────────────────────┐\n│ 1. Read JSON from stdin (Claude Code provides this)          │\n│    Contains: { \"cwd\": \"/current/path\", ... }                 │\n└──────────────────────────────────────────────────────────────┘\n                              │\n                              ▼\n┌──────────────────────────────────────────────────────────────┐\n│ 2. Extract 'cwd' field using Python                          │\n│    python3 -c \"import sys,json; print(json.load(...))\"       │\n└──────────────────────────────────────────────────────────────┘\n                              │\n                              ▼\n┌──────────────────────────────────────────────────────────────┐\n│ 3. Compare against /tmp/claude-cwd-state                     │\n│    - If file doesn't exist: first command, save and exit 0   │\n│    - If cwd unchanged: exit 0 (zero token overhead)          │\n│    - If cwd changed: continue to notification                │\n└──────────────────────────────────────────────────────────────┘\n                              │\n                              ▼\n┌──────────────────────────────────────────────────────────────┐\n│ 4. Output notification to stderr and exit 2                  │\n│    echo \"Note: Working directory changed...\" >&2             │\n│    exit 2                                                    │\n│                                                              │\n│    Why stderr + exit 2?                                      │\n│    - Exit 0 + stdout: Only shown in transcript (LLM can't    │\n│      see)                                                    │\n│    - Exit 2 + stderr: Fed back to LLM for adjustment         │\n└──────────────────────────────────────────────────────────────┘\n```\n\n### Why This Works\n\nClaude Code's hook system has specific behavior:\n\n| Exit Code | Output | LLM Sees It? | Use Case |\n|-----------|--------|--------------|----------|\n| 0 | stdout | No (transcript only) | Silent logging |\n| 0 | stderr | No | Silent warnings |\n| 1 | any | Yes (as error) | Block the action |\n| 2 | stderr | Yes (as feedback) | **Inform the LLM** |\n\nWe use **exit code 2 + stderr** to feed information back to Claude without blocking the command.\n\n### Root Cause Analysis\n\nFrom analyzing Claude Code's source:\n\n1. `PersistentShell` correctly tracks cwd via temp file (`pwd > cwdFile` after each command)\n2. `getCwd()` correctly returns the current working directory\n3. **BUT**: The recursive `query()` call reuses the **same static system prompt**\n4. **AND**: `BashTool.renderResultForAssistant()` doesn't include cwd info\n5. **Result**: The LLM never learns about directory changes\n\nThis hook works around the issue by injecting cwd change notifications into the tool output stream.\n\n## Configuration Options\n\n### Basic Configuration\n\n```json\n{\n  \"hooks\": {\n    \"PostToolUse\": [\n      {\n        \"matcher\": \"Bash\",\n        \"hooks\": [\n          {\n            \"type\": \"command\",\n            \"command\": \"~/.claude/hooks/cwd-notify.sh\"\n          }\n        ]\n      }\n    ]\n  }\n}\n```\n\n### With Other Hooks\n\nIf you have other PostToolUse hooks, add this one to the array:\n\n```json\n{\n  \"hooks\": {\n    \"PostToolUse\": [\n      {\n        \"matcher\": \"Bash\",\n        \"hooks\": [\n          { \"type\": \"command\", \"command\": \"~/.claude/hooks/cwd-notify.sh\" },\n          { \"type\": \"command\", \"command\": \"~/.claude/hooks/your-other-hook.sh\" }\n        ]\n      },\n      {\n        \"matcher\": \"Write\",\n        \"hooks\": [\n          { \"type\": \"command\", \"command\": \"~/.claude/hooks/write-hook.sh\" }\n        ]\n      }\n    ]\n  }\n}\n```\n\n## Troubleshooting\n\n### Hook Not Running\n\n**Symptom**: No \"PostToolUse:Bash hook succeeded\" message after Bash commands.\n\n**Solutions**:\n1. Verify `settings.json` syntax is valid JSON:\n   ```bash\n   cat ~/.claude/settings.json | python3 -m json.tool\n   ```\n2. Check the hook path is correct and file exists:\n   ```bash\n   ls -la ~/.claude/hooks/cwd-notify.sh\n   ```\n3. Ensure the hook is executable:\n   ```bash\n   chmod +x ~/.claude/hooks/cwd-notify.sh\n   ```\n4. Restart Claude Code (hooks are loaded at session start)\n\n### Hook Runs But No Notification\n\n**Symptom**: \"PostToolUse:Bash hook succeeded\" appears but no cwd change notification.\n\n**Possible causes**:\n1. **First command of session**: The hook silently initializes state on the first command\n2. **CWD didn't actually change**: Commands without `cd` won't trigger notifications\n3. **State file has current path**: Clear it with `rm -f /tmp/claude-cwd-state`\n\n### Python Not Found\n\n**Symptom**: Hook fails silently or errors about Python.\n\n**Solution**:\n```bash\n# Check Python 3 is available\npython3 --version\n\n# If not installed (macOS)\nbrew install python3\n\n# If not installed (Ubuntu/Debian)\nsudo apt-get install python3\n```\n\n### JSON Parsing Error\n\n**Symptom**: Hook runs but never detects changes.\n\n**Debug**:\n```bash\n# Test the JSON parsing manually\necho '{\"cwd\": \"/test/path\"}' | python3 -c \"import sys,json; print(json.load(sys.stdin).get('cwd',''))\"\n# Should output: /test/path\n```\n\n### Permission Denied\n\n**Symptom**: Error about permission denied when running hook.\n\n**Solution**:\n```bash\nchmod +x ~/.claude/hooks/cwd-notify.sh\n```\n\n### State File Issues\n\n**Symptom**: Weird behavior, wrong notifications.\n\n**Solution**:\n```bash\n# Clear the state file\nrm -f /tmp/claude-cwd-state\n\n# Check state file contents\ncat /tmp/claude-cwd-state\n```\n\n## Performance\n\n- **Zero overhead when cwd unchanged**: Hook exits immediately with code 0\n- **Minimal overhead on change**: Single file read, one Python invocation, one file write\n- **State file**: Tiny (just a path string in `/tmp/claude-cwd-state`)\n\n## Limitations\n\n- **Session-specific state**: The `/tmp/claude-cwd-state` file persists across sessions. If you start a new session in a different directory, the first `cd` might show a misleading \"changed from\" path. This is harmless—Claude gets the correct current path.\n\n- **Requires Python 3**: Used for JSON parsing. Could be rewritten in pure Bash with `jq` as an alternative.\n\n- **Single session**: If running multiple Claude Code sessions simultaneously, they share the same state file. This could cause incorrect notifications. For multi-session support, the state file path would need to include a session identifier.\n\n## Related Issues\n\nThis plugin addresses these Claude Code GitHub issues:\n\n- [#1669](https://github.com/anthropics/claude-code/issues/1669) - Working directory tracking\n- [#4100](https://github.com/anthropics/claude-code/issues/4100) - cd command confusion\n- [#11067](https://github.com/anthropics/claude-code/issues/11067) - Path resolution after cd\n- [#14122](https://github.com/anthropics/claude-code/issues/14122) - LLM unaware of directory changes\n\n## Contributing\n\nContributions welcome! Please:\n\n1. Fork the repository\n2. Create a feature branch\n3. Make your changes\n4. Test the hook manually\n5. Submit a pull request\n\n## License\n\nMIT License - see [LICENSE](LICENSE) for details.\n\n## Acknowledgments\n\n- Created during a debugging session analyzing Claude Code's source code\n- Thanks to the Claude Code team for the extensible hook system\n"
      },
      "plugins": [
        {
          "name": "cwd-tracker",
          "description": "Fixes the working directory tracking bug by notifying Claude when CWD changes",
          "version": "1.0.0",
          "author": {
            "name": "gruckion"
          },
          "source": ".",
          "category": "bug-fixes",
          "tags": [
            "cwd",
            "working-directory",
            "bash",
            "hooks"
          ],
          "keywords": [
            "cwd",
            "bash",
            "hooks",
            "bug-fix",
            "working-directory"
          ],
          "categories": [
            "bash",
            "bug-fix",
            "bug-fixes",
            "cwd",
            "hooks",
            "working-directory"
          ],
          "install_commands": [
            "/plugin marketplace add gruckion/claude-code-cwd-tracker",
            "/plugin install cwd-tracker@cwd-tracker-marketplace"
          ]
        }
      ]
    }
  ]
}