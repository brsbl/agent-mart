{
  "author": {
    "id": "fatfingererr",
    "display_name": "Ruei-Ci Wang",
    "type": "User",
    "avatar_url": "https://avatars.githubusercontent.com/u/23048798?u=69291ae5d24cc457234853cb1c3ed23d8ce42fa5&v=4",
    "url": "https://github.com/fatfingererr",
    "bio": "Emacs user / LISP lover / FX Quant",
    "stats": {
      "total_marketplaces": 1,
      "total_plugins": 36,
      "total_commands": 0,
      "total_skills": 36,
      "total_stars": 0,
      "total_forks": 0
    }
  },
  "marketplaces": [
    {
      "name": "macro-skills",
      "version": null,
      "description": "專為宏觀經濟分析設計的 Claude 技能集合",
      "owner_info": {
        "name": "fatfingererr",
        "email": "fatfingererr@gmail.com"
      },
      "keywords": [],
      "repo_full_name": "fatfingererr/macro-skills",
      "repo_url": "https://github.com/fatfingererr/macro-skills",
      "repo_description": "A hub for reusable macro-level skills (Traditional Chinese)",
      "homepage": "https://fatfingererr.github.io/macro-skills/",
      "signals": {
        "stars": 0,
        "forks": 0,
        "pushed_at": "2026-01-29T09:24:45Z",
        "created_at": "2026-01-12T02:07:56Z",
        "license": "MIT"
      },
      "file_tree": [
        {
          "path": ".claude-plugin",
          "type": "tree",
          "size": null
        },
        {
          "path": ".claude-plugin/README.md",
          "type": "blob",
          "size": 2059
        },
        {
          "path": ".claude-plugin/manifest.json",
          "type": "blob",
          "size": 904
        },
        {
          "path": ".claude-plugin/marketplace.json",
          "type": "blob",
          "size": 22392
        },
        {
          "path": "skills",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-copper-inventory-rebuild-signal",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-copper-inventory-rebuild-signal/SKILL.md",
          "type": "blob",
          "size": 11858
        },
        {
          "path": "skills/analyze-copper-inventory-rebuild-signal/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-copper-inventory-rebuild-signal/references/data-sources.md",
          "type": "blob",
          "size": 6429
        },
        {
          "path": "skills/analyze-copper-inventory-rebuild-signal/references/historical-episodes.md",
          "type": "blob",
          "size": 5793
        },
        {
          "path": "skills/analyze-copper-inventory-rebuild-signal/references/methodology.md",
          "type": "blob",
          "size": 10961
        },
        {
          "path": "skills/analyze-copper-inventory-rebuild-signal/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-copper-inventory-rebuild-signal/templates/output-json.md",
          "type": "blob",
          "size": 4606
        },
        {
          "path": "skills/analyze-copper-inventory-rebuild-signal/templates/output-markdown.md",
          "type": "blob",
          "size": 4691
        },
        {
          "path": "skills/analyze-copper-inventory-rebuild-signal/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-copper-inventory-rebuild-signal/workflows/full-analysis.md",
          "type": "blob",
          "size": 2228
        },
        {
          "path": "skills/analyze-copper-inventory-rebuild-signal/workflows/quick-check.md",
          "type": "blob",
          "size": 1744
        },
        {
          "path": "skills/analyze-copper-inventory-rebuild-signal/workflows/visualize.md",
          "type": "blob",
          "size": 1861
        },
        {
          "path": "skills/analyze-copper-stock-resilience-dependency",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-copper-stock-resilience-dependency/SKILL.md",
          "type": "blob",
          "size": 13302
        },
        {
          "path": "skills/analyze-copper-stock-resilience-dependency/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-copper-stock-resilience-dependency/references/data-sources.md",
          "type": "blob",
          "size": 7749
        },
        {
          "path": "skills/analyze-copper-stock-resilience-dependency/references/input-schema.md",
          "type": "blob",
          "size": 5749
        },
        {
          "path": "skills/analyze-copper-stock-resilience-dependency/references/methodology.md",
          "type": "blob",
          "size": 5539
        },
        {
          "path": "skills/analyze-copper-stock-resilience-dependency/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-copper-stock-resilience-dependency/templates/output-json.md",
          "type": "blob",
          "size": 6963
        },
        {
          "path": "skills/analyze-copper-stock-resilience-dependency/templates/output-markdown.md",
          "type": "blob",
          "size": 4846
        },
        {
          "path": "skills/analyze-copper-stock-resilience-dependency/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-copper-stock-resilience-dependency/workflows/analyze.md",
          "type": "blob",
          "size": 7065
        },
        {
          "path": "skills/analyze-copper-stock-resilience-dependency/workflows/quick-check.md",
          "type": "blob",
          "size": 2431
        },
        {
          "path": "skills/analyze-copper-stock-resilience-dependency/workflows/visualize.md",
          "type": "blob",
          "size": 3578
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/SKILL.md",
          "type": "blob",
          "size": 5503
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/examples",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/examples/full_report.md",
          "type": "blob",
          "size": 7105
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/references/chile-supply-dynamics.md",
          "type": "blob",
          "size": 4798
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/references/concentration-metrics.md",
          "type": "blob",
          "size": 6726
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/references/data-sources.md",
          "type": "blob",
          "size": 2528
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/references/failure-modes.md",
          "type": "blob",
          "size": 7391
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/references/geopolitics-risk.md",
          "type": "blob",
          "size": 8845
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/references/methodology.md",
          "type": "blob",
          "size": 4585
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/references/replacement-countries.md",
          "type": "blob",
          "size": 5820
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/templates/output-json.md",
          "type": "blob",
          "size": 6959
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/templates/output-markdown.md",
          "type": "blob",
          "size": 7512
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/workflows/analyze-chile-trend.md",
          "type": "blob",
          "size": 9455
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/workflows/analyze-concentration.md",
          "type": "blob",
          "size": 2415
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/workflows/analyze-replacement.md",
          "type": "blob",
          "size": 12365
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/workflows/full-report.md",
          "type": "blob",
          "size": 11774
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/workflows/ingest-data.md",
          "type": "blob",
          "size": 14293
        },
        {
          "path": "skills/analyze-copper-supply-concentration-risk/workflows/scenario-analysis.md",
          "type": "blob",
          "size": 12491
        },
        {
          "path": "skills/analyze-gas-fertilizer-contract-shock",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-gas-fertilizer-contract-shock/SKILL.md",
          "type": "blob",
          "size": 10675
        },
        {
          "path": "skills/analyze-gas-fertilizer-contract-shock/methodology.md",
          "type": "blob",
          "size": 2701
        },
        {
          "path": "skills/analyze-gas-fertilizer-contract-shock/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-gas-fertilizer-contract-shock/references/data-sources.md",
          "type": "blob",
          "size": 10445
        },
        {
          "path": "skills/analyze-gas-fertilizer-contract-shock/references/historical-episodes.md",
          "type": "blob",
          "size": 4744
        },
        {
          "path": "skills/analyze-gas-fertilizer-contract-shock/references/input-schema.md",
          "type": "blob",
          "size": 7623
        },
        {
          "path": "skills/analyze-gas-fertilizer-contract-shock/references/methods.md",
          "type": "blob",
          "size": 7905
        },
        {
          "path": "skills/analyze-gas-fertilizer-contract-shock/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-gas-fertilizer-contract-shock/templates/output-json.md",
          "type": "blob",
          "size": 6555
        },
        {
          "path": "skills/analyze-gas-fertilizer-contract-shock/templates/output-markdown.md",
          "type": "blob",
          "size": 6943
        },
        {
          "path": "skills/analyze-gas-fertilizer-contract-shock/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-gas-fertilizer-contract-shock/workflows/analyze.md",
          "type": "blob",
          "size": 7767
        },
        {
          "path": "skills/analyze-gas-fertilizer-contract-shock/workflows/hedge-hypothesis.md",
          "type": "blob",
          "size": 3798
        },
        {
          "path": "skills/analyze-gas-fertilizer-contract-shock/workflows/quick-check.md",
          "type": "blob",
          "size": 3857
        },
        {
          "path": "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/SKILL.md",
          "type": "blob",
          "size": 14667
        },
        {
          "path": "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/references/data-sources.md",
          "type": "blob",
          "size": 8685
        },
        {
          "path": "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/references/input-schema.md",
          "type": "blob",
          "size": 7947
        },
        {
          "path": "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/references/methodology.md",
          "type": "blob",
          "size": 13474
        },
        {
          "path": "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/templates/output-json.md",
          "type": "blob",
          "size": 8040
        },
        {
          "path": "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/templates/output-markdown.md",
          "type": "blob",
          "size": 7596
        },
        {
          "path": "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/workflows/analyze.md",
          "type": "blob",
          "size": 5770
        },
        {
          "path": "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/workflows/scenario.md",
          "type": "blob",
          "size": 5207
        },
        {
          "path": "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/workflows/ust-risk.md",
          "type": "blob",
          "size": 6361
        },
        {
          "path": "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/workflows/visualize.md",
          "type": "blob",
          "size": 4926
        },
        {
          "path": "skills/analyze-investment-clock-rotation",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-investment-clock-rotation/SKILL.md",
          "type": "blob",
          "size": 10425
        },
        {
          "path": "skills/analyze-investment-clock-rotation/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-investment-clock-rotation/references/data-sources.md",
          "type": "blob",
          "size": 5121
        },
        {
          "path": "skills/analyze-investment-clock-rotation/references/input-schema.md",
          "type": "blob",
          "size": 6670
        },
        {
          "path": "skills/analyze-investment-clock-rotation/references/methodology.md",
          "type": "blob",
          "size": 6426
        },
        {
          "path": "skills/analyze-investment-clock-rotation/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-investment-clock-rotation/templates/output-json.md",
          "type": "blob",
          "size": 6748
        },
        {
          "path": "skills/analyze-investment-clock-rotation/templates/output-markdown.md",
          "type": "blob",
          "size": 6454
        },
        {
          "path": "skills/analyze-investment-clock-rotation/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-investment-clock-rotation/workflows/analyze.md",
          "type": "blob",
          "size": 5683
        },
        {
          "path": "skills/analyze-investment-clock-rotation/workflows/compare-cycle.md",
          "type": "blob",
          "size": 7347
        },
        {
          "path": "skills/analyze-investment-clock-rotation/workflows/visualize.md",
          "type": "blob",
          "size": 6035
        },
        {
          "path": "skills/analyze-japan-debt-service-tax-burden",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-japan-debt-service-tax-burden/SKILL.md",
          "type": "blob",
          "size": 15214
        },
        {
          "path": "skills/analyze-japan-debt-service-tax-burden/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-japan-debt-service-tax-burden/references/data-sources.md",
          "type": "blob",
          "size": 5858
        },
        {
          "path": "skills/analyze-japan-debt-service-tax-burden/references/japan-fiscal-structure.md",
          "type": "blob",
          "size": 2974
        },
        {
          "path": "skills/analyze-japan-debt-service-tax-burden/references/methodology.md",
          "type": "blob",
          "size": 5298
        },
        {
          "path": "skills/analyze-japan-debt-service-tax-burden/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-japan-debt-service-tax-burden/templates/output-json.md",
          "type": "blob",
          "size": 4165
        },
        {
          "path": "skills/analyze-japan-debt-service-tax-burden/templates/output-markdown.md",
          "type": "blob",
          "size": 3700
        },
        {
          "path": "skills/analyze-japan-debt-service-tax-burden/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-japan-debt-service-tax-burden/workflows/full-analysis.md",
          "type": "blob",
          "size": 2393
        },
        {
          "path": "skills/analyze-japan-debt-service-tax-burden/workflows/generate-chart.md",
          "type": "blob",
          "size": 3303
        },
        {
          "path": "skills/analyze-japan-debt-service-tax-burden/workflows/historical-trend.md",
          "type": "blob",
          "size": 6734
        },
        {
          "path": "skills/analyze-japan-debt-service-tax-burden/workflows/quick-check.md",
          "type": "blob",
          "size": 968
        },
        {
          "path": "skills/analyze-japan-debt-service-tax-burden/workflows/spiral-simulate.md",
          "type": "blob",
          "size": 2953
        },
        {
          "path": "skills/analyze-japan-debt-service-tax-burden/workflows/stress-test.md",
          "type": "blob",
          "size": 2317
        },
        {
          "path": "skills/analyze-jgb-insurer-superlong-flow",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-jgb-insurer-superlong-flow/SKILL.md",
          "type": "blob",
          "size": 10387
        },
        {
          "path": "skills/analyze-jgb-insurer-superlong-flow/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-jgb-insurer-superlong-flow/references/data-sources.md",
          "type": "blob",
          "size": 5779
        },
        {
          "path": "skills/analyze-jgb-insurer-superlong-flow/references/input-schema.md",
          "type": "blob",
          "size": 5644
        },
        {
          "path": "skills/analyze-jgb-insurer-superlong-flow/references/jsda-structure.md",
          "type": "blob",
          "size": 5920
        },
        {
          "path": "skills/analyze-jgb-insurer-superlong-flow/references/methodology.md",
          "type": "blob",
          "size": 7730
        },
        {
          "path": "skills/analyze-jgb-insurer-superlong-flow/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-jgb-insurer-superlong-flow/templates/output-json.md",
          "type": "blob",
          "size": 7855
        },
        {
          "path": "skills/analyze-jgb-insurer-superlong-flow/templates/output-markdown.md",
          "type": "blob",
          "size": 5904
        },
        {
          "path": "skills/analyze-jgb-insurer-superlong-flow/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-jgb-insurer-superlong-flow/workflows/full-analysis.md",
          "type": "blob",
          "size": 4297
        },
        {
          "path": "skills/analyze-jgb-insurer-superlong-flow/workflows/generate-chart.md",
          "type": "blob",
          "size": 3226
        },
        {
          "path": "skills/analyze-jgb-insurer-superlong-flow/workflows/quick-check.md",
          "type": "blob",
          "size": 2710
        },
        {
          "path": "skills/analyze-jgb-insurer-superlong-flow/workflows/verify-claim.md",
          "type": "blob",
          "size": 3925
        },
        {
          "path": "skills/analyze-move-risk-gauges-leadlag",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-move-risk-gauges-leadlag/SKILL.md",
          "type": "blob",
          "size": 18114
        },
        {
          "path": "skills/analyze-move-risk-gauges-leadlag/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-move-risk-gauges-leadlag/references/data-sources.md",
          "type": "blob",
          "size": 7475
        },
        {
          "path": "skills/analyze-move-risk-gauges-leadlag/references/input-schema.md",
          "type": "blob",
          "size": 7040
        },
        {
          "path": "skills/analyze-move-risk-gauges-leadlag/references/methodology.md",
          "type": "blob",
          "size": 10878
        },
        {
          "path": "skills/analyze-move-risk-gauges-leadlag/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-move-risk-gauges-leadlag/templates/output-json.md",
          "type": "blob",
          "size": 8237
        },
        {
          "path": "skills/analyze-move-risk-gauges-leadlag/templates/output-markdown.md",
          "type": "blob",
          "size": 7185
        },
        {
          "path": "skills/analyze-move-risk-gauges-leadlag/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-move-risk-gauges-leadlag/workflows/analyze.md",
          "type": "blob",
          "size": 7764
        },
        {
          "path": "skills/analyze-move-risk-gauges-leadlag/workflows/visualize.md",
          "type": "blob",
          "size": 5620
        },
        {
          "path": "skills/analyze-platinum-to-brazil-equities-transmission",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-platinum-to-brazil-equities-transmission/SKILL.md",
          "type": "blob",
          "size": 10714
        },
        {
          "path": "skills/analyze-platinum-to-brazil-equities-transmission/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-platinum-to-brazil-equities-transmission/references/data-sources.md",
          "type": "blob",
          "size": 2284
        },
        {
          "path": "skills/analyze-platinum-to-brazil-equities-transmission/references/input-schema.md",
          "type": "blob",
          "size": 1951
        },
        {
          "path": "skills/analyze-platinum-to-brazil-equities-transmission/references/methodology.md",
          "type": "blob",
          "size": 5264
        },
        {
          "path": "skills/analyze-platinum-to-brazil-equities-transmission/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-platinum-to-brazil-equities-transmission/templates/output-json.md",
          "type": "blob",
          "size": 2852
        },
        {
          "path": "skills/analyze-platinum-to-brazil-equities-transmission/templates/output-markdown.md",
          "type": "blob",
          "size": 2610
        },
        {
          "path": "skills/analyze-platinum-to-brazil-equities-transmission/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-platinum-to-brazil-equities-transmission/workflows/analyze.md",
          "type": "blob",
          "size": 4760
        },
        {
          "path": "skills/analyze-platinum-to-brazil-equities-transmission/workflows/visualize.md",
          "type": "blob",
          "size": 3436
        },
        {
          "path": "skills/analyze-rolex-market-index-liquidity-proxy",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-rolex-market-index-liquidity-proxy/SKILL.md",
          "type": "blob",
          "size": 11080
        },
        {
          "path": "skills/analyze-rolex-market-index-liquidity-proxy/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-rolex-market-index-liquidity-proxy/references/data-sources.md",
          "type": "blob",
          "size": 6428
        },
        {
          "path": "skills/analyze-rolex-market-index-liquidity-proxy/references/input-schema.md",
          "type": "blob",
          "size": 4130
        },
        {
          "path": "skills/analyze-rolex-market-index-liquidity-proxy/references/methodology.md",
          "type": "blob",
          "size": 4871
        },
        {
          "path": "skills/analyze-rolex-market-index-liquidity-proxy/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-rolex-market-index-liquidity-proxy/templates/output-json.md",
          "type": "blob",
          "size": 4492
        },
        {
          "path": "skills/analyze-rolex-market-index-liquidity-proxy/templates/output-markdown.md",
          "type": "blob",
          "size": 4388
        },
        {
          "path": "skills/analyze-rolex-market-index-liquidity-proxy/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-rolex-market-index-liquidity-proxy/workflows/analyze.md",
          "type": "blob",
          "size": 10644
        },
        {
          "path": "skills/analyze-silver-miner-metal-ratio",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-silver-miner-metal-ratio/SKILL.md",
          "type": "blob",
          "size": 13250
        },
        {
          "path": "skills/analyze-silver-miner-metal-ratio/methodology.md",
          "type": "blob",
          "size": 2477
        },
        {
          "path": "skills/analyze-silver-miner-metal-ratio/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-silver-miner-metal-ratio/references/data-sources.md",
          "type": "blob",
          "size": 5010
        },
        {
          "path": "skills/analyze-silver-miner-metal-ratio/references/input-schema.md",
          "type": "blob",
          "size": 4718
        },
        {
          "path": "skills/analyze-silver-miner-metal-ratio/references/method.md",
          "type": "blob",
          "size": 5576
        },
        {
          "path": "skills/analyze-silver-miner-metal-ratio/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-silver-miner-metal-ratio/templates/output-json.md",
          "type": "blob",
          "size": 6630
        },
        {
          "path": "skills/analyze-silver-miner-metal-ratio/templates/output-markdown.md",
          "type": "blob",
          "size": 5080
        },
        {
          "path": "skills/analyze-silver-miner-metal-ratio/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-silver-miner-metal-ratio/workflows/analyze.md",
          "type": "blob",
          "size": 5327
        },
        {
          "path": "skills/analyze-silver-miner-metal-ratio/workflows/data-research.md",
          "type": "blob",
          "size": 4260
        },
        {
          "path": "skills/analyze-us-bank-credit-deposit-decoupling",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-us-bank-credit-deposit-decoupling/SKILL.md",
          "type": "blob",
          "size": 9087
        },
        {
          "path": "skills/analyze-us-bank-credit-deposit-decoupling/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-us-bank-credit-deposit-decoupling/references/data-sources.md",
          "type": "blob",
          "size": 6609
        },
        {
          "path": "skills/analyze-us-bank-credit-deposit-decoupling/references/historical-episodes.md",
          "type": "blob",
          "size": 4573
        },
        {
          "path": "skills/analyze-us-bank-credit-deposit-decoupling/references/methodology.md",
          "type": "blob",
          "size": 5287
        },
        {
          "path": "skills/analyze-us-bank-credit-deposit-decoupling/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-us-bank-credit-deposit-decoupling/templates/output-json.md",
          "type": "blob",
          "size": 5454
        },
        {
          "path": "skills/analyze-us-bank-credit-deposit-decoupling/templates/output-markdown.md",
          "type": "blob",
          "size": 4189
        },
        {
          "path": "skills/analyze-us-bank-credit-deposit-decoupling/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/analyze-us-bank-credit-deposit-decoupling/workflows/analyze.md",
          "type": "blob",
          "size": 3891
        },
        {
          "path": "skills/analyze-us-bank-credit-deposit-decoupling/workflows/quick-check.md",
          "type": "blob",
          "size": 1026
        },
        {
          "path": "skills/backsolve-miner-vs-metal-ratio-with-fundamentals",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/SKILL.md",
          "type": "blob",
          "size": 15443
        },
        {
          "path": "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/methodology.md",
          "type": "blob",
          "size": 4240
        },
        {
          "path": "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/references/backsolve-math.md",
          "type": "blob",
          "size": 7401
        },
        {
          "path": "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/references/data-sources.md",
          "type": "blob",
          "size": 7610
        },
        {
          "path": "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/references/fundamental-factors.md",
          "type": "blob",
          "size": 8561
        },
        {
          "path": "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/references/input-schema.md",
          "type": "blob",
          "size": 9010
        },
        {
          "path": "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/templates/output-json.md",
          "type": "blob",
          "size": 8152
        },
        {
          "path": "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/templates/output-markdown.md",
          "type": "blob",
          "size": 8399
        },
        {
          "path": "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/workflows/analyze.md",
          "type": "blob",
          "size": 7881
        },
        {
          "path": "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/workflows/data-fetch.md",
          "type": "blob",
          "size": 9332
        },
        {
          "path": "skills/compute-precious-miner-gross-margin",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/compute-precious-miner-gross-margin/SKILL.md",
          "type": "blob",
          "size": 11242
        },
        {
          "path": "skills/compute-precious-miner-gross-margin/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/compute-precious-miner-gross-margin/references/data-sources.md",
          "type": "blob",
          "size": 7428
        },
        {
          "path": "skills/compute-precious-miner-gross-margin/references/input-schema.md",
          "type": "blob",
          "size": 7171
        },
        {
          "path": "skills/compute-precious-miner-gross-margin/references/methodology.md",
          "type": "blob",
          "size": 8643
        },
        {
          "path": "skills/compute-precious-miner-gross-margin/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/compute-precious-miner-gross-margin/templates/output-json.md",
          "type": "blob",
          "size": 7268
        },
        {
          "path": "skills/compute-precious-miner-gross-margin/templates/output-markdown.md",
          "type": "blob",
          "size": 5927
        },
        {
          "path": "skills/compute-precious-miner-gross-margin/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/compute-precious-miner-gross-margin/workflows/analyze.md",
          "type": "blob",
          "size": 5592
        },
        {
          "path": "skills/compute-precious-miner-gross-margin/workflows/data-research.md",
          "type": "blob",
          "size": 7459
        },
        {
          "path": "skills/compute-precious-miner-gross-margin/workflows/signal-generation.md",
          "type": "blob",
          "size": 10159
        },
        {
          "path": "skills/cost-density-net-rr-calculator",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/cost-density-net-rr-calculator/SKILL.md",
          "type": "blob",
          "size": 4261
        },
        {
          "path": "skills/cost-density-net-rr-calculator/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/cost-density-net-rr-calculator/references/formulas.md",
          "type": "blob",
          "size": 5010
        },
        {
          "path": "skills/cost-density-net-rr-calculator/references/theory.md",
          "type": "blob",
          "size": 5001
        },
        {
          "path": "skills/cost-density-net-rr-calculator/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/cost-density-net-rr-calculator/workflows/analyze.md",
          "type": "blob",
          "size": 4588
        },
        {
          "path": "skills/cost-density-net-rr-calculator/workflows/compute.md",
          "type": "blob",
          "size": 2089
        },
        {
          "path": "skills/cost-density-net-rr-calculator/workflows/sweep.md",
          "type": "blob",
          "size": 3044
        },
        {
          "path": "skills/demographic-fiscal-trap-analyzer",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/demographic-fiscal-trap-analyzer/SKILL.md",
          "type": "blob",
          "size": 11902
        },
        {
          "path": "skills/demographic-fiscal-trap-analyzer/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/demographic-fiscal-trap-analyzer/references/data-sources.md",
          "type": "blob",
          "size": 7552
        },
        {
          "path": "skills/demographic-fiscal-trap-analyzer/references/indicator-codes.md",
          "type": "blob",
          "size": 5818
        },
        {
          "path": "skills/demographic-fiscal-trap-analyzer/references/input-schema.md",
          "type": "blob",
          "size": 5512
        },
        {
          "path": "skills/demographic-fiscal-trap-analyzer/references/methodology.md",
          "type": "blob",
          "size": 6615
        },
        {
          "path": "skills/demographic-fiscal-trap-analyzer/scripts",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/demographic-fiscal-trap-analyzer/scripts/README.md",
          "type": "blob",
          "size": 6356
        },
        {
          "path": "skills/demographic-fiscal-trap-analyzer/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/demographic-fiscal-trap-analyzer/templates/output-json.md",
          "type": "blob",
          "size": 10286
        },
        {
          "path": "skills/demographic-fiscal-trap-analyzer/templates/output-markdown.md",
          "type": "blob",
          "size": 7662
        },
        {
          "path": "skills/demographic-fiscal-trap-analyzer/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/demographic-fiscal-trap-analyzer/workflows/aging-projection.md",
          "type": "blob",
          "size": 4324
        },
        {
          "path": "skills/demographic-fiscal-trap-analyzer/workflows/cross-country.md",
          "type": "blob",
          "size": 5533
        },
        {
          "path": "skills/demographic-fiscal-trap-analyzer/workflows/debt-dynamics.md",
          "type": "blob",
          "size": 3242
        },
        {
          "path": "skills/demographic-fiscal-trap-analyzer/workflows/full-analysis.md",
          "type": "blob",
          "size": 3708
        },
        {
          "path": "skills/demographic-fiscal-trap-analyzer/workflows/inflation-path.md",
          "type": "blob",
          "size": 6176
        },
        {
          "path": "skills/detect-atr-squeeze-regime",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-atr-squeeze-regime/SKILL.md",
          "type": "blob",
          "size": 10171
        },
        {
          "path": "skills/detect-atr-squeeze-regime/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-atr-squeeze-regime/references/data-sources.md",
          "type": "blob",
          "size": 4972
        },
        {
          "path": "skills/detect-atr-squeeze-regime/references/input-schema.md",
          "type": "blob",
          "size": 5923
        },
        {
          "path": "skills/detect-atr-squeeze-regime/references/methodology.md",
          "type": "blob",
          "size": 5316
        },
        {
          "path": "skills/detect-atr-squeeze-regime/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-atr-squeeze-regime/templates/output-json.md",
          "type": "blob",
          "size": 7650
        },
        {
          "path": "skills/detect-atr-squeeze-regime/templates/output-markdown.md",
          "type": "blob",
          "size": 5161
        },
        {
          "path": "skills/detect-atr-squeeze-regime/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-atr-squeeze-regime/workflows/backtest.md",
          "type": "blob",
          "size": 3847
        },
        {
          "path": "skills/detect-atr-squeeze-regime/workflows/detect.md",
          "type": "blob",
          "size": 3216
        },
        {
          "path": "skills/detect-atr-squeeze-regime/workflows/monitor.md",
          "type": "blob",
          "size": 3596
        },
        {
          "path": "skills/detect-fed-unamortized-discount-pattern",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-fed-unamortized-discount-pattern/SKILL.md",
          "type": "blob",
          "size": 13205
        },
        {
          "path": "skills/detect-fed-unamortized-discount-pattern/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-fed-unamortized-discount-pattern/references/data-sources.md",
          "type": "blob",
          "size": 5068
        },
        {
          "path": "skills/detect-fed-unamortized-discount-pattern/references/input-schema.md",
          "type": "blob",
          "size": 7368
        },
        {
          "path": "skills/detect-fed-unamortized-discount-pattern/references/methodology.md",
          "type": "blob",
          "size": 10960
        },
        {
          "path": "skills/detect-fed-unamortized-discount-pattern/references/wudsho-mechanism.md",
          "type": "blob",
          "size": 4813
        },
        {
          "path": "skills/detect-fed-unamortized-discount-pattern/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-fed-unamortized-discount-pattern/templates/output-json.md",
          "type": "blob",
          "size": 9039
        },
        {
          "path": "skills/detect-fed-unamortized-discount-pattern/templates/output-markdown.md",
          "type": "blob",
          "size": 7486
        },
        {
          "path": "skills/detect-fed-unamortized-discount-pattern/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-fed-unamortized-discount-pattern/workflows/execute-analysis.md",
          "type": "blob",
          "size": 4489
        },
        {
          "path": "skills/detect-fed-unamortized-discount-pattern/workflows/historical-episodes.md",
          "type": "blob",
          "size": 4169
        },
        {
          "path": "skills/detect-fed-unamortized-discount-pattern/workflows/visualize-analysis.md",
          "type": "blob",
          "size": 3037
        },
        {
          "path": "skills/detect-freight-led-inflation-turn",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-freight-led-inflation-turn/SKILL.md",
          "type": "blob",
          "size": 10893
        },
        {
          "path": "skills/detect-freight-led-inflation-turn/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-freight-led-inflation-turn/references/data-sources.md",
          "type": "blob",
          "size": 10551
        },
        {
          "path": "skills/detect-freight-led-inflation-turn/references/historical-episodes.md",
          "type": "blob",
          "size": 6931
        },
        {
          "path": "skills/detect-freight-led-inflation-turn/references/methodology.md",
          "type": "blob",
          "size": 2257
        },
        {
          "path": "skills/detect-freight-led-inflation-turn/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-freight-led-inflation-turn/templates/output-json.md",
          "type": "blob",
          "size": 7079
        },
        {
          "path": "skills/detect-freight-led-inflation-turn/templates/output-markdown.md",
          "type": "blob",
          "size": 7273
        },
        {
          "path": "skills/detect-freight-led-inflation-turn/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-freight-led-inflation-turn/workflows/analyze.md",
          "type": "blob",
          "size": 12458
        },
        {
          "path": "skills/detect-freight-led-inflation-turn/workflows/quick-check.md",
          "type": "blob",
          "size": 4546
        },
        {
          "path": "skills/detect-palladium-lead-silver-turns",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-palladium-lead-silver-turns/SKILL.md",
          "type": "blob",
          "size": 12108
        },
        {
          "path": "skills/detect-palladium-lead-silver-turns/methodology.md",
          "type": "blob",
          "size": 2114
        },
        {
          "path": "skills/detect-palladium-lead-silver-turns/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-palladium-lead-silver-turns/references/data-sources.md",
          "type": "blob",
          "size": 5703
        },
        {
          "path": "skills/detect-palladium-lead-silver-turns/references/input-schema.md",
          "type": "blob",
          "size": 8657
        },
        {
          "path": "skills/detect-palladium-lead-silver-turns/references/methods.md",
          "type": "blob",
          "size": 9880
        },
        {
          "path": "skills/detect-palladium-lead-silver-turns/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-palladium-lead-silver-turns/templates/output-json.md",
          "type": "blob",
          "size": 7381
        },
        {
          "path": "skills/detect-palladium-lead-silver-turns/templates/output-markdown.md",
          "type": "blob",
          "size": 6459
        },
        {
          "path": "skills/detect-palladium-lead-silver-turns/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-palladium-lead-silver-turns/workflows/backtest.md",
          "type": "blob",
          "size": 6044
        },
        {
          "path": "skills/detect-palladium-lead-silver-turns/workflows/detect.md",
          "type": "blob",
          "size": 4620
        },
        {
          "path": "skills/detect-palladium-lead-silver-turns/workflows/monitor.md",
          "type": "blob",
          "size": 6681
        },
        {
          "path": "skills/detect-shanghai-silver-stock-drain",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-shanghai-silver-stock-drain/SKILL.md",
          "type": "blob",
          "size": 10216
        },
        {
          "path": "skills/detect-shanghai-silver-stock-drain/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-shanghai-silver-stock-drain/references/data-sources.md",
          "type": "blob",
          "size": 7162
        },
        {
          "path": "skills/detect-shanghai-silver-stock-drain/references/input-schema.md",
          "type": "blob",
          "size": 5094
        },
        {
          "path": "skills/detect-shanghai-silver-stock-drain/references/methodology.md",
          "type": "blob",
          "size": 5824
        },
        {
          "path": "skills/detect-shanghai-silver-stock-drain/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-shanghai-silver-stock-drain/templates/output-json.md",
          "type": "blob",
          "size": 5696
        },
        {
          "path": "skills/detect-shanghai-silver-stock-drain/templates/output-markdown.md",
          "type": "blob",
          "size": 5516
        },
        {
          "path": "skills/detect-shanghai-silver-stock-drain/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-shanghai-silver-stock-drain/workflows/analyze.md",
          "type": "blob",
          "size": 5341
        },
        {
          "path": "skills/detect-shanghai-silver-stock-drain/workflows/cross-validate.md",
          "type": "blob",
          "size": 4343
        },
        {
          "path": "skills/detect-shanghai-silver-stock-drain/workflows/fetch-data.md",
          "type": "blob",
          "size": 3457
        },
        {
          "path": "skills/detect-us-equity-valuation-percentile-extreme",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-us-equity-valuation-percentile-extreme/SKILL.md",
          "type": "blob",
          "size": 11456
        },
        {
          "path": "skills/detect-us-equity-valuation-percentile-extreme/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-us-equity-valuation-percentile-extreme/references/data-sources.md",
          "type": "blob",
          "size": 7888
        },
        {
          "path": "skills/detect-us-equity-valuation-percentile-extreme/references/input-schema.md",
          "type": "blob",
          "size": 6655
        },
        {
          "path": "skills/detect-us-equity-valuation-percentile-extreme/references/methodology.md",
          "type": "blob",
          "size": 8455
        },
        {
          "path": "skills/detect-us-equity-valuation-percentile-extreme/references/valuation-metrics.md",
          "type": "blob",
          "size": 6810
        },
        {
          "path": "skills/detect-us-equity-valuation-percentile-extreme/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-us-equity-valuation-percentile-extreme/templates/output-json.md",
          "type": "blob",
          "size": 7214
        },
        {
          "path": "skills/detect-us-equity-valuation-percentile-extreme/templates/output-markdown.md",
          "type": "blob",
          "size": 7311
        },
        {
          "path": "skills/detect-us-equity-valuation-percentile-extreme/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/detect-us-equity-valuation-percentile-extreme/workflows/execute-analysis.md",
          "type": "blob",
          "size": 4429
        },
        {
          "path": "skills/detect-us-equity-valuation-percentile-extreme/workflows/historical-episodes.md",
          "type": "blob",
          "size": 6514
        },
        {
          "path": "skills/detect-us-equity-valuation-percentile-extreme/workflows/visualize-analysis.md",
          "type": "blob",
          "size": 2860
        },
        {
          "path": "skills/evaluate-exponential-trend-deviation-regimes",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/evaluate-exponential-trend-deviation-regimes/SKILL.md",
          "type": "blob",
          "size": 4867
        },
        {
          "path": "skills/evaluate-exponential-trend-deviation-regimes/examples",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/evaluate-exponential-trend-deviation-regimes/examples/gold-trend-deviation.md",
          "type": "blob",
          "size": 3815
        },
        {
          "path": "skills/evaluate-exponential-trend-deviation-regimes/methodology.md",
          "type": "blob",
          "size": 4632
        },
        {
          "path": "skills/evaluate-exponential-trend-deviation-regimes/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/evaluate-exponential-trend-deviation-regimes/references/data-sources.md",
          "type": "blob",
          "size": 7961
        },
        {
          "path": "skills/evaluate-exponential-trend-deviation-regimes/references/input-schema.md",
          "type": "blob",
          "size": 6107
        },
        {
          "path": "skills/evaluate-exponential-trend-deviation-regimes/references/methodology.md",
          "type": "blob",
          "size": 936
        },
        {
          "path": "skills/evaluate-exponential-trend-deviation-regimes/references/regime-rules.md",
          "type": "blob",
          "size": 8693
        },
        {
          "path": "skills/evaluate-exponential-trend-deviation-regimes/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/evaluate-exponential-trend-deviation-regimes/templates/output-json.md",
          "type": "blob",
          "size": 5474
        },
        {
          "path": "skills/evaluate-exponential-trend-deviation-regimes/templates/output-markdown.md",
          "type": "blob",
          "size": 11123
        },
        {
          "path": "skills/evaluate-exponential-trend-deviation-regimes/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/evaluate-exponential-trend-deviation-regimes/workflows/compare.md",
          "type": "blob",
          "size": 4514
        },
        {
          "path": "skills/evaluate-exponential-trend-deviation-regimes/workflows/detect.md",
          "type": "blob",
          "size": 4795
        },
        {
          "path": "skills/evaluate-exponential-trend-deviation-regimes/workflows/macro.md",
          "type": "blob",
          "size": 6544
        },
        {
          "path": "skills/forecast-sector-relative-return-from-yield-spread",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/forecast-sector-relative-return-from-yield-spread/SKILL.md",
          "type": "blob",
          "size": 13459
        },
        {
          "path": "skills/forecast-sector-relative-return-from-yield-spread/methodology.md",
          "type": "blob",
          "size": 3070
        },
        {
          "path": "skills/forecast-sector-relative-return-from-yield-spread/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/forecast-sector-relative-return-from-yield-spread/references/data-sources.md",
          "type": "blob",
          "size": 10185
        },
        {
          "path": "skills/forecast-sector-relative-return-from-yield-spread/references/input-schema.md",
          "type": "blob",
          "size": 5618
        },
        {
          "path": "skills/forecast-sector-relative-return-from-yield-spread/references/method.md",
          "type": "blob",
          "size": 6984
        },
        {
          "path": "skills/forecast-sector-relative-return-from-yield-spread/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/forecast-sector-relative-return-from-yield-spread/templates/output-json.md",
          "type": "blob",
          "size": 6098
        },
        {
          "path": "skills/forecast-sector-relative-return-from-yield-spread/templates/output-markdown.md",
          "type": "blob",
          "size": 6909
        },
        {
          "path": "skills/forecast-sector-relative-return-from-yield-spread/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/forecast-sector-relative-return-from-yield-spread/workflows/analyze.md",
          "type": "blob",
          "size": 6541
        },
        {
          "path": "skills/forecast-sector-relative-return-from-yield-spread/workflows/data-research.md",
          "type": "blob",
          "size": 6481
        },
        {
          "path": "skills/google-trends-ath-detector",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/google-trends-ath-detector/SKILL.md",
          "type": "blob",
          "size": 8589
        },
        {
          "path": "skills/google-trends-ath-detector/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/google-trends-ath-detector/references/data-sources.md",
          "type": "blob",
          "size": 10727
        },
        {
          "path": "skills/google-trends-ath-detector/references/input-schema.md",
          "type": "blob",
          "size": 6335
        },
        {
          "path": "skills/google-trends-ath-detector/references/seasonality-guide.md",
          "type": "blob",
          "size": 8737
        },
        {
          "path": "skills/google-trends-ath-detector/references/signal-types.md",
          "type": "blob",
          "size": 7892
        },
        {
          "path": "skills/google-trends-ath-detector/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/google-trends-ath-detector/workflows/analyze.md",
          "type": "blob",
          "size": 6464
        },
        {
          "path": "skills/google-trends-ath-detector/workflows/compare.md",
          "type": "blob",
          "size": 6587
        },
        {
          "path": "skills/google-trends-ath-detector/workflows/detect.md",
          "type": "blob",
          "size": 3794
        },
        {
          "path": "skills/list-china-today-macro-news",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/list-china-today-macro-news/SKILL.md",
          "type": "blob",
          "size": 6981
        },
        {
          "path": "skills/list-china-today-macro-news/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/list-china-today-macro-news/references/data-sources.md",
          "type": "blob",
          "size": 3695
        },
        {
          "path": "skills/list-china-today-macro-news/templates.md",
          "type": "blob",
          "size": 2190
        },
        {
          "path": "skills/list-china-today-macro-news/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/list-china-today-macro-news/templates/news-report.md",
          "type": "blob",
          "size": 1410
        },
        {
          "path": "skills/list-china-today-macro-news/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/list-china-today-macro-news/workflows/fetch-releases.md",
          "type": "blob",
          "size": 2121
        },
        {
          "path": "skills/lithium-supply-demand-gap-radar",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/lithium-supply-demand-gap-radar/SKILL.md",
          "type": "blob",
          "size": 12486
        },
        {
          "path": "skills/lithium-supply-demand-gap-radar/methodology.md",
          "type": "blob",
          "size": 3282
        },
        {
          "path": "skills/lithium-supply-demand-gap-radar/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/lithium-supply-demand-gap-radar/references/data-sources.md",
          "type": "blob",
          "size": 7160
        },
        {
          "path": "skills/lithium-supply-demand-gap-radar/references/etf-holdings-structure.md",
          "type": "blob",
          "size": 9152
        },
        {
          "path": "skills/lithium-supply-demand-gap-radar/references/failure-modes.md",
          "type": "blob",
          "size": 9178
        },
        {
          "path": "skills/lithium-supply-demand-gap-radar/references/price-methodology.md",
          "type": "blob",
          "size": 7220
        },
        {
          "path": "skills/lithium-supply-demand-gap-radar/references/supply-chain-mapping.md",
          "type": "blob",
          "size": 10797
        },
        {
          "path": "skills/lithium-supply-demand-gap-radar/references/unit-conversion.md",
          "type": "blob",
          "size": 6567
        },
        {
          "path": "skills/lithium-supply-demand-gap-radar/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/lithium-supply-demand-gap-radar/templates/output-json.md",
          "type": "blob",
          "size": 10286
        },
        {
          "path": "skills/lithium-supply-demand-gap-radar/templates/output-markdown.md",
          "type": "blob",
          "size": 13435
        },
        {
          "path": "skills/lithium-supply-demand-gap-radar/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/lithium-supply-demand-gap-radar/workflows/balance-nowcast.md",
          "type": "blob",
          "size": 8790
        },
        {
          "path": "skills/lithium-supply-demand-gap-radar/workflows/etf-exposure.md",
          "type": "blob",
          "size": 9794
        },
        {
          "path": "skills/lithium-supply-demand-gap-radar/workflows/full-analysis.md",
          "type": "blob",
          "size": 8929
        },
        {
          "path": "skills/lithium-supply-demand-gap-radar/workflows/ingest.md",
          "type": "blob",
          "size": 11462
        },
        {
          "path": "skills/lithium-supply-demand-gap-radar/workflows/price-regime.md",
          "type": "blob",
          "size": 9221
        },
        {
          "path": "skills/monitor-etf-holdings-drawdown-risk",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/monitor-etf-holdings-drawdown-risk/SKILL.md",
          "type": "blob",
          "size": 9884
        },
        {
          "path": "skills/monitor-etf-holdings-drawdown-risk/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/monitor-etf-holdings-drawdown-risk/references/data-sources.md",
          "type": "blob",
          "size": 8330
        },
        {
          "path": "skills/monitor-etf-holdings-drawdown-risk/references/input-schema.md",
          "type": "blob",
          "size": 5632
        },
        {
          "path": "skills/monitor-etf-holdings-drawdown-risk/references/methodology.md",
          "type": "blob",
          "size": 5721
        },
        {
          "path": "skills/monitor-etf-holdings-drawdown-risk/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/monitor-etf-holdings-drawdown-risk/templates/output-json.md",
          "type": "blob",
          "size": 6456
        },
        {
          "path": "skills/monitor-etf-holdings-drawdown-risk/templates/output-markdown.md",
          "type": "blob",
          "size": 4735
        },
        {
          "path": "skills/monitor-etf-holdings-drawdown-risk/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/monitor-etf-holdings-drawdown-risk/workflows/analyze.md",
          "type": "blob",
          "size": 5999
        },
        {
          "path": "skills/monitor-etf-holdings-drawdown-risk/workflows/cross-validate.md",
          "type": "blob",
          "size": 7183
        },
        {
          "path": "skills/monitor-etf-holdings-drawdown-risk/workflows/monitor.md",
          "type": "blob",
          "size": 4882
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/README.md",
          "type": "blob",
          "size": 6199
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/SKILL.md",
          "type": "blob",
          "size": 10391
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/examples",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/examples/analysis_report.md",
          "type": "blob",
          "size": 3559
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/methodology.md",
          "type": "blob",
          "size": 1892
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/references/concentration-metrics.md",
          "type": "blob",
          "size": 9675
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/references/data-sources.md",
          "type": "blob",
          "size": 7535
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/references/failure-modes.md",
          "type": "blob",
          "size": 11226
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/references/indonesia-supply-structure.md",
          "type": "blob",
          "size": 6744
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/references/mine-level-anchors.md",
          "type": "blob",
          "size": 8599
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/references/unit-conversion.md",
          "type": "blob",
          "size": 7451
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/templates/output-json.md",
          "type": "blob",
          "size": 10647
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/templates/output-markdown.md",
          "type": "blob",
          "size": 5703
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/workflows/analyze.md",
          "type": "blob",
          "size": 6112
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/workflows/ingest.md",
          "type": "blob",
          "size": 8066
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/workflows/scenario-engine.md",
          "type": "blob",
          "size": 7018
        },
        {
          "path": "skills/nickel-concentration-risk-analyzer/workflows/validate-sources.md",
          "type": "blob",
          "size": 6361
        },
        {
          "path": "skills/track-agri-hedge-fund-positioning",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/track-agri-hedge-fund-positioning/SKILL.md",
          "type": "blob",
          "size": 10369
        },
        {
          "path": "skills/track-agri-hedge-fund-positioning/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/track-agri-hedge-fund-positioning/references/contracts-map.md",
          "type": "blob",
          "size": 5661
        },
        {
          "path": "skills/track-agri-hedge-fund-positioning/references/data-sources.md",
          "type": "blob",
          "size": 7287
        },
        {
          "path": "skills/track-agri-hedge-fund-positioning/references/input-schema.md",
          "type": "blob",
          "size": 7193
        },
        {
          "path": "skills/track-agri-hedge-fund-positioning/references/macro-indicators.md",
          "type": "blob",
          "size": 8179
        },
        {
          "path": "skills/track-agri-hedge-fund-positioning/references/methodology.md",
          "type": "blob",
          "size": 6751
        },
        {
          "path": "skills/track-agri-hedge-fund-positioning/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/track-agri-hedge-fund-positioning/templates/annotations.md",
          "type": "blob",
          "size": 9964
        },
        {
          "path": "skills/track-agri-hedge-fund-positioning/templates/output-json.md",
          "type": "blob",
          "size": 6275
        },
        {
          "path": "skills/track-agri-hedge-fund-positioning/templates/output-markdown.md",
          "type": "blob",
          "size": 6719
        },
        {
          "path": "skills/track-agri-hedge-fund-positioning/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/track-agri-hedge-fund-positioning/workflows/analyze.md",
          "type": "blob",
          "size": 5374
        },
        {
          "path": "skills/track-agri-hedge-fund-positioning/workflows/cross-check.md",
          "type": "blob",
          "size": 8170
        },
        {
          "path": "skills/track-agri-hedge-fund-positioning/workflows/monitor.md",
          "type": "blob",
          "size": 5247
        },
        {
          "path": "skills/track-agri-hedge-fund-positioning/workflows/visualize.md",
          "type": "blob",
          "size": 5853
        },
        {
          "path": "skills/track-equity-cumulative-return",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/track-equity-cumulative-return/SKILL.md",
          "type": "blob",
          "size": 15294
        },
        {
          "path": "skills/track-equity-cumulative-return/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/track-equity-cumulative-return/references/data-sources.md",
          "type": "blob",
          "size": 3498
        },
        {
          "path": "skills/track-equity-cumulative-return/references/index-components.md",
          "type": "blob",
          "size": 4472
        },
        {
          "path": "skills/track-equity-cumulative-return/references/input-schema.md",
          "type": "blob",
          "size": 4878
        },
        {
          "path": "skills/track-equity-cumulative-return/references/methodology.md",
          "type": "blob",
          "size": 3766
        },
        {
          "path": "skills/track-equity-cumulative-return/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/track-equity-cumulative-return/templates/output-json.md",
          "type": "blob",
          "size": 6187
        },
        {
          "path": "skills/track-equity-cumulative-return/templates/output-markdown.md",
          "type": "blob",
          "size": 3599
        },
        {
          "path": "skills/track-equity-cumulative-return/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/track-equity-cumulative-return/workflows/compare.md",
          "type": "blob",
          "size": 3868
        },
        {
          "path": "skills/track-equity-cumulative-return/workflows/quick-check.md",
          "type": "blob",
          "size": 2787
        },
        {
          "path": "skills/track-equity-cumulative-return/workflows/top-n.md",
          "type": "blob",
          "size": 5063
        },
        {
          "path": "skills/us-cpi-pce-comparator",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/us-cpi-pce-comparator/SKILL.md",
          "type": "blob",
          "size": 7518
        },
        {
          "path": "skills/us-cpi-pce-comparator/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/us-cpi-pce-comparator/references/cpi-pce-methodology.md",
          "type": "blob",
          "size": 6080
        },
        {
          "path": "skills/us-cpi-pce-comparator/references/data-sources.md",
          "type": "blob",
          "size": 6342
        },
        {
          "path": "skills/us-cpi-pce-comparator/references/implementation.md",
          "type": "blob",
          "size": 13539
        },
        {
          "path": "skills/us-cpi-pce-comparator/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/us-cpi-pce-comparator/templates/output-json.md",
          "type": "blob",
          "size": 4469
        },
        {
          "path": "skills/us-cpi-pce-comparator/templates/output-markdown.md",
          "type": "blob",
          "size": 5090
        },
        {
          "path": "skills/us-cpi-pce-comparator/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/us-cpi-pce-comparator/workflows/analyze.md",
          "type": "blob",
          "size": 4435
        },
        {
          "path": "skills/us-cpi-pce-comparator/workflows/quick-check.md",
          "type": "blob",
          "size": 2750
        },
        {
          "path": "skills/usd-reserve-loss-gold-revaluation",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/usd-reserve-loss-gold-revaluation/SKILL.md",
          "type": "blob",
          "size": 10353
        },
        {
          "path": "skills/usd-reserve-loss-gold-revaluation/methodology.md",
          "type": "blob",
          "size": 946
        },
        {
          "path": "skills/usd-reserve-loss-gold-revaluation/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/usd-reserve-loss-gold-revaluation/references/data-sources.md",
          "type": "blob",
          "size": 9784
        },
        {
          "path": "skills/usd-reserve-loss-gold-revaluation/references/input-schema.md",
          "type": "blob",
          "size": 8413
        },
        {
          "path": "skills/usd-reserve-loss-gold-revaluation/references/methods.md",
          "type": "blob",
          "size": 7373
        },
        {
          "path": "skills/usd-reserve-loss-gold-revaluation/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/usd-reserve-loss-gold-revaluation/templates/output-json.md",
          "type": "blob",
          "size": 9634
        },
        {
          "path": "skills/usd-reserve-loss-gold-revaluation/templates/output-markdown.md",
          "type": "blob",
          "size": 5802
        },
        {
          "path": "skills/usd-reserve-loss-gold-revaluation/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/usd-reserve-loss-gold-revaluation/workflows/analyze.md",
          "type": "blob",
          "size": 6060
        },
        {
          "path": "skills/usd-reserve-loss-gold-revaluation/workflows/compare.md",
          "type": "blob",
          "size": 4164
        },
        {
          "path": "skills/usd-reserve-loss-gold-revaluation/workflows/monitor.md",
          "type": "blob",
          "size": 5574
        },
        {
          "path": "skills/wasde-ingestor",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/wasde-ingestor/SKILL.md",
          "type": "blob",
          "size": 8954
        },
        {
          "path": "skills/wasde-ingestor/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/wasde-ingestor/references/commodities-overview.md",
          "type": "blob",
          "size": 4900
        },
        {
          "path": "skills/wasde-ingestor/references/cotton.md",
          "type": "blob",
          "size": 4933
        },
        {
          "path": "skills/wasde-ingestor/references/failure-modes.md",
          "type": "blob",
          "size": 8482
        },
        {
          "path": "skills/wasde-ingestor/references/grains.md",
          "type": "blob",
          "size": 7449
        },
        {
          "path": "skills/wasde-ingestor/references/livestock.md",
          "type": "blob",
          "size": 6761
        },
        {
          "path": "skills/wasde-ingestor/references/oilseeds.md",
          "type": "blob",
          "size": 5854
        },
        {
          "path": "skills/wasde-ingestor/references/sugar.md",
          "type": "blob",
          "size": 5424
        },
        {
          "path": "skills/wasde-ingestor/references/validation-rules.md",
          "type": "blob",
          "size": 7657
        },
        {
          "path": "skills/wasde-ingestor/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/wasde-ingestor/workflows/backfill.md",
          "type": "blob",
          "size": 8192
        },
        {
          "path": "skills/wasde-ingestor/workflows/configure.md",
          "type": "blob",
          "size": 7349
        },
        {
          "path": "skills/wasde-ingestor/workflows/ingest.md",
          "type": "blob",
          "size": 7442
        },
        {
          "path": "skills/wasde-ingestor/workflows/validate.md",
          "type": "blob",
          "size": 10943
        },
        {
          "path": "skills/zeberg-salomon-rotator",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/zeberg-salomon-rotator/SKILL.md",
          "type": "blob",
          "size": 8794
        },
        {
          "path": "skills/zeberg-salomon-rotator/references",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/zeberg-salomon-rotator/references/data-sources.md",
          "type": "blob",
          "size": 5089
        },
        {
          "path": "skills/zeberg-salomon-rotator/references/input-schema.md",
          "type": "blob",
          "size": 7823
        },
        {
          "path": "skills/zeberg-salomon-rotator/references/methodology.md",
          "type": "blob",
          "size": 6583
        },
        {
          "path": "skills/zeberg-salomon-rotator/templates",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/zeberg-salomon-rotator/templates/output-json.md",
          "type": "blob",
          "size": 7765
        },
        {
          "path": "skills/zeberg-salomon-rotator/templates/output-markdown.md",
          "type": "blob",
          "size": 4583
        },
        {
          "path": "skills/zeberg-salomon-rotator/workflows",
          "type": "tree",
          "size": null
        },
        {
          "path": "skills/zeberg-salomon-rotator/workflows/analyze.md",
          "type": "blob",
          "size": 5017
        },
        {
          "path": "skills/zeberg-salomon-rotator/workflows/backtest.md",
          "type": "blob",
          "size": 4224
        },
        {
          "path": "skills/zeberg-salomon-rotator/workflows/monitor.md",
          "type": "blob",
          "size": 3779
        },
        {
          "path": "skills/zeberg-salomon-rotator/workflows/visualize.md",
          "type": "blob",
          "size": 2032
        }
      ],
      "files": {
        ".claude-plugin/README.md": "# Macro Skills - Claude Plugin Marketplace\n\n宏觀經濟技能市集，專為宏觀經濟分析設計的 Claude 技能集合。\n\n## 安裝方式\n\n在 Claude 中執行以下指令即可安裝整個技能市集：\n\n```\n/plugin marketplace add fatfingererr/macro-skills\n```\n\n## 包含技能\n\n市集目前包含以下技能：\n\n- **經濟指標分析師** - 分析 GDP、CPI、失業率、PMI 等經濟指標\n- **央行政策解碼器** - 解讀央行聲明、會議紀要、政策訊號\n- **景氣循環判官** - 判斷當前景氣位置、預測週期轉折點\n\n## 技能分類\n\n市集將技能分為 18 個類別：\n\n1. 資料處理\n2. 指標監控\n3. 即時預測\n4. 景氣週期\n5. 通膨分析\n6. 勞動市場\n7. 消費需求\n8. 產業景氣\n9. 房市居住\n10. 央行操作\n11. 政策模型\n12. 存貸利率\n13. 外匯因子\n14. 跨境金流\n15. 信用風險\n16. 流動性條件\n17. 商品供需\n18. 事件情境\n\n## 資料等級\n\n每個技能都標示其資料來源成本等級：\n\n- **免費不限量** (green) - 無 API key 需求、寬鬆存取限制\n- **免費有限制** (yellow) - 有 API 呼叫次數限制\n- **小額付費** (blue) - $5-$50/月\n- **高額付費** (purple) - $100-$1000+/月\n- **企業授權** (red) - 合約制\n\n## 進階操作\n\n```bash\n# 列出所有可用技能\n/plugin marketplace list macro-skills\n\n# 啟用特定技能\n/plugin marketplace enable macro-skills/economic-indicator-analyst\n\n# 停用特定技能\n/plugin marketplace disable macro-skills/economic-indicator-analyst\n\n# 更新 marketplace\n/plugin marketplace update macro-skills\n\n# 移除 marketplace\n/plugin marketplace remove macro-skills\n```\n\n## 使用方式\n\n安裝後，您可以直接與 Claude 對話，Claude 會自動選擇適合的技能來處理您的請求：\n\n```\n請幫我分析最新的 CPI 數據\n```\n\n或明確指定技能：\n\n```\n使用經濟指標分析師，分析最新的非農就業報告\n```\n\n## 授權\n\nMIT License\n\n## 連結\n\n- 網站：https://fatfingererr.github.io/macro-skills/\n- GitHub：https://github.com/fatfingererr/macro-skills\n",
        ".claude-plugin/manifest.json": "{\n  \"$schema\": \"https://claude.ai/schemas/plugin-manifest.json\",\n  \"id\": \"macro-skills\",\n  \"name\": \"Macro Skills\",\n  \"displayName\": \"宏觀經濟技能市集\",\n  \"version\": \"1.0.0\",\n  \"description\": \"專為宏觀經濟分析設計的 Claude 技能集合，涵蓋經濟指標、央行政策、景氣循環等領域\",\n  \"author\": {\n    \"name\": \"fatfingererr\",\n    \"url\": \"https://github.com/fatfingererr/macro-skills\"\n  },\n  \"license\": \"MIT\",\n  \"repository\": {\n    \"type\": \"git\",\n    \"url\": \"https://github.com/fatfingererr/macro-skills.git\"\n  },\n  \"homepage\": \"https://fatfingererr.github.io/macro-skills/\",\n  \"type\": \"marketplace\",\n  \"marketplace\": {\n    \"configPath\": \"marketplace.json\",\n    \"skillsPath\": \"../skills\",\n    \"indexPath\": \"index.json\"\n  },\n  \"compatibility\": {\n    \"claude\": \">=1.0.0\"\n  },\n  \"keywords\": [\n    \"economics\",\n    \"macro\",\n    \"finance\",\n    \"analysis\",\n    \"indicators\"\n  ]\n}",
        ".claude-plugin/marketplace.json": "{\n  \"name\": \"macro-skills\",\n  \"owner\": {\n    \"name\": \"fatfingererr\",\n    \"email\": \"fatfingererr@gmail.com\"\n  },\n  \"metadata\": {\n    \"description\": \"專為宏觀經濟分析設計的 Claude 技能集合\",\n    \"version\": \"1.0.0\"\n  },\n  \"plugins\": [\n    {\n      \"name\": \"zeberg-salomon-rotator\",\n      \"description\": \"用領先和即時指標建構景氣模型，並判讀兩種景氣階段：景氣擴張與景氣收縮期，並根據理論給出\\\"撞冰山\\\"與\\\"下沉\\\"事件訊號\",\n      \"version\": \"0.1.2\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/zeberg-salomon-rotator\",\n      \"category\": \"business-cycles\",\n      \"tags\": [\n        \"景氣循環\",\n        \"領先指標\",\n        \"同時指標\",\n        \"景氣擴張\",\n        \"景氣收縮\",\n        \"FRED\"\n      ]\n    },\n    {\n      \"name\": \"usd-reserve-loss-gold-revaluation\",\n      \"description\": \"在「美元／某貨幣失去儲備地位、黃金成為唯一錨」的假設下，用央行貨幣負債 ÷ 黃金儲備，推演「資產負債表可承受的隱含金價」，並輸出各國/各貨幣的槓桿程度、缺口與排名\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/usd-reserve-loss-gold-revaluation\",\n      \"category\": \"fx-factors\",\n      \"tags\": [\n        \"黃金\",\n        \"央行\",\n        \"儲備貨幣\",\n        \"美元\",\n        \"M0\",\n        \"M2\"\n      ]\n    },\n    {\n      \"name\": \"compute-precious-miner-gross-margin\",\n      \"description\": \"以公開金屬價格 + 礦業成本指標（AISC/All-in cost/現金成本）計算「黃金/白銀礦業毛利率代理值」，並判斷當前是否處於歷史高/低檔區間。\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/compute-precious-miner-gross-margin\",\n      \"category\": \"commodity-sd\",\n      \"tags\": [\n        \"貴金屬\",\n        \"黃金\",\n        \"白銀\",\n        \"礦業\",\n        \"AISC\",\n        \"毛利率\"\n      ]\n    },\n    {\n      \"name\": \"us-cpi-pce-comparator\",\n      \"description\": \"自動比較 CPI（固定權重）與 PCE（動態權重）的通膨訊號，識別低波動高權重桶位的 PCE 上行風險。用於分析 Fed 關注的 PCE 是否正在 re-accelerate，即使 CPI 看似降溫。\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/us-cpi-pce-comparator\",\n      \"category\": \"inflation-analytics\",\n      \"tags\": [\n        \"CPI\",\n        \"PCE\",\n        \"通膨\",\n        \"Fed\",\n        \"權重差異\",\n        \"FRED\"\n      ]\n    },\n    {\n      \"name\": \"track-equity-cumulative-return\",\n      \"description\": \"追蹤股票/指數的累積報酬率，支援多標的比較、指數成分股 Top N 排名，並與 S&P 500 作為基準進行比較，並輸出視覺化圖表。\",\n      \"version\": \"0.1.1\",\n      \"author\": {\n        \"name\": \"macro-skills\"\n      },\n      \"source\": \"./skills/track-equity-cumulative-return\",\n      \"category\": \"indicator-monitoring\",\n      \"tags\": [\n        \"股票\",\n        \"美股\",\n        \"YTD\",\n        \"累積報酬\",\n        \"股票指數\",\n        \"基準比較\"\n      ]\n    },\n    {\n      \"name\": \"wasde-ingestor\",\n      \"description\": \"抓取並解析 USDA（美國農業部）每月發布的 WASDE（世界農產品供需估計）報告，擷取所有主要商品（穀物、油籽、棉花、畜產品、糖）的供需平衡表。產出經標準化、具版本控管的資料集，作為即時預測的基準錨點。\",\n      \"version\": \"0.2.0\",\n      \"author\": {\n        \"name\": \"macro-skills\"\n      },\n      \"source\": \"./skills/wasde-ingestor\",\n      \"category\": \"nowcasting\",\n      \"tags\": []\n    },\n    {\n      \"name\": \"track-agri-hedge-fund-positioning\",\n      \"description\": \"用 COT 非商業部位變化，量化對沖基金在農產品期貨的資金流向，並把出口需求、USDA 數據、美元/原油/金屬等宏觀風向整合成可交易的敘事與訊號。\",\n      \"version\": \"0.1.1\",\n      \"author\": {\n        \"name\": \"macro-skills\"\n      },\n      \"source\": \"./skills/track-agri-hedge-fund-positioning\",\n      \"category\": \"commodity-sd\",\n      \"tags\": [\n        \"COT\",\n        \"農產品\",\n        \"穀物\",\n        \"油籽\",\n        \"肉類\",\n        \"軟性商品\"\n      ]\n    },\n    {\n      \"name\": \"nickel-concentration-risk-analyzer\",\n      \"description\": \"以全球鎳供給結構為核心，量化各國的主導程度（例如印尼）、主要礦區供給量、以及政策配額/減產情境對全球供需平衡與價格非對稱的影響。\",\n      \"version\": \"0.1.1\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/nickel-concentration-risk-analyzer\",\n      \"category\": \"event-scenario\",\n      \"tags\": [\n        \"鎳\",\n        \"供給集中度\",\n        \"原物料\",\n        \"採礦\",\n        \"地緣政治\",\n        \"情境分析\"\n      ]\n    },\n    {\n      \"name\": \"lithium-supply-demand-gap-radar\",\n      \"description\": \"將鋰產業鏈（礦端 → 精煉化學品 → 電池與終端需求），整合為一套可運算的替代指標；再把這些指標映射到鋰主題 ETF（如 LIT）的成分暴露與長期價格走勢，形成可供決策的依據。 \",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/lithium-supply-demand-gap-radar\",\n      \"category\": \"commodity-sd\",\n      \"tags\": [\n        \"鋰\",\n        \"供需分析\",\n        \"ETF\",\n        \"LIT\",\n        \"原物料\",\n        \"電池\"\n      ]\n    },\n    {\n      \"name\": \"google-trends-ath-detector\",\n      \"description\": \"模擬真人操作瀏覽器抓取 Google Trends 數據，自動判定搜尋趨勢是否創下歷史新高（ATH）或出現異常飆升，並提供訊號分類。\",\n      \"version\": \"0.1.1\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/google-trends-ath-detector\",\n      \"category\": \"indicator-monitoring\",\n      \"tags\": [\n        \"Google Trends\",\n        \"ATH\",\n        \"歷史新高\",\n        \"情緒指標\",\n        \"異常偵測\",\n        \"搜尋趨勢\"\n      ]\n    },\n    {\n      \"name\": \"list-china-today-macro-news\",\n      \"description\": \"彙整今日中國宏觀經濟新聞消息，從華爾街日報、36氪等來源抓取並篩選宏觀相關新聞，輸出雜誌風格的新聞摘要。適用於交易/研究開盤前快速掌握中國宏觀動態。\",\n      \"version\": \"0.3.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/list-china-today-macro-news\",\n      \"category\": \"nowcasting\",\n      \"tags\": [\n        \"中國\",\n        \"宏觀經濟\",\n        \"新聞\",\n        \"華爾街日報\",\n        \"央行\",\n        \"利率\"\n      ]\n    },\n    {\n      \"name\": \"forecast-sector-relative-return-from-yield-spread\",\n      \"description\": \"用美債殖利率曲線利差（如 2Y-10Y）建立領先關係，推估未來一段時間內成長股（Nasdaq 100）相對防禦股（Healthcare/XLV）的相對績效方向與幅度。\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/forecast-sector-relative-return-from-yield-spread\",\n      \"category\": \"interest-rates\",\n      \"tags\": [\n        \"殖利率\",\n        \"利差\",\n        \"領先指標\",\n        \"相對報酬\",\n        \"QQQ\",\n        \"XLV\"\n      ]\n    },\n    {\n      \"name\": \"monitor-etf-holdings-drawdown-risk\",\n      \"description\": \"偵測「商品價格上漲、但對應實物 ETF/信託持倉卻下滑」的背離現象，並用多指標交叉驗證，評估是否存在實物供給緊張/交割壓力風險\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/monitor-etf-holdings-drawdown-risk\",\n      \"category\": \"indicator-monitoring\",\n      \"tags\": [\n        \"ETF\",\n        \"持倉監控\",\n        \"背離分析\",\n        \"實物短缺\",\n        \"白銀\",\n        \"黃金\"\n      ]\n    },\n    {\n      \"name\": \"evaluate-exponential-trend-deviation-regimes\",\n      \"description\": \"計算資產價格相對長期指數成長趨勢線的偏離度，衡量當前是否處於歷史極端區間，並可選擇性地進行宏觀因子分析以判斷行情體質。\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/evaluate-exponential-trend-deviation-regimes\",\n      \"category\": \"business-cycles\",\n      \"tags\": [\n        \"趨勢\",\n        \"偏離度\",\n        \"歷史峰值\",\n        \"指數成長\",\n        \"技術分析\",\n        \"宏觀分析\"\n      ]\n    },\n    {\n      \"name\": \"detect-us-equity-valuation-percentile-extreme\",\n      \"description\": \"把多個股票估值指標統一轉成在過去百年歷史中的分位數，再合成一個總分，判斷目前是否處於歷史極端高估區間，並用歷史類比（如 1929、1965、1999）給出風險解讀\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/detect-us-equity-valuation-percentile-extreme\",\n      \"category\": \"indicator-monitoring\",\n      \"tags\": [\n        \"估值\",\n        \"分位數\",\n        \"CAPE\",\n        \"本益比\",\n        \"巴菲特指標\",\n        \"GDP\"\n      ]\n    },\n    {\n      \"name\": \"detect-shanghai-silver-stock-drain\",\n      \"description\": \"以公開交易所庫存資料為核心，量化上海白銀庫存耗盡的方向、速度與加速度，並將其轉成可交易的供給緊縮訊號\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/detect-shanghai-silver-stock-drain\",\n      \"category\": \"commodity-sd\",\n      \"tags\": [\n        \"白銀\",\n        \"庫存監控\",\n        \"上海黃金交易所\",\n        \"上海期交所\",\n        \"供給緊縮\",\n        \"耗盡訊號\"\n      ]\n    },\n    {\n      \"name\": \"detect-palladium-lead-silver-turns\",\n      \"description\": \"以鈀金的先行轉向作為確認條件，檢驗白銀短期漲跌是否獲得工業景氣與風險情緒的同步支持，並標記缺乏鈀金參與度的失敗走勢。\",\n      \"version\": \"0.1.1\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/detect-palladium-lead-silver-turns\",\n      \"category\": \"indicator-monitoring\",\n      \"tags\": [\n        \"鈀金\",\n        \"白銀\",\n        \"貴金屬\",\n        \"拐點偵測\",\n        \"領先指標\",\n        \"跨金屬確認\"\n      ]\n    },\n    {\n      \"name\": \"detect-freight-led-inflation-turn\",\n      \"description\": \"透過美國卡斯貨運指數 (CASS Freight Index) 的週期轉折，偵測美國通膨壓力是否進入放緩或反轉階段。用於判斷「通膨是否正在降溫」，並驗證市場對降息、通膨回落的宏觀敘事是否有實體經濟數據支撐。\",\n      \"version\": \"0.1.1\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/detect-freight-led-inflation-turn\",\n      \"category\": \"inflation-analytics\",\n      \"tags\": [\n        \"卡斯貨運指數\",\n        \"貨運\",\n        \"企業運費\",\n        \"通貨膨脹\",\n        \"領先指標\",\n        \"CPI\"\n      ]\n    },\n    {\n      \"name\": \"detect-fed-unamortized-discount-pattern\",\n      \"description\": \"檢查聯準會持有證券的未攤銷折價（Unamortized Discounts）是否出現與特定歷史危機期間相似的走勢模板，並用多指標交叉驗證是否真的屬於「金融壓力升高」而非單純會計/利率效果\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/detect-fed-unamortized-discount-pattern\",\n      \"category\": \"liquidity-fci\",\n      \"tags\": [\n        \"聯準會\",\n        \"未攤銷折價\",\n        \"WUDSHO\",\n        \"流動性風險\",\n        \"金融壓力\",\n        \"交叉驗證\"\n      ]\n    },\n    {\n      \"name\": \"detect-atr-squeeze-regime\",\n      \"description\": \"以 14 日指數平滑 ATR 偵測市場是否從秩序型趨勢轉為波動主導的擠壓（squeeze）行情，並輸出對技術位、停損、交易持有期的可行性評估。\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/detect-atr-squeeze-regime\",\n      \"category\": \"indicator-monitoring\",\n      \"tags\": [\n        \"ATR\",\n        \"波動率\",\n        \"擠壓行情\",\n        \"停損管理\",\n        \"風險控制\",\n        \"技術分析\"\n      ]\n    },\n    {\n      \"name\": \"demographic-fiscal-trap-analyzer\",\n      \"description\": \"分析人口老化、債務動態、官僚膨脹與通膨稀釋交互作用下的「財政陷阱」風險，量化各國/地區的財政脆弱度並識別潛在的貨幣稀釋路徑\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"macro-skills\"\n      },\n      \"source\": \"./skills/demographic-fiscal-trap-analyzer\",\n      \"category\": \"policy-modeling\",\n      \"tags\": [\n        \"人口\",\n        \"人口結構\",\n        \"財政政策\",\n        \"債務動能\",\n        \"通貨膨脹\",\n        \"人口老化\"\n      ]\n    },\n    {\n      \"name\": \"cost-density-net-rr-calculator\",\n      \"description\": \"計算非線性交易成本對風險報酬比的影響。將固定手續費與買賣價差整合為統一的成本密度（Cost Density）指標，揭示停損幅度與策略效率之間呈現雙曲線式的關係。\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"macro-skills\"\n      },\n      \"source\": \"./skills/cost-density-net-rr-calculator\",\n      \"category\": \"indicator-monitoring\",\n      \"tags\": []\n    },\n    {\n      \"name\": \"backsolve-miner-vs-metal-ratio-with-fundamentals\",\n      \"description\": \"從網路自動抓取礦業公司財務報表與營運揭露（產量、成本、資本支出），回算「礦業股/金屬本體比率」的基本面解釋與區間門檻（如 1.2/1.7），並輸出可重現的估值拆解（成本因子 / 槓桿因子 / 倍數因子 / 稀釋因子）。\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/backsolve-miner-vs-metal-ratio-with-fundamentals\",\n      \"category\": \"commodity-sd\",\n      \"tags\": [\n        \"礦業股\",\n        \"基本面\",\n        \"AISC\",\n        \"槓桿\",\n        \"倍數\",\n        \"稀釋\"\n      ]\n    },\n    {\n      \"name\": \"analyze-silver-miner-metal-ratio\",\n      \"description\": \"以「銀礦股價格 / 白銀價格」的相對比率衡量礦業股板塊相對於金屬本體的估值區間（偏貴/偏便宜），並用歷史分位數與類比區間推導「底部/頂部」訊號與情境推演。\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/analyze-silver-miner-metal-ratio\",\n      \"category\": \"commodity-sd\",\n      \"tags\": [\n        \"白銀\",\n        \"礦業股\",\n        \"SIL\",\n        \"SILJ\",\n        \"相對估值\",\n        \"分位數\"\n      ]\n    },\n    {\n      \"name\": \"analyze-rolex-market-index-liquidity-proxy\",\n      \"description\": \"用勞力士市場指數（WatchCharts Rolex Market Index）作為高 β 的風險偏好／流動性代理，建立可重現的公開數據流程，判讀「流動性改善但未到投機狂熱」的狀態\",\n      \"version\": \"0.1.1\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/analyze-rolex-market-index-liquidity-proxy\",\n      \"category\": \"liquidity-fci\",\n      \"tags\": [\n        \"勞力士市場指數\",\n        \"Rolex\",\n        \"流動性\",\n        \"美聯儲\",\n        \"實質利率\",\n        \"二級市場\"\n      ]\n    },\n    {\n      \"name\": \"analyze-platinum-to-brazil-equities-transmission\",\n      \"description\": \"使用公開市場資料量化驗證鉑/白金對巴西股市（EWZ）的長週期傳導/連動關係，輸出雙軸圖、領先落後分析、關聯強度分數與監控訊號。\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/analyze-platinum-to-brazil-equities-transmission\",\n      \"category\": \"indicator-monitoring\",\n      \"tags\": [\n        \"白金\",\n        \"巴西\",\n        \"EWZ\",\n        \"鉑\",\n        \"原物料\",\n        \"股市\"\n      ]\n    },\n    {\n      \"name\": \"analyze-us-bank-credit-deposit-decoupling\",\n      \"description\": \"分析銀行貸款與存款之間的「信貸創造脫鉤」現象，用以辨識聯準會緊縮政策在銀行體系內部的真實傳導效果。\",\n      \"version\": \"0.1.1\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/analyze-us-bank-credit-deposit-decoupling\",\n      \"category\": \"credit-risk\",\n      \"tags\": [\n        \"QT\",\n        \"聯準會\",\n        \"銀行信貸\",\n        \"存款\",\n        \"RRP\",\n        \"隱性緊縮\"\n      ]\n    },\n    {\n      \"name\": \"analyze-move-risk-gauges-leadlag\",\n      \"description\": \"用公開市場數據檢查「利率波動率（MOVE）是否對利率事件（如 JGB 殖利率變動）不恐慌，並且是否領先帶動 VIX / 信用利差走低」\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/analyze-move-risk-gauges-leadlag\",\n      \"category\": \"interest-rates\",\n      \"tags\": [\n        \"利率波動率\",\n        \"MOVE\",\n        \"VIX\",\n        \"信用利差\",\n        \"領先落後\",\n        \"事件分析\"\n      ]\n    },\n    {\n      \"name\": \"analyze-jgb-insurer-superlong-flow\",\n      \"description\": \"從日本保險公司對長端/超長端 JGB 的淨買入(淨賣出) 時間序列，自動產出「本月是否創紀錄賣超、連續賣超月數、期間累積賣超」等結論。\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/analyze-jgb-insurer-superlong-flow\",\n      \"category\": \"interest-rates\",\n      \"tags\": [\n        \"日本\",\n        \"JGB\",\n        \"保險公司\",\n        \"長債\",\n        \"淨買賣\",\n        \"JSDA\"\n      ]\n    },\n    {\n      \"name\": \"analyze-japan-debt-service-tax-burden\",\n      \"description\": \"以日本公債殖利率變化為觸發，量化「政府利息支出 / 稅收」負擔（含情境壓力測試），並判斷是否進入債務利息螺旋風險區。\",\n      \"version\": \"0.1.1\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/analyze-japan-debt-service-tax-burden\",\n      \"category\": \"interest-rates\",\n      \"tags\": [\n        \"日本\",\n        \"國債\",\n        \"債務\",\n        \"利息支出\",\n        \"稅收\",\n        \"壓力測試\"\n      ]\n    },\n    {\n      \"name\": \"analyze-investment-clock-rotation\",\n      \"description\": \"把「獲利成長 × 財務狀況（金融環境）」映射成「投資時鐘」，判斷目前落在哪個象限、近期是順時針還是逆時針旋轉、以及相對於上一輪循環的位置差異\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/analyze-investment-clock-rotation\",\n      \"category\": \"business-cycles\",\n      \"tags\": [\n        \"投資時鐘\",\n        \"景氣循環\",\n        \"獲利成長\",\n        \"金融環境\",\n        \"資產配置\",\n        \"象限分析\"\n      ]\n    },\n    {\n      \"name\": \"analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios\",\n      \"description\": \"在「失業率走高／勞動市場轉弱」但「名目或實質 GDP 仍維持高位（或仍在成長）」的情境下，依據歷史關聯估算美國財政赤字占 GDP（Deficit/GDP）可能擴張的區間，並生成對長天期美債（長久期 UST）供給/利率風險的情境解讀。\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios\",\n      \"category\": \"macro-indicator\",\n      \"tags\": [\n        \"失業率\",\n        \"GDP\",\n        \"財政赤字\",\n        \"勞動市場\",\n        \"JOLTS\",\n        \"薩姆規則\"\n      ]\n    },\n    {\n      \"name\": \"analyze-gas-fertilizer-contract-shock\",\n      \"description\": \"用天然氣與化肥價格的日頻數據，檢驗「天然氣暴漲→化肥供應受限/毀約→化肥飆價」敘事是否成立，輸出可標註到圖上的關鍵轉折點與領先落後分析。\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/analyze-gas-fertilizer-contract-shock\",\n      \"category\": \"event-scenario\",\n      \"tags\": [\n        \"天然氣\",\n        \"化肥\",\n        \"尿素\",\n        \"原物料\",\n        \"事件分析\",\n        \"不可抗力\"\n      ]\n    },\n    {\n      \"name\": \"analyze-copper-supply-concentration-risk\",\n      \"description\": \"用公開資料量化「銅供應是否過度集中、主要產地是否結構性衰退、替代增量是否依賴少數國家」，並輸出可行的中期供應風險結論與情境推演。\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/analyze-copper-supply-concentration-risk\",\n      \"category\": \"commodity-sd\",\n      \"tags\": [\n        \"銅\",\n        \"供給集中度\",\n        \"原物料\",\n        \"採礦\",\n        \"地緣政治\",\n        \"情境分析\"\n      ]\n    },\n    {\n      \"name\": \"analyze-copper-stock-resilience-dependency\",\n      \"description\": \"用跨資產訊號（全球股市韌性 + 中國利率環境）評估銅價能否突破關卡或進入「回補/回踩」到支撐的機率與路徑\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/analyze-copper-stock-resilience-dependency\",\n      \"category\": \"indicator-monitoring\",\n      \"tags\": [\n        \"銅價\",\n        \"股市韌性\",\n        \"跨資產分析\",\n        \"中國利率\",\n        \"關卡突破\",\n        \"回補分析\"\n      ]\n    },\n    {\n      \"name\": \"analyze-copper-inventory-rebuild-signal\",\n      \"description\": \"用「庫存快速回補」作為短期警戒訊號，評估銅價是否接近短線高點，同時給出一個「長期是否偏便宜」的歷史分位數判讀。\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Ricky Wang\"\n      },\n      \"source\": \"./skills/analyze-copper-inventory-rebuild-signal\",\n      \"category\": \"commodity-sd\",\n      \"tags\": [\n        \"銅\",\n        \"庫存\",\n        \"SHFE\",\n        \"COMEX\",\n        \"期貨\",\n        \"技術分析\"\n      ]\n    }\n  ]\n}",
        "skills/analyze-copper-inventory-rebuild-signal/SKILL.md": "---\nname: analyze-copper-inventory-rebuild-signal\ndescription: 用「庫存快速回補」作為短期警戒訊號，評估銅價是否接近短線高點，同時給出一個「長期是否偏便宜」的歷史分位數判讀。\n---\n\n<essential_principles>\n\n<principle name=\"dual_signal_framework\">\n**雙層訊號框架（Dual Signal Framework）**\n\n本技能將「肉眼看圖」轉換為可量化、可自動更新的雙層訊號系統：\n\n| 層次 | 問題 | 核心指標 | 決策輸出 |\n|------|------|----------|----------|\n| **短線** | 是否「有點超前」？ | SHFE 回補速度 z-score + 庫存水位 | CAUTION / NEUTRAL / SUPPORTIVE |\n| **長線** | 是否「仍偏便宜」？ | 銅價歷史分位數（10 年） | CHEAP / FAIR / RICH |\n\n**關鍵洞察**：SHFE 庫存快速回補 + 水位偏高 → 常常貼近價格局部高點。\n</principle>\n\n<principle name=\"data_source\">\n**數據來源（三類數據）**\n\n使用 Chrome CDP **全自動**抓取 Highcharts 圖表數據，共需三類數據：\n\n| 數據 | 來源 | URL |\n|------|------|-----|\n| SHFE 銅庫存 | MacroMicro (CDP) | https://en.macromicro.me/series/8743/copper-shfe-warehouse-stock |\n| COMEX 銅庫存 | MacroMicro (CDP) | https://www.macromicro.me/series/8742/copper-comex-warehouse-stock |\n| 銅期貨價格 | Yahoo Finance | `HG=F`（COMEX 銅期貨連續近月） |\n\n**口徑**：庫存為可交割銅庫存（噸）、價格為收盤價（USD/lb）\n</principle>\n\n<principle name=\"rebuild_speed_zscore\">\n**回補速度 Z-Score 計算**\n\n將主觀「回補很快」轉化為客觀可比較的標準化指標：\n\n```\nrebuild_W = inv_t - inv_{t-W}  (W = 4 週)\nz_score = (rebuild_W - μ) / σ   (μ, σ 為 3 年滾動)\n```\n\n- z-score > 1.5：回補速度「異常快」\n- z-score > 2.0：回補速度「極端快」\n- z-score < -1.5：去庫存速度「異常快」\n</principle>\n\n</essential_principles>\n\n<objective>\n分析銅庫存回補訊號與價格的歷史關係，輸出：\n1. **短期訊號**：當前回補速度與庫存水位是否觸發「謹慎」訊號\n2. **長期判讀**：銅價是否仍處於歷史偏便宜區間\n3. **歷史驗證**：過去同類訊號對應價格高點的命中率\n</objective>\n\n<quick_start>\n\n**全自動執行（無需手動操作 Chrome）**\n\n**Step 1：安裝依賴**\n```bash\npip install requests websocket-client pandas numpy yfinance matplotlib\n```\n\n**Step 2：一鍵抓取所有數據（SHFE + COMEX 庫存 + 銅價）**\n```bash\ncd skills/analyze-copper-inventory-rebuild-signal/scripts\npython fetch_copper_data.py\n```\n\n腳本會自動：\n- 啟動 Chrome 調試模式\n- 依序抓取 SHFE 和 COMEX 庫存（~80 秒）\n- 抓取銅期貨價格（Yahoo Finance）\n- 儲存到 `cache/shfe_inventory.csv`、`cache/comex_inventory.csv`、`cache/copper_price.csv`\n- 關閉 Chrome\n\n**Step 3：執行庫存訊號分析**\n```bash\npython inventory_signal_analyzer.py\n```\n\n**Step 4：生成視覺化圖表**\n```bash\npython visualize_inventory_signal.py\n```\n\n**輸出**：`{專案根目錄}/output/copper_inventory_signal_YYYY-MM-DD.png`\n\n</quick_start>\n\n<intake>\n需要進行什麼分析？\n\n1. **快速檢查** - 查看當前 SHFE 庫存回補訊號狀態\n2. **完整分析** - 執行回補訊號與價格高點的歷史驗證\n3. **長期分位數** - 銅價歷史分位數判讀（10 年）\n4. **視覺化** - 生成 Bloomberg 風格分析圖表\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response | Action |\n|----------|--------|\n| 1, \"快速\", \"quick\", \"check\", \"狀態\" | 執行 `python scripts/inventory_signal_analyzer.py --quick` |\n| 2, \"完整\", \"full\", \"驗證\", \"backtest\" | 執行 `python scripts/inventory_signal_analyzer.py --full` |\n| 3, \"長期\", \"分位數\", \"percentile\", \"cheap\" | 執行 `python scripts/inventory_signal_analyzer.py --long-term` |\n| 4, \"圖表\", \"chart\", \"視覺化\", \"visualize\" | 執行 `python scripts/visualize_inventory_signal.py` |\n\n**路由後，執行對應命令。**\n</routing>\n\n<directory_structure>\n```\nanalyze-copper-inventory-rebuild-signal/\n├── SKILL.md                              # 本文件（路由器）\n├── manifest.json                         # 技能元資料\n├── skill.yaml                            # 前端展示元數據\n├── scripts/\n│   ├── fetch_copper_data.py              # 全自動 CDP 數據爬蟲（SHFE + COMEX + 價格）\n│   ├── fetch_shfe_inventory.py           # SHFE 專用爬蟲（向下相容）\n│   ├── inventory_signal_analyzer.py      # 核心分析邏輯\n│   └── visualize_inventory_signal.py     # Bloomberg 風格視覺化\n├── references/\n│   ├── data-sources.md                   # 數據來源說明\n│   ├── methodology.md                    # 方法論說明\n│   └── historical-episodes.md            # 歷史事件對照\n├── templates/\n│   ├── output-json.md                    # JSON 輸出格式\n│   └── output-markdown.md                # Markdown 輸出格式\n├── workflows/\n│   ├── quick-check.md                    # 快速檢查流程\n│   ├── full-analysis.md                  # 完整分析流程\n│   └── visualize.md                      # 視覺化流程\n├── cache/\n│   ├── shfe_inventory.csv                # SHFE 庫存快取\n│   ├── comex_inventory.csv               # COMEX 庫存快取\n│   └── copper_price.csv                  # 銅價快取\n└── examples/\n    └── sample_output.json                # 範例輸出\n\n# 視覺化輸出位置（專案根目錄）\n{專案根目錄}/output/\n└── copper_inventory_signal_YYYY-MM-DD.png  # 輸出圖表（含日期）\n```\n</directory_structure>\n\n<scripts_index>\n| Script | Command | Purpose |\n|--------|---------|---------|\n| fetch_copper_data.py | `python fetch_copper_data.py` | 全自動抓取所有數據（SHFE + COMEX + 價格） |\n| fetch_copper_data.py | `--force-refresh` | 強制重新抓取（忽略快取） |\n| fetch_copper_data.py | `--source shfe` | 只抓取 SHFE 庫存 |\n| fetch_copper_data.py | `--source comex` | 只抓取 COMEX 庫存 |\n| fetch_copper_data.py | `--source price` | 只抓取銅價 |\n| inventory_signal_analyzer.py | `--quick` | 快速檢查當前訊號狀態 |\n| inventory_signal_analyzer.py | `--full` | 完整歷史驗證分析 |\n| inventory_signal_analyzer.py | `--long-term` | 長期價格分位數分析 |\n| visualize_inventory_signal.py | 無參數 | 生成 Bloomberg 風格圖表（輸出到專案根目錄 output/） |\n| visualize_inventory_signal.py | `-o path.png` | 指定輸出路徑 |\n</scripts_index>\n\n<input_parameters>\n\n**分析參數**\n\n| 參數 | 類型 | 預設值 | 說明 |\n|------|------|--------|------|\n| `start_date` | string | 2015-01-01 | 回測起始日 |\n| `end_date` | string | today | 回測結束日 |\n| `price_ticker` | string | HG=F | 銅期貨代碼（Yahoo Finance） |\n| `price_freq` | string | weekly | 價格頻率（daily/weekly） |\n| `fast_rebuild_window_weeks` | int | 4 | 「快速回補」觀察窗（週） |\n| `fast_rebuild_z` | float | 1.5 | 回補速度 z-score 門檻 |\n| `high_inventory_mode` | string | percentile | 庫存偏高判定模式（absolute/percentile） |\n| `high_inventory_percentile` | float | 0.85 | 庫存偏高分位數門檻 |\n| `peak_match_window_weeks` | int | 2 | 訊號對應價格高點的容許窗口（±N 週） |\n| `long_term_window_years` | int | 10 | 長期分位數計算窗口（年） |\n| `cheap_percentile` | float | 0.35 | 「長期偏便宜」門檻 |\n\n</input_parameters>\n\n<visualization>\n\n**視覺化輸出：Bloomberg 風格銅庫存回補訊號儀表板**\n\n遵循 `thoughts/shared/guide/bloomberg-style-chart-guide.md` 規範設計。\n\n包含三個區塊（上中下排列）：\n\n1. **銅價 + 總庫存對照**（雙軸圖）\n   - R1 右軸：銅價（橙紅色線）\n   - L2 左軸：總庫存面積圖（SHFE + COMEX 疊加）\n   - 標記 CAUTION 訊號觸發點\n   - 最新價格標註\n\n2. **回補速度 z-score**（時序圖）\n   - SHFE z-score：面積填充（紅/青色區分回補/去庫存）\n   - COMEX z-score：虛線疊加\n   - 門檻線（z=1.5, z=2.0, z=-1.5）\n\n3. **訊號狀態儀表板**\n   - 短期訊號區塊（CAUTION/NEUTRAL/SUPPORTIVE）\n   - 長期判斷區塊（CHEAP/FAIR/RICH）\n   - SHFE/COMEX z-score 即時數值\n\n**配色**：Bloomberg 深色主題（依據 bloomberg-style-chart-guide.md）\n- 背景: `#1a1a2e`（深藍黑色）\n- 網格: `#2d2d44`（暗灰紫）\n- 銅價（primary）: `#ff6b35`（橙紅色）\n- SHFE 庫存（secondary）: `#ffaa00`（橙黃色）\n- COMEX 庫存（tertiary）: `#ffff00`（黃色）\n- CAUTION 訊號: `#ff4444`（紅色）\n- SUPPORTIVE: `#00ff88`（綠色）\n- 中性: `#888888`（灰色）\n\n**快速繪圖**：\n```bash\ncd scripts\npython visualize_inventory_signal.py\n```\n\n**輸出路徑**：`{專案根目錄}/output/copper_inventory_signal_YYYY-MM-DD.png`\n\n圖表會自動輸出到專案根目錄的 `output/` 資料夾，檔名包含當天日期。\n\n</visualization>\n\n<output_example>\n\n**Markdown 輸出範例**\n\n```markdown\n# 銅：庫存回補訊號（SHFE / COMEX）\n\n## 最新狀態\n- 數據日期：2026-01-26\n- SHFE 庫存：235,000 噸\n- SHFE 4 週回補速度 z-score：+1.9（異常快）\n- COMEX 庫存：18,500 噸\n- COMEX 4 週回補速度 z-score：+0.5（正常）\n- 總庫存（SHFE + COMEX）：253,500 噸\n- 銅期貨價格：4.52 USD/lb\n\n## 短期判斷（是否「有點超前」）\n- 訊號：**⚠️ CAUTION**\n- 原因：SHFE 庫存「水位偏高」且「回補速度異常快」\n- 歷史驗證：過去同類訊號在 ±2 週內對應局部高點的命中率約 **62%**\n- 解讀：短線更容易出現「漲勢喘口氣 / 回檔」而不是一路順風\n\n## 長期判斷（是否仍「偏便宜」）\n- 銅價 10 年歷史分位數：0.32（低於 0.35）\n- 結論：**💚 長期偏便宜**（但不代表短線不會先整理）\n\n---\n### 數據來源\n- SHFE 庫存：MacroMicro (CDP)\n- COMEX 庫存：MacroMicro (CDP)\n- 銅價：Yahoo Finance (HG=F)\n```\n\n**JSON 輸出範例**\n\n```json\n{\n  \"asof\": \"2026-01-26\",\n  \"near_term_signal\": \"CAUTION\",\n  \"long_term_view\": \"CHEAP\",\n  \"latest\": {\n    \"shfe_inventory_tonnes\": 235000,\n    \"shfe_rebuild_z\": 1.9,\n    \"comex_inventory_tonnes\": 18500,\n    \"comex_rebuild_z\": 0.5,\n    \"total_inventory_tonnes\": 253500,\n    \"copper_price\": 4.52,\n    \"price_percentile\": 0.32\n  },\n  \"backtest\": {\n    \"peak_match_window_weeks\": 2,\n    \"signal_to_local_peak_hit_rate\": 0.62,\n    \"signal_count\": 21\n  }\n}\n```\n\n</output_example>\n\n<success_criteria>\n分析成功時應產出：\n\n- [x] SHFE 和 COMEX 庫存數據已從 MacroMicro **全自動**抓取並快取\n- [x] 銅期貨價格數據已從 Yahoo Finance 抓取\n- [x] SHFE 和 COMEX 當前回補速度 z-score 與庫存分位數\n- [x] 短期訊號（CAUTION / NEUTRAL / SUPPORTIVE）\n- [x] 歷史訊號命中率回測結果\n- [x] 長期價格分位數與判讀（CHEAP / FAIR / RICH）\n- [x] **Bloomberg 風格視覺化圖表**\n- [x] 明確標註數據來源與計算方法\n</success_criteria>\n\n<references_index>\n| 文件 | 內容 |\n|------|------|\n| references/data-sources.md | SHFE 庫存與銅價數據來源、CDP 抓取說明 |\n| references/methodology.md | 回補速度 z-score、分位數計算方法論 |\n| references/historical-episodes.md | 歷史訊號觸發事件對照 |\n</references_index>\n\n<workflows_index>\n| Workflow | Purpose |\n|----------|---------|\n| workflows/quick-check.md | 快速檢查當前訊號狀態 |\n| workflows/full-analysis.md | 完整歷史驗證分析 |\n| workflows/visualize.md | 視覺化圖表生成 |\n</workflows_index>\n\n<templates_index>\n| Template | Purpose |\n|----------|---------|\n| templates/output-json.md | JSON 輸出格式規範 |\n| templates/output-markdown.md | Markdown 輸出格式規範 |\n</templates_index>\n",
        "skills/analyze-copper-inventory-rebuild-signal/references/data-sources.md": "<overview>\n此參考文件列出銅庫存回補訊號分析所需的資料來源，包括 SHFE/COMEX 庫存的 MacroMicro 爬蟲說明與銅價來源。\n\n**資料來源（三類數據）**：\n- **SHFE 銅庫存**：MacroMicro Highcharts 圖表\n- **COMEX 銅庫存**：MacroMicro Highcharts 圖表\n- **銅期貨價格**：Yahoo Finance HG=F\n\n**推薦方法**：Chrome CDP（繞過 Cloudflare）\n</overview>\n\n<shfe_inventory>\n\n**SHFE 銅庫存數據**\n\n| 屬性 | 值 |\n|------|-----|\n| 名稱 | SHFE Copper Warehouse Stock |\n| URL | https://en.macromicro.me/series/8743/copper-shfe-warehouse-stock |\n| 頻率 | 週（每週五公布） |\n| 單位 | 噸 (tonnes) |\n| 歷史 | 2003 年起 |\n| 更新延遲 | ~1 週 |\n\n**欄位說明**：\n\n| 欄位 | 說明 |\n|------|------|\n| date | 數據日期 |\n| inventory_tonnes | SHFE 可交割銅庫存量（噸） |\n\n**抓取方法**：Chrome CDP（推薦）\n\n詳見 [Chrome CDP 數據爬取 SOP](../../../thoughts/shared/guide/chrome-cdp-scraping-sop.md)\n\n</shfe_inventory>\n\n<comex_inventory>\n\n**COMEX 銅庫存數據**\n\n| 屬性 | 值 |\n|------|-----|\n| 名稱 | COMEX Copper Warehouse Stock |\n| URL | https://www.macromicro.me/series/8742/copper-comex-warehouse-stock |\n| 頻率 | 日（可轉週） |\n| 單位 | 噸 (tonnes) |\n| 歷史 | 1990 年代起 |\n| 更新延遲 | ~1-2 天 |\n\n**欄位說明**：\n\n| 欄位 | 說明 |\n|------|------|\n| date | 數據日期 |\n| inventory_tonnes | COMEX 可交割銅庫存量（噸） |\n\n**抓取方法**：Chrome CDP（推薦）\n\n與 SHFE 使用相同的抓取流程，由 `fetch_copper_data.py` 統一處理。\n\n</comex_inventory>\n\n<copper_price>\n\n**銅期貨價格數據**\n\n| 屬性 | 值 |\n|------|-----|\n| 名稱 | COMEX Copper Futures (HG=F) |\n| 來源 | Yahoo Finance |\n| 頻率 | 日（可轉週） |\n| 單位 | USD/lb |\n| 歷史 | 2000 年起 |\n\n**抓取方法**：yfinance Python 套件\n\n```python\nimport yfinance as yf\n\ndata = yf.download(\"HG=F\", start=\"2015-01-01\", end=\"2026-01-26\")\n```\n\n**注意事項**：\n- HG=F 為連續近月合約\n- 存在換倉日的價格跳躍\n- 建議使用週收盤價減少噪音\n\n</copper_price>\n\n<cdp_method>\n\n**Chrome CDP 方法（推薦）**\n\n透過 Chrome DevTools Protocol 連接到已開啟的 Chrome 瀏覽器，完全繞過 Cloudflare 和反爬蟲偵測。\n\n**原理**：\n```\n┌─────────────────┐     WebSocket      ┌─────────────────┐\n│  Python Script  │ ◄────────────────► │  Chrome Browser │\n│  (CDP Client)   │    Port 9222       │  (你的 Profile) │\n└─────────────────┘                    └─────────────────┘\n        │                                      │\n        │ Runtime.evaluate()                   │\n        ▼                                      ▼\n   執行 JavaScript ──────────────────► 提取 Highcharts 數據\n```\n\n**自動化流程**：\n\n本技能的 `fetch_shfe_inventory.py` 腳本實現全自動流程：\n\n1. 檢查是否已有 Chrome 調試實例\n2. 若無，自動啟動 Chrome（帶調試端口）\n3. 等待頁面載入（~40 秒）\n4. 透過 CDP 執行 JavaScript 提取 Highcharts 數據\n5. 關閉 Chrome（若是本次啟動的）\n\n**使用方式**：\n```bash\ncd scripts\npython fetch_shfe_inventory.py\n```\n\n**強制更新**：\n```bash\npython fetch_shfe_inventory.py --force-refresh\n```\n\n</cdp_method>\n\n<cache_strategy>\n\n**快取策略**\n\n| 參數 | 值 | 說明 |\n|------|-----|------|\n| 快取目錄 | `./cache` | 預設 |\n| 最大有效期 | 12 小時 | 庫存為週數據 |\n| SHFE 快取 | `shfe_inventory.csv` | SHFE 庫存數據 |\n| COMEX 快取 | `comex_inventory.csv` | COMEX 庫存數據 |\n| 價格快取 | `copper_price.csv` | 銅期貨價格 |\n\n**使用快取**：\n```bash\npython scripts/fetch_copper_data.py  # 自動使用快取\n```\n\n**強制更新**：\n```bash\npython scripts/fetch_copper_data.py --force-refresh\n```\n\n**只更新特定數據**：\n```bash\npython scripts/fetch_copper_data.py --source shfe      # 只抓 SHFE\npython scripts/fetch_copper_data.py --source comex     # 只抓 COMEX\npython scripts/fetch_copper_data.py --source price     # 只抓價格\n```\n\n</cache_strategy>\n\n<update_schedule>\n\n**資料更新時程**\n\n| 資料 | 來源 | 更新頻率 | 延遲 | 建議抓取時機 |\n|------|------|---------|------|-------------|\n| SHFE 庫存 | MacroMicro | 週 | ~7 天 | 每週一 |\n| COMEX 庫存 | MacroMicro | 日 | ~1-2 天 | 每日 |\n| 銅期貨價格 | Yahoo Finance | 日 | ~1 天 | 每日 |\n\n**監控建議**：\n- 每週一檢查 SHFE 庫存更新\n- COMEX 庫存每日可更新\n- 設定快取有效期為 12 小時\n- 重大經濟事件後可手動更新\n\n</update_schedule>\n\n<fallback_sources>\n\n**備用數據源**\n\n若 MacroMicro 無法存取：\n\n1. **上海期貨交易所官網**\n   - http://www.shfe.com.cn/\n   - 需手動查詢日報/週報\n\n2. **其他庫存來源**\n   | 來源 | 庫存類型 | 取得難度 |\n   |------|----------|----------|\n   | CME Group | COMEX 倉庫庫存 | 需爬蟲 |\n   | LME | LME 倉庫庫存 | 需訂閱 |\n   | 中國海關 | 進出口數據 | 月度滯後 |\n\n</fallback_sources>\n\n<troubleshooting>\n\n**常見問題排解**\n\n**Q1: WebSocket 連線被拒絕 (403 Forbidden)**\n\n確認啟動 Chrome 時有加上 `--remote-allow-origins=*` 參數。\n\n**Q2: 無法連接到 Chrome 調試端口**\n\n1. 確保所有 Chrome 視窗都已關閉\n2. 確認使用了非預設的 `--user-data-dir`\n3. 檢查端口 9222 是否被佔用：`curl -s http://127.0.0.1:9222/json`\n\n**Q3: Highcharts not found**\n\n1. 確認頁面已完全載入（圖表已顯示）\n2. 在瀏覽器 Console 中執行 `typeof Highcharts` 確認\n3. 可能需要登入 MacroMicro 帳號\n\n**Q4: 被 Cloudflare 擋住**\n\n1. 使用 CDP 方法而非 Selenium\n2. 在 Chrome 中手動完成 Cloudflare 驗證\n3. 登入 MacroMicro 帳號後再執行\n\n**Q5: yfinance 無法取得數據**\n\n1. 確認網路連線正常\n2. 嘗試更新 yfinance：`pip install --upgrade yfinance`\n3. 檢查 ticker symbol 是否正確（HG=F）\n\n</troubleshooting>\n\n<related_guides>\n\n**相關指南**\n\n- [Chrome CDP 數據爬取 SOP](../../../thoughts/shared/guide/chrome-cdp-scraping-sop.md)\n- [MacroMicro Highcharts 爬蟲指南](../../../thoughts/shared/guide/macromicro-highcharts-crawler.md)\n\n</related_guides>\n",
        "skills/analyze-copper-inventory-rebuild-signal/references/historical-episodes.md": "<overview>\n此參考文件列出 SHFE 銅庫存回補訊號的歷史觸發事件，以及與價格走勢的對照分析。\n</overview>\n\n<notable_episodes>\n\n**重要歷史事件**\n\n以下列出「SHFE 庫存快速回補 + 水位偏高」訊號觸發後的價格走勢案例。\n\n---\n\n**2018 年 3-4 月：貿易戰初期**\n\n| 項目 | 數值 |\n|------|------|\n| 訊號觸發日 | 2018-03-16 |\n| SHFE 庫存 | ~380,000 噸 |\n| 回補速度 z-score | +2.1 |\n| 銅價（觸發時） | 3.15 USD/lb |\n| 銅價（4 週後） | 3.05 USD/lb |\n| 回檔幅度 | -3.2% |\n| 訊號命中 | ✅ 是 |\n\n**背景**：美中貿易戰升溫，市場避險情緒上升，前期備貨後需求轉弱。\n\n---\n\n**2019 年 4 月：復活節前補庫**\n\n| 項目 | 數值 |\n|------|------|\n| 訊號觸發日 | 2019-04-12 |\n| SHFE 庫存 | ~320,000 噸 |\n| 回補速度 z-score | +1.8 |\n| 銅價（觸發時） | 2.92 USD/lb |\n| 銅價（4 週後） | 2.78 USD/lb |\n| 回檔幅度 | -4.8% |\n| 訊號命中 | ✅ 是 |\n\n**背景**：節前補庫完成，Q2 需求不如預期。\n\n---\n\n**2020 年 1 月：疫情前夕**\n\n| 項目 | 數值 |\n|------|------|\n| 訊號觸發日 | 2020-01-17 |\n| SHFE 庫存 | ~190,000 噸 |\n| 回補速度 z-score | +1.6 |\n| 銅價（觸發時） | 2.82 USD/lb |\n| 銅價（4 週後） | 2.55 USD/lb |\n| 回檔幅度 | -9.6% |\n| 訊號命中 | ✅ 是（超額命中） |\n\n**背景**：COVID-19 疫情爆發前的最後一波補庫，隨後價格崩跌。\n\n---\n\n**2021 年 2 月：農曆新年效應**\n\n| 項目 | 數值 |\n|------|------|\n| 訊號觸發日 | 2021-02-19 |\n| SHFE 庫存 | ~250,000 噸 |\n| 回補速度 z-score | +2.3 |\n| 銅價（觸發時） | 4.18 USD/lb |\n| 銅價（4 週後） | 4.05 USD/lb |\n| 回檔幅度 | -3.1% |\n| 訊號命中 | ✅ 是 |\n\n**背景**：春節假期前大量補庫，節後需求釋放前的短暫調整。\n\n---\n\n**2021 年 5 月：歷史高點區域**\n\n| 項目 | 數值 |\n|------|------|\n| 訊號觸發日 | 2021-05-07 |\n| SHFE 庫存 | ~280,000 噸 |\n| 回補速度 z-score | +1.7 |\n| 銅價（觸發時） | 4.76 USD/lb |\n| 銅價（4 週後） | 4.52 USD/lb |\n| 回檔幅度 | -5.0% |\n| 訊號命中 | ✅ 是（接近歷史高點） |\n\n**背景**：銅價創歷史新高附近，庫存快速回補暗示短期過熱。\n\n---\n\n**2022 年 3 月：俄烏衝突後**\n\n| 項目 | 數值 |\n|------|------|\n| 訊號觸發日 | 2022-03-04 |\n| SHFE 庫存 | ~310,000 噸 |\n| 回補速度 z-score | +2.0 |\n| 銅價（觸發時） | 4.85 USD/lb |\n| 銅價（4 週後） | 4.68 USD/lb |\n| 回檔幅度 | -3.5% |\n| 訊號命中 | ✅ 是 |\n\n**背景**：地緣政治避險後的短線高點。\n\n</notable_episodes>\n\n<failed_signals>\n\n**訊號失敗案例**\n\n並非所有訊號都成功預測價格高點，以下列出訊號「失效」的案例。\n\n---\n\n**2020 年 11 月：疫情後復甦**\n\n| 項目 | 數值 |\n|------|------|\n| 訊號觸發日 | 2020-11-20 |\n| SHFE 庫存 | ~200,000 噸 |\n| 回補速度 z-score | +1.6 |\n| 銅價（觸發時） | 3.35 USD/lb |\n| 銅價（4 週後） | 3.55 USD/lb |\n| 變化 | +6.0%（續漲） |\n| 訊號命中 | ❌ 否 |\n\n**失敗原因**：\n- 疫情後需求復甦強勁\n- 全球寬鬆貨幣政策\n- 新能源需求敘事推升預期\n\n---\n\n**2023 年 1 月：中國解封樂觀**\n\n| 項目 | 數值 |\n|------|------|\n| 訊號觸發日 | 2023-01-13 |\n| SHFE 庫存 | ~240,000 噸 |\n| 回補速度 z-score | +1.8 |\n| 銅價（觸發時） | 4.08 USD/lb |\n| 銅價（4 週後） | 4.15 USD/lb |\n| 變化 | +1.7%（小幅續漲） |\n| 訊號命中 | ❌ 否（邊界案例） |\n\n**失敗原因**：\n- 中國清零政策結束後的樂觀情緒\n- 市場預期需求復甦\n\n</failed_signals>\n\n<pattern_observations>\n\n**規律觀察**\n\n從歷史案例中可觀察到以下規律：\n\n**1. 季節性因素**\n\n| 時間 | 特性 | 訊號可靠度 |\n|------|------|-----------|\n| 農曆新年前（1-2月） | 季節性補庫 | 較低（假陽性多） |\n| 春節後（3-4月） | 需求驗證期 | 較高 |\n| Q4 年底 | 補庫 + 年度結算 | 中等 |\n\n**2. 宏觀背景影響**\n\n| 背景 | 訊號效果 |\n|------|----------|\n| 避險情緒上升（地緣政治） | 較可靠 |\n| 需求復甦初期 | 可能失效 |\n| 政策刺激期 | 可能失效 |\n| 衰退擔憂期 | 較可靠 |\n\n**3. 庫存絕對水位**\n\n| 庫存水位 | 訊號可靠度 |\n|----------|-----------|\n| > 350,000 噸 | 高 |\n| 250,000 ~ 350,000 噸 | 中等 |\n| < 250,000 噸 | 較低 |\n\n</pattern_observations>\n\n<signal_statistics>\n\n**訊號統計（2015-2025）**\n\n| 統計項目 | 數值 |\n|----------|------|\n| CAUTION 訊號觸發次數 | ~25 次 |\n| 命中次數（±2 週內局部高點） | ~15 次 |\n| 整體命中率 | ~60% |\n| 平均回檔幅度（命中案例） | -4.2% |\n| 最大回檔幅度 | -15%（2020 疫情） |\n| 最大失效（續漲幅度） | +12%（2020 復甦） |\n\n**不同時期的命中率**：\n\n| 時期 | 訊號次數 | 命中率 |\n|------|----------|--------|\n| 2015-2017 | 6 | 67% |\n| 2018-2019 | 5 | 80% |\n| 2020-2021 | 8 | 50%（疫情干擾） |\n| 2022-2025 | 6 | 67% |\n\n</signal_statistics>\n\n<usage_recommendations>\n\n**使用建議**\n\n基於歷史分析，建議：\n\n1. **不要單獨使用**\n   - 命中率 ~60% 僅略優於隨機\n   - 需搭配其他指標交叉驗證\n\n2. **考慮宏觀背景**\n   - 政策刺激期/需求復甦期：降低訊號權重\n   - 避險情緒期/需求轉弱期：提高訊號權重\n\n3. **季節性調整**\n   - 農曆新年前的訊號：謹慎對待\n   - 節後 2-3 週的訊號：更有參考價值\n\n4. **關注絕對水位**\n   - 庫存 > 300,000 噸時的訊號更可靠\n   - 庫存 < 200,000 噸時的訊號可能是假陽性\n\n5. **動態監控**\n   - 定期更新命中率統計\n   - 若近期命中率顯著下降，考慮調整參數或暫停使用\n\n</usage_recommendations>\n",
        "skills/analyze-copper-inventory-rebuild-signal/references/methodology.md": "**核心假說：「SHFE 銅庫存快速回補，且水位處於高檔」→「短線價格更可能出現局部高點」**\n\n這個假說基於以下邏輯：\n1. 庫存快速回補代表下游需求可能已經前置完成\n2. 庫存處於高檔代表潛在拋售壓力\n3. 兩者同時發生時，價格上漲動能可能減弱\n\n**注意**：這是概率訊號，非確定性預測。\n\n---\n\n## 數據來源架構\n\n本技能使用以下數據，分別扮演不同角色：\n\n| 數據         | 來源                 | 頻率 | 角色               |\n|--------------|----------------------|------|--------------------|\n| SHFE 銅庫存  | MacroMicro (CDP)     | 週   | **主要訊號源**     |\n| COMEX 銅庫存 | MacroMicro (CDP)     | 日   | **輔助驗證**       |\n| 銅期貨價格   | Yahoo Finance (HG=F) | 日   | **長期分位數判讀** |\n\n### 為什麼使用雙庫存來源？\n\n**SHFE（上海期貨交易所）**：\n- 中國消費全球約 50% 的精煉銅\n- 反映中國銅需求的即時變化\n- 作為**主要訊號來源**\n\n**COMEX（芝加哥商品交易所）**：\n- 反映北美/西方市場庫存\n- 作為**輔助驗證來源**\n- 與 SHFE 同向時，訊號更可靠\n\n**總庫存（SHFE + COMEX）**：\n- 反映全球可見庫存趨勢\n- 用於判斷整體供需格局\n\n---\n\n## 回補速度 Z-Score 計算\n\n將主觀「回補很快」轉化為客觀可比較的標準化指標。\n\n### Step 1: 計算 W 週累積回補量\n\n```\nrebuild_W(t) = inventory(t) - inventory(t - W)\n```\n\n- W = 4 週（預設）\n- 正值代表「回補」\n- 負值代表「去庫存」\n\n**注意**：SHFE 和 COMEX 各自獨立計算，不混合。\n\n### Step 2: 計算滾動均值與標準差\n\n```\nμ = rolling_mean(rebuild_W, window=156)   # 3 年滾動\nσ = rolling_std(rebuild_W, window=156)\n```\n\n### Step 3: 計算 Z-Score\n\n```\nz(t) = (rebuild_W(t) - μ) / σ\n```\n\n**Z-Score 解讀**：\n\n| Z-Score 範圍 | 解讀               | 短期訊號貢獻  |\n|--------------|--------------------|---------------|\n| > 2.0        | 回補速度「極端快」 | 強 CAUTION    |\n| 1.5 ~ 2.0    | 回補速度「異常快」 | CAUTION       |\n| -1.5 ~ 1.5   | 正常範圍           | NEUTRAL       |\n| -2.0 ~ -1.5  | 去庫存「異常快」   | SUPPORTIVE    |\n| < -2.0       | 去庫存「極端快」   | 強 SUPPORTIVE |\n\n### 為什麼用 3 年滾動？\n\n1. 庫存行為會隨市場結構變化（期貨持倉規模、套利策略）\n2. 3 年足夠捕捉近期特性，又有足夠樣本（~156 週）\n3. 避免遠期極端值過度影響\n4. **SHFE 和 COMEX 各自計算**，保持獨立的基準線\n\n### 代碼範例\n\n```python\nW = 4  # 4 週窗口\nbaseline_weeks = 156  # 3 年滾動\n\n# SHFE z-score\nshfe_df['rebuild_W'] = shfe_df['inventory_tonnes'] - shfe_df['inventory_tonnes'].shift(W)\nmu = shfe_df['rebuild_W'].rolling(baseline_weeks, min_periods=52).mean()\nsigma = shfe_df['rebuild_W'].rolling(baseline_weeks, min_periods=52).std()\nshfe_df['rebuild_z'] = (shfe_df['rebuild_W'] - mu) / sigma\n\n# COMEX z-score（獨立計算）\ncomex_df['rebuild_W'] = comex_df['inventory_tonnes'] - comex_df['inventory_tonnes'].shift(W)\nmu_c = comex_df['rebuild_W'].rolling(baseline_weeks, min_periods=52).mean()\nsigma_c = comex_df['rebuild_W'].rolling(baseline_weeks, min_periods=52).std()\ncomex_df['rebuild_z'] = (comex_df['rebuild_W'] - mu_c) / sigma_c\n```\n\n---\n\n## 庫存水位分位數\n\n判斷當前庫存水位在歷史分布中的位置。\n\n### 計算方法\n\n```\npercentile(t) = (inventory(t) - min) / (max - min)\n```\n\n其中 min, max 為過去 N 年（預設 10 年）的最小/最大值。\n\n### 門檻判定\n\n| 分位數      | 解讀         | 短期訊號貢獻     |\n|-------------|--------------|------------------|\n| ≥ 0.85      | 庫存「偏高」 | CAUTION 前提條件 |\n| 0.35 ~ 0.85 | 庫存「正常」 | 中性             |\n| ≤ 0.35      | 庫存「偏低」 | 潛在支撐         |\n\n### 也可用絕對門檻\n\n```python\n# 絕對門檻模式\nif high_inventory_mode == \"absolute\":\n    high_inventory = inventory >= 250000  # 噸\n```\n\n---\n\n## 雙庫存同步性分析\n\n### 同步情境（SHFE 與 COMEX 同向）\n\n當兩個庫存來源呈現相同趨勢時：\n- 訊號**可信度較高**\n- 反映全球銅需求的真實變化\n- 可增加訊號權重\n\n**判定方式**：\n```python\nis_sync = (shfe_rebuild_z > 0 and comex_rebuild_z > 0) or \\\n          (shfe_rebuild_z < 0 and comex_rebuild_z < 0)\n```\n\n### 背離情境（SHFE 與 COMEX 反向）\n\n當兩個庫存來源呈現相反趨勢時：\n- 需**謹慎解讀**單一庫存訊號\n- 可能為區域性套利或調倉\n- 應降低訊號權重\n\n**背離情境解讀**：\n\n| SHFE     | COMEX    | 可能原因                 | 建議                   |\n|----------|----------|--------------------------|------------------------|\n| 回補 ↑   | 去庫存 ↓ | 中國進口增加導致庫存轉移 | 關注進口數據與價差變化 |\n| 去庫存 ↓ | 回補 ↑   | 中國出口增加或需求減弱   | 觀察是否為季節性因素   |\n\n### 總庫存觀察\n\n```python\ntotal_inventory = shfe_inventory + comex_inventory\n```\n\n總庫存趨勢用於判斷：\n- 全球可見庫存是否在累積或消耗\n- 單一交易所的變化是否為「轉移」還是「真實供需」\n\n---\n\n## 價格分位數（長期判讀）\n\n判斷當前銅價在歷史分布中的位置，用於長期便宜/昂貴判讀。\n\n### 計算方法\n\n```\nprice_percentile(t) = (price(t) - min) / (max - min)\n```\n\n其中 min, max 為過去 10 年（520 週）的最小/最大值。\n\n### 門檻判定\n\n| 分位數      | 解讀           | 長期訊號 |\n|-------------|----------------|----------|\n| ≤ 0.35      | 長期「偏便宜」 | CHEAP    |\n| 0.35 ~ 0.65 | 長期「中性」   | FAIR     |\n| ≥ 0.65      | 長期「偏貴」   | RICH     |\n\n### 進階：通膨調整（可選）\n\n```python\n# 用 CPI 調整為實質價格\nreal_price = nominal_price / cpi * 100\nprice_percentile = calculate_percentile(real_price)\n```\n\n### 銅價數據注意事項\n\n- HG=F 為 COMEX 銅期貨連續近月合約\n- 換倉日可能有價格跳躍\n- 建議使用週收盤價減少噪音\n\n---\n\n## 訊號生成邏輯\n\n### 短期訊號（Near-term Signal）\n\n**主訊號基於 SHFE**（中國消費全球 50% 銅）：\n\n```python\nif shfe_high_inventory and shfe_fast_rebuild:\n    signal = \"CAUTION\"\nelif shfe_low_inventory or shfe_fast_destocking:\n    signal = \"SUPPORTIVE\"\nelse:\n    signal = \"NEUTRAL\"\n```\n\n**COMEX 輔助驗證**：\n\n```python\n# 若 COMEX 同步，增強訊號\nif signal == \"CAUTION\" and comex_rebuild_z > 1.0:\n    confidence = \"HIGH\"\nelif signal == \"CAUTION\" and comex_rebuild_z < 0:\n    confidence = \"LOW\"  # 背離，降低信心\nelse:\n    confidence = \"MEDIUM\"\n```\n\n### 完整條件表\n\n| SHFE 庫存水位 | SHFE 回補 z-score | COMEX 同步 | 短期訊號    | 信心 |\n|---------------|-------------------|------------|-------------|------|\n| ≥ 0.85 分位   | ≥ 1.5             | 是         | **CAUTION** | 高   |\n| ≥ 0.85 分位   | ≥ 1.5             | 否         | **CAUTION** | 中   |\n| ≥ 0.85 分位   | < 1.5             | -          | NEUTRAL     | -    |\n| 正常          | ≥ 1.5             | -          | NEUTRAL     | -    |\n| 正常          | 正常              | -          | NEUTRAL     | -    |\n| ≤ 0.35 分位   | ≤ -1.5            | 是         | SUPPORTIVE  | 高   |\n| 任意          | ≤ -1.5            | 否         | SUPPORTIVE  | 中   |\n\n### 長期訊號（Long-term View）\n\n```python\nif price_percentile <= 0.35:\n    view = \"CHEAP\"\nelif price_percentile >= 0.65:\n    view = \"RICH\"\nelse:\n    view = \"FAIR\"\n```\n\n---\n\n## 歷史驗證方法論\n\n驗證「訊號觸發」與「價格局部高點」的歷史相關性。\n\n### Step 1: 識別訊號週\n\n找出所有滿足 CAUTION 條件的週次：\n- SHFE rebuild_z ≥ 1.5\n- SHFE inventory_percentile ≥ 0.85\n\n### Step 2: 定義「局部高點」\n\n在訊號週的 ±N 週（預設 N=2）內，若訊號週的價格為該窗口最高，則視為「命中」。\n\n```python\nwindow = price[t-N : t+N]\nis_peak = price[t] >= max(window) * 0.99  # 容許 1% 誤差\n```\n\n### Step 3: 計算命中率\n\n```\nhit_rate = 命中次數 / 訊號觸發次數\n```\n\n### 解讀\n\n| 命中率    | 解讀                           |\n|-----------|--------------------------------|\n| > 65%     | 訊號有較強參考價值             |\n| 55% ~ 65% | 訊號有參考價值，需搭配其他指標 |\n| < 55%     | 訊號接近隨機，參考價值低       |\n\n### COMEX 增強驗證\n\n```python\n# 計算「SHFE + COMEX 同步」的訊號命中率\nsync_signals = signals[comex_also_rebuilding]\nsync_hit_rate = calculate_hit_rate(sync_signals)\n\n# 通常同步訊號的命中率會更高\n```\n\n### 回測限制\n\n1. 樣本量可能不足（訊號觸發次數有限）\n2. 未考慮前視偏差（look-ahead bias）\n3. 市場結構可能已變化\n4. SHFE 和 COMEX 的歷史同步性可能隨時間變化\n\n---\n\n## 參數敏感度分析\n\n不同參數設定對訊號的影響：\n\n### 1. 回補窗口 W\n\n| W    | 訊號特性           | 建議場景 |\n|------|--------------------|----------|\n| 2 週 | 更敏感，訊號更頻繁 | 短線交易 |\n| 4 週 | 平衡               | 預設     |\n| 8 週 | 更平滑，訊號更少   | 中期趨勢 |\n\n### 2. Z-Score 門檻\n\n| 門檻 | 訊號特性             |\n|------|----------------------|\n| 1.2  | 訊號頻繁，假陽性較多 |\n| 1.5  | 平衡（預設）         |\n| 2.0  | 訊號稀少，但更可靠   |\n\n### 3. 庫存分位數門檻\n\n| 門檻 | 訊號特性           |\n|------|--------------------|\n| 0.80 | 更容易觸發 CAUTION |\n| 0.85 | 平衡（預設）       |\n| 0.90 | 較少觸發，但更極端 |\n\n---\n\n## 方法限制\n\n1. **季節性**：農曆新年前後的季節性庫存波動可能產生假訊號\n2. **結構變化**：中國銅消費結構變化可能影響庫存行為\n3. **雙來源限制**：僅依賴 SHFE + COMEX，未整合 LME\n4. **價格因素**：未考慮價格本身的技術形態\n5. **基本面**：未整合供需平衡表等基本面數據\n6. **換倉跳躍**：HG=F 期貨連續合約在換倉日可能有價格不連續\n\n### 使用建議\n\n- 作為風險管理參考，非唯一決策依據\n- 搭配其他技術/基本面指標\n- 關注訊號的時間穩定性\n- 定期驗證回測結果是否失效\n- **優先參考 SHFE 訊號，COMEX 作為輔助驗證**\n- **當 SHFE 與 COMEX 背離時，降低訊號權重**\n\n---\n\n## 學術與實務參考\n\n1. **庫存與價格關係**\n   - 商品期貨理論認為庫存水位影響期貨升貼水\n   - 高庫存 → contango → 潛在拋售壓力\n\n2. **動能與均值回歸**\n   - z-score 極端值傾向均值回歸\n   - 但非對稱：回補極端可能持續更久\n\n3. **中國因素**\n   - 中國銅消費佔全球 ~50%\n   - SHFE 庫存對銅價的邊際影響顯著\n   - COMEX 反映西方市場供需\n\n4. **跨市套利**\n   - SHFE 與 COMEX 價差影響實物流向\n   - 庫存背離時需考慮套利因素\n",
        "skills/analyze-copper-inventory-rebuild-signal/templates/output-json.md": "<overview>\n銅庫存回補訊號分析的 JSON 輸出格式規範。\n</overview>\n\n<schema>\n\n```json\n{\n  \"asof\": \"YYYY-MM-DD\",\n  \"status\": \"success | partial | error\",\n  \"confidence\": 0.0-1.0,\n\n  \"latest\": {\n    \"shfe_inventory_tonnes\": 235000,\n    \"shfe_rebuild_z\": 1.9,\n    \"shfe_inventory_percentile\": 0.87,\n    \"copper_price\": 4.52,\n    \"price_percentile\": 0.32,\n    \"near_term_signal\": \"CAUTION | NEUTRAL | SUPPORTIVE\",\n    \"long_term_view\": \"CHEAP | FAIR | RICH\",\n    \"high_inventory\": true,\n    \"fast_rebuild\": true\n  },\n\n  \"backtest\": {\n    \"peak_match_window_weeks\": 2,\n    \"signal_count\": 21,\n    \"hit_count\": 13,\n    \"signal_to_local_peak_hit_rate\": 0.62\n  },\n\n  \"drivers\": {\n    \"shfe_inventory_tonnes\": 235000,\n    \"shfe_rebuild_window_weeks\": 4,\n    \"shfe_rebuild_z\": 1.9,\n    \"high_inventory_rule\": \"percentile>=0.85\"\n  },\n\n  \"long_term\": {\n    \"window_years\": 10,\n    \"price_percentile\": 0.32,\n    \"cheap_threshold\": 0.35,\n    \"rich_threshold\": 0.65,\n    \"long_term_view\": \"CHEAP\"\n  },\n\n  \"metadata\": {\n    \"data_sources\": {\n      \"shfe_inventory\": \"MacroMicro (CDP)\",\n      \"copper_price\": \"Yahoo Finance (HG=F)\"\n    },\n    \"shfe_data_range\": {\n      \"start\": \"2015-01-01\",\n      \"end\": \"2026-01-26\"\n    },\n    \"price_data_range\": {\n      \"start\": \"2015-01-01\",\n      \"end\": \"2026-01-26\"\n    },\n    \"analyzed_at\": \"2026-01-26T10:30:00Z\"\n  },\n\n  \"config\": {\n    \"fast_rebuild_window_weeks\": 4,\n    \"fast_rebuild_z\": 1.5,\n    \"z_baseline_weeks\": 156,\n    \"high_inventory_mode\": \"percentile\",\n    \"high_inventory_percentile\": 0.85,\n    \"peak_match_window_weeks\": 2,\n    \"long_term_window_years\": 10,\n    \"cheap_percentile\": 0.35,\n    \"rich_percentile\": 0.65\n  },\n\n  \"reasons\": [\n    \"SHFE 庫存 235,000 噸，處於 87% 分位數（偏高）\",\n    \"4 週回補速度 z-score +1.9，超過 1.5 門檻（異常快）\",\n    \"歷史同類訊號命中率 62%\",\n    \"銅價 10 年分位數 32%，處於「偏便宜」區間\"\n  ],\n\n  \"artifacts\": [\n    {\n      \"type\": \"chart\",\n      \"path\": \"output/copper_inventory_signal.png\",\n      \"description\": \"Bloomberg 風格銅庫存回補訊號圖表\"\n    },\n    {\n      \"type\": \"data\",\n      \"path\": \"cache/shfe_inventory.csv\",\n      \"description\": \"SHFE 庫存時序數據\"\n    }\n  ]\n}\n```\n\n</schema>\n\n<field_descriptions>\n\n**頂層欄位**\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| asof | string | 數據截止日期 |\n| status | enum | 執行狀態：success, partial, error |\n| confidence | float | 信心水準（0-1） |\n\n**latest 區塊**\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| shfe_inventory_tonnes | number | SHFE 庫存量（噸） |\n| shfe_rebuild_z | number | 回補速度 z-score |\n| shfe_inventory_percentile | number | 庫存水位分位數（0-1） |\n| copper_price | number | 銅價（USD/lb） |\n| price_percentile | number | 價格分位數（0-1） |\n| near_term_signal | enum | 短期訊號 |\n| long_term_view | enum | 長期判讀 |\n| high_inventory | boolean | 是否庫存偏高 |\n| fast_rebuild | boolean | 是否快速回補 |\n\n**backtest 區塊**\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| peak_match_window_weeks | number | 局部高點匹配窗口（週） |\n| signal_count | number | 歷史訊號觸發次數 |\n| hit_count | number | 命中次數 |\n| signal_to_local_peak_hit_rate | number | 命中率 |\n\n**reasons 陣列**\n\n人類可讀的結論依據清單，用於快速理解分析結論。\n\n**artifacts 陣列**\n\n分析產出的檔案清單，包含圖表和數據檔案。\n\n</field_descriptions>\n\n<example>\n\n```json\n{\n  \"asof\": \"2026-01-26\",\n  \"status\": \"success\",\n  \"confidence\": 0.75,\n  \"latest\": {\n    \"shfe_inventory_tonnes\": 235000,\n    \"shfe_rebuild_z\": 1.9,\n    \"shfe_inventory_percentile\": 0.87,\n    \"copper_price\": 4.52,\n    \"price_percentile\": 0.32,\n    \"near_term_signal\": \"CAUTION\",\n    \"long_term_view\": \"CHEAP\",\n    \"high_inventory\": true,\n    \"fast_rebuild\": true\n  },\n  \"backtest\": {\n    \"peak_match_window_weeks\": 2,\n    \"signal_count\": 21,\n    \"hit_count\": 13,\n    \"signal_to_local_peak_hit_rate\": 0.62\n  },\n  \"drivers\": {\n    \"shfe_inventory_tonnes\": 235000,\n    \"shfe_rebuild_window_weeks\": 4,\n    \"shfe_rebuild_z\": 1.9,\n    \"high_inventory_rule\": \"percentile>=0.85\"\n  },\n  \"long_term\": {\n    \"window_years\": 10,\n    \"price_percentile\": 0.32,\n    \"long_term_view\": \"CHEAP\"\n  },\n  \"reasons\": [\n    \"SHFE 庫存 235,000 噸，處於 87% 分位數（偏高）\",\n    \"4 週回補速度 z-score +1.9，超過 1.5 門檻（異常快）\",\n    \"歷史同類訊號命中率 62%\",\n    \"銅價 10 年分位數 32%，處於「偏便宜」區間\"\n  ]\n}\n```\n\n</example>\n",
        "skills/analyze-copper-inventory-rebuild-signal/templates/output-markdown.md": "<overview>\n銅庫存回補訊號分析的 Markdown 輸出格式規範。\n</overview>\n\n<template>\n\n```markdown\n# 銅：庫存回補訊號（SHFE）\n\n## 最新狀態\n- 數據日期：{asof}\n- SHFE 庫存：{shfe_inventory_tonnes:,} 噸\n- 4 週回補速度 z-score：{shfe_rebuild_z:+.2f}（{z_interpretation}）\n- 期貨價格：{copper_price:.2f} USD/lb\n\n## 短期判斷（是否「有點超前」）\n- 訊號：**{signal_emoji} {near_term_signal}**\n- 原因：{signal_reason}\n- 歷史驗證：過去同類訊號在 ±{peak_match_window_weeks} 週內對應局部高點的命中率約 **{hit_rate:.0%}**\n- 樣本數：{signal_count} 次訊號\n- 解讀：{signal_interpretation}\n\n## 長期判斷（是否仍「偏便宜」）\n- 銅價 {long_term_window_years} 年歷史分位數：{price_percentile:.2f}\n- 結論：**{view_emoji} {long_term_view_description}**\n\n---\n\n### 參數設定\n| 參數 | 值 |\n|------|-----|\n| 回補觀察窗 | {fast_rebuild_window_weeks} 週 |\n| z-score 門檻 | {fast_rebuild_z} |\n| 庫存偏高門檻 | {high_inventory_rule} |\n| 長期窗口 | {long_term_window_years} 年 |\n\n### 數據來源\n- SHFE 庫存：MacroMicro (CDP)\n- 銅價：Yahoo Finance (HG=F)\n- 更新時間：{analyzed_at}\n```\n\n</template>\n\n<variable_definitions>\n\n**變數說明**\n\n| 變數 | 說明 | 範例 |\n|------|------|------|\n| asof | 數據截止日期 | 2026-01-26 |\n| shfe_inventory_tonnes | SHFE 庫存（噸） | 235,000 |\n| shfe_rebuild_z | 回補速度 z-score | +1.9 |\n| z_interpretation | z-score 解讀 | 屬於「異常快」 |\n| copper_price | 銅價 | 4.52 |\n| signal_emoji | 訊號 emoji | ⚠️ / ➖ / ✅ |\n| near_term_signal | 短期訊號 | CAUTION |\n| signal_reason | 訊號原因 | SHFE 庫存「水位偏高」且「回補速度異常快」 |\n| hit_rate | 歷史命中率 | 62% |\n| signal_interpretation | 訊號解讀 | 短線更容易出現「漲勢喘口氣」 |\n| price_percentile | 價格分位數 | 0.32 |\n| view_emoji | 長期判讀 emoji | 💚 / ➖ / 🔴 |\n| long_term_view_description | 長期判讀描述 | 長期仍偏便宜 |\n\n</variable_definitions>\n\n<interpretation_rules>\n\n**z-score 解讀規則**\n\n| z-score 範圍 | z_interpretation |\n|-------------|------------------|\n| > 2.0 | 屬於「極端快」 |\n| 1.5 ~ 2.0 | 屬於「異常快」 |\n| -1.5 ~ 1.5 | 屬於「正常」 |\n| -2.0 ~ -1.5 | 屬於「異常慢」（去庫存快） |\n| < -2.0 | 屬於「極端慢」（去庫存極快） |\n\n**訊號 emoji 規則**\n\n| near_term_signal | signal_emoji |\n|------------------|--------------|\n| CAUTION | ⚠️ |\n| NEUTRAL | ➖ |\n| SUPPORTIVE | ✅ |\n\n**訊號原因規則**\n\n| 條件 | signal_reason |\n|------|---------------|\n| high_inventory & fast_rebuild | SHFE 庫存「水位偏高」且「回補速度異常快」 |\n| fast_rebuild only | SHFE 庫存回補速度異常快（但水位正常） |\n| high_inventory only | SHFE 庫存水位偏高（但回補速度正常） |\n| fast_destocking | 庫存去化速度快，短線有支撐 |\n| neutral | 庫存水位與回補速度均在正常範圍 |\n\n**長期判讀 emoji 規則**\n\n| long_term_view | view_emoji | long_term_view_description |\n|----------------|------------|----------------------------|\n| CHEAP | 💚 | 長期仍偏便宜 |\n| FAIR | ➖ | 長期中性 |\n| RICH | 🔴 | 長期偏貴 |\n\n**訊號解讀規則**\n\n| near_term_signal | signal_interpretation |\n|------------------|----------------------|\n| CAUTION | 短線更容易出現「漲勢喘口氣 / 回檔」而不是一路順風 |\n| NEUTRAL | 短線無明顯偏向，可維持原有策略 |\n| SUPPORTIVE | 庫存偏低或去化快，短線有支撐 |\n\n</interpretation_rules>\n\n<example>\n\n```markdown\n# 銅：庫存回補訊號（SHFE）\n\n## 最新狀態\n- 數據日期：2026-01-26\n- SHFE 庫存：235,000 噸\n- 4 週回補速度 z-score：+1.90（屬於「異常快」）\n- 期貨價格：4.52 USD/lb\n\n## 短期判斷（是否「有點超前」）\n- 訊號：**⚠️ CAUTION**\n- 原因：SHFE 庫存「水位偏高」且「回補速度異常快」\n- 歷史驗證：過去同類訊號在 ±2 週內對應局部高點的命中率約 **62%**\n- 樣本數：21 次訊號\n- 解讀：短線更容易出現「漲勢喘口氣 / 回檔」而不是一路順風\n\n## 長期判斷（是否仍「偏便宜」）\n- 銅價 10 年歷史分位數：0.32\n- 結論：**💚 長期仍偏便宜**（但不代表短線不會先整理）\n\n---\n\n### 參數設定\n| 參數 | 值 |\n|------|-----|\n| 回補觀察窗 | 4 週 |\n| z-score 門檻 | 1.5 |\n| 庫存偏高門檻 | 分位數 >= 0.85 |\n| 長期窗口 | 10 年 |\n\n### 數據來源\n- SHFE 庫存：MacroMicro (CDP)\n- 銅價：Yahoo Finance (HG=F)\n- 更新時間：2026-01-26 10:30\n```\n\n</example>\n",
        "skills/analyze-copper-inventory-rebuild-signal/workflows/full-analysis.md": "<required_reading>\n- references/data-sources.md（數據來源與快取策略）\n- references/methodology.md（方法論詳解）\n- references/historical-episodes.md（歷史案例）\n</required_reading>\n\n<objective>\n執行完整的銅庫存回補訊號分析，包括歷史回測驗證與詳細報告。\n</objective>\n\n<process>\n\n**Step 1: 強制更新數據（SHFE + COMEX + 價格）**\n\n```bash\ncd skills/analyze-copper-inventory-rebuild-signal/scripts\npython fetch_copper_data.py --force-refresh\n```\n\n**Step 2: 執行完整分析**\n\n```bash\npython inventory_signal_analyzer.py --full\n```\n\n**Step 3: 生成視覺化圖表**\n\n```bash\npython visualize_inventory_signal.py\n```\n\n輸出：`output/copper_inventory_signal.png`\n\n**Step 4: 檢視完整報告**\n\n分析結果包含：\n\n1. **最新狀態**\n   - SHFE 庫存量與分位數\n   - SHFE 回補速度 z-score\n   - COMEX 庫存量與分位數\n   - COMEX 回補速度 z-score\n   - 總庫存（SHFE + COMEX）\n   - 銅價與分位數\n\n2. **短期判斷**\n   - near_term_signal（主要看 SHFE）\n   - 訊號原因\n   - 歷史驗證命中率\n\n3. **長期判斷**\n   - 價格歷史分位數\n   - long_term_view\n\n4. **歷史回測**\n   - 訊號觸發次數\n   - 命中次數與命中率\n\n</process>\n\n<parameter_tuning>\n**可調參數**\n\n| 參數 | 預設值 | 說明 |\n|------|--------|------|\n| fast_rebuild_window_weeks | 4 | 回補觀察窗口（週） |\n| fast_rebuild_z | 1.5 | z-score 門檻 |\n| z_baseline_weeks | 156 | z-score 滾動基準（3年） |\n| high_inventory_percentile | 0.85 | 庫存偏高門檻 |\n| peak_match_window_weeks | 2 | 局部高點匹配窗口 |\n| long_term_window_years | 10 | 長期歷史窗口 |\n| cheap_percentile | 0.35 | 便宜門檻 |\n| rich_percentile | 0.65 | 昂貴門檻 |\n\n**修改方式**：\n\n編輯 `scripts/inventory_signal_analyzer.py` 中的 `DEFAULT_CONFIG`。\n</parameter_tuning>\n\n<output_format>\n完整分析輸出格式參考：\n- Markdown：`templates/output-markdown.md`\n- JSON：`templates/output-json.md`\n</output_format>\n\n<success_criteria>\n- [x] 數據成功更新\n- [x] 完整分析報告生成\n- [x] Bloomberg 風格圖表輸出\n- [x] 歷史回測結果可驗證\n- [x] 訊號邏輯與方法論一致\n</success_criteria>\n",
        "skills/analyze-copper-inventory-rebuild-signal/workflows/quick-check.md": "<required_reading>\n- references/data-sources.md（數據來源與快取策略）\n</required_reading>\n\n<objective>\n快速檢查當前銅庫存回補訊號狀態，產出簡短的訊號判讀。\n</objective>\n\n<process>\n\n**Step 1: 執行數據抓取（SHFE + COMEX + 價格）**\n\n```bash\ncd skills/analyze-copper-inventory-rebuild-signal/scripts\npython fetch_copper_data.py\n```\n\n若快取有效（12 小時內），會直接使用快取數據。\n\n**Step 2: 執行分析**\n\n```bash\npython inventory_signal_analyzer.py\n```\n\n**Step 3: 查看結果**\n\n分析結果會輸出到控制台，並儲存到：\n- `cache/analysis_result.json`\n\n**Step 4: 解讀訊號**\n\n| near_term_signal | 解讀 |\n|------------------|------|\n| CAUTION | 短線謹慎，回補速度異常快且庫存偏高 |\n| NEUTRAL | 無明顯訊號 |\n| SUPPORTIVE | 庫存偏低或去化快，短線有支撐 |\n\n| long_term_view | 解讀 |\n|----------------|------|\n| CHEAP | 長期偏便宜（價格分位數 ≤ 35%） |\n| FAIR | 長期中性 |\n| RICH | 長期偏貴（價格分位數 ≥ 65%） |\n\n</process>\n\n<output_format>\n快速檢查的輸出應包含：\n\n```\n銅庫存回補訊號快速檢查\n========================\n數據日期：{asof}\nSHFE 庫存：{shfe_inventory_tonnes:,} 噸\nSHFE 回補速度 z-score：{shfe_rebuild_z:+.2f}\nCOMEX 庫存：{comex_inventory_tonnes:,} 噸\nCOMEX 回補速度 z-score：{comex_rebuild_z:+.2f}\n總庫存：{total_inventory_tonnes:,} 噸\n銅價：{copper_price:.2f} USD/lb\n\n短期訊號：{signal_emoji} {near_term_signal}\n長期判讀：{view_emoji} {long_term_view}\n```\n</output_format>\n\n<success_criteria>\n- [x] 數據成功抓取或使用有效快取\n- [x] 分析完成並輸出訊號\n- [x] 訊號解讀清晰明確\n</success_criteria>\n",
        "skills/analyze-copper-inventory-rebuild-signal/workflows/visualize.md": "<required_reading>\n- references/data-sources.md（確認數據已抓取）\n</required_reading>\n\n<objective>\n生成 Bloomberg 風格的銅庫存回補訊號視覺化圖表。\n</objective>\n\n<process>\n\n**Step 1: 確認數據存在**\n\n```bash\nls cache/shfe_inventory.csv cache/comex_inventory.csv cache/copper_price.csv\n```\n\n若不存在，先執行：\n```bash\npython fetch_copper_data.py\n```\n\n**Step 2: 生成圖表**\n\n```bash\ncd skills/analyze-copper-inventory-rebuild-signal/scripts\npython visualize_inventory_signal.py\n```\n\n**Step 3: 指定輸出路徑（可選）**\n\n```bash\npython visualize_inventory_signal.py --output path/to/custom_output.png\n```\n\n</process>\n\n<chart_components>\n**圖表包含多個子圖**\n\n1. **上圖：價格與庫存**\n   - 左軸：銅期貨價格（USD/lb）\n   - 右軸：SHFE 和 COMEX 庫存（噸）\n   - 標記：CAUTION 訊號點\n\n2. **中圖：回補速度 Z-Score**\n   - 顯示 SHFE 和 COMEX z-score 時序\n   - 標記 ±1.5 和 ±2.0 門檻線\n   - CAUTION 區域（z > 1.5）著色\n\n3. **下圖：庫存分位數熱力條**\n   - 顯示庫存在歷史分布中的位置\n   - 綠色（低位）→ 紅色（高位）\n\n**配色方案（Bloomberg 深色主題）**\n\n| 元素 | 顏色 |\n|------|------|\n| 背景 | #1a1a2e |\n| 銅價 | #ffa500（橙色） |\n| SHFE 庫存 | #00bfff（天藍） |\n| COMEX 庫存 | #00ff88（綠色） |\n| CAUTION 標記 | #ff6b35（紅橙） |\n| SUPPORTIVE 標記 | #00d4aa（青綠） |\n| 門檻線 | #666666（灰色） |\n</chart_components>\n\n<output>\n**預設輸出路徑**：`output/copper_inventory_signal.png`\n\n**圖表尺寸**：1600 x 1200 像素\n\n**字體**：等寬字體（Consolas / Monaco / monospace）\n</output>\n\n<success_criteria>\n- [x] 圖表成功生成\n- [x] 三個子圖完整顯示\n- [x] CAUTION 訊號點正確標記\n- [x] 配色符合 Bloomberg 風格\n</success_criteria>\n",
        "skills/analyze-copper-stock-resilience-dependency/SKILL.md": "---\nname: analyze-copper-stock-resilience-dependency\ndescription: 用跨資產訊號（全球股市韌性 + 中國利率環境）評估銅價能否突破關卡或進入「回補/回踩」到支撐的機率與路徑。\n---\n\n<essential_principles>\n\n<principle name=\"cross_asset_dependency\">\n**跨資產依賴核心邏輯**\n\n銅價的關卡突破與回補，並非單純由銅本身決定，而是高度依賴股市韌性：\n\n```\n銅價走勢 = f(技術面關卡狀態) × f(股市韌性) × f(中國利率環境)\n```\n\n關鍵洞察：\n- **股市韌性高**時：銅突破關卡後「續航」機率更高\n- **股市韌性低**時：銅更容易出現「back-and-fill」回補到支撐區\n- **中國10Y殖利率**：作為風險壓力/政策寬鬆的雙面訊號\n</principle>\n\n<principle name=\"round_levels\">\n**心理關卡與趨勢狀態**\n\n銅價的重要心理整數位（如 10,000 / 13,000 USD/ton）是判斷突破與回補的關鍵：\n\n| 狀態      | 條件                       | 含義     |\n|-----------|----------------------------|----------|\n| **up**    | close > SMA(60) 且斜率為正 | 上升趨勢 |\n| **down**  | close < SMA(60) 且斜率為負 | 下降趨勢 |\n| **range** | 其他                       | 區間整理 |\n\n關卡判定：\n- `near_resistance`: 接近上方關卡\n- `near_support`: 接近下方支撐\n</principle>\n\n<principle name=\"equity_resilience_score\">\n**股市韌性評分（0-100）**\n\n將「股市韌性」量化為可計算的分數：\n\n| 因子       | 權重 | 計算方式                           |\n|------------|------|------------------------------------|\n| 12個月動能 | 40%  | 12m 報酬分位數（vs 歷史）          |\n| 均線位置   | 40%  | 是否站上 12 月均線（是=100，否=0） |\n| 近期回撤   | 20%  | 近 3m 回撤越小越好（反向計分）     |\n\n評分解讀：\n- **70-100**：高韌性，銅突破關卡後續航機率較高\n- **30-70**：中性，需觀察其他因子\n- **0-30**：低韌性，回補風險顯著上升\n</principle>\n\n<principle name=\"rolling_beta\">\n**滾動迴歸：量化依賴強度**\n\n計算銅價對股市與中國殖利率的滾動貝塔係數：\n\n```\nΔcopper ~ β1 × Δequity + β2 × Δchina_yield + ε\n```\n\n- **β1（股市貝塔）越大越正**：銅越像風險資產，越依賴股市\n- **β1 高分位**：市場正在把銅當風險資產一起交易\n- **β1 < 0（負相關）**：銅與股市脫鉤，展現獨立邏輯（避險/供給/能源轉型敘事）\n- **β2（殖利率貝塔）**：正 = 殖利率上升利好銅（通膨敘事），負 = 反之\n</principle>\n\n<principle name=\"data_access\">\n**資料取得方式**\n\n本 skill 使用以下公開數據來源：\n\n| 數據          | 代碼/來源                                                                         | 取得方式              |\n|---------------|-----------------------------------------------------------------------------------|----------------------|\n| 銅期貨價格    | COMEX Copper (HG=F)                                                               | Yahoo Finance        |\n| 全球股市市值  | VT (Vanguard Total World Stock ETF)                                               | Yahoo Finance        |\n| 中國10Y殖利率 | [MacroMicro](https://en.macromicro.me/charts/133362/China-10Year-Government-Bond-Yield) | Selenium + Highcharts |\n\n**單位換算**：\n- HG=F 為 $/lb，自動乘以 2204.62262 轉換為 $/ton\n- VT ETF 價格乘以係數轉換為全球市值估計（兆美元）\n- 中國10Y 為百分比（%）\n</principle>\n\n</essential_principles>\n\n<objective>\n實作銅價股市韌性依賴分析：\n\n1. **資料擷取**：抓取銅價、全球股市、中國10Y殖利率\n2. **趨勢與關卡判定**：計算 SMA、趨勢狀態、接近哪個關卡\n3. **股市韌性評分**：計算 equity_resilience_score\n4. **依賴關係量化**：滾動迴歸計算 β 係數\n5. **回補機率估計**：歷史統計回補頻率（高韌性 vs 低韌性）\n6. **情境判讀**：輸出當前是「續航」還是「回補」情境\n\n輸出：當前狀態、依賴強度、回補機率、可執行警報旗標。\n</objective>\n\n<quick_start>\n\n**最快的方式：執行預設分析**\n\n```bash\ncd skills/analyze-copper-stock-resilience-dependency\npip install pandas numpy yfinance scipy statsmodels matplotlib  # 首次使用\npython scripts/copper_stock_analyzer.py --quick\n```\n\n輸出範例：\n```json\n{\n  \"as_of\": \"2026-01-22\",\n  \"latest_state\": {\n    \"copper_price_usd_per_ton\": 12727,\n    \"copper_trend\": \"up\",\n    \"equity_resilience_score\": 83,\n    \"rolling_beta_equity_24m\": -0.80\n  },\n  \"diagnosis\": {\n    \"narrative\": \"銅價上升趨勢中，接近 13,000 關卡，股市韌性高檔。\"\n  }\n}\n```\n\n**生成 Bloomberg 風格圖表**：\n```bash\npython scripts/visualize.py \\\n  --start 2015-01-01 \\\n  -o output/copper_resilience_2026-01-22.png\n```\n\n圖表包含：\n- 銅價月線 + SMA60（右軸，橙紅/黃色）\n- 全球股市市值（左軸，橙色面積圖）\n- 中國 10Y 殖利率（左軸，黃線）\n- 關卡線（10,000 / 13,000）\n\n**生成依賴度分析圖表**（三面板綜合圖）：\n```bash\npython scripts/plot_dependency_analysis.py \\\n  --start 2015-01-01 \\\n  -o ../../output/copper-dependency-analysis-2026-01-22.png\n```\n\n圖表包含三個面板：\n1. **銅價面板**：銅價 + SMA60 + 趨勢背景色（綠=上升，紅=下降）+ 關卡線\n2. **β係數面板**：滾動 β 時間序列 + ±1σ 區間 + 當前分位數 + 負值警示\n3. **韌性面板**：股市韌性評分 + 高/低閾值線\n\n**完整分析**：\n```bash\npython scripts/copper_stock_analyzer.py \\\n  --start 2015-01-01 \\\n  --end 2026-01-22 \\\n  --copper HG=F \\\n  --equity ACWI \\\n  --output result.json\n```\n\n</quick_start>\n\n<intake>\n需要進行什麼操作？\n\n1. **快速檢查** - 查看目前銅價、股市韌性、關卡狀態\n2. **完整分析** - 分析時間區間內的依賴關係與回補機率\n3. **視覺化圖表** - 生成銅價與依賴因子的視覺化圖表\n4. **依賴度分析圖** - 生成三面板依賴度分析圖表（銅價+β係數+韌性）\n5. **方法論學習** - 了解跨資產依賴模型的邏輯\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                     | Action                                                 |\n|------------------------------|--------------------------------------------------------|\n| 1, \"快速\", \"quick\", \"check\"  | 執行 `python scripts/copper_stock_analyzer.py --quick` |\n| 2, \"完整\", \"分析\", \"full\"    | 閱讀 `workflows/analyze.md` 並執行                     |\n| 3, \"視覺化\", \"chart\", \"plot\" | 閱讀 `workflows/visualize.md` 並執行                   |\n| 4, \"依賴度\", \"dependency\"    | 執行 `python scripts/plot_dependency_analysis.py`      |\n| 5, \"學習\", \"方法論\", \"why\"   | 閱讀 `references/methodology.md`                       |\n| 提供參數 (如日期範圍)        | 閱讀 `workflows/analyze.md` 並使用參數執行             |\n\n**路由後，閱讀對應文件並執行。**\n</routing>\n\n<directory_structure>\n```\nanalyze-copper-stock-resilience-dependency/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元數據\n├── workflows/\n│   ├── analyze.md                     # 完整分析工作流\n│   ├── quick-check.md                 # 快速檢查工作流\n│   └── visualize.md                   # 視覺化工作流\n├── references/\n│   ├── methodology.md                 # 跨資產依賴方法論\n│   ├── data-sources.md                # 數據來源與爬蟲說明\n│   └── input-schema.md                # 完整輸入參數定義\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n├── scripts/\n│   ├── copper_stock_analyzer.py       # 主分析腳本\n│   ├── fetch_data.py                  # 數據抓取工具\n│   ├── visualize.py                   # Bloomberg 風格圖表\n│   └── plot_dependency_analysis.py    # 三面板依賴度分析圖表\n├── data/\n│   └── cache/                         # 數據快取目錄\n└── examples/\n    └── sample-output.json             # 範例輸出\n```\n</directory_structure>\n\n<reference_index>\n\n**方法論**: references/methodology.md\n- 跨資產依賴概念與研究報告對照\n- 股市韌性評分設計\n- 滾動迴歸與貝塔解讀\n- Back-and-fill 回補判定邏輯\n\n**資料來源**: references/data-sources.md\n- Yahoo Finance (yfinance) 使用說明\n- 中國10Y殖利率爬蟲設計\n- 數據頻率與對齊方法\n\n**輸入參數**: references/input-schema.md\n- 完整參數定義\n- 預設值與建議範圍\n\n</reference_index>\n\n<workflows_index>\n| Workflow       | Purpose        | 使用時機                   |\n|----------------|----------------|----------------------------|\n| analyze.md     | 完整分析       | 需要詳細依賴關係與回補分析 |\n| quick-check.md | 快速檢查       | 只想看當前狀態             |\n| visualize.md   | 生成視覺化圖表 | 需要圖表展示               |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構定義 |\n| output-markdown.md | Markdown 報告模板 |\n</templates_index>\n\n<scripts_index>\n| Script                      | Command                                    | Purpose                      |\n|-----------------------------|--------------------------------------------|------------------------------|\n| copper_stock_analyzer.py    | `--quick`                                  | 快速檢查當前狀態             |\n| copper_stock_analyzer.py    | `--start DATE --end DATE`                  | 完整分析                     |\n| fetch_data.py               | `--series HG=F,ACWI`                       | 抓取市場數據                 |\n| visualize.py                | `--start 2015-01-01 -o output/chart.png`   | 生成 Bloomberg 風格圖表      |\n| plot_dependency_analysis.py | `--start 2015-01-01 -o output/chart.png`   | 生成三面板依賴度分析圖表     |\n</scripts_index>\n\n<input_schema_summary>\n\n**核心參數**\n\n| 參數                   | 類型   | 預設值     | 說明          |\n|------------------------|--------|------------|---------------|\n| start_date             | string | 2020-01-01 | 分析起點      |\n| end_date               | string | today      | 分析終點      |\n| freq                   | string | 1mo        | 頻率（月）    |\n| copper_series          | string | HG=F       | 銅價序列代碼  |\n| equity_proxy_series    | string | ACWI       | 股市代理序列  |\n| china_10y_yield_series | string | 爬取       | 中國10Y殖利率 |\n\n**模型參數**\n\n| 參數                  | 類型  | 預設值         | 說明               |\n|-----------------------|-------|----------------|--------------------|\n| ma_window             | int   | 60             | 移動平均視窗       |\n| rolling_window        | int   | 24             | 滾動迴歸視窗（月） |\n| round_levels          | list  | [10000, 13000] | 關卡位置           |\n| backfill_max_drawdown | float | 0.25           | 回補幅度上限       |\n\n完整參數定義見 `references/input-schema.md`。\n\n</input_schema_summary>\n\n<output_schema_summary>\n```json\n{\n  \"skill\": \"analyze-copper-stock-resilience-dependency\",\n  \"as_of\": \"2026-01-22\",\n  \"inputs\": {\n    \"copper_series\": \"HG=F (converted to USD/ton)\",\n    \"equity_proxy_series\": \"ACWI\",\n    \"ma_window\": 60,\n    \"rolling_window\": 24\n  },\n  \"latest_state\": {\n    \"copper_price_usd_per_ton\": 12727,\n    \"copper_sma_60\": 9355,\n    \"copper_trend\": \"up\",\n    \"near_resistance_levels\": [13000],\n    \"near_support_levels\": [],\n    \"equity_resilience_score\": 91,\n    \"rolling_beta_equity_24m\": -0.80,\n    \"rolling_beta_yield_24m\": -0.05\n  },\n  \"diagnosis\": {\n    \"narrative\": \"銅價上升趨勢中，接近 13,000 關卡，股市韌性高檔。\",\n    \"scenario\": \"續航機率較高\",\n    \"dependency_status\": \"滾動 β 為負值 (-0.80)，銅與股市呈反向關係，脫離傳統風險資產模式\"\n  },\n  \"actionable_flags\": [\n    {\n      \"flag\": \"APPROACHING_RESISTANCE\",\n      \"meaning\": \"接近重要阻力位，關注能否突破\"\n    },\n    {\n      \"flag\": \"NEGATIVE_BETA_REGIME\",\n      \"meaning\": \"銅與股市呈反向關係，脫離傳統風險資產模式\"\n    },\n    {\n      \"flag\": \"LOW_BETA_ANOMALY\",\n      \"meaning\": \"β 處於歷史極端低位，銅正展現獨立於股市的上漲邏輯\"\n    }\n  ]\n}\n```\n\n完整輸出結構見 `templates/output-json.md`。\n</output_schema_summary>\n\n<success_criteria>\n執行成功時應產出：\n\n- [ ] 當前銅價與趨勢狀態（up/down/range）\n- [ ] 接近的關卡位置（resistance/support）\n- [ ] 股市韌性評分（0-100）\n- [ ] 滾動貝塔係數（β_equity, β_yield）\n- [ ] 回補機率估計（overall / high_resilience / low_resilience）\n- [ ] 情境判讀敘述\n- [ ] 可執行警報旗標\n- [ ] 視覺化圖表（可選，輸出至 `output/` 目錄）\n</success_criteria>\n",
        "skills/analyze-copper-stock-resilience-dependency/references/data-sources.md": "# 數據來源與爬蟲說明\n\n## 數據來源總覽\n\n| 數據 | 原始來源（封閉） | 公開替代 | 取得方式 |\n|------|------------------|----------|----------|\n| 銅期貨價格 | LME Copper | COMEX Copper (HG=F) | Yahoo Finance (yfinance) |\n| 全球股市韌性 | Bloomberg World Mkt Cap | ACWI / VT | Yahoo Finance (yfinance) |\n| 中國10Y殖利率 | Bloomberg Generic Yield | TradingEconomics | Selenium 爬蟲 |\n\n---\n\n## 1. 銅期貨價格 (COMEX Copper)\n\n### 來源\n\n**Yahoo Finance - HG=F**\n\n```python\nimport yfinance as yf\n\n# 抓取 COMEX Copper futures\ncopper = yf.download(\"HG=F\", start=\"2020-01-01\", end=\"2026-01-20\", interval=\"1mo\")\n```\n\n### 重要：單位換算\n\nHG=F 報價單位為 **USD/lb（美元/磅）**，需轉換為 **USD/ton（美元/噸）**：\n\n```python\n# 換算係數：1 噸 = 2204.62262 磅\nPOUNDS_PER_TON = 2204.62262\n\ncopper_usd_per_ton = copper[\"Close\"] * POUNDS_PER_TON\n```\n\n**對照範例：**\n- HG=F = $4.50/lb → $4.50 × 2204.62 = **$9,921/ton**\n- HG=F = $5.90/lb → $5.90 × 2204.62 = **$13,007/ton**\n\n### 注意事項\n\n- HG=F 為連續合約，可能有換月跳空\n- 建議使用月底收盤價\n- 數據延遲約 15 分鐘\n\n---\n\n## 2. 全球股市韌性代理 (ACWI)\n\n### 來源\n\n**Yahoo Finance - ACWI / VT**\n\n```python\nimport yfinance as yf\n\n# ACWI: iShares MSCI All Country World Index ETF\nequity = yf.download(\"ACWI\", start=\"2020-01-01\", end=\"2026-01-20\", interval=\"1mo\")\n\n# 或使用 VT: Vanguard Total World Stock ETF\n# equity = yf.download(\"VT\", start=\"2020-01-01\", end=\"2026-01-20\", interval=\"1mo\")\n```\n\n### 可用代理比較\n\n| 代碼 | 名稱 | 涵蓋範圍 | 費用率 |\n|------|------|----------|--------|\n| ACWI | iShares MSCI ACWI ETF | 全球已開發 + 新興 | 0.32% |\n| VT | Vanguard Total World Stock | 全球 | 0.07% |\n| URTH | iShares MSCI World ETF | 已開發市場 | 0.24% |\n\n**建議使用 ACWI**，涵蓋範圍最接近「全球股市市值」概念。\n\n### 與彭博全球市值的差異\n\n- 彭博數據為總市值（market cap）\n- ACWI 為指數價格（price return）\n- 兩者高度相關，但非完全一致\n- 本技能目的是捕捉「股市韌性」，價格指數已足夠\n\n---\n\n## 3. 中國10Y公債殖利率\n\n### 來源\n\n**TradingEconomics 爬蟲**\n\n由於中國公債殖利率沒有方便的免費 API，需使用 Selenium 爬取。\n\n### 爬蟲設計\n\n遵循 `thoughts/shared/guide/design-human-like-crawler.md` 規範：\n\n```python\n#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n\"\"\"\n中國10年期公債殖利率爬蟲\n使用 Selenium 模擬瀏覽器行為\n\"\"\"\n\nimport random\nimport time\nfrom datetime import datetime\nfrom typing import Optional, Dict\n\nfrom selenium import webdriver\nfrom selenium.webdriver.chrome.service import Service\nfrom selenium.webdriver.chrome.options import Options\nfrom selenium.webdriver.common.by import By\nfrom selenium.webdriver.support.ui import WebDriverWait\nfrom selenium.webdriver.support import expected_conditions as EC\nfrom webdriver_manager.chrome import ChromeDriverManager\nfrom bs4 import BeautifulSoup\n\n# 配置\nTARGET_URL = \"https://tradingeconomics.com/china/government-bond-yield\"\n\nUSER_AGENTS = [\n    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36...',\n    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36...',\n]\n\n\ndef get_china_10y_yield() -> Optional[Dict]:\n    \"\"\"抓取中國 10Y 殖利率\"\"\"\n    driver = None\n\n    try:\n        # 隨機延遲\n        time.sleep(random.uniform(1.0, 2.0))\n\n        # Chrome 配置（防偵測）\n        options = Options()\n        options.add_argument('--headless')\n        options.add_argument('--no-sandbox')\n        options.add_argument('--disable-dev-shm-usage')\n        options.add_argument('--disable-blink-features=AutomationControlled')\n        options.add_experimental_option('excludeSwitches', ['enable-automation'])\n        options.add_argument(f'user-agent={random.choice(USER_AGENTS)}')\n\n        # 啟動瀏覽器\n        service = Service(ChromeDriverManager().install())\n        driver = webdriver.Chrome(service=service, options=options)\n        driver.set_page_load_timeout(60)\n\n        # 載入頁面\n        driver.get(TARGET_URL)\n\n        # 等待表格載入\n        WebDriverWait(driver, 20).until(\n            EC.presence_of_element_located((By.CSS_SELECTOR, \"table\"))\n        )\n        time.sleep(3)\n\n        # 解析\n        soup = BeautifulSoup(driver.page_source, 'lxml')\n\n        # 提取當前殖利率（需依實際頁面結構調整選擇器）\n        yield_element = soup.select_one('#ticker')\n        if yield_element:\n            current_yield = float(yield_element.get_text(strip=True))\n            return {\n                \"date\": datetime.now().strftime(\"%Y-%m-%d\"),\n                \"china_10y_yield\": current_yield,\n                \"source\": \"TradingEconomics\"\n            }\n\n        return None\n\n    except Exception as e:\n        print(f\"爬取失敗: {e}\")\n        return None\n\n    finally:\n        if driver:\n            driver.quit()\n```\n\n### 快取策略\n\n```python\nimport json\nfrom pathlib import Path\nfrom datetime import datetime, timedelta\n\nCACHE_FILE = Path(\"data/cache/china_10y_yield.json\")\nCACHE_MAX_AGE_HOURS = 12\n\ndef get_cached_yield():\n    \"\"\"優先使用快取\"\"\"\n    if CACHE_FILE.exists():\n        mtime = datetime.fromtimestamp(CACHE_FILE.stat().st_mtime)\n        if datetime.now() - mtime < timedelta(hours=CACHE_MAX_AGE_HOURS):\n            with open(CACHE_FILE) as f:\n                return json.load(f)\n\n    # 快取過期，重新爬取\n    data = get_china_10y_yield()\n    if data:\n        CACHE_FILE.parent.mkdir(parents=True, exist_ok=True)\n        with open(CACHE_FILE, 'w') as f:\n            json.dump(data, f)\n    return data\n```\n\n### 替代來源\n\n如果 TradingEconomics 不可用，可考慮：\n\n| 來源 | 可行性 | 說明 |\n|------|--------|------|\n| Investing.com | 中 | 頁面結構複雜，反爬蟲較強 |\n| MacroMicro | 中 | 需等待 Highcharts 渲染（見 macromicro-highcharts-crawler.md） |\n| FRED | 低 | 無中國公債殖利率序列 |\n\n---\n\n## 4. 數據頻率與對齊\n\n### 頻率選擇\n\n本技能預設使用 **月頻（1mo）**：\n\n- 對應研究報告圖中的 monthly candle\n- 過濾短期雜訊\n- 三條序列都能取得月頻數據\n\n### 對齊方法\n\n```python\nimport pandas as pd\n\ndef align_monthly(data_dict: dict) -> pd.DataFrame:\n    \"\"\"\n    將多條序列對齊到月底\n\n    Parameters\n    ----------\n    data_dict : dict\n        {\"copper\": series1, \"equity\": series2, \"cny10y\": series3}\n\n    Returns\n    -------\n    pd.DataFrame\n        對齊後的 DataFrame\n    \"\"\"\n    df = pd.DataFrame(data_dict)\n\n    # 確保索引為日期\n    df.index = pd.to_datetime(df.index)\n\n    # 重採樣到月底\n    df = df.resample('M').last()\n\n    # 丟掉缺值（或用前值填補）\n    df = df.dropna()\n\n    return df\n```\n\n### 時區處理\n\n- Yahoo Finance 預設為美東時間\n- TradingEconomics 數據可能為 UTC\n- 建議統一轉換為 UTC，再取月底\n\n---\n\n## 5. 依賴套件安裝\n\n```bash\n# 核心套件\npip install pandas numpy yfinance scipy statsmodels\n\n# 爬蟲套件\npip install selenium webdriver-manager beautifulsoup4 lxml\n\n# 視覺化（可選）\npip install matplotlib plotly\n```\n\n---\n\n## 6. 完整資料抓取範例\n\n```python\nfrom scripts.fetch_data import fetch_copper, fetch_equity, fetch_china_yield\nfrom scripts.copper_stock_analyzer import align_monthly\n\n# 1. 抓取數據\ncopper = fetch_copper(\"HG=F\", \"2020-01-01\", \"2026-01-20\")\nequity = fetch_equity(\"ACWI\", \"2020-01-01\", \"2026-01-20\")\ncny10y = fetch_china_yield(\"2020-01-01\", \"2026-01-20\")\n\n# 2. 對齊\ndf = align_monthly({\n    \"copper\": copper,\n    \"equity\": equity,\n    \"cny10y\": cny10y\n})\n\nprint(f\"資料筆數: {len(df)}\")\nprint(df.tail())\n```\n",
        "skills/analyze-copper-stock-resilience-dependency/references/input-schema.md": "# 輸入參數定義\n\n## 完整參數表\n\n### 核心參數\n\n| 參數 | 類型 | 必填 | 預設值 | 說明 |\n|------|------|------|--------|------|\n| `start_date` | string | ✅ | - | 分析起始日期（YYYY-MM-DD） |\n| `end_date` | string | ✅ | - | 分析結束日期（YYYY-MM-DD） |\n| `freq` | string | ❌ | `1mo` | 資料頻率（1mo = 月） |\n| `copper_series` | string | ✅ | - | 銅價序列代碼（如 HG=F） |\n| `equity_proxy_series` | string | ✅ | - | 股市代理序列（如 ACWI） |\n| `china_10y_yield_series` | string | ✅ | - | 中國10Y殖利率來源 |\n\n### 模型參數\n\n| 參數 | 類型 | 必填 | 預設值 | 說明 |\n|------|------|------|--------|------|\n| `ma_window` | int | ❌ | `60` | 移動平均視窗（期數） |\n| `rolling_window` | int | ❌ | `24` | 滾動迴歸視窗（月數） |\n| `round_levels` | list[float] | ❌ | `[10000, 13000]` | 關卡位置（USD/ton） |\n| `backfill_max_drawdown` | float | ❌ | `0.25` | 回補幅度上限（25%） |\n| `level_threshold` | float | ❌ | `0.05` | 關卡判定容忍範圍（5%） |\n\n### 股市韌性權重\n\n| 參數 | 類型 | 必填 | 預設值 | 說明 |\n|------|------|------|--------|------|\n| `resilience_weight_momentum` | float | ❌ | `0.4` | 12m 動能權重 |\n| `resilience_weight_sma` | float | ❌ | `0.4` | 均線位置權重 |\n| `resilience_weight_drawdown` | float | ❌ | `0.2` | 近期回撤權重 |\n| `resilience_sma_period` | int | ❌ | `12` | 韌性用均線期數 |\n| `resilience_drawdown_period` | int | ❌ | `3` | 回撤計算期數 |\n\n### 輸出參數\n\n| 參數 | 類型 | 必填 | 預設值 | 說明 |\n|------|------|------|--------|------|\n| `output` | string | ❌ | `stdout` | 輸出檔案路徑 |\n| `format` | string | ❌ | `json` | 輸出格式（json / markdown） |\n| `verbose` | bool | ❌ | `false` | 是否輸出詳細日誌 |\n\n---\n\n## 參數詳細說明\n\n### start_date / end_date\n\n分析的時間範圍。\n\n```python\n# 範例\nstart_date = \"2020-01-01\"\nend_date = \"2026-01-20\"\n```\n\n**建議**：至少包含 5 年歷史，確保有足夠樣本計算回補機率。\n\n### freq\n\n資料頻率，對應 yfinance 的 interval 參數。\n\n| 值 | 說明 |\n|----|------|\n| `1mo` | 月頻（預設，對應圖中 monthly candle） |\n| `1wk` | 週頻 |\n| `1d` | 日頻 |\n\n**注意**：頻率越高，計算量越大且雜訊越多。\n\n### copper_series\n\n銅價序列代碼。\n\n| 代碼 | 來源 | 單位 | 說明 |\n|------|------|------|------|\n| `HG=F` | Yahoo Finance | USD/lb | COMEX Copper futures |\n| `custom` | 自定義 | 視情況 | 需提供 CSV 路徑 |\n\n**重要**：若使用 HG=F，腳本會自動轉換為 USD/ton。\n\n### equity_proxy_series\n\n全球股市韌性代理序列。\n\n| 代碼 | 名稱 | 涵蓋範圍 |\n|------|------|----------|\n| `ACWI` | iShares MSCI ACWI ETF | 全球（預設推薦） |\n| `VT` | Vanguard Total World Stock | 全球 |\n| `URTH` | iShares MSCI World ETF | 已開發市場 |\n\n### china_10y_yield_series\n\n中國10Y殖利率來源。\n\n| 值 | 說明 |\n|----|------|\n| `tradingeconomics` | 從 TradingEconomics 爬取（預設） |\n| `csv:path/to/file.csv` | 使用本地 CSV 檔案 |\n| `manual` | 手動輸入（互動模式） |\n\n### ma_window\n\n移動平均視窗，用於判定趨勢狀態。\n\n```python\n# 預設 60 期（月），對應圖中長期均線\nma_window = 60\n```\n\n**調整建議**：\n- 更短期觀點：20-30\n- 更長期觀點：90-120\n\n### rolling_window\n\n滾動迴歸視窗，用於計算 β 係數。\n\n```python\n# 預設 24 個月\nrolling_window = 24\n```\n\n**調整建議**：\n- 更反應性：12-18\n- 更穩定：30-36\n\n### round_levels\n\n關卡位置列表，單位 USD/ton。\n\n```python\n# 預設關卡\nround_levels = [10000, 13000]\n\n# 自定義\nround_levels = [8000, 10000, 13000, 15000]\n```\n\n### backfill_max_drawdown\n\n用於判定「典型回補」的幅度上限。\n\n```python\n# 預設 25%\nbackfill_max_drawdown = 0.25\n```\n\n若觸及高關卡後的回撤在 10%-25% 範圍內，視為典型 back-and-fill。\n\n---\n\n## 命令列介面\n\n### 基本用法\n\n```bash\npython scripts/copper_stock_analyzer.py \\\n    --start 2020-01-01 \\\n    --end 2026-01-20 \\\n    --copper HG=F \\\n    --equity ACWI\n```\n\n### 完整參數\n\n```bash\npython scripts/copper_stock_analyzer.py \\\n    --start 2020-01-01 \\\n    --end 2026-01-20 \\\n    --copper HG=F \\\n    --equity ACWI \\\n    --yield tradingeconomics \\\n    --ma-window 60 \\\n    --rolling-window 24 \\\n    --levels 10000,13000 \\\n    --output result.json \\\n    --format json \\\n    --verbose\n```\n\n### 快速檢查模式\n\n```bash\npython scripts/copper_stock_analyzer.py --quick\n```\n\n等同於：\n```bash\npython scripts/copper_stock_analyzer.py \\\n    --start $(date -d \"3 years ago\" +%Y-%m-%d) \\\n    --end $(date +%Y-%m-%d) \\\n    --copper HG=F \\\n    --equity ACWI \\\n    --yield tradingeconomics\n```\n\n---\n\n## JSON 配置檔（可選）\n\n除了命令列參數，也可使用 JSON 配置檔：\n\n```json\n{\n  \"start_date\": \"2020-01-01\",\n  \"end_date\": \"2026-01-20\",\n  \"freq\": \"1mo\",\n  \"copper_series\": \"HG=F\",\n  \"equity_proxy_series\": \"ACWI\",\n  \"china_10y_yield_series\": \"tradingeconomics\",\n  \"ma_window\": 60,\n  \"rolling_window\": 24,\n  \"round_levels\": [10000, 13000],\n  \"backfill_max_drawdown\": 0.25,\n  \"resilience_weights\": {\n    \"momentum\": 0.4,\n    \"sma\": 0.4,\n    \"drawdown\": 0.2\n  },\n  \"output\": {\n    \"path\": \"result.json\",\n    \"format\": \"json\"\n  }\n}\n```\n\n使用配置檔：\n```bash\npython scripts/copper_stock_analyzer.py --config config.json\n```\n\n---\n\n## 參數驗證\n\n腳本會驗證以下條件：\n\n1. `start_date` < `end_date`\n2. `ma_window` >= 1\n3. `rolling_window` >= 12\n4. `round_levels` 至少包含 2 個值\n5. `backfill_max_drawdown` 在 (0, 1) 範圍內\n6. 權重總和 = 1.0\n\n驗證失敗時會輸出錯誤訊息並退出。\n",
        "skills/analyze-copper-stock-resilience-dependency/references/methodology.md": "本技能的邏輯來自對研究報告中「銅要漲得動，股市得繼續漲」這類定性敘述的量化轉譯。\n\n### 原始研究報告邏輯\n\n```\n研究報告圖表通常顯示：\n- 銅價（LME Copper futures）\n- 全球股市市值（Bloomberg World Exchange Market Cap USD）\n- 中國 10Y 公債殖利率\n\n隱含推理：\n「銅價接近 13,000 關卡，若要突破需要股市維持強勢；\n 否則可能出現 back-and-fill 回到 10,000 附近支撐。」\n```\n\n### 量化轉譯\n\n本技能將上述定性敘述轉化為可計算的指標：\n\n| 定性描述          | 量化指標                       |\n|-------------------|--------------------------------|\n| 「銅接近關卡」    | near_resistance / near_support |\n| 「股市維持強勢」  | equity_resilience_score        |\n| 「back-and-fill」 | backfill_probability           |\n| 「依賴股市」      | rolling_beta_equity            |\n\n---\n\n## 核心模型\n\n### 1. 趨勢狀態判定\n\n使用移動平均線與斜率定義趨勢：\n\n```\ncopper_trend = {\n    \"up\":    close > SMA(60) AND SMA_slope > 0\n    \"down\":  close < SMA(60) AND SMA_slope < 0\n    \"range\": otherwise\n}\n```\n\n**為何用 60 期（月）？**\n- 對應研究報告圖中的長期均線\n- 過濾短期雜訊，聚焦中長期趨勢\n\n### 2. 關卡判定\n\n心理整數位（round levels）是市場參與者普遍關注的價位：\n\n```python\nthreshold = 0.05  # 5% 容忍範圍\n\nnear_resistance = price 接近但低於關卡\nnear_support = price 接近但高於關卡\n```\n\n預設關卡：\n- **10,000 USD/ton**：重要支撐\n- **13,000 USD/ton**：重要阻力\n\n### 3. 股市韌性評分\n\n將「股市強勢」這個模糊概念量化為 0-100 分：\n\n| 因子     | 權重 | 計算方式                  | 邏輯         |\n|----------|------|---------------------------|--------------|\n| 12m 動能 | 40%  | 12 個月報酬率的歷史分位數 | 動能代表方向 |\n| 均線位置 | 40%  | 是否站上 12 月均線        | 趨勢確認     |\n| 近期回撤 | 20%  | 近 3 個月最大回撤（反向） | 穩定性       |\n\n**評分解讀：**\n- 70-100：高韌性，股市處於強勢\n- 30-70：中性，需觀察其他因子\n- 0-30：低韌性，股市偏弱\n\n### 4. 滾動迴歸（依賴強度量化）\n\n透過滾動 OLS 迴歸量化銅對股市與利率的敏感度：\n\n```\nΔcopper_t = α + β1 × Δequity_t + β2 × Δyield_t + ε_t\n```\n\n- **β1（股市貝塔）**：銅對全球股市的敏感度\n  - β1 > 0 且顯著：銅與股市正相關（風險資產特徵）\n  - β1 越大：銅越依賴股市\n  - **β1 < 0（負相關）**：銅與股市呈反向關係，這是重要的結構性訊號\n    - 可能原因：避險需求（銅作為實物資產）、供給衝擊、能源轉型獨立敘事\n    - 當 β1 位於歷史極端低位（如 <10% 分位）時，表示銅正脫離傳統風險資產模式\n\n- **β2（殖利率貝塔）**：銅對中國利率的敏感度\n  - β2 > 0：殖利率上升利好銅（可能是通膨敘事）\n  - β2 < 0：殖利率上升不利銅（可能是緊縮敘事）\n\n**視窗選擇：**\n- 預設 24 個月，平衡穩定性與反應性\n- 可依需求調整（12-36 個月）\n\n### 5. 回補機率估計\n\n統計歷史上「觸及高關卡後回補到低關卡」的頻率：\n\n**事件定義：**\n```python\n觸及事件 = 銅價 >= 13,000 × 0.98  # 接近或觸及 13,000\n回補事件 = 未來 12 個月內最低價 <= 10,000 × 1.02  # 回到 10,000 附近\n```\n\n**分組統計：**\n```\noverall_backfill_rate = 所有事件的回補率\nhigh_resilience_rate  = 韌性 >= 70 的事件回補率\nlow_resilience_rate   = 韌性 <= 30 的事件回補率\n```\n\n**核心洞察：**\n高韌性情境下的回補率通常顯著低於低韌性情境。\n\n---\n\n## 情境判讀邏輯\n\n### 條件式輸出（非單一因果）\n\n本技能使用條件式判讀，而非硬性結論：\n\n**問題 1：續航還是回補？**\n```\nIF copper_trend == \"up\" AND near_resistance AND resilience >= 70:\n    → \"續航機率較高\"\nELIF copper_trend == \"up\" AND near_resistance AND resilience < 50:\n    → \"回補風險上升\"\nELSE:\n    → \"需持續觀察\"\n```\n\n**問題 2：依賴股市有多強？**\n```\nIF beta_equity 位於歷史 75+ 分位:\n    → \"高依賴：市場正把銅當風險資產交易\"\nELIF beta_equity 位於歷史 50-75 分位:\n    → \"中度依賴\"\nELSE:\n    → \"低依賴：銅有自身邏輯\"\n```\n\n**問題 3：中國殖利率角色？**\n```\nIF yield_change < 0 AND resilience < 50:\n    → \"殖利率下行 + 股市不強 → 風險/成長壓力敘事（對銅不利）\"\nELIF yield_change < 0 AND resilience >= 70:\n    → \"殖利率下行 + 股市強勢 → 寬鬆/流動性敘事（未必對銅不利）\"\nELSE:\n    → \"中性，需觀察\"\n```\n\n---\n\n## 模型限制與注意事項\n\n### 限制\n\n1. **歷史不等於未來**：回補機率是歷史統計，不保證未來重演\n2. **代理變數偏差**：ACWI 不等於彭博全球市值，可能有追蹤誤差\n3. **數據頻率限制**：月頻數據無法捕捉日內波動\n4. **模型簡化**：三因子模型可能遺漏其他重要驅動因素\n\n### 注意事項\n\n1. **單位換算**：HG=F 為 $/lb，必須轉換為 $/ton\n2. **時區對齊**：確保三條序列使用相同的月底日期\n3. **快取管理**：爬蟲數據建議快取 12 小時\n4. **結合基本面**：本模型為技術面 + 跨資產分析，建議結合銅的基本面供需\n\n---\n\n## 參考文獻\n\n- 原始研究報告圖表概念\n- Merrill Lynch Investment Clock 模型\n- 跨資產相關性分析方法\n",
        "skills/analyze-copper-stock-resilience-dependency/templates/output-json.md": "# JSON 輸出模板\n\n## 完整輸出結構\n\n```json\n{\n  \"skill\": \"analyze-copper-stock-resilience-dependency\",\n  \"version\": \"0.1.0\",\n  \"as_of\": \"2026-01-20\",\n\n  \"inputs\": {\n    \"start_date\": \"2020-01-01\",\n    \"end_date\": \"2026-01-20\",\n    \"freq\": \"1mo\",\n    \"copper_series\": \"HG=F (converted to USD/ton)\",\n    \"equity_proxy_series\": \"ACWI\",\n    \"china_10y_yield_series\": \"TradingEconomics: China 10Y\",\n    \"ma_window\": 60,\n    \"rolling_window\": 24,\n    \"round_levels\": [10000, 13000]\n  },\n\n  \"data_summary\": {\n    \"total_periods\": 72,\n    \"copper_range\": {\n      \"min\": 5800,\n      \"max\": 13200,\n      \"latest\": 12700\n    },\n    \"equity_range\": {\n      \"min\": 65.2,\n      \"max\": 120.5,\n      \"latest\": 115.3\n    },\n    \"yield_range\": {\n      \"min\": 2.1,\n      \"max\": 3.8,\n      \"latest\": 2.45\n    }\n  },\n\n  \"latest_state\": {\n    \"date\": \"2026-01-20\",\n    \"copper_price_usd_per_ton\": 12700,\n    \"copper_sma_60\": 9261,\n    \"copper_sma_slope\": 42.5,\n    \"copper_trend\": \"up\",\n    \"near_resistance_levels\": [13000],\n    \"near_support_levels\": [],\n    \"distance_to_resistance_pct\": 2.36,\n    \"distance_to_support_pct\": null,\n    \"equity_price\": 115.3,\n    \"equity_12m_return\": 0.082,\n    \"equity_above_sma12\": true,\n    \"equity_drawdown_3m\": 0.025,\n    \"equity_resilience_score\": 78,\n    \"china_10y_yield\": 2.45,\n    \"china_yield_zscore_5y\": -0.35,\n    \"china_yield_change_12m\": -0.42,\n    \"rolling_beta_equity_24m\": 0.62,\n    \"rolling_beta_yield_24m\": -0.18,\n    \"rolling_r_squared_24m\": 0.45\n  },\n\n  \"historical_betas\": {\n    \"beta_equity_percentile\": 75,\n    \"beta_equity_mean\": 0.48,\n    \"beta_equity_std\": 0.21,\n    \"beta_yield_percentile\": 40,\n    \"beta_yield_mean\": -0.12,\n    \"beta_yield_std\": 0.15\n  },\n\n  \"backfill_analysis\": {\n    \"events_detected\": 8,\n    \"backfill_events\": 3,\n    \"backfill_probability_12m\": {\n      \"overall\": 0.375,\n      \"equity_resilience_high\": 0.20,\n      \"equity_resilience_low\": 0.60\n    },\n    \"events_detail\": [\n      {\n        \"touch_date\": \"2022-03-31\",\n        \"touch_price\": 13050,\n        \"trough_price\": 9800,\n        \"backfill\": true,\n        \"equity_resilience_at_touch\": 45\n      },\n      {\n        \"touch_date\": \"2024-05-31\",\n        \"touch_price\": 12980,\n        \"trough_price\": 11200,\n        \"backfill\": false,\n        \"equity_resilience_at_touch\": 72\n      }\n    ]\n  },\n\n  \"diagnosis\": {\n    \"trend_status\": \"上升趨勢中，銅價高於 60 月均線且均線斜率為正\",\n    \"level_status\": \"接近 13,000 關卡（距離 2.36%），為重要阻力位\",\n    \"resilience_status\": \"股市韌性評分 78，處於高韌性區間\",\n    \"dependency_status\": \"滾動 β_equity = 0.62，位於歷史 75 分位，銅正被當作風險資產交易\",\n    \"yield_interpretation\": \"中國10Y殖利率下行（-0.42%），但股市韌性高，偏向寬鬆/流動性敘事\",\n    \"narrative\": \"銅價接近 13,000 關卡，趨勢仍偏上行，但是否能續航高度依賴股市韌性。當前股市韌性高檔（78），歷史上類似情境的回補機率約 20%。若股市韌性轉弱跌破 50，回補至 10,000 附近的風險將顯著上升。\",\n    \"scenario\": \"續航機率較高\"\n  },\n\n  \"actionable_flags\": [\n    {\n      \"flag\": \"APPROACHING_RESISTANCE\",\n      \"level\": \"active\",\n      \"condition\": \"copper within 5% of 13000\",\n      \"meaning\": \"接近重要阻力位，關注能否突破\"\n    },\n    {\n      \"flag\": \"HIGH_RESILIENCE\",\n      \"level\": \"active\",\n      \"condition\": \"equity_resilience_score >= 70\",\n      \"meaning\": \"股市韌性高，支持突破\"\n    },\n    {\n      \"flag\": \"HIGH_BETA_REGIME\",\n      \"level\": \"active\",\n      \"condition\": \"beta_equity >= 75th percentile\",\n      \"meaning\": \"銅正被當作風險資產交易，與股市高度連動\"\n    }\n  ],\n\n  \"watch_conditions\": [\n    {\n      \"condition\": \"equity_resilience_score drops below 50\",\n      \"trigger\": \"WATCH_EQUITY_RESILIENCE\",\n      \"action\": \"回補風險上升，考慮減碼或設定停損\"\n    },\n    {\n      \"condition\": \"copper breaks above 13000 with volume\",\n      \"trigger\": \"BREAKOUT_CONFIRMATION\",\n      \"action\": \"突破確認，可考慮追進\"\n    },\n    {\n      \"condition\": \"copper drops below 10000\",\n      \"trigger\": \"SUPPORT_BREACH\",\n      \"action\": \"支撐跌破，重新評估趨勢\"\n    }\n  ],\n\n  \"metadata\": {\n    \"generated_at\": \"2026-01-20T14:30:00Z\",\n    \"execution_time_seconds\": 12.5,\n    \"data_sources\": {\n      \"copper\": \"yfinance:HG=F\",\n      \"equity\": \"yfinance:ACWI\",\n      \"yield\": \"tradingeconomics:scrape\"\n    },\n    \"cache_used\": {\n      \"copper\": false,\n      \"equity\": false,\n      \"yield\": true\n    }\n  }\n}\n```\n\n---\n\n## 欄位說明\n\n### 頂層欄位\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| `skill` | string | 技能名稱 |\n| `version` | string | 技能版本 |\n| `as_of` | string | 分析截止日期 |\n\n### inputs\n\n輸入參數的回顯，便於重現分析。\n\n### data_summary\n\n資料摘要，包含各序列的範圍與最新值。\n\n### latest_state\n\n**核心輸出**，當前狀態的完整資訊：\n\n| 欄位 | 說明 |\n|------|------|\n| `copper_price_usd_per_ton` | 銅價（USD/ton） |\n| `copper_trend` | 趨勢狀態（up/down/range） |\n| `near_resistance_levels` | 接近的阻力位列表 |\n| `equity_resilience_score` | 股市韌性評分（0-100） |\n| `rolling_beta_equity_24m` | 滾動 β 係數（股市） |\n| `rolling_beta_yield_24m` | 滾動 β 係數（殖利率） |\n\n### backfill_analysis\n\n回補機率分析：\n\n| 欄位 | 說明 |\n|------|------|\n| `events_detected` | 偵測到的觸及高關卡事件數 |\n| `backfill_probability_12m.overall` | 整體回補機率 |\n| `backfill_probability_12m.equity_resilience_high` | 高韌性情境回補機率 |\n| `backfill_probability_12m.equity_resilience_low` | 低韌性情境回補機率 |\n\n### diagnosis\n\n**情境判讀**，以自然語言呈現分析結論。\n\n### actionable_flags\n\n**可執行警報旗標**，用於程式化監控：\n\n| Flag | 觸發條件 |\n|------|----------|\n| `APPROACHING_RESISTANCE` | 接近阻力位 |\n| `APPROACHING_SUPPORT` | 接近支撐位 |\n| `HIGH_RESILIENCE` | 韌性 >= 70 |\n| `LOW_RESILIENCE` | 韌性 <= 30 |\n| `HIGH_BETA_REGIME` | β_equity >= 75 分位 |\n| `NEGATIVE_BETA_REGIME` | β_equity < 0（銅與股市呈反向關係） |\n| `LOW_BETA_ANOMALY` | β_equity <= 10 分位（歷史極端低位） |\n| `WATCH_EQUITY_RESILIENCE` | 韌性 < 50 且接近關卡 |\n\n### watch_conditions\n\n後續監控條件，可用於設定警報。\n\n---\n\n## 快速檢查模式輸出（簡化版）\n\n```json\n{\n  \"skill\": \"analyze-copper-stock-resilience-dependency\",\n  \"as_of\": \"2026-01-20\",\n  \"quick_check\": true,\n  \"latest_state\": {\n    \"copper_price_usd_per_ton\": 12700,\n    \"copper_trend\": \"up\",\n    \"near_resistance\": [13000],\n    \"equity_resilience_score\": 78,\n    \"rolling_beta_equity_24m\": 0.62\n  },\n  \"quick_diagnosis\": \"上升趨勢中，接近 13,000 關卡，股市韌性高（78），支持續航\",\n  \"flags\": [\"APPROACHING_RESISTANCE\", \"HIGH_RESILIENCE\"]\n}\n```\n",
        "skills/analyze-copper-stock-resilience-dependency/templates/output-markdown.md": "# Markdown 報告模板\n\n## 報告結構\n\n```markdown\n# 銅價股市韌性依賴分析報告\n\n**分析日期**：2026-01-20\n**數據期間**：2020-01-01 至 2026-01-20\n\n---\n\n## 摘要\n\n| 指標 | 數值 | 狀態 |\n|------|------|------|\n| 銅價 (USD/ton) | 12,700 | 接近 13,000 關卡 |\n| 趨勢狀態 | up | 上升趨勢 |\n| 60月均線 | 9,261 | 價格高於均線 |\n| 股市韌性評分 | 78 | 高韌性 |\n| β_equity (24m) | 0.62 | 高依賴度 |\n\n**情境判讀**：銅價接近 13,000 關卡，股市韌性高檔支持續航，回補風險相對較低。\n\n---\n\n## 1. 趨勢與關卡分析\n\n### 當前趨勢狀態\n\n- **趨勢**：上升趨勢 (up)\n- **價格**：12,700 USD/ton\n- **60月均線**：9,261 USD/ton\n- **均線斜率**：+42.5（正斜率）\n\n### 關卡判定\n\n| 關卡 | 類型 | 距離 | 狀態 |\n|------|------|------|------|\n| 13,000 | 阻力 | 2.36% | **接近中** |\n| 10,000 | 支撐 | 27.0% | 遠離 |\n\n---\n\n## 2. 股市韌性評分\n\n### 評分構成\n\n| 因子 | 數值 | 貢獻 |\n|------|------|------|\n| 12m 動能（分位數） | 82% | +32.8 |\n| 均線位置 | 高於12月均線 | +40.0 |\n| 近3m回撤 | 2.5% | +16.7 |\n| **總分** | - | **78** |\n\n### 評分解讀\n\n- **70-100**：高韌性 ✅ （當前狀態）\n- **30-70**：中性\n- **0-30**：低韌性\n\n---\n\n## 3. 依賴關係分析\n\n### 滾動迴歸結果（24個月視窗）\n\n| 因子 | β 值 | 歷史分位數 | 解讀 |\n|------|------|------------|------|\n| 股市 (ACWI) | 0.62 | 75th | 高依賴 |\n| 中國10Y殖利率 | -0.18 | 40th | 中性偏低 |\n\n### 依賴強度解讀\n\nβ_equity = 0.62 位於歷史 75 分位，意味著：\n- 銅正被市場當作風險資產交易\n- 與全球股市的連動性高於歷史平均\n- 需密切關注股市走向\n\n---\n\n## 4. 回補機率分析\n\n### 歷史事件統計\n\n觸及 13,000 後 12 個月內回補至 10,000 的頻率：\n\n| 情境 | 事件數 | 回補率 |\n|------|--------|--------|\n| 整體 | 8 | 37.5% |\n| 高韌性 (≥70) | 5 | **20%** |\n| 低韌性 (≤30) | 2 | **60%** |\n\n### 當前適用\n\n當前股市韌性 = 78（高韌性），參考「高韌性」情境的回補率 **20%**。\n\n---\n\n## 5. 中國利率環境\n\n### 殖利率狀態\n\n- **當前殖利率**：2.45%\n- **5年 Z-score**：-0.35（偏低）\n- **12個月變化**：-0.42%（下行）\n\n### 條件式解讀\n\n| 殖利率變化 | 股市韌性 | 解讀 |\n|------------|----------|------|\n| ↓ 下行 | 低 | 風險/成長壓力敘事（對銅不利） |\n| ↓ 下行 | **高** | **寬鬆/流動性敘事（未必對銅不利）** ✅ |\n\n當前情況：殖利率下行 + 股市韌性高 → 偏向寬鬆/流動性敘事。\n\n---\n\n## 6. 情境判讀\n\n### 核心問題回答\n\n**Q1: 現在是續航情境，還是回補情境？**\n\n> **續航機率較高**\n>\n> 銅價處於上升趨勢，接近 13,000 關卡，股市韌性評分 78 處於高韌性區間。\n> 歷史上類似情境的回補機率約 20%，續航機率約 80%。\n\n**Q2: 依賴股市有多強？**\n\n> **高依賴**\n>\n> 滾動 β_equity = 0.62，位於歷史 75 分位。\n> 市場正把銅當作風險資產交易，與股市高度連動。\n\n**Q3: 中國殖利率扮演什麼角色？**\n\n> **寬鬆/流動性敘事**\n>\n> 殖利率下行但股市強勢，偏向政策寬鬆而非成長壓力的解讀。\n> 這對銅價未必不利。\n\n---\n\n## 7. 警報旗標\n\n| Flag | 狀態 | 含義 |\n|------|------|------|\n| `APPROACHING_RESISTANCE` | 🟡 Active | 接近 13,000 阻力位 |\n| `HIGH_RESILIENCE` | 🟢 Active | 股市韌性高，支持突破 |\n| `HIGH_BETA_REGIME` | 🟡 Active | 與股市高度連動 |\n| `WATCH_EQUITY_RESILIENCE` | ⚪ Inactive | 韌性仍在高位 |\n\n---\n\n## 8. 後續監控建議\n\n| 條件 | 觸發後動作 |\n|------|------------|\n| 股市韌性跌破 50 | 回補風險上升，考慮減碼 |\n| 銅價帶量突破 13,000 | 突破確認，可考慮追進 |\n| 銅價跌破 10,000 | 支撐失守，重新評估趨勢 |\n\n---\n\n## 附錄\n\n### 數據來源\n\n- 銅價：Yahoo Finance (HG=F, 已轉換為 USD/ton)\n- 股市代理：Yahoo Finance (ACWI)\n- 中國10Y殖利率：TradingEconomics (爬蟲)\n\n### 分析參數\n\n- 移動平均視窗：60 期（月）\n- 滾動迴歸視窗：24 個月\n- 關卡位置：10,000 / 13,000 USD/ton\n- 韌性權重：動能 40%、均線 40%、回撤 20%\n\n---\n\n*報告生成時間：2026-01-20 14:30:00 UTC*\n```\n\n---\n\n## 模板使用說明\n\n### 變數替換\n\n報告中的動態數值以 `{variable}` 格式標記，腳本會自動替換：\n\n```python\ntemplate_vars = {\n    \"as_of\": \"2026-01-20\",\n    \"copper_price\": 12700,\n    \"copper_trend\": \"up\",\n    \"resilience_score\": 78,\n    \"beta_equity\": 0.62,\n    # ...\n}\n\nreport = template.format(**template_vars)\n```\n\n### 生成報告\n\n```bash\npython scripts/copper_stock_analyzer.py \\\n    --start 2020-01-01 \\\n    --end 2026-01-20 \\\n    --output report.md \\\n    --format markdown\n```\n",
        "skills/analyze-copper-stock-resilience-dependency/workflows/analyze.md": "# Workflow: 完整分析\n\n<required_reading>\n**執行前請閱讀：**\n1. references/methodology.md - 跨資產依賴方法論\n2. references/data-sources.md - 數據來源與爬蟲說明\n3. references/input-schema.md - 完整參數定義\n</required_reading>\n\n<process>\n\n## Step 1: 資料擷取 (Data Ingestion)\n\n抓取三條核心序列：\n\n### 1.1 銅期貨價格（月K）\n\n```python\n# 使用 yfinance 抓取 COMEX Copper\npython scripts/fetch_data.py --series HG=F --start 2020-01-01 --end 2026-01-20 --freq 1mo\n```\n\n**注意**：HG=F 為 $/lb，需轉換為 $/ton：\n```python\ncopper_usd_per_ton = copper_usd_per_lb * 2204.62262\n```\n\n### 1.2 全球股市韌性代理\n\n```python\n# 使用 yfinance 抓取 ACWI\npython scripts/fetch_data.py --series ACWI --start 2020-01-01 --end 2026-01-20 --freq 1mo\n```\n\n### 1.3 中國10年公債殖利率\n\n```python\n# 使用 Selenium 爬取 TradingEconomics\npython scripts/fetch_china_10y.py --start 2020-01-01 --end 2026-01-20\n```\n\n**快取策略**：爬蟲數據建議快取 12 小時，避免頻繁請求。\n\n### 1.4 資料對齊\n\n```python\n# 統一轉成月頻、對齊時間索引\ndf = align_monthly({\n    \"copper\": copper,\n    \"equity\": equity,\n    \"cny10y\": cny10y\n}).dropna()\n```\n\n## Step 2: 趨勢與關卡分析 (Trend & Round Levels)\n\n### 2.1 計算移動平均與趨勢\n\n```python\n# 計算 60 期（月）SMA\ndf[\"copper_sma\"] = df[\"copper\"].rolling(ma_window).mean()\ndf[\"copper_sma_slope\"] = df[\"copper_sma\"].diff()\n\n# 定義趨勢狀態\ndf[\"copper_trend\"] = np.where(\n    (df[\"copper\"] > df[\"copper_sma\"]) & (df[\"copper_sma_slope\"] > 0), \"up\",\n    np.where(\n        (df[\"copper\"] < df[\"copper_sma\"]) & (df[\"copper_sma_slope\"] < 0), \"down\",\n        \"range\"\n    )\n)\n```\n\n### 2.2 關卡判定\n\n```python\n# 設定關卡（如 10,000 / 13,000）\nround_levels = [10000, 13000]\nthreshold = 0.05  # 5% 容忍範圍\n\n# 判斷接近哪個關卡\nnear_resistance = [lv for lv in round_levels if abs(price - lv)/lv < threshold and price < lv]\nnear_support = [lv for lv in round_levels if abs(price - lv)/lv < threshold and price > lv]\n```\n\n## Step 3: 股市韌性評分 (Equity Resilience Score)\n\n### 3.1 計算三個因子\n\n```python\n# 12 個月動能\ndf[\"equity_12m_ret\"] = df[\"equity\"].pct_change(12)\n\n# 是否站上 12 月均線\ndf[\"equity_sma12\"] = df[\"equity\"].rolling(12).mean()\ndf[\"above_sma\"] = (df[\"equity\"] > df[\"equity_sma12\"]).astype(int)\n\n# 近 3 個月回撤\ndf[\"equity_3m_max\"] = df[\"equity\"].rolling(3).max()\ndf[\"equity_drawdown_3m\"] = (df[\"equity_3m_max\"] - df[\"equity\"]) / df[\"equity_3m_max\"]\n```\n\n### 3.2 計算加權評分\n\n```python\n# 分位數函數\ndef percentile_rank(series):\n    return series.rank(pct=True) * 100\n\n# 計算韌性評分\ndf[\"equity_resilience_score\"] = (\n    0.4 * percentile_rank(df[\"equity_12m_ret\"]) +\n    0.4 * df[\"above_sma\"] * 100 +\n    0.2 * (1 - np.clip(df[\"equity_drawdown_3m\"] / 0.15, 0, 1)) * 100\n)\n```\n\n## Step 4: 滾動迴歸 (Rolling Regression)\n\n### 4.1 計算報酬率\n\n```python\nret = pd.DataFrame({\n    \"dcopper\": df[\"copper\"].pct_change(),\n    \"dequity\": df[\"equity\"].pct_change(),\n    \"dyield\": df[\"cny10y\"].diff()\n}).dropna()\n```\n\n### 4.2 執行滾動迴歸\n\n```python\nfrom statsmodels.regression.rolling import RollingOLS\n\n# 設定 rolling window（24 個月）\nmodel = RollingOLS(\n    ret[\"dcopper\"],\n    sm.add_constant(ret[[\"dequity\", \"dyield\"]]),\n    window=rolling_window\n)\nbetas = model.fit()\n\n# 提取係數\ndf[\"beta_equity\"] = betas.params[\"dequity\"]\ndf[\"beta_yield\"] = betas.params[\"dyield\"]\ndf[\"r_squared\"] = betas.rsquared\n```\n\n## Step 5: 回補機率估計 (Backfill Probability)\n\n### 5.1 定義回補事件\n\n```python\ndef detect_backfill_events(df, level_hi=13000, level_lo=10000, lookforward=12):\n    \"\"\"\n    偵測觸及高關卡後回補到低關卡的事件\n    \"\"\"\n    events = []\n    for i, row in df.iterrows():\n        if row[\"copper\"] >= level_hi * 0.98:  # 觸及高關卡\n            future = df.loc[i:].head(lookforward)\n            trough = future[\"copper\"].min()\n            if trough <= level_lo * 1.02:  # 回到低關卡\n                events.append({\n                    \"touch_date\": i,\n                    \"touch_price\": row[\"copper\"],\n                    \"trough_price\": trough,\n                    \"backfill\": True,\n                    \"equity_resilience\": row[\"equity_resilience_score\"]\n                })\n            else:\n                events.append({\n                    \"touch_date\": i,\n                    \"touch_price\": row[\"copper\"],\n                    \"trough_price\": trough,\n                    \"backfill\": False,\n                    \"equity_resilience\": row[\"equity_resilience_score\"]\n                })\n    return pd.DataFrame(events)\n```\n\n### 5.2 分組統計\n\n```python\nevents_df = detect_backfill_events(df)\n\n# 整體回補率\noverall_backfill_rate = events_df[\"backfill\"].mean()\n\n# 依韌性分組\nhigh_resilience = events_df[events_df[\"equity_resilience\"] >= 70]\nlow_resilience = events_df[events_df[\"equity_resilience\"] <= 30]\n\nbackfill_stats = {\n    \"overall\": overall_backfill_rate,\n    \"equity_resilience_high\": high_resilience[\"backfill\"].mean(),\n    \"equity_resilience_low\": low_resilience[\"backfill\"].mean()\n}\n```\n\n## Step 6: 情境判讀 (Insight Generation)\n\n### 6.1 輸出診斷\n\n回答三個核心問題：\n\n**Q1: 現在是續航情境，還是回補情境？**\n```python\nif copper_trend == \"up\" and near_resistance and equity_resilience_score >= 70:\n    scenario = \"續航機率較高\"\nelif copper_trend == \"up\" and near_resistance and equity_resilience_score < 50:\n    scenario = \"回補風險上升\"\nelse:\n    scenario = \"需持續觀察\"\n```\n\n**Q2: 依賴股市有多強？**\n```python\nbeta_percentile = percentile_rank(beta_equity)\nif beta_percentile >= 75:\n    dependency = \"高依賴：市場正把銅當風險資產交易\"\nelif beta_percentile >= 50:\n    dependency = \"中度依賴\"\nelse:\n    dependency = \"低依賴：銅有自身邏輯\"\n```\n\n**Q3: 中國殖利率扮演什麼角色？**\n```python\nyield_change = df[\"cny10y\"].diff(12).iloc[-1]\nif yield_change < 0 and equity_resilience_score < 50:\n    yield_role = \"殖利率下行 + 股市不強 → 風險/成長壓力敘事（對銅不利）\"\nelif yield_change < 0 and equity_resilience_score >= 70:\n    yield_role = \"殖利率下行 + 股市強勢 → 寬鬆/流動性敘事（未必對銅不利）\"\nelse:\n    yield_role = \"中性，需觀察\"\n```\n\n## Step 7: 輸出結果\n\n```python\n# 執行完整分析\npython scripts/copper_stock_analyzer.py \\\n    --start 2020-01-01 \\\n    --end 2026-01-20 \\\n    --copper HG=F \\\n    --equity ACWI \\\n    --output result.json\n```\n\n輸出結構參見 `templates/output-json.md`。\n\n</process>\n\n<success_criteria>\n完整分析成功時應產出：\n\n- [ ] 銅價時間序列（已轉換為 USD/ton）\n- [ ] 趨勢狀態（up/down/range）\n- [ ] 關卡接近判定（near_resistance/near_support）\n- [ ] 股市韌性評分（0-100）\n- [ ] 滾動貝塔係數（β_equity, β_yield）\n- [ ] 回補機率統計（overall / high / low）\n- [ ] 情境判讀敘述\n- [ ] JSON 輸出檔案\n</success_criteria>\n",
        "skills/analyze-copper-stock-resilience-dependency/workflows/quick-check.md": "# Workflow: 快速檢查\n\n<required_reading>\n**執行前快速瀏覽：**\n1. references/data-sources.md - 確認資料來源可用\n</required_reading>\n\n<process>\n\n## Step 1: 執行快速檢查腳本\n\n```bash\ncd skills/analyze-copper-stock-resilience-dependency\npython scripts/copper_stock_analyzer.py --quick\n```\n\n此命令會：\n1. 抓取最近 3 年數據（使用快取優先）\n2. 計算當前狀態（趨勢、關卡、韌性評分）\n3. 輸出簡要摘要\n\n## Step 2: 解讀輸出\n\n### 輸出範例\n\n```json\n{\n  \"as_of\": \"2026-01-20\",\n  \"quick_check\": true,\n  \"latest_state\": {\n    \"copper_price_usd_per_ton\": 12700,\n    \"copper_sma_60\": 9261,\n    \"copper_trend\": \"up\",\n    \"near_resistance\": [13000],\n    \"near_support\": [],\n    \"equity_resilience_score\": 78,\n    \"rolling_beta_equity_24m\": 0.62\n  },\n  \"quick_diagnosis\": \"上升趨勢中，接近 13,000 關卡，股市韌性高（78），支持續航\",\n  \"flags\": [\"APPROACHING_RESISTANCE\"]\n}\n```\n\n### 欄位解讀\n\n| 欄位 | 含義 |\n|------|------|\n| copper_trend | 趨勢狀態：up/down/range |\n| near_resistance | 接近的上方關卡（阻力） |\n| near_support | 接近的下方關卡（支撐） |\n| equity_resilience_score | 股市韌性：70+ 高、30- 低 |\n| rolling_beta_equity_24m | 銅對股市的依賴度 |\n| flags | 警報旗標（見下方說明） |\n\n### 常見 Flags\n\n| Flag | 條件 | 建議動作 |\n|------|------|----------|\n| `APPROACHING_RESISTANCE` | 接近關卡上方 | 關注是否能突破 |\n| `APPROACHING_SUPPORT` | 接近關卡下方 | 關注是否會跌破 |\n| `WATCH_EQUITY_RESILIENCE` | 韌性 < 50 且接近關卡 | 回補風險上升 |\n| `HIGH_BETA_REGIME` | β_equity 位於高分位 | 銅正被當風險資產交易 |\n\n## Step 3: 判斷是否需要完整分析\n\n如果快速檢查顯示以下情況，建議執行完整分析：\n\n1. **接近關卡** (near_resistance 或 near_support 非空)\n2. **韌性邊界** (equity_resilience_score 在 45-55 之間)\n3. **趨勢轉換** (copper_trend = \"range\")\n\n完整分析命令：\n```bash\npython scripts/copper_stock_analyzer.py \\\n    --start 2020-01-01 \\\n    --end 2026-01-20 \\\n    --output result.json\n```\n\n</process>\n\n<success_criteria>\n快速檢查成功時應產出：\n\n- [ ] 當前銅價（USD/ton）\n- [ ] 趨勢狀態\n- [ ] 關卡接近判定\n- [ ] 股市韌性評分\n- [ ] 滾動貝塔（最近值）\n- [ ] 快速診斷摘要\n- [ ] 警報旗標（如有）\n</success_criteria>\n",
        "skills/analyze-copper-stock-resilience-dependency/workflows/visualize.md": "# Workflow: 視覺化圖表（Bloomberg 風格）\n\n<required_reading>\n**執行前請閱讀：**\n1. references/data-sources.md - 確認資料來源\n</required_reading>\n\n<process>\n\n## Step 1: 生成 Bloomberg 風格圖表\n\n### 1.1 快速生成（預設 2015-今）\n\n```bash\ncd skills/analyze-copper-stock-resilience-dependency\npython scripts/visualize.py\n```\n\n輸出檔案會自動命名為 `output/copper_resilience_YYYY-MM-DD.png`\n\n### 1.2 自訂參數\n\n```bash\npython scripts/visualize.py \\\n    --start 2015-01-01 \\\n    --end 2026-01-22 \\\n    -o output/copper_resilience_2026-01-22.png \\\n    --figsize 14,8 \\\n    --dpi 150 \\\n    --levels 10000,13000\n```\n\n## Step 2: 圖表元素說明\n\n圖表模仿 Bloomberg Intelligence 風格，包含：\n\n| 元素                 | 軸位   | 顏色   | 說明                       |\n|----------------------|--------|--------|----------------------------|\n| 銅價 (HG=F)          | R1 右軸 | 橙紅色 | 月線圖，轉換為 USD/ton     |\n| SMA(60)              | R1 右軸 | 橙黃色 | 60 月移動平均線            |\n| 全球股市市值         | L2 左軸 | 橙色   | 面積圖（VT 作為代理）      |\n| 中國 10Y 殖利率      | L1 左軸 | 黃色   | 折線圖                     |\n| 關卡線               | R1 右軸 | 灰色   | 10,000 / 13,000 整數位     |\n\n### 數值標註\n\n圖表右側會標註各序列的最新數值：\n- 銅價（粗體）\n- SMA60\n- 全球市值（兆美元）\n- 中國 10Y（%）\n\n## Step 3: 配置選項\n\n### 可用參數\n\n| 參數          | 預設值         | 說明               |\n|---------------|----------------|--------------------|\n| `--start`     | 2015-01-01     | 起始日期           |\n| `--end`       | 今天           | 結束日期           |\n| `-o/--output` | 自動生成       | 輸出路徑           |\n| `--figsize`   | 14,8           | 圖表尺寸（寬,高）  |\n| `--dpi`       | 150            | 解析度             |\n| `--levels`    | 10000,13000    | 關卡位置（逗號分隔）|\n| `--ma-window` | 60             | SMA 視窗           |\n\n### 輸出路徑規範\n\n建議輸出至專案根目錄的 `output/` 資料夾：\n\n```\noutput/\n├── copper_resilience_2026-01-22.png\n├── copper_resilience_2026-01-21.png\n└── ...\n```\n\n## Step 4: 從分析腳本生成\n\n也可以在完整分析後直接生成圖表：\n\n```bash\n# 完整分析 + 圖表\npython scripts/copper_stock_analyzer.py \\\n    --start 2015-01-01 \\\n    --end 2026-01-22 \\\n    --output data/result.json\n\n# 單獨生成圖表\npython scripts/visualize.py \\\n    --start 2015-01-01 \\\n    --end 2026-01-22 \\\n    -o output/copper_resilience_2026-01-22.png\n```\n\n</process>\n\n<success_criteria>\n視覺化成功時應產出：\n\n- [ ] Bloomberg 風格深色背景圖表\n- [ ] 多軸疊加（銅價 R1 + 市值 L2 + 殖利率 L1）\n- [ ] 銅價線 + SMA60 線\n- [ ] 全球市值橙色面積圖\n- [ ] 中國 10Y 黃色折線\n- [ ] 關卡位置標記（10,000 / 13,000）\n- [ ] 數值標註（最新值）\n- [ ] 圖例、來源、日期標註\n- [ ] 圖表儲存至 `output/` 目錄\n</success_criteria>\n\n<troubleshooting>\n\n### 常見問題\n\n**1. 找不到 mplfinance 模組**\n```bash\npip install mplfinance\n```\n\n**2. 中國殖利率爬取失敗**\n會自動使用模擬數據，不影響圖表生成。\n\n**3. 圖表中文亂碼**\n```python\nimport matplotlib.pyplot as plt\nplt.rcParams['font.sans-serif'] = ['Microsoft JhengHei', 'SimHei']\nplt.rcParams['axes.unicode_minus'] = False\n```\n\n**4. 數據時間範圍不一致**\n腳本會自動對齊到共同的時間區間。\n\n</troubleshooting>\n",
        "skills/analyze-copper-supply-concentration-risk/SKILL.md": "---\nname: analyze-copper-supply-concentration-risk\ndescription: 用公開資料量化「銅供應是否過度集中、主要產地是否結構性衰退、替代增量是否依賴少數國家」，並輸出可行的中期供應風險結論與情境推演。\n---\n\n<essential_principles>\n\n<principle name=\"narrative_to_metrics\">\n**敘事轉指標（Narrative to Metrics）**\n\n市場敘事必須可量化驗證。三大命題對應三組指標：\n\n| 命題 | 核心問題 | 量化指標 |\n|------|----------|----------|\n| A. 集中度 | 供應是否過度集中？ | CR4, CR5, 份額排名 |\n| B. 結構衰退 | 智利是否結構性衰退？ | 峰值年份、峰值回撤 |\n| C. 替代依賴 | 是否依賴秘魯/DRC？ | 秘魯+DRC 合計份額 vs 智利份額 |\n\n**注意**：由於 MacroMicro 只提供 5 個國家的細分數據，HHI 指標不適用於本分析。\n</principle>\n\n<principle name=\"data_source\">\n**數據來源：MacroMicro (WBMS)**\n\n唯一主要來源，使用 Chrome CDP **全自動**抓取 Highcharts 圖表數據。\n\n- URL: https://en.macromicro.me/charts/91500/wbms-copper-mine-production-total-world\n- 口徑: mined copper content（礦場產量的銅金屬含量）\n- 可用序列: World, Chile, Peru, DRC, China, US\n</principle>\n\n</essential_principles>\n\n<objective>\n分析全球銅供應的國家集中度與結構性風險。\n\n輸出兩層分析：\n1. **Concentration**: 國家份額排名、CR4/CR5\n2. **Chile vs Replacers**: 智利 vs 新興替代國（Peru + DRC）份額對比\n</objective>\n\n<quick_start>\n\n**全自動執行（無需手動操作 Chrome）**\n\n**Step 1：安裝依賴**\n```bash\npip install requests websocket-client pandas numpy matplotlib\n```\n\n**Step 2：一鍵抓取數據（自動啟動/關閉 Chrome）**\n```bash\ncd scripts\npython fetch_copper_production.py\n```\n\n腳本會自動：\n- 啟動 Chrome 調試模式\n- 等待頁面載入（~40 秒）\n- 提取 Highcharts 數據\n- 儲存到 `cache/copper_production.csv`\n- 關閉 Chrome\n\n**Step 3：生成 Bloomberg 風格視覺化圖表**\n```bash\npython visualize_copper_concentration.py\n```\n\n**輸出**：`output/copper_concentration.png`\n\n</quick_start>\n\n<intake>\n需要進行什麼分析？\n\n1. **快速圖表** - 直接生成 Bloomberg 風格集中度圖表\n2. **完整分析** - 1970 年至今的集中度趨勢分析（含數據表）\n3. **智利趨勢** - 智利產量份額與峰值回撤分析\n4. **替代評估** - 秘魯+DRC 替代依賴度分析\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response | Action |\n|----------|--------|\n| 1, \"快速\", \"圖表\", \"chart\" | `python scripts/fetch_copper_production.py && python scripts/visualize_copper_concentration.py` |\n| 2, \"完整\", \"trend\", \"1970\" | 抓取數據後輸出完整年度數據表 |\n| 3, \"智利\", \"chile\" | 分析智利份額趨勢與峰值 |\n| 4, \"替代\", \"replacement\", \"秘魯\", \"drc\" | 分析 Peru+DRC 是否已超越智利 |\n\n**路由後，執行對應命令。**\n</routing>\n\n<directory_structure>\n```\nanalyze-copper-supply-concentration-risk/\n├── SKILL.md                              # 本文件（路由器）\n├── skill.yaml                            # 前端展示元數據\n├── scripts/\n│   ├── fetch_copper_production.py        # 全自動 CDP 數據爬蟲\n│   └── visualize_copper_concentration.py # Bloomberg 風格視覺化\n├── cache/\n│   ├── copper_production.csv             # 數據快取\n│   └── copper_production_cache.json      # 原始 JSON 快取\n└── output/\n    └── copper_concentration.png          # 輸出圖表\n```\n</directory_structure>\n\n<scripts_index>\n| Script | Command | Purpose |\n|--------|---------|---------|\n| fetch_copper_production.py | `python fetch_copper_production.py` | 全自動 CDP 抓取（自動啟動/關閉 Chrome） |\n| fetch_copper_production.py | `--force-refresh` | 強制重新抓取（忽略快取） |\n| fetch_copper_production.py | `--start-year 1970` | 指定起始年份 |\n| visualize_copper_concentration.py | `python visualize_copper_concentration.py` | 生成 Bloomberg 風格圖表 |\n| visualize_copper_concentration.py | `--output path/to/output.png` | 指定輸出路徑 |\n</scripts_index>\n\n<visualization>\n\n**視覺化輸出：Bloomberg 風格銅供應集中度儀表板**\n\n包含兩張圖（上下排列）：\n1. **國家份額堆疊面積圖**：Chile, Peru, DRC, China, US, Others\n2. **智利 vs 新興替代國**：Chile vs Peru+DRC 份額對比，標記交叉點\n\n**配色**：Bloomberg 深色主題\n- 背景: `#1a1a2e`\n- Chile: `#ff6b35` (橙紅)\n- Peru: `#00bfff` (天藍)\n- DRC: `#00ff88` (綠)\n- Peru+DRC: `#00d4aa` (青綠)\n\n**快速繪圖**：\n```bash\ncd scripts\npython visualize_copper_concentration.py\n```\n\n**輸出路徑**：`output/copper_concentration.png`\n\n</visualization>\n\n<output_example>\n**2023 年關鍵指標**：\n\n| 國家 | 份額 |\n|------|------|\n| Chile | 23.5% |\n| Peru + DRC | 25.2% |\n| China | 7.5% |\n| US | 5.0% |\n\n**關鍵發現**：\n- 智利份額峰值：37.2% (2004)\n- 智利當前份額：23.5% (2023)\n- 峰值回撤：13.7pp\n- **2023 年 Peru+DRC 首次超越智利**（份額逆轉）\n</output_example>\n\n<success_criteria>\n分析成功時應產出：\n\n- [x] 數據已從 MacroMicro **全自動**抓取並快取\n- [x] 國家份額排名（Chile, Peru, DRC, China, US, Others）\n- [x] 智利峰值年份與回撤分析\n- [x] 秘魯+DRC 替代趨勢\n- [x] **Bloomberg 風格視覺化圖表**\n- [x] 明確標註數據來源\n</success_criteria>\n",
        "skills/analyze-copper-supply-concentration-risk/examples/full_report.md": "# 銅供應「集中 + 失速 + 依賴」快速檢核（1970-2023）\n\n**生成時間**：2026-01-24T10:30:00Z\n**數據口徑**：Mined copper content（礦場產量的銅金屬含量）\n\n---\n\n## 執行摘要\n\n本報告驗證市場常見的銅供應風險敘事。主要發現：\n\n| 命題 | 結論 | 關鍵指標 |\n|------|------|----------|\n| A. 供應集中 | ✅ 確認 | HHI=1820, CR4=56.2% |\n| B. 智利失速 | ✅ 確認 | 斜率=-47,000 t/年, 回撤=9.8% |\n| C. 替代依賴 | ⚠️ 部分 | ratio=1.05（調整後） |\n| D. 供應慣性 | ✅ 確認 | 10年基準缺口=4.9 Mt |\n| E. 地緣風險 | ⚠️ 顯著 | 系統風險=73.5/100 |\n\n---\n\n## 1) 供應是否高度集中？\n\n> **市場敘事**：「只有 10-12 國有顯著產量，智利像銅礦的 OPEC」\n\n### 驗證結果\n\n| 指標 | 2023年值 | 解讀 |\n|------|----------|------|\n| HHI | 1,820 | 中等集中 (Moderately Concentrated) |\n| CR4 | 56.2% | 前四國控制超過半數供應 |\n| CR8 | 73.4% | 前八國控制絕大多數供應 |\n| 智利份額 | 26.8% | 高於75%歷史年份 |\n\n### 國家份額排名\n\n| 排名 | 國家 | 產量 (Mt) | 份額 | 累積份額 |\n|------|------|-----------|------|----------|\n| 1 | 🇨🇱 Chile | 5.26 | 26.8% | 26.8% |\n| 2 | 🇵🇪 Peru | 2.00 | 10.2% | 37.0% |\n| 3 | 🇨🇩 DRC | 1.86 | 9.5% | 46.5% |\n| 4 | 🇨🇳 China | 1.70 | 8.7% | 55.2% |\n| 5 | 🇺🇸 USA | 1.10 | 5.6% | 60.8% |\n| 6 | 🇷🇺 Russia | 0.82 | 4.2% | 65.0% |\n| 7 | 🇦🇺 Australia | 0.78 | 4.0% | 69.0% |\n| 8 | 🇮🇩 Indonesia | 0.72 | 3.7% | 72.7% |\n\n### 時序趨勢\n\nHHI 從 1,720（2014年）**上升**至 1,820（2023年），增加 100 點（+5.8%）。\n\n**含義**：供應更像「少數國家的系統性依賴」，不是分散式供應鏈。\n\n---\n\n## 2) 智利是「儲量大但供應不安全」嗎？\n\n> **市場敘事**：「品位下滑 → 成本上升 → 產量衰退」\n\n### 驗證結果\n\n| 指標 | 數值 | 解讀 |\n|------|------|------|\n| 峰值年份 | 2018 | 產量達到 5.83 Mt |\n| 最新產量 | 5.26 Mt | 較峰值下滑 9.8% |\n| 近 10 年斜率 | -47,000 t/年 | 持續負向趨勢 |\n| 結構斷點 | 2016 | 趨勢由升轉降 |\n\n### 判定邏輯\n\n- slope < 0 : ✅ 確認\n- structural_break detected : ✅ 確認\n- drawdown > 10% : ⚠️ 接近（9.8%）\n\n**結論**：智利銅產量已進入**結構性衰退**期。\n\n### 品位推斷（country_proxy 模式）\n\n根據產量趨勢推斷，品位下滑**可能性高**（置信度 70%）：\n- 產量增速遠低於全球需求增速\n- 高銅價環境下產量仍未提升\n- 主要礦區公開報告品位下滑（Escondida: 1.0% → 0.6%）\n\n**含義**：如果產量進入結構性停滯/下滑，單看儲量會高估供應安全。\n\n---\n\n## 3) 世界是否被迫依賴秘魯與 DRC 擴產？\n\n> **市場敘事**：「near/medium term path 只能靠秘魯和剛果金」\n\n### 驗證結果\n\n| 項目 | 數量 | 說明 |\n|------|------|------|\n| 智利預期減產 | -0.47 Mt | 延續趨勢斜率 |\n| 秘魯預期增量 | +0.52 Mt | CAGR 4.2%，執行係數 0.8 |\n| DRC 預期增量 | +0.87 Mt | CAGR 8.9%，執行係數 0.7 |\n| **替代依賴度（原始）** | **2.18** | 表面看充足 |\n| **替代依賴度（調整後）** | **1.05** | 考慮執行風險後剛好填補 |\n| **淨缺口** | -0.02 Mt | 略有餘裕 |\n\n### 風險因素\n\n| 國家 | 政治風險 | 主要因素 |\n|------|----------|----------|\n| 秘魯 | 🟡 中 | 社會衝突、礦業稅制、社區抗議 |\n| DRC | 🔴 高 | 政治不穩定、武裝衝突、ESG爭議 |\n\n**含義**：表面上 ratio > 2 看似充足，但考慮執行風險後僅剛好填補。風險仍集中於兩個高風險國家。\n\n---\n\n## 4) 為何價格訊號不一定能快速解決缺口？\n\n> **市場敘事**：「歷史上沒有銅短缺，但這次供應反應慢」\n\n### 供應約束分析\n\n**新增大型礦場供應反應時間**：約 10 年\n\n| 增量來源 | 預期增量 | 可行性 |\n|----------|----------|--------|\n| 現有產能擴建 | +0.30 Mt | 短期可行 |\n| 在建項目 | +0.20 Mt | 中期釋放 |\n| 智利減產 | -0.82 Mt | 結構性趨勢 |\n| 秘魯增量 | +0.52 Mt | 執行風險中 |\n| DRC 增量 | +0.61 Mt | 執行風險高 |\n| **淨可行增量** | +0.81 Mt | - |\n| **供應天花板** | 24.7 Mt | 10 年內上限 |\n\n### 情境分析\n\n| 情境 | 需求 CAGR | 10年後需求 | 供需缺口 | 嚴重程度 |\n|------|-----------|------------|----------|----------|\n| 經濟放緩 | 1.5% | 25.6 Mt | 0.9 Mt | 🟢 小缺口 |\n| **基準情境** | **3.0%** | **29.6 Mt** | **4.9 Mt** | 🔴 嚴重缺口 |\n| 電氣化加速 | 5.0% | 35.8 Mt | 11.1 Mt | 🔴 嚴重缺口 |\n\n**含義**：供應鏈反應慢，短期價格上漲不等於短期供給彈性。\n\n---\n\n## 5) 地緣政治為何是宏觀供應慢變量風險？\n\n> **市場敘事**：「peace deal / insurgencies 被市場忽略」\n\n### 地緣風險指數\n\n| 國家 | 事件頻率 Z分數 | 風險等級 | 近期事件 |\n|------|----------------|----------|----------|\n| 智利 | 0.3 | 🟢 低 | 水資源爭議、原住民抗議 |\n| 秘魯 | 1.2 | 🟡 中高 | 多次罷工、Las Bambas 衝突 |\n| DRC | 2.1 | 🔴 高 | Mutanda 關閉、政府審查礦權 |\n\n*數據來源：GDELT 事件資料庫（近 12 個月）*\n\n### 系統風險評估\n\n**綜合分數：73.5/100**\n\n| 分項 | 分數 | 說明 |\n|------|------|------|\n| 集中度分數 | 18.2 | HHI 標準化 |\n| 依賴度分數 | 0.12 | 1 - replacement_ratio |\n| 地緣風險加權 | 1.65 | 替代國風險加權 |\n\n**解讀**：🔴 極高風險 - 供應中斷可能性顯著\n\n---\n\n## 綜合結論\n\n### 五命題驗證摘要\n\n| 命題 | 驗證結果 | 關鍵指標 |\n|------|----------|----------|\n| A. 供應高度集中 | ✅ 確認 | HHI=1820, CR4=56.2% |\n| B. 智利結構性衰退 | ✅ 確認 | slope=-47,000, drawdown=9.8% |\n| C. 依賴秘魯/DRC | ⚠️ 部分 | ratio=1.05（風險調整後） |\n| D. 供應反應慢 | ✅ 確認 | 基準情境缺口=4.9 Mt |\n| E. 地緣風險被忽略 | ⚠️ 顯著 | system_risk=73.5/100 |\n\n### 建議監控\n\n1. 📊 智利產量月度數據與主要礦區動態\n2. 🏭 秘魯勞工談判與社區衝突\n3. 🌍 DRC 政治穩定性與礦權政策\n4. 🚧 全球在建項目進度\n\n---\n\n## 數據來源與方法說明\n\n### 數據來源\n\n| 來源 | Tier | 用途 |\n|------|------|------|\n| MacroMicro (WBMS) | 0 | 主幹產量數據（唯一主要來源） |\n| GDELT | 3 | 地緣風險事件 |\n\n### 口徑說明\n\n本分析使用 **mined copper content**（礦場產量的銅金屬含量）：\n- ✅ 銅金屬含量（metric tonnes Cu）\n- ❌ 非 ore tonnes（礦石噸數）\n- ❌ 非 refined production（精煉產量）\n- ❌ 非 reserves（儲量）\n\n### 方法論\n\n- **集中度**：HHI = Σ (share × 100)²\n- **趨勢分析**：Rolling linear regression + breakpoint detection\n- **替代依賴度**：replacement_ratio = (秘魯增量 + DRC增量) / 智利缺口\n- **系統風險**：concentration × (1 + dependency) × (1 + geo_risk_weighted)\n\n---\n\n*報告生成時間：2026-01-24T10:30:00Z*\n*Skill 版本：analyze-copper-supply-concentration-risk v0.1.0*\n",
        "skills/analyze-copper-supply-concentration-risk/references/chile-supply-dynamics.md": "# 智利銅供應結構與動態\n\n## 智利銅礦概況\n\n### 全球地位\n\n| 指標 | 數值 | 全球排名 |\n|------|------|----------|\n| 礦場產量（2023） | ~5.26 Mt | #1 |\n| 銅儲量 | ~190 Mt | #1 |\n| 全球份額（產量） | ~26-27% | - |\n| 全球份額（儲量） | ~22% | - |\n\n### 核心矛盾\n\n> **儲量第一 ≠ 供應安全**\n>\n> 智利擁有全球最大銅儲量，但產量增長已停滯甚至下滑。\n> 這個矛盾是本 Skill 分析的核心問題。\n\n---\n\n## 主要礦區\n\n### Escondida（世界最大銅礦）\n\n| 項目 | 數值 |\n|------|------|\n| 位置 | Atacama 沙漠 |\n| 業主 | BHP (57.5%), Rio Tinto (30%), JECO (12.5%) |\n| 年產量 | ~1.1 Mt |\n| 全球佔比 | ~5% |\n| 開採方式 | 露天 + 地下 |\n\n**品位問題**：\n- 2010s 品位從 ~1.0% 降至 ~0.6%\n- 需要處理更多礦石維持產量\n\n### Codelco 系統\n\n| 礦區 | 年產量 | 說明 |\n|------|--------|------|\n| El Teniente | ~400 kt | 世界最大地下礦 |\n| Chuquicamata | ~350 kt | 世界最大露天轉地下 |\n| Radomiro Tomic | ~300 kt | 浸出礦 |\n| Andina | ~200 kt | - |\n\n**Codelco 挑戰**：\n- 國有企業，投資受政府預算限制\n- 老礦區轉型成本高\n- 2020s 產量持續下滑\n\n### 其他主要礦區\n\n| 礦區 | 業主 | 年產量 |\n|------|------|--------|\n| Collahuasi | Glencore/Anglo | ~550 kt |\n| Los Pelambres | Antofagasta | ~350 kt |\n| Candelaria | Lundin | ~150 kt |\n| Centinela | Antofagasta | ~300 kt |\n\n---\n\n## 品位下滑問題\n\n### 歷史趨勢\n\n| 年代 | 平均品位 | 說明 |\n|------|----------|------|\n| 1990s | ~1.5% | 高品位時代 |\n| 2000s | ~1.0% | 開始下滑 |\n| 2010s | ~0.7% | 顯著下滑 |\n| 2020s | ~0.6% | 繼續下滑 |\n\n### 影響分析\n\n**「挖兩倍礦才有同樣產出」**\n\n| 品位 | 產出 1t 銅需處理礦石 |\n|------|----------------------|\n| 1.5% | 67 t |\n| 1.0% | 100 t |\n| 0.6% | 167 t |\n\n**連鎖效應**：\n1. 處理量增加 → 設備投資增加\n2. 能源消耗增加 → 成本上升\n3. 水資源需求增加 → 沙漠地區壓力\n4. 尾礦量增加 → 環境負擔\n\n---\n\n## 結構性約束\n\n### 水資源限制\n\n智利北部礦區位於 Atacama 沙漠，水資源極度稀缺：\n\n| 解決方案 | 說明 | 成本影響 |\n|----------|------|----------|\n| 海水淡化 | 從海岸抽水淡化 | +$0.2-0.5/lb |\n| 長距離輸水 | 管線可達數百公里 | +$0.1-0.3/lb |\n| 水回收 | 提高回收率 | +$0.05-0.1/lb |\n\n### 電力成本\n\n| 因素 | 說明 |\n|------|------|\n| 能源結構 | 傳統依賴進口化石燃料 |\n| 可再生轉型 | 太陽能潛力大但需投資 |\n| 礦區用電 | 佔智利總電力消費 ~40% |\n\n### 勞動力與社會\n\n| 因素 | 說明 |\n|------|------|\n| 勞工談判 | 定期罷工風險 |\n| 社區關係 | 原住民土地權爭議 |\n| 環境抗議 | 水權、污染問題 |\n\n---\n\n## 產量趨勢分析\n\n### 歷史產量（1970-2023）\n\n```\n1970:  0.7 Mt ▁\n1980:  1.1 Mt ▂\n1990:  1.6 Mt ▃\n2000:  4.6 Mt ▇\n2010:  5.4 Mt █\n2018:  5.8 Mt █ ← 峰值\n2020:  5.7 Mt █\n2023:  5.3 Mt ▇ ← 回撤中\n```\n\n### 增長階段\n\n| 階段 | 年份 | 特徵 | CAGR |\n|------|------|------|------|\n| 擴張期 | 1990-2005 | Escondida 等大礦投產 | +7% |\n| 高原期 | 2005-2015 | 產量穩定 | +1% |\n| 停滯期 | 2015-2023 | 產量持平/下滑 | -0.5% |\n\n### 結構斷點\n\n**2016-2017 年**：產量增長趨勢由正轉負\n\n判定依據：\n- Rolling slope 轉負\n- 多個大礦區產量見頂\n- 投資週期結束\n\n---\n\n## 未來展望\n\n### 在建/規劃項目\n\n| 項目 | 業主 | 預期產量 | 投產時間 |\n|------|------|----------|----------|\n| Quebrada Blanca Phase 2 | Teck | +200 kt | 2023 |\n| Los Bronces expansion | Anglo | +100 kt | 2027 |\n| Codelco Chuqui underground | Codelco | 維持產量 | 2030s |\n\n### 增量 vs 減量\n\n| 來源 | 2023-2030 預期變化 |\n|------|-------------------|\n| 新項目 | +300-500 kt |\n| 老礦區衰減 | -400-600 kt |\n| **淨變化** | **-100 ~ +100 kt** |\n\n**結論**：即使所有項目順利推進，智利產量也難以顯著增長。\n\n---\n\n## 替代方案分析\n\n### ore_grade_mode 選項\n\n#### 1. none（不分析品位）\n- 只做產量趨勢分析\n- 適用於快速評估\n\n#### 2. country_proxy（間接代理）\n- 用產量趨勢推斷品位問題\n- 邏輯：高銅價 + 產量停滯 → 供應端問題\n- 本 Skill 預設使用\n\n#### 3. mine_level（礦場級數據）\n- 需要公司年報/財報數據\n- 可計算：ore_processed ≈ output / head_grade\n- 更精確但數據獲取成本高\n\n---\n\n## 關鍵監控指標\n\n| 指標 | 頻率 | 來源 | 意義 |\n|------|------|------|------|\n| 月度產量 | 月 | Cochilco | 短期趨勢 |\n| Codelco 季報 | 季 | Codelco | 國企動態 |\n| 勞資談判 | 事件 | 新聞 | 罷工風險 |\n| 水權政策 | 事件 | 政府公告 | 長期約束 |\n",
        "skills/analyze-copper-supply-concentration-risk/references/concentration-metrics.md": "# 集中度指標計算方法\n\n## 核心指標定義\n\n### Herfindahl-Hirschman Index (HHI)\n\n**公式**：\n```\nHHI = Σ (share_i × 100)²\n```\n\n其中 `share_i` 為第 i 個國家的市場份額（0-1）。\n\n**範圍**：0 - 10,000\n\n**解讀**：\n\n| HHI 範圍 | 市場結構 | 說明 |\n|----------|----------|------|\n| < 1,500 | 低集中 (Unconcentrated) | 競爭市場 |\n| 1,500 - 2,500 | 中等集中 (Moderately Concentrated) | 寡占傾向 |\n| > 2,500 | 高集中 (Highly Concentrated) | 寡占市場 |\n\n**計算範例**：\n```python\n# 假設 4 國各 25% 份額\nshares = [0.25, 0.25, 0.25, 0.25]\nhhi = sum((s * 100) ** 2 for s in shares)\n# hhi = 625 + 625 + 625 + 625 = 2,500\n\n# 假設 1 國 70% + 3 國各 10%\nshares = [0.70, 0.10, 0.10, 0.10]\nhhi = sum((s * 100) ** 2 for s in shares)\n# hhi = 4,900 + 100 + 100 + 100 = 5,200\n```\n\n---\n\n### 集中比率 (Concentration Ratio, CR_n)\n\n**公式**：\n```\nCR_n = Σ top_n_share\n```\n\n**常用指標**：\n- **CR4**：前 4 大生產國份額加總\n- **CR8**：前 8 大生產國份額加總\n\n**解讀**：\n\n| CR4 範圍 | 市場結構 |\n|----------|----------|\n| < 40% | 低集中 |\n| 40% - 60% | 中等集中 |\n| > 60% | 高集中 |\n\n---\n\n### 單國份額 (Country Share)\n\n**公式**：\n```\nshare_i = production_i / world_production\n```\n\n**關鍵閾值**（智利專用）：\n\n| 智利份額 | 風險等級 | 說明 |\n|----------|----------|------|\n| < 20% | 低 | 分散化較好 |\n| 20% - 30% | 中 | 顯著依賴 |\n| > 30% | 高 | 單點風險 |\n\n---\n\n## Python 實作\n\n```python\nimport pandas as pd\nimport numpy as np\n\ndef compute_shares(df: pd.DataFrame, year: int) -> pd.DataFrame:\n    \"\"\"\n    計算各國市場份額\n\n    Parameters:\n    -----------\n    df : pd.DataFrame\n        標準化產量數據（含 year, country, production）\n    year : int\n        目標年份\n\n    Returns:\n    --------\n    pd.DataFrame : 排序後的份額表\n    \"\"\"\n    year_data = df[df.year == year].copy()\n\n    # 取得世界總量\n    world_row = year_data[year_data.country == \"World\"]\n    if world_row.empty:\n        # 如果沒有 World 行，自己加總\n        world_total = year_data.production.sum()\n    else:\n        world_total = world_row.production.values[0]\n        year_data = year_data[year_data.country != \"World\"]\n\n    # 計算份額\n    year_data[\"share\"] = year_data.production / world_total\n    year_data[\"share_pct\"] = year_data.share * 100\n\n    # 排序\n    year_data = year_data.sort_values(\"share\", ascending=False).reset_index(drop=True)\n\n    # 計算累積份額\n    year_data[\"cumulative_share\"] = year_data.share.cumsum()\n\n    return year_data\n\n\ndef compute_hhi(shares_df: pd.DataFrame) -> float:\n    \"\"\"\n    計算 Herfindahl-Hirschman Index\n\n    Parameters:\n    -----------\n    shares_df : pd.DataFrame\n        compute_shares 的輸出\n\n    Returns:\n    --------\n    float : HHI 值（0-10000）\n    \"\"\"\n    return ((shares_df[\"share\"] * 100) ** 2).sum()\n\n\ndef compute_cr_n(shares_df: pd.DataFrame, n: int) -> float:\n    \"\"\"\n    計算前 N 大國家集中度\n\n    Parameters:\n    -----------\n    shares_df : pd.DataFrame\n        compute_shares 的輸出\n    n : int\n        前 N 大國家\n\n    Returns:\n    --------\n    float : CR_n 值（0-1）\n    \"\"\"\n    return shares_df.head(n)[\"share\"].sum()\n\n\ndef classify_market_structure(hhi: float) -> str:\n    \"\"\"\n    根據 HHI 分類市場結構\n    \"\"\"\n    if hhi < 1500:\n        return \"低集中 (Unconcentrated)\"\n    elif hhi < 2500:\n        return \"中等集中 (Moderately Concentrated)\"\n    else:\n        return \"高集中 (Highly Concentrated)\"\n\n\ndef compute_all_metrics(df: pd.DataFrame, year: int) -> dict:\n    \"\"\"\n    計算所有集中度指標\n\n    Returns:\n    --------\n    dict : 完整指標集\n    \"\"\"\n    shares = compute_shares(df, year)\n\n    hhi = compute_hhi(shares)\n    cr4 = compute_cr_n(shares, 4)\n    cr8 = compute_cr_n(shares, 8)\n\n    chile_row = shares[shares.country == \"Chile\"]\n    chile_share = chile_row[\"share\"].values[0] if not chile_row.empty else 0\n\n    return {\n        \"year\": year,\n        \"hhi\": round(hhi, 0),\n        \"cr4\": round(cr4, 4),\n        \"cr8\": round(cr8, 4),\n        \"chile_share\": round(chile_share, 4),\n        \"market_structure\": classify_market_structure(hhi),\n        \"top_3\": shares.head(3)[[\"country\", \"share\"]].to_dict(\"records\"),\n        \"top_producer\": shares.iloc[0][\"country\"],\n        \"top_producer_share\": round(shares.iloc[0][\"share\"], 4)\n    }\n```\n\n---\n\n## 時序分析\n\n```python\ndef compute_concentration_timeseries(df: pd.DataFrame, start_year: int, end_year: int) -> pd.DataFrame:\n    \"\"\"\n    計算多年份集中度指標\n\n    Returns:\n    --------\n    pd.DataFrame : 年度指標時序\n    \"\"\"\n    results = []\n\n    for year in range(start_year, end_year + 1):\n        try:\n            metrics = compute_all_metrics(df, year)\n            results.append(metrics)\n        except Exception as e:\n            print(f\"Warning: {year} 年計算失敗 - {e}\")\n            continue\n\n    return pd.DataFrame(results)\n\n\ndef analyze_trend(timeseries: pd.DataFrame, window: int = 10) -> dict:\n    \"\"\"\n    分析集中度趨勢\n\n    Returns:\n    --------\n    dict : 趨勢分析結果\n    \"\"\"\n    recent = timeseries.tail(window)\n\n    hhi_change = recent.hhi.iloc[-1] - recent.hhi.iloc[0]\n    chile_change = recent.chile_share.iloc[-1] - recent.chile_share.iloc[0]\n\n    return {\n        \"hhi_latest\": recent.hhi.iloc[-1],\n        \"hhi_10y_ago\": recent.hhi.iloc[0],\n        \"hhi_change\": hhi_change,\n        \"hhi_trend\": \"上升\" if hhi_change > 0 else \"下降\",\n        \"chile_share_latest\": recent.chile_share.iloc[-1],\n        \"chile_share_10y_ago\": recent.chile_share.iloc[0],\n        \"chile_change\": chile_change,\n        \"chile_trend\": \"上升\" if chile_change > 0 else \"下降\"\n    }\n```\n\n---\n\n## 歷史分位數\n\n```python\ndef compute_percentile(timeseries: pd.DataFrame, country: str, current_share: float) -> float:\n    \"\"\"\n    計算當前份額在歷史分布中的分位數\n\n    Parameters:\n    -----------\n    timeseries : pd.DataFrame\n        歷史時序數據\n    country : str\n        國家名稱\n    current_share : float\n        當前份額\n\n    Returns:\n    --------\n    float : 分位數（0-100）\n    \"\"\"\n    historical_shares = timeseries[f\"{country.lower()}_share\"].dropna()\n    percentile = (historical_shares < current_share).mean() * 100\n    return round(percentile, 0)\n```\n\n---\n\n## 視覺化建議\n\n### HHI 時序圖\n- X 軸：年份\n- Y 軸：HHI 值\n- 標記 1,500 和 2,500 門檻線\n- 標記當前值\n\n### 國家份額餅圖\n- 最新年度\n- 前 N 大國家 + \"Other\"\n- 標註份額百分比\n\n### CR 指標演進圖\n- X 軸：年份\n- Y 軸：CR 值（0-1）\n- 多線：CR4、CR8\n- 對比智利單國份額\n",
        "skills/analyze-copper-supply-concentration-risk/references/data-sources.md": "# 銅產量數據來源說明\n\n## 唯一主要來源：MacroMicro (WBMS)\n\n### 數據特性\n\n| 項目 | 說明 |\n|------|------|\n| 來源 | MacroMicro (財經M平方) |\n| 原始數據 | WBMS (World Bureau of Metal Statistics) |\n| URL | https://en.macromicro.me/charts/91500/wbms-copper-mine-production-total-world |\n| 口徑 | mined copper content（礦場產量的銅金屬含量） |\n| 單位 | 千噸（圖表）→ 噸（轉換後） |\n| 頻率 | 月度 |\n| 歷史起點 | 約 1970 年 |\n\n### 數據擷取方式\n\n**推薦：Chrome CDP（繞過 Cloudflare）**\n\n```bash\n# Step 1: 啟動 Chrome 調試模式\n\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" ^\n  --remote-debugging-port=9222 ^\n  --remote-allow-origins=* ^\n  --user-data-dir=\"%USERPROFILE%\\.chrome-debug-profile\" ^\n  \"https://en.macromicro.me/charts/91500/wbms-copper-mine-production-total-world\"\n\n# Step 2: 等待頁面載入（圖表顯示），然後執行\ncd scripts\npython fetch_copper_production.py --cdp\n```\n\n**備選：Selenium**\n\n```bash\npython fetch_copper_production.py --selenium --no-headless\n```\n\n### 可用國家\n\n圖表包含以下國家/地區的銅礦產量：\n\n- World（全球總量）\n- Chile（智利）\n- Peru（秘魯）\n- Democratic Republic of Congo（剛果民主共和國）\n- China（中國）\n- United States（美國）\n- Russia（俄羅斯）\n- Australia（澳洲）\n- Mexico（墨西哥）\n- Kazakhstan（哈薩克）\n- Canada（加拿大）\n- Indonesia（印尼）\n- Zambia（尚比亞）\n\n---\n\n## 口徑說明\n\n### 本技能使用口徑\n\n| 口徑 | 說明 | 使用 |\n|------|------|------|\n| **mined_production** | 礦場產量（銅金屬含量） | ✅ 主要 |\n| refined_production | 精煉產量 | ❌ 不使用 |\n| reserves | 儲量 | ⚠️ 參考用 |\n\n### 口徑差異警告\n\n⚠️ **不同口徑不可直接比較**：\n\n- **礦石噸數 vs 銅金屬含量**：礦石品位約 0.5-1.5%，1 噸銅金屬 ≈ 67-200 噸礦石\n- **礦場產量 vs 精煉產量**：精煉產量包含二次銅（廢銅回收），通常精煉 > 礦場\n\n---\n\n## 快取策略\n\n```python\nCACHE_MAX_AGE_HOURS = 12  # 快取有效期\n```\n\n快取路徑：\n- `scripts/cache/copper_production_cache.json` - 原始 Highcharts 數據\n- `scripts/cache/copper_production.csv` - 標準化 DataFrame\n\n---\n\n## 數據標準化 Schema\n\n```python\n{\n    \"year\": int,           # 年度\n    \"country\": str,        # 國家（標準化名稱）\n    \"production\": float,   # 產量（噸）\n    \"unit\": \"t_Cu_content\",\n    \"source_id\": \"MacroMicro\"\n}\n```\n",
        "skills/analyze-copper-supply-concentration-risk/references/failure-modes.md": "# 失敗模式與緩解策略\n\n## 數據擷取失敗\n\n### FM-001: OWID 數據不可用\n\n**症狀**：\n- HTTP 請求失敗（timeout, 404, 500）\n- GitHub 服務中斷\n\n**緩解策略**：\n1. 使用本地快取（若存在）\n2. 切換到 USGS 歷史數據（Tier 0 備援）\n3. 通知用戶並建議稍後重試\n\n```python\ndef fetch_with_fallback(primary_source, fallback_source, cache):\n    try:\n        return primary_source.fetch()\n    except Exception as e:\n        logger.warning(f\"主要來源失敗: {e}\")\n        if cache.is_valid():\n            logger.info(\"使用快取數據\")\n            return cache.load()\n        logger.info(\"切換到備援來源\")\n        return fallback_source.fetch()\n```\n\n### FM-002: GDELT API 限流\n\n**症狀**：\n- 429 Too Many Requests\n- 空回應\n\n**緩解策略**：\n1. 實作指數退避重試\n2. 減少查詢頻率\n3. 切換到 news_count 代理模式\n\n```python\ndef gdelt_with_backoff(query, max_retries=3):\n    for attempt in range(max_retries):\n        try:\n            return gdelt_query(query)\n        except RateLimitError:\n            wait_time = 2 ** attempt\n            time.sleep(wait_time)\n    return fallback_to_fixed_ratings()\n```\n\n---\n\n## 數據品質問題\n\n### FM-003: 國家名稱不一致\n\n**症狀**：\n- 同一國家有多種名稱\n- 份額加總不等於 100%\n\n**範例**：\n- \"Democratic Republic of the Congo\" vs \"DRC\" vs \"Congo, Dem. Rep.\"\n- \"United States\" vs \"USA\" vs \"United States of America\"\n\n**緩解策略**：\n```python\nCOUNTRY_MAPPING = {\n    \"DRC\": \"Democratic Republic of Congo\",\n    \"Congo, Dem. Rep.\": \"Democratic Republic of Congo\",\n    \"USA\": \"United States\",\n    # ... 完整映射表\n}\n\ndef normalize_country(name):\n    return COUNTRY_MAPPING.get(name, name)\n```\n\n### FM-004: 缺失值處理\n\n**症狀**：\n- 某年某國數據缺失\n- NaN 導致計算錯誤\n\n**緩解策略**：\n\n| 情況 | 策略 | 說明 |\n|------|------|------|\n| 單年缺失 | 線性插值 | `df.interpolate()` |\n| 連續多年缺失 | 標記為缺失 | 不參與計算 |\n| 最新年度缺失 | 使用上一年度 | 標記為 estimated |\n| 國家完全缺失 | 歸入 \"Other\" | 不單獨計算份額 |\n\n```python\ndef handle_missing_values(df, strategy=\"interpolate\"):\n    if strategy == \"interpolate\":\n        return df.interpolate(method=\"linear\", limit=2)\n    elif strategy == \"forward_fill\":\n        return df.ffill(limit=1)\n    elif strategy == \"drop\":\n        return df.dropna()\n```\n\n### FM-005: 口徑不一致\n\n**症狀**：\n- 混用 mined vs refined 數據\n- 混用 ore tonnage vs metal content\n\n**緩解策略**：\n1. 數據擷取時強制標記 `unit` 欄位\n2. 計算前驗證所有數據口徑一致\n3. 若不一致，發出警告並拒絕計算\n\n```python\ndef validate_unit_consistency(df):\n    units = df[\"unit\"].unique()\n    if len(units) > 1:\n        raise UnitMismatchError(\n            f\"數據口徑不一致: {units}。\"\n            f\"請確保所有數據使用相同口徑。\"\n        )\n```\n\n---\n\n## 計算邏輯問題\n\n### FM-006: 除以零錯誤\n\n**症狀**：\n- 計算 replacement_ratio 時智利缺口為 0\n- 計算 share 時全球產量為 0\n\n**緩解策略**：\n```python\ndef safe_divide(numerator, denominator, default=0):\n    if denominator == 0 or pd.isna(denominator):\n        return default\n    return numerator / denominator\n\n# 使用\nreplacement_ratio = safe_divide(\n    peru_inc + drc_inc,\n    chile_decline,\n    default=float('inf')  # 無限大表示「無缺口」\n)\n```\n\n### FM-007: 斷點偵測失敗\n\n**症狀**：\n- 數據過短無法偵測斷點\n- 所有年份都返回 breakpoint\n\n**緩解策略**：\n```python\ndef detect_breakpoint_safe(series, min_segment=5):\n    if len(series) < min_segment * 2:\n        return {\n            \"detected\": False,\n            \"reason\": f\"數據長度不足（需 {min_segment * 2} 年）\"\n        }\n\n    breakpoint = find_breakpoint(series, min_segment)\n\n    # 驗證斷點顯著性\n    if not is_significant_break(series, breakpoint):\n        return {\n            \"detected\": False,\n            \"reason\": \"斷點不顯著\"\n        }\n\n    return {\"detected\": True, \"break_year\": breakpoint}\n```\n\n---\n\n## 外部依賴問題\n\n### FM-008: 套件版本衝突\n\n**症狀**：\n- `ruptures` 與 `statsmodels` 版本衝突\n- 某些函數簽名變更\n\n**緩解策略**：\n1. 固定版本在 `requirements.txt`\n2. 提供無 `ruptures` 的備選實作\n\n```python\ntry:\n    import ruptures as rpt\n    HAS_RUPTURES = True\nexcept ImportError:\n    HAS_RUPTURES = False\n\ndef find_breakpoint(series, method=\"auto\"):\n    if method == \"ruptures\" and HAS_RUPTURES:\n        return find_breakpoint_ruptures(series)\n    else:\n        return find_breakpoint_simple(series)\n```\n\n### FM-009: 網路環境限制\n\n**症狀**：\n- 企業防火牆阻擋 API 請求\n- 無網路環境\n\n**緩解策略**：\n1. 支援離線模式（使用預先下載的數據）\n2. 提供手動數據輸入選項\n3. 允許用戶指定本地數據路徑\n\n```python\ndef load_data(source=\"auto\", local_path=None):\n    if local_path:\n        return pd.read_csv(local_path)\n    elif source == \"offline\":\n        return load_bundled_data()\n    else:\n        return fetch_from_api()\n```\n\n---\n\n## 輸出問題\n\n### FM-010: 視覺化失敗\n\n**症狀**：\n- `matplotlib` backend 問題\n- 圖片無法保存\n\n**緩解策略**：\n```python\nimport matplotlib\nmatplotlib.use('Agg')  # 非互動式 backend\n\ndef save_chart_safe(fig, filename):\n    try:\n        fig.savefig(filename, dpi=150, bbox_inches='tight')\n        return {\"status\": \"success\", \"path\": filename}\n    except Exception as e:\n        logger.error(f\"圖表保存失敗: {e}\")\n        return {\"status\": \"failed\", \"error\": str(e)}\n```\n\n### FM-011: 報告生成過長\n\n**症狀**：\n- Markdown 報告超過限制\n- 用戶難以閱讀\n\n**緩解策略**：\n1. 提供摘要版與完整版\n2. 使用折疊區塊\n3. 分割為多個檔案\n\n```python\ndef generate_report(results, detail_level=\"summary\"):\n    if detail_level == \"summary\":\n        return generate_summary(results)\n    elif detail_level == \"full\":\n        return generate_full_report(results)\n    elif detail_level == \"split\":\n        return {\n            \"summary\": generate_summary(results),\n            \"concentration\": generate_concentration_detail(results),\n            \"trend\": generate_trend_detail(results),\n            # ...\n        }\n```\n\n---\n\n## 錯誤回報格式\n\n當發生不可恢復的錯誤時，輸出標準化錯誤報告：\n\n```json\n{\n  \"status\": \"error\",\n  \"error_code\": \"FM-003\",\n  \"error_type\": \"DataQualityError\",\n  \"message\": \"數據口徑不一致：發現 mined 和 refined 混用\",\n  \"context\": {\n    \"affected_countries\": [\"Chile\", \"Peru\"],\n    \"affected_years\": [2022, 2023]\n  },\n  \"remediation\": [\n    \"檢查數據來源設定\",\n    \"確認使用相同口徑（建議 mined）\",\n    \"若需混用，請使用轉換係數\"\n  ],\n  \"partial_results\": null,\n  \"generated_at\": \"2026-01-24T10:30:00Z\"\n}\n```\n\n---\n\n## 監控與日誌\n\n```python\nimport logging\n\nlogging.basicConfig(\n    level=logging.INFO,\n    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',\n    handlers=[\n        logging.FileHandler('copper_analysis.log'),\n        logging.StreamHandler()\n    ]\n)\n\nlogger = logging.getLogger('copper_supply_risk')\n\n# 使用\nlogger.info(\"開始數據擷取\")\nlogger.warning(\"OWID 請求超時，使用快取\")\nlogger.error(\"計算失敗\", exc_info=True)\n```\n",
        "skills/analyze-copper-supply-concentration-risk/references/geopolitics-risk.md": "# 地緣風險指數計算方法\n\n## 概述\n\n地緣政治是銅供應的「慢變量」風險：\n- 市場常忽略（不在即時價格中反映）\n- 但一旦爆發，影響可能是結構性的\n- 需要持續監控並納入系統風險評估\n\n---\n\n## GDELT 事件資料庫\n\n### 簡介\n\nGDELT（Global Database of Events, Language, and Tone）是全球最大的事件資料庫：\n\n- **覆蓋**：全球 240+ 國家/地區\n- **歷史**：1979 年至今\n- **更新**：每 15 分鐘\n- **成本**：免費\n\n### API 端點\n\n```\nhttps://api.gdeltproject.org/api/v2/doc/doc\n```\n\n### 查詢參數\n\n| 參數 | 說明 | 範例 |\n|------|------|------|\n| query | 搜索關鍵字 | `mining AND (strike OR conflict)` |\n| timespan | 時間範圍 | `3months` |\n| mode | 輸出模式 | `ArtList`, `TimelineVol` |\n| sourcecountry | 來源國家 | `PE` (秘魯) |\n\n---\n\n## 風險關鍵字設計\n\n### 銅礦供應風險相關\n\n```python\nRISK_KEYWORDS = {\n    \"conflict\": [\n        \"mining conflict\",\n        \"mining protest\",\n        \"mining strike\",\n        \"mining violence\",\n        \"indigenous protest mining\"\n    ],\n    \"policy\": [\n        \"mining tax\",\n        \"mining regulation\",\n        \"nationalization mining\",\n        \"export ban mining\",\n        \"mining permit\"\n    ],\n    \"environmental\": [\n        \"mining water rights\",\n        \"mining pollution\",\n        \"mining environmental\",\n        \"tailings dam\"\n    ],\n    \"labor\": [\n        \"mining strike\",\n        \"mining union\",\n        \"mining workers\",\n        \"mining wage\"\n    ]\n}\n```\n\n### 國家特定關鍵字\n\n| 國家 | 額外關鍵字 |\n|------|-----------|\n| 智利 | `Codelco`, `Escondida`, `Atacama` |\n| 秘魯 | `Las Bambas`, `Antamina`, `Arequipa` |\n| DRC | `Katanga`, `Kamoa`, `Gécamines`, `cobalt` |\n\n---\n\n## 風險指數計算\n\n### Step 1: 事件頻率統計\n\n```python\ndef fetch_event_count(country: str, keywords: list, lookback_months: int = 12) -> int:\n    \"\"\"\n    從 GDELT 擷取特定國家的事件數量\n\n    Parameters:\n    -----------\n    country : str\n        目標國家\n    keywords : list\n        搜索關鍵字\n    lookback_months : int\n        回溯月數\n\n    Returns:\n    --------\n    int : 事件數量\n    \"\"\"\n    import requests\n\n    # 構建查詢\n    query = \" OR \".join([f'\"{kw}\"' for kw in keywords])\n    query += f' AND (country:{country} OR sourcecountry:{country})'\n\n    params = {\n        \"query\": query,\n        \"mode\": \"TimelineVol\",\n        \"timespan\": f\"{lookback_months}months\",\n        \"format\": \"json\"\n    }\n\n    url = \"https://api.gdeltproject.org/api/v2/doc/doc\"\n\n    try:\n        response = requests.get(url, params=params, timeout=30)\n        data = response.json()\n        # 解析並加總事件數\n        total_events = sum(item.get(\"value\", 0) for item in data.get(\"timeline\", []))\n        return total_events\n    except Exception as e:\n        print(f\"GDELT 查詢失敗: {e}\")\n        return None\n```\n\n### Step 2: 歷史基準建立\n\n```python\ndef compute_baseline_stats(country: str, keywords: list, years: int = 3) -> dict:\n    \"\"\"\n    計算歷史基準統計\n\n    Returns:\n    --------\n    dict : mean, std, min, max\n    \"\"\"\n    # 抓取過去 N 年每月事件數\n    monthly_counts = []\n\n    for months_ago in range(0, years * 12, 1):\n        count = fetch_event_count(country, keywords, lookback_months=1)\n        monthly_counts.append(count)\n\n    import numpy as np\n    return {\n        \"mean\": np.mean(monthly_counts),\n        \"std\": np.std(monthly_counts),\n        \"min\": np.min(monthly_counts),\n        \"max\": np.max(monthly_counts)\n    }\n```\n\n### Step 3: Z-Score 計算\n\n```python\ndef compute_geo_risk_zscore(current_count: int, baseline: dict) -> float:\n    \"\"\"\n    計算地緣風險 Z-Score\n\n    Z = (current - mean) / std\n\n    解讀：\n    - Z < 0：低於歷史平均（較安全）\n    - Z = 0-1：歷史平均水平\n    - Z = 1-2：偏高風險\n    - Z > 2：顯著高風險\n    \"\"\"\n    if baseline[\"std\"] == 0:\n        return 0.0\n\n    z_score = (current_count - baseline[\"mean\"]) / baseline[\"std\"]\n    return round(z_score, 2)\n\n\ndef classify_risk_level(z_score: float) -> str:\n    \"\"\"\n    根據 Z-Score 分類風險等級\n    \"\"\"\n    if z_score < 0:\n        return \"低\"\n    elif z_score < 1:\n        return \"中\"\n    elif z_score < 2:\n        return \"中高\"\n    else:\n        return \"高\"\n```\n\n---\n\n## 完整風險指數計算\n\n```python\ndef compute_country_geo_risk(country: str, lookback_months: int = 12) -> dict:\n    \"\"\"\n    計算單一國家的地緣風險指數\n\n    Returns:\n    --------\n    dict : 完整風險評估\n    \"\"\"\n    keywords = RISK_KEYWORDS[\"conflict\"] + RISK_KEYWORDS[\"policy\"] + RISK_KEYWORDS[\"labor\"]\n\n    # 當前事件數\n    current_count = fetch_event_count(country, keywords, lookback_months)\n\n    # 歷史基準（使用快取或預計算值）\n    baseline = get_cached_baseline(country)\n    if baseline is None:\n        baseline = compute_baseline_stats(country, keywords)\n\n    # Z-Score\n    z_score = compute_geo_risk_zscore(current_count, baseline)\n\n    return {\n        \"country\": country,\n        \"event_count_12m\": current_count,\n        \"historical_mean\": baseline[\"mean\"],\n        \"historical_std\": baseline[\"std\"],\n        \"z_score\": z_score,\n        \"risk_level\": classify_risk_level(z_score)\n    }\n```\n\n---\n\n## 系統風險整合\n\n### 加權方法\n\n地緣風險在系統風險中的權重，根據替代依賴度調整：\n\n```python\ndef compute_geo_weighted_risk(\n    geo_risks: dict,\n    replacement_weights: dict\n) -> float:\n    \"\"\"\n    計算加權地緣風險\n\n    Parameters:\n    -----------\n    geo_risks : dict\n        各國地緣風險 Z-Score\n        {\"Peru\": 1.2, \"DRC\": 2.1, \"Chile\": 0.3}\n    replacement_weights : dict\n        各國在替代供應中的權重\n        {\"Peru\": 0.45, \"DRC\": 0.55}  # 基於增量貢獻\n\n    Returns:\n    --------\n    float : 加權後的地緣風險分數\n    \"\"\"\n    weighted_sum = 0\n    total_weight = 0\n\n    for country, weight in replacement_weights.items():\n        if country in geo_risks:\n            weighted_sum += geo_risks[country] * weight\n            total_weight += weight\n\n    if total_weight == 0:\n        return 0\n\n    return weighted_sum / total_weight\n```\n\n### 整合到系統風險分數\n\n```python\ndef compute_system_risk(\n    concentration_score: float,\n    dependency_score: float,\n    geo_risk_weighted: float\n) -> dict:\n    \"\"\"\n    計算綜合系統風險分數\n\n    公式：\n    system_risk = concentration × (1 + dependency) × (1 + geo_risk × 0.2)\n\n    Parameters:\n    -----------\n    concentration_score : float\n        集中度分數（HHI/100，0-100 範圍）\n    dependency_score : float\n        依賴度分數（1 - replacement_ratio，調整後）\n    geo_risk_weighted : float\n        加權地緣風險 Z-Score\n\n    Returns:\n    --------\n    dict : 系統風險評估\n    \"\"\"\n    # 地緣風險乘數（Z-Score → 乘數）\n    geo_multiplier = 1 + geo_risk_weighted * 0.2\n\n    # 綜合分數\n    raw_score = concentration_score * (1 + dependency_score) * geo_multiplier\n\n    # 標準化到 0-100\n    system_risk = min(raw_score, 100)\n\n    return {\n        \"system_risk_score\": round(system_risk, 1),\n        \"components\": {\n            \"concentration\": round(concentration_score, 1),\n            \"dependency\": round(dependency_score, 2),\n            \"geo_risk\": round(geo_risk_weighted, 2)\n        },\n        \"interpretation\": interpret_system_risk(system_risk)\n    }\n\n\ndef interpret_system_risk(score: float) -> str:\n    if score < 30:\n        return \"低風險 - 供應鏈相對穩健\"\n    elif score < 50:\n        return \"中等風險 - 需關注關鍵國家動態\"\n    elif score < 70:\n        return \"高風險 - 建議評估對沖策略\"\n    else:\n        return \"極高風險 - 供應中斷可能性顯著\"\n```\n\n---\n\n## 替代方案\n\n### 當 GDELT 不可用時\n\n#### 1. 新聞計數代理（news_count）\n\n使用 Google News API 或類似服務：\n\n```python\ndef fetch_news_count_proxy(country: str, keywords: list, days: int = 30) -> int:\n    \"\"\"\n    使用新聞搜索計數作為風險代理\n    \"\"\"\n    # 使用 Google News RSS 或其他新聞 API\n    pass\n```\n\n#### 2. 固定風險評級\n\n基於歷史經驗設定固定值：\n\n```python\nFIXED_RISK_RATINGS = {\n    \"Chile\": {\"risk_level\": \"低\", \"z_score\": 0.3},\n    \"Peru\": {\"risk_level\": \"中高\", \"z_score\": 1.5},\n    \"DRC\": {\"risk_level\": \"高\", \"z_score\": 2.0}\n}\n```\n\n---\n\n## 監控與警報\n\n### 警報門檻\n\n| Z-Score | 警報等級 | 行動 |\n|---------|----------|------|\n| < 1 | 正常 | 例行監控 |\n| 1-2 | 注意 | 增加監控頻率 |\n| 2-3 | 警告 | 評估對沖策略 |\n| > 3 | 緊急 | 立即評估供應鏈影響 |\n\n### 監控頻率\n\n| 國家風險等級 | 建議頻率 |\n|--------------|----------|\n| 高（DRC） | 每日 |\n| 中高（秘魯） | 每週 |\n| 中/低（智利） | 每月 |\n",
        "skills/analyze-copper-supply-concentration-risk/references/methodology.md": "這套方法把「供應風險」拆成三塊，分別對應到可以用公開資料計算的指標。\n\n### 1) 供應集中度：少數國家決定了全球供應彈性\n**直覺**：如果某一兩個國家佔全球產量比重很大，那它的任何事故、政策、成本上升，都會變成全球問題。  \n**做法**：用各國的銅礦產量（國家×年份）計算市場份額，再做集中度指標（例如前四大國份額、或更完整的集中度指數）。\n\n> 你可以把它想成：「供應端的市場結構」  \n> 越集中 → 越像少數供應商市場 → 越容易出現供應衝擊。\n\n---\n\n### 2) 結構性衰退：不是沒儲量，而是「越挖越難、越挖越貴」\n在經濟學上，智利產量可能因為長期因素下滑」屬於**供給曲線往上移**的現象：同樣產量需要更高成本、更大投入。\n\n**做法（用公開數據也能做的版本）**：\n- 不一定要直接拿到礦石品位，先用最保守的方式看：  \n  - 智利產量是否從長期上升轉為停滯或下降？\n  - 是否出現明顯的「高點後回落」？\n  - 是否存在「趨勢轉折點」？\n\n> 重點是辨別：  \n> **產量下降是短期景氣（循環）**，還是**供應能力本身在變弱（結構）**。\n\n---\n\n### 3) 替代依賴：少數國家是否有能力補上缺口？\n如果智利走弱，世界只能靠秘魯與剛果金在中期擴產。  \n這裡的核心就是：**替代國的增產速度是否足夠、而且是否穩定**。\n\n**做法**：\n- 算出近十年（或十五年）各國產量新增量，看看「新增供應主要來自誰」。\n- 再做一個直覺比值：  \n  - 「秘魯＋剛果金未來可能新增的量」  \n  除以  \n  - 「智利如果持續下滑，可能減少的量」\n\n> 比值越接近 1，代表剛好補得上；  \n> 小於 1，代表補不上；  \n> 大於 1 才有餘裕支撐新增需求（例如交通電氣化）。\n\n---\n\n## 三、應用：這套方法適合用在哪些決策？\n這不是用來抓明天漲跌，而是用來做三種中期決策：\n\n1) **大宗商品的中期供需框架**：判斷銅是否可能進入「供需拉鋸、價格易偏緊」的結構。\n2) **供應鏈與地緣風險研究**：若全球依賴某兩國補缺口，那政治事件、政策變動會變成宏觀變數。\n3) **資產配置與產業分析**：例如電網、電動車、工業自動化等產業的成本結構，是否會被銅供應的緊縮牽動。\n\n---\n\n## 四、案例示範：用這套方法解讀「智利主導、秘魯與剛果金補位」\n以下用案例邏輯，示範如何一步步用數據把它說清楚。\n\n### (A) 先驗證「集中度」：智利是不是像供應端的單點？\n從全球銅礦產量資料切出各國份額，你通常會看到：\n- 全球產量並不是平均分散，而是集中在少數國家。\n- 智利長期位居最大產國，份額顯著高於其他國家。\n\n**這一步的結論語氣**應該是：\n> 「銅礦供應在國家層級呈現高度集中，智利的份額使其具備系統性影響力。」\n\n---\n\n### (B) 再看智利的「趨勢是否轉折」：是短期回落，還是長期下滑？\n從智利長期產量曲線，你會看到：\n- 長期曾大幅上升，但近年出現「高檔震盪甚至回落」的跡象。\n- 這符合案例想表達的重點：即使儲量仍大，**產量也可能因成本與難度上升而下降**。\n\n**這一步的結論語氣**應該是：\n> 「智利的問題不在於資源是否存在，而在於供給能力可能出現結構性限制，導致產量難以再像過去一樣上升。」\n\n---\n\n### (C) 最後檢查「替代依賴」：秘魯與剛果金是否真的在扛新增量？\n從近十多年各國新增量來看，你通常會看到：\n- 秘魯與剛果金的增產幅度在主要產國中很突出。\n- 這使得案例的判斷（中期增量主要靠這兩國）具備可被數據支持的基礎。\n\n但這裡也要補上一句更完整、經濟系友善的提醒：\n> 「即使兩國具備增產潛力，全球供應安全仍取決於它們能否持續、穩定地擴產；而擴產本身有時間與投資門檻，不可能一兩季就完成。」\n\n---\n\n### (D) 把「慢變量」講清楚：為何這不只是下一季的事？\n不要只看短期，因為供應端調整很慢。  \n你可以用一句話把邏輯收束成經濟學的供給特性：\n\n> 「銅礦擴產需要多年規劃與投資，供給短期彈性低；因此當需求因電氣化上升時，價格訊號未必能迅速換來供應增加，供需緊張可能以『慢變量』方式累積。」\n",
        "skills/analyze-copper-supply-concentration-risk/references/replacement-countries.md": "# 替代供應國分析：秘魯與剛果金\n\n## 替代依賴度框架\n\n當智利產量無法維持增長時，全球銅供應增量主要依賴：\n\n1. **秘魯** - 地理鄰近、礦業基礎完善\n2. **剛果金 (DRC)** - 增速最快、品位較高\n3. **其他** - 印尼、蒙古、贊比亞等\n\n---\n\n## 秘魯銅礦概況\n\n### 基本數據\n\n| 指標 | 數值 | 全球排名 |\n|------|------|----------|\n| 礦場產量（2023） | ~2.0 Mt | #2 |\n| 銅儲量 | ~81 Mt | #3 |\n| 全球份額（產量） | ~9-10% | - |\n\n### 主要礦區\n\n| 礦區 | 業主 | 年產量 | 說明 |\n|------|------|--------|------|\n| Antamina | Glencore/BHP/Teck | ~400 kt | 世界級銅鋅礦 |\n| Cerro Verde | Freeport-McMoRan | ~400 kt | 浸出 + 精礦 |\n| Las Bambas | MMG | ~350 kt | 爭議礦區 |\n| Southern Peru | Southern Copper | ~350 kt | 多礦區系統 |\n| Quellaveco | Anglo | ~300 kt | 2022 新投產 |\n\n### 增長歷史\n\n```\n2010: 1.2 Mt ▃\n2015: 1.7 Mt ▅\n2020: 2.1 Mt ▇\n2023: 2.0 Mt ▇\n```\n\n近 10 年 CAGR：~4%\n\n### 風險因素\n\n#### 1. 社會衝突\n\n| 因素 | 說明 | 近期事件 |\n|------|------|----------|\n| 社區抗議 | 對礦業環境影響的反對 | Las Bambas 道路封鎖 |\n| 原住民權益 | 土地權與補償爭議 | 多個項目延期 |\n| 罷工 | 勞工待遇談判 | 2023 多次罷工 |\n\n#### 2. 政治不確定性\n\n| 因素 | 說明 |\n|------|------|\n| 政府更迭頻繁 | 2016-2023 年多次政變/彈劾 |\n| 礦業政策搖擺 | 稅制改革提案反覆 |\n| 投資環境 | 企業觀望情緒 |\n\n#### 3. 基礎設施\n\n| 因素 | 說明 |\n|------|------|\n| 物流瓶頸 | 道路運輸風險（社區封路） |\n| 電力供應 | 部分礦區依賴自發電 |\n| 水資源 | 安第斯高原水權爭議 |\n\n### 執行係數建議\n\n考慮上述風險，建議對秘魯增量潛力使用 **0.7-0.8** 的執行係數。\n\n---\n\n## 剛果金 (DRC) 銅礦概況\n\n### 基本數據\n\n| 指標 | 數值 | 全球排名 |\n|------|------|----------|\n| 礦場產量（2023） | ~1.9 Mt | #3 |\n| 銅儲量 | ~31 Mt | #4 |\n| 全球份額（產量） | ~8-9% | - |\n\n### 主要礦區（加丹加省）\n\n| 礦區 | 業主 | 年產量 | 說明 |\n|------|------|--------|------|\n| Kamoa-Kakula | Ivanhoe/Zijin | ~400 kt | 新投產，增長中 |\n| Tenke Fungurume | CMOC | ~350 kt | 銅鈷複合礦 |\n| Kamoto | Glencore | ~250 kt | - |\n| Mutanda | Glencore | 0 (停產) | 2019 停產 |\n| Frontier | First Quantum | ~100 kt | 邊境礦 |\n\n### 增長歷史\n\n```\n2010: 0.5 Mt ▂\n2015: 1.0 Mt ▄\n2020: 1.6 Mt ▆\n2023: 1.9 Mt █\n```\n\n近 10 年 CAGR：~9%（全球最快）\n\n### Kamoa-Kakula：遊戲改變者\n\n| 指標 | 數值 |\n|------|------|\n| 品位 | ~4-6%（全球最高之一） |\n| 儲量 | 數十年開採壽命 |\n| 擴產潛力 | 目標 800 kt+ |\n| 問題 | 電力供應、物流 |\n\n### 風險因素\n\n#### 1. 政治風險\n\n| 因素 | 說明 |\n|------|------|\n| 政治不穩定 | 選舉爭議、武裝衝突 |\n| 礦權審查 | 2022-2023 政府重新審查礦權 |\n| 國有化風險 | 增加國家持股的政策傾向 |\n\n#### 2. 安全風險\n\n| 因素 | 說明 |\n|------|------|\n| 武裝團體 | 東部地區衝突 |\n| 非法採礦 | 小規模非法開採 |\n| 物流安全 | 運輸線路風險 |\n\n#### 3. ESG 爭議\n\n| 因素 | 說明 |\n|------|------|\n| 人權問題 | 童工、社區遷移 |\n| 環境爭議 | 鈷礦開採相關問題 |\n| 供應鏈透明度 | 西方買家審查加嚴 |\n\n#### 4. 基礎設施\n\n| 因素 | 說明 |\n|------|------|\n| 電力供應 | 依賴進口電力或自發電 |\n| 物流 | 內陸國，依賴鄰國港口 |\n| 加工能力 | 部分出口為礦石/精礦 |\n\n### 執行係數建議\n\n考慮上述風險，建議對 DRC 增量潛力使用 **0.6-0.7** 的執行係數。\n\n---\n\n## 替代依賴度計算\n\n### 公式\n\n```\nreplacement_ratio = (expected_increment_peru + expected_increment_drc) / expected_chile_decline\n```\n\n### 計算範例\n\n**假設條件（10 年）**：\n- 智利產量延續趨勢斜率 -47,000 t/年 → 缺口 470,000 t\n- 秘魯 CAGR 4%，執行係數 0.8 → 增量 ~520,000 t × 0.8 = 416,000 t\n- DRC CAGR 9%，執行係數 0.7 → 增量 ~870,000 t × 0.7 = 609,000 t\n\n```\nreplacement_ratio = (416,000 + 609,000) / 470,000 = 2.18\n```\n\n這個結果看起來很樂觀，但：\n\n1. **執行風險**：兩國都有顯著的政治/社會風險\n2. **風險集中**：依賴兩個高風險國家不比依賴智利更安全\n3. **時間錯配**：增量需要新項目投產，有時滯\n\n### 風險調整後的解讀\n\n| Ratio | 表面含義 | 風險調整後含義 |\n|-------|----------|----------------|\n| > 2.0 | 充足餘裕 | 考慮執行風險後可能只是「剛好」 |\n| 1.0-2.0 | 基本填補 | 可能出現供應緊張 |\n| < 1.0 | 替代不足 | 供應缺口幾乎確定 |\n\n---\n\n## 其他替代來源\n\n### 潛在增量國\n\n| 國家 | 2023 產量 | 潛在項目 | 增量潛力 |\n|------|-----------|----------|----------|\n| 印尼 | ~700 kt | Grasberg 地下 | +100 kt |\n| 蒙古 | ~600 kt | Oyu Tolgoi 地下 | +200 kt |\n| 贊比亞 | ~800 kt | Kalumbila 擴建 | +100 kt |\n| 巴拿馬 | ~350 kt | (已關閉 Cobre Panama) | -350 kt |\n\n### 限制因素\n\n- **印尼**：Grasberg 轉地下後產量穩定但難大幅增加\n- **蒙古**：地緣政治風險（夾在中俄之間）\n- **贊比亞**：電力問題、投資環境\n- **巴拿馬**：Cobre Panama 2023 年底被迫關閉\n\n---\n\n## 監控指標\n\n### 秘魯\n\n| 指標 | 頻率 | 來源 |\n|------|------|------|\n| 社區衝突事件 | 即時 | 新聞 |\n| Las Bambas 道路狀況 | 週 | 公司公告 |\n| 政府礦業政策 | 月 | 政府公報 |\n| 月度產量 | 月 | MINEM |\n\n### DRC\n\n| 指標 | 頻率 | 來源 |\n|------|------|------|\n| Kamoa-Kakula 產量 | 季 | Ivanhoe |\n| 礦權政策變化 | 事件 | 新聞 |\n| 電力供應狀況 | 月 | 公司報告 |\n| 安全局勢 | 即時 | GDELT |\n",
        "skills/analyze-copper-supply-concentration-risk/templates/output-json.md": "# JSON 輸出結構模板\n\n## 完整報告輸出\n\n```json\n{\n  \"commodity\": \"copper\",\n  \"analysis_type\": \"full_report\",\n  \"generated_at\": \"2026-01-24T10:30:00Z\",\n  \"period\": {\n    \"start_year\": 1970,\n    \"end_year\": 2023\n  },\n  \"parameters\": {\n    \"concentration_metric\": \"HHI\",\n    \"top_n_producers\": 12,\n    \"structural_break\": true,\n    \"ore_grade_mode\": \"country_proxy\",\n    \"supply_lead_time_years\": 10,\n    \"geopolitics_mode\": \"gdelt\"\n  },\n\n  \"proposition_a\": {\n    \"title\": \"供應是否高度集中？\",\n    \"verdict\": \"是\",\n    \"metrics\": {\n      \"hhi_latest\": 1820,\n      \"hhi_10y_ago\": 1750,\n      \"hhi_trend\": \"上升\",\n      \"cr4_latest\": 0.562,\n      \"cr8_latest\": 0.734,\n      \"market_structure\": \"中等集中\"\n    },\n    \"chile_analysis\": {\n      \"share_latest\": 0.268,\n      \"share_peak\": 0.342,\n      \"peak_year\": 2003,\n      \"percentile\": 75\n    },\n    \"top_producers\": [\n      {\"rank\": 1, \"country\": \"Chile\", \"share\": 0.268, \"production_mt\": 5.26},\n      {\"rank\": 2, \"country\": \"Peru\", \"share\": 0.102, \"production_mt\": 2.00},\n      {\"rank\": 3, \"country\": \"DRC\", \"share\": 0.095, \"production_mt\": 1.86},\n      {\"rank\": 4, \"country\": \"China\", \"share\": 0.087, \"production_mt\": 1.70}\n    ]\n  },\n\n  \"proposition_b\": {\n    \"title\": \"智利是否結構性衰退？\",\n    \"verdict\": \"是\",\n    \"trend_metrics\": {\n      \"peak_year\": 2018,\n      \"peak_production_mt\": 5.83,\n      \"latest_production_mt\": 5.26,\n      \"drawdown\": 0.098,\n      \"rolling_slope_t_per_year\": -47000,\n      \"rolling_window\": 10\n    },\n    \"structural_break\": {\n      \"detected\": true,\n      \"break_year\": 2016,\n      \"pre_slope_t_per_year\": 85000,\n      \"post_slope_t_per_year\": -38000\n    },\n    \"classification\": \"structural_decline\",\n    \"grade_inference\": {\n      \"mode\": \"country_proxy\",\n      \"grade_decline_likely\": true,\n      \"evidence\": [\n        \"產量增速遠低於全球需求增速\",\n        \"高銅價環境下產量仍未提升\"\n      ],\n      \"confidence\": 0.7\n    }\n  },\n\n  \"proposition_c\": {\n    \"title\": \"是否依賴秘魯與DRC替代？\",\n    \"verdict\": \"是\",\n    \"chile_decline\": {\n      \"method\": \"trend\",\n      \"expected_decline_mt\": 0.47\n    },\n    \"replacement_capacity\": {\n      \"Peru\": {\n        \"historical_cagr\": 0.042,\n        \"expected_increment_mt\": 0.52,\n        \"execution_multiplier\": 0.8,\n        \"adjusted_increment_mt\": 0.416\n      },\n      \"DRC\": {\n        \"historical_cagr\": 0.089,\n        \"expected_increment_mt\": 0.87,\n        \"execution_multiplier\": 0.7,\n        \"adjusted_increment_mt\": 0.609\n      }\n    },\n    \"replacement_ratio\": 2.18,\n    \"adjusted_replacement_ratio\": 1.05,\n    \"gap_mt\": -0.56,\n    \"interpretation\": \"表面充足，但考慮執行風險後僅剛好填補\",\n    \"risk_assessment\": {\n      \"Peru\": {\n        \"political\": \"中\",\n        \"operational\": \"中\",\n        \"recent_events\": [\"2023年多次罷工\", \"Las Bambas衝突\"]\n      },\n      \"DRC\": {\n        \"political\": \"高\",\n        \"operational\": \"高\",\n        \"recent_events\": [\"Mutanda關閉\", \"政府審查礦權\"]\n      }\n    }\n  },\n\n  \"proposition_d\": {\n    \"title\": \"價格能快速帶來供應嗎？\",\n    \"verdict\": \"否\",\n    \"supply_constraints\": {\n      \"lead_time_years\": 10,\n      \"current_supply_mt\": 22.0,\n      \"supply_ceiling_mt\": 24.7,\n      \"increment_breakdown\": {\n        \"brownfield_expansion\": 0.3,\n        \"under_construction\": 0.2,\n        \"chile_decline\": -0.82,\n        \"peru_increment\": 0.52,\n        \"drc_increment\": 0.61\n      }\n    },\n    \"scenarios\": [\n      {\n        \"name\": \"slowdown\",\n        \"demand_cagr\": 0.015,\n        \"final_demand_mt\": 25.6,\n        \"gap_mt\": 0.9,\n        \"gap_pct\": 0.041,\n        \"severity\": \"小缺口\"\n      },\n      {\n        \"name\": \"base\",\n        \"demand_cagr\": 0.03,\n        \"final_demand_mt\": 29.6,\n        \"gap_mt\": 4.9,\n        \"gap_pct\": 0.223,\n        \"severity\": \"嚴重缺口\"\n      },\n      {\n        \"name\": \"electrification\",\n        \"demand_cagr\": 0.05,\n        \"final_demand_mt\": 35.8,\n        \"gap_mt\": 11.1,\n        \"gap_pct\": 0.505,\n        \"severity\": \"嚴重缺口\"\n      }\n    ]\n  },\n\n  \"proposition_e\": {\n    \"title\": \"地緣風險有多大？\",\n    \"verdict\": \"顯著\",\n    \"geo_risk_by_country\": {\n      \"Chile\": {\n        \"event_count_12m\": 45,\n        \"z_score\": 0.3,\n        \"risk_level\": \"低\"\n      },\n      \"Peru\": {\n        \"event_count_12m\": 120,\n        \"z_score\": 1.2,\n        \"risk_level\": \"中高\"\n      },\n      \"DRC\": {\n        \"event_count_12m\": 280,\n        \"z_score\": 2.1,\n        \"risk_level\": \"高\"\n      }\n    },\n    \"geo_risk_weighted\": 1.65,\n    \"data_source\": \"GDELT\"\n  },\n\n  \"system_risk\": {\n    \"score\": 73.5,\n    \"interpretation\": \"極高風險 - 供應中斷可能性顯著\",\n    \"components\": {\n      \"concentration_score\": 18.2,\n      \"dependency_score\": 0.12,\n      \"geo_risk_weighted\": 1.65\n    }\n  },\n\n  \"data_sources\": {\n    \"production\": [\"OWID Minerals\", \"USGS MCS\"],\n    \"geopolitics\": [\"GDELT\"],\n    \"unit\": \"t_Cu_content\",\n    \"notes\": [\n      \"所有產量數據為 mined copper content（非 refined）\",\n      \"GDELT 數據為近 12 個月事件統計\"\n    ]\n  },\n\n  \"recommendations\": [\n    \"監控智利產量月度數據與主要礦區動態\",\n    \"關注秘魯勞工談判與社區衝突\",\n    \"追蹤 DRC 政治穩定性與礦權政策\",\n    \"評估供應鏈多元化策略\"\n  ]\n}\n```\n\n---\n\n## 單一分析輸出\n\n### 集中度分析\n\n```json\n{\n  \"commodity\": \"copper\",\n  \"analysis_type\": \"concentration\",\n  \"generated_at\": \"2026-01-24T10:30:00Z\",\n  \"period\": {\n    \"start_year\": 1970,\n    \"end_year\": 2023\n  },\n  \"concentration\": {\n    \"metric\": \"HHI\",\n    \"hhi_latest\": 1820,\n    \"cr4_latest\": 0.562,\n    \"cr8_latest\": 0.734,\n    \"market_structure\": \"中等集中\"\n  },\n  \"top_producers\": [...],\n  \"timeseries\": [\n    {\"year\": 2019, \"hhi\": 1780, \"cr4\": 0.55},\n    {\"year\": 2020, \"hhi\": 1790, \"cr4\": 0.55},\n    {\"year\": 2021, \"hhi\": 1800, \"cr4\": 0.56},\n    {\"year\": 2022, \"hhi\": 1810, \"cr4\": 0.56},\n    {\"year\": 2023, \"hhi\": 1820, \"cr4\": 0.56}\n  ],\n  \"data_sources\": [\"OWID Minerals\"]\n}\n```\n\n### 智利趨勢分析\n\n```json\n{\n  \"commodity\": \"copper\",\n  \"analysis_type\": \"chile_trend\",\n  \"generated_at\": \"2026-01-24T10:30:00Z\",\n  \"country\": \"Chile\",\n  \"trend_metrics\": {\n    \"peak_year\": 2018,\n    \"peak_production_mt\": 5.83,\n    \"latest_production_mt\": 5.26,\n    \"drawdown\": 0.098,\n    \"rolling_slope_t_per_year\": -47000\n  },\n  \"structural_break\": {\n    \"detected\": true,\n    \"break_year\": 2016\n  },\n  \"classification\": \"structural_decline\",\n  \"data_sources\": [\"OWID Minerals\"]\n}\n```\n\n---\n\n## 錯誤輸出\n\n```json\n{\n  \"status\": \"error\",\n  \"error_code\": \"FM-001\",\n  \"error_type\": \"DataFetchError\",\n  \"message\": \"無法從 OWID 擷取數據\",\n  \"context\": {\n    \"url\": \"https://raw.githubusercontent.com/owid/...\",\n    \"http_status\": 500\n  },\n  \"remediation\": [\n    \"檢查網路連線\",\n    \"使用本地快取\",\n    \"稍後重試\"\n  ],\n  \"partial_results\": null,\n  \"generated_at\": \"2026-01-24T10:30:00Z\"\n}\n```\n",
        "skills/analyze-copper-supply-concentration-risk/templates/output-markdown.md": "# Markdown 報告模板\n\n## 完整五命題報告\n\n```markdown\n# 銅供應「集中 + 失速 + 依賴」快速檢核（{{start_year}}-{{end_year}}）\n\n**生成時間**：{{generated_at}}\n**數據口徑**：Mined copper content（礦場產量的銅金屬含量）\n\n---\n\n## 執行摘要\n\n本報告驗證市場常見的銅供應風險敘事。主要發現：\n\n| 命題 | 結論 | 關鍵指標 |\n|------|------|----------|\n| A. 供應集中 | {{verdict_a}} | HHI={{hhi}}, CR4={{cr4}} |\n| B. 智利失速 | {{verdict_b}} | 斜率={{slope}} t/年, 回撤={{drawdown}} |\n| C. 替代依賴 | {{verdict_c}} | ratio={{ratio}} |\n| D. 供應慣性 | {{verdict_d}} | 10年缺口={{gap}} Mt |\n| E. 地緣風險 | {{verdict_e}} | 系統風險={{system_risk}}/100 |\n\n---\n\n## 1) 供應是否高度集中？\n\n> **市場敘事**：「只有 10-12 國有顯著產量，智利像銅礦的 OPEC」\n\n### 驗證結果\n\n| 指標 | {{end_year}}年值 | 解讀 |\n|------|------------------|------|\n| HHI | {{hhi}} | {{market_structure}} |\n| CR4 | {{cr4}} | 前四國控制{{cr4}}供應 |\n| CR8 | {{cr8}} | 前八國控制{{cr8}}供應 |\n| 智利份額 | {{chile_share}} | 高於{{percentile}}%歷史年份 |\n\n### 國家份額排名\n\n| 排名 | 國家 | 產量 (Mt) | 份額 | 累積份額 |\n|------|------|-----------|------|----------|\n{{#each top_producers}}\n| {{rank}} | {{country}} | {{production_mt}} | {{share}} | {{cumulative_share}} |\n{{/each}}\n\n### 時序趨勢\n\nHHI 從 {{hhi_10y_ago}}（{{year_10y_ago}}年）{{hhi_trend}}至 {{hhi_latest}}（{{end_year}}年）。\n\n**含義**：供應更像「少數國家的系統性依賴」，不是分散式供應鏈。\n\n---\n\n## 2) 智利是「儲量大但供應不安全」嗎？\n\n> **市場敘事**：「品位下滑 → 成本上升 → 產量衰退」\n\n### 驗證結果\n\n| 指標 | 數值 | 解讀 |\n|------|------|------|\n| 峰值年份 | {{peak_year}} | 產量達到 {{peak_production}} Mt |\n| 最新產量 | {{latest_production}} Mt | 較峰值下滑 {{drawdown}} |\n| 近 {{window}} 年斜率 | {{slope}} t/年 | {{slope_interpretation}} |\n| 結構斷點 | {{break_year}} | 趨勢由升轉{{break_direction}} |\n\n### 判定邏輯\n\n- slope < 0 : {{slope_check}}\n- structural_break detected : {{break_check}}\n- drawdown > 10% : {{drawdown_check}}\n\n**結論**：{{chile_conclusion}}\n\n### 品位推斷（{{ore_grade_mode}} 模式）\n\n{{grade_inference_text}}\n\n**含義**：如果產量進入結構性停滯/下滑，單看儲量會高估供應安全。\n\n---\n\n## 3) 世界是否被迫依賴秘魯與 DRC 擴產？\n\n> **市場敘事**：「near/medium term path 只能靠秘魯和剛果金」\n\n### 驗證結果\n\n| 項目 | 數量 | 說明 |\n|------|------|------|\n| 智利預期減產 | {{chile_decline}} Mt | 延續趨勢 |\n| 秘魯預期增量 | {{peru_inc}} Mt | CAGR {{peru_cagr}}，執行係數 0.8 |\n| DRC 預期增量 | {{drc_inc}} Mt | CAGR {{drc_cagr}}，執行係數 0.7 |\n| **替代依賴度** | **{{ratio}}** | {{ratio_interpretation}} |\n| **淨缺口** | {{gap}} Mt | {{gap_interpretation}} |\n\n### 風險因素\n\n| 國家 | 政治風險 | 主要因素 |\n|------|----------|----------|\n| 秘魯 | {{peru_risk}} | 社會衝突、礦業稅制、社區抗議 |\n| DRC | {{drc_risk}} | 政治不穩定、武裝衝突、ESG爭議 |\n\n**含義**：若 ratio < 1，兩國擴產不足補位；若 ≈1，仍需考慮兩國風險與執行難度。\n\n---\n\n## 4) 為何價格訊號不一定能快速解決缺口？\n\n> **市場敘事**：「歷史上沒有銅短缺，但這次供應反應慢」\n\n### 供應約束分析\n\n**新增大型礦場供應反應時間**：約 {{lead_time}} 年\n\n| 增量來源 | 預期增量 | 可行性 |\n|----------|----------|--------|\n| 現有產能擴建 | +{{brownfield}} Mt | 短期可行 |\n| 在建項目 | +{{construction}} Mt | 中期釋放 |\n| 新礦開發 | 受 lead time 約束 | 長期 |\n| **供應天花板** | {{ceiling}} Mt | {{lead_time}} 年內上限 |\n\n### 情境分析\n\n| 情境 | 需求 CAGR | {{lead_time}}年後需求 | 供需缺口 | 嚴重程度 |\n|------|-----------|----------------------|----------|----------|\n{{#each scenarios}}\n| {{name}} | {{cagr}} | {{demand}} Mt | {{gap}} Mt | {{severity}} |\n{{/each}}\n\n**含義**：供應鏈反應慢，短期價格上漲不等於短期供給彈性。\n\n---\n\n## 5) 地緣政治為何是宏觀供應慢變量風險？\n\n> **市場敘事**：「peace deal / insurgencies 被市場忽略」\n\n### 地緣風險指數\n\n| 國家 | 事件頻率 Z分數 | 風險等級 | 近期事件 |\n|------|----------------|----------|----------|\n| 智利 | {{chile_z}} | {{chile_level}} | 水資源爭議、原住民抗議 |\n| 秘魯 | {{peru_z}} | {{peru_level}} | 多次罷工、Las Bambas 衝突 |\n| DRC | {{drc_z}} | {{drc_level}} | Mutanda 關閉、政府審查礦權 |\n\n*數據來源：GDELT 事件資料庫（近 12 個月）*\n\n### 系統風險評估\n\n**綜合分數：{{system_risk}}/100**\n\n| 分項 | 分數 | 說明 |\n|------|------|------|\n| 集中度分數 | {{conc_score}} | HHI 標準化 |\n| 依賴度分數 | {{dep_score}} | 1 - replacement_ratio |\n| 地緣風險加權 | {{geo_score}} | 替代國風險加權 |\n\n**解讀**：{{system_interpretation}}\n\n---\n\n## 綜合結論\n\n### 五命題驗證摘要\n\n| 命題 | 驗證結果 | 關鍵指標 |\n|------|----------|----------|\n| A. 供應高度集中 | {{a_verdict}} | HHI={{hhi}}, CR4={{cr4}} |\n| B. 智利結構性衰退 | {{b_verdict}} | slope={{slope}}, drawdown={{drawdown}} |\n| C. 依賴秘魯/DRC | {{c_verdict}} | ratio={{ratio}} |\n| D. 供應反應慢 | {{d_verdict}} | 基準情境缺口={{base_gap}} Mt |\n| E. 地緣風險被忽略 | {{e_verdict}} | system_risk={{system_risk}}/100 |\n\n### 建議監控\n\n1. 智利產量月度數據與主要礦區動態\n2. 秘魯勞工談判與社區衝突\n3. DRC 政治穩定性與礦權政策\n4. 全球在建項目進度\n\n---\n\n## 數據來源與方法說明\n\n### 數據來源\n\n| 來源 | Tier | 用途 |\n|------|------|------|\n| OWID Minerals | 0 | 主幹產量數據（{{start_year}}年起） |\n| USGS MCS | 0 | 官方口徑驗證 |\n| GDELT | 3 | 地緣風險事件 |\n\n### 口徑說明\n\n本分析使用 **mined copper content**（礦場產量的銅金屬含量）：\n- ✅ 銅金屬含量（metric tonnes Cu）\n- ❌ 非 ore tonnes（礦石噸數）\n- ❌ 非 refined production（精煉產量）\n- ❌ 非 reserves（儲量）\n\n### 方法論\n\n- **集中度**：HHI = Σ (share × 100)²\n- **趨勢分析**：Rolling linear regression + breakpoint detection\n- **替代依賴度**：replacement_ratio = (秘魯增量 + DRC增量) / 智利缺口\n- **系統風險**：concentration × (1 + dependency) × (1 + geo_risk_weighted)\n\n---\n\n*報告生成時間：{{generated_at}}*\n```\n\n---\n\n## 摘要版報告\n\n```markdown\n## 銅供應集中度風險快速檢核（{{end_year}}年）\n\n### TL;DR\n\n{{#if high_risk}}\n🔴 **高風險**：銅供應呈現高集中度（HHI={{hhi}}），智利產量結構性下滑，\n替代供應依賴高風險國家。系統風險分數 {{system_risk}}/100。\n{{else}}\n🟡 **中等風險**：銅供應集中度 {{market_structure}}，需持續監控智利趨勢\n與替代國動態。\n{{/if}}\n\n### 關鍵數據\n\n| 指標 | 數值 |\n|------|------|\n| HHI（{{end_year}}年） | {{hhi}} |\n| 智利份額 | {{chile_share}} |\n| 智利趨勢斜率 | {{slope}} t/年 |\n| 替代依賴度 | {{ratio}} |\n| 系統風險分數 | {{system_risk}}/100 |\n\n### 建議行動\n\n1. {{recommendation_1}}\n2. {{recommendation_2}}\n3. {{recommendation_3}}\n\n---\n\n*完整報告請使用 `--output=markdown` 參數*\n```\n",
        "skills/analyze-copper-supply-concentration-risk/workflows/analyze-chile-trend.md": "# Workflow: 智利銅產量結構性趨勢分析\n\n<required_reading>\n**讀取以下參考文件：**\n1. references/data-sources.md\n2. references/chile-supply-dynamics.md\n</required_reading>\n\n<process>\n## Step 1: 確認分析參數\n\n收集或確認以下參數：\n\n```yaml\ncountry: \"Chile\"          # 目標國家\nstart_year: 1970          # 分析起始年\nend_year: 2023            # 分析結束年\nrolling_window: 10        # 滾動趨勢視窗（年）\nstructural_break: true    # 是否偵測結構斷點\nore_grade_mode: \"country_proxy\"  # none | country_proxy | mine_level\n```\n\n**ore_grade_mode 說明：**\n- `none`：只做產量趨勢分析\n- `country_proxy`：用產量趨勢作為品位下滑的間接代理\n- `mine_level`：如有礦場級品位數據則使用\n\n## Step 2: 擷取智利產量數據\n\n從 OWID 擷取智利歷年銅產量：\n\n```bash\npython scripts/fetch_owid.py --commodity=copper --country=Chile --start={start_year} --end={end_year}\n```\n\n確保數據包含：\n- 年度產量（公噸銅金屬含量）\n- 全球總產量（用於計算份額）\n\n## Step 3: 計算基礎趨勢指標\n\n```python\ndef compute_trend_metrics(df, country=\"Chile\"):\n    \"\"\"計算智利產量趨勢指標\"\"\"\n    chile_data = df[df.country == country].sort_values(\"year\")\n\n    # 峰值分析\n    peak_idx = chile_data.production.idxmax()\n    peak_year = chile_data.loc[peak_idx, \"year\"]\n    peak_production = chile_data.loc[peak_idx, \"production\"]\n\n    # 最新數據\n    latest = chile_data.iloc[-1]\n    latest_year = latest.year\n    latest_production = latest.production\n\n    # 峰值回撤 (Drawdown)\n    drawdown = (peak_production - latest_production) / peak_production\n\n    return {\n        \"peak_year\": peak_year,\n        \"peak_production\": peak_production,\n        \"latest_year\": latest_year,\n        \"latest_production\": latest_production,\n        \"drawdown\": drawdown\n    }\n```\n\n## Step 4: 計算滾動趨勢斜率\n\n```python\nimport numpy as np\n\ndef rolling_slope(series, window=10):\n    \"\"\"\n    計算滾動線性回歸斜率\n\n    Parameters:\n    -----------\n    series : pd.Series\n        時間序列數據（index 為年份）\n    window : int\n        滾動視窗大小\n\n    Returns:\n    --------\n    pd.Series\n        滾動斜率序列（單位：t/年）\n    \"\"\"\n    slopes = []\n    years = series.index.values\n\n    for i in range(window - 1, len(series)):\n        y = series.values[i - window + 1:i + 1]\n        x = years[i - window + 1:i + 1]\n        # 線性回歸\n        coeffs = np.polyfit(x, y, 1)\n        slopes.append(coeffs[0])\n\n    # 前面補 NaN\n    result = [np.nan] * (window - 1) + slopes\n    return pd.Series(result, index=series.index)\n\n# 計算智利產量的滾動斜率\nchile_series = df[df.country == \"Chile\"].set_index(\"year\")[\"production\"]\nchile_rolling_slope = rolling_slope(chile_series, window=rolling_window)\nlatest_slope = chile_rolling_slope.iloc[-1]\n```\n\n## Step 5: 偵測結構斷點\n\n**方法一：簡易雙線段回歸**\n\n```python\ndef find_breakpoint_simple(series, min_segment=5):\n    \"\"\"\n    簡易結構斷點偵測：找到使兩段線性回歸總誤差最小的分割點\n\n    Returns:\n    --------\n    dict with break_year, pre_slope, post_slope\n    \"\"\"\n    years = series.index.values\n    values = series.values\n    n = len(series)\n\n    best_mse = float('inf')\n    best_break = None\n\n    for i in range(min_segment, n - min_segment):\n        # 前段回歸\n        x1, y1 = years[:i], values[:i]\n        p1 = np.polyfit(x1, y1, 1)\n        mse1 = np.mean((y1 - np.polyval(p1, x1)) ** 2)\n\n        # 後段回歸\n        x2, y2 = years[i:], values[i:]\n        p2 = np.polyfit(x2, y2, 1)\n        mse2 = np.mean((y2 - np.polyval(p2, x2)) ** 2)\n\n        total_mse = mse1 * len(x1) + mse2 * len(x2)\n\n        if total_mse < best_mse:\n            best_mse = total_mse\n            best_break = {\n                \"break_year\": years[i],\n                \"pre_slope\": p1[0],\n                \"post_slope\": p2[0]\n            }\n\n    return best_break\n```\n\n**方法二：使用 ruptures（如已安裝）**\n\n```python\n# Optional: 使用 ruptures 套件做更精確的斷點偵測\ntry:\n    import ruptures as rpt\n\n    def find_breakpoint_ruptures(series, n_breakpoints=1):\n        signal = series.values.reshape(-1, 1)\n        algo = rpt.Pelt(model=\"l2\").fit(signal)\n        result = algo.predict(pen=10)\n        break_indices = result[:-1]  # 排除最後一個（序列結尾）\n        break_years = [series.index[i] for i in break_indices]\n        return break_years\n\nexcept ImportError:\n    # 退回使用簡易方法\n    pass\n```\n\n## Step 6: 判定結構性衰退\n\n根據三指標組合判定：\n\n```python\ndef classify_trend(slope, drawdown, break_info, threshold_slope=-20000):\n    \"\"\"\n    判定產量趨勢類型\n\n    Parameters:\n    -----------\n    slope : float\n        近 N 年趨勢斜率（t/年）\n    drawdown : float\n        從峰值回撤幅度（0-1）\n    break_info : dict\n        斷點資訊（含 pre_slope, post_slope）\n    threshold_slope : float\n        負向斜率門檻\n\n    Returns:\n    --------\n    str : \"structural_decline\" | \"plateau\" | \"growth\"\n    \"\"\"\n    slope_negative = slope < threshold_slope\n    significant_drawdown = drawdown > 0.10\n    trend_reversal = (break_info[\"pre_slope\"] > 0 and break_info[\"post_slope\"] < 0)\n\n    if slope_negative and significant_drawdown and trend_reversal:\n        return \"structural_decline\"  # 結構性衰退\n    elif abs(slope) < abs(threshold_slope) and significant_drawdown:\n        return \"plateau\"  # 高原期\n    elif slope > 0:\n        return \"growth\"  # 仍在增長\n    else:\n        return \"uncertain\"  # 需要更多分析\n```\n\n## Step 7: 品位代理分析（country_proxy 模式）\n\n當 ore_grade_mode = \"country_proxy\" 時，使用以下邏輯：\n\n```python\ndef infer_grade_decline(production_series, world_demand_growth=0.03):\n    \"\"\"\n    從產量趨勢推斷品位下滑\n\n    邏輯：若全球需求成長 3%/年，價格處於高位，但智利產量停滯/下滑\n    → 說明不是需求問題，而是供應端（品位、成本）問題\n    \"\"\"\n    growth_rate = (production_series.iloc[-1] / production_series.iloc[-10]) ** 0.1 - 1\n\n    if growth_rate < world_demand_growth / 2:\n        inference = {\n            \"grade_decline_likely\": True,\n            \"evidence\": [\n                \"產量增速遠低於全球需求增速\",\n                \"高銅價環境下產量仍未提升\",\n                \"主要礦區公開報告品位下滑\"\n            ],\n            \"confidence\": 0.7\n        }\n    else:\n        inference = {\n            \"grade_decline_likely\": False,\n            \"evidence\": [\"產量增速與需求增速匹配\"],\n            \"confidence\": 0.5\n        }\n\n    return inference\n```\n\n## Step 8: 生成視覺化圖表\n\n```bash\npython scripts/visualize_analysis.py --mode=chile-trend\n```\n\n**生成的圖表**：\n1. `chile_production_trend_YYYYMMDD.png` - 智利產量與趨勢線\n2. `chile_slope_rolling_YYYYMMDD.png` - 滾動斜率變化\n3. `chile_breakpoint_YYYYMMDD.png` - 結構斷點視覺化\n\n## Step 9: 輸出結果\n\n**JSON 輸出：**\n\n```json\n{\n  \"commodity\": \"copper\",\n  \"analysis_type\": \"chile_trend\",\n  \"country\": \"Chile\",\n  \"period\": {\n    \"start_year\": 1970,\n    \"end_year\": 2023\n  },\n  \"trend_metrics\": {\n    \"peak_year\": 2018,\n    \"peak_production_mt\": 5.83,\n    \"latest_production_mt\": 5.26,\n    \"drawdown\": 0.098,\n    \"rolling_slope_t_per_year\": -47000,\n    \"rolling_window\": 10\n  },\n  \"structural_break\": {\n    \"detected\": true,\n    \"break_year\": 2016,\n    \"pre_slope_t_per_year\": 85000,\n    \"post_slope_t_per_year\": -38000\n  },\n  \"classification\": \"structural_decline\",\n  \"grade_inference\": {\n    \"mode\": \"country_proxy\",\n    \"grade_decline_likely\": true,\n    \"confidence\": 0.7\n  },\n  \"data_sources\": [\"OWID Minerals\"],\n  \"generated_at\": \"2026-01-24\"\n}\n```\n\n**Markdown 報告：**\n\n```markdown\n## 智利銅產量結構性趨勢分析\n\n### 執行摘要\n\n智利銅產量已進入 **{classification}** 期。從 {peak_year} 年的峰值\n{peak_production_mt:.2f} Mt 下滑至 {end_year} 年的 {latest_production_mt:.2f} Mt，\n回撤幅度 {drawdown:.1%}。結構斷點出現在 {break_year} 年。\n\n### 關鍵指標\n\n| 指標 | 數值 | 解讀 |\n|------|------|------|\n| 峰值年份 | {peak_year} | 產量達到歷史最高點 |\n| 峰值產量 | {peak_production_mt:.2f} Mt | - |\n| 最新產量 | {latest_production_mt:.2f} Mt | 較峰值下滑 {drawdown:.1%} |\n| 近 {window} 年斜率 | {slope:+,.0f} t/年 | {slope_interpretation} |\n| 結構斷點 | {break_year} | 趨勢由升轉降 |\n\n### 判定邏輯\n\n- slope < 0 : {slope_check}\n- structural_break detected : {break_check}\n- drawdown > 10% : {drawdown_check}\n\n**結論**：{conclusion}\n\n### 品位推斷（country_proxy 模式）\n\n{grade_inference_text}\n\n### 風險提示\n\n- 儲量排名全球第一 ≠ 產量能持續增長\n- 品位下滑意味著需要挖掘更多礦石維持同樣產出\n- 水資源限制可能進一步約束產能\n\n### 數據來源\n\n- OWID Minerals Explorer\n- 口徑：mined copper content（銅金屬含量）\n```\n</process>\n\n<success_criteria>\n此 workflow 完成時：\n- [ ] 計算峰值、回撤、滾動斜率三指標\n- [ ] 偵測結構斷點（若 structural_break=true）\n- [ ] 判定趨勢類型（structural_decline/plateau/growth）\n- [ ] 如使用 country_proxy 模式，輸出品位推斷\n- [ ] 輸出 JSON + Markdown 格式\n- [ ] 包含視覺化圖表（可選）\n</success_criteria>\n",
        "skills/analyze-copper-supply-concentration-risk/workflows/analyze-concentration.md": "# Workflow: 銅供應集中度分析\n\n<required_reading>\n**讀取以下參考文件：**\n1. references/data-sources.md\n2. references/concentration-metrics.md\n</required_reading>\n\n<process>\n\n## Step 1: 確認分析參數\n\n收集或確認以下參數：\n\n```yaml\nstart_year: 1970          # 分析起始年\nend_year: 2023            # 分析結束年（最新可用年）\nconcentration_metric: \"HHI\"  # HHI | CR4 | CR8\n```\n\n**若用戶未提供參數**，使用上述預設值並告知。\n\n## Step 2: 數據擷取（Chrome CDP）\n\n**Step 2a: 啟動 Chrome 調試模式**\n\n```bash\n# Windows\n\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" ^\n  --remote-debugging-port=9222 ^\n  --remote-allow-origins=* ^\n  --user-data-dir=\"%USERPROFILE%\\.chrome-debug-profile\" ^\n  \"https://en.macromicro.me/charts/91500/wbms-copper-mine-production-total-world\"\n```\n\n**Step 2b: 等待圖表完全載入**（約 35 秒）\n\n**Step 2c: 執行數據擷取**\n\n```bash\ncd scripts\npython fetch_copper_production.py --cdp\n```\n\n## Step 3: 執行集中度分析\n\n**快速檢查（最新年度）**：\n```bash\npython copper_concentration_analyzer.py --quick\n```\n\n**完整趨勢分析**：\n```bash\npython copper_concentration_analyzer.py --start 1970 --end 2023\n```\n\n## Step 4: 生成視覺化圖表\n\n```bash\npython visualize_copper_concentration.py \\\n  --cache cache/copper_production.csv \\\n  --output ../../output/copper_concentration.png\n```\n\n## Step 5: 輸出結果\n\n**JSON 輸出範例：**\n\n```json\n{\n  \"period\": {\"start_year\": 1970, \"end_year\": 2023},\n  \"hhi_latest\": 1820,\n  \"hhi_first\": 1650,\n  \"trend_direction\": \"上升\",\n  \"cr4_latest\": 0.562,\n  \"cr8_latest\": 0.734,\n  \"market_structure\": \"中等集中 (Moderately Concentrated)\",\n  \"chile_share_latest\": 0.268,\n  \"top_producers\": [\n    {\"country\": \"Chile\", \"share\": 0.268, \"production_mt\": 5.26},\n    {\"country\": \"Peru\", \"share\": 0.102, \"production_mt\": 2.00},\n    {\"country\": \"DRC\", \"share\": 0.095, \"production_mt\": 1.86}\n  ]\n}\n```\n\n**關鍵觀察點：**\n- HHI 是上升還是下降趨勢？\n- 智利份額在哪些年份達到峰值？\n- 是否有明顯的結構變化年份？\n\n</process>\n\n<success_criteria>\n此 workflow 完成時：\n- [ ] 數據已從 MacroMicro 成功抓取\n- [ ] 計算 HHI, CR4, CR8 指標\n- [ ] 生成國家份額排名表\n- [ ] 包含時序趨勢分析\n- [ ] 生成視覺化圖表\n- [ ] 標註數據口徑為 mined copper content\n</success_criteria>\n",
        "skills/analyze-copper-supply-concentration-risk/workflows/analyze-replacement.md": "# Workflow: 秘魯/DRC 替代依賴度分析\n\n<required_reading>\n**讀取以下參考文件：**\n1. references/data-sources.md\n2. references/replacement-countries.md\n</required_reading>\n\n<process>\n## Step 1: 確認分析參數\n\n收集或確認以下參數：\n\n```yaml\nstart_year: 2010          # 歷史分析起始年\nend_year: 2023            # 分析結束年\nhorizon_years: 10         # 未來預測年限\nchile_decline_assumption: \"trend\"  # trend | fixed | scenario\nreplacement_countries:\n  - Peru\n  - Democratic Republic of Congo\n```\n\n**chile_decline_assumption 說明：**\n- `trend`：延續近 N 年趨勢斜率\n- `fixed`：使用固定百分比（如 -2%/年）\n- `scenario`：多情境分析\n\n## Step 2: 擷取歷史產量數據\n\n從 OWID 擷取智利、秘魯、DRC 歷年產量：\n\n```bash\npython scripts/fetch_owid.py --commodity=copper \\\n  --countries=Chile,Peru,\"Democratic Republic of Congo\" \\\n  --start={start_year} --end={end_year}\n```\n\n## Step 3: 計算歷史增量\n\n```python\ndef compute_historical_increment(df, country, n_years=10):\n    \"\"\"\n    計算國家近 N 年的產量增量\n\n    Returns:\n    --------\n    dict with total_increment, cagr, annual_increments\n    \"\"\"\n    country_data = df[df.country == country].sort_values(\"year\")\n\n    # 取近 N 年\n    recent = country_data.tail(n_years + 1)\n\n    start_prod = recent.iloc[0].production\n    end_prod = recent.iloc[-1].production\n\n    total_increment = end_prod - start_prod\n    cagr = (end_prod / start_prod) ** (1 / n_years) - 1\n\n    annual_increments = recent.production.diff().dropna().tolist()\n\n    return {\n        \"country\": country,\n        \"period\": f\"{recent.iloc[0].year}-{recent.iloc[-1].year}\",\n        \"start_production\": start_prod,\n        \"end_production\": end_prod,\n        \"total_increment\": total_increment,\n        \"cagr\": cagr,\n        \"annual_increments\": annual_increments\n    }\n\nchile_hist = compute_historical_increment(df, \"Chile\", n_years=10)\nperu_hist = compute_historical_increment(df, \"Peru\", n_years=10)\ndrc_hist = compute_historical_increment(df, \"Democratic Republic of Congo\", n_years=10)\n```\n\n## Step 4: 估算智利未來缺口\n\n```python\ndef estimate_chile_decline(df, method=\"trend\", horizon=10):\n    \"\"\"\n    估算智利未來 N 年的產量下滑量\n\n    Parameters:\n    -----------\n    method : str\n        \"trend\" - 延續歷史趨勢斜率\n        \"fixed\" - 固定年化下滑率\n        \"scenario\" - 多情境\n\n    Returns:\n    --------\n    dict with expected_decline, scenarios\n    \"\"\"\n    chile = df[df.country == \"Chile\"].sort_values(\"year\")\n    latest_prod = chile.iloc[-1].production\n\n    if method == \"trend\":\n        # 使用近 10 年斜率\n        recent = chile.tail(11)\n        x = recent.year.values\n        y = recent.production.values\n        slope = np.polyfit(x, y, 1)[0]\n\n        # 預測 horizon 年後\n        future_prod = latest_prod + slope * horizon\n        expected_decline = latest_prod - future_prod if future_prod < latest_prod else 0\n\n        return {\n            \"method\": \"trend\",\n            \"slope_t_per_year\": slope,\n            \"latest_production\": latest_prod,\n            \"expected_decline\": expected_decline,\n            \"scenarios\": None\n        }\n\n    elif method == \"fixed\":\n        decline_rate = 0.02  # 年化 -2%\n        future_prod = latest_prod * (1 - decline_rate) ** horizon\n        expected_decline = latest_prod - future_prod\n\n        return {\n            \"method\": \"fixed\",\n            \"decline_rate\": decline_rate,\n            \"latest_production\": latest_prod,\n            \"expected_decline\": expected_decline,\n            \"scenarios\": None\n        }\n\n    elif method == \"scenario\":\n        scenarios = []\n        for rate in [-0.01, -0.02, -0.03]:  # -1%, -2%, -3%\n            future_prod = latest_prod * (1 + rate) ** horizon\n            decline = latest_prod - future_prod\n            scenarios.append({\n                \"name\": f\"{rate*100:.0f}%/年\",\n                \"decline_rate\": rate,\n                \"expected_decline\": decline\n            })\n\n        return {\n            \"method\": \"scenario\",\n            \"latest_production\": latest_prod,\n            \"scenarios\": scenarios\n        }\n\nchile_decline = estimate_chile_decline(df, method=chile_decline_assumption, horizon=horizon_years)\n```\n\n## Step 5: 估算替代國增量潛力\n\n```python\ndef estimate_replacement_capacity(hist_increment, multiplier=1.0):\n    \"\"\"\n    基於歷史增速估算未來增量潛力\n\n    Parameters:\n    -----------\n    hist_increment : dict\n        compute_historical_increment 的輸出\n    multiplier : float\n        調整係數（考慮執行風險、產能上限等）\n\n    Returns:\n    --------\n    dict with expected_increment, assumptions\n    \"\"\"\n    # 使用歷史 CAGR 外推\n    base_cagr = hist_increment[\"cagr\"]\n    latest_prod = hist_increment[\"end_production\"]\n\n    # 假設未來維持相同增速（可調整）\n    future_prod = latest_prod * (1 + base_cagr) ** horizon_years\n    expected_increment = (future_prod - latest_prod) * multiplier\n\n    return {\n        \"country\": hist_increment[\"country\"],\n        \"historical_cagr\": base_cagr,\n        \"latest_production\": latest_prod,\n        \"expected_increment\": expected_increment,\n        \"multiplier\": multiplier,\n        \"assumptions\": [\n            f\"基於 {hist_increment['period']} 歷史增速 ({base_cagr:.1%}/年)\",\n            f\"執行調整係數 {multiplier}\",\n            f\"未考慮產能天花板\"\n        ]\n    }\n\nperu_capacity = estimate_replacement_capacity(peru_hist, multiplier=0.8)\ndrc_capacity = estimate_replacement_capacity(drc_hist, multiplier=0.7)\n```\n\n## Step 6: 計算替代依賴度\n\n```python\ndef compute_replacement_ratio(chile_decline, peru_capacity, drc_capacity):\n    \"\"\"\n    計算替代依賴度\n\n    replacement_ratio = (秘魯增量 + DRC增量) / 智利缺口\n    \"\"\"\n    if chile_decline[\"method\"] == \"scenario\":\n        # 多情境計算\n        results = []\n        for scenario in chile_decline[\"scenarios\"]:\n            decline = scenario[\"expected_decline\"]\n            peru_inc = peru_capacity[\"expected_increment\"]\n            drc_inc = drc_capacity[\"expected_increment\"]\n\n            ratio = (peru_inc + drc_inc) / max(decline, 1)  # 避免除以 0\n\n            results.append({\n                \"scenario\": scenario[\"name\"],\n                \"chile_decline\": decline,\n                \"peru_increment\": peru_inc,\n                \"drc_increment\": drc_inc,\n                \"total_replacement\": peru_inc + drc_inc,\n                \"replacement_ratio\": ratio,\n                \"gap\": decline - (peru_inc + drc_inc)\n            })\n        return results\n\n    else:\n        decline = chile_decline[\"expected_decline\"]\n        peru_inc = peru_capacity[\"expected_increment\"]\n        drc_inc = drc_capacity[\"expected_increment\"]\n\n        ratio = (peru_inc + drc_inc) / max(decline, 1)\n        gap = decline - (peru_inc + drc_inc)\n\n        return {\n            \"chile_decline\": decline,\n            \"peru_increment\": peru_inc,\n            \"drc_increment\": drc_inc,\n            \"total_replacement\": peru_inc + drc_inc,\n            \"replacement_ratio\": ratio,\n            \"gap\": gap,\n            \"interpretation\": interpret_ratio(ratio)\n        }\n\ndef interpret_ratio(ratio):\n    if ratio < 0.8:\n        return \"嚴重不足 - 供應缺口將擴大\"\n    elif ratio < 1.0:\n        return \"略有不足 - 缺口需其他來源填補\"\n    elif ratio < 1.2:\n        return \"剛好填補 - 但風險集中於兩國\"\n    else:\n        return \"有餘裕 - 但需考慮執行風險\"\n\nreplacement_result = compute_replacement_ratio(chile_decline, peru_capacity, drc_capacity)\n```\n\n## Step 7: 風險因素分析\n\n```python\ndef assess_replacement_risks():\n    \"\"\"評估秘魯與DRC的替代風險因素\"\"\"\n    return {\n        \"Peru\": {\n            \"political_risk\": {\n                \"level\": \"中\",\n                \"factors\": [\"社會衝突頻繁\", \"礦業稅制不穩定\", \"社區抗議\"]\n            },\n            \"operational_risk\": {\n                \"level\": \"中\",\n                \"factors\": [\"水資源限制\", \"高海拔作業\", \"基礎設施瓶頸\"]\n            },\n            \"track_record\": {\n                \"recent_disruptions\": [\"2023 年多次罷工\", \"Las Bambas 衝突持續\"],\n                \"production_volatility\": \"高\"\n            }\n        },\n        \"DRC\": {\n            \"political_risk\": {\n                \"level\": \"高\",\n                \"factors\": [\"政治不穩定\", \"武裝衝突\", \"礦權爭議\"]\n            },\n            \"operational_risk\": {\n                \"level\": \"高\",\n                \"factors\": [\"電力供應不穩\", \"物流困難\", \"ESG爭議\"]\n            },\n            \"track_record\": {\n                \"recent_disruptions\": [\"Mutanda 礦山關閉\", \"政府審查礦權\"],\n                \"production_volatility\": \"極高\"\n            }\n        }\n    }\n```\n\n## Step 8: 生成視覺化圖表\n\n```bash\npython scripts/visualize_analysis.py --mode=replacement\n```\n\n**生成的圖表**：\n1. `copper_replacement_bars_YYYYMMDD.png` - 智利缺口 vs 替代增量柱狀圖\n2. `copper_country_growth_YYYYMMDD.png` - 三國產量增長對比\n3. `copper_replacement_ratio_YYYYMMDD.png` - 替代依賴度指標\n\n## Step 9: 輸出結果\n\n**JSON 輸出：**\n\n```json\n{\n  \"commodity\": \"copper\",\n  \"analysis_type\": \"replacement_dependency\",\n  \"period\": {\n    \"historical\": \"2010-2023\",\n    \"projection\": \"2023-2033\"\n  },\n  \"chile_decline\": {\n    \"method\": \"trend\",\n    \"expected_decline_mt\": 0.82,\n    \"slope_t_per_year\": -47000\n  },\n  \"replacement_capacity\": {\n    \"Peru\": {\n      \"expected_increment_mt\": 0.52,\n      \"historical_cagr\": 0.042,\n      \"multiplier\": 0.8\n    },\n    \"DRC\": {\n      \"expected_increment_mt\": 0.61,\n      \"historical_cagr\": 0.089,\n      \"multiplier\": 0.7\n    }\n  },\n  \"replacement_ratio\": 0.88,\n  \"gap_mt\": 0.11,\n  \"interpretation\": \"略有不足 - 缺口需其他來源填補\",\n  \"risk_assessment\": {\n    \"Peru\": \"中\",\n    \"DRC\": \"高\"\n  },\n  \"data_sources\": [\"OWID Minerals\"],\n  \"generated_at\": \"2026-01-24\"\n}\n```\n\n**Markdown 報告：**\n\n```markdown\n## 秘魯與DRC替代依賴度分析\n\n### 執行摘要\n\n若智利產量延續當前趨勢，未來 {horizon} 年預期減產 {chile_decline:.2f} Mt。\n秘魯與DRC合計可提供 {total_replacement:.2f} Mt 增量，\n替代依賴度（replacement_ratio）為 **{ratio:.2f}**。\n\n**判定**：{interpretation}\n\n### 歷史產量增量（近 {n_years} 年）\n\n| 國家 | 起始產量 | 最新產量 | 增量 | CAGR |\n|------|----------|----------|------|------|\n| 智利 | {chile_start} Mt | {chile_end} Mt | {chile_inc:+} Mt | {chile_cagr:.1%} |\n| 秘魯 | {peru_start} Mt | {peru_end} Mt | {peru_inc:+} Mt | {peru_cagr:.1%} |\n| DRC | {drc_start} Mt | {drc_end} Mt | {drc_inc:+} Mt | {drc_cagr:.1%} |\n\n### 未來預測（{horizon} 年）\n\n| 項目 | 數量 | 說明 |\n|------|------|------|\n| 智利預期減產 | {chile_decline:.2f} Mt | 延續趨勢斜率 {slope:+,.0f} t/年 |\n| 秘魯預期增量 | {peru_inc:.2f} Mt | CAGR {peru_cagr:.1%}，執行係數 0.8 |\n| DRC 預期增量 | {drc_inc:.2f} Mt | CAGR {drc_cagr:.1%}，執行係數 0.7 |\n| **淨缺口** | {gap:.2f} Mt | 需其他來源填補 |\n\n### 替代依賴度解讀\n\n**replacement_ratio = {ratio:.2f}**\n\n- < 0.8：嚴重不足，供應缺口將擴大\n- 0.8-1.0：略有不足，需其他來源\n- 1.0-1.2：剛好填補，但風險集中\n- > 1.2：有餘裕，但需考慮執行風險\n\n### 風險因素\n\n**秘魯**：\n- 政治風險：{peru_political}\n- 主要因素：社會衝突、礦業稅制、社區抗議\n- 近期事件：2023 年多次罷工、Las Bambas 衝突\n\n**DRC**：\n- 政治風險：{drc_political}\n- 主要因素：政治不穩定、武裝衝突、ESG爭議\n- 近期事件：Mutanda 關閉、政府審查礦權\n\n### 含義\n\n1. 即使 ratio ≈ 1，風險仍集中於兩個高風險國家\n2. 秘魯與 DRC 的執行風險可能導致實際增量低於預期\n3. 建議關注其他替代來源（印尼、蒙古、贊比亞）\n\n### 數據來源\n\n- OWID Minerals Explorer\n- 口徑：mined copper content\n```\n</process>\n\n<success_criteria>\n此 workflow 完成時：\n- [ ] 計算三國歷史產量增量與 CAGR\n- [ ] 估算智利未來缺口\n- [ ] 估算秘魯/DRC 增量潛力（含執行係數調整）\n- [ ] 計算 replacement_ratio\n- [ ] 包含風險因素評估\n- [ ] 輸出 JSON + Markdown 格式\n</success_criteria>\n",
        "skills/analyze-copper-supply-concentration-risk/workflows/full-report.md": "# Workflow: 完整五命題分析報告\n\n<required_reading>\n**讀取以下參考文件：**\n1. references/data-sources.md\n2. references/concentration-metrics.md\n3. references/chile-supply-dynamics.md\n4. references/replacement-countries.md\n5. references/geopolitics-risk.md\n</required_reading>\n\n<process>\n## Step 1: 確認完整分析參數\n\n收集或確認以下參數：\n\n```yaml\n# 必要參數\nstart_year: 1970\nend_year: 2023\n\n# 分析參數\ncommodity: \"copper\"\ntop_n_producers: 12\nconcentration_metric: \"HHI\"\n\nfocus_countries:\n  - Chile\n  - Peru\n  - Democratic Republic of Congo\n  - China\n  - United States\n  - Russia\n  - Australia\n  - Mexico\n  - Kazakhstan\n  - Canada\n\n# 趨勢分析\nstructural_break: true\nore_grade_mode: \"country_proxy\"\nrolling_window: 10\n\n# 情境分析\ndemand_scenarios:\n  - name: \"base\"\n    demand_cagr: 0.03\n    horizon_years: 10\n\nsupply_lead_time_years: 10\n\n# 地緣風險\ngeopolitics_mode: \"gdelt\"\n\n# 輸出\noutput_format: \"markdown\"  # markdown | json\n```\n\n## Step 2: 執行數據擷取\n\n使用 Chrome CDP 方式從 MacroMicro 擷取數據：\n\n**Step 2.1: 啟動 Chrome 調試模式**\n```bash\n\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" ^\n  --remote-debugging-port=9222 ^\n  --remote-allow-origins=* ^\n  --user-data-dir=\"%USERPROFILE%\\.chrome-debug-profile\" ^\n  \"https://en.macromicro.me/charts/91500/wbms-copper-mine-production-total-world\"\n```\n\n**Step 2.2: 等待圖表完全載入**（約 35 秒）\n\n**Step 2.3: 執行數據擷取**\n```bash\npython scripts/copper_pipeline.py ingest --start={start_year} --end={end_year}\n```\n\n等待數據擷取完成，確認：\n- MacroMicro (WBMS) 銅產量數據已下載\n- 數據已標準化為統一 schema\n\n## Step 3: 執行命題 A - 集中度分析\n\n調用 `workflows/analyze-concentration.md` 流程：\n\n```python\nfrom copper_pipeline import compute_concentration\n\nconcentration_result = compute_concentration(\n    df=normalized_data,\n    start_year=start_year,\n    end_year=end_year,\n    metric=concentration_metric,\n    top_n=top_n_producers\n)\n```\n\n**輸出要點**：\n- HHI 最新值與 10 年前對比\n- CR4, CR8 數值\n- 智利份額與歷史分位數\n- 時序趨勢\n\n## Step 4: 執行命題 B - 智利趨勢分析\n\n調用 `workflows/analyze-chile-trend.md` 流程：\n\n```python\nfrom copper_pipeline import compute_chile_trend\n\nchile_trend = compute_chile_trend(\n    df=normalized_data,\n    country=\"Chile\",\n    rolling_window=rolling_window,\n    structural_break=structural_break,\n    ore_grade_mode=ore_grade_mode\n)\n```\n\n**輸出要點**：\n- 峰值年份與產量\n- 近 N 年趨勢斜率\n- 結構斷點年份\n- 峰值回撤幅度\n- 趨勢分類（structural_decline/plateau/growth）\n\n## Step 5: 執行命題 C - 替代依賴度分析\n\n調用 `workflows/analyze-replacement.md` 流程：\n\n```python\nfrom copper_pipeline import compute_replacement\n\nreplacement_result = compute_replacement(\n    df=normalized_data,\n    chile_decline=chile_trend[\"expected_decline\"],\n    replacement_countries=[\"Peru\", \"Democratic Republic of Congo\"],\n    horizon_years=10\n)\n```\n\n**輸出要點**：\n- 秘魯與 DRC 歷史增量\n- 未來增量潛力估算\n- replacement_ratio\n- 缺口判定\n\n## Step 6: 執行命題 D & E - 情境與風險分析\n\n調用 `workflows/scenario-analysis.md` 流程：\n\n```python\nfrom copper_pipeline import run_scenario_analysis\n\nscenario_result = run_scenario_analysis(\n    baseline=baseline_data,\n    demand_scenarios=demand_scenarios,\n    supply_constraints=supply_model,\n    geo_countries=focus_countries,\n    geopolitics_mode=geopolitics_mode\n)\n```\n\n**輸出要點**：\n- 各情境供需缺口\n- 地緣風險指數\n- 系統風險分數\n\n## Step 7: 綜合生成完整報告\n\n整合所有分析結果，生成完整五命題報告：\n\n```python\ndef generate_full_report(concentration, chile_trend, replacement, scenario, output_format):\n    \"\"\"\n    生成完整五命題報告\n\n    報告結構：\n    1. 執行摘要\n    2. 命題 A: 供應是否高度集中？\n    3. 命題 B: 智利是否結構性衰退？\n    4. 命題 C: 是否被迫依賴秘魯與 DRC？\n    5. 命題 D: 價格能快速帶來供應嗎？\n    6. 命題 E: 地緣風險有多大？\n    7. 綜合結論與系統風險評估\n    8. 數據來源與方法說明\n    \"\"\"\n    pass\n```\n\n## Step 8: 生成視覺化圖表\n\n```bash\npython scripts/visualize_analysis.py --mode=full-report\n```\n\n**生成的圖表**：\n1. `copper_concentration_summary_YYYYMMDD.png` - 集中度摘要儀表板\n2. `copper_chile_trend_YYYYMMDD.png` - 智利趨勢分析\n3. `copper_replacement_analysis_YYYYMMDD.png` - 替代依賴度分析\n4. `copper_scenario_dashboard_YYYYMMDD.png` - 情境分析儀表板\n5. `copper_system_risk_radar_YYYYMMDD.png` - 系統風險雷達圖\n\n## Step 9: 輸出完整報告\n\n**Markdown 報告結構：**\n\n```markdown\n# 銅供應「集中 + 失速 + 依賴」快速檢核（{start_year}-{end_year}）\n\n## 執行摘要\n\n本報告使用公開數據量化驗證市場常見的銅供應風險敘事。主要發現：\n\n- **供應集中**：HHI {hhi:.0f}，市場結構為{market_structure}\n- **智利失速**：產量趨勢斜率 {slope:+,.0f} t/年，{trend_classification}\n- **替代依賴**：replacement_ratio = {ratio:.2f}，{dependency_interpretation}\n- **供應慣性**：10 年 lead time 下，基準情境缺口 {gap:.1f} Mt\n- **系統風險**：綜合分數 {system_risk:.1f}/100（{risk_interpretation}）\n\n---\n\n## 1) 供應是否高度集中？\n\n> 推文主張：「只有 10-12 國有顯著產量，智利像 OPEC」\n\n### 驗證結果\n\n| 指標 | {end_year}年值 | 解讀 |\n|------|----------------|------|\n| HHI | {hhi:.0f} | {hhi_interpretation} |\n| CR4 | {cr4:.1%} | 前四國控制{cr4:.1%}供應 |\n| CR8 | {cr8:.1%} | 前八國控制{cr8:.1%}供應 |\n| 智利份額 | {chile_share:.1%} | 高於{percentile:.0f}%歷史年份 |\n\n### 國家份額排名（{end_year}年）\n\n| 排名 | 國家 | 產量 (Mt) | 份額 | 累積份額 |\n|------|------|-----------|------|----------|\n{country_table}\n\n### 時序趨勢\n\n{concentration_trend_chart}\n\n**含義**：供應更像「少數國家的系統性依賴」，不是分散式供應鏈。\n\n---\n\n## 2) 智利是「儲量大但供應不安全」嗎？\n\n> 推文主張：「品位下滑 → 成本上升 → 產量衰退」\n\n### 驗證結果\n\n| 指標 | 數值 | 解讀 |\n|------|------|------|\n| 峰值年份 | {peak_year} | 產量達到 {peak_prod:.2f} Mt |\n| 最新產量 | {latest_prod:.2f} Mt | 較峰值下滑 {drawdown:.1%} |\n| 近 {window} 年斜率 | {slope:+,.0f} t/年 | {slope_interpretation} |\n| 結構斷點 | {break_year} | 趨勢由升轉{break_direction} |\n\n### 判定邏輯\n\n- slope < 0 : {slope_check}\n- structural_break detected : {break_check}\n- drawdown > 10% : {drawdown_check}\n\n**結論**：{chile_conclusion}\n\n### 品位推斷（{ore_grade_mode} 模式）\n\n{grade_inference}\n\n**含義**：如果產量進入結構性停滯/下滑，單看儲量會高估供應安全。\n\n---\n\n## 3) 世界是否被迫依賴秘魯與 DRC 擴產？\n\n> 推文主張：「near/medium term path 只能靠秘魯和剛果金」\n\n### 驗證結果\n\n| 項目 | 數量 | 說明 |\n|------|------|------|\n| 智利預期減產 | {chile_decline:.2f} Mt | 延續趨勢 |\n| 秘魯預期增量 | {peru_inc:.2f} Mt | CAGR {peru_cagr:.1%}，執行係數 0.8 |\n| DRC 預期增量 | {drc_inc:.2f} Mt | CAGR {drc_cagr:.1%}，執行係數 0.7 |\n| **替代依賴度** | **{ratio:.2f}** | {ratio_interpretation} |\n| **淨缺口** | {gap:.2f} Mt | 需其他來源填補 |\n\n### 風險因素\n\n| 國家 | 政治風險 | 主要因素 |\n|------|----------|----------|\n| 秘魯 | {peru_risk} | 社會衝突、礦業稅制、社區抗議 |\n| DRC | {drc_risk} | 政治不穩定、武裝衝突、ESG爭議 |\n\n**含義**：若 ratio < 1，兩國擴產不足補位；若 ≈1，仍需考慮兩國風險與執行難度。\n\n---\n\n## 4) 為何價格訊號不一定能快速解決缺口？\n\n> 推文主張：「歷史上沒有銅短缺，但這次供應反應慢」\n\n### 供應約束分析\n\n**新增大型礦場供應反應時間**：約 {lead_time} 年\n\n| 增量來源 | 預期增量 | 可行性 |\n|----------|----------|--------|\n| 現有產能擴建 | +{brownfield:.2f} Mt | 短期可行 |\n| 在建項目 | +{construction:.2f} Mt | 中期釋放 |\n| 新礦開發 | 受 lead time 約束 | 長期 |\n| **供應天花板** | {ceiling:.2f} Mt | 10 年內上限 |\n\n### 情境分析\n\n| 情境 | 需求 CAGR | 10年後需求 | 供需缺口 | 嚴重程度 |\n|------|-----------|------------|----------|----------|\n| 經濟放緩 | 1.5% | {slow_demand:.1f} Mt | {slow_gap:.1f} Mt | {slow_severity} |\n| 基準情境 | 3.0% | {base_demand:.1f} Mt | {base_gap:.1f} Mt | {base_severity} |\n| 電氣化加速 | 5.0% | {elec_demand:.1f} Mt | {elec_gap:.1f} Mt | {elec_severity} |\n\n**含義**：供應鏈反應慢，短期價格上漲不等於短期供給彈性。\n\n---\n\n## 5) 地緣政治為何是宏觀供應慢變量風險？\n\n> 推文主張：「peace deal / insurgencies 被市場忽略」\n\n### 地緣風險指數\n\n| 國家 | 事件頻率 Z分數 | 風險等級 | 近期事件 |\n|------|----------------|----------|----------|\n| 智利 | {chile_z:.1f} | {chile_level} | 水資源爭議、原住民抗議 |\n| 秘魯 | {peru_z:.1f} | {peru_level} | 多次罷工、Las Bambas 衝突 |\n| DRC | {drc_z:.1f} | {drc_level} | Mutanda 關閉、政府審查礦權 |\n\n*數據來源：GDELT 事件資料庫（近 12 個月）*\n\n### 系統風險評估\n\n**綜合分數：{system_risk:.1f}/100**\n\n| 分項 | 分數 | 權重 |\n|------|------|------|\n| 集中度分數 | {conc_score:.1f} | HHI 標準化 |\n| 依賴度分數 | {dep_score:.2f} | 1 - replacement_ratio |\n| 地緣風險加權 | {geo_score:.2f} | 替代國風險加權 |\n\n**解讀**：{system_interpretation}\n\n**含義**：地緣政治是慢變量，市場常忽略，但會放大系統風險。\n\n---\n\n## 綜合結論\n\n本分析驗證了以下五個命題：\n\n| 命題 | 驗證結果 | 關鍵指標 |\n|------|----------|----------|\n| A. 供應高度集中 | {a_verdict} | HHI={hhi:.0f}, CR4={cr4:.1%} |\n| B. 智利結構性衰退 | {b_verdict} | slope={slope:+,.0f}, drawdown={drawdown:.1%} |\n| C. 依賴秘魯/DRC | {c_verdict} | ratio={ratio:.2f} |\n| D. 供應反應慢 | {d_verdict} | 基準情境缺口={base_gap:.1f} Mt |\n| E. 地緣風險被忽略 | {e_verdict} | system_risk={system_risk:.1f}/100 |\n\n### 建議監控\n\n1. 智利產量月度數據與主要礦區動態\n2. 秘魯勞工談判與社區衝突\n3. DRC 政治穩定性與礦權政策\n4. 全球在建項目進度\n\n---\n\n## 數據來源與方法說明\n\n### 數據來源\n\n| 來源 | Tier | 用途 |\n|------|------|------|\n| MacroMicro (WBMS) | 0 | 主幹產量數據（唯一主要來源） |\n| GDELT | 3 | 地緣風險事件 |\n\n### 口徑說明\n\n本分析使用 **mined copper content**（礦場產量的銅金屬含量）：\n- ✅ 銅金屬含量（metric tonnes Cu）\n- ❌ 非 ore tonnes（礦石噸數）\n- ❌ 非 refined production（精煉產量）\n- ❌ 非 reserves（儲量）\n\n### 方法論\n\n- 集中度：HHI = Σ (share × 100)²\n- 趨勢分析：Rolling linear regression + breakpoint detection\n- 替代依賴度：replacement_ratio = (秘魯增量 + DRC增量) / 智利缺口\n- 系統風險：concentration × (1 + dependency) × (1 + geo_risk_weighted)\n\n---\n\n*報告生成時間：{generated_at}*\n```\n</process>\n\n<success_criteria>\n此 workflow 完成時：\n- [ ] 完成數據擷取與標準化\n- [ ] 完成命題 A 集中度分析\n- [ ] 完成命題 B 智利趨勢分析\n- [ ] 完成命題 C 替代依賴度分析\n- [ ] 完成命題 D 供需缺口情境分析\n- [ ] 完成命題 E 地緣風險與系統風險評估\n- [ ] 生成完整五命題報告（Markdown 或 JSON）\n- [ ] 包含所有視覺化圖表\n- [ ] 包含數據來源與方法說明\n</success_criteria>\n",
        "skills/analyze-copper-supply-concentration-risk/workflows/ingest-data.md": "# Workflow: 數據擷取與標準化\n\n<required_reading>\n**讀取以下參考文件：**\n1. references/data-sources.md\n2. thoughts/shared/guide/macromicro-highcharts-crawler.md\n</required_reading>\n\n<process>\n## Step 1: 確認擷取參數\n\n```yaml\ncommodity: \"copper\"\nstart_year: 1970\nend_year: 2023\nsources:\n  - MacroMicro   # 唯一主要來源（WBMS 數據）\noutput_dir: \"data/\"\ncache_enabled: true\ncache_ttl_days: 7\n```\n\n> **注意**：本技能僅使用 MacroMicro (WBMS) 作為產量數據的唯一主要來源。\n\n## Step 2: 擷取 MacroMicro 銅礦產量數據\n\nMacroMicro 提供 WBMS（World Bureau of Metal Statistics）銅礦產量數據，包含全球及各主要產銅國的歷史產量。\n\n**數據源 URL**：\n```\nhttps://en.macromicro.me/charts/91500/wbms-copper-mine-production-total-world\n```\n\n**擷取方式**：\n使用 Selenium 模擬瀏覽器，從 Highcharts 圖表提取數據。\n\n**擷取腳本**：\n\n```python\nimport random\nimport time\nimport json\nfrom pathlib import Path\nfrom datetime import datetime\n\nimport pandas as pd\n\n# MacroMicro 爬蟲配置\nMACROMICRO_URL = \"https://en.macromicro.me/charts/91500/wbms-copper-mine-production-total-world\"\nCHART_WAIT_SECONDS = 35  # Highcharts 渲染需要長時間等待\n\n# User-Agent 清單（防偵測）\nUSER_AGENTS = [\n    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36...',\n    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36...',\n]\n\n# Highcharts 數據提取 JavaScript\nEXTRACT_HIGHCHARTS_JS = '''\n(function() {\n    if (typeof Highcharts === 'undefined' || !Highcharts.charts) {\n        return JSON.stringify({error: 'Highcharts not found', retry: true});\n    }\n\n    var charts = Highcharts.charts.filter(c => c !== undefined && c !== null);\n    if (charts.length === 0) {\n        return JSON.stringify({error: 'No charts found', retry: true});\n    }\n\n    var result = [];\n    for (var i = 0; i < charts.length; i++) {\n        var chart = charts[i];\n        var chartInfo = {\n            title: chart.title ? chart.title.textStr : 'Chart ' + i,\n            series: []\n        };\n\n        for (var j = 0; j < chart.series.length; j++) {\n            var s = chart.series[j];\n            var seriesData = [];\n\n            // 優先使用 xData/yData\n            if (s.xData && s.xData.length > 0) {\n                for (var k = 0; k < s.xData.length; k++) {\n                    seriesData.push({\n                        x: s.xData[k],\n                        y: s.yData[k],\n                        date: new Date(s.xData[k]).toISOString().split('T')[0]\n                    });\n                }\n            } else if (s.data && s.data.length > 0) {\n                seriesData = s.data.map(function(point) {\n                    return {\n                        x: point.x,\n                        y: point.y,\n                        date: point.x ? new Date(point.x).toISOString().split('T')[0] : null\n                    };\n                });\n            }\n\n            chartInfo.series.push({\n                name: s.name,\n                type: s.type,\n                dataLength: seriesData.length,\n                data: seriesData\n            });\n        }\n        result.push(chartInfo);\n    }\n    return JSON.stringify(result);\n})()\n'''\n\n\ndef get_selenium_driver():\n    \"\"\"建立 Selenium WebDriver（帶防偵測配置）\"\"\"\n    from selenium import webdriver\n    from selenium.webdriver.chrome.service import Service\n    from selenium.webdriver.chrome.options import Options\n    from webdriver_manager.chrome import ChromeDriverManager\n\n    chrome_options = Options()\n    chrome_options.add_argument('--headless=new')\n    chrome_options.add_argument('--no-sandbox')\n    chrome_options.add_argument('--disable-dev-shm-usage')\n    chrome_options.add_argument('--disable-gpu')\n    chrome_options.add_argument('--window-size=1920,1080')\n\n    # 防偵測設定\n    chrome_options.add_argument('--disable-blink-features=AutomationControlled')\n    chrome_options.add_experimental_option('excludeSwitches', ['enable-automation'])\n    chrome_options.add_experimental_option('useAutomationExtension', False)\n\n    # 隨機 User-Agent\n    user_agent = random.choice(USER_AGENTS)\n    chrome_options.add_argument(f'user-agent={user_agent}')\n\n    service = Service(ChromeDriverManager().install())\n    driver = webdriver.Chrome(service=service, options=chrome_options)\n    driver.set_page_load_timeout(120)\n\n    return driver\n\n\ndef fetch_macromicro_copper(start_year: int, end_year: int, cache_dir: Path = Path(\"data/cache\")):\n    \"\"\"\n    從 MacroMicro 擷取銅產量數據\n\n    Returns:\n    --------\n    pd.DataFrame with columns: year, country, production, unit, source_id, confidence\n    \"\"\"\n    from selenium.webdriver.common.by import By\n    from selenium.webdriver.support.ui import WebDriverWait\n    from selenium.webdriver.support import expected_conditions as EC\n\n    cache_dir.mkdir(parents=True, exist_ok=True)\n    cache_file = cache_dir / f\"macromicro_copper_{start_year}_{end_year}.csv\"\n\n    # 檢查快取\n    if cache_file.exists():\n        cache_age = datetime.now() - datetime.fromtimestamp(cache_file.stat().st_mtime)\n        if cache_age.days < 7:\n            print(f\"使用快取: {cache_file}\")\n            return pd.read_csv(cache_file)\n\n    driver = None\n    try:\n        # 隨機延遲\n        delay = random.uniform(1.0, 2.0)\n        print(f\"請求前延遲 {delay:.2f} 秒...\")\n        time.sleep(delay)\n\n        # 啟動瀏覽器\n        driver = get_selenium_driver()\n        print(f\"正在抓取: {MACROMICRO_URL}\")\n        driver.get(MACROMICRO_URL)\n\n        # 等待頁面載入\n        time.sleep(5)\n        driver.execute_script('window.scrollTo(0, 0);')\n        time.sleep(3)\n\n        # 等待圖表區域\n        chart_selectors = ['.highcharts-container', '[data-highcharts-chart]']\n        for selector in chart_selectors:\n            try:\n                WebDriverWait(driver, 30).until(\n                    EC.presence_of_element_located((By.CSS_SELECTOR, selector))\n                )\n                break\n            except:\n                continue\n\n        # 🔴 長時間等待 Highcharts 渲染\n        print(f\"等待圖表渲染 ({CHART_WAIT_SECONDS}秒)...\")\n        time.sleep(CHART_WAIT_SECONDS)\n\n        # 執行 JavaScript 提取數據\n        result = driver.execute_script(f\"return {EXTRACT_HIGHCHARTS_JS}\")\n        chart_data = json.loads(result) if isinstance(result, str) else result\n\n        if isinstance(chart_data, dict) and 'error' in chart_data:\n            raise ValueError(f\"提取失敗: {chart_data['error']}\")\n\n        # 解析數據\n        all_data = []\n        for chart in chart_data:\n            for series in chart.get('series', []):\n                series_name = series.get('name', '')\n                for point in series.get('data', []):\n                    if point.get('y') is None:\n                        continue\n                    try:\n                        year = int(point['date'][:4])\n                        if year < start_year or year > end_year:\n                            continue\n                        all_data.append({\n                            'year': year,\n                            'country': normalize_country_name(series_name),\n                            'production': float(point['y']) * 1000,  # 千噸 -> 噸\n                            'unit': 't_Cu_content',\n                            'source_id': 'MacroMicro',\n                            'confidence': 0.9,\n                            'date': point['date']\n                        })\n                    except (ValueError, TypeError):\n                        continue\n\n        df = pd.DataFrame(all_data)\n\n        # 去重：每年每國只保留一筆\n        df = df.sort_values(['year', 'country', 'date'])\n        df = df.groupby(['year', 'country']).last().reset_index()\n        df = df[['year', 'country', 'production', 'unit', 'source_id', 'confidence']]\n\n        # 保存快取\n        df.to_csv(cache_file, index=False)\n        print(f\"數據已快取: {cache_file}\")\n\n        return df\n\n    finally:\n        if driver:\n            driver.quit()\n```\n\n## Step 3: 國家名稱標準化\n\n```python\ndef normalize_country_name(name: str) -> str:\n    \"\"\"標準化國家名稱\"\"\"\n    mapping = {\n        # 英文變體\n        \"Democratic Republic of the Congo\": \"Democratic Republic of Congo\",\n        \"DRC\": \"Democratic Republic of Congo\",\n        \"Congo, Dem. Rep.\": \"Democratic Republic of Congo\",\n        \"D.R. Congo\": \"Democratic Republic of Congo\",\n        \"United States of America\": \"United States\",\n        \"USA\": \"United States\",\n        \"US\": \"United States\",\n        \"Russian Federation\": \"Russia\",\n        \"USSR\": \"Russia\",\n        # 中文\n        \"智利\": \"Chile\",\n        \"秘魯\": \"Peru\",\n        \"中國\": \"China\",\n        \"美國\": \"United States\",\n        \"俄羅斯\": \"Russia\",\n        \"澳洲\": \"Australia\",\n        \"墨西哥\": \"Mexico\",\n        \"加拿大\": \"Canada\",\n        \"印尼\": \"Indonesia\",\n        \"贊比亞\": \"Zambia\",\n        \"哈薩克\": \"Kazakhstan\",\n        \"剛果民主共和國\": \"Democratic Republic of Congo\",\n        \"全球\": \"World\",\n        \"世界\": \"World\",\n    }\n\n    if name in mapping:\n        return mapping[name]\n\n    name_lower = name.lower()\n    for key, value in mapping.items():\n        if key.lower() in name_lower or name_lower in key.lower():\n            return value\n\n    return name\n```\n\n## Step 4: 數據驗證\n\n```python\ndef validate_data(df: pd.DataFrame, end_year: int) -> dict:\n    \"\"\"\n    驗證數據完整性與一致性\n\n    Returns:\n    --------\n    dict with validation results\n    \"\"\"\n    results = {\n        \"total_records\": len(df),\n        \"year_range\": f\"{df.year.min()}-{df.year.max()}\",\n        \"countries\": df.country.nunique(),\n        \"has_world_total\": \"World\" in df.country.values,\n        \"latest_year_records\": len(df[df.year == end_year]),\n        \"issues\": []\n    }\n\n    # 檢查是否有世界總量\n    if not results[\"has_world_total\"]:\n        results[\"issues\"].append(\"缺少 World 總量數據\")\n\n    # 檢查最新年度是否有足夠國家\n    if results[\"latest_year_records\"] < 10:\n        results[\"issues\"].append(f\"最新年度（{end_year}）記錄過少\")\n\n    # 檢查主要產銅國是否都有數據\n    major_countries = [\"Chile\", \"Peru\", \"China\", \"Democratic Republic of Congo\"]\n    for country in major_countries:\n        if country not in df.country.values:\n            results[\"issues\"].append(f\"缺少 {country} 數據\")\n\n    results[\"is_valid\"] = len(results[\"issues\"]) == 0\n\n    return results\n```\n\n## Step 5: 保存標準化數據\n\n```python\ndef save_normalized_data(df: pd.DataFrame, output_dir: Path = Path(\"data\")):\n    \"\"\"\n    保存標準化後的數據\n    \"\"\"\n    output_dir.mkdir(parents=True, exist_ok=True)\n\n    # 保存完整數據\n    output_file = output_dir / f\"copper_production_normalized.csv\"\n    df.to_csv(output_file, index=False)\n    print(f\"標準化數據已保存: {output_file}\")\n\n    # 保存元數據\n    metadata = {\n        \"generated_at\": datetime.now().isoformat(),\n        \"records\": len(df),\n        \"year_range\": f\"{df.year.min()}-{df.year.max()}\",\n        \"countries\": df.country.nunique(),\n        \"source\": \"MacroMicro (WBMS)\",\n        \"url\": MACROMICRO_URL\n    }\n\n    meta_file = output_dir / \"copper_production_metadata.json\"\n    with open(meta_file, \"w\") as f:\n        json.dump(metadata, f, indent=2)\n\n    return output_file\n```\n\n## Step 6: 完整擷取流程\n\n```python\ndef run_ingestion_pipeline(\n    start_year: int = 1970,\n    end_year: int = 2023,\n    output_dir: Path = Path(\"data\")\n):\n    \"\"\"\n    執行完整數據擷取流程\n    \"\"\"\n    print(\"=\" * 50)\n    print(\"銅產量數據擷取流程（數據來源：MacroMicro）\")\n    print(\"=\" * 50)\n\n    # Step 1: 擷取 MacroMicro 數據\n    print(\"\\n[1/3] 擷取 MacroMicro 數據...\")\n    df = fetch_macromicro_copper(start_year, end_year)\n    print(f\"  - 擷取 {len(df)} 筆記錄\")\n\n    # Step 2: 驗證\n    print(\"\\n[2/3] 驗證數據...\")\n    validation = validate_data(df, end_year)\n    print(f\"  - 驗證結果: {'通過' if validation['is_valid'] else '有問題'}\")\n    if validation[\"issues\"]:\n        for issue in validation[\"issues\"]:\n            print(f\"    ⚠️ {issue}\")\n\n    # Step 3: 保存\n    print(\"\\n[3/3] 保存數據...\")\n    output_file = save_normalized_data(df, output_dir)\n\n    print(\"\\n\" + \"=\" * 50)\n    print(\"擷取完成！\")\n    print(f\"輸出檔案: {output_file}\")\n    print(\"=\" * 50)\n\n    return df\n\n# 執行\nif __name__ == \"__main__\":\n    df = run_ingestion_pipeline()\n```\n\n## 替代方案：Chrome CDP 連接\n\n如果 Selenium headless 被 Cloudflare 擋住，可使用 Chrome CDP 方式：\n\n**Step 1: 啟動 Chrome 調試模式**\n\n```bash\n# Windows\n\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" ^\n  --remote-debugging-port=9222 ^\n  --remote-allow-origins=* ^\n  --user-data-dir=\"%USERPROFILE%\\.chrome-debug-profile\" ^\n  \"https://en.macromicro.me/charts/91500/wbms-copper-mine-production-total-world\"\n```\n\n**Step 2: 等待頁面完全載入**（圖表顯示）\n\n**Step 3: 使用 CDP 提取數據**\n\n```python\nimport requests\nimport websocket\nimport json\n\nCDP_PORT = 9222\n\ndef get_page_ws_url():\n    resp = requests.get(f'http://127.0.0.1:{CDP_PORT}/json', timeout=5)\n    pages = resp.json()\n    for page in pages:\n        if 'macromicro' in page.get('url', '').lower():\n            return page.get('webSocketDebuggerUrl')\n    return pages[0].get('webSocketDebuggerUrl') if pages else None\n\ndef execute_js(ws_url, js_code):\n    ws = websocket.create_connection(ws_url, timeout=30)\n    cmd = {\n        \"id\": 1,\n        \"method\": \"Runtime.evaluate\",\n        \"params\": {\"expression\": js_code, \"returnByValue\": True}\n    }\n    ws.send(json.dumps(cmd))\n    result = json.loads(ws.recv())\n    ws.close()\n    return result\n\n# 使用\nws_url = get_page_ws_url()\nresult = execute_js(ws_url, EXTRACT_HIGHCHARTS_JS)\nchart_data = json.loads(result['result']['result']['value'])\n```\n</process>\n\n<success_criteria>\n此 workflow 完成時：\n- [ ] MacroMicro 銅產量數據已擷取\n- [ ] 數據已標準化為統一 schema\n- [ ] 國家名稱已標準化\n- [ ] 數據完整性已驗證\n- [ ] 快取機制正常運作\n- [ ] 輸出 CSV + 元數據 JSON\n</success_criteria>\n",
        "skills/analyze-copper-supply-concentration-risk/workflows/scenario-analysis.md": "# Workflow: 供需缺口與系統風險情境模擬\n\n<required_reading>\n**讀取以下參考文件：**\n1. references/data-sources.md\n2. references/geopolitics-risk.md\n</required_reading>\n\n<process>\n## Step 1: 確認情境參數\n\n收集或確認以下參數：\n\n```yaml\n# 需求情境\ndemand_scenarios:\n  - name: \"base\"\n    demand_cagr: 0.03    # 年化需求成長率\n    horizon_years: 10     # 預測年限\n  - name: \"electrification\"\n    demand_cagr: 0.05    # 電氣化加速情境\n    horizon_years: 10\n  - name: \"slowdown\"\n    demand_cagr: 0.015   # 經濟放緩情境\n    horizon_years: 10\n\n# 供應約束\nsupply_lead_time_years: 10   # 新礦開發週期\n\n# 地緣風險\ngeopolitics_mode: \"gdelt\"    # none | gdelt | news_count\nfocus_countries:\n  - Chile\n  - Peru\n  - Democratic Republic of Congo\n```\n\n## Step 2: 建立供需基準\n\n```python\ndef establish_baseline(df, base_year):\n    \"\"\"建立供需基準數據\"\"\"\n    world_data = df[df.country == \"World\"]\n    latest = world_data[world_data.year == base_year]\n\n    return {\n        \"base_year\": base_year,\n        \"production_mt\": latest.production.values[0] / 1e6,  # 轉換為 Mt\n        \"consumption_mt\": latest.production.values[0] / 1e6 * 1.02,  # 假設消費略高於產量\n        \"inventory_mt\": 2.0  # 約 2 個月消費量\n    }\n\nbaseline = establish_baseline(df, end_year)\n```\n\n## Step 3: 需求預測\n\n```python\ndef project_demand(baseline, scenario):\n    \"\"\"\n    根據情境預測未來需求\n\n    Parameters:\n    -----------\n    baseline : dict\n        基準年供需數據\n    scenario : dict\n        情境參數（name, demand_cagr, horizon_years）\n\n    Returns:\n    --------\n    list of dict : 逐年需求預測\n    \"\"\"\n    projections = []\n    current_demand = baseline[\"consumption_mt\"]\n\n    for year in range(1, scenario[\"horizon_years\"] + 1):\n        future_demand = current_demand * (1 + scenario[\"demand_cagr\"]) ** year\n        projections.append({\n            \"year\": baseline[\"base_year\"] + year,\n            \"demand_mt\": future_demand,\n            \"cumulative_growth\": future_demand / baseline[\"consumption_mt\"] - 1\n        })\n\n    return projections\n\n# 計算各情境需求預測\ndemand_projections = {}\nfor scenario in demand_scenarios:\n    demand_projections[scenario[\"name\"]] = project_demand(baseline, scenario)\n```\n\n## Step 4: 供應約束建模\n\n```python\ndef model_supply_constraints(baseline, lead_time_years, chile_decline_info, replacement_info):\n    \"\"\"\n    建模供應約束\n\n    供應增量來源：\n    1. 現有產能擴建（短期可行）\n    2. 在建項目釋放（中期）\n    3. 智利減產（負向）\n    4. 秘魯/DRC 增量\n\n    約束：\n    - 新礦開發需要 lead_time 年\n    - 現有產能擴建有上限\n    \"\"\"\n    current_supply = baseline[\"production_mt\"]\n\n    # 各來源增量估算\n    increments = {\n        \"brownfield_expansion\": 0.3 * lead_time_years / 10,  # 現有礦擴建\n        \"under_construction\": 0.2 * lead_time_years / 10,    # 在建項目\n        \"chile_decline\": -abs(chile_decline_info[\"expected_decline\"]) / 1e6,\n        \"peru_increment\": replacement_info[\"Peru\"][\"expected_increment\"] / 1e6,\n        \"drc_increment\": replacement_info[\"DRC\"][\"expected_increment\"] / 1e6\n    }\n\n    # 總可行增量\n    feasible_increment = sum(increments.values())\n\n    return {\n        \"current_supply_mt\": current_supply,\n        \"feasible_increment_mt\": feasible_increment,\n        \"increment_breakdown\": increments,\n        \"supply_ceiling_mt\": current_supply + feasible_increment,\n        \"lead_time_years\": lead_time_years\n    }\n\nsupply_model = model_supply_constraints(baseline, supply_lead_time_years, chile_decline, replacement_result)\n```\n\n## Step 5: 計算供需缺口\n\n```python\ndef compute_supply_demand_gap(demand_projections, supply_model):\n    \"\"\"\n    計算各情境下的供需缺口\n\n    Returns:\n    --------\n    dict : 各情境的缺口分析\n    \"\"\"\n    results = {}\n\n    for scenario_name, demand_proj in demand_projections.items():\n        # 取最終年需求\n        final_demand = demand_proj[-1][\"demand_mt\"]\n        supply_ceiling = supply_model[\"supply_ceiling_mt\"]\n\n        gap = final_demand - supply_ceiling\n        gap_pct = gap / supply_model[\"current_supply_mt\"]\n\n        # 判斷缺口嚴重程度\n        if gap <= 0:\n            severity = \"無缺口\"\n        elif gap_pct < 0.05:\n            severity = \"小缺口\"\n        elif gap_pct < 0.15:\n            severity = \"中等缺口\"\n        else:\n            severity = \"嚴重缺口\"\n\n        results[scenario_name] = {\n            \"final_demand_mt\": final_demand,\n            \"supply_ceiling_mt\": supply_ceiling,\n            \"gap_mt\": gap,\n            \"gap_pct\": gap_pct,\n            \"severity\": severity,\n            \"demand_projections\": demand_proj\n        }\n\n    return results\n\ngap_analysis = compute_supply_demand_gap(demand_projections, supply_model)\n```\n\n## Step 6: 地緣風險指數計算（GDELT 模式）\n\n```python\ndef compute_geo_risk_gdelt(countries, lookback_months=12):\n    \"\"\"\n    使用 GDELT 事件資料計算地緣風險指數\n\n    方法：\n    1. 抓取各國與採礦/衝突/罷工相關的事件\n    2. 計算事件頻率的 rolling z-score\n    3. 輸出標準化風險分數\n\n    注意：需要 GDELT API 存取\n    \"\"\"\n    # 模擬 GDELT 數據（實際需要 API 請求）\n    # 實際實作請參考 references/geopolitics-risk.md\n\n    risk_scores = {\n        \"Chile\": {\n            \"event_count_12m\": 45,\n            \"z_score\": 0.3,\n            \"risk_level\": \"低\"\n        },\n        \"Peru\": {\n            \"event_count_12m\": 120,\n            \"z_score\": 1.2,\n            \"risk_level\": \"中高\"\n        },\n        \"DRC\": {\n            \"event_count_12m\": 280,\n            \"z_score\": 2.1,\n            \"risk_level\": \"高\"\n        }\n    }\n\n    return risk_scores\n\ngeo_risk = compute_geo_risk_gdelt(focus_countries)\n```\n\n## Step 7: 計算系統風險分數\n\n```python\ndef compute_system_risk_score(concentration_result, replacement_result, geo_risk):\n    \"\"\"\n    綜合計算系統風險分數\n\n    公式：\n    system_risk = concentration_score × (1 + dependency_score) × (1 + geo_risk_weighted)\n\n    各分項：\n    - concentration_score: HHI 標準化 (0-100)\n    - dependency_score: 1 - replacement_ratio (調整)\n    - geo_risk_weighted: 替代國風險加權平均\n    \"\"\"\n    # Concentration score (HHI 標準化到 0-100)\n    hhi = concentration_result[\"hhi_latest\"]\n    concentration_score = min(hhi / 100, 100)  # HHI=10000 → 100\n\n    # Dependency score\n    ratio = replacement_result[\"replacement_ratio\"]\n    dependency_score = max(1 - ratio, 0)  # ratio < 1 → 有依賴風險\n\n    # Geo risk weighted\n    # 按替代國增量比例加權\n    total_increment = (replacement_result[\"Peru\"][\"expected_increment\"] +\n                       replacement_result[\"DRC\"][\"expected_increment\"])\n    peru_weight = replacement_result[\"Peru\"][\"expected_increment\"] / total_increment\n    drc_weight = replacement_result[\"DRC\"][\"expected_increment\"] / total_increment\n\n    geo_risk_weighted = (\n        geo_risk[\"Peru\"][\"z_score\"] * peru_weight +\n        geo_risk[\"DRC\"][\"z_score\"] * drc_weight\n    )\n\n    # 綜合分數\n    system_risk = concentration_score * (1 + dependency_score) * (1 + geo_risk_weighted * 0.2)\n    system_risk = min(system_risk, 100)  # 上限 100\n\n    return {\n        \"system_risk_score\": system_risk,\n        \"components\": {\n            \"concentration_score\": concentration_score,\n            \"dependency_score\": dependency_score,\n            \"geo_risk_weighted\": geo_risk_weighted\n        },\n        \"interpretation\": interpret_system_risk(system_risk)\n    }\n\ndef interpret_system_risk(score):\n    if score < 30:\n        return \"低風險 - 供應鏈相對穩健\"\n    elif score < 50:\n        return \"中等風險 - 需關注關鍵國家動態\"\n    elif score < 70:\n        return \"高風險 - 建議評估對沖策略\"\n    else:\n        return \"極高風險 - 供應中斷可能性顯著\"\n\nsystem_risk = compute_system_risk_score(concentration_result, replacement_result, geo_risk)\n```\n\n## Step 8: 生成視覺化圖表\n\n```bash\npython scripts/visualize_analysis.py --mode=scenario\n```\n\n**生成的圖表**：\n1. `copper_demand_supply_gap_YYYYMMDD.png` - 各情境供需缺口\n2. `copper_geo_risk_map_YYYYMMDD.png` - 地緣風險熱力圖\n3. `copper_system_risk_YYYYMMDD.png` - 系統風險分解\n\n## Step 9: 輸出結果\n\n**JSON 輸出：**\n\n```json\n{\n  \"commodity\": \"copper\",\n  \"analysis_type\": \"scenario_analysis\",\n  \"baseline\": {\n    \"year\": 2023,\n    \"production_mt\": 22.0,\n    \"consumption_mt\": 22.4\n  },\n  \"supply_constraints\": {\n    \"lead_time_years\": 10,\n    \"supply_ceiling_mt\": 24.7,\n    \"increment_breakdown\": {\n      \"brownfield_expansion\": 0.3,\n      \"under_construction\": 0.2,\n      \"chile_decline\": -0.82,\n      \"peru_increment\": 0.52,\n      \"drc_increment\": 0.61\n    }\n  },\n  \"scenarios\": {\n    \"base\": {\n      \"demand_cagr\": 0.03,\n      \"final_demand_mt\": 29.6,\n      \"gap_mt\": 4.9,\n      \"gap_pct\": 0.223,\n      \"severity\": \"嚴重缺口\"\n    },\n    \"electrification\": {\n      \"demand_cagr\": 0.05,\n      \"final_demand_mt\": 35.8,\n      \"gap_mt\": 11.1,\n      \"gap_pct\": 0.505,\n      \"severity\": \"嚴重缺口\"\n    },\n    \"slowdown\": {\n      \"demand_cagr\": 0.015,\n      \"final_demand_mt\": 25.6,\n      \"gap_mt\": 0.9,\n      \"gap_pct\": 0.041,\n      \"severity\": \"小缺口\"\n    }\n  },\n  \"geo_risk\": {\n    \"Chile\": {\"z_score\": 0.3, \"level\": \"低\"},\n    \"Peru\": {\"z_score\": 1.2, \"level\": \"中高\"},\n    \"DRC\": {\"z_score\": 2.1, \"level\": \"高\"}\n  },\n  \"system_risk\": {\n    \"score\": 73.5,\n    \"interpretation\": \"極高風險 - 供應中斷可能性顯著\",\n    \"components\": {\n      \"concentration_score\": 18.2,\n      \"dependency_score\": 0.12,\n      \"geo_risk_weighted\": 1.65\n    }\n  },\n  \"generated_at\": \"2026-01-24\"\n}\n```\n\n**Markdown 報告：**\n\n```markdown\n## 銅供需缺口與系統風險情境分析\n\n### 執行摘要\n\n在基準需求情境（CAGR 3%）下，10 年後供需缺口達 {gap_mt:.1f} Mt，\n佔當前產量的 {gap_pct:.1%}。考慮集中度、替代依賴與地緣風險後，\n系統風險分數為 **{system_risk:.1f}/100**（{interpretation}）。\n\n### 供應約束分析\n\n**供應反應時間約束**：{lead_time} 年\n\n| 增量來源 | 預期增量 | 說明 |\n|----------|----------|------|\n| 現有產能擴建 | +{brownfield:.2f} Mt | 短期可行 |\n| 在建項目 | +{construction:.2f} Mt | 中期釋放 |\n| 智利減產 | {chile:.2f} Mt | 結構性趨勢 |\n| 秘魯增量 | +{peru:.2f} Mt | 執行風險中 |\n| DRC 增量 | +{drc:.2f} Mt | 執行風險高 |\n| **淨可行增量** | +{feasible:.2f} Mt | - |\n| **供應天花板** | {ceiling:.2f} Mt | 10 年內上限 |\n\n### 情境分析\n\n| 情境 | 需求 CAGR | 10年後需求 | 供需缺口 | 嚴重程度 |\n|------|-----------|------------|----------|----------|\n| 經濟放緩 | 1.5% | {slow_demand:.1f} Mt | {slow_gap:.1f} Mt | {slow_severity} |\n| 基準情境 | 3.0% | {base_demand:.1f} Mt | {base_gap:.1f} Mt | {base_severity} |\n| 電氣化加速 | 5.0% | {elec_demand:.1f} Mt | {elec_gap:.1f} Mt | {elec_severity} |\n\n### 地緣風險指數\n\n| 國家 | 事件頻率 Z分數 | 風險等級 |\n|------|----------------|----------|\n| 智利 | {chile_z:.1f} | {chile_level} |\n| 秘魯 | {peru_z:.1f} | {peru_level} |\n| DRC | {drc_z:.1f} | {drc_level} |\n\n*數據來源：GDELT 事件資料庫（近 12 個月）*\n\n### 系統風險分數\n\n**綜合分數：{system_risk:.1f}/100**\n\n| 分項 | 分數 | 說明 |\n|------|------|------|\n| 集中度分數 | {concentration_score:.1f} | HHI 標準化 |\n| 依賴度分數 | {dependency_score:.2f} | 1 - replacement_ratio |\n| 地緣風險加權 | {geo_weighted:.2f} | 替代國風險加權 |\n\n**解讀**：{interpretation}\n\n### 含義與建議\n\n1. **供應鏈反應慢**：價格上漲不能在短期內解決缺口\n2. **決策窗口**：2025-2028 年間的投資決策將決定 2033 年供應\n3. **風險集中**：替代供應依賴高風險國家\n4. **監控重點**：秘魯勞工動態、DRC 政治穩定性\n\n### 數據來源\n\n- OWID Minerals Explorer（產量）\n- USGS MCS（驗證）\n- GDELT（地緣事件）\n```\n</process>\n\n<success_criteria>\n此 workflow 完成時：\n- [ ] 建立供需基準\n- [ ] 計算多情境需求預測\n- [ ] 建模供應約束與天花板\n- [ ] 計算各情境供需缺口\n- [ ] 計算地緣風險指數（GDELT）\n- [ ] 計算綜合系統風險分數\n- [ ] 輸出 JSON + Markdown 格式\n- [ ] 包含視覺化圖表\n</success_criteria>\n",
        "skills/analyze-gas-fertilizer-contract-shock/SKILL.md": "---\nname: analyze-gas-fertilizer-contract-shock\ndescription: 用天然氣與化肥價格的日頻數據，檢驗「天然氣暴漲→化肥供應受限/毀約→化肥飆價」敘事是否成立，輸出可標註到圖上的關鍵轉折點與領先落後分析。\n---\n\n<essential_principles>\n\n<principle name=\"narrative_verification\">\n**敘事驗證而非預測**\n\n本技能專注於「用數據檢驗敘事」：\n- 輸入：社群/新聞宣稱「天然氣暴漲導致化肥供應/價格異常」\n- 輸出：時間序列上的因果假說檢驗結果\n\n不做價格預測，只回答：「這個敘事在數據上是否有支撐？」\n</principle>\n\n<principle name=\"three_part_test\">\n**三段式因果檢驗**\n\n敘事成立需要三段條件同時滿足：\n\n| 階段 | 條件 | 檢驗方式 |\n|------|------|----------|\n| A 段 | 天然氣出現 shock regime | z-score 或斜率突破閾值 |\n| B 段 | 化肥在 A 段後出現 spike | 同法檢驗，且起點晚於天然氣 |\n| C 段 | 領先落後關係支持因果 | cross-correlation 顯示 gas 領先 fert |\n\n若 A→B→C 成立，敘事有量化支撐；否則提供替代解釋。\n</principle>\n\n<principle name=\"regime_detection\">\n**Regime 偵測邏輯**\n\n使用 rolling z-score + 斜率雙重確認：\n\n```python\n# z-score 偵測\nz_t = (r_t - rolling_mean(r, window)) / rolling_std(r, window)\nshock = z_t >= threshold_z  # 預設 3.0\n\n# 斜率偵測（補充）\nslope_t = (price_t / price_{t-k} - 1) / k\nshock |= slope_t >= threshold_slope  # 預設 1.5%/day\n```\n\n連續 shock 日合併為 regime，輸出起點/終點/峰值。\n</principle>\n\n<principle name=\"lead_lag_interpretation\">\n**領先落後解讀**\n\nCross-correlation 結果解讀：\n\n| lag 值 | 意義 | 敘事支撐度 |\n|--------|------|-----------|\n| lag > 0 | 天然氣領先化肥 | 高（符合預期） |\n| lag ≈ 0 | 同時變動 | 中（共同驅動） |\n| lag < 0 | 化肥領先天然氣 | 低（敘事較弱） |\n\n合理領先期：1-8 週（7-56 天）\n</principle>\n\n<principle name=\"data_source_priority\">\n**數據來源優先順序**\n\n主要：TradingEconomics（透過全自動 Chrome CDP 爬取）\n備援：FRED Henry Hub + World Bank Pink Sheet\n\n**全自動 Chrome CDP 爬取**：\n腳本自動完成以下步驟，無需手動操作：\n1. 自動啟動 Chrome 調試模式\n2. 開啟 TradingEconomics 頁面並等待圖表載入\n3. 透過 WebSocket 連接執行 JavaScript 提取 Highcharts 數據\n4. 自動導航到多個商品頁面（如天然氣→化肥）\n5. 完成後自動關閉 Chrome\n\n完全繞過 Cloudflare，無需手動驗證。\n</principle>\n\n</essential_principles>\n\n<objective>\n檢驗「天然氣暴漲→化肥飆價」的因果假說。\n\n輸出三層分析：\n1. **Shock Regimes**: 天然氣與化肥的拋物線/暴衝區間\n2. **Lead-Lag Test**: 領先落後相關分析\n3. **Narrative Assessment**: 敘事可信度判斷\n</objective>\n\n<quick_start>\n\n**全自動模式：一鍵完成數據抓取、分析與視覺化**\n\n腳本會自動啟動 Chrome、抓取數據、關閉 Chrome，無需手動操作。\n\n**Step 1：安裝依賴**\n```bash\npip install requests websocket-client pandas numpy matplotlib scipy\n```\n\n**Step 2：全自動抓取數據**（自動啟動/關閉 Chrome）\n```bash\ncd scripts\npython fetch_te_data.py --symbol natural-gas --symbol urea\n```\n\n**Step 3：執行因果假說分析**\n```bash\npython gas_fertilizer_analyzer.py \\\n  --gas-file ../data/cache/natural-gas.csv \\\n  --fert-file ../data/cache/urea.csv \\\n  --output ../data/analysis_result.json\n```\n\n**Step 4：生成視覺化圖表**（Bloomberg 風格）\n```bash\npython visualize_shock_regimes.py\n# 自動輸出到: output/gas_fert_shock_YYYY-MM-DD.png\n```\n\n**輸出範例**：\n```json\n{\n  \"signal\": \"narrative_supported\",\n  \"confidence\": \"medium\",\n  \"gas_shock_regimes\": [\n    {\"start\": \"2026-01-20\", \"peak\": \"2026-01-22\", \"regime_return_pct\": 29.1}\n  ],\n  \"fert_spike_regimes\": [\n    {\"start\": \"2025-10-27\", \"peak\": \"2025-10-27\", \"regime_return_pct\": 0.0}\n  ],\n  \"lead_lag_test\": {\n    \"best_lag_days_gas_leads_fert\": 21,\n    \"best_corr\": 0.131\n  },\n  \"interpretation\": \"天然氣領先化肥約 21 天，敘事有量化支撐\"\n}\n```\n\n**注意**：首次執行時，Chrome 會自動啟動並在背景抓取數據（約 60 秒），完成後自動關閉。\n\n</quick_start>\n\n<intake>\n需要進行什麼分析？\n\n1. **快速檢查** - 查看最近是否有天然氣 shock 及化肥跟隨\n2. **完整分析** - 執行三段式因果檢驗並生成報告\n3. **合約對沖假說** - 輸入合約價格，計算價差壓力指標\n4. **方法論學習** - 了解 shock 偵測與領先落後分析原理\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                       | Action                                     |\n|--------------------------------|--------------------------------------------|\n| 1, \"快速\", \"quick\", \"check\"    | 閱讀 `workflows/quick-check.md` 並執行     |\n| 2, \"完整\", \"full\", \"analyze\"   | 閱讀 `workflows/analyze.md` 並執行         |\n| 3, \"合約\", \"對沖\", \"hedge\"     | 閱讀 `workflows/hedge-hypothesis.md` 並執行|\n| 4, \"學習\", \"方法論\", \"why\"     | 閱讀 `references/methodology.md`           |\n| 提供參數 (如日期/商品)          | 閱讀 `workflows/analyze.md` 並使用參數執行 |\n\n**路由後，閱讀對應文件並執行。**\n</routing>\n\n<directory_structure>\n```\nanalyze-gas-fertilizer-contract-shock/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元資料\n├── workflows/\n│   ├── analyze.md                     # 完整三段式分析工作流\n│   ├── quick-check.md                 # 快速檢查工作流\n│   └── hedge-hypothesis.md            # 合約對沖假說分析\n├── references/\n│   ├── data-sources.md                # Chrome CDP 爬蟲說明\n│   ├── methodology.md                 # Shock 偵測與領先落後方法論\n│   ├── input-schema.md                # 輸入參數定義\n│   └── historical-episodes.md         # 歷史案例對照\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n├── scripts/\n│   ├── fetch_te_data.py               # TradingEconomics CDP 爬蟲\n│   ├── gas_fertilizer_analyzer.py     # 主分析腳本\n│   └── visualize_shock_regimes.py     # Shock regime 視覺化\n├── data/                              # 數據快取目錄\n│   └── cache/                         # 快取檔案\n└── examples/\n    └── sample_output.json             # 範例輸出\n```\n</directory_structure>\n\n<reference_index>\n\n**方法論**: references/methodology.md\n- Shock/Spike 偵測邏輯（z-score + 斜率）\n- 領先落後相關分析\n- Regime 合併演算法\n\n**資料來源**: references/data-sources.md\n- TradingEconomics Chrome CDP 爬蟲說明\n- 天然氣與化肥商品代碼\n- 備援數據源（FRED/World Bank）\n\n**輸入參數**: references/input-schema.md\n- 完整參數定義與預設值\n- te_symbols、spike_detection、lead_lag 等\n\n**歷史案例**: references/historical-episodes.md\n- 2021-2022 歐洲天然氣危機\n- 2022 俄烏衝突期間\n- 季節性波動案例\n\n</reference_index>\n\n<workflows_index>\n| Workflow            | Purpose               | 使用時機                   |\n|---------------------|-----------------------|---------------------------|\n| analyze.md          | 完整三段式因果分析     | 需要驗證敘事時             |\n| quick-check.md      | 快速檢查最近 shock     | 日常監控或快速回答         |\n| hedge-hypothesis.md | 合約對沖假說分析       | 給定合約價格計算價差壓力   |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose                    |\n|--------------------|----------------------------|\n| output-json.md     | JSON 輸出結構定義           |\n| output-markdown.md | Markdown 報告模板           |\n</templates_index>\n\n<scripts_index>\n| Script                       | Command                                      | Purpose                    |\n|------------------------------|----------------------------------------------|----------------------------|\n| fetch_te_data.py             | `--symbol natural-gas --symbol urea`         | 全自動 CDP 爬取（自動啟動/關閉 Chrome） |\n| gas_fertilizer_analyzer.py   | `--gas-file X.csv --fert-file Y.csv`         | 完整三段式因果分析          |\n| visualize_shock_regimes.py   | （無參數，自動讀取快取）                      | Bloomberg 風格視覺化圖表    |\n</scripts_index>\n\n<input_schema>\n\n<parameter name=\"start_date\" required=\"true\">\n**Type**: string (ISO YYYY-MM-DD)\n**Description**: 分析起始日期\n**Example**: \"2025-08-01\"\n</parameter>\n\n<parameter name=\"end_date\" required=\"true\">\n**Type**: string (ISO YYYY-MM-DD)\n**Description**: 分析結束日期\n**Example**: \"2026-02-01\"\n</parameter>\n\n<parameter name=\"te_symbols\" required=\"true\">\n**Type**: object\n**Description**: TradingEconomics 商品代碼\n```json\n{\n  \"natural_gas\": \"natural-gas\",  // 或 \"Natural Gas\"\n  \"fertilizer\": \"urea\"           // 或 \"dap\", \"fertilizer\"\n}\n```\n</parameter>\n\n<parameter name=\"spike_detection\" required=\"false\">\n**Type**: object\n**Defaults**:\n```json\n{\n  \"return_window\": 1,\n  \"z_window\": 60,\n  \"parabolic_threshold\": {\"z\": 3.0, \"slope_pct_per_day\": 1.5}\n}\n```\n</parameter>\n\n<parameter name=\"lead_lag\" required=\"false\">\n**Type**: object\n**Defaults**:\n```json\n{\n  \"max_lag_days\": 60,\n  \"method\": \"corr_returns\"\n}\n```\n</parameter>\n\n</input_schema>\n\n<output_schema>\n參見 `templates/output-json.md` 的完整結構定義。\n\n**摘要**：\n```json\n{\n  \"signal\": \"narrative_supported | narrative_weak | inconclusive\",\n  \"confidence\": \"high | medium | low\",\n  \"gas_shock_regimes\": [...],\n  \"fert_spike_regimes\": [...],\n  \"lead_lag_test\": {\n    \"best_lag_days\": 12,\n    \"best_corr\": 0.41,\n    \"interpretation\": \"gas 領先 fert\"\n  },\n  \"narrative_assessment\": \"三段式檢驗結果摘要\",\n  \"artifacts\": {\n    \"charts\": [\"output/gas_fert_shock.png\"]\n  }\n}\n```\n</output_schema>\n\n<success_criteria>\n分析成功時應產出：\n\n- [ ] 天然氣與化肥的 shock/spike regime 清單\n- [ ] 領先落後相關分析結果\n- [ ] 三段式因果檢驗判斷\n- [ ] 敘事可信度與替代解釋\n- [ ] **Shock Regime 對比圖**（output/gas_fert_shock_YYYY-MM-DD.png）\n- [ ] 可操作的宏觀解讀\n- [ ] 明確標註資料限制與假設\n</success_criteria>\n",
        "skills/analyze-gas-fertilizer-contract-shock/methodology.md": "新聞常見一種敘事：**天然氣價格突然暴衝 → 化肥廠商因能源合約或生產成本改變而出現供應問題 → 化肥價格上漲、供給緊縮**。  \n這類敘事看起來合理，但是否真的「由天然氣帶動化肥」？我們可以用一套相對中性、可重複的做法，用**日頻價格資料**把敘事拆解成可檢驗的條件。\n\n## 操作方法：三個關鍵模組\n\n### 1) 找出「暴衝區間」：用短期變化率 + 異常程度\n我們先把每一天的價格換成「變化率」（例如今天相對昨天的百分比變動），再判斷哪些日子屬於異常：\n\n- **短期變化率**：看每天漲跌是否突然變得很大  \n- **異常程度**：把當天的變化跟過去一段時間的平均與波動相比  \n  - 如果當天變化遠高於過去常態，就可視為「衝擊」\n\n把連續的異常日合併，就得到一段「天然氣衝擊區間」。\n\n### 2) 看化肥是否出現「跟隨性異常」\n對化肥價格做同樣的處理：\n\n- 是否在某一段時間上漲加速？\n- 是否波動突然變大？\n- 是否出現連續上漲（或快速拉升）的區間？\n\n這讓我們把「化肥漲價、供應緊」的描述，轉成可量化的「化肥異常區間」。\n\n### 3) 做「領先—落後」檢驗：檢查時間順序\n最後檢查：  \n化肥的異常通常是出現在天然氣異常之後幾天？幾週？\n\n一個直觀做法是：\n\n- 讓「天然氣變化率」向前、向後平移不同天數\n- 每次都計算它和「化肥變化率」的相似程度\n- 找出相似度最高的平移天數\n\n如果相似度最高出現在「天然氣先、化肥後」（例如天然氣領先 10～30 天），就支持「天然氣帶動化肥」這個時間順序；反之若化肥反而領先，敘事就比較弱。\n\n## 這套方法能回答什麼、不能回答什麼？\n\n### 能回答（適合用來做研究筆記與事件標註）\n- 天然氣是否發生「異常暴衝」？發生在何時？\n- 化肥是否出現「異常上漲/波動放大」？發生在何時？\n- 兩者時間順序是否支持「天然氣先動、化肥後動」？\n- 可以產出「關鍵轉折點清單」，把事件標到圖上做後續追新聞\n\n### 不能直接回答（需要公司與制度層資料才行）\n- 廠商是否真的靠天然氣合約賺到超額利潤\n- 廠商是否真的因此降低化肥產量或刻意毀約\n- 不可抗力的法律與契約細節是否成立\n\n因此，這套方法定位是：  \n**把故事先做成“可檢驗的時間序列命題”，用價格資料做第一輪篩選。**  \n若三段式條件都成立，你再進一步去找事件新聞、公司公告或制度資料，才會更有效率。\n",
        "skills/analyze-gas-fertilizer-contract-shock/references/data-sources.md": "# 數據來源與 Chrome CDP 爬蟲說明\n\n<overview>\n此參考文件列出天然氣與化肥價格分析所需的資料來源。\n\n**主要來源**：TradingEconomics（透過 Chrome CDP 爬取）\n**備援來源**：FRED（天然氣）、World Bank Pink Sheet（化肥）\n\n**爬取方法**：Chrome CDP（繞過 Cloudflare，完全模擬真人瀏覽）\n</overview>\n\n---\n\n## 1. TradingEconomics 商品頁面\n\n### 天然氣\n\n| 商品 | URL | Slug |\n|------|-----|------|\n| Natural Gas | https://tradingeconomics.com/commodity/natural-gas | `natural-gas` |\n| EU Natural Gas | https://tradingeconomics.com/commodity/eu-natural-gas | `eu-natural-gas` |\n| UK Natural Gas | https://tradingeconomics.com/commodity/uk-natural-gas | `uk-natural-gas` |\n\n### 化肥\n\n| 商品 | URL | Slug |\n|------|-----|------|\n| Urea | https://tradingeconomics.com/commodity/urea | `urea` |\n| DAP | https://tradingeconomics.com/commodity/dap | `dap` |\n| Fertilizers Index | https://tradingeconomics.com/commodity/fertilizers | `fertilizers` |\n\n---\n\n## 2. Chrome CDP 爬取方法\n\n### 2.1 核心原理\n\n透過 Chrome DevTools Protocol (CDP) 連接到**你自己開啟的 Chrome 瀏覽器**，完全繞過 Cloudflare。這個方法對網站來說就是「真人在用瀏覽器」。\n\n```\n┌─────────────────┐     WebSocket      ┌─────────────────┐\n│  Python Script  │ ◄────────────────► │  Chrome Browser │\n│  (CDP Client)   │    Port 9222       │  (你的 Profile) │\n└─────────────────┘                    └─────────────────┘\n        │                                      │\n        │ Runtime.evaluate()                   │\n        ▼                                      ▼\n   執行 JavaScript ──────────────────► 提取 Highcharts 數據\n```\n\n### 2.2 前置準備\n\n```bash\npip install requests websocket-client pandas numpy\n```\n\n建立專用的 Chrome profile 目錄（只需執行一次）：\n\n```bash\n# Windows\nmkdir \"%USERPROFILE%\\.chrome-debug-profile\"\n\n# macOS / Linux\nmkdir -p ~/.chrome-debug-profile\n```\n\n### 2.3 操作流程\n\n**Step 1：關閉所有 Chrome 視窗**\n\n確保沒有其他 Chrome 實例在執行，否則調試端口會無法啟動。\n\n**Step 2：啟動 Chrome（帶調試端口）**\n\n```bash\n# Windows\n\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" ^\n  --remote-debugging-port=9222 ^\n  --remote-allow-origins=* ^\n  --user-data-dir=\"%USERPROFILE%\\.chrome-debug-profile\" ^\n  \"https://tradingeconomics.com/commodity/natural-gas\"\n```\n\n```bash\n# macOS\n/Applications/Google\\ Chrome.app/Contents/MacOS/Google\\ Chrome \\\n  --remote-debugging-port=9222 \\\n  --remote-allow-origins=* \\\n  --user-data-dir=\"$HOME/.chrome-debug-profile\" \\\n  \"https://tradingeconomics.com/commodity/natural-gas\"\n```\n\n**Step 3：等待頁面完全載入**（圖表顯示）\n\n如果遇到 Cloudflare 驗證，手動完成驗證即可。\n\n**Step 4：驗證連線**\n\n```bash\ncurl -s http://127.0.0.1:9222/json\n```\n\n成功的回應範例：\n```json\n[{\n   \"title\": \"Natural Gas | 2025 Data...\",\n   \"url\": \"https://tradingeconomics.com/commodity/natural-gas\",\n   \"webSocketDebuggerUrl\": \"ws://127.0.0.1:9222/devtools/page/XXXXXX\"\n}]\n```\n\n**Step 5：執行爬蟲腳本**\n\n```bash\ncd scripts\npython fetch_te_data.py --symbol natural-gas\n```\n\n### 2.4 關鍵參數說明\n\n| 參數 | 說明 |\n|------|------|\n| `--remote-debugging-port=9222` | 開啟 CDP 調試端口（可改用其他端口） |\n| `--remote-allow-origins=*` | 允許所有來源連線（**必要**，否則 WebSocket 會被拒絕） |\n| `--user-data-dir=<path>` | 指定 profile 目錄（**必須是非預設目錄**） |\n\n---\n\n## 3. Highcharts 數據提取\n\nTradingEconomics 使用 Highcharts 渲染圖表，數據存儲在全域 `Highcharts.charts` 陣列中。\n\n### 提取 JavaScript\n\n```javascript\n(function() {\n    if (typeof Highcharts === 'undefined' || !Highcharts.charts) {\n        return JSON.stringify({error: 'Highcharts not found'});\n    }\n\n    var charts = Highcharts.charts.filter(c => c !== undefined && c !== null);\n    var result = [];\n\n    for (var i = 0; i < charts.length; i++) {\n        var chart = charts[i];\n        var chartInfo = {\n            title: chart.title ? chart.title.textStr : 'Chart ' + i,\n            series: []\n        };\n\n        for (var j = 0; j < chart.series.length; j++) {\n            var s = chart.series[j];\n            var seriesData = [];\n\n            if (s.xData && s.xData.length > 0) {\n                for (var k = 0; k < s.xData.length; k++) {\n                    if (s.yData[k] !== null) {\n                        seriesData.push({\n                            x: s.xData[k],\n                            y: s.yData[k],\n                            date: new Date(s.xData[k]).toISOString().split('T')[0]\n                        });\n                    }\n                }\n            }\n\n            if (seriesData.length > 0) {\n                chartInfo.series.push({\n                    name: s.name,\n                    dataLength: seriesData.length,\n                    data: seriesData\n                });\n            }\n        }\n        result.push(chartInfo);\n    }\n    return JSON.stringify(result);\n})()\n```\n\n---\n\n## 4. 抓取多個商品\n\n### 方法一：手動切換頁面\n\n1. 在 Chrome 中抓完 natural-gas 後\n2. 在同一分頁切換到 urea 頁面\n3. 等待頁面載入後執行第二次爬蟲\n\n```bash\npython fetch_te_data.py --symbol natural-gas\n# 在 Chrome 中切換到 urea 頁面\npython fetch_te_data.py --symbol urea\n```\n\n### 方法二：開啟新分頁（CDP 指令）\n\n```python\nimport requests\n\n# 開啟新分頁\nrequests.get('http://127.0.0.1:9222/json/new?https://tradingeconomics.com/commodity/urea')\n\n# 等待頁面載入後執行爬蟲\n```\n\n---\n\n## 5. 備援數據源\n\n### 5.1 FRED（天然氣）\n\n若 TradingEconomics 不可用，使用 FRED Henry Hub：\n\n```python\nimport pandas as pd\nimport requests\nfrom io import StringIO\n\nFRED_CSV_URL = \"https://fred.stlouisfed.org/graph/fredgraph.csv\"\n\ndef fetch_henry_hub(start_date: str, end_date: str) -> pd.Series:\n    \"\"\"\n    從 FRED 抓取 Henry Hub 天然氣價格\n\n    Parameters\n    ----------\n    start_date : str\n        起始日期 (YYYY-MM-DD)\n    end_date : str\n        結束日期 (YYYY-MM-DD)\n    \"\"\"\n    params = {\n        \"id\": \"DHHNGSP\",  # Daily Henry Hub Natural Gas Spot Price\n        \"cosd\": start_date,\n        \"coed\": end_date\n    }\n    response = requests.get(FRED_CSV_URL, params=params, timeout=30)\n    response.raise_for_status()\n\n    df = pd.read_csv(StringIO(response.text))\n    df.columns = [\"DATE\", \"DHHNGSP\"]\n    df[\"DATE\"] = pd.to_datetime(df[\"DATE\"])\n    df[\"DHHNGSP\"] = df[\"DHHNGSP\"].replace(\".\", pd.NA)\n    df[\"DHHNGSP\"] = pd.to_numeric(df[\"DHHNGSP\"], errors=\"coerce\")\n    df = df.dropna()\n\n    return df.set_index(\"DATE\")[\"DHHNGSP\"]\n```\n\n### 5.2 World Bank Pink Sheet（化肥）\n\n月頻數據，需手動下載：\n\n- URL: https://www.worldbank.org/en/research/commodity-markets\n- 檔案: CMO-Historical-Data-Monthly.xlsx\n- 相關欄位: Urea, DAP, TSP\n\n```python\n# 讀取 World Bank 數據\nimport pandas as pd\n\nwb_df = pd.read_excel(\n    \"CMO-Historical-Data-Monthly.xlsx\",\n    sheet_name=\"Monthly Prices\"\n)\nurea = wb_df[[\"Date\", \"Urea\"]].dropna()\n```\n\n---\n\n## 6. 快取策略\n\n| 參數 | 值 | 說明 |\n|------|-----|------|\n| 快取目錄 | `./data/cache` | 預設 |\n| 最大有效期 | 12 小時 | 日頻數據，每日更新一次足夠 |\n| 快取檔案 | `{symbol}_raw.json` | 原始 Highcharts 數據 |\n| CSV 檔案 | `{symbol}.csv` | 提取後的價格序列 |\n\n```python\nfrom pathlib import Path\nfrom datetime import datetime, timedelta\nimport json\n\nCACHE_DIR = Path(\"data/cache\")\nCACHE_MAX_AGE_HOURS = 12\n\ndef is_cache_valid(symbol: str) -> bool:\n    cache_file = CACHE_DIR / f\"{symbol}_raw.json\"\n    if cache_file.exists():\n        mtime = datetime.fromtimestamp(cache_file.stat().st_mtime)\n        return datetime.now() - mtime < timedelta(hours=CACHE_MAX_AGE_HOURS)\n    return False\n```\n\n---\n\n## 7. 數據單位與對齊\n\n### 單位\n\n| 商品 | 單位 | 說明 |\n|------|------|------|\n| Natural Gas | USD/MMBtu | 百萬英熱單位 |\n| EU Natural Gas | EUR/MWh | 兆瓦時 |\n| Urea | USD/ton | 噸 |\n| DAP | USD/ton | 噸 |\n\n### 對齊方法\n\n```python\ndef align_daily(gas_df: pd.DataFrame, fert_df: pd.DataFrame) -> pd.DataFrame:\n    \"\"\"對齊兩個日頻序列\"\"\"\n    merged = gas_df.merge(fert_df, left_index=True, right_index=True, how=\"outer\")\n    merged = merged.sort_index()\n    merged = merged.ffill()  # forward-fill 缺值\n    return merged.dropna()\n```\n\n---\n\n## 8. 常見問題排解\n\n### Q1: 無法連接到 Chrome 調試端口\n\n1. 確保所有 Chrome 視窗都已關閉\n2. 確認使用了非預設的 `--user-data-dir`\n3. 檢查端口 9222：\n   ```bash\n   curl -s http://127.0.0.1:9222/json\n   ```\n\n### Q2: WebSocket 連線被拒絕 (403 Forbidden)\n\n確認啟動 Chrome 時有加上 `--remote-allow-origins=*` 參數。\n\n### Q3: Highcharts not found\n\n1. 確認頁面已完全載入（圖表已顯示）\n2. 在瀏覽器 Console 中執行 `typeof Highcharts` 確認\n3. 頁面可能仍在載入，等待幾秒後再試\n\n### Q4: 被 Cloudflare 擋住\n\n1. 在 Chrome 中手動完成 Cloudflare 驗證\n2. 登入 TradingEconomics 帳號後再執行\n3. 使用你平常用的 Chrome profile（複製 cookies）\n\n### Q5: 數據與其他來源不一致\n\n1. 確認是否為同一合約（現貨 vs 期貨）\n2. 確認時區（TradingEconomics 可能為 UTC）\n3. 確認是否為日頻（非盤中價）\n\n---\n\n## 9. 腳本參考\n\n| 腳本 | 功能 | 說明 |\n|------|------|------|\n| `scripts/fetch_te_data.py` | TradingEconomics CDP 爬蟲 | 主要爬蟲腳本 |\n| `scripts/gas_fertilizer_analyzer.py` | 完整分析 | 含 FRED 備援 |\n| `scripts/visualize_shock_regimes.py` | 視覺化 | 生成對比圖 |\n\n```bash\n# 抓取天然氣\npython fetch_te_data.py --symbol natural-gas\n\n# 抓取化肥（先在 Chrome 切換到化肥頁面）\npython fetch_te_data.py --symbol urea\n\n# 指定輸出路徑\npython fetch_te_data.py --symbol natural-gas --output ../data/gas.csv\n\n# 強制重新抓取（忽略快取）\npython fetch_te_data.py --symbol urea --force-refresh\n```\n\n---\n\n## 10. 相關指南\n\n- [Chrome CDP 數據爬取 SOP](../../../thoughts/shared/guide/chrome-cdp-scraping-sop.md)\n",
        "skills/analyze-gas-fertilizer-contract-shock/references/historical-episodes.md": "# 歷史案例對照\n\n<overview>\n本文件記錄「天然氣→化肥」傳導的歷史案例，供當前分析對照參考。\n</overview>\n\n---\n\n## 1. 2021-2022 歐洲天然氣危機\n\n### 背景\n\n- 2021 年下半年起，歐洲天然氣（TTF）價格開始飆升\n- 主因：俄羅斯供應減少 + 風電出力不足 + 儲氣量低\n- 2022 年 8 月 TTF 一度突破 300 EUR/MWh（歷史新高）\n\n### 天然氣 → 化肥傳導\n\n| 時間 | 事件 |\n|------|------|\n| 2021-09 | CF Industries、Yara 宣布歐洲廠減產 |\n| 2021-10 | 多家化肥廠宣布 force majeure |\n| 2022-03 | 俄烏衝突後，Urea 價格創歷史新高（$925/ton） |\n| 2022-H2 | 天然氣回落，化肥逐步緩解但仍高於歷史均值 |\n\n### 數據觀察\n\n```\nTTF 天然氣：\n- 2021-09: ~60 EUR/MWh\n- 2021-12: ~100 EUR/MWh\n- 2022-08: ~300 EUR/MWh (峰值)\n\nUrea:\n- 2021-09: ~450 USD/ton\n- 2022-01: ~700 USD/ton\n- 2022-03: ~925 USD/ton (峰值)\n\n領先期：約 2-4 個月\n```\n\n### 本技能驗證結果（預期）\n\n若使用 2021-2022 數據：\n- A 段：TTF 多次觸發 z >= 3 的 shock\n- B 段：Urea 在 TTF shock 後 2-4 週開始上漲\n- C 段：Lead-lag 應顯示 gas 領先 fert 約 14-28 天\n- 結論：narrative_supported, confidence: high\n\n---\n\n## 2. 2022 俄烏衝突\n\n### 背景\n\n- 2022-02-24 俄羅斯入侵烏克蘭\n- 俄羅斯是全球天然氣、化肥主要出口國\n- 制裁與反制裁導致供應鏈中斷\n\n### 天然氣 → 化肥傳導\n\n這是「直接供應衝擊」而非「成本傳導」：\n\n| 傳導路徑 | 說明 |\n|----------|------|\n| 路徑 1 | 俄羅斯天然氣出口減少 → 歐洲生產成本上升 → 減產 |\n| 路徑 2 | 俄羅斯化肥出口直接減少 → 全球供給缺口 |\n| 路徑 3 | 預期心理 → 恐慌性囤積 → 價格飆升 |\n\n### 特殊性\n\n此案例中，天然氣與化肥幾乎「同時」暴漲：\n- 2022-02-24 衝突爆發\n- 2022-02-28 TTF 單日漲 30%+\n- 2022-02-28 Urea 單日漲 15%+\n\n**Lead-lag 分析可能顯示 lag ≈ 0**，因為兩者受同一事件驅動。\n\n### 本技能處理\n\n- 若 lead-lag 顯示同時變動，應標記為「共同驅動」\n- 替代解釋：地緣政治事件同時衝擊兩者\n- 這不代表「天然氣→化肥」傳導不存在，只是被更強的共同因素掩蓋\n\n---\n\n## 3. 2018-2019 中國環保限產\n\n### 背景\n\n- 中國實施嚴格環保政策\n- 部分煤化工、化肥廠被要求限產\n- 中國是全球最大尿素生產國\n\n### 傳導路徑\n\n這是「政策主導」而非「天然氣成本主導」的案例：\n\n- 環保限產 → 中國尿素產量下降\n- 國際尿素供給減少 → 價格上漲\n- 與天然氣價格無明顯關聯\n\n### 本技能處理\n\n若分析 2018-2019 數據：\n- A 段：美國天然氣可能無明顯 shock\n- B 段：Urea 仍可能有 spike（但原因是政策）\n- C 段：Lead-lag 可能顯示 fert 領先或無相關\n\n**結論**：narrative_weak，替代解釋為「政策驅動」\n\n---\n\n## 4. 季節性波動\n\n### 天然氣季節性\n\n| 季節 | 特徵 |\n|------|------|\n| 冬季 | 需求高峰（取暖），價格通常較高 |\n| 夏季 | 需求淡季，價格通常較低 |\n| 春秋 | 過渡期，價格波動較小 |\n\n### 化肥季節性\n\n| 季節 | 特徵 |\n|------|------|\n| 春季 | 北半球施肥季，需求高峰 |\n| 秋季 | 次高峰（秋播） |\n| 冬夏 | 需求淡季 |\n\n### 季節性錯配\n\n天然氣冬季高峰 vs 化肥春季高峰可能產生「虛假」的領先落後關係：\n\n- 1-2 月：天然氣高（冬季取暖）\n- 3-4 月：化肥高（春季施肥）\n- 若機械地計算 lead-lag，可能誤判為「天然氣領先化肥 2 個月」\n\n### 處理建議\n\n1. 使用 YoY 變化而非絕對水準\n2. 關注「異常波動」（z-score）而非「季節性高點」\n3. 對照歷史同期，區分「季節性」與「shock」\n\n---\n\n## 5. 案例總結\n\n| 案例 | 年份 | Gas→Fert 成立？ | 特點 |\n|------|------|-----------------|------|\n| 歐洲能源危機 | 2021-22 | 是 | 經典成本傳導案例 |\n| 俄烏衝突 | 2022-02 | 部分 | 共同驅動，lag≈0 |\n| 中國環保限產 | 2018-19 | 否 | 政策驅動，與天然氣無關 |\n| 季節性波動 | 每年 | 虛假關係 | 需去季節化處理 |\n\n---\n\n## 6. 驗證建議\n\n使用歷史數據驗證本技能時：\n\n### 6.1 預期成功案例\n\n使用 2021-09 至 2022-06 的 TTF + Urea 數據：\n- 預期 A 段、B 段、C 段皆通過\n- 預期 signal = \"narrative_supported\"\n\n### 6.2 預期失敗案例\n\n使用 2018-01 至 2019-06 的 Henry Hub + Urea 數據：\n- 預期 A 段可能不通過\n- 預期 signal = \"narrative_weak\" 或 \"inconclusive\"\n\n### 6.3 回歸測試\n\n建立自動化測試，確保：\n- 已知成功案例仍輸出 \"narrative_supported\"\n- 已知失敗案例不輸出 \"narrative_supported\"\n",
        "skills/analyze-gas-fertilizer-contract-shock/references/input-schema.md": "# 輸入參數定義\n\n<overview>\n本文件定義 analyze-gas-fertilizer-contract-shock 技能的完整輸入參數結構。\n</overview>\n\n---\n\n## 必要參數\n\n### start_date\n\n| 屬性 | 值             |\n|------|----------------|\n| 類型 | string         |\n| 格式 | YYYY-MM-DD     |\n| 必填 | 是             |\n| 說明 | 分析起始日期   |\n| 範例 | `\"2025-08-01\"` |\n\n### end_date\n\n| 屬性 | 值             |\n|------|----------------|\n| 類型 | string         |\n| 格式 | YYYY-MM-DD     |\n| 必填 | 是             |\n| 說明 | 分析結束日期   |\n| 範例 | `\"2026-02-01\"` |\n\n### freq\n\n| 屬性   | 值               |\n|--------|------------------|\n| 類型   | string           |\n| 必填   | 是               |\n| 固定值 | `\"1D\"`           |\n| 說明   | 資料頻率（日頻） |\n\n### te_symbols\n\n| 屬性 | 值                        |\n|------|---------------------------|\n| 類型 | object                    |\n| 必填 | 是                        |\n| 說明 | TradingEconomics 商品代碼 |\n\n**結構**：\n\n```json\n{\n  \"natural_gas\": \"natural-gas\",\n  \"fertilizer\": \"urea\"\n}\n```\n\n**natural_gas 選項**：\n\n| 值                 | 說明                         |\n|--------------------|------------------------------|\n| `\"natural-gas\"`    | 美國天然氣（Henry Hub 基準） |\n| `\"eu-natural-gas\"` | 歐洲天然氣（TTF 基準）       |\n| `\"uk-natural-gas\"` | 英國天然氣                   |\n\n**fertilizer 選項**：\n\n| 值              | 說明               |\n|-----------------|--------------------|\n| `\"urea\"`        | 尿素（最常見氮肥） |\n| `\"dap\"`         | 磷酸二銨           |\n| `\"fertilizers\"` | 化肥綜合指數       |\n\n---\n\n## 選填參數\n\n### te_ui_time_range\n\n| 屬性 | 值                             |\n|------|--------------------------------|\n| 類型 | string                         |\n| 必填 | 否                             |\n| 預設 | `\"6M\"`                         |\n| 說明 | TradingEconomics UI 的區間按鈕 |\n\n**選項**：\n\n| 值      | 說明     |\n|---------|----------|\n| `\"1M\"`  | 1 個月   |\n| `\"3M\"`  | 3 個月   |\n| `\"6M\"`  | 6 個月   |\n| `\"1Y\"`  | 1 年     |\n| `\"5Y\"`  | 5 年     |\n| `\"All\"` | 全部歷史 |\n\n---\n\n### cdp\n\n| 屬性 | 值              |\n|------|-----------------|\n| 類型 | object          |\n| 必填 | 否              |\n| 說明 | Chrome CDP 配置 |\n\n**結構**：\n\n```json\n{\n  \"port\": 9222,\n  \"timeout_seconds\": 30,\n  \"cache_hours\": 12\n}\n```\n\n**欄位說明**：\n\n| 欄位            | 類型 | 預設   | 說明                   |\n|-----------------|------|--------|------------------------|\n| port            | int  | `9222` | Chrome 調試端口        |\n| timeout_seconds | int  | `30`   | WebSocket 連線超時時間 |\n| cache_hours     | int  | `12`   | 快取有效時間（小時）   |\n\n---\n\n### spike_detection\n\n| 屬性 | 值                   |\n|------|----------------------|\n| 類型 | object               |\n| 必填 | 否                   |\n| 說明 | Shock/Spike 偵測參數 |\n\n**結構**：\n\n```json\n{\n  \"return_window\": 1,\n  \"z_window\": 60,\n  \"parabolic_threshold\": {\n    \"z\": 3.0,\n    \"slope_pct_per_day\": 1.5\n  }\n}\n```\n\n**欄位說明**：\n\n| 欄位                                  | 類型  | 預設  | 說明                       |\n|---------------------------------------|-------|-------|----------------------------|\n| return_window                         | int   | `1`   | 報酬計算窗口（天）         |\n| z_window                              | int   | `60`  | rolling z-score 視窗（天） |\n| parabolic_threshold.z                 | float | `3.0` | z-score 閾值               |\n| parabolic_threshold.slope_pct_per_day | float | `1.5` | 斜率閾值（%/天）           |\n\n**調參建議**：\n\n| 場景       | z       | slope |\n|------------|---------|-------|\n| 一般市場   | 3.0     | 1.5   |\n| 高波動市場 | 3.5-4.0 | 2.0   |\n| 保守偵測   | 2.5     | 1.0   |\n\n---\n\n### lead_lag\n\n| 屬性 | 值               |\n|------|------------------|\n| 類型 | object           |\n| 必填 | 否               |\n| 說明 | 領先落後分析參數 |\n\n**結構**：\n\n```json\n{\n  \"max_lag_days\": 60,\n  \"method\": \"corr_returns\"\n}\n```\n\n**欄位說明**：\n\n| 欄位         | 類型   | 預設             | 說明              |\n|--------------|--------|------------------|-------------------|\n| max_lag_days | int    | `60`             | 最大領先/落後天數 |\n| method       | string | `\"corr_returns\"` | 相關計算方法      |\n\n**method 選項**：\n\n| 值               | 說明                     |\n|------------------|--------------------------|\n| `\"corr_returns\"` | 報酬率的交叉相關（推薦） |\n| `\"corr_levels\"`  | 價格水準的交叉相關       |\n\n---\n\n### hedge_hypothesis\n\n| 屬性 | 值               |\n|------|------------------|\n| 類型 | object           |\n| 必填 | 否               |\n| 說明 | 合約對沖假說參數 |\n\n**結構**：\n\n```json\n{\n  \"gas_contract_price\": 0.80,\n  \"gas_contract_unit\": \"USD/MMBtu\",\n  \"profit_proxy_mode\": \"spot_minus_contract\"\n}\n```\n\n**欄位說明**：\n\n| 欄位               | 類型   | 預設                    | 說明               |\n|--------------------|--------|-------------------------|--------------------|\n| gas_contract_price | float  | 無預設                  | 新聞宣稱的合約價格 |\n| gas_contract_unit  | string | `\"USD/MMBtu\"`           | 價格單位           |\n| profit_proxy_mode  | string | `\"spot_minus_contract\"` | 計算模式           |\n\n**注意**：只有在執行 hedge-hypothesis workflow 時才需要此參數。\n\n---\n\n### output\n\n| 屬性 | 值       |\n|------|----------|\n| 類型 | object   |\n| 必填 | 否       |\n| 說明 | 輸出配置 |\n\n**結構**：\n\n```json\n{\n  \"format\": \"json\",\n  \"include_charts\": true\n}\n```\n\n**欄位說明**：\n\n| 欄位           | 類型    | 預設     | 說明                                 |\n|----------------|---------|----------|--------------------------------------|\n| format         | string  | `\"json\"` | 輸出格式（`\"json\"` 或 `\"markdown\"`） |\n| include_charts | boolean | `true`   | 是否輸出圖表檔案路徑                 |\n\n---\n\n## 完整範例\n\n### 最小配置\n\n```json\n{\n  \"start_date\": \"2025-08-01\",\n  \"end_date\": \"2026-02-01\",\n  \"freq\": \"1D\",\n  \"te_symbols\": {\n    \"natural_gas\": \"natural-gas\",\n    \"fertilizer\": \"urea\"\n  }\n}\n```\n\n### 完整配置\n\n```json\n{\n  \"start_date\": \"2025-08-01\",\n  \"end_date\": \"2026-02-01\",\n  \"freq\": \"1D\",\n  \"te_symbols\": {\n    \"natural_gas\": \"natural-gas\",\n    \"fertilizer\": \"urea\"\n  },\n  \"te_ui_time_range\": \"6M\",\n  \"cdp\": {\n    \"port\": 9222,\n    \"timeout_seconds\": 30,\n    \"cache_hours\": 12\n  },\n  \"spike_detection\": {\n    \"return_window\": 1,\n    \"z_window\": 60,\n    \"parabolic_threshold\": {\n      \"z\": 3.0,\n      \"slope_pct_per_day\": 1.5\n    }\n  },\n  \"lead_lag\": {\n    \"max_lag_days\": 60,\n    \"method\": \"corr_returns\"\n  },\n  \"hedge_hypothesis\": {\n    \"gas_contract_price\": 0.80,\n    \"gas_contract_unit\": \"USD/MMBtu\",\n    \"profit_proxy_mode\": \"spot_minus_contract\"\n  },\n  \"output\": {\n    \"format\": \"json\",\n    \"include_charts\": true\n  }\n}\n```\n\n---\n\n## Chrome CDP 前置要求\n\n使用本技能前，需要：\n\n1. **安裝 Google Chrome**（版本 90+）\n2. **建立專用 profile 目錄**：\n   ```bash\n   # Windows\n   mkdir \"%USERPROFILE%\\.chrome-debug-profile\"\n\n   # macOS / Linux\n   mkdir -p ~/.chrome-debug-profile\n   ```\n3. **啟動 Chrome 調試模式**：\n   ```bash\n   chrome --remote-debugging-port=9222 --remote-allow-origins=* --user-data-dir=\"<profile-path>\"\n   ```\n\n詳細說明請參閱 `references/data-sources.md`。\n",
        "skills/analyze-gas-fertilizer-contract-shock/references/methods.md": "# 方法論：Shock 偵測與領先落後分析\n\n<overview>\n本文件說明天然氣→化肥因果假說檢驗的技術方法論。\n\n核心問題：如何從價格時間序列判斷「A 導致 B」？\n\n答案：時序上 A 先動、B 後動，且統計上 A 領先 B。\n</overview>\n\n---\n\n## 1. 三段式因果檢驗框架\n\n### 1.1 設計原理\n\n敘事「天然氣暴漲→化肥供應受限→化肥飆價」包含三個可檢驗的假說：\n\n| 階段 | 假說 | 可觀測證據 |\n|------|------|-----------|\n| A | 天然氣出現異常暴漲 | Gas 價格 z-score 或斜率突破閾值 |\n| B | 化肥在 A 之後出現異常上漲 | Fert 價格在 Gas shock 後出現 spike |\n| C | Gas 統計上領先 Fert | Cross-correlation 顯示 Gas 領先 |\n\n### 1.2 判斷邏輯\n\n```\nA_pass AND B_pass AND C_pass → 敘事有強支撐\nA_pass AND B_pass           → 敘事有中度支撐（但 lead-lag 不明確）\nA_pass only                 → 敘事較弱（化肥未跟隨）\nNone                        → 不成立\n```\n\n---\n\n## 2. Shock/Spike 偵測方法\n\n### 2.1 Rolling Z-Score\n\n**定義**：當日報酬率相對於歷史分布的標準化偏離程度。\n\n```python\nr_t = price_t / price_{t-1} - 1  # 日報酬率\n\nmu_t = rolling_mean(r, window=60)  # 60 日滾動平均\nsigma_t = rolling_std(r, window=60)  # 60 日滾動標準差\n\nz_t = (r_t - mu_t) / sigma_t\n```\n\n**閾值解讀**：\n\n| z 值 | 機率（常態分布） | 意義 |\n|------|-----------------|------|\n| z >= 2 | ~2.3% | 異常 |\n| z >= 3 | ~0.13% | 極端異常 |\n| z >= 4 | ~0.003% | 黑天鵝等級 |\n\n**預設閾值**：z >= 3.0\n\n### 2.2 斜率代理\n\n**定義**：短期價格變化的日均漲幅。\n\n```python\nk = 20  # 20 日視窗\nslope_t = (price_t / price_{t-k} - 1) / k\n```\n\n**解讀**：\n- slope = 1.5% 代表過去 20 天日均漲 1.5%\n- 20 天累計漲幅 = 1.5% × 20 = 30%\n\n**預設閾值**：slope >= 1.5%/day\n\n### 2.3 雙重確認\n\n使用 z-score 或斜率任一觸發即標記為 shock：\n\n```python\nshock = (z_t >= z_threshold) | (slope_t >= slope_threshold)\n```\n\n**為什麼雙重條件？**\n- z-score 捕捉「突然爆發」（單日大漲）\n- 斜率捕捉「持續攀升」（多日累積）\n- 兩者互補，覆蓋不同類型的 shock\n\n---\n\n## 3. Regime 合併演算法\n\n### 3.1 問題\n\n連續多天的 shock 應視為同一個 regime，而非多個獨立事件。\n\n### 3.2 演算法\n\n```python\ndef compress_boolean_to_regimes(df, shock_col, value_col):\n    \"\"\"\n    將布林值序列壓縮為 regime 清單\n\n    Returns:\n    [\n        {\n            \"start\": \"2026-01-12\",\n            \"end\": \"2026-01-29\",\n            \"peak_date\": \"2026-01-25\",\n            \"peak_value\": 6.95,\n            \"regime_return_pct\": 85.4,\n            \"duration_days\": 18\n        },\n        ...\n    ]\n    \"\"\"\n    regimes = []\n    in_regime = False\n    current_regime = None\n\n    for idx, row in df.iterrows():\n        if row[shock_col] and not in_regime:\n            # 新 regime 開始\n            in_regime = True\n            current_regime = {\n                \"start\": idx,\n                \"end\": idx,\n                \"peak_value\": row[value_col],\n                \"peak_date\": idx,\n                \"start_value\": row[value_col]\n            }\n        elif row[shock_col] and in_regime:\n            # 延續 regime\n            current_regime[\"end\"] = idx\n            if row[value_col] > current_regime[\"peak_value\"]:\n                current_regime[\"peak_value\"] = row[value_col]\n                current_regime[\"peak_date\"] = idx\n        elif not row[shock_col] and in_regime:\n            # Regime 結束\n            in_regime = False\n            current_regime[\"regime_return_pct\"] = (\n                (current_regime[\"peak_value\"] / current_regime[\"start_value\"] - 1) * 100\n            )\n            current_regime[\"duration_days\"] = (\n                current_regime[\"end\"] - current_regime[\"start\"]\n            ).days + 1\n            regimes.append(current_regime)\n            current_regime = None\n\n    return regimes\n```\n\n---\n\n## 4. 領先落後分析\n\n### 4.1 Cross-Correlation\n\n計算兩個時間序列在不同 lag 下的相關係數。\n\n```python\nfrom scipy import signal\n\ndef cross_correlation_analysis(x, y, max_lag=60):\n    \"\"\"\n    計算 x 與 y 的交叉相關\n\n    Returns:\n    {\n        \"best_lag\": int,   # 最大相關的 lag\n        \"best_corr\": float, # 最大相關係數\n        \"all_lags\": [...],  # 所有 lag\n        \"all_corrs\": [...]  # 所有相關係數\n    }\n    \"\"\"\n    # 標準化\n    x = (x - x.mean()) / x.std()\n    y = (y - y.mean()) / y.std()\n\n    # 計算交叉相關\n    corr = signal.correlate(x, y, mode='full')\n    lags = signal.correlation_lags(len(x), len(y), mode='full')\n\n    # 正規化\n    corr = corr / max(len(x), len(y))\n\n    # 限制在 max_lag 範圍內\n    mask = (lags >= -max_lag) & (lags <= max_lag)\n    lags = lags[mask]\n    corr = corr[mask]\n\n    # 找最大\n    best_idx = np.argmax(np.abs(corr))\n\n    return {\n        \"best_lag\": lags[best_idx],\n        \"best_corr\": corr[best_idx],\n        \"all_lags\": lags.tolist(),\n        \"all_corrs\": corr.tolist()\n    }\n```\n\n### 4.2 Lag 解讀\n\n| best_lag | 意義 | 敘事支撐度 |\n|----------|------|-----------|\n| > 0 | x 領先 y（Gas 領先 Fert） | 高 |\n| = 0 | 同時變動 | 中（共同驅動） |\n| < 0 | y 領先 x（Fert 領先 Gas） | 低 |\n\n### 4.3 合理領先期\n\n根據經濟傳導機制，Gas → Fert 的合理領先期：\n\n| 傳導環節 | 時間 |\n|----------|------|\n| 天然氣價格上漲被觀察 | 即時 |\n| 生產商評估成本影響 | 1-2 週 |\n| 決定減產/停產 | 2-4 週 |\n| 供給減少反映到化肥價格 | 2-4 週 |\n| **總計** | **1-8 週（7-56 天）** |\n\n若 best_lag 在 7-56 天範圍內，敘事更有說服力。\n\n---\n\n## 5. 替代解釋\n\n當敘事檢驗不成立時，應提供替代解釋：\n\n### 5.1 Gas 大漲但 Fert 不動\n\n可能原因：\n- 化肥庫存充足，短期不受影響\n- 化肥價格由需求主導（農業週期）\n- 其他生產成本抵消（如運費下降）\n- 政府補貼或價格管制\n\n### 5.2 Fert 先動\n\n可能原因：\n- 化肥需求獨立變化（種植季節）\n- 出口限制或貿易政策\n- 預期效應（市場預期 Gas 將上漲）\n\n### 5.3 兩者同時動\n\n可能原因：\n- 共同驅動因素（地緣政治事件）\n- 整體能源成本上升\n- 通膨預期\n\n---\n\n## 6. 方法論限制\n\n### 6.1 無法證明因果\n\n時間序列分析只能證明「相關」和「時序先後」，不能證明「因果」。\n\n敘事成立需要額外條件：\n- 機制合理（Gas 是 Fert 的成本）\n- 無重大干擾因素\n- 類似情況歷史上也成立\n\n### 6.2 數據頻率限制\n\n- TradingEconomics 日頻數據可能有缺失\n- World Bank Pink Sheet 為月頻\n- 不同頻率混用需謹慎對齊\n\n### 6.3 地區差異\n\n- 美國 Henry Hub 天然氣與歐洲 TTF 價格可能背離\n- 全球化肥市場但有區域差異\n- 跨區域分析需額外考慮\n\n---\n\n## 7. 參數建議\n\n### 7.1 預設參數\n\n```python\nDEFAULT_PARAMS = {\n    \"return_window\": 1,        # 日報酬\n    \"z_window\": 60,            # 60 日 rolling\n    \"z_threshold\": 3.0,        # 3 標準差\n    \"slope_window\": 20,        # 20 日斜率\n    \"slope_threshold\": 0.015,  # 1.5%/day\n    \"max_lag_days\": 60,        # 最大 lag 60 天\n    \"reasonable_lag_range\": (7, 56)  # 合理領先期\n}\n```\n\n### 7.2 調參建議\n\n| 場景 | 調整 |\n|------|------|\n| 波動性高的市場 | 提高 z_threshold 到 3.5-4.0 |\n| 短期分析（< 3 個月） | 縮短 z_window 到 30-40 |\n| 週頻數據 | 調整 reasonable_lag_range 到 (1, 8) 週 |\n\n---\n\n## 8. 參考文獻\n\n- Hamilton, J. D. (1994). *Time Series Analysis*. Princeton University Press.\n- Granger, C. W. J. (1969). \"Investigating Causal Relations by Econometric Models and Cross-spectral Methods.\" *Econometrica*.\n- Stock, J. H., & Watson, M. W. (1999). \"Forecasting Inflation.\" *Journal of Monetary Economics*.\n",
        "skills/analyze-gas-fertilizer-contract-shock/templates/output-json.md": "# JSON 輸出結構定義\n\n<overview>\n本文件定義 analyze-gas-fertilizer-contract-shock 技能的 JSON 輸出結構。\n</overview>\n\n---\n\n## 完整結構\n\n```json\n{\n  \"metadata\": {\n    \"skill_name\": \"analyze-gas-fertilizer-contract-shock\",\n    \"skill_version\": \"0.1.0\",\n    \"analysis_timestamp\": \"2026-01-28T10:30:00Z\",\n    \"parameters\": {\n      \"start_date\": \"2025-08-01\",\n      \"end_date\": \"2026-02-01\",\n      \"freq\": \"1D\"\n    }\n  },\n\n  \"series\": {\n    \"natural_gas\": {\n      \"symbol\": \"natural-gas\",\n      \"source\": \"TradingEconomics\",\n      \"unit\": \"USD/MMBtu\",\n      \"data_points\": 180,\n      \"date_range\": [\"2025-08-01\", \"2026-01-28\"]\n    },\n    \"fertilizer\": {\n      \"symbol\": \"urea\",\n      \"source\": \"TradingEconomics\",\n      \"unit\": \"USD/ton\",\n      \"data_points\": 175,\n      \"date_range\": [\"2025-08-01\", \"2026-01-28\"]\n    }\n  },\n\n  \"detections\": {\n    \"gas_shock_regimes\": [\n      {\n        \"start\": \"2026-01-12\",\n        \"end\": \"2026-01-29\",\n        \"peak_date\": \"2026-01-29\",\n        \"peak_value\": 6.95,\n        \"start_value\": 3.75,\n        \"regime_return_pct\": 85.4,\n        \"duration_days\": 18,\n        \"max_z_score\": 4.2,\n        \"max_slope_pct_per_day\": 2.1\n      }\n    ],\n    \"fert_spike_regimes\": [\n      {\n        \"start\": \"2026-01-20\",\n        \"end\": \"2026-02-01\",\n        \"peak_date\": \"2026-01-31\",\n        \"peak_value\": 420.0,\n        \"start_value\": 344.0,\n        \"regime_return_pct\": 22.1,\n        \"duration_days\": 13,\n        \"max_z_score\": 3.5,\n        \"max_slope_pct_per_day\": 1.8\n      }\n    ]\n  },\n\n  \"lead_lag_test\": {\n    \"method\": \"corr_returns\",\n    \"max_lag_days\": 60,\n    \"best_lag_days_gas_leads_fert\": 12,\n    \"best_corr\": 0.41,\n    \"corr_at_zero_lag\": 0.25,\n    \"reasonable_lag_range\": [7, 56],\n    \"in_reasonable_range\": true,\n    \"interpretation\": \"天然氣報酬領先化肥報酬約 12 天，相關係數為中度\"\n  },\n\n  \"three_part_test\": {\n    \"A_gas_shock\": {\n      \"pass\": true,\n      \"regime_count\": 1,\n      \"max_return_pct\": 85.4,\n      \"total_days\": 18\n    },\n    \"B_fert_follows\": {\n      \"pass\": true,\n      \"fert_start_after_gas_start\": true,\n      \"lag_days\": 8,\n      \"explanation\": \"化肥 spike 起點（2026-01-20）晚於天然氣 shock 起點（2026-01-12）約 8 天\"\n    },\n    \"C_lead_lag_supports\": {\n      \"pass\": true,\n      \"lag_in_range\": true,\n      \"corr_significant\": true,\n      \"explanation\": \"best_lag=12 在合理範圍 [7,56] 內，相關係數 0.41 為中度\"\n    }\n  },\n\n  \"signal\": \"narrative_supported\",\n  \"confidence\": \"medium\",\n\n  \"narrative_assessment\": {\n    \"summary\": \"三段式因果檢驗通過，敘事有量化支撐\",\n    \"details\": [\n      \"天然氣在樣本末端出現明顯 shock regime（z-score/斜率同時觸發）\",\n      \"化肥在天然氣 shock 後約 1-3 週出現 spike regime，時序關係符合預期\",\n      \"交叉相關顯示 gas 報酬領先 fert 報酬約 12 天，達到中度相關\",\n      \"僅憑價格無法證明 force majeure/毀約，但可提供敘事的時間序列支持度\"\n    ],\n    \"alternative_explanations\": [\n      \"化肥 spike 可能還受其他因素影響（運費、需求、政策）\",\n      \"相關係數 0.41 為中度，部分變異來自其他驅動因素\"\n    ]\n  },\n\n  \"hedge_proxy\": {\n    \"enabled\": false,\n    \"contract_price\": null,\n    \"unit\": null,\n    \"peak_proxy\": null,\n    \"interpretation\": null\n  },\n\n  \"artifacts\": {\n    \"data_files\": [\n      \"data/natural_gas.csv\",\n      \"data/urea.csv\",\n      \"data/analysis_result.json\"\n    ],\n    \"charts\": [\n      \"output/gas_fert_shock_2026-01-28.png\"\n    ]\n  },\n\n  \"caveats\": [\n    \"數據來源為 TradingEconomics，可能與交易所官方數據有差異\",\n    \"日頻數據可能有缺失，已使用 forward-fill 處理\",\n    \"相關不代表因果，需配合機制分析\",\n    \"本分析不構成任何投資建議\"\n  ]\n}\n```\n\n---\n\n## 欄位說明\n\n### metadata\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| skill_name | string | 技能名稱 |\n| skill_version | string | 技能版本 |\n| analysis_timestamp | string | 分析時間（ISO 8601） |\n| parameters | object | 輸入參數快照 |\n\n### series\n\n每個商品包含：\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| symbol | string | 商品代碼 |\n| source | string | 數據來源 |\n| unit | string | 價格單位 |\n| data_points | int | 數據筆數 |\n| date_range | array | 日期範圍 [start, end] |\n\n### detections.gas_shock_regimes / fert_spike_regimes\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| start | string | Regime 起始日 |\n| end | string | Regime 結束日 |\n| peak_date | string | 峰值日期 |\n| peak_value | float | 峰值價格 |\n| start_value | float | 起始價格 |\n| regime_return_pct | float | Regime 內漲幅（%） |\n| duration_days | int | 持續天數 |\n| max_z_score | float | 最大 z-score |\n| max_slope_pct_per_day | float | 最大斜率（%/day） |\n\n### lead_lag_test\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| method | string | 計算方法 |\n| max_lag_days | int | 最大 lag 搜尋範圍 |\n| best_lag_days_gas_leads_fert | int | 最佳 lag（正=gas 領先） |\n| best_corr | float | 最大相關係數 |\n| corr_at_zero_lag | float | 零 lag 相關係數 |\n| reasonable_lag_range | array | 合理領先期範圍 |\n| in_reasonable_range | bool | 是否在合理範圍內 |\n| interpretation | string | 文字解讀 |\n\n### three_part_test\n\n三段式檢驗結果：\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| A_gas_shock.pass | bool | A 段是否通過 |\n| B_fert_follows.pass | bool | B 段是否通過 |\n| C_lead_lag_supports.pass | bool | C 段是否通過 |\n\n### signal\n\n| 值 | 說明 |\n|-----|------|\n| `\"narrative_supported\"` | 敘事有量化支撐 |\n| `\"narrative_weak\"` | 敘事較弱 |\n| `\"inconclusive\"` | 無法判斷 |\n\n### confidence\n\n| 值 | 條件 |\n|-----|------|\n| `\"high\"` | 三段皆通過 + corr > 0.5 |\n| `\"medium\"` | 三段皆通過 + 0.3 < corr <= 0.5 |\n| `\"low\"` | 部分通過或 corr <= 0.3 |\n\n---\n\n## 精簡輸出（Quick Check）\n\n```json\n{\n  \"check_date\": \"2026-01-28\",\n  \"lookback_days\": 180,\n  \"gas_status\": {\n    \"current_z\": 2.1,\n    \"is_shock\": false,\n    \"recent_shock\": {\n      \"exists\": true,\n      \"last_date\": \"2026-01-29\",\n      \"days_ago\": 0\n    }\n  },\n  \"fert_status\": {\n    \"current_z\": 1.5,\n    \"is_spike\": false,\n    \"recent_spike\": {\n      \"exists\": true,\n      \"last_date\": \"2026-01-31\",\n      \"days_ago\": 0\n    }\n  },\n  \"quick_assessment\": \"gas_shock_recent_fert_following\",\n  \"recommendation\": \"建議執行完整分析以驗證因果關係\"\n}\n```\n",
        "skills/analyze-gas-fertilizer-contract-shock/templates/output-markdown.md": "# Markdown 報告模板\n\n<overview>\n本文件定義 analyze-gas-fertilizer-contract-shock 技能的 Markdown 輸出模板。\n</overview>\n\n---\n\n## 報告模板\n\n```markdown\n# 天然氣→化肥因果假說分析報告\n\n**分析日期**: {{analysis_date}}\n**數據區間**: {{start_date}} 至 {{end_date}}\n**數據來源**: TradingEconomics ({{gas_symbol}}, {{fert_symbol}})\n\n---\n\n## TL;DR\n\n{{signal_emoji}} **{{signal_text}}**（信心水準：{{confidence}}）\n\n{{summary_sentence}}\n\n---\n\n## 一、三段式因果檢驗結果\n\n| 階段 | 檢驗內容 | 結果 | 說明 |\n|------|----------|------|------|\n| A: Gas Shock | 天然氣出現異常暴漲？ | {{A_result}} | {{A_explanation}} |\n| B: Fert Follows | 化肥在 A 段後上漲？ | {{B_result}} | {{B_explanation}} |\n| C: Lead-Lag | 統計上 Gas 領先 Fert？ | {{C_result}} | {{C_explanation}} |\n\n---\n\n## 二、天然氣 Shock Regime\n\n{{#if gas_shock_regimes}}\n| 起始 | 結束 | 峰值日 | 峰值 | 漲幅 | 持續 |\n|------|------|--------|------|------|------|\n{{#each gas_shock_regimes}}\n| {{start}} | {{end}} | {{peak_date}} | {{peak_value}} {{unit}} | +{{regime_return_pct}}% | {{duration_days}} 天 |\n{{/each}}\n\n**最大 z-score**: {{max_z_score}}\n**最大斜率**: {{max_slope}}%/天\n{{else}}\n*樣本期間內未偵測到天然氣 shock。*\n{{/if}}\n\n---\n\n## 三、化肥 Spike Regime\n\n{{#if fert_spike_regimes}}\n| 起始 | 結束 | 峰值日 | 峰值 | 漲幅 | 持續 |\n|------|------|--------|------|------|------|\n{{#each fert_spike_regimes}}\n| {{start}} | {{end}} | {{peak_date}} | {{peak_value}} {{unit}} | +{{regime_return_pct}}% | {{duration_days}} 天 |\n{{/each}}\n\n**與天然氣 shock 的時序關係**: 化肥 spike 起點晚於天然氣 shock 起點約 {{lag_days}} 天\n{{else}}\n*樣本期間內未偵測到化肥 spike。*\n{{/if}}\n\n---\n\n## 四、領先落後分析\n\n| 指標 | 值 | 解讀 |\n|------|-----|------|\n| 最佳 Lag | {{best_lag}} 天 | {{lag_interpretation}} |\n| 相關係數 | {{best_corr}} | {{corr_interpretation}} |\n| 合理範圍 | 7-56 天 | {{in_range_text}} |\n\n**方法**: {{method}}（{{method_description}}）\n\n---\n\n## 五、敘事評估\n\n### 結論\n\n{{narrative_summary}}\n\n### 支持證據\n\n{{#each supporting_evidence}}\n- {{this}}\n{{/each}}\n\n### 替代解釋\n\n{{#each alternative_explanations}}\n- {{this}}\n{{/each}}\n\n---\n\n## 六、注意事項\n\n{{#each caveats}}\n- {{this}}\n{{/each}}\n\n---\n\n## 七、下一步建議\n\n{{#each recommendations}}\n- {{this}}\n{{/each}}\n\n---\n\n## 附錄：圖表\n\n{{#if charts}}\n{{#each charts}}\n![{{description}}]({{path}})\n{{/each}}\n{{else}}\n*未生成圖表。*\n{{/if}}\n\n---\n\n*報告由 analyze-gas-fertilizer-contract-shock v{{skill_version}} 自動生成*\n*數據來源: TradingEconomics | 分析時間: {{analysis_timestamp}}*\n```\n\n---\n\n## 變數說明\n\n### 信號相關\n\n| 變數 | 來源 | 說明 |\n|------|------|------|\n| signal_emoji | 根據 signal 值 | ✅ / ⚠️ / ❓ |\n| signal_text | 根據 signal 值 | 敘事有支撐 / 敘事較弱 / 無法判斷 |\n| confidence | JSON output | high / medium / low |\n| summary_sentence | 動態生成 | 一句話總結 |\n\n### 三段式檢驗\n\n| 變數 | 來源 | 說明 |\n|------|------|------|\n| A_result | three_part_test.A_gas_shock.pass | ✓ / ✗ |\n| B_result | three_part_test.B_fert_follows.pass | ✓ / ✗ |\n| C_result | three_part_test.C_lead_lag_supports.pass | ✓ / ✗ |\n| A_explanation | 動態生成 | A 段解釋 |\n| B_explanation | 動態生成 | B 段解釋 |\n| C_explanation | 動態生成 | C 段解釋 |\n\n### Regime 資訊\n\n| 變數 | 來源 | 說明 |\n|------|------|------|\n| gas_shock_regimes | detections | 天然氣 shock 清單 |\n| fert_spike_regimes | detections | 化肥 spike 清單 |\n\n### Lead-Lag\n\n| 變數 | 來源 | 說明 |\n|------|------|------|\n| best_lag | lead_lag_test | 最佳 lag 天數 |\n| best_corr | lead_lag_test | 最大相關係數 |\n| lag_interpretation | 動態生成 | lag 解讀 |\n| corr_interpretation | 動態生成 | 相關係數解讀 |\n\n---\n\n## 範例輸出\n\n```markdown\n# 天然氣→化肥因果假說分析報告\n\n**分析日期**: 2026-01-28\n**數據區間**: 2025-08-01 至 2026-02-01\n**數據來源**: TradingEconomics (natural-gas, urea)\n\n---\n\n## TL;DR\n\n✅ **敘事有量化支撐**（信心水準：medium）\n\n天然氣在 2026 年 1 月出現明顯 shock，化肥在其後約 8 天開始上漲，領先落後分析顯示 gas 領先 fert 約 12 天，時序關係支持「天然氣暴漲→化肥飆價」的敘事。\n\n---\n\n## 一、三段式因果檢驗結果\n\n| 階段 | 檢驗內容 | 結果 | 說明 |\n|------|----------|------|------|\n| A: Gas Shock | 天然氣出現異常暴漲？ | ✓ | 2026-01-12 至 01-29，漲幅 85.4% |\n| B: Fert Follows | 化肥在 A 段後上漲？ | ✓ | 2026-01-20 起漲，晚於 gas shock 8 天 |\n| C: Lead-Lag | 統計上 Gas 領先 Fert？ | ✓ | 最佳 lag 12 天，在合理範圍內 |\n\n---\n\n## 二、天然氣 Shock Regime\n\n| 起始 | 結束 | 峰值日 | 峰值 | 漲幅 | 持續 |\n|------|------|--------|------|------|------|\n| 2026-01-12 | 2026-01-29 | 2026-01-29 | 6.95 USD/MMBtu | +85.4% | 18 天 |\n\n**最大 z-score**: 4.2\n**最大斜率**: 2.1%/天\n\n---\n\n## 三、化肥 Spike Regime\n\n| 起始 | 結束 | 峰值日 | 峰值 | 漲幅 | 持續 |\n|------|------|--------|------|------|------|\n| 2026-01-20 | 2026-02-01 | 2026-01-31 | 420.0 USD/ton | +22.1% | 13 天 |\n\n**與天然氣 shock 的時序關係**: 化肥 spike 起點晚於天然氣 shock 起點約 8 天\n\n---\n\n## 四、領先落後分析\n\n| 指標 | 值 | 解讀 |\n|------|-----|------|\n| 最佳 Lag | 12 天 | 天然氣領先化肥 |\n| 相關係數 | 0.41 | 中度相關 |\n| 合理範圍 | 7-56 天 | ✓ 在範圍內 |\n\n**方法**: corr_returns（報酬率交叉相關）\n\n---\n\n## 五、敘事評估\n\n### 結論\n\n三段式因果檢驗通過，「天然氣暴漲→化肥飆價」的敘事在時間序列上有量化支撐。\n\n### 支持證據\n\n- 天然氣在樣本末端出現明顯 shock regime（z-score 達 4.2）\n- 化肥在天然氣 shock 後約 8 天開始上漲\n- 交叉相關顯示 gas 領先 fert 約 12 天，在合理傳導期內\n\n### 替代解釋\n\n- 化肥 spike 可能還受其他因素影響（運費、需求、政策）\n- 相關係數 0.41 為中度，部分變異來自其他驅動因素\n- 僅憑價格無法證明 force majeure/毀約\n\n---\n\n## 六、注意事項\n\n- 數據來源為 TradingEconomics，可能與交易所官方數據有差異\n- 日頻數據可能有缺失，已使用 forward-fill 處理\n- 相關不代表因果，需配合機制分析\n- 本分析不構成任何投資建議\n\n---\n\n## 七、下一步建議\n\n- 若需驗證具體公司行為，應查閱該公司公告與新聞\n- 可擴展分析其他化肥種類（DAP、磷肥）\n- 可使用不同地區天然氣（歐洲 TTF）重複驗證\n\n---\n\n*報告由 analyze-gas-fertilizer-contract-shock v0.1.0 自動生成*\n*數據來源: TradingEconomics | 分析時間: 2026-01-28T10:30:00Z*\n```\n",
        "skills/analyze-gas-fertilizer-contract-shock/workflows/analyze.md": "# Workflow: 完整三段式因果分析\n\n<required_reading>\n**執行前請閱讀：**\n1. references/data-sources.md - Chrome CDP 爬蟲說明\n2. references/methodology.md - Shock 偵測與領先落後方法論\n3. references/input-schema.md - 完整參數定義\n</required_reading>\n\n<process>\n\n## Step 1: 數據準備\n\n### 1.1 確認參數\n\n收集用戶輸入或使用預設值：\n\n```python\nparams = {\n    \"start_date\": \"2025-08-01\",        # 分析起始日\n    \"end_date\": \"2026-02-01\",          # 分析結束日\n    \"freq\": \"1D\",                       # 日頻\n    \"te_symbols\": {\n        \"natural_gas\": \"natural-gas\",   # TradingEconomics slug\n        \"fertilizer\": \"urea\"            # urea / dap / fertilizers\n    },\n    \"spike_detection\": {\n        \"return_window\": 1,\n        \"z_window\": 60,\n        \"parabolic_threshold\": {\"z\": 3.0, \"slope_pct_per_day\": 1.5}\n    },\n    \"lead_lag\": {\n        \"max_lag_days\": 60,\n        \"method\": \"corr_returns\"\n    }\n}\n```\n\n### 1.2 啟動 Chrome CDP 並抓取數據\n\n**Step 1：關閉所有 Chrome 視窗**\n\n確保沒有其他 Chrome 實例在執行，否則調試端口會無法啟動。\n\n**Step 2：啟動 Chrome 調試模式**\n\n```bash\n# Windows\n\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" ^\n  --remote-debugging-port=9222 ^\n  --remote-allow-origins=* ^\n  --user-data-dir=\"%USERPROFILE%\\.chrome-debug-profile\" ^\n  \"https://tradingeconomics.com/commodity/natural-gas\"\n\n# macOS\n/Applications/Google\\ Chrome.app/Contents/MacOS/Google\\ Chrome \\\n  --remote-debugging-port=9222 \\\n  --remote-allow-origins=* \\\n  --user-data-dir=\"$HOME/.chrome-debug-profile\" \\\n  \"https://tradingeconomics.com/commodity/natural-gas\"\n```\n\n**Step 3：等待頁面載入，驗證連線**\n\n```bash\ncurl -s http://127.0.0.1:9222/json\n```\n\n成功的回應應包含 `webSocketDebuggerUrl`。\n\n**Step 4：執行爬蟲**\n\n```bash\ncd skills/analyze-gas-fertilizer-contract-shock/scripts\n\n# 抓取天然氣\npython fetch_te_data.py --symbol natural-gas --output ../data/natural_gas.csv\n\n# 切換到化肥頁面（在 Chrome 中切換或開新分頁），抓取化肥\npython fetch_te_data.py --symbol urea --output ../data/urea.csv\n```\n\n### 1.3 備援方案（若 TradingEconomics 不可用）\n\n```bash\n# 使用 FRED 抓取 Henry Hub 天然氣\npython fetch_fred_series.py --series DHHNGSP --start 2025-08-01 --end 2026-02-01\n\n# 使用 World Bank Pink Sheet（月頻，需手動下載）\n# https://www.worldbank.org/en/research/commodity-markets\n```\n\n---\n\n## Step 2: 數據處理與 Shock 偵測\n\n### 2.1 執行主分析腳本\n\n```bash\npython gas_fertilizer_analyzer.py \\\n  --gas-file ../data/natural_gas.csv \\\n  --fert-file ../data/urea.csv \\\n  --start 2025-08-01 \\\n  --end 2026-02-01 \\\n  --z-window 60 \\\n  --z-threshold 3.0 \\\n  --slope-threshold 1.5 \\\n  --output ../data/analysis_result.json\n```\n\n### 2.2 分析邏輯說明\n\n腳本執行以下步驟：\n\n**A. 資料對齊**\n```python\n# 合併兩個時間序列到共同交易日\nmerged = gas_df.merge(fert_df, on=\"date\", how=\"outer\").sort_values(\"date\")\nmerged = merged.ffill()  # forward-fill 缺值\n```\n\n**B. 計算報酬率**\n```python\nmerged[\"gas_ret\"] = merged[\"gas\"].pct_change(return_window)\nmerged[\"fert_ret\"] = merged[\"fert\"].pct_change(return_window)\n```\n\n**C. Rolling z-score**\n```python\nmerged[\"gas_z\"] = (merged[\"gas_ret\"] - merged[\"gas_ret\"].rolling(z_window).mean()) \\\n                / merged[\"gas_ret\"].rolling(z_window).std()\n```\n\n**D. 斜率代理**\n```python\nk = 20\nmerged[\"gas_slope\"] = (merged[\"gas\"] / merged[\"gas\"].shift(k) - 1) / k\n```\n\n**E. Shock 偵測**\n```python\nmerged[\"gas_shock\"] = (merged[\"gas_z\"] >= z_threshold) | (merged[\"gas_slope\"] >= slope_threshold)\nmerged[\"fert_spike\"] = (merged[\"fert_z\"] >= z_threshold) | (merged[\"fert_slope\"] >= slope_threshold)\n```\n\n**F. Regime 合併**\n```python\ngas_regimes = compress_boolean_to_regimes(merged, \"gas_shock\", value_col=\"gas\")\nfert_regimes = compress_boolean_to_regimes(merged, \"fert_spike\", value_col=\"fert\")\n```\n\n---\n\n## Step 3: 領先落後分析\n\n### 3.1 Cross-Correlation\n\n```python\nfrom scipy import signal\n\n# 計算報酬率的交叉相關\ncorr = signal.correlate(gas_ret.dropna(), fert_ret.dropna(), mode='full')\nlags = signal.correlation_lags(len(gas_ret.dropna()), len(fert_ret.dropna()), mode='full')\n\n# 找最大相關的 lag\nbest_idx = np.argmax(np.abs(corr))\nbest_lag = lags[best_idx]\nbest_corr = corr[best_idx]\n```\n\n### 3.2 解讀 lag 值\n\n| best_lag | 意義 |\n|----------|------|\n| > 0 | 天然氣領先化肥（符合敘事） |\n| ≈ 0 | 同時變動（共同驅動） |\n| < 0 | 化肥領先天然氣（敘事較弱） |\n\n---\n\n## Step 4: 三段式因果檢驗\n\n### 4.1 A 段檢驗：Gas Shock 存在？\n\n```python\nA_pass = len(gas_regimes) > 0\nif A_pass:\n    A_info = {\n        \"regime_count\": len(gas_regimes),\n        \"max_return_pct\": max(r[\"regime_return_pct\"] for r in gas_regimes),\n        \"total_days\": sum(r[\"duration_days\"] for r in gas_regimes)\n    }\n```\n\n### 4.2 B 段檢驗：Fert Spike 在 A 段之後？\n\n```python\nB_pass = False\nfor fert_r in fert_regimes:\n    for gas_r in gas_regimes:\n        # 化肥 spike 起點晚於天然氣 shock 起點\n        if fert_r[\"start\"] > gas_r[\"start\"]:\n            B_pass = True\n            break\n```\n\n### 4.3 C 段檢驗：Lead-Lag 支持因果？\n\n```python\n# 合理領先期：1-8 週\nC_pass = (best_lag > 0) and (7 <= best_lag <= 56)\nC_info = {\n    \"best_lag_days\": best_lag,\n    \"best_corr\": best_corr,\n    \"in_reasonable_range\": C_pass\n}\n```\n\n### 4.4 綜合判斷\n\n```python\nif A_pass and B_pass and C_pass:\n    signal = \"narrative_supported\"\n    confidence = \"high\" if best_corr > 0.5 else \"medium\"\nelif A_pass and B_pass:\n    signal = \"narrative_supported\"\n    confidence = \"low\"  # lead-lag 不完全支持\nelif A_pass:\n    signal = \"narrative_weak\"\n    confidence = \"low\"\nelse:\n    signal = \"inconclusive\"\n    confidence = \"low\"\n```\n\n---\n\n## Step 5: 生成報告\n\n### 5.1 JSON 輸出\n\n```bash\n# 結果已在 Step 2 輸出到 analysis_result.json\ncat ../data/analysis_result.json\n```\n\n### 5.2 視覺化\n\n```bash\npython visualize_shock_regimes.py \\\n  --data ../data/analysis_result.json \\\n  --output ../../output/gas_fert_shock_$(date +%Y-%m-%d).png\n```\n\n### 5.3 Markdown 報告\n\n根據 `templates/output-markdown.md` 模板生成人類可讀報告。\n\n---\n\n## Step 6: 替代解釋提示\n\n根據分析結果，提供替代解釋：\n\n| 情況 | 替代解釋 |\n|------|----------|\n| Gas 大漲但 Fert 不動 | 肥價由其他因素主導（運費、需求、政策） |\n| Fert 先動 | 供需/政策先改變，Gas 只是後續共振 |\n| 兩者同時動 | 共同驅動（能源成本、地緣政治） |\n\n</process>\n\n<success_criteria>\nWorkflow 完成時應有：\n\n- [ ] Chrome CDP 連線成功驗證\n- [ ] 天然氣與化肥數據已抓取並對齊\n- [ ] Gas shock regimes 已偵測並記錄\n- [ ] Fert spike regimes 已偵測並記錄\n- [ ] 領先落後相關分析完成\n- [ ] 三段式因果檢驗結論明確\n- [ ] JSON 結果已輸出\n- [ ] 視覺化圖表已生成\n- [ ] 替代解釋已提供（若敘事不成立）\n</success_criteria>\n\n<troubleshooting>\n\n### 常見問題\n\n**Q1: 無法連接到 Chrome 調試端口**\n1. 確保所有 Chrome 視窗都已關閉\n2. 確認使用了非預設的 `--user-data-dir`\n3. 檢查端口 9222：`curl -s http://127.0.0.1:9222/json`\n\n**Q2: WebSocket 連線被拒絕 (403 Forbidden)**\n確認啟動 Chrome 時有加上 `--remote-allow-origins=*` 參數。\n\n**Q3: Highcharts not found**\n1. 確認頁面已完全載入（圖表已顯示）\n2. 在瀏覽器 Console 中執行 `typeof Highcharts` 確認\n3. 頁面可能仍在載入，等待幾秒後再試\n\n**Q4: 被 Cloudflare 擋住**\n1. 在 Chrome 中手動完成 Cloudflare 驗證\n2. 登入 TradingEconomics 帳號後再執行\n\n</troubleshooting>\n",
        "skills/analyze-gas-fertilizer-contract-shock/workflows/hedge-hypothesis.md": "# Workflow: 合約對沖假說分析\n\n<required_reading>\n**執行前請閱讀：**\n1. references/methodology.md - 了解 hedge_pnl_proxy 的定義\n</required_reading>\n\n<overview>\n當新聞提到「公司以低價合約鎖定天然氣，現在市價暴漲賺翻」時，\n本 workflow 計算一個**價差壓力指標**，量化這個敘事的可信度。\n\n**重要提醒**：這不是公司真實 PnL，只是把敘事轉成可量化的 proxy。\n</overview>\n\n<process>\n\n## Step 1: 收集合約假說參數\n\n詢問用戶或從新聞中提取：\n\n```python\nhedge_hypothesis = {\n    \"gas_contract_price\": 0.80,     # 新聞宣稱的合約價格\n    \"gas_contract_unit\": \"USD/MMBtu\",\n    \"profit_proxy_mode\": \"spot_minus_contract\"\n}\n```\n\n---\n\n## Step 2: 計算 Hedge PnL Proxy\n\n### 2.1 基本計算\n\n```python\n# 取得天然氣現貨/近月價格\ngas_spot = merged[\"gas\"]  # 從 TradingEconomics 抓取\n\n# 計算每日的「價差收益代理」\ncontract_price = hedge_hypothesis[\"gas_contract_price\"]\nmerged[\"hedge_pnl_proxy\"] = (gas_spot - contract_price).clip(lower=0)\n```\n\n### 2.2 解讀\n\n- `hedge_pnl_proxy > 0`：現貨高於合約，理論上「賺錢」\n- `hedge_pnl_proxy = 0`：現貨低於合約，無套利空間\n\n---\n\n## Step 3: 生成 Hedge Regime\n\n### 3.1 識別高價差區間\n\n```python\n# 當 hedge_pnl_proxy 超過某閾值，標記為 hedge_active\nthreshold = contract_price * 0.5  # 價差超過合約價 50%\nmerged[\"hedge_active\"] = merged[\"hedge_pnl_proxy\"] > threshold\n\n# 合併為 regime\nhedge_regimes = compress_boolean_to_regimes(merged, \"hedge_active\", value_col=\"hedge_pnl_proxy\")\n```\n\n### 3.2 與 Fert Spike 對比\n\n```python\n# 檢查 hedge regime 是否與 fert spike 在時間上重疊或接續\nfor hedge_r in hedge_regimes:\n    for fert_r in fert_regimes:\n        if overlaps_or_follows(hedge_r, fert_r):\n            # 敘事支持：天然氣價差壓力期間，化肥也在漲\n            narrative_support = True\n```\n\n---\n\n## Step 4: 輸出報告\n\n```json\n{\n  \"hedge_hypothesis\": {\n    \"contract_price\": 0.80,\n    \"unit\": \"USD/MMBtu\",\n    \"interpretation\": \"價格層面的價差壓力指標（非真實公司PnL）\"\n  },\n  \"hedge_pnl_proxy_stats\": {\n    \"peak_value\": 6.15,\n    \"peak_date\": \"2026-01-29\",\n    \"mean_during_shock\": 4.2,\n    \"days_above_threshold\": 18\n  },\n  \"hedge_fert_alignment\": {\n    \"overlap_days\": 12,\n    \"interpretation\": \"hedge regime 與 fert spike 有明顯重疊，敘事有數據支撐\"\n  },\n  \"caveats\": [\n    \"這是價格層面的 proxy，不代表任何特定公司的真實損益\",\n    \"實際對沖還涉及合約量、到期日、counterparty 等因素\",\n    \"不能用此結論斷言任何公司的 force majeure 行為\"\n  ]\n}\n```\n\n---\n\n## Step 5: 視覺化\n\n```bash\npython visualize_hedge_proxy.py \\\n  --data ../data/analysis_result.json \\\n  --contract-price 0.80 \\\n  --output ../../output/hedge_proxy_$(date +%Y-%m-%d).png\n```\n\n圖表包含：\n- 天然氣現貨價格（實線）\n- 合約價格（水平虛線）\n- Hedge PnL Proxy（填充區域）\n- Fert 價格（次軸）\n\n</process>\n\n<success_criteria>\nWorkflow 完成時應有：\n\n- [ ] 合約假說參數已確認\n- [ ] Hedge PnL Proxy 時間序列已計算\n- [ ] Peak proxy 值與日期\n- [ ] 與 Fert Spike 的時序對比\n- [ ] 明確的 caveats（這不是真實 PnL）\n- [ ] 視覺化圖表\n</success_criteria>\n\n<important_disclaimer>\n**重要聲明**\n\nHedge PnL Proxy 只是一個「把新聞敘事轉成可量化指標」的工具。\n\n**它不代表**：\n- 任何特定公司的真實損益\n- Force majeure 是否發生\n- 合約是否被毀約\n\n**它只能說明**：\n- 如果某公司真的以 X 價格鎖定天然氣\n- 且現貨價格如數據所示\n- 那麼「價差壓力」的量級是多少\n\n請在報告中明確標註這些限制。\n</important_disclaimer>\n",
        "skills/analyze-gas-fertilizer-contract-shock/workflows/quick-check.md": "# Workflow: 快速檢查（全自動）\n\n<required_reading>\n無需額外閱讀，直接執行。\n</required_reading>\n\n<process>\n\n## Step 1: 全自動抓取數據\n\n腳本會自動啟動 Chrome、抓取數據、關閉 Chrome，無需手動操作。\n\n### 1.1 如果有快取數據（12 小時內）\n\n```bash\ncd scripts\n# 直接執行分析（會使用快取）\npython gas_fertilizer_analyzer.py \\\n  --gas-file ../data/cache/natural-gas.csv \\\n  --fert-file ../data/cache/urea.csv \\\n  --output ../data/analysis_result.json\n```\n\n### 1.2 如果需要更新數據\n\n```bash\ncd scripts\n\n# 全自動抓取（自動啟動/關閉 Chrome，約 60 秒）\npython fetch_te_data.py --symbol natural-gas --symbol urea\n\n# 執行分析\npython gas_fertilizer_analyzer.py \\\n  --gas-file ../data/cache/natural-gas.csv \\\n  --fert-file ../data/cache/urea.csv \\\n  --output ../data/analysis_result.json\n```\n\n### 1.3 強制更新（忽略快取）\n\n```bash\npython fetch_te_data.py --symbol natural-gas --symbol urea --force-refresh\n```\n\n---\n\n## Step 2: 解讀分析結果\n\n分析完成後會顯示：\n\n```\n分析完成！結果已儲存至: ../data/analysis_result.json\nSignal: narrative_supported (Confidence: medium)\n```\n\n### Signal 解讀\n\n| Signal | Confidence | 含義 |\n|--------|------------|------|\n| `narrative_supported` | `high` | 強力支持「天然氣暴漲→化肥飆價」敘事 |\n| `narrative_supported` | `medium` | 數據支持敘事，但相關性偏低 |\n| `narrative_weak` | `low` | 敘事較弱，化肥未明顯跟隨 |\n| `inconclusive` | `low` | 數據不足以判斷 |\n\n---\n\n## Step 3: 生成視覺化圖表（Bloomberg 風格）\n\n```bash\npython visualize_shock_regimes.py\n```\n\n**輸出**：`output/gas_fert_shock_YYYY-MM-DD.png`\n\n圖表包含：\n- 上圖：天然氣價格 + shock regimes（紅色標記）\n- 下圖：化肥價格 + spike regimes（黃色標記）\n- 標題顯示 signal、confidence、lead-lag 天數\n\n---\n\n## Step 4: 快速判斷\n\n```\n如果 signal == narrative_supported 且 best_lag > 0：\n  → 天然氣暴漲可能傳導至化肥，預期滯後 best_lag 天\n\n如果 signal == narrative_weak：\n  → 化肥價格可能受其他因素主導（庫存、需求、政策）\n\n如果 signal == inconclusive：\n  → 數據範圍不足，建議擴大時間範圍重新分析\n```\n\n---\n\n## Step 5: 決定下一步\n\n**若 signal 為 `narrative_supported`**：\n1. 查看詳細的 JSON 報告（`../data/analysis_result.json`）\n2. 關注 lead_lag 天數，預判化肥價格反應時間點\n3. 考慮對農業/肥料相關資產的配置調整\n\n**若 signal 為 `narrative_weak`**：\n1. 調查其他可能的化肥驅動因素\n2. 設定監控頻率（每週檢查）\n3. 關注其他商品傳導路徑\n\n</process>\n\n<success_criteria>\n快速檢查完成時應有：\n\n- [ ] 天然氣與化肥數據已抓取（或使用快取）\n- [ ] Signal 與 Confidence 判斷\n- [ ] Lead-lag 天數\n- [ ] Bloomberg 風格視覺化圖表\n- [ ] 下一步建議\n</success_criteria>\n\n<troubleshooting>\n\n### Chrome 啟動失敗\n\n**問題**：腳本報錯「找不到 Chrome」\n\n**解決**：\n1. 確認已安裝 Google Chrome\n2. 檢查 Chrome 路徑是否正確（預設路徑在 `fetch_te_data.py` 的 `CHROME_PATHS` 列表中）\n\n### WebSocket 連線失敗\n\n**問題**：`websocket._exceptions.WebSocketBadStatusException`\n\n**解決**：\n1. 關閉所有 Chrome 視窗後重試\n2. 如果已有 Chrome 調試實例，腳本會自動重用\n\n### Highcharts not found\n\n**問題**：提取數據時報錯 `Highcharts not found`\n\n**解決**：\n1. 頁面可能仍在載入，增加等待時間\n2. 如遇 Cloudflare 驗證，需要手動完成驗證後重試\n\n### 數據範圍太短\n\n**問題**：TradingEconomics 只返回 1 年數據\n\n**解決**：\n1. 這是 TradingEconomics 免費版的限制\n2. 對於長期分析，考慮使用 FRED 備援數據源\n\n</troubleshooting>\n",
        "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/SKILL.md": "---\nname: analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios\ndescription: 在「失業率走高／勞動市場轉弱」但「名目或實質 GDP 仍維持高位（或仍在成長）」的情境下，依據歷史關聯估算美國財政赤字占 GDP（Deficit/GDP）可能擴張的區間，並生成對長天期美債（長久期 UST）供給/利率風險的情境解讀。支援視覺化圖表輸出。\n---\n\n<essential_principles>\n\n<principle name=\"labor_gdp_divergence\">\n**勞動-GDP 背離核心邏輯**\n\n本技能聚焦於一個特殊的宏觀情境：**勞動市場明顯轉弱，但 GDP 仍處高位**。這種組合歷史上常伴隨：\n- 財政赤字/GDP 的階躍式上升（自動穩定器 + 反週期支出）\n- 長天期國債供給壓力增加\n- 期限溢酬的潛在上升\n\n關鍵洞察：「30 年歷史顯示，當 jobs 夠軟，赤字/GDP 會從 6–7% 跳到 12–17%」\n</principle>\n\n<principle name=\"slack_metric\">\n**勞動鬆緊度量 (Slack Metric)**\n\n核心度量方式：\n- **UJO** = Unemployed_Level / Job_Openings_Level（失業人數/職缺比）\n  - 能捕捉「職缺掉很快、失業還沒上來」的早期轉弱階段\n- **ΔUR** = Unemployment_Rate(t) - Unemployment_Rate(t-6M)（半年變化）\n- **薩姆規則** = 3M_MA(UR) - min(UR over last 12M)（觸發式警報，≥0.5 為衰退警示）\n\n這些指標用於定義「勞動轉弱事件」的觸發與分級（輕/中/重）。\n</principle>\n\n<principle name=\"elasticity_coefficients\">\n**彈性係數 (Elasticity Coefficients)**\n\n基於 2000-2025 年歷史回歸分析的核心經濟彈性：\n\n| 係數        | 數值      | 意涵                             |\n|-------------|-----------|----------------------------------|\n| **β_UR**    | **0.59**  | 失業率每↑1ppt → 赤字/GDP↑0.59ppt |\n| **β_UJO**   | **0.69**  | UJO每↑1 → 赤字/GDP↑0.69ppt       |\n| **β_JOLTS** | **-0.07** | 職缺每↑1M → 赤字/GDP↓0.07ppt     |\n| **Lag**     | **4Q**    | 勞動指標領先赤字約4季            |\n\n這些彈性係數用於：\n- 情境投影的定量推演\n- 驗證事件分組區間法的結果一致性\n- 敏感度分析\n\n詳細方法論見 `references/methodology.md`。\n</principle>\n\n<principle name=\"high_gdp_condition\">\n**高 GDP 條件定義**\n\n「高 GDP」量化為：\n- **GDP_level_percentile**：GDP 水平在回看期間的分位數（例如 > 70% 視為高位）\n- **GDP_growth_regime**：成長仍為正、或僅小幅趨緩\n- （進階）產出缺口/趨勢偏離\n\n只有同時滿足「勞動轉弱」+「高 GDP」條件的樣本，才納入情境分析。\n</principle>\n\n<principle name=\"three_models\">\n**三種分析模型**\n\n| 模型                    | 用途           | 輸出形式                           |\n|-------------------------|----------------|------------------------------------|\n| **event_study_banding** | 事件分組區間法 | 「12–17%」範圍型敘事，歷史事件清單 |\n| **quantile_mapping**    | 分位數映射     | 「現在落在歷史哪個角落」的條件分布 |\n| **robust_regression**   | 穩健迴歸推演   | 連續型情境路徑與區間               |\n\n預設使用 `event_study_banding`，最貼近「歷史顯示…」的敘事方式。\n</principle>\n\n<principle name=\"visualization\">\n**三軸視覺化圖表**\n\n本技能支援生成三軸圖表：\n- **左軸**：失業人數（紅色）、職缺數（藍色）— 千人\n- **右軸**：財政赤字/GDP（綠色）— 百分比\n- **標註**：歷史 crossover 事件（失業 > 職缺）及對應的赤字跳升幅度\n- **情境投影**：虛線顯示未來可能的路徑（mild/moderate/severe）\n\n圖表基於 FRED 公開數據繪製，便於追蹤勞動-財政關聯的歷史演變。\n</principle>\n\n<principle name=\"data_access\">\n**資料取得方式**\n\n本技能使用**無需 API key** 的公開資料來源：\n- **FRED CSV**: `https://fred.stlouisfed.org/graph/fredgraph.csv?id={SERIES_ID}`\n  - 勞動：UNRATE, UNEMPLOY, JTSJOL, ICSA\n  - 宏觀：GDP, GDPC1\n  - 財政：FYFSGDA188S（聯邦盈餘/赤字占 GDP）\n- **BEA**: 備用的 GDP/財政數據源\n\n腳本位於 `scripts/` 目錄，可直接執行。\n</principle>\n\n</essential_principles>\n\n<objective>\n實作「高失業 + 高 GDP」情境下的財政赤字推估：\n\n1. **建構勞動鬆緊指標**：從 FRED 數據計算 UJO、薩姆規則 等\n2. **定義背離事件**：識別「勞動轉弱 + GDP 高位」的歷史樣本\n3. **推估赤字區間**：使用三種模型估算 Deficit/GDP 的可能跳升區間\n4. **生成情境解讀**：產出對長天期 UST 的供給/利率風險解讀\n5. **視覺化輸出**：生成三軸圖表與情境投影\n\n輸出：診斷資訊、赤字區間投影、歷史事件樣本、UST 風險解讀、視覺化圖表。\n</objective>\n\n<quick_start>\n\n**最快的方式：執行預設情境分析**\n\n```bash\ncd skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios\npip install pandas numpy requests matplotlib  # 首次使用\npython scripts/analyzer.py --quick\n```\n\n**生成視覺化圖表（推薦）**：\n```bash\npython scripts/analyzer.py --visualize --scenario-type moderate\n```\n\n**或直接使用視覺化腳本**：\n```bash\npython scripts/visualizer.py --scenario moderate --years 25\n```\n\n輸出範例：\n```json\n{\n  \"skill\": \"analyze_high_unemployment_fiscal_deficit_scenarios\",\n  \"as_of\": \"2026-01-21\",\n  \"diagnostics\": {\n    \"current_slack_percentile\": 0.28,\n    \"high_gdp_condition\": true,\n    \"triggered_labor_softening\": false\n  },\n  \"deficit_gdp_projection\": {\n    \"baseline_deficit_gdp\": 0.062,\n    \"conditional_range_next_8q\": {\n      \"p25\": 0.11, \"p50\": 0.135, \"p75\": 0.16\n    },\n    \"n_episodes\": 3\n  }\n}\n```\n\n**完整情境分析 + 圖表**：\n```bash\npython scripts/analyzer.py --lookback 30 --horizon 8 --model event_study_banding --visualize --scenario-type severe --output result.json --chart-output chart.png\n```\n\n</quick_start>\n\n<intake>\n需要進行什麼操作？\n\n1. **快速診斷** - 查看目前的勞動/GDP 狀態與赤字風險判定\n2. **完整情境分析** - 執行完整的歷史事件研究與赤字區間推估\n3. **視覺化圖表** - 生成三軸圖表與情境投影\n4. **自訂情境推演** - 輸入自訂的失業衝擊情境進行推演\n5. **方法論學習** - 了解勞動-財政連結的邏輯與模型\n6. **UST 風險解讀** - 生成長天期美債的供給/利率風險報告\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                     | Action                                     |\n|------------------------------|--------------------------------------------|\n| 1, \"快速\", \"quick\", \"診斷\"   | 執行 `python scripts/analyzer.py --quick`  |\n| 2, \"完整\", \"full\", \"情境\"    | 閱讀 `workflows/analyze.md` 並執行         |\n| 3, \"視覺化\", \"圖表\", \"chart\" | 閱讀 `workflows/visualize.md` 並執行       |\n| 4, \"自訂\", \"custom\", \"推演\"  | 閱讀 `workflows/scenario.md` 並執行        |\n| 5, \"學習\", \"方法論\", \"why\"   | 閱讀 `references/methodology.md`           |\n| 6, \"UST\", \"美債\", \"利率\"     | 閱讀 `workflows/ust-risk.md` 並執行        |\n| 提供參數 (如 lookback_years) | 閱讀 `workflows/analyze.md` 並使用參數執行 |\n\n**路由後，閱讀對應文件並執行。**\n</routing>\n\n<directory_structure>\n```\nanalyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元數據\n├── workflows/\n│   ├── analyze.md                     # 完整情境分析工作流\n│   ├── visualize.md                   # 視覺化圖表工作流\n│   ├── scenario.md                    # 自訂情境推演工作流\n│   └── ust-risk.md                    # UST 風險解讀工作流\n├── references/\n│   ├── data-sources.md                # FRED 系列代碼與資料來源\n│   ├── methodology.md                 # 勞動-財政連結方法論\n│   └── input-schema.md                # 完整輸入參數定義\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n├── scripts/\n│   ├── analyzer.py                    # 主分析腳本（含視覺化整合）\n│   ├── visualizer.py                  # 視覺化專用腳本\n│   └── fetch_data.py                  # 數據抓取工具\n└── output/                            # 圖表輸出目錄\n    └── (generated charts)\n```\n</directory_structure>\n\n<reference_index>\n\n**方法論**: references/methodology.md\n- 勞動-財政連結邏輯\n- 三種分析模型詳解\n- 事件分組與門檻定義\n\n**資料來源**: references/data-sources.md\n- FRED 系列代碼（勞動/GDP/財政）\n- 數據頻率與對齊方法\n\n**輸入參數**: references/input-schema.md\n- 完整參數定義\n- 預設值與建議範圍\n\n</reference_index>\n\n<workflows_index>\n| Workflow     | Purpose      | 使用時機           |\n|--------------|--------------|--------------------|\n| analyze.md   | 完整情境分析 | 需要歷史事件研究時 |\n| visualize.md | 視覺化圖表   | 需要生成圖表時     |\n| scenario.md  | 自訂情境推演 | 輸入自訂失業衝擊時 |\n| ust-risk.md  | UST 風險解讀 | 需要債市風險報告時 |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構定義 |\n| output-markdown.md | Markdown 報告模板 |\n</templates_index>\n\n<scripts_index>\n| Script        | Command                                | Purpose            |\n|---------------|----------------------------------------|--------------------|\n| analyzer.py   | `--quick`                              | 快速診斷當前狀態   |\n| analyzer.py   | `--lookback 30 --horizon 8`            | 完整情境分析       |\n| analyzer.py   | `--visualize --scenario-type moderate` | 分析 + 視覺化圖表  |\n| visualizer.py | `--scenario moderate --years 25`       | 單獨生成視覺化圖表 |\n| visualizer.py | `--scenario severe --output chart.png` | 指定輸出路徑       |\n| fetch_data.py | `--series UNRATE,JTSJOL,GDP`           | 抓取 FRED 資料     |\n</scripts_index>\n\n<input_schema_summary>\n\n**核心參數**\n\n| 參數             | 類型   | 預設值              | 說明       |\n|------------------|--------|---------------------|------------|\n| country          | string | US                  | 國家代碼   |\n| lookback_years   | int    | 30                  | 回看年數   |\n| frequency        | string | quarterly           | 資料頻率   |\n| horizon_quarters | int    | 8                   | 推演季度數 |\n| model            | string | event_study_banding | 分析模型   |\n| output_format    | string | json                | 輸出格式   |\n\n**勞動指標設定**\n\n| 參數             | 類型   | 預設值                           | 說明          |\n|------------------|--------|----------------------------------|---------------|\n| use_jolts        | bool   | true                             | 使用 JOLTS    |\n| use_unemployment | bool   | true                             | 使用失業率    |\n| use_sahm_rule    | bool   | true                             | 計算 薩姆規則 |\n| slack_metric     | string | unemployed_to_job_openings_ratio | 鬆緊度量      |\n\n**視覺化參數**\n\n| 參數          | 類型   | 預設值   | 說明                            |\n|---------------|--------|----------|---------------------------------|\n| visualize     | bool   | false    | 是否生成視覺化圖表              |\n| scenario_type | string | moderate | 情境類型 (mild/moderate/severe) |\n| chart_output  | string | auto     | 圖表輸出路徑                    |\n| no_show       | bool   | false    | 不顯示圖表（僅保存）            |\n\n**情境假設**\n\n| 參數               | 類型   | 預設值              | 說明         |\n|--------------------|--------|---------------------|--------------|\n| gdp_path           | string | high_gdp_sticky     | GDP 路徑假設 |\n| unemployment_shock | object | {type, size, speed} | 失業衝擊設定 |\n\n完整參數定義見 `references/input-schema.md`。\n\n</input_schema_summary>\n\n<output_schema_summary>\n```json\n{\n  \"skill\": \"analyze_high_unemployment_fiscal_deficit_scenarios\",\n  \"inputs\": {\n    \"country\": \"US\",\n    \"lookback_years\": 30,\n    \"slack_metric\": \"unemployed_to_job_openings_ratio\",\n    \"model\": \"event_study_banding\"\n  },\n  \"diagnostics\": {\n    \"current_slack_percentile\": 0.28,\n    \"high_gdp_condition\": true,\n    \"triggered_labor_softening\": false\n  },\n  \"elasticity_model\": {\n    \"parameters\": {\n      \"beta_ur\": 0.59,\n      \"beta_ujo\": 0.69,\n      \"beta_jolts\": -0.07,\n      \"lag_quarters\": 4\n    },\n    \"interpretation\": {\n      \"ur_effect\": \"每 1ppt 失業率上升 → 赤字/GDP 上升 0.59 ppt\",\n      \"ujo_effect\": \"UJO 每上升 1 → 赤字/GDP 上升 0.69 ppt\",\n      \"lag_effect\": \"勞動指標領先赤字約 4 季\"\n    },\n    \"conditional_means\": {\n      \"deficit_when_loose\": 5.6,\n      \"deficit_when_tight\": 5.2\n    }\n  },\n  \"deficit_gdp_projection\": {\n    \"baseline_deficit_gdp\": 0.062,\n    \"conditional_range_next_8q\": {\n      \"p25\": 0.11, \"p50\": 0.135, \"p75\": 0.16, \"min\": 0.095, \"max\": 0.175\n    },\n    \"n_episodes\": 3,\n    \"episode_years\": [\"2001-2003\", \"2008-2010\", \"2020-2021\"]\n  },\n  \"interpretation\": {\n    \"macro_story\": \"...\",\n    \"ust_duration_implications\": [...],\n    \"watchlist_switch_indicators\": [...]\n  },\n  \"visualization\": {\n    \"chart_path\": \"output/fiscal_deficit_scenario_20260121.png\",\n    \"scenario_type\": \"moderate\",\n    \"projected_deficit_jump_bps\": 600\n  }\n}\n```\n\n完整輸出結構見 `templates/output-json.md`。\n</output_schema_summary>\n\n<success_criteria>\n執行成功時應產出：\n\n**數據分析**\n- [ ] 當前勞動鬆緊狀態（分位數、是否觸發轉弱）\n- [ ] 高 GDP 條件判定結果\n- [ ] Deficit/GDP 的條件分布區間（p25/p50/p75）\n- [ ] 歷史樣本事件清單（年份、指標數值）\n- [ ] UST 供給壓力通道解讀\n- [ ] 風險偏好通道解讀（避險 vs 供給兩股力量）\n- [ ] 監控切換指標清單\n- [ ] 診斷資訊（當前指標數值）\n\n**視覺化（若啟用）**\n- [ ] 三軸圖表（職缺/失業/赤字GDP）\n- [ ] 歷史 crossover 事件標註\n- [ ] 情境投影虛線（mild/moderate/severe）\n- [ ] 衰退期灰色陰影\n- [ ] JSON 摘要檔案\n</success_criteria>\n",
        "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/references/data-sources.md": "<overview>\n本文件定義技能使用的所有 FRED 數據系列代碼、頻率、轉換方式，以及數據抓取的技術細節。\n</overview>\n\n<fred_series>\n\n<category name=\"labor_market\">\n**勞動市場指標**\n\n| Series ID | 名稱                         | 頻率 | 單位 | 轉換  | 說明          |\n|-----------|------------------------------|------|------|-------|---------------|\n| UNRATE    | Unemployment Rate            | 月   | %    | level | 失業率（U-3） |\n| UNEMPLOY  | Unemployed Level             | 月   | 千人 | level | 失業人數      |\n| JTSJOL    | Job Openings: Total Nonfarm  | 月   | 千人 | level | JOLTS 職缺數  |\n| ICSA      | Initial Claims               | 週   | 人   | 4w_ma | 初領失業救濟  |\n| PAYEMS    | All Employees: Total Nonfarm | 月   | 千人 | yoy   | 非農就業      |\n| U6RATE    | U-6 Unemployment Rate        | 月   | %    | level | 廣義失業率    |\n\n**關鍵衍生指標**：\n- **UJO** = UNEMPLOY / JTSJOL（失業/職缺比）\n- **薩姆規則** = 3M_MA(UNRATE) - 12M_MIN(UNRATE)\n- **ΔUR** = UNRATE(t) - UNRATE(t-6M)\n</category>\n\n<category name=\"gdp_macro\">\n**GDP 與宏觀指標**\n\n| Series ID       | 名稱                   | 頻率 | 單位                  | 轉換  | 說明            |\n|-----------------|------------------------|------|-----------------------|-------|-----------------|\n| GDP             | Gross Domestic Product | 季   | 十億美元              | level | 名目 GDP        |\n| GDPC1           | Real GDP               | 季   | 十億美元（2017 鏈價） | level | 實質 GDP        |\n| A191RL1Q225SBEA | Real GDP Growth        | 季   | % SAAR                | level | 實質 GDP 成長率 |\n| CPIAUCSL        | CPI: All Items         | 月   | 指數                  | yoy   | 消費者物價指數  |\n| GDPDEF          | GDP Deflator           | 季   | 指數                  | yoy   | GDP 平減指數    |\n\n**高 GDP 條件判定**：\n- GDP_pctl > 70%（GDP 水平在 30 年歷史的 70 分位以上）\n- 或 GDP_growth > 0（實質 GDP 仍正成長）\n</category>\n\n<category name=\"fiscal\">\n**財政指標**\n\n| Series ID   | 名稱                                | 頻率 | 單位     | 轉換  | 說明                |\n|-------------|-------------------------------------|------|----------|-------|---------------------|\n| FYFSGDA188S | Federal Surplus/Deficit as % of GDP | 年   | %        | level | 聯邦盈餘/赤字占 GDP |\n| FGEXPND     | Federal Government Expenditures     | 季   | 十億美元 | level | 聯邦支出            |\n| FGRECPT     | Federal Government Receipts         | 季   | 十億美元 | level | 聯邦收入            |\n| GFDEBTN     | Federal Debt: Total Public Debt     | 季   | 百萬美元 | level | 聯邦總債務          |\n| GFDEGDQ188S | Federal Debt as % of GDP            | 季   | %        | level | 債務/GDP            |\n\n**注意**：FYFSGDA188S 為負值時表示赤字（例如 -6.5 表示赤字占 GDP 6.5%）。\n在分析中，我們通常取絕對值或乘以 -1 使赤字為正數。\n</category>\n\n<category name=\"financial_stress\">\n**金融壓力指標（用於 UST 風險分析）**\n\n| Series ID    | 名稱                                      | 頻率 | 說明           |\n|--------------|-------------------------------------------|------|----------------|\n| BAMLC0A0CM   | ICE BofA US Corporate Master OAS          | 日   | 投資級信用利差 |\n| BAMLH0A0HYM2 | ICE BofA US High Yield OAS                | 日   | 高收益債利差   |\n| T10Y2Y       | 10Y-2Y Treasury Spread                    | 日   | 殖利率曲線     |\n| DGS10        | 10-Year Treasury Rate                     | 日   | 10 年期殖利率  |\n| VIXCLS       | VIX                                       | 日   | 波動率指數     |\n| NFCI         | Chicago Fed National Financial Conditions | 週   | 金融壓力指數   |\n</category>\n\n</fred_series>\n\n<data_fetching>\n\n<method name=\"csv_endpoint\">\n**FRED CSV 端點（無需 API key）**\n\n```python\nimport pandas as pd\nfrom io import StringIO\nimport requests\n\ndef fetch_fred_csv(series_id: str, start_date: str = None) -> pd.Series:\n    \"\"\"\n    從 FRED CSV 端點抓取數據（無需 API key）\n\n    Parameters\n    ----------\n    series_id : str\n        FRED 系列代碼\n    start_date : str, optional\n        起始日期 (YYYY-MM-DD)\n\n    Returns\n    -------\n    pd.Series\n        時間序列數據\n    \"\"\"\n    url = f\"https://fred.stlouisfed.org/graph/fredgraph.csv?id={series_id}\"\n\n    if start_date:\n        url += f\"&cosd={start_date}\"\n\n    response = requests.get(url, timeout=30)\n    response.raise_for_status()\n\n    df = pd.read_csv(StringIO(response.text), parse_dates=['DATE'], index_col='DATE')\n    series = df[series_id].replace('.', pd.NA).astype(float)\n\n    return series\n\n\ndef fetch_multiple_series(series_ids: list, years: int = 30) -> pd.DataFrame:\n    \"\"\"\n    批量抓取多個 FRED 系列\n    \"\"\"\n    from datetime import datetime, timedelta\n\n    start_date = (datetime.now() - timedelta(days=years*365)).strftime('%Y-%m-%d')\n\n    data = {}\n    for sid in series_ids:\n        try:\n            data[sid] = fetch_fred_csv(sid, start_date)\n            print(f\"✓ {sid}\")\n        except Exception as e:\n            print(f\"✗ {sid}: {e}\")\n\n    return pd.DataFrame(data)\n```\n</method>\n\n<method name=\"frequency_alignment\">\n**頻率對齊**\n\n多數財政/GDP 數據為季頻，勞動數據為月頻。需要對齊處理：\n\n```python\ndef align_to_quarterly(data: pd.DataFrame, method: str = 'quarter_end') -> pd.DataFrame:\n    \"\"\"\n    將數據對齊到季度頻率\n\n    Parameters\n    ----------\n    data : pd.DataFrame\n        原始數據（可能包含不同頻率）\n    method : str\n        'quarter_end' - 取季末值\n        'quarter_avg' - 取季度平均\n\n    Returns\n    -------\n    pd.DataFrame\n        季度頻率數據\n    \"\"\"\n    if method == 'quarter_end':\n        return data.resample('QE').last()\n    elif method == 'quarter_avg':\n        return data.resample('QE').mean()\n    else:\n        raise ValueError(f\"Unknown method: {method}\")\n```\n</method>\n\n<method name=\"caching\">\n**快取策略**\n\n建議使用本地快取減少重複請求：\n\n```python\nfrom pathlib import Path\nimport json\nfrom datetime import datetime, timedelta\n\nCACHE_DIR = Path('data/cache')\nCACHE_MAX_AGE_HOURS = 12\n\ndef get_cached_data(series_id: str) -> pd.Series:\n    \"\"\"嘗試從快取讀取\"\"\"\n    cache_file = CACHE_DIR / f\"{series_id}.csv\"\n\n    if cache_file.exists():\n        mtime = datetime.fromtimestamp(cache_file.stat().st_mtime)\n        if datetime.now() - mtime < timedelta(hours=CACHE_MAX_AGE_HOURS):\n            return pd.read_csv(cache_file, index_col=0, parse_dates=True).squeeze()\n\n    return None\n\ndef save_to_cache(series_id: str, data: pd.Series):\n    \"\"\"保存到快取\"\"\"\n    CACHE_DIR.mkdir(parents=True, exist_ok=True)\n    data.to_csv(CACHE_DIR / f\"{series_id}.csv\")\n```\n</method>\n\n</data_fetching>\n\n<data_quality>\n\n<validation>\n**數據驗證檢查**\n\n抓取數據後應進行以下檢查：\n\n1. **缺失值檢查**：\n   ```python\n   missing_pct = data.isna().sum() / len(data) * 100\n   assert missing_pct < 10, f\"Missing values too high: {missing_pct:.1f}%\"\n   ```\n\n2. **時間範圍檢查**：\n   ```python\n   assert data.index.min().year <= start_year\n   assert data.index.max() >= pd.Timestamp.now() - pd.Timedelta(days=90)\n   ```\n\n3. **數值範圍檢查**：\n   ```python\n   # 失業率應在 0-30% 之間\n   assert 0 <= data['UNRATE'].min() and data['UNRATE'].max() <= 30\n   # 赤字/GDP 應在 -30% 到 +10% 之間\n   assert -30 <= data['FYFSGDA188S'].min() and data['FYFSGDA188S'].max() <= 10\n   ```\n</validation>\n\n<known_issues>\n**已知問題**\n\n| 系列        | 問題              | 處理方式               |\n|-------------|-------------------|------------------------|\n| JTSJOL      | 2000 年以前無數據 | UJO 分析從 2001 年開始 |\n| FYFSGDA188S | 年頻數據          | 需轉換或使用季頻替代   |\n| ICSA        | 週頻高頻噪音      | 使用 4 週移動平均      |\n</known_issues>\n\n</data_quality>\n\n<update_frequency>\n**數據更新時間表**\n\n| 數據類型           | 發布頻率 | 發布延遲 | 最佳抓取時機     |\n|--------------------|----------|----------|------------------|\n| 失業率 (UNRATE)    | 月       | ~5 天    | 每月第一個週五後 |\n| JOLTS (JTSJOL)     | 月       | ~2 個月  | 每月中旬         |\n| GDP                | 季       | ~1 個月  | 季末月底         |\n| 財政 (FYFSGDA188S) | 年       | ~3 個月  | 年初更新         |\n\n**建議**：每天最多抓取一次，快取有效期設為 12 小時。\n</update_frequency>\n",
        "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/references/input-schema.md": "<overview>\n本文件定義技能的完整輸入參數，包含參數類型、預設值、有效範圍與說明。\n</overview>\n\n<core_parameters>\n\n<parameter name=\"country\">\n**country**\n- **類型**: string\n- **預設值**: `\"US\"`\n- **有效值**: `[\"US\"]`（目前僅支援美國）\n- **說明**: 國家代碼。本技能目前僅支援美國數據，因為所使用的 FRED 系列專屬於美國。\n</parameter>\n\n<parameter name=\"lookback_years\">\n**lookback_years**\n- **類型**: int\n- **預設值**: `30`\n- **有效範圍**: `10-50`\n- **說明**: 回看年數，用於建立歷史分布與識別事件樣本。建議使用 30 年以涵蓋多個經濟週期。\n\n| 設定 | 樣本涵蓋 | 事件數 |\n|------|----------|--------|\n| 20   | 2006-今  | ~4     |\n| 30   | 1996-今  | ~6     |\n| 40   | 1986-今  | ~8     |\n</parameter>\n\n<parameter name=\"frequency\">\n**frequency**\n- **類型**: string\n- **預設值**: `\"quarterly\"`\n- **有效值**: `[\"monthly\", \"quarterly\"]`\n- **說明**: 分析頻率。季頻較適合財政/GDP 分析，月頻適合勞動指標監控。\n\n**注意**：選擇 `monthly` 時，財政數據會進行插值或使用代理指標。\n</parameter>\n\n<parameter name=\"horizon_quarters\">\n**horizon_quarters**\n- **類型**: int\n- **預設值**: `8`\n- **有效範圍**: `4-12`\n- **說明**: 推演期數（季度）。觀察事件後多少季的赤字/GDP。\n\n| 設定 | 時間範圍 | 適用情境 |\n|------|----------|----------|\n| 4    | 1 年     | 短期衝擊 |\n| 8    | 2 年     | 標準週期 |\n| 12   | 3 年     | 長期影響 |\n</parameter>\n\n<parameter name=\"model\">\n**model**\n- **類型**: string\n- **預設值**: `\"event_study_banding\"`\n- **有效值**: `[\"event_study_banding\", \"quantile_mapping\", \"robust_regression\"]`\n- **說明**: 分析模型選擇。\n\n| 模型                | 輸出形式        | 適用情境       |\n|---------------------|-----------------|----------------|\n| event_study_banding | 區間 + 事件清單 | 預設，最直觀   |\n| quantile_mapping    | 條件分布        | 連續型分析     |\n| robust_regression   | 預測路徑 + 係數 | 多變數情境推演 |\n</parameter>\n\n<parameter name=\"output_format\">\n**output_format**\n- **類型**: string\n- **預設值**: `\"json\"`\n- **有效值**: `[\"json\", \"markdown\"]`\n- **說明**: 輸出格式。JSON 適合程式處理，Markdown 適合報告閱讀。\n</parameter>\n\n</core_parameters>\n\n<labor_indicator_set>\n\n<parameter name=\"use_jolts\">\n**labor_indicator_set.use_jolts**\n- **類型**: bool\n- **預設值**: `true`\n- **說明**: 是否使用 JOLTS 職缺資料計算 UJO（失業/職缺比）。\n- **注意**: JOLTS 從 2001 年開始，設為 false 可用更長歷史但犧牲 UJO 指標。\n</parameter>\n\n<parameter name=\"use_unemployment_rate\">\n**labor_indicator_set.use_unemployment_rate**\n- **類型**: bool\n- **預設值**: `true`\n- **說明**: 是否使用失業率（UNRATE）計算 薩姆規則 和 ΔUR。\n</parameter>\n\n<parameter name=\"use_unemployed_level\">\n**labor_indicator_set.use_unemployed_level**\n- **類型**: bool\n- **預設值**: `true`\n- **說明**: 是否使用失業人數（UNEMPLOY）。與 JOLTS 結合計算 UJO。\n</parameter>\n\n<parameter name=\"use_sahm_rule\">\n**labor_indicator_set.use_sahm_rule**\n- **類型**: bool\n- **預設值**: `true`\n- **說明**: 是否計算 薩姆規則（失業率 3M MA 相對近 12M 低點的上升）。\n</parameter>\n\n<parameter name=\"slack_metric\">\n**slack_metric**\n- **類型**: string\n- **預設值**: `\"unemployed_to_job_openings_ratio\"`\n- **有效值**:\n  - `\"unemployed_to_job_openings_ratio\"` - UJO 比率\n  - `\"unemployment_rate_change\"` - ΔUR 半年變化\n  - `\"sahm_rule\"` - 薩姆規則 數值\n  - `\"composite\"` - 加權複合指標\n- **說明**: 定義「勞動轉弱」的核心度量方式。\n\n| 指標 | 轉弱門檻  | 特性                 |\n|------|-----------|----------------------|\n| UJO  | > 80 分位 | 早期預警，對職缺敏感 |\n| ΔUR  | > +1.0%   | 中等延遲，直觀       |\n| Sahm | ≥ 0.5     | 確認型，準確度高     |\n</parameter>\n\n</labor_indicator_set>\n\n<scenario_parameters>\n\n<parameter name=\"gdp_path\">\n**scenario.gdp_path**\n- **類型**: string\n- **預設值**: `\"high_gdp_sticky\"`\n- **有效值**: `[\"high_gdp_sticky\", \"soft_gdp\", \"recession_gdp\"]`\n- **說明**: GDP 路徑假設。\n\n| 路徑            | GDP 分位數 | GDP 成長  | 說明           |\n|-----------------|------------|-----------|----------------|\n| high_gdp_sticky | > 70%      | > 0%      | GDP 維持高位   |\n| soft_gdp        | 50-70%     | -1% ~ +2% | GDP 溫和趨緩   |\n| recession_gdp   | < 50%      | < 0%      | GDP 進入負成長 |\n</parameter>\n\n<parameter name=\"unemployment_shock\">\n**scenario.unemployment_shock**\n- **類型**: object\n- **預設值**: `{\"type\": \"rate_jump\", \"size\": 1.5, \"speed\": \"fast\"}`\n- **說明**: 失業衝擊設定。\n\n**子參數**：\n\n| 參數  | 類型   | 有效值                        | 說明     |\n|-------|--------|-------------------------------|----------|\n| type  | string | `\"rate_jump\"`, `\"level_jump\"` | 衝擊類型 |\n| size  | float  | 0.5-5.0                       | 衝擊幅度 |\n| speed | string | `\"fast\"`, `\"gradual\"`         | 衝擊速度 |\n\n**衝擊幅度解讀**：\n- `type: \"rate_jump\"` + `size: 1.5` → 失業率上升 1.5 百分點\n- `type: \"level_jump\"` + `size: 150` → 失業人數上升 150 萬人\n\n**衝擊速度**：\n- `fast` → 2 季內達到\n- `gradual` → 4-6 季逐步達到\n</parameter>\n\n</scenario_parameters>\n\n<threshold_parameters>\n\n<parameter name=\"high_gdp_percentile_threshold\">\n**high_gdp_percentile_threshold**\n- **類型**: float\n- **預設值**: `0.70`\n- **有效範圍**: `0.5-0.9`\n- **說明**: 定義「高 GDP」的分位數門檻。GDP 水平高於此分位數視為高位。\n</parameter>\n\n<parameter name=\"labor_soft_percentile_threshold\">\n**labor_soft_percentile_threshold**\n- **類型**: float\n- **預設值**: `0.80`\n- **有效範圍**: `0.6-0.95`\n- **說明**: 定義「勞動轉弱」的分位數門檻（針對 UJO）。UJO 高於此分位數視為轉弱。\n</parameter>\n\n<parameter name=\"sahm_threshold\">\n**sahm_threshold**\n- **類型**: float\n- **預設值**: `0.5`\n- **有效範圍**: `0.3-1.0`\n- **說明**: 薩姆規則 觸發門檻。經典門檻為 0.5，可調低以更早預警。\n</parameter>\n\n<parameter name=\"delta_ur_threshold\">\n**delta_ur_threshold**\n- **類型**: float\n- **預設值**: `1.0`\n- **有效範圍**: `0.5-2.0`\n- **說明**: ΔUR（6M 變化）觸發門檻。失業率半年上升超過此值視為快速惡化。\n</parameter>\n\n</threshold_parameters>\n\n<complete_example>\n**完整參數範例**\n\n```json\n{\n  \"country\": \"US\",\n  \"lookback_years\": 30,\n  \"frequency\": \"quarterly\",\n  \"labor_indicator_set\": {\n    \"use_jolts\": true,\n    \"use_unemployment_rate\": true,\n    \"use_unemployed_level\": true,\n    \"use_sahm_rule\": true\n  },\n  \"slack_metric\": \"unemployed_to_job_openings_ratio\",\n  \"scenario\": {\n    \"horizon_quarters\": 8,\n    \"gdp_path\": \"high_gdp_sticky\",\n    \"unemployment_shock\": {\n      \"type\": \"rate_jump\",\n      \"size\": 1.5,\n      \"speed\": \"fast\"\n    }\n  },\n  \"model\": \"event_study_banding\",\n  \"output_format\": \"json\",\n  \"thresholds\": {\n    \"high_gdp_percentile\": 0.70,\n    \"labor_soft_percentile\": 0.80,\n    \"sahm_threshold\": 0.5,\n    \"delta_ur_threshold\": 1.0\n  }\n}\n```\n</complete_example>\n\n<cli_usage>\n**命令列使用範例**\n\n```bash\n# 快速診斷（使用所有預設值）\npython scripts/analyzer.py --quick\n\n# 完整分析\npython scripts/analyzer.py \\\n    --lookback 30 \\\n    --horizon 8 \\\n    --model event_study_banding \\\n    --output result.json\n\n# 自訂情境\npython scripts/analyzer.py \\\n    --scenario '{\"horizon_quarters\": 8, \"gdp_path\": \"high_gdp_sticky\", \"unemployment_shock\": {\"type\": \"rate_jump\", \"size\": 1.5, \"speed\": \"fast\"}}' \\\n    --output scenario_result.json\n\n# Markdown 報告輸出\npython scripts/analyzer.py --quick --format markdown --output report.md\n```\n</cli_usage>\n",
        "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/references/methodology.md": "<overview>\n本文件詳細說明「高失業 + 高 GDP」情境下財政赤字推估的方法論，包含理論基礎、指標建構、分析模型，以及 UST 風險雙通道框架。\n</overview>\n\n<theoretical_foundation>\n\n<concept name=\"labor_fiscal_linkage\">\n**勞動-財政連結機制**\n\n當勞動市場轉弱時，財政赤字擴張主要透過兩個管道：\n\n**1. 自動穩定器 (Automatic Stabilizers)**\n- 失業上升 → 失業救濟支出自動增加\n- 收入下降 → 所得稅收自動減少\n- 消費減緩 → 銷售稅收減少\n\n**2. 自主性財政政策 (Discretionary Fiscal Policy)**\n- 經濟轉弱時政府可能推出刺激方案\n- 規模不定，取決於政治意願與財政空間\n- 2008: TARP + ARRA ≈ GDP 5%\n- 2020: CARES + 後續 ≈ GDP 10%+\n\n**關鍵洞察**：\n自動穩定器效應相對穩定可預測，自主性政策變異大。本技能的「事件分組區間法」能捕捉兩者的歷史分布。\n</concept>\n\n<concept name=\"elasticity_parameters\">\n**勞動-財政彈性係數 (Elasticity Parameters)**\n\n基於 2000-2025 年歷史數據回歸分析，得出以下經濟彈性關係：\n\n| 彈性係數                    | 數值      | 經濟意涵                                    |\n|-----------------------------|-----------|---------------------------------------------|\n| **β_UR (UR→Deficit)**       | **0.59**  | 失業率每上升 1 ppt → 赤字/GDP 上升 0.59 ppt |\n| **β_UJO (UJO→Deficit)**     | **0.69**  | UJO 比率每上升 1 → 赤字/GDP 上升 0.69 ppt   |\n| **β_JOLTS (JOLTS→Deficit)** | **-0.07** | 職缺每增加 1M → 赤字/GDP 下降 0.07 ppt      |\n\n**領先-滯後結構**：\n- 失業率領先赤字約 **4 個季度**（最佳相關係數 r = -0.644）\n- 這意味著勞動市場惡化後，赤字擴張約在 1 年後才完全體現\n\n**條件平均值**：\n| 勞動市場狀態 | 條件    | 平均赤字/GDP |\n|--------------|---------|--------------|\n| 勞動鬆弛     | UJO > 1 | 5.6%         |\n| 勞動緊俏     | UJO ≤ 1 | 5.2%         |\n\n**彈性應用公式**：\n```python\n# 情境推演公式\ndef project_deficit_elasticity(current_deficit, delta_ur, delta_ujo):\n    \"\"\"\n    使用彈性係數推演赤字/GDP\n\n    Parameters:\n    - current_deficit: 當前赤字/GDP (%)\n    - delta_ur: 失業率變化 (ppt)\n    - delta_ujo: UJO 比率變化\n\n    Returns:\n    - projected_deficit: 預測赤字/GDP (%)\n    \"\"\"\n    BETA_UR = 0.59   # 失業率彈性\n    BETA_UJO = 0.69  # UJO 比率彈性\n    LAG_Q = 4        # 領先季度數\n\n    # 彈性驅動的變化\n    delta_deficit = BETA_UR * delta_ur + BETA_UJO * delta_ujo\n\n    return current_deficit + delta_deficit\n```\n\n**注意事項**：\n1. 這些彈性係數反映「平均」效應，危機時期（2008、2020）會有非線性放大\n2. β_UR 包含自動穩定器和部分自主性政策的混合效應\n3. 實際推演應考慮 4Q 滯後結構\n</concept>\n\n<concept name=\"divergence_scenario\">\n**勞動-GDP 背離情境**\n\n本技能聚焦的特殊情境：**勞動轉弱但 GDP 仍高**\n\n這種背離通常出現在：\n1. **景氣循環晚期**：領先指標（就業）先轉，GDP 尚未反映\n2. **結構性調整期**：生產力提升導致「無就業成長」\n3. **名目 GDP 被通膨撐高**：實質經濟放緩但名目數字仍高\n4. **財政/信用擴張期**：政府支出或信貸撐住總需求\n\n為什麼這個情境重要？\n- 勞動轉弱啟動自動穩定器\n- GDP 仍高意味稅基尚未崩潰\n- 但赤字擴張已經開始\n- 這是赤字從「溫和」跳升到「大幅」的關鍵轉折點\n</concept>\n\n</theoretical_foundation>\n\n<indicator_construction>\n\n<indicator name=\"ujo\">\n**UJO（失業/職缺比）**\n\n```\nUJO = UNEMPLOY / JTSJOL\n    = 失業人數 / 職缺數\n```\n\n**解讀**：\n| UJO 水準 | 市場狀態 | 歷史參照           |\n|----------|----------|--------------------|\n| < 0.5    | 極度緊張 | 2021-2022 復甦期   |\n| 0.5-1.0  | 正常偏緊 | 2015-2019 擴張期   |\n| 1.0-1.5  | 正常偏鬆 | 2010-2014 復甦中   |\n| 1.5-2.0  | 鬆弛     | 2003-2004          |\n| > 2.0    | 嚴重鬆弛 | 2009-2010 金融海嘯 |\n\n**優點**：能捕捉「職缺掉很快、失業還沒上來」的早期轉弱階段\n**缺點**：JOLTS 數據從 2001 年才開始\n</indicator>\n\n<indicator name=\"sahm_rule\">\n**薩姆規則**\n\n```\nSahm = 3M_MA(UNRATE) - min(UNRATE over last 12M)\n```\n\n**解讀**：\n- Sahm ≥ 0.5 → 衰退警示（歷史上準確率極高）\n- Sahm ≥ 0.3 → 勞動轉弱早期跡象\n- Sahm < 0.2 → 勞動市場穩定\n\n**優點**：由 Fed 經濟學家 Claudia Sahm 提出，有理論基礎\n**缺點**：是「確認型」指標，轉弱後才會觸發\n</indicator>\n\n<indicator name=\"delta_ur\">\n**ΔUR（失業率變化）**\n\n```\nΔUR = UNRATE(t) - UNRATE(t-6M)\n```\n\n**解讀**：\n| ΔUR 6M  | 市場狀態 |\n|---------|----------|\n| < 0     | 改善中   |\n| 0-0.3   | 穩定     |\n| 0.3-1.0 | 溫和惡化 |\n| > 1.0   | 快速惡化 |\n\n**優點**：簡單直觀，數據覆蓋長\n**缺點**：對起點敏感（從低點上升 vs 從中等水準上升意義不同）\n</indicator>\n\n<indicator name=\"high_gdp\">\n**高 GDP 條件**\n\n```python\n# 方法 1：分位數法\nGDP_pctl = percentile_rank(GDP, lookback_years)\nHIGH_GDP = GDP_pctl >= 0.70\n\n# 方法 2：成長法\nGDP_growth = (GDP / GDP.shift(4) - 1) * 100  # YoY\nHIGH_GDP = GDP_growth > 0\n\n# 方法 3：組合法（建議）\nHIGH_GDP = (GDP_pctl >= 0.70) | (GDP_growth > 0)\n```\n</indicator>\n\n</indicator_construction>\n\n<analysis_models>\n\n<model name=\"event_study_banding\">\n**事件分組區間法 (Event Study Banding)**\n\n最貼近「歷史顯示…」敘事的方法。\n\n**步驟**：\n1. 找出歷史上所有「勞動轉弱事件」的起點\n2. 篩選事件發生時滿足「高 GDP」條件的樣本\n3. 觀察每個事件後 horizon_quarters 內的 Deficit/GDP\n4. 計算這些樣本的分布統計\n\n```python\ndef event_study_banding(data, episodes, horizon_q, gdp_condition):\n    forward_deficits = []\n\n    for ep in episodes:\n        if not ep.meets_condition(gdp_condition):\n            continue\n\n        # 取事件後 horizon_q 季的最大赤字\n        future_deficit = data['DEFICIT_GDP'][\n            ep.start : ep.start + pd.DateOffset(months=horizon_q*3)\n        ].max()\n\n        forward_deficits.append({\n            'start': ep.start,\n            'deficit_peak': future_deficit,\n            'slack_at_start': ep.slack_metric\n        })\n\n    # 計算統計\n    deficits = [d['deficit_peak'] for d in forward_deficits]\n    return {\n        'p25': np.percentile(deficits, 25),\n        'p50': np.percentile(deficits, 50),\n        'p75': np.percentile(deficits, 75),\n        'min': min(deficits),\n        'max': max(deficits),\n        'n_episodes': len(deficits),\n        'episodes': forward_deficits\n    }\n```\n\n**優點**：\n- 直觀，產出「12–17%」這種範圍型敘事\n- 可追溯到每一次歷史事件\n- 不依賴參數估計\n\n**缺點**：\n- 樣本數有限（約 6 次）\n- 每次事件的財政反應強度不同\n</model>\n\n<model name=\"quantile_mapping\">\n**分位數映射 (Quantile Mapping)**\n\n適合回答「現在落在歷史哪個角落？」\n\n**步驟**：\n1. 計算當前 slack_metric 在歷史分布的分位數 p\n2. 找出歷史上 slack_metric 落在 p±ε 的所有時點\n3. 對這些時點的後續 Deficit/GDP 做統計\n\n```python\ndef quantile_mapping(data, current_slack, epsilon=0.05, horizon_q=8):\n    # 計算當前 slack 的分位數\n    slack_series = data['SLACK_METRIC']\n    current_pctl = (slack_series < current_slack).mean()\n\n    # 找出相似時期\n    all_pctl = slack_series.rank(pct=True)\n    similar_mask = abs(all_pctl - current_pctl) < epsilon\n\n    # 取這些時期的後續赤字\n    forward_deficits = []\n    for date in data.index[similar_mask]:\n        future_date = date + pd.DateOffset(months=horizon_q*3)\n        if future_date <= data.index.max():\n            forward_deficits.append(data['DEFICIT_GDP'].loc[:future_date].iloc[-1])\n\n    return {\n        'current_percentile': current_pctl,\n        'similar_periods_count': len(forward_deficits),\n        'deficit_distribution': {\n            'p25': np.percentile(forward_deficits, 25),\n            'p50': np.percentile(forward_deficits, 50),\n            'p75': np.percentile(forward_deficits, 75)\n        }\n    }\n```\n\n**優點**：\n- 使用所有歷史數據，不只是「事件」\n- 適合連續型分析\n\n**缺點**：\n- 可能混入非危機時期的樣本\n- 對 ε 參數敏感\n</model>\n\n<model name=\"robust_regression\">\n**穩健迴歸 (Robust Regression)**\n\n適合連續型情境推演。\n\n**模型**：\n```\nDeficit/GDP(t+4Q) = α + β₁·Slack(t) + β₂·GDP_regime(t) + β₃·Inflation(t) + ε\n```\n\n使用分位數迴歸 (Quantile Regression) 可得到不同分位數的預測區間。\n\n```python\nfrom statsmodels.regression.quantile_regression import QuantReg\n\ndef robust_regression_projection(data, scenario, quantiles=[0.25, 0.5, 0.75]):\n    # 準備特徵\n    X = data[['SLACK_METRIC', 'GDP_GROWTH', 'INFLATION']].dropna()\n    y = data['DEFICIT_GDP'].shift(-4).dropna()  # 4Q 後的赤字\n\n    # 對齊\n    idx = X.index.intersection(y.index)\n    X, y = X.loc[idx], y.loc[idx]\n\n    results = {}\n    for q in quantiles:\n        model = QuantReg(y, X).fit(q=q)\n        # 用情境值預測\n        X_scenario = [[scenario['slack'], scenario['gdp_growth'], scenario['inflation']]]\n        results[f'p{int(q*100)}'] = model.predict(X_scenario)[0]\n\n    return results\n```\n\n**優點**：\n- 可納入多個控制變數\n- 產出連續的預測路徑\n- 可做敏感度分析\n\n**缺點**：\n- 樣本量有限時估計不穩定\n- 線性假設可能不成立\n- 可解釋性較低\n</model>\n\n</analysis_models>\n\n<ust_risk_framework>\n\n<dual_channel>\n**UST 風險雙通道框架**\n\n長天期美債價格（或殖利率）同時受到兩股相反力量影響：\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                                                              │\n│   供給壓力通道                      避險買盤通道             │\n│   ────────────                      ────────────             │\n│                                                              │\n│   赤字↑                             經濟轉弱                 │\n│      ↓                                 ↓                     │\n│   發債需求↑                         風險趨避↑               │\n│      ↓                                 ↓                     │\n│   期限溢酬↑                         債券需求↑               │\n│      ↓                                 ↓                     │\n│   殖利率↑（債券價格↓）              殖利率↓（債券價格↑）    │\n│                                                              │\n└─────────────────────────────────────────────────────────────┘\n```\n\n**哪個力量主導？**\n\n取決於：\n1. 衝擊的性質（金融危機 vs 通膨驅動的緊縮）\n2. Fed 的政策立場（是否 QE 吸收供給）\n3. 全球避險需求（美元/美債的避風港地位）\n4. 通膨預期（影響實質報酬要求）\n</dual_channel>\n\n<historical_precedents>\n**歷史先例**\n\n| 事件       | 赤字/GDP 峰值 | 10Y 殖利率變化 | 主導力量         |\n|------------|---------------|----------------|------------------|\n| 2001-2003  | 3.4%          | -200 bps       | 避險/Fed 降息    |\n| 2008-2010  | 9.8%          | -150 bps       | 避險/QE 吸收     |\n| 2020 Q1-Q2 | 14.9%         | -100 bps       | 避險/Fed 無限 QE |\n| 2022-2023  | 6%            | +200 bps       | 供給/通膨        |\n\n**觀察**：\n- 當避險需求極強（危機時刻）+ Fed 介入，避險主導\n- 當沒有危機氣氛 + Fed 不介入（或 QT），供給主導\n- 通膨預期高時，供給壓力更明顯\n</historical_precedents>\n\n<switching_indicators>\n**力量切換指標**\n\n| 指標            | 供給主導訊號 | 避險主導訊號  |\n|-----------------|--------------|---------------|\n| VIX             | < 25         | > 30          |\n| IG 信用利差     | 穩定         | 急升 > 50 bps |\n| 股債相關性      | 正相關       | 負相關        |\n| 通膨預期 (5Y5Y) | > 2.5%       | < 2%          |\n| 國債拍賣尾差    | > 2 bps      | < -2 bps      |\n| Fed 政策        | QT 進行中    | QE/暫停 QT    |\n\n**決策樹**：\n```\nIF VIX > 30 AND 信用利差急升 THEN\n    避險主導 → 長債可能上漲\nELIF VIX < 25 AND 拍賣持續疲軟 THEN\n    供給主導 → 長債可能承壓\nELSE\n    混合/拉鋸 → 觀望\n```\n</switching_indicators>\n\n</ust_risk_framework>\n\n<limitations>\n**方法論限制**\n\n1. **樣本量有限**：過去 30 年符合條件的事件約 6 次\n2. **每次不同**：財政反應強度取決於政治環境\n3. **數據延遲**：JOLTS 延遲 2 個月，GDP 延遲 1 個月\n4. **模型不確定性**：三種模型可能給出不同答案\n5. **政策依賴**：Fed 政策可大幅改變結果\n\n**建議使用方式**：\n- 將輸出視為「歷史參照區間」而非精確預測\n- 搭配其他分析工具交叉驗證\n- 持續監控切換指標判斷主導力量\n</limitations>\n",
        "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/templates/output-json.md": "<overview>\n本文件定義技能的 JSON 輸出結構，包含所有欄位的說明與範例。\n</overview>\n\n<schema>\n**完整 JSON 輸出結構**\n\n```json\n{\n  \"skill\": \"analyze_high_unemployment_fiscal_deficit_scenarios\",\n  \"version\": \"0.1.0\",\n  \"as_of\": \"2026-01-21\",\n  \"inputs\": {\n    \"country\": \"US\",\n    \"lookback_years\": 30,\n    \"frequency\": \"quarterly\",\n    \"slack_metric\": \"unemployed_to_job_openings_ratio\",\n    \"scenario\": {\n      \"horizon_quarters\": 8,\n      \"gdp_path\": \"high_gdp_sticky\",\n      \"unemployment_shock\": {\n        \"type\": \"rate_jump\",\n        \"size\": 1.5,\n        \"speed\": \"fast\"\n      }\n    },\n    \"model\": \"event_study_banding\"\n  },\n  \"diagnostics\": {\n    \"data_coverage\": {\n      \"start_date\": \"1996-01-01\",\n      \"end_date\": \"2026-01-01\",\n      \"series_available\": [\"UNRATE\", \"UNEMPLOY\", \"JTSJOL\", \"GDP\", \"FYFSGDA188S\"]\n    },\n    \"current_indicators\": {\n      \"unemployment_rate\": 4.1,\n      \"unemployed_level\": 6800,\n      \"job_openings\": 9400,\n      \"ujo_ratio\": 0.72,\n      \"sahm_rule\": 0.21,\n      \"delta_ur_6m\": 0.3\n    },\n    \"current_slack_percentile\": 0.84,\n    \"high_gdp_condition\": true,\n    \"gdp_percentile\": 0.95,\n    \"triggered_labor_softening\": true,\n    \"trigger_reasons\": [\"ujo_above_threshold\"]\n  },\n  \"deficit_gdp_projection\": {\n    \"baseline_deficit_gdp\": 0.065,\n    \"conditional_range_next_8q\": {\n      \"p25\": 0.11,\n      \"p50\": 0.135,\n      \"p75\": 0.16,\n      \"min\": 0.095,\n      \"max\": 0.175\n    },\n    \"n_episodes\": 6,\n    \"episode_years\": [\"2001-2003\", \"2008-2010\", \"2020-2021\", \"1990-1991\", \"1980-1982\", \"2023-2024\"]\n  },\n  \"historical_episodes\": [\n    {\n      \"start_date\": \"2001-03-31\",\n      \"end_date\": \"2003-06-30\",\n      \"duration_quarters\": 9,\n      \"ujo_at_start\": 1.21,\n      \"sahm_at_start\": 0.4,\n      \"gdp_percentile_at_start\": 0.82,\n      \"deficit_gdp_peak\": 0.034,\n      \"context\": \"科技泡沫破裂 + 911\"\n    },\n    {\n      \"start_date\": \"2008-01-31\",\n      \"end_date\": \"2010-09-30\",\n      \"duration_quarters\": 11,\n      \"ujo_at_start\": 1.45,\n      \"sahm_at_start\": 0.6,\n      \"gdp_percentile_at_start\": 0.78,\n      \"deficit_gdp_peak\": 0.098,\n      \"context\": \"全球金融海嘯\"\n    },\n    {\n      \"start_date\": \"2020-03-31\",\n      \"end_date\": \"2021-03-31\",\n      \"duration_quarters\": 4,\n      \"ujo_at_start\": 4.60,\n      \"sahm_at_start\": 1.2,\n      \"gdp_percentile_at_start\": 0.91,\n      \"deficit_gdp_peak\": 0.149,\n      \"context\": \"COVID-19 財政刺激\"\n    }\n  ],\n  \"interpretation\": {\n    \"macro_story\": \"在歷史上勞動市場明顯轉弱且 GDP 仍處高位的樣本中，赤字/GDP 常出現階躍式上移，區間落在約 11%–16%（中位數約 13.5%）。當前勞動市場鬆緊度處於 84 分位（UJO 基準），已觸發轉弱條件，而 GDP 仍處於 95 分位高位。若失業率在未來 2 季快速上升 1.5 百分點，歷史經驗顯示財政赤字可能從當前 6.5% 跳升至 11-16% 區間。\",\n    \"ust_duration_implications\": [\n      {\n        \"channel\": \"supply_pressure\",\n        \"assessment\": \"高\",\n        \"description\": \"赤字/GDP 若進入 12%+ 區間，通常意味更高的國債淨發行需求，長端對期限溢酬變化更敏感。以當前 GDP 規模估算，赤字 13.5% 對應約 3.8 兆美元的年度淨發行，較當前增加近一倍。\"\n      },\n      {\n        \"channel\": \"risk_aversion\",\n        \"assessment\": \"中等\",\n        \"description\": \"若同時出現風險趨避（信用利差擴大、波動上升），長端可能先被避險買盤壓低殖利率；需用風險指標判斷主導力量。當前 VIX 處於正常水準，信用利差穩定，避險力量尚未啟動。\"\n      }\n    ],\n    \"dominant_force\": \"目前偏向供給壓力主導，但需持續監控避險指標\",\n    \"watchlist_switch_indicators\": [\n      \"信用利差/金融壓力指數是否急升（避險力道）\",\n      \"通膨預期是否黏著（長端期限溢酬）\",\n      \"國債拍賣尾差/投標倍數（供給壓力顯性化）\",\n      \"Fed 政策立場（QE 暫停/重啟）\",\n      \"股債相關性（轉負表示避險模式）\"\n    ]\n  },\n  \"metadata\": {\n    \"generated_at\": \"2026-01-21T10:30:00Z\",\n    \"model_used\": \"event_study_banding\",\n    \"data_freshness\": {\n      \"UNRATE\": \"2025-12-31\",\n      \"JTSJOL\": \"2025-11-30\",\n      \"GDP\": \"2025-09-30\"\n    }\n  }\n}\n```\n</schema>\n\n<field_descriptions>\n\n<field name=\"skill\">\n**skill** (string): 技能識別碼\n</field>\n\n<field name=\"version\">\n**version** (string): 技能版本號\n</field>\n\n<field name=\"as_of\">\n**as_of** (string): 分析基準日期 (YYYY-MM-DD)\n</field>\n\n<field name=\"inputs\">\n**inputs** (object): 輸入參數回顯，方便追溯分析設定\n</field>\n\n<field name=\"diagnostics\">\n**diagnostics** (object): 診斷資訊\n\n| 子欄位                    | 類型   | 說明                     |\n|---------------------------|--------|--------------------------|\n| data_coverage             | object | 數據覆蓋範圍             |\n| current_indicators        | object | 當前指標數值             |\n| current_slack_percentile  | float  | 當前勞動鬆緊分位數 (0-1) |\n| high_gdp_condition        | bool   | 是否滿足高 GDP 條件      |\n| triggered_labor_softening | bool   | 是否觸發勞動轉弱         |\n| trigger_reasons           | array  | 觸發原因清單             |\n</field>\n\n<field name=\"deficit_gdp_projection\">\n**deficit_gdp_projection** (object): 赤字/GDP 投影結果\n\n| 子欄位                    | 類型   | 說明                               |\n|---------------------------|--------|------------------------------------|\n| baseline_deficit_gdp      | float  | 當前基線赤字/GDP                   |\n| conditional_range_next_8q | object | 條件分布區間 (p25/p50/p75/min/max) |\n| n_episodes                | int    | 歷史樣本數量                       |\n| episode_years             | array  | 歷史事件年份清單                   |\n</field>\n\n<field name=\"historical_episodes\">\n**historical_episodes** (array): 歷史事件詳細資料\n\n每個事件包含：\n| 欄位                    | 類型   | 說明              |\n|-------------------------|--------|-------------------|\n| start_date              | string | 事件起始日期      |\n| end_date                | string | 事件結束日期      |\n| duration_quarters       | int    | 持續季數          |\n| ujo_at_start            | float  | 起始時 UJO        |\n| sahm_at_start           | float  | 起始時 薩姆規則   |\n| gdp_percentile_at_start | float  | 起始時 GDP 分位數 |\n| deficit_gdp_peak        | float  | 期間赤字/GDP 峰值 |\n| context                 | string | 事件背景說明      |\n</field>\n\n<field name=\"interpretation\">\n**interpretation** (object): 情境解讀\n\n| 子欄位                      | 類型   | 說明             |\n|-----------------------------|--------|------------------|\n| macro_story                 | string | 宏觀敘事摘要     |\n| ust_duration_implications   | array  | UST 風險通道分析 |\n| dominant_force              | string | 當前主導力量判斷 |\n| watchlist_switch_indicators | array  | 監控指標清單     |\n</field>\n\n<field name=\"metadata\">\n**metadata** (object): 元資料\n\n| 子欄位         | 類型   | 說明                    |\n|----------------|--------|-------------------------|\n| generated_at   | string | 報告生成時間 (ISO 8601) |\n| model_used     | string | 使用的分析模型          |\n| data_freshness | object | 各數據系列的最新日期    |\n</field>\n\n</field_descriptions>\n\n<quick_output>\n**快速診斷輸出（--quick 模式）**\n\n```json\n{\n  \"skill\": \"analyze_high_unemployment_fiscal_deficit_scenarios\",\n  \"as_of\": \"2026-01-21\",\n  \"state\": {\n    \"current_slack_percentile\": 0.84,\n    \"high_gdp_condition\": true,\n    \"triggered_labor_softening\": true\n  },\n  \"deficit_gdp_projection\": {\n    \"baseline\": 0.065,\n    \"if_labor_softens\": {\n      \"p25\": 0.11,\n      \"p50\": 0.135,\n      \"p75\": 0.16\n    }\n  },\n  \"ust_risk_level\": \"elevated\",\n  \"dominant_force\": \"supply_pressure\"\n}\n```\n</quick_output>\n",
        "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/templates/output-markdown.md": "<overview>\n本文件定義 Markdown 格式的輸出報告模板。\n</overview>\n\n<template>\n\n```markdown\n# 高失業高GDP情境下的財政赤字分析報告\n\n**分析日期**：{{as_of}}\n**數據截至**：{{data_end_date}}\n**分析模型**：{{model_name}}\n\n---\n\n## 執行摘要\n\n{{macro_story}}\n\n| 關鍵指標              | 數值                          | 狀態               |\n|-----------------------|-------------------------------|--------------------|\n| 勞動鬆緊分位數        | {{current_slack_percentile}}  | {{slack_status}}   |\n| 高 GDP 條件           | {{high_gdp_condition}}        | {{gdp_status}}     |\n| 勞動轉弱觸發          | {{triggered_labor_softening}} | {{trigger_status}} |\n| 當前赤字/GDP          | {{baseline_deficit_gdp}}      | -                  |\n| 預估赤字/GDP (中位數) | {{deficit_p50}}               | {{deficit_change}} |\n\n---\n\n## 1. 當前勞動市場狀態\n\n### 1.1 核心指標\n\n| 指標               | 數值                      | 歷史分位數         | 說明                        |\n|--------------------|---------------------------|--------------------|-----------------------------|\n| 失業率             | {{unemployment_rate}}%    | {{ur_percentile}}  | {{ur_interpretation}}       |\n| 失業人數           | {{unemployed_level}} 萬人 | -                  | -                           |\n| JOLTS 職缺         | {{job_openings}} 萬人     | -                  | -                           |\n| UJO（失業/職缺比） | {{ujo_ratio}}             | {{ujo_percentile}} | {{ujo_interpretation}}      |\n| 薩姆規則           | {{sahm_rule}}             | -                  | {{sahm_interpretation}}     |\n| ΔUR (6M 變化)      | {{delta_ur_6m}}%          | -                  | {{delta_ur_interpretation}} |\n\n### 1.2 勞動轉弱判定\n\n**觸發條件**：\n{{#each trigger_reasons}}\n- {{this}}\n{{/each}}\n\n**結論**：{{labor_conclusion}}\n\n---\n\n## 2. GDP 狀態判定\n\n| 指標          | 數值                 | 說明                              |\n|---------------|----------------------|-----------------------------------|\n| 名目 GDP      | {{gdp_level}} 兆美元 | -                                 |\n| GDP 分位數    | {{gdp_percentile}}   | {{gdp_percentile_interpretation}} |\n| 實質 GDP 成長 | {{gdp_growth}}% YoY  | {{gdp_growth_interpretation}}     |\n\n**高 GDP 條件**：{{high_gdp_conclusion}}\n\n---\n\n## 3. 財政赤字/GDP 投影\n\n### 3.1 條件分布區間（未來 {{horizon_quarters}} 季）\n\n| 統計量     | 赤字/GDP                            | 說明         |\n|------------|-------------------------------------|--------------|\n| 當前基線   | {{baseline_deficit_gdp}}%           | -            |\n| 25 分位    | {{deficit_p25}}%                    | 樂觀情境     |\n| **中位數** | **{{deficit_p50}}%**                | **基準情境** |\n| 75 分位    | {{deficit_p75}}%                    | 悲觀情境     |\n| 歷史極端   | {{deficit_min}}% - {{deficit_max}}% | 尾部風險     |\n\n### 3.2 歷史樣本事件（共 {{n_episodes}} 次）\n\n| 期間 | 持續 | 起始 UJO | 起始 Sahm | 赤字峰值 | 背景 |\n|------|------|----------|-----------|----------|------|\n{{#each historical_episodes}}\n| {{start_date}} - {{end_date}} | {{duration_quarters}} 季 | {{ujo_at_start}} | {{sahm_at_start}} | {{deficit_gdp_peak}}% | {{context}} |\n{{/each}}\n\n---\n\n## 4. 長天期美債（UST）風險解讀\n\n### 4.1 供給壓力通道\n\n**評估等級**：{{supply_pressure_level}}\n\n{{supply_pressure_description}}\n\n- **發債估算**：以當前 GDP 規模 {{gdp_level}} 兆美元計算，赤字 {{deficit_p50}}% 對應約 {{estimated_issuance}} 兆美元的年度淨發行\n- **較當前變化**：{{issuance_change_description}}\n- **期限溢酬影響**：{{term_premium_impact}}\n\n### 4.2 避險買盤通道\n\n**評估等級**：{{risk_aversion_level}}\n\n{{risk_aversion_description}}\n\n**當前避險指標**：\n| 指標        | 數值                | 訊號            |\n|-------------|---------------------|-----------------|\n| VIX         | {{vix_level}}       | {{vix_signal}}  |\n| IG 信用利差 | {{ig_spread}} bps   | {{ig_signal}}   |\n| 股債相關性  | {{stock_bond_corr}} | {{corr_signal}} |\n\n### 4.3 主導力量判斷\n\n**當前判斷**：{{dominant_force}}\n\n{{dominant_force_reasoning}}\n\n### 4.4 監控指標清單\n\n持續追蹤以下指標判斷力量切換：\n\n{{#each watchlist_switch_indicators}}\n- {{this}}\n{{/each}}\n\n---\n\n## 5. 情境風險矩陣\n\n| 情境     | 觸發條件     | 赤字/GDP          | UST 影響                     |\n|----------|--------------|-------------------|------------------------------|\n| **基準** | 失業溫和上升 | {{deficit_p50}}%  | 殖利率溫和上行               |\n| **悲觀** | 失業快速惡化 | {{deficit_p75}}%+ | 供給壓力主導，殖利率顯著上行 |\n| **危機** | 金融風險蔓延 | {{deficit_max}}%  | 避險主導，殖利率可能下行     |\n\n---\n\n## 6. 結論與建議\n\n### 6.1 核心結論\n\n{{core_conclusion}}\n\n### 6.2 監控建議\n\n1. **短期（1-3 個月）**：\n   - 追蹤每月就業報告與 JOLTS\n   - 觀察 薩姆規則 是否突破 0.5\n\n2. **中期（3-6 個月）**：\n   - 觀察財政預算與支出動態\n   - 追蹤國債拍賣表現\n\n3. **觸發性行動**：\n   - 若 VIX 突破 30 且信用利差急升 → 重新評估避險主導情境\n   - 若拍賣持續疲軟且通膨預期上升 → 確認供給壓力主導\n\n---\n\n**報告生成時間**：{{generated_at}}\n**使用模型**：{{model_used}}\n**數據來源**：FRED (無需 API key)\n\n---\n\n*免責聲明：本報告基於歷史數據的統計分析，不構成投資建議。實際財政與市場走勢受多重因素影響，可能與歷史模式顯著偏離。*\n```\n\n</template>\n\n<placeholders>\n**模板佔位符說明**\n\n| 佔位符                         | 來源                   | 說明                                   |\n|--------------------------------|------------------------|----------------------------------------|\n| `{{as_of}}`                    | metadata               | 分析基準日期                           |\n| `{{current_slack_percentile}}` | diagnostics            | 勞動鬆緊分位數 (格式化為 \"84 分位\")    |\n| `{{deficit_p50}}`              | deficit_gdp_projection | 中位數赤字/GDP (格式化為 \"13.5%\")      |\n| `{{historical_episodes}}`      | historical_episodes    | 歷史事件陣列，使用 Handlebars 風格迭代 |\n| ...                            | ...                    | ...                                    |\n\n**條件顯示**：使用 `{{#if condition}}...{{/if}}` 語法控制區塊顯示。\n\n**陣列迭代**：使用 `{{#each array}}...{{/each}}` 語法遍歷歷史事件。\n</placeholders>\n\n<example_output>\n**範例報告片段**\n\n```markdown\n## 執行摘要\n\n在歷史上勞動市場明顯轉弱且 GDP 仍處高位的樣本中，赤字/GDP 常出現階躍式上移，\n區間落在約 11%–16%（中位數約 13.5%）。當前勞動市場鬆緊度處於 84 分位（UJO 基準），\n已觸發轉弱條件，而 GDP 仍處於 95 分位高位。\n\n| 關鍵指標              | 數值    | 狀態             |\n|-----------------------|---------|------------------|\n| 勞動鬆緊分位數        | 84 分位 | ⚠️ 偏高（轉弱中） |\n| 高 GDP 條件           | 是      | ✅ GDP 仍處高位   |\n| 勞動轉弱觸發          | 是      | ⚠️ 已觸發         |\n| 當前赤字/GDP          | 6.5%    | -                |\n| 預估赤字/GDP (中位數) | 13.5%   | 📈 +7.0%         |\n```\n</example_output>\n",
        "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/workflows/analyze.md": "<required_reading>\n**執行前請先閱讀：**\n1. references/data-sources.md - 了解 FRED 系列代碼\n2. references/input-schema.md - 了解完整參數定義\n</required_reading>\n\n<objective>\n執行完整的「高失業 + 高 GDP」情境下財政赤字推估分析，包含：\n- 抓取所有必要的 FRED 數據\n- 計算勞動鬆緊指標（UJO、薩姆規則、ΔUR）\n- 識別歷史上符合條件的事件樣本\n- 使用選定模型推估赤字/GDP 區間\n- 生成完整的分析報告與 UST 風險解讀\n</objective>\n\n<process>\n\n<step name=\"1_setup\">\n**Step 1: 環境準備與參數確認**\n\n確認 Python 環境與依賴：\n```bash\ncd skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios\npip install pandas numpy requests scipy\n```\n\n確認分析參數（使用者可自訂或使用預設）：\n```python\nparams = {\n    \"country\": \"US\",\n    \"lookback_years\": 30,\n    \"frequency\": \"quarterly\",\n    \"slack_metric\": \"unemployed_to_job_openings_ratio\",\n    \"horizon_quarters\": 8,\n    \"gdp_path\": \"high_gdp_sticky\",\n    \"model\": \"event_study_banding\",\n    \"output_format\": \"json\"\n}\n```\n</step>\n\n<step name=\"2_fetch_data\">\n**Step 2: 抓取 FRED 數據**\n\n執行數據抓取腳本：\n```bash\npython scripts/fetch_data.py --series UNRATE,UNEMPLOY,JTSJOL,GDP,GDPC1,FYFSGDA188S --years 30\n```\n\n或在 Python 中直接調用：\n```python\nfrom scripts.fetch_data import fetch_fred_series\n\nlabor_data = fetch_fred_series(['UNRATE', 'UNEMPLOY', 'JTSJOL'], years=30)\nmacro_data = fetch_fred_series(['GDP', 'GDPC1'], years=30)\nfiscal_data = fetch_fred_series(['FYFSGDA188S'], years=30)\n```\n\n**數據驗證**：\n- 確認各序列無過多缺失值\n- 確認時間範圍覆蓋完整\n- 確認最新數據日期\n</step>\n\n<step name=\"3_compute_indicators\">\n**Step 3: 計算勞動鬆緊指標**\n\n3.1 **UJO（失業/職缺比）**：\n```python\nujo = unemploy / jtsjol  # 越高表示越鬆\n```\n\n3.2 **薩姆規則**：\n```python\nur_3m_ma = unrate.rolling(3).mean()\nur_12m_min = unrate.rolling(12).min()\nsahm = ur_3m_ma - ur_12m_min  # ≥0.5 為衰退警示\n```\n\n3.3 **ΔUR（半年變化）**：\n```python\ndelta_ur = unrate - unrate.shift(6)\n```\n\n3.4 **計算分位數**：\n```python\nujo_pctl = ujo.rank(pct=True)\n```\n</step>\n\n<step name=\"4_define_conditions\">\n**Step 4: 定義背離事件條件**\n\n4.1 **勞動轉弱條件**（滿足任一）：\n- UJO 進入歷史 80% 分位以上\n- 薩姆規則 ≥ 0.5\n- ΔUR（6M）≥ +1.0 百分點\n\n4.2 **高 GDP 條件**（同時滿足）：\n- GDP 水平在 70% 分位以上\n- 或 GDP YoY 成長仍為正\n\n4.3 **識別事件樣本**：\n```python\nevent_mask = labor_soft & high_gdp\nepisodes = extract_episodes(data, event_mask, min_duration=2)\n```\n</step>\n\n<step name=\"5_run_model\">\n**Step 5: 執行分析模型**\n\n根據 `model` 參數選擇：\n\n**A) event_study_banding（事件分組區間法）**：\n```python\n# 對每個事件，觀察後續 horizon_quarters 的 Deficit/GDP\nforward_deficits = []\nfor ep in episodes:\n    future_deficit = deficit_gdp[ep.start : ep.start + horizon_quarters].max()\n    forward_deficits.append(future_deficit)\n\n# 計算區間統計\nresult = {\n    'p25': np.percentile(forward_deficits, 25),\n    'p50': np.percentile(forward_deficits, 50),\n    'p75': np.percentile(forward_deficits, 75),\n    'min': min(forward_deficits),\n    'max': max(forward_deficits)\n}\n```\n\n**B) quantile_mapping（分位數映射）**：\n```python\n# 找出歷史上 slack_metric 落在當前分位數附近的時點\ncurrent_pctl = ujo_pctl.iloc[-1]\nsimilar_periods = data[abs(ujo_pctl - current_pctl) < 0.05]\n# 對這些時點的後續 Deficit/GDP 做統計\n```\n\n**C) robust_regression（穩健迴歸）**：\n```python\nfrom statsmodels.regression.quantile_regression import QuantReg\nmodel = QuantReg(deficit_gdp_future, X)\nresult = model.fit(q=0.5)\n```\n</step>\n\n<step name=\"6_generate_output\">\n**Step 6: 生成輸出報告**\n\n執行完整分析並輸出：\n```bash\npython scripts/analyzer.py \\\n    --lookback 30 \\\n    --horizon 8 \\\n    --model event_study_banding \\\n    --output result.json\n```\n\n輸出內容應包含：\n1. **診斷資訊**：當前 UJO、Sahm、ΔUR 數值與分位數\n2. **條件判定**：是否觸發勞動轉弱、是否滿足高 GDP\n3. **赤字區間**：條件分布（p25/p50/p75/min/max）\n4. **歷史樣本**：事件年份與對應赤字峰值\n5. **UST 解讀**：供給壓力與避險買盤的雙通道分析\n6. **監控指標**：建議追蹤的切換指標\n</step>\n\n<step name=\"7_visualize\">\n**Step 7: 生成視覺化圖表（可選）**\n\n若需要視覺化輸出，使用 `--visualize` 參數：\n```bash\npython scripts/analyzer.py \\\n    --lookback 30 \\\n    --horizon 8 \\\n    --model event_study_banding \\\n    --visualize \\\n    --scenario-type moderate \\\n    --output result.json \\\n    --chart-output chart.png\n```\n\n或單獨執行視覺化腳本：\n```bash\npython scripts/visualizer.py --scenario moderate --years 25\n```\n\n圖表包含：\n- 三軸歷史數據（職缺/失業/赤字GDP）\n- 歷史 crossover 事件標註\n- 情境投影虛線\n- 衰退期灰色陰影\n</step>\n\n<step name=\"8_validate\">\n**Step 8: 驗證輸出**\n\n確認輸出完整性：\n- [ ] 所有診斷指標都有數值\n- [ ] 赤字區間在合理範圍（0% - 25%）\n- [ ] 歷史樣本數量 ≥ 1\n- [ ] UST 解讀包含兩股力量\n- [ ] 監控指標清單不為空\n- [ ] （若啟用視覺化）圖表檔案已生成\n</step>\n\n</process>\n\n<success_criteria>\n工作流程完成時：\n- [ ] 成功抓取所有 FRED 數據\n- [ ] 計算出 UJO、薩姆規則、ΔUR 指標\n- [ ] 識別出歷史事件樣本\n- [ ] 產出赤字/GDP 的條件分布區間\n- [ ] 生成 UST 風險解讀\n- [ ] 輸出符合模板格式（JSON 或 Markdown）\n- [ ] （若啟用視覺化）生成 Luke Gromen 風格圖表\n</success_criteria>\n",
        "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/workflows/scenario.md": "<required_reading>\n**執行前請先閱讀：**\n1. references/methodology.md - 了解情境推演邏輯\n2. references/input-schema.md - 了解情境參數定義\n</required_reading>\n\n<objective>\n執行自訂失業衝擊情境的財政赤字推演，讓使用者可以：\n- 指定失業衝擊的類型、幅度與速度\n- 選擇 GDP 路徑假設\n- 觀察不同情境下的赤字/GDP 估算區間\n</objective>\n\n<process>\n\n<step name=\"1_define_scenario\">\n**Step 1: 定義情境參數**\n\n使用者需指定以下情境假設：\n\n```python\nscenario = {\n    \"horizon_quarters\": 8,          # 推演期數（4 或 8）\n    \"gdp_path\": \"high_gdp_sticky\",  # GDP 路徑\n    \"unemployment_shock\": {\n        \"type\": \"rate_jump\",        # \"rate_jump\" 或 \"level_jump\"\n        \"size\": 1.5,                # 失業率 +1.5% 或 失業人數 +150萬\n        \"speed\": \"fast\"             # \"fast\"（2季內）或 \"gradual\"（4-6季）\n    }\n}\n```\n\n**GDP 路徑選項**：\n| 選項             | 描述                           |\n|------------------|--------------------------------|\n| high_gdp_sticky  | GDP 維持高位，僅小幅趨緩       |\n| soft_gdp         | GDP 溫和下滑，但仍為正成長     |\n| recession_gdp    | GDP 進入負成長                 |\n\n**失業衝擊類型**：\n| 類型       | 描述                    | 示例              |\n|------------|-------------------------|-------------------|\n| rate_jump  | 失業率跳升（百分點）    | size=1.5 → +1.5%  |\n| level_jump | 失業人數跳升（萬人）    | size=150 → +150萬 |\n</step>\n\n<step name=\"2_map_to_historical\">\n**Step 2: 映射到歷史樣本**\n\n根據情境設定，找出歷史上相似的事件：\n\n```python\n# 計算衝擊後的預期 slack_metric\nif shock_type == \"rate_jump\":\n    projected_ur = current_ur + shock_size\n    projected_slack_pctl = estimate_percentile(projected_ur, historical_ur)\nelif shock_type == \"level_jump\":\n    projected_unemploy = current_unemploy + shock_size * 10000\n    projected_ujo = projected_unemploy / current_jtsjol\n    projected_slack_pctl = estimate_percentile(projected_ujo, historical_ujo)\n\n# 篩選符合 GDP 路徑條件的歷史事件\nif gdp_path == \"high_gdp_sticky\":\n    condition = (gdp_pctl > 0.70) & (gdp_growth > 0)\nelif gdp_path == \"soft_gdp\":\n    condition = (gdp_growth > -1) & (gdp_growth < 2)\nelif gdp_path == \"recession_gdp\":\n    condition = (gdp_growth < 0)\n```\n</step>\n\n<step name=\"3_compute_projection\">\n**Step 3: 計算赤字/GDP 投影**\n\n使用選定的模型進行推演：\n\n**event_study_banding**（預設）：\n```python\n# 找出滿足條件的歷史事件\nmatching_episodes = filter_episodes(\n    all_episodes,\n    slack_range=(projected_slack_pctl - 0.1, projected_slack_pctl + 0.1),\n    gdp_condition=condition\n)\n\n# 計算這些事件後的赤字分布\nforward_deficits = get_forward_deficits(matching_episodes, horizon_quarters)\n```\n\n**quantile_mapping**：\n```python\n# 直接使用投影的 slack 分位數進行映射\nsimilar_periods = data[\n    (abs(slack_pctl - projected_slack_pctl) < 0.1) &\n    condition\n]\n```\n\n**robust_regression**：\n```python\n# 使用迴歸模型預測\nX_scenario = [projected_slack, gdp_growth_assumption, inflation_assumption]\npredicted_deficit = model.predict(X_scenario)\n```\n</step>\n\n<step name=\"4_sensitivity_analysis\">\n**Step 4: 敏感度分析（可選）**\n\n執行多情境比較：\n\n```bash\npython scripts/analyzer.py --scenario-sweep \\\n    --shock-sizes 0.5,1.0,1.5,2.0 \\\n    --gdp-paths high_gdp_sticky,soft_gdp \\\n    --output sensitivity.json\n```\n\n輸出比較表：\n| 失業衝擊 | GDP 路徑        | 赤字/GDP (p50) | 赤字/GDP 區間   |\n|----------|-----------------|----------------|-----------------|\n| +0.5%    | high_gdp_sticky | 8.5%           | 7.0% - 10.0%    |\n| +1.0%    | high_gdp_sticky | 11.0%          | 9.0% - 13.0%    |\n| +1.5%    | high_gdp_sticky | 13.5%          | 11.0% - 16.0%   |\n| +2.0%    | high_gdp_sticky | 15.0%          | 12.0% - 17.5%   |\n</step>\n\n<step name=\"5_generate_interpretation\">\n**Step 5: 生成情境解讀**\n\n根據投影結果生成解讀：\n\n```python\ninterpretation = {\n    \"macro_story\": generate_macro_story(scenario, projection),\n    \"ust_duration_implications\": [\n        generate_supply_pressure_analysis(projection),\n        generate_risk_aversion_analysis(scenario)\n    ],\n    \"watchlist_switch_indicators\": [\n        \"信用利差/金融壓力指數是否急升（避險力道）\",\n        \"通膨預期是否黏著（長端期限溢酬）\",\n        \"國債拍賣尾差/投標倍數（供給壓力顯性化）\"\n    ]\n}\n```\n</step>\n\n<step name=\"6_output\">\n**Step 6: 輸出結果**\n\n執行情境推演：\n```bash\npython scripts/analyzer.py \\\n    --scenario '{\"horizon_quarters\": 8, \"gdp_path\": \"high_gdp_sticky\", \"unemployment_shock\": {\"type\": \"rate_jump\", \"size\": 1.5, \"speed\": \"fast\"}}' \\\n    --model event_study_banding \\\n    --output scenario_result.json\n```\n</step>\n\n</process>\n\n<success_criteria>\n情境推演完成時：\n- [ ] 情境參數已正確解析\n- [ ] 成功映射到歷史樣本（≥3 個事件）\n- [ ] 產出赤字/GDP 投影區間\n- [ ] 生成情境解讀與 UST 影響分析\n- [ ] 輸出包含所有必要欄位\n</success_criteria>\n",
        "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/workflows/ust-risk.md": "<required_reading>\n**執行前請先閱讀：**\n1. references/methodology.md - 了解雙通道風險框架\n2. templates/output-markdown.md - 了解報告格式\n</required_reading>\n\n<objective>\n生成專注於長天期美債（UST）供給/利率風險的深度報告，包含：\n- 供給壓力通道分析（赤字 → 發債 → 期限溢酬）\n- 避險買盤通道分析（風險趨避 → 債券買盤）\n- 兩股力量的主導性判斷指標\n- 監控建議與切換訊號\n</objective>\n\n<process>\n\n<step name=\"1_run_base_analysis\">\n**Step 1: 執行基礎情境分析**\n\n首先取得赤字/GDP 投影結果：\n```bash\npython scripts/analyzer.py --quick --output base_result.json\n```\n\n或使用自訂情境：\n```bash\npython scripts/analyzer.py --scenario '{\"horizon_quarters\": 8, \"gdp_path\": \"high_gdp_sticky\", \"unemployment_shock\": {\"type\": \"rate_jump\", \"size\": 1.5, \"speed\": \"fast\"}}' --output base_result.json\n```\n</step>\n\n<step name=\"2_supply_pressure_analysis\">\n**Step 2: 供給壓力通道分析**\n\n分析赤字擴張對長端利率的影響：\n\n**2.1 淨發行估算**：\n```python\n# 赤字/GDP → 年度淨發行額\ngdp_level = 28_000  # 假設 GDP 28 兆美元\ndeficit_gdp_mid = 0.135  # 中位數 13.5%\nnet_issuance = gdp_level * deficit_gdp_mid  # 約 3.78 兆\n\n# 與當前比較\ncurrent_issuance = 2_000  # 假設當前約 2 兆\nissuance_increase = (net_issuance - current_issuance) / current_issuance\n```\n\n**2.2 期限溢酬敏感度**：\n```python\n# 歷史上發債增加與期限溢酬的關係\n# ACM Term Premium 與 Net Issuance 的迴歸係數\nterm_premium_sensitivity = 0.05  # 每增加 1 兆發債，期限溢酬上升約 5 bps\nprojected_term_premium_change = term_premium_sensitivity * (net_issuance - current_issuance) / 1000\n```\n\n**2.3 供給壓力評級**：\n| 赤字/GDP 區間 | 供給壓力等級 | 期限溢酬影響估計 |\n|---------------|--------------|------------------|\n| < 8%          | 低           | 有限             |\n| 8% - 12%      | 中           | +20-40 bps       |\n| 12% - 16%     | 高           | +40-80 bps       |\n| > 16%         | 極高         | +80-120+ bps     |\n</step>\n\n<step name=\"3_risk_aversion_analysis\">\n**Step 3: 避險買盤通道分析**\n\n分析勞動轉弱對避險需求的影響：\n\n**3.1 歷史參照**：\n```python\n# 過去勞動轉弱期間的債券買盤流入\nhistorical_episodes = [\n    {\"period\": \"2008-2009\", \"tlt_return\": \"+33%\", \"10y_yield_change\": \"-200 bps\"},\n    {\"period\": \"2020 Q1\", \"tlt_return\": \"+21%\", \"10y_yield_change\": \"-150 bps\"},\n]\n```\n\n**3.2 避險力道指標**：\n- **VIX**：> 25 表示避險需求上升\n- **信用利差**：IG 利差擴大 > 50 bps\n- **股債相關性**：轉為負相關表示避險模式\n\n**3.3 避險壓力評級**：\n| 指標組合                     | 避險力道等級 | 對長端的影響     |\n|------------------------------|--------------|------------------|\n| VIX < 20, 利差穩定           | 低           | 避險買盤有限     |\n| VIX 20-30, 利差小幅擴大      | 中           | 部分對沖供給壓力 |\n| VIX > 30, 利差大幅擴大       | 高           | 可能主導長端走勢 |\n</step>\n\n<step name=\"4_dominant_force_assessment\">\n**Step 4: 主導力量判斷**\n\n建立判斷框架：\n\n```\n供給壓力 vs 避險買盤：誰主導？\n\n┌────────────────────────────────────────────────────────────┐\n│                                                             │\n│   供給主導區                        避險主導區              │\n│   ┌─────────┐                      ┌─────────┐             │\n│   │ 赤字↑   │                      │ 恐慌↑   │             │\n│   │ VIX正常 │     ←────────────→   │ VIX飆升 │             │\n│   │ 利差穩定│                      │ 利差暴增│             │\n│   └─────────┘                      └─────────┘             │\n│        ↓                                ↓                   │\n│   長端殖利率↑                      長端殖利率↓              │\n│                                                             │\n└────────────────────────────────────────────────────────────┘\n\n判斷指標：\n1. VIX 是否 > 30？\n2. IG 信用利差是否 > +100 bps（從低點）？\n3. 金融壓力指數是否轉正？\n4. 股債相關性是否轉負？\n\n滿足 ≥3 項 → 避險主導\n滿足 ≤1 項 → 供給主導\n滿足 2 項 → 混合/拉鋸\n```\n</step>\n\n<step name=\"5_monitoring_framework\">\n**Step 5: 建立監控框架**\n\n**關鍵監控指標**：\n\n| 指標             | 數據源    | 供給主導訊號      | 避險主導訊號      |\n|------------------|-----------|-------------------|-------------------|\n| VIX              | Yahoo     | < 25              | > 30              |\n| IG 信用利差      | FRED      | 穩定              | 擴大 > 50 bps     |\n| 通膨預期 (5Y5Y)  | FRED      | > 2.5%            | < 2%              |\n| 國債拍賣尾差     | Treasury  | > 2 bps           | < -2 bps          |\n| 外國持有變化     | TIC       | 下降              | 上升              |\n\n**切換訊號**：\n- 供給 → 避險：VIX 突破 30 + 信用利差暴增\n- 避險 → 供給：VIX 回落 < 20 + 拍賣持續疲軟\n</step>\n\n<step name=\"6_generate_report\">\n**Step 6: 生成 UST 風險報告**\n\n使用模板生成報告：\n\n```bash\npython scripts/analyzer.py \\\n    --ust-risk-report \\\n    --input base_result.json \\\n    --output ust_risk_report.md\n```\n\n報告結構：\n1. 執行摘要（當前狀態 + 主要結論）\n2. 供給壓力通道分析\n3. 避險買盤通道分析\n4. 主導力量判斷\n5. 監控指標清單\n6. 情境風險矩陣\n7. 行動建議\n</step>\n\n</process>\n\n<success_criteria>\nUST 風險報告完成時：\n- [ ] 供給壓力通道分析完整（赤字 → 發債 → 期限溢酬）\n- [ ] 避險買盤通道分析完整（指標 + 歷史參照）\n- [ ] 主導力量判斷框架清晰\n- [ ] 監控指標清單可操作\n- [ ] 報告格式符合模板\n</success_criteria>\n",
        "skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios/workflows/visualize.md": "<required_reading>\n**執行前請先閱讀：**\n1. references/data-sources.md - 了解 FRED 系列代碼\n2. references/methodology.md - 了解事件識別邏輯\n</required_reading>\n\n<objective>\n生成三軸視覺化圖表，顯示勞動市場與財政赤字的關聯：\n- 歷史數據曲線（職缺、失業、赤字/GDP）\n- 歷史 crossover 事件標註（失業 > 職缺時的赤字跳升）\n- 情境模擬投影（mild/moderate/severe）\n- 衰退期灰色陰影\n</objective>\n\n<process>\n\n<step name=\"1_setup\">\n**Step 1: 環境準備**\n\n確認 Python 環境與依賴：\n```bash\ncd skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios\npip install pandas numpy requests matplotlib\n```\n\n確認視覺化參數：\n```python\nparams = {\n    \"years\": 25,              # 回看年數\n    \"scenario\": \"moderate\",   # 情境類型: mild, moderate, severe, none\n    \"horizon\": 24,            # 情境投影月數\n    \"output\": None,           # 輸出路徑（None 則自動生成）\n    \"show_annotations\": True, # 顯示標註\n}\n```\n</step>\n\n<step name=\"2_fetch_data\">\n**Step 2: 抓取視覺化所需數據**\n\n主要需要四個 FRED 系列：\n- `UNRATE`: 失業率（用於 薩姆規則）\n- `UNEMPLOY`: 失業人數（千人）\n- `JTSJOL`: 職缺數（千人）\n- `FYFSGDA188S`: 財政赤字/GDP（%）\n\n執行：\n```bash\npython scripts/visualizer.py --years 25\n```\n\n或在分析時一併生成：\n```bash\npython scripts/analyzer.py --visualize --scenario-type moderate\n```\n</step>\n\n<step name=\"3_identify_events\">\n**Step 3: 識別 Crossover 事件**\n\ncrossover 事件定義：失業人數 > 職缺數\n\n對每個事件記錄：\n- 開始/結束日期\n- 事件期間的赤字/GDP 起始值\n- 事件期間的赤字/GDP 峰值\n- 赤字跳升幅度（bps）\n\n歷史上的主要 crossover 事件：\n- 2001-2003：Dot-com 衰退，赤字跳升約 600 bps\n- 2008-2010：金融危機，赤字跳升約 800-1200 bps\n- 2020-2021：COVID，赤字跳升超過 1000 bps\n</step>\n\n<step name=\"4_generate_scenario\">\n**Step 4: 生成情境投影**\n\n三種情境類型：\n\n| 情境類型 | 失業峰值倍數 | 職缺谷底倍數 | 赤字跳升(pct) |\n|----------|--------------|--------------|---------------|\n| mild     | 1.3x         | 0.85x        | +4.0%         |\n| moderate | 1.6x         | 0.70x        | +6.0%         |\n| severe   | 2.0x         | 0.50x        | +10.0%        |\n\n投影使用 S 曲線（logistic）模擬漸進式變化。\n</step>\n\n<step name=\"5_plot_chart\">\n**Step 5: 繪製圖表**\n\n圖表元素：\n1. **左軸**：失業人數（紅色）、職缺數（藍色）\n2. **右軸**：財政赤字/GDP（綠色）\n3. **衰退陰影**：灰色背景（NBER 衰退期）\n4. **事件標註**：歷史 crossover 事件的赤字跳升幅度\n5. **情境投影**：虛線顯示未來路徑\n\n執行完整視覺化：\n```bash\npython scripts/visualizer.py \\\n    --scenario moderate \\\n    --years 25 \\\n    --output output/my_chart.png\n```\n</step>\n\n<step name=\"6_validate\">\n**Step 6: 驗證輸出**\n\n確認圖表包含：\n- [ ] 三條歷史曲線正確顯示\n- [ ] 左右軸刻度合理\n- [ ] 衰退期陰影正確標記\n- [ ] 事件標註文字清晰可讀\n- [ ] 情境投影虛線延伸到未來\n- [ ] 圖例完整\n- [ ] 資料來源標註\n\n確認 JSON 摘要檔案包含：\n- [ ] 當前指標數值\n- [ ] 歷史事件統計\n- [ ] 情境投影參數\n</step>\n\n</process>\n\n<scenario_types>\n\n**Mild 情境**\n- 假設：勞動市場小幅轉弱，失業增加 30%，職缺減少 15%\n- 赤字影響：+400 bps（從 6% 到 10%）\n- 適用場景：軟著陸、輕微經濟放緩\n\n**Moderate 情境（預設）**\n- 假設：勞動市場明顯轉弱，失業增加 60%，職缺減少 30%\n- 赤字影響：+600 bps（從 6% 到 12%）\n- 適用場景：典型衰退\n\n**Severe 情境**\n- 假設：勞動市場嚴重惡化，失業翻倍，職缺減半\n- 赤字影響：+1000 bps（從 6% 到 16%+）\n- 適用場景：金融危機級別衰退\n\n</scenario_types>\n\n<command_reference>\n\n**直接使用視覺化腳本**\n```bash\n# 基本用法\npython scripts/visualizer.py\n\n# 指定情境\npython scripts/visualizer.py --scenario severe\n\n# 指定輸出路徑\npython scripts/visualizer.py --output my_chart.png\n\n# 不顯示標註\npython scripts/visualizer.py --no-annotations\n\n# 輸出 JSON 摘要\npython scripts/visualizer.py --json summary.json\n```\n\n**透過分析器整合**\n```bash\n# 分析 + 視覺化\npython scripts/analyzer.py --visualize\n\n# 完整參數\npython scripts/analyzer.py \\\n    --lookback 30 \\\n    --visualize \\\n    --scenario-type moderate \\\n    --chart-output chart.png \\\n    --no-show  # 不顯示圖表（僅保存）\n```\n\n</command_reference>\n\n<success_criteria>\n工作流程完成時：\n- [ ] 成功抓取 FRED 數據\n- [ ] 識別出歷史 crossover 事件\n- [ ] 生成情境投影數據\n- [ ] 輸出 PNG 圖表檔案\n- [ ] 輸出 JSON 摘要檔案\n- [ ] 圖表風格符合 FRED 參考樣式\n</success_criteria>\n",
        "skills/analyze-investment-clock-rotation/SKILL.md": "---\nname: analyze-investment-clock-rotation\ndescription: 把「獲利成長 × 財務狀況（金融環境）」映射成「投資時鐘」，判斷目前落在哪個象限、近期是順時針還是逆時針旋轉、以及相對於上一輪循環的位置差異。\n---\n\n<essential_principles>\n\n<principle name=\"quadrant_model\">\n**四象限模型核心**\n\n投資時鐘將市場狀態簡化為四個象限：\n\n```\n          金融環境支持（寬鬆）\n                ↑\n       Q3      │      Q1\n     修復過渡   │   理想象限\n  ────────────┼────────────→ 獲利成長\n       Q4      │      Q2\n     最差象限   │   好壞混合\n                │\n          金融環境不支持（緊縮）\n```\n\n| 象限 | 獲利 | 金融環境 | 含義 | 配置建議 |\n|------|------|----------|------|----------|\n| Q1 理想象限 | ↑ | 支持↑ | 風險資產友善 | 偏多、順風配置 |\n| Q2 好壞混合 | ↑ | 不支持↓ | 估值壓力、波動 | 波動管理、估值敏感 |\n| Q3 修復過渡 | ↓ | 支持↑ | 寬鬆救市、基本面未回 | 勿誤判為全面牛市 |\n| Q4 最差象限 | ↓ | 不支持↓ | 風險資產易受傷 | 風險控管、降槓桿 |\n</principle>\n\n<principle name=\"axis_convention\">\n**軸向約定（重要！）**\n\n不同來源的投資時鐘圖可能有不同的軸向定義。本 skill 預設：\n\n- **X 軸**：金融環境（Financial Conditions）\n  - 左側 = 寬鬆（支持性高）\n  - 右側 = 緊縮（支持性低）\n\n- **Y 軸**：獲利成長（Earnings Growth）\n  - 上方 = 正成長\n  - 下方 = 負成長\n\n**若你的圖表定義不同**，請在輸入參數中調整 `axis_mapping` 和 `clock_convention`。\n</principle>\n\n<principle name=\"clock_hour\">\n**時鐘點位計算**\n\n透過 `atan2(y, x)` 計算角度，再轉換成 12 小時制：\n\n- 12 點：正上方（獲利最高、金融環境中性）\n- 3 點：右側（金融環境最緊）\n- 6 點：正下方（獲利最低）\n- 9 點：左側（金融環境最寬鬆）\n\n**旋轉方向**：\n- 順時針：典型景氣循環路徑（Q1 → Q2 → Q4 → Q3 → Q1）\n- 逆時針：政策干預或非典型事件\n</principle>\n\n<principle name=\"data_access\">\n**資料取得方式**\n\n本 skill 使用**無需 API key** 的資料來源：\n\n- **FRED CSV**: `https://fred.stlouisfed.org/graph/fredgraph.csv?id={SERIES_ID}`\n  - 金融環境：NFCI（Chicago Fed）、STLFSI4（St. Louis Fed）\n  - 獲利代理：CP（企業利潤）、GDP 相關指標\n\n腳本位於 `scripts/` 目錄，可直接執行。\n</principle>\n\n</essential_principles>\n\n<objective>\n實作投資時鐘分析：\n\n1. **建構座標**：從 FRED 數據計算獲利成長與金融環境 Z-score\n2. **判定象限**：識別當前落在哪個象限\n3. **計算點位**：轉換為 12 小時制時鐘點位\n4. **分析旋轉**：判斷旋轉方向與幅度\n5. **循環比較**：與前一輪循環比較（可選）\n\n輸出：當前象限、時鐘點位、旋轉摘要、配置建議。\n</objective>\n\n<quick_start>\n\n**最快的方式：執行預設分析**\n\n```bash\ncd skills/analyze-investment-clock-rotation\npip install pandas numpy requests  # 首次使用\npython scripts/investment_clock.py --quick\n```\n\n輸出範例：\n```json\n{\n  \"as_of\": \"2026-01-15\",\n  \"current_position\": {\n    \"clock_hour\": 10,\n    \"quadrant\": \"Q1_ideal\",\n    \"earnings_growth\": 0.052,\n    \"financial_conditions_zscore\": -0.35\n  },\n  \"interpretation\": \"理想象限，風險資產相對順風\"\n}\n```\n\n**完整分析**：\n```bash\npython scripts/investment_clock.py \\\n  --start 2022-01-01 \\\n  --end 2026-01-19 \\\n  --compare-cycle 2020-01-01 2022-12-31 \\\n  --output result.json\n```\n\n</quick_start>\n\n<intake>\n需要進行什麼操作？\n\n1. **快速檢查** - 查看目前的投資時鐘位置與象限\n2. **完整分析** - 分析時間區間內的旋轉路徑與方向\n3. **循環比較** - 與前一輪循環比較旋轉特徵\n4. **視覺化圖表** - 生成投資時鐘視覺化圖表\n5. **方法論學習** - 了解投資時鐘模型的邏輯\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                       | Action                                             |\n|--------------------------------|----------------------------------------------------|\n| 1, \"快速\", \"quick\", \"check\"    | 執行 `python scripts/investment_clock.py --quick`  |\n| 2, \"完整\", \"分析\", \"full\"      | 閱讀 `workflows/analyze.md` 並執行                 |\n| 3, \"比較\", \"循環\", \"compare\"   | 閱讀 `workflows/compare-cycle.md` 並執行           |\n| 4, \"視覺化\", \"chart\", \"plot\"   | 閱讀 `workflows/visualize.md` 並執行               |\n| 5, \"學習\", \"方法論\", \"why\"     | 閱讀 `references/methodology.md`                   |\n| 提供參數 (如日期範圍)          | 閱讀 `workflows/analyze.md` 並使用參數執行         |\n\n**路由後，閱讀對應文件並執行。**\n</routing>\n\n<directory_structure>\n```\nanalyze-investment-clock-rotation/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元數據\n├── workflows/\n│   ├── analyze.md                     # 完整分析工作流\n│   ├── compare-cycle.md               # 循環比較工作流\n│   └── visualize.md                   # 視覺化工作流\n├── references/\n│   ├── methodology.md                 # 投資時鐘方法論\n│   ├── data-sources.md                # FRED 系列代碼與資料來源\n│   └── input-schema.md                # 完整輸入參數定義\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n└── scripts/\n    ├── investment_clock.py            # 主分析腳本\n    ├── fetch_data.py                  # 數據抓取工具\n    └── visualize.py                   # 視覺化繪圖工具\n```\n</directory_structure>\n\n<reference_index>\n\n**方法論**: references/methodology.md\n- 投資時鐘概念與歷史\n- 四象限定義與配置含義\n- 旋轉方向解讀\n\n**資料來源**: references/data-sources.md\n- FRED 系列代碼（金融環境/獲利代理）\n- 數據頻率與對齊方法\n\n**輸入參數**: references/input-schema.md\n- 完整參數定義\n- 預設值與建議範圍\n\n</reference_index>\n\n<workflows_index>\n| Workflow          | Purpose              | 使用時機               |\n|-------------------|----------------------|------------------------|\n| analyze.md        | 完整分析             | 需要詳細象限與旋轉分析 |\n| compare-cycle.md  | 循環比較             | 比較不同循環的特徵     |\n| visualize.md      | 生成視覺化圖表       | 需要圖表展示           |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構定義 |\n| output-markdown.md | Markdown 報告模板 |\n</templates_index>\n\n<scripts_index>\n| Script               | Command                          | Purpose              |\n|----------------------|----------------------------------|----------------------|\n| investment_clock.py  | `--quick`                        | 快速檢查當前位置     |\n| investment_clock.py  | `--start DATE --end DATE`        | 完整分析             |\n| investment_clock.py  | `--compare-cycle START END`      | 循環比較             |\n| fetch_data.py        | `--series NFCI,CP`               | 抓取 FRED 資料       |\n| visualize.py         | `-i result.json -o chart.png`    | 生成視覺化圖表       |\n</scripts_index>\n\n<input_schema_summary>\n\n**核心參數**\n\n| 參數                    | 類型   | 預設值           | 說明               |\n|-------------------------|--------|------------------|--------------------|\n| market                  | string | US_EQUITY        | 分析標的           |\n| start_date              | string | 2022-01-01       | 分析起點           |\n| end_date                | string | today            | 分析終點           |\n| freq                    | string | weekly           | 頻率（weekly/monthly） |\n\n**資料來源參數**\n\n| 參數                    | 類型   | 說明                      |\n|-------------------------|--------|---------------------------|\n| earnings_series.source  | string | fred / api / csv / manual |\n| earnings_series.series_id | string | FRED 序列 ID（如 CP）     |\n| earnings_series.growth_method | string | yoy / qoq_annualized  |\n| financial_conditions_series.source | string | fred / api / csv |\n| financial_conditions_series.series_id | string | NFCI / STLFSI4 |\n| financial_conditions_series.transform | string | level / zscore / inverse |\n\n**軸向參數**\n\n| 參數                       | 類型   | 預設值              | 說明                 |\n|----------------------------|--------|---------------------|----------------------|\n| axis_mapping.x             | string | financial_conditions | X 軸定義            |\n| axis_mapping.y             | string | earnings_growth      | Y 軸定義            |\n| clock_convention.financial_loose_is_left | bool | true | 寬鬆在左側 |\n\n完整參數定義見 `references/input-schema.md`。\n\n</input_schema_summary>\n\n<output_schema_summary>\n```json\n{\n  \"skill\": \"analyze-investment-clock-rotation\",\n  \"as_of\": \"2026-01-19\",\n  \"market\": \"US_EQUITY\",\n  \"current_state\": {\n    \"clock_hour\": 10,\n    \"quadrant\": \"Q1_ideal\",\n    \"quadrant_name\": \"理想象限\",\n    \"x_value\": -0.35,\n    \"y_value\": 0.052\n  },\n  \"rotation_summary\": {\n    \"from_hour\": 2,\n    \"to_hour\": 10,\n    \"direction\": \"clockwise\",\n    \"magnitude_degrees\": 240\n  },\n  \"interpretation\": \"獲利成長為正，金融環境偏支持，屬於風險資產相對順風的象限\"\n}\n```\n\n完整輸出結構見 `templates/output-json.md`。\n</output_schema_summary>\n\n<success_criteria>\n執行成功時應產出：\n\n- [ ] 當前象限（Q1/Q2/Q3/Q4）\n- [ ] 時鐘點位（1-12 點）\n- [ ] 獲利成長值與金融環境 Z-score\n- [ ] 旋轉方向（順時針/逆時針）\n- [ ] 旋轉幅度（度數）\n- [ ] 配置建議（依象限）\n- [ ] 循環比較摘要（若有啟用）\n- [ ] 視覺化圖表（可選，輸出至 `output/` 目錄）\n</success_criteria>\n",
        "skills/analyze-investment-clock-rotation/references/data-sources.md": "# 資料來源\n\n## FRED 資料來源\n\n本 skill 主要使用 FRED（Federal Reserve Economic Data）公開資料，無需 API key。\n\n### 獲取方式\n\n**CSV Endpoint（推薦）**：\n```\nhttps://fred.stlouisfed.org/graph/fredgraph.csv?id={SERIES_ID}&cosd={START}&coed={END}\n```\n\n範例：\n```bash\n# 抓取 NFCI 從 2020-01-01 到 2026-01-01\ncurl \"https://fred.stlouisfed.org/graph/fredgraph.csv?id=NFCI&cosd=2020-01-01&coed=2026-01-01\"\n```\n\n---\n\n## 金融環境指標\n\n### NFCI - Chicago Fed National Financial Conditions Index\n\n| 屬性 | 值 |\n|------|-----|\n| FRED ID | `NFCI` |\n| 頻率 | 週度（Weekly） |\n| 單位 | Index |\n| 原始定義 | 正值 = 緊縮，負值 = 寬鬆 |\n| 歷史起點 | 1971-01-08 |\n\n**說明**：\n- 綜合 105 項金融市場指標\n- 涵蓋風險、信用、槓桿三個子指數\n- 0 代表歷史平均水平\n- 適合週度分析\n\n**使用方式**：\n```python\n# 反轉方向讓正值代表「支持性」\nfci_support = -nfci\n```\n\n### STLFSI4 - St. Louis Fed Financial Stress Index\n\n| 屬性 | 值 |\n|------|-----|\n| FRED ID | `STLFSI4` |\n| 頻率 | 週度（Weekly） |\n| 單位 | Index |\n| 原始定義 | 正值 = 壓力高，負值 = 壓力低 |\n| 歷史起點 | 1993-12-31 |\n\n**說明**：\n- 聚焦於金融壓力/風險\n- 適合危機預警\n- 與 NFCI 方向一致\n\n### ANFCI - Adjusted National Financial Conditions Index\n\n| 屬性 | 值 |\n|------|-----|\n| FRED ID | `ANFCI` |\n| 頻率 | 週度（Weekly） |\n| 單位 | Index |\n| 原始定義 | 正值 = 緊縮 |\n| 歷史起點 | 1971-01-08 |\n\n**說明**：\n- 調整過的 NFCI\n- 移除經濟週期影響\n- 更純粹反映金融條件\n\n---\n\n## 獲利成長指標\n\n### CP - Corporate Profits After Tax\n\n| 屬性 | 值 |\n|------|-----|\n| FRED ID | `CP` |\n| 頻率 | 季度（Quarterly） |\n| 單位 | Billions of Dollars |\n| 季節調整 | Seasonally Adjusted Annual Rate |\n| 歷史起點 | 1947-01-01 |\n\n**說明**：\n- 最直接的企業獲利指標\n- 涵蓋所有美國企業\n- 適合計算 YoY 成長率\n\n**計算 YoY**：\n```python\n# 季度數據，用 4 期計算 YoY\nearnings_yoy = (cp / cp.shift(4)) - 1\n```\n\n### A261RX1Q020SBEA - Real GDP per Capita\n\n| 屬性 | 值 |\n|------|-----|\n| FRED ID | `A261RX1Q020SBEA` |\n| 頻率 | 季度（Quarterly） |\n| 單位 | Chained 2017 Dollars |\n| 歷史起點 | 1947-01-01 |\n\n**說明**：\n- 實質 GDP 人均\n- 可作為獲利成長的代理變數\n- 較為平滑\n\n### INDPRO - Industrial Production Index\n\n| 屬性 | 值 |\n|------|-----|\n| FRED ID | `INDPRO` |\n| 頻率 | 月度（Monthly） |\n| 單位 | Index 2017=100 |\n| 歷史起點 | 1919-01-01 |\n\n**說明**：\n- 製造業獲利的代理\n- 月度頻率較高\n- 與企業利潤高度相關\n\n---\n\n## 資料頻率對齊\n\n### 週度 ↔ 季度對齊\n\n**方法 A：將週度降採樣到季度**\n\n```python\n# 取季度最後一個觀測值\nnfci_quarterly = nfci.resample('Q').last()\n\n# 或取季度平均\nnfci_quarterly = nfci.resample('Q').mean()\n```\n\n**方法 B：將季度升採樣到週度**\n\n```python\n# 前向填充\nearnings_weekly = earnings.resample('W').ffill()\n```\n\n### 建議做法\n\n| 分析目的 | 建議頻率 | 對齊方法 |\n|----------|----------|----------|\n| 長期趨勢 | 季度 | 週度降採樣 |\n| 短期監控 | 週度 | 季度升採樣（ffill） |\n| 回測 | 月度 | 折衷方案 |\n\n---\n\n## 替代資料來源\n\n### MacroMicro 財經 M 平方\n\n若需要更多指標或視覺化，可參考 MacroMicro：\n\n| 圖表 | URL | 說明 |\n|------|-----|------|\n| 美國金融狀況 | `/charts/xxx` | 綜合金融狀況圖 |\n| 企業利潤 | `/charts/xxx` | 企業利潤趨勢 |\n\n**注意**：MacroMicro 需要使用 Selenium 爬蟲，詳見 `thoughts/shared/guide/macromicro-highcharts-crawler.md`。\n\n### Bloomberg / Refinitiv\n\n若有付費訂閱，可使用：\n- Bloomberg: `NFCI Index`\n- Refinitiv: 對應代碼\n\n---\n\n## 資料品質檢查\n\n### 必要檢查項目\n\n```python\ndef validate_data(df):\n    checks = {\n        \"no_nulls\": df.isnull().sum().sum() == 0,\n        \"no_duplicates\": not df.index.duplicated().any(),\n        \"sorted_index\": df.index.is_monotonic_increasing,\n        \"reasonable_range\": {\n            \"nfci\": df[\"nfci\"].between(-5, 5).all(),\n            \"earnings_yoy\": df[\"earnings_yoy\"].between(-0.5, 0.5).all()\n        }\n    }\n    return checks\n```\n\n### 缺失值處理\n\n| 情況 | 建議處理 |\n|------|----------|\n| 單一缺失 | 線性內插 |\n| 連續缺失 < 4 期 | 前向填充 |\n| 連續缺失 >= 4 期 | 標記為無效區間 |\n\n---\n\n## 快速抓取範例\n\n```python\nimport pandas as pd\n\ndef fetch_fred_csv(series_id, start_date, end_date):\n    \"\"\"從 FRED 抓取 CSV 資料\"\"\"\n    url = f\"https://fred.stlouisfed.org/graph/fredgraph.csv\"\n    params = {\n        \"id\": series_id,\n        \"cosd\": start_date,\n        \"coed\": end_date\n    }\n    query = \"&\".join(f\"{k}={v}\" for k, v in params.items())\n    full_url = f\"{url}?{query}\"\n\n    df = pd.read_csv(full_url, parse_dates=[\"DATE\"], index_col=\"DATE\")\n    df.columns = [series_id]\n    return df\n\n# 使用範例\nnfci = fetch_fred_csv(\"NFCI\", \"2020-01-01\", \"2026-01-19\")\ncp = fetch_fred_csv(\"CP\", \"2020-01-01\", \"2026-01-19\")\n```\n",
        "skills/analyze-investment-clock-rotation/references/input-schema.md": "# 輸入參數定義\n\n## 完整輸入 Schema\n\n```json\n{\n  \"market\": \"US_EQUITY\",\n  \"start_date\": \"2022-01-01\",\n  \"end_date\": \"2026-01-19\",\n\n  \"earnings_series\": {\n    \"source\": \"fred\",\n    \"series_id\": \"CP\",\n    \"field\": \"value\",\n    \"growth_method\": \"yoy\"\n  },\n\n  \"financial_conditions_series\": {\n    \"source\": \"fred\",\n    \"series_id\": \"NFCI\",\n    \"transform\": \"inverse\"\n  },\n\n  \"freq\": \"weekly\",\n  \"z_window\": 52,\n\n  \"smoothing\": {\n    \"method\": \"moving_average\",\n    \"window\": 4\n  },\n\n  \"axis_mapping\": {\n    \"x\": \"financial_conditions\",\n    \"y\": \"earnings_growth\"\n  },\n\n  \"clock_convention\": {\n    \"financial_loose_is_left\": true,\n    \"supportive_is_up\": true\n  },\n\n  \"compare_cycle\": {\n    \"enabled\": false,\n    \"cycle_start\": null,\n    \"cycle_end\": null\n  }\n}\n```\n\n---\n\n## 核心參數\n\n### market\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 必要 | 是 |\n| 預設值 | `\"US_EQUITY\"` |\n| 可選值 | `US_EQUITY`, `GLOBAL`, `EU`, `EM` |\n\n分析標的或市場區域。影響資料來源選擇。\n\n### start_date / end_date\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string (ISO 8601 date) |\n| 必要 | 是 |\n| 格式 | `YYYY-MM-DD` |\n\n分析時間區間。\n\n---\n\n## 獲利成長參數 (earnings_series)\n\n### source\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 必要 | 是 |\n| 可選值 | `fred`, `api`, `csv`, `manual` |\n\n資料來源類型。\n\n### series_id\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 必要 | 若 source 為 fred/api |\n| 範例 | `\"CP\"`, `\"GDPC1\"`, `\"INDPRO\"` |\n\n資料序列 ID。\n\n### growth_method\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 必要 | 是 |\n| 預設值 | `\"yoy\"` |\n| 可選值 | `yoy`, `qoq_annualized`, `rolling_4q_yoy` |\n\n成長率計算方法。\n\n| 方法 | 說明 | 公式 |\n|------|------|------|\n| `yoy` | 年對年 | `(E[t] / E[t-1y]) - 1` |\n| `qoq_annualized` | 季對季年化 | `((E[t] / E[t-1q]) ** 4) - 1` |\n| `rolling_4q_yoy` | 滾動四季同比 | `(sum(E[t-3:t]) / sum(E[t-7:t-4])) - 1` |\n\n---\n\n## 金融環境參數 (financial_conditions_series)\n\n### source\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 必要 | 是 |\n| 可選值 | `fred`, `api`, `csv`, `manual` |\n\n### series_id\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 必要 | 若 source 為 fred/api |\n| 範例 | `\"NFCI\"`, `\"STLFSI4\"`, `\"ANFCI\"` |\n\n### transform\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 必要 | 否 |\n| 預設值 | `\"level\"` |\n| 可選值 | `level`, `zscore`, `inverse` |\n\n轉換方式。\n\n| 轉換 | 說明 | 使用時機 |\n|------|------|----------|\n| `level` | 原始值 | 已標準化的指標 |\n| `zscore` | 滾動 Z-score | 未標準化的原始數據 |\n| `inverse` | 反轉方向 | 原始定義與預期相反 |\n\n---\n\n## 頻率與平滑參數\n\n### freq\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 必要 | 否 |\n| 預設值 | `\"weekly\"` |\n| 可選值 | `weekly`, `monthly` |\n\n分析頻率。影響 Z-score 視窗單位。\n\n### z_window\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | integer |\n| 必要 | 否 |\n| 預設值 | `52`（週頻）或 `12`（月頻） |\n| 建議範圍 | 36-104（週），12-60（月） |\n\nZ-score 滾動視窗長度。\n\n### smoothing\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | object |\n| 必要 | 否 |\n\n#### smoothing.method\n\n| 可選值 | 說明 |\n|--------|------|\n| `none` | 不平滑 |\n| `moving_average` | 移動平均 |\n| `ema` | 指數移動平均 |\n\n#### smoothing.window\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | integer |\n| 預設值 | `4` |\n| 建議範圍 | 2-8 |\n\n---\n\n## 軸向參數 (axis_mapping)\n\n### x / y\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 可選值 | `earnings_growth`, `financial_conditions` |\n\n指定 X 軸和 Y 軸分別代表什麼變數。\n\n**預設**：\n- `x`: `financial_conditions`\n- `y`: `earnings_growth`\n\n**注意**：不同來源的圖表可能有不同定義，請確認後調整。\n\n---\n\n## 時鐘約定 (clock_convention)\n\n### financial_loose_is_left\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | boolean |\n| 預設值 | `true` |\n\n是否將金融環境「寬鬆」放在左側（負 X）。\n\n### supportive_is_up\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | boolean |\n| 預設值 | `true` |\n\n是否將「支持性更高」放在上方。\n\n**組合效果**：\n\n| loose_is_left | supportive_is_up | 象限配置 |\n|---------------|------------------|----------|\n| true | true | Q3 左上, Q1 右上, Q4 左下, Q2 右下 |\n| false | true | Q1 左上, Q3 右上, Q2 左下, Q4 右下 |\n\n---\n\n## 循環比較參數 (compare_cycle)\n\n### enabled\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | boolean |\n| 預設值 | `false` |\n\n是否啟用前一輪循環比較。\n\n### cycle_start / cycle_end\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string (ISO 8601 date) |\n| 必要 | 若 enabled=true |\n\n前一輪循環的起止日期。\n\n---\n\n## 參數驗證規則\n\n```python\ndef validate_params(params):\n    errors = []\n\n    # 日期驗證\n    if params[\"start_date\"] >= params[\"end_date\"]:\n        errors.append(\"start_date must be before end_date\")\n\n    # 成長方法驗證\n    valid_growth_methods = [\"yoy\", \"qoq_annualized\", \"rolling_4q_yoy\"]\n    if params[\"earnings_series\"][\"growth_method\"] not in valid_growth_methods:\n        errors.append(f\"Invalid growth_method: {params['earnings_series']['growth_method']}\")\n\n    # 軸向驗證\n    valid_axes = [\"earnings_growth\", \"financial_conditions\"]\n    if params[\"axis_mapping\"][\"x\"] not in valid_axes:\n        errors.append(f\"Invalid x axis: {params['axis_mapping']['x']}\")\n    if params[\"axis_mapping\"][\"y\"] not in valid_axes:\n        errors.append(f\"Invalid y axis: {params['axis_mapping']['y']}\")\n    if params[\"axis_mapping\"][\"x\"] == params[\"axis_mapping\"][\"y\"]:\n        errors.append(\"x and y axes must be different\")\n\n    # Z-window 驗證\n    if params[\"z_window\"] < 12:\n        errors.append(\"z_window should be at least 12 for meaningful standardization\")\n\n    return errors\n```\n\n---\n\n## 預設配置範例\n\n### 美股週度分析\n\n```json\n{\n  \"market\": \"US_EQUITY\",\n  \"earnings_series\": {\n    \"source\": \"fred\",\n    \"series_id\": \"CP\",\n    \"growth_method\": \"yoy\"\n  },\n  \"financial_conditions_series\": {\n    \"source\": \"fred\",\n    \"series_id\": \"NFCI\",\n    \"transform\": \"inverse\"\n  },\n  \"freq\": \"weekly\",\n  \"z_window\": 52\n}\n```\n\n### 月度長期分析\n\n```json\n{\n  \"market\": \"US_EQUITY\",\n  \"earnings_series\": {\n    \"source\": \"fred\",\n    \"series_id\": \"CP\",\n    \"growth_method\": \"yoy\"\n  },\n  \"financial_conditions_series\": {\n    \"source\": \"fred\",\n    \"series_id\": \"NFCI\",\n    \"transform\": \"inverse\"\n  },\n  \"freq\": \"monthly\",\n  \"z_window\": 36,\n  \"smoothing\": {\n    \"method\": \"moving_average\",\n    \"window\": 3\n  }\n}\n```\n",
        "skills/analyze-investment-clock-rotation/references/methodology.md": "投資時鐘（Investment Clock）概念源自美林證券（Merrill Lynch），後被廣泛應用於資產配置與景氣循環分析。核心理念是將經濟環境映射到二維平面，透過位置與旋轉方向判斷最有利的資產類別。\n\n## 四象限模型\n\n### 座標系定義\n\n```\n              金融環境支持（寬鬆）\n                    ↑\n                    │\n           Q3      │      Q1\n         修復過渡   │   理想象限\n                    │\n    ←───────────────┼───────────────→ 獲利成長\n    負成長          │          正成長\n           Q4      │      Q2\n         最差象限   │   好壞混合\n                    │\n                    ↓\n              金融環境不支持（緊縮）\n```\n\n### 各象限定義\n\n| 象限   | 名稱     | 獲利成長 | 金融環境 | 經濟特徵                   |\n|--------|----------|----------|----------|----------------------------|\n| **Q1** | 理想象限 | 正成長 ↑ | 支持性 ↑ | 景氣擴張、流動性充裕       |\n| **Q2** | 好壞混合 | 正成長 ↑ | 不支持 ↓ | 獲利好但估值壓力、波動上升 |\n| **Q3** | 修復過渡 | 負成長 ↓ | 支持性 ↑ | 政策寬鬆救市、基本面未回   |\n| **Q4** | 最差象限 | 負成長 ↓ | 不支持 ↓ | 衰退、緊縮、風險資產承壓   |\n\n### 配置含義\n\n| 象限   | 有利資產         | 不利資產     | 配置建議           |\n|--------|------------------|--------------|--------------------|\n| **Q1** | 股票、高收債     | 現金、防禦股 | 風險偏好、順勢配置 |\n| **Q2** | 價值股、商品     | 長債、成長股 | 波動管理、估值敏感 |\n| **Q3** | 長債、防禦股     | 週期股、商品 | 謹慎、勿追高       |\n| **Q4** | 現金、短債、黃金 | 股票、高收債 | 風險控管、保守配置 |\n\n## 時鐘旋轉邏輯\n\n### 典型景氣循環路徑（順時針）\n\n```\n12 點：獲利高峰、金融中性\n ↓\n 3 點：獲利下滑、金融開始緊縮\n ↓\n 6 點：獲利谷底、金融最緊\n ↓\n 9 點：獲利復甦、金融轉寬鬆\n ↓\n12 點：回到高峰\n```\n\n### 旋轉方向解讀\n\n| 方向       | 含義         | 典型情境               |\n|------------|--------------|------------------------|\n| **順時針** | 典型景氣循環 | 正常經濟週期           |\n| **逆時針** | 非典型路徑   | 政策干預、外部衝擊     |\n| **停滯**   | 僵局         | 停滯性通膨、結構性問題 |\n\n### 旋轉幅度分類\n\n| 幅度     | 度數範圍    | 解讀                                 |\n|----------|-------------|--------------------------------------|\n| 微幅漂移 | < 90°       | 短期波動，趨勢不明確                 |\n| 中等旋轉 | 90° - 270°  | 正常景氣週期轉換                     |\n| 大幅旋轉 | 270° - 360° | 完整景氣循環                         |\n| 極端旋轉 | > 360°      | 劇烈衝擊後的極端復甦（如 2020 疫情） |\n\n## 數據輸入\n\n### 獲利成長 (Earnings Growth)\n\n**推薦指標**：\n\n| 指標         | FRED ID | 頻率 | 說明                        |\n|--------------|---------|------|-----------------------------|\n| 企業利潤     | CP      | 季度 | Corporate Profits After Tax |\n| 國內生產總值 | GDPC1   | 季度 | Real GDP（作為獲利代理）    |\n| 工業生產     | INDPRO  | 月度 | 製造業獲利代理              |\n\n**計算方法**：\n\n```python\n# 同比成長率 (YoY)\nearnings_growth = (E[t] / E[t-4]) - 1  # 季度數據用 4 期\n\n# 季對季年化\nearnings_growth = ((E[t] / E[t-1]) ** 4) - 1\n```\n\n### 金融環境 (Financial Conditions)\n\n**推薦指標**：\n\n| 指標              | FRED ID | 頻率 | 原始定義    |\n|-------------------|---------|------|-------------|\n| Chicago Fed NFCI  | NFCI    | 週度 | 正值=緊縮   |\n| St. Louis Fed FSI | STLFSI4 | 週度 | 正值=壓力高 |\n| Adjusted NFCI     | ANFCI   | 週度 | 正值=緊縮   |\n\n**標準化方法**：\n\n```python\n# 滾動 Z-score\ndef zscore(s, window):\n    mu = s.rolling(window).mean()\n    sig = s.rolling(window).std()\n    return (s - mu) / sig\n\n# 若原始定義「正=緊縮」，需反轉讓「正=支持性」\nfci_support = -zscore(NFCI, window=52)\n```\n\n## 軸向注意事項\n\n### 常見軸向定義差異\n\n| 來源          | X 軸     | Y 軸     | 注意     |\n|---------------|----------|----------|----------|\n| 本 Skill      | 金融環境 | 獲利成長 | 預設     |\n| 某些機構      | 獲利成長 | 金融環境 | X/Y 互換 |\n| Merrill Lynch | 產出缺口 | 通膨     | 不同變數 |\n\n### 方向定義差異\n\n| 來源     | 「左側」代表 | 「上方」代表 |\n|----------|--------------|--------------|\n| 本 Skill | 金融寬鬆     | 獲利正成長   |\n| 某些圖表 | 金融緊縮     | 獲利正成長   |\n\n**使用前務必確認來源的軸向定義！**\n\n## 模型限制\n\n### 1. 資料延遲\n\n| 指標類型         | 典型延遲 |\n|------------------|----------|\n| 金融環境（週頻） | 1-2 週   |\n| 企業利潤（季頻） | 2-3 個月 |\n| GDP（季頻）      | 1-2 個月 |\n\n### 2. 非線性事件\n\n投資時鐘假設平滑的景氣循環，但以下事件可能導致跳躍：\n- 突發性危機（如 2008 金融危機、2020 疫情）\n- 政策劇變（如大規模 QE）\n- 地緣政治衝擊\n\n### 3. 頻率不匹配\n\n獲利通常是季度數據，金融環境是週度數據，需要對齊處理。\n\n## 歷史循環參考\n\n| 循環     | 期間      | 特徵               | 旋轉幅度  |\n|----------|-----------|--------------------|-----------|\n| 網路泡沫 | 1998-2003 | 先極端樂觀後崩潰   | ~450°     |\n| 金融危機 | 2006-2009 | 信用緊縮主導       | ~360°     |\n| 疫情復甦 | 2020-2022 | 極端衝擊後劇烈反彈 | ~540°     |\n| 典型週期 | 一般      | 平滑漂移           | 180°-270° |\n\n## 進階應用\n\n### 1. 多市場比較\n\n可同時繪製美股、歐股、新興市場的投資時鐘，比較相對位置。\n\n### 2. 情境分析\n\n根據當前位置和旋轉方向，預測未來可能的路徑：\n\n```\n若目前在 Q1（10 點），順時針旋轉\n→ 下一步可能進入 Q2（好壞混合）\n→ 配置上開始關注估值壓力\n```\n\n### 3. 結合其他指標\n\n- 配合 VIX 波動率判斷市場情緒\n- 配合利差曲線判斷信用週期\n- 配合通膨數據完善景氣判讀\n",
        "skills/analyze-investment-clock-rotation/templates/output-json.md": "# JSON 輸出模板 (Output JSON Template)\n\n## 完整輸出結構\n\n```json\n{\n  \"skill\": \"analyze-investment-clock-rotation\",\n  \"version\": \"0.1.0\",\n  \"as_of\": \"2026-01-19\",\n\n  \"market\": \"US_EQUITY\",\n\n  \"window\": {\n    \"start_date\": \"2022-10-01\",\n    \"end_date\": \"2026-01-19\",\n    \"freq\": \"weekly\"\n  },\n\n  \"axis_mapping_used\": {\n    \"x\": \"financial_conditions\",\n    \"y\": \"earnings_growth\"\n  },\n\n  \"current_state\": {\n    \"clock_hour\": 10,\n    \"quadrant\": \"Q1_ideal\",\n    \"quadrant_name\": \"理想象限\",\n    \"x_value\": -0.35,\n    \"y_value\": 0.052,\n    \"interpretation\": \"獲利成長為正，金融環境偏支持，屬於風險資產相對順風的象限；需監控是否開始往金融環境轉緊或獲利轉弱的方向漂移。\"\n  },\n\n  \"rotation_summary\": {\n    \"from_hour\": 2,\n    \"to_hour\": 10,\n    \"from_quadrant\": \"Q2_mixed\",\n    \"to_quadrant\": \"Q1_ideal\",\n    \"direction\": \"clockwise\",\n    \"magnitude_degrees\": 240,\n    \"full_rotations\": 0,\n    \"magnitude_note\": \"本輪旋轉幅度中等（240°），屬於典型景氣循環轉換。\"\n  },\n\n  \"quadrant_time_distribution\": {\n    \"Q1_ideal\": {\n      \"periods\": 45,\n      \"percentage\": 35.4\n    },\n    \"Q2_mixed\": {\n      \"periods\": 30,\n      \"percentage\": 23.6\n    },\n    \"Q3_recovery\": {\n      \"periods\": 25,\n      \"percentage\": 19.7\n    },\n    \"Q4_worst\": {\n      \"periods\": 27,\n      \"percentage\": 21.3\n    }\n  },\n\n  \"cycle_comparison\": {\n    \"enabled\": true,\n    \"previous_cycle\": {\n      \"period\": {\n        \"start\": \"2020-01-01\",\n        \"end\": \"2022-12-31\"\n      },\n      \"rotation_magnitude\": 540,\n      \"rotation_character\": \"large_rotation_after_shock_recovery\",\n      \"note\": \"屬於「先大幅衰退、再劇烈修復」的路徑，和一般循環的平緩漂移不完全同質。\"\n    },\n    \"comparison\": {\n      \"rotation_ratio\": 0.44,\n      \"similar_direction\": true,\n      \"homogeneity\": \"heterogeneous\",\n      \"interpretation\": \"當前循環旋轉幅度約為前一輪的 44%，兩者路徑特徵不同，不宜直接套用上一輪經驗。\"\n    }\n  },\n\n  \"path_characteristics\": {\n    \"volatility\": 1.85,\n    \"smoothness\": \"moderate\",\n    \"dominant_trend\": \"clockwise_drift\",\n    \"reversal_count\": 2,\n    \"max_consecutive_direction\": 35\n  },\n\n  \"implications\": {\n    \"current_quadrant_implication\": \"偏多風險資產、順風配置\",\n    \"rotation_implication\": \"順時針旋轉中，可能朝向 Q2（好壞混合）移動\",\n    \"risk_factors\": [\n      \"若金融環境轉緊（X 軸右移），將進入 Q2 估值壓力區\",\n      \"若獲利成長轉負（Y 軸下移），將進入 Q3 修復過渡區\"\n    ],\n    \"monitoring_points\": [\n      \"NFCI 是否持續為負\",\n      \"企業利潤季報是否維持正成長\"\n    ]\n  },\n\n  \"time_series\": {\n    \"available\": true,\n    \"columns\": [\"date\", \"x\", \"y\", \"hour\", \"quadrant\", \"earnings_growth_raw\", \"fci_raw\"],\n    \"sample\": [\n      {\n        \"date\": \"2026-01-10\",\n        \"x\": -0.32,\n        \"y\": 0.048,\n        \"hour\": 10,\n        \"quadrant\": \"Q1_ideal\"\n      },\n      {\n        \"date\": \"2026-01-17\",\n        \"x\": -0.35,\n        \"y\": 0.052,\n        \"hour\": 10,\n        \"quadrant\": \"Q1_ideal\"\n      }\n    ]\n  },\n\n  \"data_sources\": {\n    \"earnings\": {\n      \"series_id\": \"CP\",\n      \"name\": \"Corporate Profits After Tax\",\n      \"latest_date\": \"2025-09-30\",\n      \"latest_value\": 3250.5,\n      \"growth_method\": \"yoy\"\n    },\n    \"financial_conditions\": {\n      \"series_id\": \"NFCI\",\n      \"name\": \"Chicago Fed NFCI\",\n      \"latest_date\": \"2026-01-17\",\n      \"latest_value\": -0.35,\n      \"transform\": \"inverse\"\n    }\n  },\n\n  \"metadata\": {\n    \"generated_at\": \"2026-01-19T10:30:00Z\",\n    \"execution_time_ms\": 1234,\n    \"skill_version\": \"0.1.0\",\n    \"notes\": [\n      \"獲利數據有 1 季延遲（最新為 2025-Q3）\",\n      \"NFCI 週度更新，延遲約 1 週\"\n    ]\n  }\n}\n```\n\n---\n\n## 欄位說明\n\n### current_state\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| clock_hour | int | 時鐘點位（1-12） |\n| quadrant | string | 象限代碼 |\n| quadrant_name | string | 象限中文名稱 |\n| x_value | float | X 軸數值（金融環境 Z-score） |\n| y_value | float | Y 軸數值（獲利成長率） |\n| interpretation | string | 當前位置的解讀 |\n\n### rotation_summary\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| from_hour | int | 起始時鐘點位 |\n| to_hour | int | 結束時鐘點位 |\n| direction | string | 旋轉方向（clockwise/counter_clockwise） |\n| magnitude_degrees | float | 旋轉度數（絕對值） |\n| full_rotations | int | 完整圈數 |\n| magnitude_note | string | 幅度說明 |\n\n### quadrant 代碼對照\n\n| 代碼 | 名稱 | 獲利 | 金融環境 |\n|------|------|------|----------|\n| Q1_ideal | 理想象限 | 正 | 支持 |\n| Q2_mixed | 好壞混合 | 正 | 不支持 |\n| Q3_recovery | 修復過渡 | 負 | 支持 |\n| Q4_worst | 最差象限 | 負 | 不支持 |\n\n### direction 代碼\n\n| 代碼 | 說明 |\n|------|------|\n| clockwise | 順時針（典型景氣循環） |\n| counter_clockwise | 逆時針（非典型/政策干預） |\n\n---\n\n## 精簡輸出（--quick 模式）\n\n```json\n{\n  \"skill\": \"analyze-investment-clock-rotation\",\n  \"as_of\": \"2026-01-19\",\n  \"current_position\": {\n    \"clock_hour\": 10,\n    \"quadrant\": \"Q1_ideal\",\n    \"quadrant_name\": \"理想象限\",\n    \"earnings_growth\": 0.052,\n    \"financial_conditions_zscore\": -0.35\n  },\n  \"interpretation\": \"理想象限，風險資產相對順風\"\n}\n```\n\n---\n\n## 循環比較輸出\n\n當 `--compare-cycle` 啟用時，額外輸出：\n\n```json\n{\n  \"cycle_comparison\": {\n    \"current_cycle\": {\n      \"period\": {\"start\": \"2022-10-01\", \"end\": \"2026-01-19\"},\n      \"start_hour\": 2,\n      \"end_hour\": 10,\n      \"rotation_degrees\": 240,\n      \"character\": \"moderate_drift\"\n    },\n    \"previous_cycle\": {\n      \"period\": {\"start\": \"2020-01-01\", \"end\": \"2022-12-31\"},\n      \"start_hour\": 6,\n      \"end_hour\": 12,\n      \"rotation_degrees\": 540,\n      \"character\": \"extreme_swing\"\n    },\n    \"comparison_summary\": {\n      \"rotation_ratio\": 0.44,\n      \"homogeneity\": \"heterogeneous\",\n      \"can_apply_previous_experience\": false,\n      \"reason\": \"前一輪為極端衝擊後的劇烈復甦，當前循環較為平緩\"\n    }\n  }\n}\n```\n\n---\n\n## 錯誤輸出\n\n```json\n{\n  \"skill\": \"analyze-investment-clock-rotation\",\n  \"error\": true,\n  \"error_code\": \"DATA_FETCH_FAILED\",\n  \"error_message\": \"Failed to fetch NFCI data from FRED\",\n  \"details\": {\n    \"series_id\": \"NFCI\",\n    \"http_status\": 500,\n    \"retry_count\": 3\n  },\n  \"metadata\": {\n    \"generated_at\": \"2026-01-19T10:30:00Z\"\n  }\n}\n```\n\n### 錯誤代碼\n\n| 代碼 | 說明 |\n|------|------|\n| DATA_FETCH_FAILED | 資料抓取失敗 |\n| INVALID_PARAMS | 參數驗證失敗 |\n| INSUFFICIENT_DATA | 資料點數不足 |\n| CALCULATION_ERROR | 計算錯誤 |\n",
        "skills/analyze-investment-clock-rotation/templates/output-markdown.md": "# Markdown 輸出模板 (Output Markdown Template)\n\n## 完整報告模板\n\n```markdown\n# 投資時鐘分析報告\n\n**分析日期**：{as_of}\n**市場**：{market}\n**分析區間**：{start_date} 至 {end_date}\n\n---\n\n## 當前位置\n\n| 指標 | 數值 | 狀態 |\n|------|------|------|\n| 時鐘點位 | {clock_hour} 點 | {quadrant_name} |\n| 獲利成長 | {y_value:.1%} | {earnings_status} |\n| 金融環境 Z-score | {x_value:.2f} | {fci_status} |\n\n### 象限判定\n\n**當前象限**：{quadrant_name}（{quadrant}）\n\n{interpretation}\n\n### 配置建議\n\n{quadrant_implication}\n\n---\n\n## 旋轉分析\n\n| 項目 | 數值 |\n|------|------|\n| 起始點位 | {from_hour} 點（{from_quadrant_name}） |\n| 目前點位 | {to_hour} 點（{to_quadrant_name}） |\n| 旋轉方向 | {direction_cn} |\n| 旋轉幅度 | {magnitude_degrees}° |\n\n### 旋轉解讀\n\n{magnitude_note}\n\n---\n\n## 象限時間分布\n\n| 象限 | 期數 | 佔比 |\n|------|------|------|\n| 理想象限（Q1） | {q1_periods} | {q1_pct:.1%} |\n| 好壞混合（Q2） | {q2_periods} | {q2_pct:.1%} |\n| 修復過渡（Q3） | {q3_periods} | {q3_pct:.1%} |\n| 最差象限（Q4） | {q4_periods} | {q4_pct:.1%} |\n\n---\n\n## 風險監控\n\n### 需關注的因素\n\n{risk_factors_list}\n\n### 監控指標\n\n{monitoring_points_list}\n\n---\n\n## 資料來源\n\n| 指標 | 系列 ID | 最新日期 | 最新值 |\n|------|---------|----------|--------|\n| 獲利成長 | {earnings_series_id} | {earnings_latest_date} | {earnings_latest_value} |\n| 金融環境 | {fci_series_id} | {fci_latest_date} | {fci_latest_value} |\n\n### 注意事項\n\n{notes_list}\n\n---\n\n*報告生成時間：{generated_at}*\n*技能版本：{skill_version}*\n```\n\n---\n\n## 循環比較模板\n\n```markdown\n# 投資時鐘循環比較報告\n\n**分析日期**：{as_of}\n\n---\n\n## 循環概覽\n\n### 當前循環\n\n| 項目 | 數值 |\n|------|------|\n| 期間 | {current_start} 至 {current_end} |\n| 起始點位 | {current_from_hour} 點 |\n| 目前點位 | {current_to_hour} 點 |\n| 旋轉幅度 | {current_magnitude}° |\n| 路徑特徵 | {current_character} |\n\n### 前一輪循環（{previous_name}）\n\n| 項目 | 數值 |\n|------|------|\n| 期間 | {previous_start} 至 {previous_end} |\n| 起始點位 | {previous_from_hour} 點 |\n| 終點點位 | {previous_to_hour} 點 |\n| 旋轉幅度 | {previous_magnitude}° |\n| 路徑特徵 | {previous_character} |\n\n---\n\n## 比較分析\n\n| 比較項目 | 當前循環 | 前一輪循環 |\n|----------|----------|------------|\n| 旋轉幅度 | {current_magnitude}° | {previous_magnitude}° |\n| 旋轉方向 | {current_direction} | {previous_direction} |\n| 主要路徑 | {current_path} | {previous_path} |\n\n### 同質性判斷\n\n**判定結果**：{homogeneity}\n\n{homogeneity_explanation}\n\n---\n\n## 結論與建議\n\n{comparison_implications}\n\n### 注意事項\n\n{caveats_list}\n\n---\n\n*報告生成時間：{generated_at}*\n```\n\n---\n\n## 快速報告模板\n\n```markdown\n## 投資時鐘快速檢查\n\n**截至**：{as_of}\n\n### 當前位置\n\n- **時鐘點位**：{clock_hour} 點\n- **象限**：{quadrant_name}\n- **獲利成長**：{y_value:.1%}\n- **金融環境**：{x_value:.2f}（{fci_status}）\n\n### 解讀\n\n{interpretation}\n\n### 配置建議\n\n{implication}\n```\n\n---\n\n## 表格格式模板\n\n用於終端顯示：\n\n```\n投資時鐘分析結果（數據截至 {as_of}）\n\n┌────────────────────────────┬────────┬──────────────────────────┐\n│            指標            │  數值  │           狀態           │\n├────────────────────────────┼────────┼──────────────────────────┤\n│ 時鐘點位                   │ {hour} │ {quadrant_name}          │\n├────────────────────────────┼────────┼──────────────────────────┤\n│ 獲利成長 (Earnings Growth) │ {y}%   │ {earnings_status}        │\n├────────────────────────────┼────────┼──────────────────────────┤\n│ 金融環境 (FCI Z-score)     │ {x}    │ {fci_status}             │\n└────────────────────────────┴────────┴──────────────────────────┘\n\n旋轉分析\n┌──────────┬───────────┬──────────────────────────┐\n│   項目   │   數值    │           說明           │\n├──────────┼───────────┼──────────────────────────┤\n│ 起始點位 │ {from} 點 │ {from_quadrant}          │\n├──────────┼───────────┼──────────────────────────┤\n│ 目前點位 │ {to} 點   │ {to_quadrant}            │\n├──────────┼───────────┼──────────────────────────┤\n│ 旋轉方向 │ {dir}     │ {dir_explanation}        │\n├──────────┼───────────┼──────────────────────────┤\n│ 旋轉幅度 │ {mag}°    │ {mag_note}               │\n└──────────┴───────────┴──────────────────────────┘\n\n配置建議\n{implication}\n\n注意事項\n{caveats}\n```\n\n---\n\n## 變數說明\n\n| 變數 | 說明 | 範例 |\n|------|------|------|\n| {as_of} | 資料截止日 | 2026-01-19 |\n| {clock_hour} | 時鐘點位 | 10 |\n| {quadrant} | 象限代碼 | Q1_ideal |\n| {quadrant_name} | 象限中文名 | 理想象限 |\n| {x_value} | X 軸數值 | -0.35 |\n| {y_value} | Y 軸數值 | 0.052 |\n| {direction_cn} | 旋轉方向中文 | 順時針 |\n| {magnitude_degrees} | 旋轉度數 | 240 |\n| {earnings_status} | 獲利狀態 | 正成長 |\n| {fci_status} | 金融環境狀態 | 偏寬鬆 |\n",
        "skills/analyze-investment-clock-rotation/workflows/analyze.md": "# Workflow: 完整分析\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/methodology.md - 投資時鐘模型邏輯\n2. references/data-sources.md - 各指標的經濟意義\n3. references/input-schema.md - 參數配置\n</required_reading>\n\n<process>\n\n## Step 1: 抓取數據\n\n```bash\npython scripts/fetch_data.py \\\n  --earnings CP \\\n  --fci NFCI \\\n  --start 2022-01-01 \\\n  --end 2026-01-19 \\\n  --output data.json\n```\n\n或使用 Python：\n\n```python\nfrom scripts.fetch_data import fetch_fred_series, fetch_all_data\n\n# 抓取所有需要的數據\ndata = fetch_all_data(\n    start_date=\"2022-01-01\",\n    end_date=\"2026-01-19\",\n    earnings_id=\"CP\",\n    fci_id=\"NFCI\"\n)\n```\n\n## Step 2: 計算獲利成長\n\n```python\nfrom scripts.investment_clock import yoy_growth\n\n# 計算同比成長率\n# periods 依據頻率：週頻=52, 月頻=12, 季頻=4\nearnings_growth = yoy_growth(data[\"earnings\"], periods=4)  # 季度數據用 4\n```\n\n獲利成長計算方法選擇：\n\n| 方法 | 說明 | 適用場景 |\n|------|------|----------|\n| `yoy` | 年對年成長 | 消除季節性，最常用 |\n| `qoq_annualized` | 季對季年化 | 捕捉短期動量 |\n| `rolling_4q_yoy` | 滾動四季同比 | 平滑雜訊 |\n\n## Step 3: 計算金融環境 Z-score\n\n```python\nfrom scripts.investment_clock import zscore\n\n# 計算滾動 Z-score\n# NFCI 原始定義：正值=緊縮，負值=寬鬆\nfci_z = zscore(data[\"fci\"], window=52)  # 52 週視窗\n\n# 若需要反轉方向（讓正值=支持性）\nfci_support = -fci_z\n```\n\n**方向統一規則**：\n\n| 原始指標 | 原始定義 | transform 設定 |\n|----------|----------|----------------|\n| NFCI | 正=緊縮 | `inverse=True` 讓正=寬鬆 |\n| STLFSI4 | 正=壓力高 | `inverse=True` |\n| 自建 FCI | 依定義 | 檢查後設定 |\n\n## Step 4: 對齊頻率\n\n```python\nimport pandas as pd\n\n# 獲利通常是季度，金融環境是週度\n# 需要對齊到共同頻率\n\n# 方法 A：將週度數據重採樣到季度\nfci_quarterly = fci_z.resample('Q').last()\n\n# 方法 B：將季度數據擴展到週度（前向填充）\nearnings_weekly = earnings_growth.resample('W').ffill()\n\n# 合併\ndf = pd.DataFrame({\n    'earnings_growth': earnings_growth,\n    'fci_z': fci_z\n}).dropna()\n```\n\n## Step 5: 建立座標\n\n```python\nfrom scripts.investment_clock import build_coordinates\n\n# 依據 axis_mapping 建立座標\n# 預設：X = financial_conditions, Y = earnings_growth\ncoords = build_coordinates(\n    df,\n    x_col='fci_z',\n    y_col='earnings_growth',\n    invert_x=True  # 若 financial_loose_is_left=True\n)\n\n# coords 結構：\n# {\n#   'x': [...],\n#   'y': [...],\n#   'dates': [...]\n# }\n```\n\n## Step 6: 計算象限與時鐘點位\n\n```python\nfrom scripts.investment_clock import calculate_quadrant, clock_hour_from_angle\nimport numpy as np\n\n# 計算角度\nangle = np.arctan2(coords['y'][-1], coords['x'][-1])\n\n# 轉換為時鐘點位\nhour = clock_hour_from_angle(angle)\n\n# 判定象限\nquadrant = calculate_quadrant(coords['x'][-1], coords['y'][-1])\n\n# quadrant 可能的值：\n# - 'Q1_ideal': 獲利↑ & 支持↑\n# - 'Q2_mixed': 獲利↑ & 支持↓\n# - 'Q3_recovery': 獲利↓ & 支持↑\n# - 'Q4_worst': 獲利↓ & 支持↓\n```\n\n## Step 7: 計算旋轉方向與幅度\n\n```python\nfrom scripts.investment_clock import analyze_rotation\n\nrotation = analyze_rotation(\n    start_angle=angles[0],\n    end_angle=angles[-1],\n    intermediate_angles=angles[1:-1]\n)\n\n# rotation 結構：\n# {\n#   'from_hour': 2,\n#   'to_hour': 10,\n#   'direction': 'clockwise',  # 或 'counter_clockwise'\n#   'magnitude_degrees': 240,\n#   'full_rotations': 0,  # 完整圈數\n#   'net_degrees': 240\n# }\n```\n\n## Step 8: 生成分析報告\n\n```python\nresult = {\n    \"skill\": \"analyze-investment-clock-rotation\",\n    \"as_of\": str(df.index[-1].date()),\n    \"market\": \"US_EQUITY\",\n    \"window\": {\n        \"start_date\": start_date,\n        \"end_date\": end_date,\n        \"freq\": freq\n    },\n    \"axis_mapping_used\": {\n        \"x\": \"financial_conditions\",\n        \"y\": \"earnings_growth\"\n    },\n    \"current_state\": {\n        \"clock_hour\": hour,\n        \"quadrant\": quadrant,\n        \"quadrant_name\": QUADRANT_NAMES[quadrant],\n        \"x_value\": float(coords['x'][-1]),\n        \"y_value\": float(coords['y'][-1]),\n        \"interpretation\": get_quadrant_interpretation(quadrant)\n    },\n    \"rotation_summary\": {\n        \"from_hour\": rotation['from_hour'],\n        \"to_hour\": rotation['to_hour'],\n        \"direction\": rotation['direction'],\n        \"magnitude_degrees\": rotation['magnitude_degrees'],\n        \"magnitude_note\": get_magnitude_note(rotation['magnitude_degrees'])\n    },\n    \"time_series\": {\n        \"dates\": [str(d.date()) for d in df.index],\n        \"x\": coords['x'].tolist(),\n        \"y\": coords['y'].tolist(),\n        \"hours\": hours.tolist(),\n        \"quadrants\": quadrants\n    },\n    \"metadata\": {\n        \"generated_at\": datetime.now().isoformat(),\n        \"data_sources\": {\n            \"earnings\": earnings_series_id,\n            \"financial_conditions\": fci_series_id\n        }\n    }\n}\n```\n\n## Step 9: 輸出\n\n```bash\n# 輸出到檔案\npython scripts/investment_clock.py \\\n  --start 2022-01-01 \\\n  --end 2026-01-19 \\\n  --output result.json\n\n# 或直接輸出到 stdout\npython scripts/investment_clock.py --start 2022-01-01 --end 2026-01-19\n```\n\n</process>\n\n<success_criteria>\n完整分析完成時應產出：\n\n- [ ] 當前時鐘點位（1-12 點）\n- [ ] 當前象限與名稱\n- [ ] X/Y 軸數值（金融環境 Z-score 與獲利成長）\n- [ ] 旋轉方向（順時針/逆時針）\n- [ ] 旋轉幅度（度數）\n- [ ] 配置建議（依象限解讀）\n- [ ] 完整時間序列（若需要視覺化）\n- [ ] 資料來源與元數據\n</success_criteria>\n",
        "skills/analyze-investment-clock-rotation/workflows/compare-cycle.md": "# Workflow: 循環比較\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/methodology.md - 循環比較的意義\n2. references/data-sources.md - 確保數據覆蓋所需區間\n</required_reading>\n\n<process>\n\n## Step 1: 定義比較區間\n\n```python\n# 當前循環\ncurrent_cycle = {\n    \"start\": \"2022-10-01\",\n    \"end\": \"2026-01-19\",\n    \"name\": \"current\"\n}\n\n# 前一輪循環（如 2020 疫情後復甦）\nprevious_cycle = {\n    \"start\": \"2020-01-01\",\n    \"end\": \"2022-12-31\",\n    \"name\": \"covid_recovery\"\n}\n```\n\n## Step 2: 分別計算兩個循環的數據\n\n```python\nfrom scripts.investment_clock import analyze_cycle\n\n# 當前循環\ncurrent = analyze_cycle(\n    start_date=current_cycle[\"start\"],\n    end_date=current_cycle[\"end\"],\n    earnings_id=\"CP\",\n    fci_id=\"NFCI\"\n)\n\n# 前一輪循環\nprevious = analyze_cycle(\n    start_date=previous_cycle[\"start\"],\n    end_date=previous_cycle[\"end\"],\n    earnings_id=\"CP\",\n    fci_id=\"NFCI\"\n)\n```\n\n## Step 3: 計算循環特徵\n\n```python\nfrom scripts.investment_clock import extract_cycle_features\n\ndef extract_cycle_features(cycle_data):\n    \"\"\"提取循環特徵\"\"\"\n    return {\n        # 起終點\n        \"start_hour\": cycle_data[\"hours\"][0],\n        \"end_hour\": cycle_data[\"hours\"][-1],\n        \"start_quadrant\": cycle_data[\"quadrants\"][0],\n        \"end_quadrant\": cycle_data[\"quadrants\"][-1],\n\n        # 旋轉特徵\n        \"total_rotation_degrees\": cycle_data[\"rotation\"][\"net_degrees\"],\n        \"direction\": cycle_data[\"rotation\"][\"direction\"],\n        \"full_rotations\": cycle_data[\"rotation\"][\"full_rotations\"],\n\n        # 極端值\n        \"max_earnings_growth\": max(cycle_data[\"y\"]),\n        \"min_earnings_growth\": min(cycle_data[\"y\"]),\n        \"max_fci_z\": max(cycle_data[\"x\"]),\n        \"min_fci_z\": min(cycle_data[\"x\"]),\n\n        # 象限分布\n        \"time_in_q1\": sum(1 for q in cycle_data[\"quadrants\"] if q == \"Q1_ideal\"),\n        \"time_in_q2\": sum(1 for q in cycle_data[\"quadrants\"] if q == \"Q2_mixed\"),\n        \"time_in_q3\": sum(1 for q in cycle_data[\"quadrants\"] if q == \"Q3_recovery\"),\n        \"time_in_q4\": sum(1 for q in cycle_data[\"quadrants\"] if q == \"Q4_worst\"),\n\n        # 路徑特徵\n        \"path_volatility\": np.std(cycle_data[\"hours\"]),\n        \"dominant_direction\": \"clockwise\" if net_rotation > 0 else \"counter_clockwise\"\n    }\n\ncurrent_features = extract_cycle_features(current)\nprevious_features = extract_cycle_features(previous)\n```\n\n## Step 4: 比較分析\n\n```python\ndef compare_cycles(current_feat, previous_feat):\n    \"\"\"比較兩個循環\"\"\"\n    comparison = {\n        # 旋轉幅度比較\n        \"rotation_comparison\": {\n            \"current_degrees\": current_feat[\"total_rotation_degrees\"],\n            \"previous_degrees\": previous_feat[\"total_rotation_degrees\"],\n            \"ratio\": current_feat[\"total_rotation_degrees\"] / max(previous_feat[\"total_rotation_degrees\"], 1),\n            \"interpretation\": interpret_rotation_difference(\n                current_feat[\"total_rotation_degrees\"],\n                previous_feat[\"total_rotation_degrees\"]\n            )\n        },\n\n        # 起終點比較\n        \"position_comparison\": {\n            \"current_start\": current_feat[\"start_hour\"],\n            \"previous_start\": previous_feat[\"start_hour\"],\n            \"current_end\": current_feat[\"end_hour\"],\n            \"previous_end\": previous_feat[\"end_hour\"],\n            \"similar_endpoint\": abs(current_feat[\"end_hour\"] - previous_feat[\"end_hour\"]) <= 2\n        },\n\n        # 極端值比較\n        \"extremes_comparison\": {\n            \"earnings_range_current\": current_feat[\"max_earnings_growth\"] - current_feat[\"min_earnings_growth\"],\n            \"earnings_range_previous\": previous_feat[\"max_earnings_growth\"] - previous_feat[\"min_earnings_growth\"],\n            \"fci_range_current\": current_feat[\"max_fci_z\"] - current_feat[\"min_fci_z\"],\n            \"fci_range_previous\": previous_feat[\"max_fci_z\"] - previous_feat[\"min_fci_z\"]\n        },\n\n        # 象限時間分布\n        \"quadrant_distribution\": {\n            \"current\": {\n                \"Q1\": current_feat[\"time_in_q1\"],\n                \"Q2\": current_feat[\"time_in_q2\"],\n                \"Q3\": current_feat[\"time_in_q3\"],\n                \"Q4\": current_feat[\"time_in_q4\"]\n            },\n            \"previous\": {\n                \"Q1\": previous_feat[\"time_in_q1\"],\n                \"Q2\": previous_feat[\"time_in_q2\"],\n                \"Q3\": previous_feat[\"time_in_q3\"],\n                \"Q4\": previous_feat[\"time_in_q4\"]\n            }\n        },\n\n        # 同質性判斷\n        \"homogeneity\": {\n            \"similar_magnitude\": abs(current_feat[\"total_rotation_degrees\"] - previous_feat[\"total_rotation_degrees\"]) < 180,\n            \"similar_direction\": current_feat[\"dominant_direction\"] == previous_feat[\"dominant_direction\"],\n            \"similar_volatility\": abs(current_feat[\"path_volatility\"] - previous_feat[\"path_volatility\"]) < 1.0,\n            \"overall\": \"homogeneous\" if all([...]) else \"heterogeneous\"\n        }\n    }\n\n    return comparison\n\ncomparison = compare_cycles(current_features, previous_features)\n```\n\n## Step 5: 生成比較報告\n\n```json\n{\n  \"skill\": \"analyze-investment-clock-rotation\",\n  \"mode\": \"cycle_comparison\",\n  \"as_of\": \"2026-01-19\",\n\n  \"cycles\": {\n    \"current\": {\n      \"name\": \"current\",\n      \"period\": {\"start\": \"2022-10-01\", \"end\": \"2026-01-19\"},\n      \"features\": {\n        \"start_hour\": 2,\n        \"end_hour\": 10,\n        \"total_rotation\": 240,\n        \"direction\": \"clockwise\",\n        \"path_character\": \"moderate_drift\"\n      }\n    },\n    \"previous\": {\n      \"name\": \"covid_recovery\",\n      \"period\": {\"start\": \"2020-01-01\", \"end\": \"2022-12-31\"},\n      \"features\": {\n        \"start_hour\": 6,\n        \"end_hour\": 12,\n        \"total_rotation\": 540,\n        \"direction\": \"clockwise\",\n        \"path_character\": \"extreme_swing\"\n      }\n    }\n  },\n\n  \"comparison\": {\n    \"rotation_comparison\": {\n      \"current_degrees\": 240,\n      \"previous_degrees\": 540,\n      \"ratio\": 0.44,\n      \"interpretation\": \"當前循環旋轉幅度約為前一輪的一半，屬於較溫和的漂移\"\n    },\n    \"homogeneity\": {\n      \"similar_magnitude\": false,\n      \"similar_direction\": true,\n      \"overall\": \"heterogeneous\",\n      \"note\": \"兩輪循環不完全同質，前一輪為極端衝擊後的劇烈復甦，當前循環較為平緩\"\n    }\n  },\n\n  \"implications\": [\n    \"當前循環與 2020-2022 循環的路徑特徵不同，不宜直接套用上一輪經驗\",\n    \"前一輪因疫情衝擊出現極端旋轉，當前循環更接近典型景氣漂移\",\n    \"若要類比，可參考 2015-2019 的溫和循環特徵\"\n  ],\n\n  \"caveats\": [\n    \"循環比較假設相同的資料來源和計算方法\",\n    \"不同循環的外部環境（政策、事件）可能導致不可比性\"\n  ]\n}\n```\n\n## Step 6: 執行比較\n\n```bash\npython scripts/investment_clock.py \\\n  --start 2022-10-01 \\\n  --end 2026-01-19 \\\n  --compare-cycle 2020-01-01 2022-12-31 \\\n  --output comparison.json\n```\n\n</process>\n\n<success_criteria>\n循環比較完成時應產出：\n\n- [ ] 兩個循環的完整特徵摘要\n- [ ] 旋轉幅度比較（度數、比率）\n- [ ] 起終點位置比較\n- [ ] 極端值範圍比較\n- [ ] 象限時間分布比較\n- [ ] 同質性判斷（是否可類比）\n- [ ] 配置含義與注意事項\n- [ ] 不可比的警示（若有）\n</success_criteria>\n",
        "skills/analyze-investment-clock-rotation/workflows/visualize.md": "# Workflow: 視覺化\n\n<required_reading>\n**執行前請先閱讀：**\n1. workflows/analyze.md - 了解如何產生分析數據\n</required_reading>\n\n<process>\n\n## Step 1: 準備分析數據\n\n先執行完整分析以取得時間序列數據：\n\n```bash\npython scripts/investment_clock.py \\\n  --start 2022-01-01 \\\n  --end 2026-01-19 \\\n  --output analysis.json\n```\n\n## Step 2: 執行視覺化\n\n```bash\npython scripts/visualize.py \\\n  -i analysis.json \\\n  -o output/investment_clock.png \\\n  --style dark  # 或 light\n```\n\n## Step 3: 視覺化腳本說明\n\n```python\n# scripts/visualize.py 主要功能\n\nimport matplotlib.pyplot as plt\nimport numpy as np\nimport json\n\ndef plot_investment_clock(data, output_path, style='dark'):\n    \"\"\"\n    生成投資時鐘視覺化圖表\n\n    圖表包含：\n    1. 極座標時鐘圖（主圖）\n    2. 時間序列軌跡\n    3. 象限標註\n    4. 當前位置標記\n    \"\"\"\n\n    fig = plt.figure(figsize=(14, 10))\n\n    # Panel 1: 極座標時鐘圖\n    ax1 = fig.add_subplot(221, projection='polar')\n    plot_clock_face(ax1, data)\n\n    # Panel 2: X-Y 散佈圖（笛卡爾座標）\n    ax2 = fig.add_subplot(222)\n    plot_xy_scatter(ax2, data)\n\n    # Panel 3: 時間序列 - 獲利成長\n    ax3 = fig.add_subplot(223)\n    plot_earnings_series(ax3, data)\n\n    # Panel 4: 時間序列 - 金融環境\n    ax4 = fig.add_subplot(224)\n    plot_fci_series(ax4, data)\n\n    plt.tight_layout()\n    plt.savefig(output_path, dpi=150, bbox_inches='tight')\n    plt.close()\n\n\ndef plot_clock_face(ax, data):\n    \"\"\"繪製極座標時鐘圖\"\"\"\n\n    # 繪製時鐘刻度\n    for hour in range(1, 13):\n        angle = (90 - hour * 30) * np.pi / 180\n        ax.annotate(str(hour), xy=(angle, 1.1), ha='center', va='center')\n\n    # 繪製象限背景\n    quadrant_colors = {\n        'Q1': '#90EE90',  # 淺綠（理想）\n        'Q2': '#FFD700',  # 金色（混合）\n        'Q3': '#87CEEB',  # 天藍（修復）\n        'Q4': '#FFA07A'   # 淺橘（最差）\n    }\n\n    # 繪製軌跡\n    angles = data['time_series']['angles']\n    radii = data['time_series']['radii']\n    ax.plot(angles, radii, 'b-', alpha=0.6, linewidth=1)\n\n    # 標記起點和終點\n    ax.scatter(angles[0], radii[0], c='green', s=100, marker='o', label='Start')\n    ax.scatter(angles[-1], radii[-1], c='red', s=100, marker='*', label='Current')\n\n    ax.set_title('Investment Clock')\n    ax.legend(loc='upper right')\n\n\ndef plot_xy_scatter(ax, data):\n    \"\"\"繪製 X-Y 散佈圖\"\"\"\n\n    x = data['time_series']['x']\n    y = data['time_series']['y']\n\n    # 繪製象限背景\n    ax.axhline(y=0, color='gray', linestyle='--', alpha=0.5)\n    ax.axvline(x=0, color='gray', linestyle='--', alpha=0.5)\n\n    # 填充象限顏色\n    ax.fill_between([-3, 0], 0, 3, alpha=0.2, color='lightblue', label='Q3 Recovery')\n    ax.fill_between([0, 3], 0, 3, alpha=0.2, color='lightgreen', label='Q1 Ideal')\n    ax.fill_between([-3, 0], -3, 0, alpha=0.2, color='lightsalmon', label='Q4 Worst')\n    ax.fill_between([0, 3], -3, 0, alpha=0.2, color='khaki', label='Q2 Mixed')\n\n    # 繪製軌跡\n    ax.plot(x, y, 'b-', alpha=0.6, linewidth=1)\n\n    # 標記起點和終點\n    ax.scatter(x[0], y[0], c='green', s=100, marker='o', zorder=5)\n    ax.scatter(x[-1], y[-1], c='red', s=100, marker='*', zorder=5)\n\n    # 標註箭頭顯示方向\n    for i in range(0, len(x)-1, max(1, len(x)//10)):\n        ax.annotate('', xy=(x[i+1], y[i+1]), xytext=(x[i], y[i]),\n                    arrowprops=dict(arrowstyle='->', color='blue', alpha=0.3))\n\n    ax.set_xlabel('Financial Conditions (Z-score)\\n← Loose | Tight →')\n    ax.set_ylabel('Earnings Growth\\n← Negative | Positive →')\n    ax.set_title('Investment Clock Path')\n    ax.set_xlim(-2.5, 2.5)\n    ax.set_ylim(-0.3, 0.3)\n\n\ndef plot_earnings_series(ax, data):\n    \"\"\"繪製獲利成長時間序列\"\"\"\n\n    dates = data['time_series']['dates']\n    y = data['time_series']['y']\n\n    ax.plot(dates, y, 'b-', linewidth=1.5)\n    ax.axhline(y=0, color='gray', linestyle='--', alpha=0.5)\n    ax.fill_between(dates, y, 0, where=[v > 0 for v in y], alpha=0.3, color='green')\n    ax.fill_between(dates, y, 0, where=[v < 0 for v in y], alpha=0.3, color='red')\n\n    ax.set_xlabel('Date')\n    ax.set_ylabel('Earnings Growth (YoY)')\n    ax.set_title('Earnings Growth Over Time')\n\n\ndef plot_fci_series(ax, data):\n    \"\"\"繪製金融環境時間序列\"\"\"\n\n    dates = data['time_series']['dates']\n    x = data['time_series']['x']\n\n    ax.plot(dates, x, 'purple', linewidth=1.5)\n    ax.axhline(y=0, color='gray', linestyle='--', alpha=0.5)\n    ax.fill_between(dates, x, 0, where=[v < 0 for v in x], alpha=0.3, color='green', label='Loose')\n    ax.fill_between(dates, x, 0, where=[v > 0 for v in x], alpha=0.3, color='red', label='Tight')\n\n    ax.set_xlabel('Date')\n    ax.set_ylabel('Financial Conditions (Z-score)')\n    ax.set_title('Financial Conditions Over Time')\n    ax.legend()\n```\n\n## Step 4: 輸出格式選項\n\n```bash\n# PNG（預設）\npython scripts/visualize.py -i analysis.json -o chart.png\n\n# SVG（向量格式）\npython scripts/visualize.py -i analysis.json -o chart.svg\n\n# HTML（互動式，使用 Plotly）\npython scripts/visualize.py -i analysis.json -o chart.html --interactive\n```\n\n## Step 5: 自訂樣式\n\n```python\n# 可用樣式參數\nstyles = {\n    'dark': {\n        'bg_color': '#1a1a2e',\n        'text_color': 'white',\n        'grid_color': '#444',\n        'quadrant_alpha': 0.3\n    },\n    'light': {\n        'bg_color': 'white',\n        'text_color': 'black',\n        'grid_color': '#ccc',\n        'quadrant_alpha': 0.2\n    },\n    'print': {\n        'bg_color': 'white',\n        'text_color': 'black',\n        'grid_color': 'gray',\n        'quadrant_alpha': 0.1\n    }\n}\n```\n\n</process>\n\n<success_criteria>\n視覺化完成時應產出：\n\n- [ ] 投資時鐘極座標圖（含軌跡、起終點）\n- [ ] X-Y 散佈圖（含象限背景、方向箭頭）\n- [ ] 獲利成長時間序列\n- [ ] 金融環境時間序列\n- [ ] 圖表標題與圖例\n- [ ] 輸出檔案（PNG/SVG/HTML）\n</success_criteria>\n",
        "skills/analyze-japan-debt-service-tax-burden/SKILL.md": "---\nname: analyze-japan-debt-service-tax-burden\ndescription: 以日本公債殖利率變化為觸發，量化「政府利息支出 / 稅收」負擔（含情境壓力測試），並判斷是否進入債務利息螺旋風險區。\n---\n\n# 分析日本債務利息負擔 Skill\n\n以公開數據量化日本「利息吃掉稅收」的敘事，提供可驗證的現況核對、敏感度分析與風險分級。\n\n<essential_principles>\n\n<principle name=\"interest_tax_ratio\">\n**核心指標：利息/稅收比**\n\n`interest_tax_ratio = interest_payments / tax_revenue`\n\n這是影片敘事「利息吃掉 1/3 稅收」的可核驗版本。不同口徑（國稅 vs 一般會計稅收 vs 總收入）會產生不同數值，必須明示口徑選擇。\n\n**口徑對照（FY2025）**：\n| 口徑 | 計算 | 比例 |\n|------|------|------|\n| 純利息/稅收 | 10.5兆/70兆 | **15.0%** |\n| 國債費/稅收 | 28.2兆/70兆 | **40.3%** |\n\n**注意**：媒體敘事「利息吃掉 1/3」通常誤用國債費（含本金）口徑。\n</principle>\n\n<principle name=\"implied_avg_rate\">\n**隱含平均利率**\n\n`implied_avg_rate = interest_payments / debt_stock`\n\n衡量存量債務的平均融資成本。對比當前市場利率可評估再融資壓力。\n\n**FY2025**：10.5兆 / 1,324兆 = **0.79%** vs 當前 10Y 殖利率 **2.0%+**\n→ 差距反映大量存量債務在低利率時期發行，未來再融資將推高利息負擔。\n</principle>\n\n<principle name=\"debt_in_us_terms\">\n**「in US terms」換算邏輯**\n\n媒體常用「美國等效規模」表達日本債務以增強震撼效果。\n\n**公式**（動態計算）：\n```\ndebt_to_gdp = japan_debt_stock / japan_gdp\ndebt_in_us_terms = us_gdp × debt_to_gdp\n```\n\n**數據來源**：GDP 從 FRED 實時抓取，非硬編碼。\n\n**範例**：$30.6T × 250% = **$76.5T** ≈ $70T（媒體口語化）\n\n**用途**：解釋影片/新聞中「$70T」數字的來源，用於跨國比較時統一規模感知。\n</principle>\n\n<principle name=\"yield_sensitivity\">\n**殖利率敏感度映射**\n\n把殖利率變動映射到利息支出增加：\n```\nadditional_interest ≈ debt_stock × pass_through × delta_yield\n```\n\n其中 `pass_through` 是年度再定價/再融資比例（約 15%），`delta_yield` 以小數表示（200bp = 0.02）。\n</principle>\n\n<principle name=\"risk_bands\">\n**風險分級（Traffic Light）**\n\n| 區間  | interest_tax_ratio | 含義                |\n|-------|--------------------|---------------------|\n| 🟢 綠 | < 0.25             | 財政彈性充足        |\n| 🟡 黃 | 0.25–0.40          | 財政彈性開始下降    |\n| 🟠 橘 | 0.40–0.55          | 政策空間明顯受限    |\n| 🔴 紅 | > 0.55             | 接近「2/3」敘事區域 |\n</principle>\n\n<principle name=\"data_transparency\">\n**口徑透明原則**\n\n所有輸出必須標示：\n- 稅收口徑（national_tax / general_account_tax / total_revenue）\n- 利息口徑（interest_only / debt_service）\n- 資料年度與滯後（lag）\n- 再定價假設（pass_through）\n</principle>\n\n</essential_principles>\n\n<objective>\n量化日本「利息吃掉稅收」敘事，並提供：\n1. **現況核對**：當前 interest/tax ratio 與殖利率分位數\n2. **壓力測試**：不同利率衝擊情境下的未來負擔\n3. **風險分級**：可決策的 Traffic Light 評估\n4. **外溢通道**（選用）：日本對美資產規模與潛在影響\n</objective>\n\n<quick_start>\n\n**最快的方式：執行快速檢查**\n\n```bash\ncd skills/analyze-japan-debt-service-tax-burden\npip install pandas numpy requests matplotlib  # 首次使用\npython scripts/japan_debt_analyzer.py --quick\n```\n\n輸出範例：\n```json\n{\n  \"yield_stats\": {\"tenor\": \"10Y\", \"latest\": 1.23, \"percentile\": 0.97},\n  \"fiscal\": {\"interest_tax_ratio\": 0.15, \"risk_band\": \"green\"},\n  \"headline\": \"利息支出佔稅收 15.0%，處於🟢 GREEN 區\",\n  \"data_sources\": {\"jgb_10y\": \"FRED/IRLTLT01JPM156N\", \"fiscal\": \"config/FY2025\"}\n}\n```\n\n**完整分析（含實時數據刷新）**：\n```bash\npython scripts/japan_debt_analyzer.py --full --refresh\n```\n\n**生成視覺化 Dashboard**：\n```bash\npython scripts/generate_charts.py --full --output-dir ../../output\n```\n\n輸出：`output/japan_debt_dashboard_YYYYMMDD.png`\n\nDashboard 包含：\n- Interest/Tax Ratio 風險儀表盤\n- 殖利率分位數指標\n- 財政數據摘要\n- 壓力測試情境比較圖\n\n**生成債務螺旋模擬圖表**：\n```bash\n# 完整多情境螺旋模擬\npython scripts/generate_spiral_chart.py --all --output-dir ../../output\n\n# 單一壓力情境（如 +200bp）\npython scripts/generate_spiral_chart.py --stress 200 --output-dir ../../output\n\n# 自定義模擬年數\npython scripts/generate_spiral_chart.py --years 15 --output-dir ../../output\n```\n\n輸出：`output/japan_debt_spiral_YYYY-MM-DD.png`\n\n螺旋模擬包含：\n- 多情境 Interest/Tax Ratio 10年演變曲線\n- 風險區間背景（綠/黃/橙/紅）\n- 利息支出分解堆疊圖\n- 各情境最終風險評估\n\n**生成歷史趨勢分析圖表**（NEW!）：\n```bash\n# 完整歷史趨勢分析（2015-2025）\npython scripts/generate_historical_trend.py --output-dir ../../output\n\n# 自定義時間範圍\npython scripts/generate_historical_trend.py --start-year 2018 --end-year 2025\n```\n\n輸出：`output/japan_debt_trend_YYYYMMDD.png`\n\n歷史趨勢分析包含：\n- Interest/Tax Ratio 11年完整走勢（2015-2025）\n- 稅收、利息支出、債務存量趨勢\n- 隱含平均利率演變\n- 風險分級分布統計\n- 階段性特徵分析（下降期/疫情期/反彈期）\n\n**單獨測試數據抓取**：\n```bash\npython scripts/fetch_jgb_yields.py --tenor 10Y\npython scripts/fetch_tic_holdings.py\n```\n\n</quick_start>\n\n<intake>\n您想要執行什麼操作？\n\n1. **快速檢查** - 查看最新的利息/稅收比與殖利率狀態\n2. **完整分析** - 執行完整的財政壓力測試與風險評估\n3. **情境壓測** - 自定義利率衝擊情境進行壓力測試\n4. **生成圖表** - 生成視覺化 Dashboard（PNG 圖檔）\n5. **債務螺旋模擬** - 模擬多年累積效應，生成螺旋演變圖表\n6. **歷史趨勢分析** - 分析 2015-2025 年完整歷史趨勢（NEW!）\n7. **方法論學習** - 了解指標計算與風險分級邏輯\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                                  | Workflow                     | Description          |\n|-------------------------------------------|------------------------------|----------------------|\n| 1, \"快速\", \"quick\", \"check\"               | workflows/quick-check.md     | 快速狀態檢查         |\n| 2, \"完整\", \"full\", \"analyze\"              | workflows/full-analysis.md   | 完整分析工作流       |\n| 3, \"壓測\", \"stress\", \"scenario\"           | workflows/stress-test.md     | 情境壓力測試         |\n| 4, \"圖表\", \"chart\", \"dashboard\"           | workflows/generate-chart.md  | 生成視覺化圖表       |\n| 5, \"螺旋\", \"spiral\", \"多年\"               | workflows/spiral-simulate.md | 債務螺旋模擬         |\n| 6, \"歷史\", \"趨勢\", \"historical\", \"2015\"   | workflows/historical-trend.md| 歷史趨勢分析（NEW!） |\n| 7, \"學習\", \"方法論\", \"why\"                | references/methodology.md    | 方法論說明           |\n| 提供參數 (如殖利率衝擊)                   | workflows/stress-test.md     | 使用參數執行壓測     |\n\n**路由後，閱讀對應工作流程並完全遵循其步驟。**\n</routing>\n\n<input_schema>\n\n<parameter name=\"country\" required=\"true\" default=\"JP\">\n**Type**: string\n**Description**: 固定 JP / Japan（預留擴展多國）\n</parameter>\n\n<parameter name=\"analysis_window_days\" required=\"false\" default=\"504\">\n**Type**: int\n**Description**: 殖利率與市場指標分析視窗（交易日數）\n</parameter>\n\n<parameter name=\"yield_tenors\" required=\"false\" default='[\"2Y\",\"10Y\",\"30Y\"]'>\n**Type**: array[string]\n**Description**: JGB 觀察期限\n</parameter>\n\n<parameter name=\"tax_revenue_series\" required=\"false\" default=\"general_account_tax\">\n**Type**: string\n**Options**: `national_tax` | `general_account_tax` | `total_revenue`\n**Description**: 稅收口徑選擇\n</parameter>\n\n<parameter name=\"interest_payment_series\" required=\"false\" default=\"interest_only\">\n**Type**: string\n**Options**: `interest_only` | `debt_service`\n**Description**: 利息支出口徑（純利息 vs 含本金償還）\n</parameter>\n\n<parameter name=\"stress_scenarios\" required=\"false\">\n**Type**: array[object]\n**Description**: 壓力測試情境設定\n\n每個情境包含：\n- `name` (string): 情境名稱\n- `delta_yield_bp` (int): 殖利率上升幅度（bp）\n- `pass_through_year1` (float): 第一年再定價比例（預設 0.15）\n- `pass_through_year2` (float): 第二年再定價比例（預設 0.15）\n- `tax_shock` (float): 稅收衝擊（如 -0.05 表示下降 5%）\n</parameter>\n\n<parameter name=\"include_us_assets_channel\" required=\"false\" default=\"true\">\n**Type**: boolean\n**Description**: 是否計算日本對美資產外溢通道\n</parameter>\n\n<parameter name=\"output_format\" required=\"false\" default=\"markdown\">\n**Type**: string\n**Options**: `json` | `markdown`\n</parameter>\n\n</input_schema>\n\n<output_schema>\n參見 `templates/output-json.md` 的完整結構定義。\n\n**摘要**：\n```json\n{\n  \"skill\": \"analyze_japan_debt_service_tax_burden\",\n  \"as_of\": \"2026-01-20\",\n  \"yield_stats\": {\n    \"tenor\": \"10Y\",\n    \"latest\": 1.23,\n    \"zscore\": 2.10,\n    \"percentile\": 0.97,\n    \"interpretation\": \"近兩年分位數 97%，屬於偏極端區\"\n  },\n  \"fiscal\": {\n    \"tax_revenue_jpy\": 72000000000000,\n    \"interest_payments_jpy\": 24000000000000,\n    \"debt_stock_jpy\": 1200000000000000,\n    \"interest_tax_ratio\": 0.333,\n    \"risk_band\": \"yellow\",\n    \"definition\": {...}\n  },\n  \"stress_tests\": [...],\n  \"spillover_channel\": {...},\n  \"headline_takeaways\": [...]\n}\n```\n</output_schema>\n\n<reference_index>\n**參考文件** (`references/`)\n\n| 文件                      | 內容                                       |\n|---------------------------|--------------------------------------------|\n| data-sources.md           | 資料來源與 API 端點（MOF、BOJ、FRED、TIC） |\n| methodology.md            | 計算方法論與風險分級邏輯                   |\n| japan-fiscal-structure.md | 日本財政結構與債務特徵                     |\n</reference_index>\n\n<workflows_index>\n| Workflow            | Purpose                          |\n|---------------------|----------------------------------|\n| quick-check.md      | 快速狀態檢查（1分鐘內完成）      |\n| full-analysis.md    | 完整分析工作流（含所有步驟）     |\n| stress-test.md      | 自定義情境壓力測試               |\n| generate-chart.md   | 生成視覺化 Dashboard             |\n| spiral-simulate.md  | 債務螺旋多年模擬                 |\n| historical-trend.md | 歷史趨勢分析（2015-2025）（NEW!）|\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構定義 |\n| output-markdown.md | Markdown 報告模板 |\n</templates_index>\n\n<scripts_index>\n| Script                      | Command                      | Purpose                        |\n|-----------------------------|------------------------------|--------------------------------|\n| japan_debt_analyzer.py      | `--quick`                    | 快速檢查                       |\n| japan_debt_analyzer.py      | `--full`                     | 完整分析                       |\n| japan_debt_analyzer.py      | `--stress BP`                | 壓力測試                       |\n| japan_debt_analyzer.py      | `--refresh`                  | 強制刷新數據                   |\n| generate_charts.py          | `--full --output-dir DIR`    | 生成視覺化 Dashboard           |\n| generate_charts.py          | `--quick`                    | 快速模式圖表                   |\n| generate_charts.py          | `--data-file FILE`           | 從 JSON 載入數據               |\n| generate_spiral_chart.py    | `--all --output-dir DIR`     | 完整債務螺旋模擬 Dashboard     |\n| generate_spiral_chart.py    | `--stress BP`                | 單一壓力情境螺旋圖             |\n| generate_spiral_chart.py    | `--years N`                  | 自定義模擬年數（預設 10）      |\n| generate_historical_trend.py| `--output-dir DIR`           | 歷史趨勢分析（2015-2025）（NEW!）|\n| generate_historical_trend.py| `--start-year Y --end-year Y`| 自定義時間範圍分析             |\n| fetch_jgb_yields.py         | `--tenor 10Y`                | 抓取 JGB 殖利率 (FRED)         |\n| fetch_tic_holdings.py       | `--refresh`                  | 抓取 TIC 美債持有數據          |\n| data_manager.py             | `--fetch-all`                | 協調所有數據源抓取             |\n</scripts_index>\n\n<success_criteria>\nSkill 成功執行時：\n\n- [ ] 輸出當前 interest/tax ratio 與風險分級\n- [ ] 殖利率分位數/Z-score 判斷是否極端\n- [ ] 壓力測試結果含敏感度分析\n- [ ] 明確標示資料口徑與滯後\n- [ ] 若啟用，輸出外溢通道評估\n- [ ] 可操作的 headline takeaways\n</success_criteria>\n\n<directory_structure>\n```\nanalyze-japan-debt-service-tax-burden/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元資料\n├── workflows/\n│   ├── quick-check.md                 # 快速檢查工作流\n│   ├── full-analysis.md               # 完整分析工作流\n│   ├── stress-test.md                 # 壓力測試工作流\n│   ├── generate-chart.md              # 圖表生成工作流\n│   ├── spiral-simulate.md             # 債務螺旋模擬工作流\n│   └── historical-trend.md            # 歷史趨勢分析工作流（NEW!）\n├── references/\n│   ├── data-sources.md                # 資料來源說明\n│   ├── methodology.md                 # 方法論與公式\n│   └── japan-fiscal-structure.md      # 日本財政結構\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n├── config/\n│   └── fiscal_data.json               # 財政數據配置（含 2015-2025 完整數據）\n├── scripts/\n│   ├── japan_debt_analyzer.py         # 主分析腳本\n│   ├── generate_charts.py             # 視覺化圖表生成\n│   ├── generate_spiral_chart.py       # 債務螺旋模擬圖表\n│   ├── generate_historical_trend.py   # 歷史趨勢分析圖表（NEW!）\n│   ├── fetch_jgb_yields.py            # JGB 殖利率抓取 (FRED)\n│   ├── fetch_tic_holdings.py          # TIC 美債持有抓取\n│   └── data_manager.py                # 數據協調與緩存管理\n├── data/\n│   └── cache/                         # 自動緩存目錄（gitignore）\n└── examples/\n    └── sample-output.json             # 範例輸出\n```\n</directory_structure>\n",
        "skills/analyze-japan-debt-service-tax-burden/references/data-sources.md": "# 資料來源說明\n\n本 Skill 使用的資料來源與 API 端點。\n\n## 優先使用：官方/公開資料\n\n### 1. JGB 殖利率\n\n#### 日本財務省 (MOF)\n- **網站**: https://www.mof.go.jp/jgbs/reference/interest_rate/\n- **資料**: 日本國債殖利率時間序列\n- **格式**: CSV/Excel 可下載\n- **期限**: 1Y, 2Y, 3Y, 5Y, 10Y, 20Y, 30Y, 40Y\n\n#### 日本銀行 (BOJ) 統計\n- **網站**: https://www.stat-search.boj.or.jp/\n- **資料**: 金融市場統計\n- **格式**: CSV\n\n#### FRED（替代方案）\n- **端點**: `https://fred.stlouisfed.org/graph/fredgraph.csv?id=IRLTLT01JPM156N`\n- **系列**:\n  - `IRLTLT01JPM156N` - 日本長期利率（10Y 近似）\n  - `INTGSTJPM193N` - 日本短期利率\n\n```python\n# 無需 API key 的 FRED CSV 抓取\nimport pandas as pd\nurl = \"https://fred.stlouisfed.org/graph/fredgraph.csv?id=IRLTLT01JPM156N\"\ndf = pd.read_csv(url, parse_dates=[\"DATE\"])\n```\n\n### 2. 財政數據（稅收、利息支出、債務）\n\n#### 日本財務省 預算/決算\n- **網站**: https://www.mof.go.jp/policy/budget/\n- **資料**:\n  - 一般會計歲入歲出（稅收）\n  - 國債費（利息+本金償還）\n  - 國債殘高（債務存量）\n- **頻率**: 年度\n\n#### 日本財務省 國債統計\n- **網站**: https://www.mof.go.jp/jgbs/reference/gbb/\n- **資料**: 國債發行殘高、到期結構\n- **用途**: 計算 pass_through 再定價比例\n\n#### IMF / OECD（跨國比較用）\n- **IMF IFS**: General government interest payments / revenue\n- **OECD**: Government debt interest payments\n- **注意**: 口徑可能與日本國內統計不同\n\n### 3. 外溢通道（日本對美資產）\n\n#### US Treasury TIC\n- **網站**: https://ticdata.treasury.gov/\n- **資料**: 外國持有美國證券\n- **系列**: Major Foreign Holders of Treasury Securities\n- **日本數據**: 月度更新\n\n```python\n# TIC 日本持有美債\nurl = \"https://ticdata.treasury.gov/resource-center/data-chart-center/tic/Documents/mfh.txt\"\n```\n\n#### 日本 IIP（國際投資頭寸）\n- **來源**: 日本銀行\n- **資料**: 對外資產負債表\n- **用途**: 估算對美資產總規模\n\n### 4. GDP 數據（用於計算 debt_to_gdp 和 debt_in_us_terms）\n\n#### 美國 GDP (FRED)\n- **系列**: `GDP`（季度名目 GDP）\n- **端點**: `https://fred.stlouisfed.org/graph/fredgraph.csv?id=GDP`\n- **單位**: 十億美元\n- **更新頻率**: 季度\n- **用途**: 計算「debt_in_us_terms」（若美國有相同債務/GDP比例）\n\n```python\n# 抓取美國 GDP（由 data_manager.py 自動執行）\nimport pandas as pd\nurl = \"https://fred.stlouisfed.org/graph/fredgraph.csv?id=GDP\"\ndf = pd.read_csv(url, parse_dates=[\"DATE\"])\nus_gdp_usd = df[\"GDP\"].iloc[-1] * 1e9  # 十億美元 → 美元\n```\n\n#### 日本 GDP (FRED)\n- **系列**: `JPNNGDP`（日本名目 GDP，美元計）\n- **端點**: `https://fred.stlouisfed.org/graph/fredgraph.csv?id=JPNNGDP`\n- **單位**: 十億美元\n- **更新頻率**: 年度\n- **用途**: 驗證配置中的 `japan_gdp_jpy` 合理性\n\n```python\n# 抓取日本 GDP（由 data_manager.py 自動執行）\nurl = \"https://fred.stlouisfed.org/graph/fredgraph.csv?id=JPNNGDP\"\ndf = pd.read_csv(url, parse_dates=[\"DATE\"])\njapan_gdp_usd = df[\"JPNNGDP\"].iloc[-1] * 1e9\n```\n\n#### 日本 GDP（日圓計，配置維護）\n- **來源**: `config/fiscal_data.json` 中的 `japan_gdp_jpy`\n- **用途**: 計算 `debt_to_gdp = debt_stock_jpy / japan_gdp_jpy`\n- **注意**: 此值需手動維護，與財政數據同步更新\n\n## 資料口徑說明\n\n### 稅收口徑\n\n| 口徑 | 說明 | 數值量級 |\n|------|------|----------|\n| `national_tax` | 國稅（所得稅+法人稅+消費稅等） | ~60-65 兆 |\n| `general_account_tax` | 一般會計稅收 | ~70-75 兆 |\n| `total_revenue` | 總收入（含非稅收入） | ~100+ 兆 |\n\n### 利息口徑\n\n| 口徑 | 說明 | 數值量級 |\n|------|------|----------|\n| `interest_only` | 純利息支出 | ~8-10 兆 |\n| `debt_service` | 國債費（利息+本金償還） | ~25-28 兆 |\n\n**重要**：媒體敘事「1/3」通常使用 `debt_service / general_account_tax`。\n\n## 資料更新頻率\n\n| 資料類型 | 更新頻率 | 滯後 |\n|----------|----------|------|\n| JGB 殖利率 | 每日 | T+0 |\n| 稅收/利息 | 年度 | 1-2 年 |\n| 債務存量 | 季度/年度 | 1 季度 |\n| TIC 持有 | 月度 | 2 個月 |\n\n## 資料品質警示\n\n1. **殖利率 vs 財政資料時間不同步**：殖利率為即時，財政為歷史\n2. **會計年度差異**：日本財政年度為 4 月～3 月\n3. **口徑混用風險**：不同來源可能使用不同定義\n4. **預算 vs 決算**：預算數與實際執行數可能有差異\n\n## 緩存策略\n\n本 Skill 使用多層數據抓取與緩存機制：\n\n### 數據源優先級\n\n| 數據類型 | 優先級 1 | 優先級 2 | Fallback |\n|----------|----------|----------|----------|\n| JGB 殖利率 | FRED CSV | yfinance | 本地緩存/靜態 |\n| 財政數據 | config/fiscal_data.json | - | 硬編碼 fallback |\n| GDP 數據 | FRED CSV | - | 硬編碼 fallback |\n| TIC 持有 | TIC mfh.txt | - | 本地緩存/靜態 |\n\n### 緩存過期時間\n\n| 數據類型 | 緩存位置 | 過期時間 |\n|----------|----------|----------|\n| JGB 殖利率 | `data/cache/jgb_*.json` | 24 小時 |\n| GDP 數據 | `data/cache/gdp_data.json` | 7 天 |\n| TIC 持有 | `data/cache/tic_*.json` | 7 天 |\n| 財政數據 | `config/fiscal_data.json` | 手動更新 |\n\n### 驗證規則\n\n數據抓取後會進行範圍驗證：\n\n| 數據 | 最小值 | 最大值 |\n|------|--------|--------|\n| JGB 10Y | -0.5% | 5.0% |\n| 稅收 | 50 兆 | 100 兆 |\n| 利息支出 | 5 兆 | 35 兆 |\n| 債務存量 | 800 兆 | 1500 兆 |\n| US GDP | $20T | $40T |\n| Japan GDP | $3T | $8T |\n| UST 持有 | $500B | $2000B |\n\n### 強制刷新\n\n使用 `--refresh` 參數可忽略緩存強制抓取最新數據：\n\n```bash\npython scripts/japan_debt_analyzer.py --quick --refresh\n```\n",
        "skills/analyze-japan-debt-service-tax-burden/references/japan-fiscal-structure.md": "# 日本財政結構說明\n\n## 債務概況\n\n### 債務規模（2024 財政年度）\n\n| 指標 | 數值 | 備註 |\n|------|------|------|\n| 中央政府債務 | ~¥1,200 兆 | 約 $8 兆美元 |\n| 債務/GDP | ~260% | 全球最高 |\n| 人均債務 | ~¥1,000 萬 | ~$65,000 |\n\n### 債務持有結構\n\n| 持有者 | 比例 | 特徵 |\n|--------|------|------|\n| 日本銀行 (BOJ) | ~53% | 量化寬鬆累積 |\n| 國內金融機構 | ~25% | 銀行、保險、年金 |\n| 國內其他 | ~17% | 家庭、企業 |\n| 海外投資者 | ~5% | 相對較低 |\n\n**關鍵特徵**：95%+ 國內持有，降低外部擠兌風險。\n\n## 財政收支結構\n\n### 一般會計歲入（FY2024 預算）\n\n| 項目 | 金額 | 占比 |\n|------|------|------|\n| 稅收 | ~¥69 兆 | ~60% |\n| 國債發行 | ~¥35 兆 | ~30% |\n| 其他收入 | ~¥11 兆 | ~10% |\n| **合計** | ~¥115 兆 | 100% |\n\n### 一般會計歲出（FY2024 預算）\n\n| 項目 | 金額 | 占比 |\n|------|------|------|\n| 社會保障 | ~¥37 兆 | ~32% |\n| **國債費** | ~¥27 兆 | ~23% |\n| 地方交付稅 | ~¥17 兆 | ~15% |\n| 公共事業 | ~¥6 兆 | ~5% |\n| 防衛 | ~¥8 兆 | ~7% |\n| 其他 | ~¥20 兆 | ~18% |\n\n**國債費 ≈ 稅收的 40%**（含本金償還）\n\n### 國債費構成\n\n| 項目 | 金額 | 備註 |\n|------|------|------|\n| 利息支付 | ~¥9 兆 | 純利息成本 |\n| 債務償還 | ~¥17 兆 | 本金償還 |\n| 事務費 | ~¥1 兆 | 發行管理費 |\n\n**純利息/稅收 ≈ 13%**（較低）\n**國債費/稅收 ≈ 39%**（媒體常引用）\n\n## 為何利息負擔相對可控？\n\n### 1. 超低利率環境\n\n- 過去 20 年 10Y JGB < 1%\n- 存量債務以低利率發行\n- 平均票息 ~0.8%（遠低於名義利率）\n\n### 2. BOJ 持有效應\n\n- BOJ 持有的國債利息回流財政部\n- 實質利息成本更低\n\n### 3. 長平均到期\n\n- 平均到期 ~8-9 年\n- 利率上升傳導緩慢\n- 每年僅 ~11-12% 存量再定價\n\n## 風險情境\n\n### 若利率「正常化」\n\n假設平均利率升至 2%（歷史常態）：\n\n```\n新利息支出 ≈ ¥1,200 兆 × 2% = ¥24 兆\n（當前約 ¥9 兆）\n```\n\n但需 5-10 年才能完全傳導（再定價週期）。\n\n### 若發生財政危機\n\n可能觸發因素：\n1. 大規模資本外流\n2. 日圓急劇貶值\n3. BOJ 被迫收緊政策\n4. 國際評級大幅下調\n\n日本的緩衝：\n- 經常帳順差\n- 大量海外資產\n- 國內持有為主\n- 央行可作為最後買家\n\n## 與敘事的對照\n\n### 「利息吃掉 1/3 稅收」\n\n- 若用「國債費/稅收」：~39%，接近 1/3\n- 若用「純利息/稅收」：~13%，遠低於 1/3\n\n**口徑選擇決定敘事真偽。**\n\n### 「債務危機迫在眉睫」\n\n- 當前利息負擔可控\n- 但利率正常化風險存在\n- 需監控殖利率走勢與 BOJ 政策\n\n### 「日本會拋售美債」\n\n- 持有 ~$1.1 兆美債\n- 但大規模拋售會：\n  - 推升日圓（減少出口競爭力）\n  - 損失資產價值\n  - 可能觸發報復\n- 漸進減持可能，恐慌拋售不太可能\n",
        "skills/analyze-japan-debt-service-tax-burden/references/methodology.md": "### 1. 計算 Interest/Tax Ratio\n\n**定義**：\n```\ninterest_tax_ratio = interest_payments / tax_revenue\n```\n\n**解讀**：\n- 0.25 = 利息吃掉 1/4 稅收\n- 0.333 = 利息吃掉 1/3 稅收\n- 0.50 = 利息吃掉 1/2 稅收\n\n### 1.1 國債費/稅收比（Debt Service Ratio）\n\n**定義**：\n```\ndebt_service_tax_ratio = debt_service / tax_revenue\n```\n\n其中 `debt_service` = 利息支出 + 本金償還（國債費總額）\n\n**重要**：媒體敘事「利息吃掉 1/3 稅收」通常**誤用此口徑**，將國債費（含本金）誤稱為「interest payments alone」。\n\n**FY2025 對照**：\n| 口徑 | 分子 | 分母 | 比例 |\n|------|------|------|------|\n| 純利息/稅收 | 10.5 兆 | 70 兆 | **15.0%** |\n| 國債費/稅收 | 28.2 兆 | 70 兆 | **40.3%** |\n\n### 1.2 隱含平均利率（Implied Average Rate）\n\n**定義**：\n```\nimplied_avg_rate = interest_payments / debt_stock\n```\n\n**用途**：衡量存量債務的平均融資成本，對比當前市場利率可評估再融資壓力。\n\n**FY2025 計算**：\n```\nimplied_avg_rate = 10.5 兆 / 1,324 兆 = 0.79% ≈ 0.8%\n```\n\n**解讀**：\n- 隱含利率 **0.8%** vs 當前 10Y 殖利率 **2.0%+**\n- 差距說明大量存量債務在低利率時期（YCC/零利率）發行\n- 隨著再融資，利息負擔將逐年攀升\n\n### 1.3 「in US terms」換算邏輯\n\n**背景**：媒體常將日本債務以「美國等效規模」表達以增強震撼效果。\n\n**換算公式**（動態計算）：\n```\ndebt_to_gdp = japan_debt_stock / japan_gdp\ndebt_in_us_terms = us_gdp × debt_to_gdp\n```\n\n**數據來源**：\n- `us_gdp`：從 FRED 系列 `GDP` 實時抓取\n- `japan_gdp`：從 FRED 系列 `JPNNGDP` 實時抓取，或使用配置中的 `japan_gdp_jpy`\n- `japan_debt_stock`：從 `fiscal_data.json` 配置讀取\n\n**計算範例**（數值會隨實時數據變動）：\n```python\n# 假設抓取到的數據\nus_gdp = $30.6T（FRED 最新）\njapan_gdp_jpy = ¥530 兆（配置）\njapan_debt_stock = ¥1,324 兆（配置）\n\n# 計算\ndebt_to_gdp = 1324 / 530 = 2.50 (250%)\ndebt_in_us_terms = $30.6T × 2.50 = $76.5T\n```\n\n**解讀**：\n- 這是「若美國有相同債務/GDP比例，債務規模會是多少」\n- 媒體稱「$70T」即來自此換算邏輯（口語化）\n- 用於跨國比較時統一規模感知\n\n### 2. 風險分級\n\n| 區間      | 分級      | 含義                |\n|-----------|-----------|---------------------|\n| < 0.25    | 🟢 GREEN  | 財政彈性充足        |\n| 0.25–0.40 | 🟡 YELLOW | 彈性開始下降        |\n| 0.40–0.55 | 🟠 ORANGE | 政策空間明顯受限    |\n| > 0.55    | 🔴 RED    | 接近敘事「2/3」區域 |\n\n**閾值依據**：\n- 0.25：一般財政健康標準\n- 0.40：OECD 多數國家不超過此水平\n- 0.55：接近歷史極端情況\n\n## 壓力測試公式\n\n### 利率衝擊映射\n\n**核心公式**：\n```\nadditional_interest = debt_stock × pass_through × delta_yield\n```\n\n其中：\n- `debt_stock`：債務存量（日圓）\n- `pass_through`：年度再定價/再融資比例\n- `delta_yield`：殖利率上升幅度（小數，200bp = 0.02）\n\n**範例**：\n```\ndebt_stock = ¥1,200 兆\npass_through = 0.15（15%）\ndelta_yield = 0.02（200bp）\n\nadditional_interest = 1,200 × 0.15 × 0.02 = ¥3.6 兆\n```\n\n### 壓測後比率\n\n```\nstressed_ratio = (interest_payments + additional_interest) / (tax_revenue × (1 + tax_shock))\n```\n\n其中 `tax_shock` 為稅收衝擊（負數=下降）。\n\n### 多年累積效應\n\nYear 2 使用累積 pass_through：\n```\ncumulative_pass_through = pass_through_year1 + pass_through_year2\n```\n\n假設每年 15%，兩年累積 30% 存量債務被再定價。\n\n## 殖利率統計分析\n\n### Z-Score\n\n```python\nzscore = (latest - mean) / std\n```\n\n**解讀**：\n- |Z| > 2.0：處於極端區域\n- |Z| > 1.5：處於偏離區域\n\n### 百分位數\n\n```python\npercentile = (series <= latest).mean()\n```\n\n**解讀**：\n- > 0.95：近乎歷史最高\n- > 0.80：處於高位區\n- 0.20–0.80：中性區\n\n## Pass-Through 估算\n\n### 方法 1：平均到期年限\n\n```\npass_through ≈ 1 / average_maturity\n```\n\n日本政府債務平均到期 ~8-9 年 → pass_through ~11-12%\n\n### 方法 2：年度發債/到期數據\n\n```\npass_through = (redemptions + new_issuance_at_new_rate) / debt_stock\n```\n\n若有實際發債計劃數據，此方法更精確。\n\n### 預設假設\n\n本 Skill 使用 15% 作為保守估計，涵蓋：\n- 到期再融資 ~11%\n- 新增發債 ~4%\n\n## 敘事核對邏輯\n\n### 「殖利率創 40 年新高」\n\n核對方法：\n1. 取 40 年歷史數據\n2. 計算 percentile_rank\n3. 若 > 0.99 且 latest > max(history[-40Y:]) → 敘事成立\n\n### 「利息吃掉 1/3 稅收」\n\n核對方法：\n1. 確認口徑（哪種稅收？純利息還是國債費？）\n2. 計算 interest_tax_ratio\n3. 若 ≈ 0.333 且口徑對齊 → 敘事成立\n\n### 「日本會拋售美債」\n\n核對方法：\n1. 確認日本持有美債規模（TIC）\n2. 標示潛在通道與量級\n3. **不做行為預測**：持有 ≠ 會拋售\n\n## 局限性\n\n1. **資料滯後**：財政數據通常有 1-2 年滯後\n2. **口徑差異**：不同來源定義不同\n3. **結構假設**：pass_through 是假設，非實際數據\n4. **單一國家**：當前僅支援日本，跨國比較需調整\n5. **非線性效應**：極端情況可能有非線性反應\n",
        "skills/analyze-japan-debt-service-tax-burden/templates/output-json.md": "# JSON 輸出模板\n\n## 完整輸出結構\n\n```json\n{\n  \"skill\": \"analyze_japan_debt_service_tax_burden\",\n  \"mode\": \"full_analysis\",\n  \"as_of\": \"2026-01-20\",\n\n  \"yield_stats\": {\n    \"tenor\": \"10Y\",\n    \"latest\": 1.23,\n    \"zscore\": 2.10,\n    \"percentile\": 0.97,\n    \"window_days\": 504,\n    \"min\": 0.65,\n    \"max\": 1.25,\n    \"mean\": 0.92,\n    \"interpretation\": \"分位數 97%，處於極端高位區\"\n  },\n\n  \"fiscal\": {\n    \"tax_revenue_jpy\": 72000000000000,\n    \"interest_payments_jpy\": 24000000000000,\n    \"debt_stock_jpy\": 1200000000000000,\n    \"interest_tax_ratio\": 0.3333,\n    \"risk_band\": \"yellow\",\n    \"risk_band_emoji\": \"🟡\",\n    \"definition\": {\n      \"tax_revenue_series\": \"general_account_tax\",\n      \"interest_payment_series\": \"interest_only\",\n      \"fiscal_year\": \"FY2024\"\n    }\n  },\n\n  \"stress_tests\": [\n    {\n      \"name\": \"+100bp baseline\",\n      \"assumptions\": {\n        \"delta_yield_bp\": 100,\n        \"pass_through_year1\": 0.15,\n        \"pass_through_year2\": 0.15,\n        \"tax_shock\": 0.0\n      },\n      \"results\": {\n        \"year1_interest_tax_ratio\": 0.3583,\n        \"year2_interest_tax_ratio\": 0.3833\n      },\n      \"risk_band_year1\": \"yellow\",\n      \"risk_band_year2\": \"yellow\"\n    },\n    {\n      \"name\": \"+200bp baseline\",\n      \"assumptions\": {\n        \"delta_yield_bp\": 200,\n        \"pass_through_year1\": 0.15,\n        \"pass_through_year2\": 0.15,\n        \"tax_shock\": 0.0\n      },\n      \"results\": {\n        \"year1_interest_tax_ratio\": 0.3833,\n        \"year2_interest_tax_ratio\": 0.4333\n      },\n      \"risk_band_year1\": \"yellow\",\n      \"risk_band_year2\": \"orange\"\n    },\n    {\n      \"name\": \"+200bp + recession (-5% tax)\",\n      \"assumptions\": {\n        \"delta_yield_bp\": 200,\n        \"pass_through_year1\": 0.15,\n        \"pass_through_year2\": 0.15,\n        \"tax_shock\": -0.05\n      },\n      \"results\": {\n        \"year1_interest_tax_ratio\": 0.4035,\n        \"year2_interest_tax_ratio\": 0.4561\n      },\n      \"risk_band_year1\": \"orange\",\n      \"risk_band_year2\": \"orange\"\n    }\n  ],\n\n  \"spillover_channel\": {\n    \"enabled\": true,\n    \"us_assets_estimate_usd\": 3000000000000,\n    \"ust_holdings_usd\": 1100000000000,\n    \"components\": [\n      \"UST holdings (TIC)\",\n      \"Agency securities\",\n      \"Corporate bonds\",\n      \"Equities\"\n    ],\n    \"note\": \"僅標示潛在通道與量級；是否『會拋售』屬行為假設，需搭配資金流/政策約束判讀\"\n  },\n\n  \"headline_takeaways\": [\n    \"當前 interest/tax ratio 為 33.3%，處於 YELLOW 區\",\n    \"10Y JGB 殖利率 1.23% 處於 97% 分位，接近近期極值\",\n    \"最嚴重壓測情境下，兩年後 ratio 可能升至 45.6%，進入 ORANGE 區\",\n    \"注意：不同口徑（國稅 vs 一般會計 vs 總收入）會產生不同數值，本分析已標示使用口徑\"\n  ]\n}\n```\n\n## 快速檢查輸出\n\n```json\n{\n  \"mode\": \"quick_check\",\n  \"as_of\": \"2026-01-20\",\n  \"yield_stats\": {\n    \"tenor\": \"10Y\",\n    \"latest\": 1.23,\n    \"percentile\": 0.97\n  },\n  \"fiscal\": {\n    \"interest_tax_ratio\": 0.333,\n    \"risk_band\": \"yellow\",\n    \"risk_band_emoji\": \"🟡\"\n  },\n  \"headline\": \"利息支出佔稅收 33.3%，處於🟡 YELLOW 區\"\n}\n```\n\n## 欄位說明\n\n### yield_stats\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| tenor | string | 觀察期限（如 10Y） |\n| latest | float | 最新殖利率（%） |\n| zscore | float | Z-score（標準差距離） |\n| percentile | float | 百分位數（0-1） |\n| window_days | int | 分析視窗（交易日） |\n| interpretation | string | 人類可讀解讀 |\n\n### fiscal\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| tax_revenue_jpy | int | 稅收（日圓） |\n| interest_payments_jpy | int | 利息支出（日圓） |\n| debt_stock_jpy | int | 債務存量（日圓） |\n| interest_tax_ratio | float | 利息/稅收比 |\n| risk_band | string | 風險分級（green/yellow/orange/red） |\n| definition | object | 口徑定義 |\n\n### stress_tests\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| name | string | 情境名稱 |\n| assumptions | object | 假設參數 |\n| results | object | 壓測結果 |\n| risk_band_year1 | string | Year 1 風險分級 |\n| risk_band_year2 | string | Year 2 風險分級 |\n",
        "skills/analyze-japan-debt-service-tax-burden/templates/output-markdown.md": "# Markdown 報告模板\n\n## 標準報告格式\n\n```markdown\n# 分析日本債務利息負擔報告\n\n> 分析日期：{as_of}\n\n## 摘要\n\n**{headline}**\n\n## 殖利率狀態\n\n| 指標           | 數值          |\n|----------------|---------------|\n| {tenor} 殖利率 | {latest}%     |\n| 百分位數       | {percentile}% |\n| Z-Score        | {zscore}      |\n\n{interpretation}\n\n## 財政利息負擔\n\n| 指標               | 數值                            |\n|--------------------|---------------------------------|\n| 稅收               | ¥{tax_revenue_jpy/1e12}兆       |\n| 利息支出           | ¥{interest_payments_jpy/1e12}兆 |\n| 債務存量           | ¥{debt_stock_jpy/1e12}兆        |\n| Interest/Tax Ratio | {interest_tax_ratio}%           |\n| 風險分級           | {risk_band_emoji} {risk_band}   |\n\n**口徑說明**：\n- 稅收：{tax_revenue_series}\n- 利息：{interest_payment_series}\n- 財政年度：{fiscal_year}\n\n## 壓力測試結果\n\n| 情境 | Year 1 Ratio | Year 2 Ratio | 風險分級 |\n|------|--------------|--------------|----------|\n{stress_test_rows}\n\n## 外溢通道（日本對美資產）\n\n- 估計總規模：${us_assets_estimate_usd/1e12}兆\n- 美債持有：${ust_holdings_usd/1e12}兆\n\n> {spillover_note}\n\n## 要點摘要\n\n{headline_takeaways}\n\n---\n\n*報告由 analyze-japan-debt-service-tax-burden skill 自動生成*\n```\n\n## 範例輸出\n\n```markdown\n# 分析日本債務利息負擔報告\n\n> 分析日期：2026-01-20\n\n## 摘要\n\n**利息支出佔稅收 33.3%，處於🟡 YELLOW 區**\n\n## 殖利率狀態\n\n| 指標       | 數值  |\n|------------|-------|\n| 10Y 殖利率 | 1.23% |\n| 百分位數   | 97%   |\n| Z-Score    | 2.10  |\n\n分位數 97%，處於極端高位區\n\n## 財政利息負擔\n\n| 指標               | 數值       |\n|--------------------|------------|\n| 稅收               | ¥72.0兆    |\n| 利息支出           | ¥24.0兆    |\n| 債務存量           | ¥1,200.0兆 |\n| Interest/Tax Ratio | 33.3%      |\n| 風險分級           | 🟡 YELLOW  |\n\n**口徑說明**：\n- 稅收：general_account_tax\n- 利息：interest_only\n- 財政年度：FY2024\n\n## 壓力測試結果\n\n| 情境                         | Year 1 Ratio | Year 2 Ratio | 風險分級  |\n|------------------------------|--------------|--------------|-----------|\n| +100bp baseline              | 35.8%        | 38.3%        | 🟡 YELLOW |\n| +200bp baseline              | 38.3%        | 43.3%        | 🟠 ORANGE |\n| +200bp + recession (-5% tax) | 40.4%        | 45.6%        | 🟠 ORANGE |\n| +300bp severe stress         | 43.3%        | 53.3%        | 🟠 ORANGE |\n\n## 外溢通道（日本對美資產）\n\n- 估計總規模：$3.0兆\n- 美債持有：$1.1兆\n\n> 僅標示潛在通道與量級；是否『會拋售』屬行為假設，需搭配資金流/政策約束判讀\n\n## 要點摘要\n\n- 當前 interest/tax ratio 為 33.3%，處於 YELLOW 區\n- 10Y JGB 殖利率 1.23% 處於 97% 分位，接近近期極值\n- 最嚴重壓測情境下，兩年後 ratio 可能升至 53.3%，進入 ORANGE 區\n- 注意：不同口徑會產生不同數值，本分析已標示使用口徑\n\n---\n\n*報告由 analyze-japan-debt-service-tax-burden skill 自動生成*\n```\n\n## 格式化規則\n\n### 數值格式\n\n| 類型       | 格式                | 範例    |\n|------------|---------------------|---------|\n| 百分比     | {value:.1%}         | 33.3%   |\n| 金額（兆） | ¥{value/1e12:.1f}兆 | ¥72.0兆 |\n| 殖利率     | {value:.2f}%        | 1.23%   |\n| 分位數     | {value:.0%}         | 97%     |\n\n### 風險分級 Emoji\n\n| 分級   | Emoji |\n|--------|-------|\n| green  | 🟢    |\n| yellow | 🟡    |\n| orange | 🟠    |\n| red    | 🔴    |\n",
        "skills/analyze-japan-debt-service-tax-burden/workflows/full-analysis.md": "# 完整分析工作流\n\n執行完整的分析日本債務利息負擔，包含現況核對、壓力測試與外溢通道評估。\n\n## 執行步驟\n\n### Step 1: 安裝依賴\n\n```bash\ncd skills/analyze-japan-debt-service-tax-burden\npip install pandas numpy requests\n```\n\n### Step 2: 執行完整分析\n\n```bash\npython scripts/japan_debt_analyzer.py --full\n```\n\n或指定 JSON 輸出：\n```bash\npython scripts/japan_debt_analyzer.py --full --format json\n```\n\n### Step 3: 解讀各區塊結果\n\n#### 3.1 殖利率狀態 (yield_stats)\n\n```json\n{\n  \"tenor\": \"10Y\",\n  \"latest\": 1.23,\n  \"zscore\": 2.10,\n  \"percentile\": 0.97,\n  \"interpretation\": \"分位數 97%，處於極端高位區\"\n}\n```\n\n**核對敘事**：\n- 若 percentile > 0.95 且 zscore > 2.0 → 接近極值，敘事「創高」可能成立\n- 若 percentile < 0.80 → 敘事可能誇大\n\n#### 3.2 財政利息負擔 (fiscal)\n\n```json\n{\n  \"interest_tax_ratio\": 0.333,\n  \"risk_band\": \"yellow\",\n  \"definition\": {\n    \"tax_revenue_series\": \"general_account_tax\",\n    \"interest_payment_series\": \"interest_only\",\n    \"fiscal_year\": \"FY2024\"\n  }\n}\n```\n\n**核對敘事**：\n- 0.333 ≈ 1/3，敘事「利息吃掉 1/3 稅收」可驗證\n- 注意口徑：若用 total_revenue（含非稅收入），ratio 會較低\n\n#### 3.3 壓力測試 (stress_tests)\n\n```json\n{\n  \"name\": \"+200bp baseline\",\n  \"results\": {\n    \"year1_interest_tax_ratio\": 0.383,\n    \"year2_interest_tax_ratio\": 0.433\n  },\n  \"risk_band_year2\": \"orange\"\n}\n```\n\n**敏感度分析**：\n- 主要驅動因子：債務存量 × 再定價速度 × 利率衝擊\n- Year 2 累積效應：兩年再定價約 30% 存量債務\n\n#### 3.4 外溢通道 (spillover_channel)\n\n```json\n{\n  \"us_assets_estimate_usd\": 3000000000000,\n  \"ust_holdings_usd\": 1100000000000,\n  \"note\": \"僅標示通道與量級，不做行為預測\"\n}\n```\n\n**謹慎解讀**：\n- 「持有」≠「會拋售」\n- 實際拋售受制於：政策約束、匯率影響、市場深度\n\n### Step 4: 輸出報告\n\n完整 Markdown 報告會包含：\n1. 摘要 headline\n2. 殖利率狀態表\n3. 財政負擔表\n4. 壓力測試結果表\n5. 外溢通道說明\n6. 要點摘要列表\n\n## 自定義分析\n\n若需調整參數，編輯腳本或使用 `--stress` 單一壓測：\n\n```bash\n# 壓測 +150bp\npython scripts/japan_debt_analyzer.py --stress 150\n\n# 不含外溢分析\npython scripts/japan_debt_analyzer.py --full --no-spillover\n```\n",
        "skills/analyze-japan-debt-service-tax-burden/workflows/generate-chart.md": "# 圖表生成工作流\n\n生成日本債務利息負擔的視覺化 Dashboard。\n\n## 執行步驟\n\n### Step 1: 執行圖表生成腳本\n\n**完整模式**（推薦，包含壓力測試）：\n```bash\ncd skills/analyze-japan-debt-service-tax-burden\npython scripts/generate_charts.py --full --output-dir ../../output\n```\n\n**快速模式**：\n```bash\npython scripts/generate_charts.py --quick --output-dir ../../output\n```\n\n**從 JSON 檔案載入**：\n```bash\npython scripts/generate_charts.py --data-file data.json --output-dir ../../output\n```\n\n### Step 2: 確認輸出\n\n輸出檔案：`output/japan_debt_dashboard_YYYYMMDD.png`\n\n### Step 3: Dashboard 內容說明\n\n生成的 Dashboard 包含四個區塊：\n\n| 區塊 | 說明 |\n|------|------|\n| **風險儀表盤** (左上) | Interest/Tax Ratio 半圓儀表盤，顯示當前比例與風險區間 |\n| **殖利率指標** (中上) | 10Y JGB 殖利率分位數指標，標示是否處於極端位置 |\n| **財政摘要** (右上) | 稅收、利息支出、存量債務、隱含平均利率 |\n| **壓力測試** (下方) | 多情境壓力測試結果條形圖，Year 1 vs Year 2 對比 |\n\n### Step 4: 風險分級顏色\n\n| 顏色 | 區間 | 含義 |\n|------|------|------|\n| 綠色 | < 25% | 財政彈性充足 |\n| 黃色 | 25-40% | 彈性開始下降 |\n| 橘色 | 40-55% | 政策空間受限 |\n| 紅色 | > 55% | 接近危險區 |\n\n## 進階選項\n\n### 指定輸出檔名\n```bash\npython scripts/generate_charts.py --full --output-file my_dashboard.png\n```\n\n### 強制刷新數據\n```bash\npython scripts/generate_charts.py --full --refresh --output-dir ../../output\n```\n\n### 顯示圖表（不只存檔）\n```bash\npython scripts/generate_charts.py --full --show\n```\n\n## 輸出範例\n\nDashboard 範例輸出：\n\n```\n┌─────────────────┬─────────────────┬─────────────────┐\n│  風險儀表盤     │  殖利率指標     │  財政摘要       │\n│     15.0%       │  10Y: 2.06%     │  稅收: ¥70兆    │\n│   ● GREEN       │  分位: 100%     │  利息: ¥10.5兆  │\n└─────────────────┴─────────────────┴─────────────────┘\n┌─────────────────────────────────────────────────────┐\n│                 壓力測試情境比較                    │\n│  +100bp baseline   ████████░░░░░░░  17.8% → 20.7%  │\n│  +200bp baseline   ██████████░░░░░  20.7% → 26.4%  │\n│  +200bp recession  ██████████░░░░░  21.8% → 27.7%  │\n│  +300bp stress     █████████████░░  26.1% → 35.6%  │\n└─────────────────────────────────────────────────────┘\n```\n\n## 常見問題\n\n### 字體警告\n如果出現中文字體警告，請確保系統安裝以下字體之一：\n- Microsoft JhengHei\n- PingFang TC\n- Noto Sans CJK TC\n\n### matplotlib 安裝\n```bash\npip install matplotlib\n```\n",
        "skills/analyze-japan-debt-service-tax-burden/workflows/historical-trend.md": "# 歷史趨勢分析工作流\n\n分析 2015-2025 年日本債務利息支出佔稅收比例的完整歷史趨勢。\n\n## 功能概述\n\n此工作流提供：\n- 11 年完整財政數據時間序列（FY2015-FY2025）\n- Interest/Tax Ratio 歷史走勢分析\n- 稅收、利息支出、債務存量趨勢圖\n- 隱含平均利率演變\n- 風險分級分布統計\n\n## 執行步驟\n\n### Step 1: 執行歷史趨勢分析\n\n**完整分析（2015-2025）**：\n```bash\ncd skills/analyze-japan-debt-service-tax-burden\npython scripts/generate_historical_trend.py --output-dir ../../output\n```\n\n**自定義時間範圍**：\n```bash\npython scripts/generate_historical_trend.py --start-year 2018 --end-year 2025 --output-dir ../../output\n```\n\n**指定輸出檔名**：\n```bash\npython scripts/generate_historical_trend.py --output-file custom_trend.png --output-dir ../../output\n```\n\n### Step 2: 查看輸出\n\n輸出檔案：`output/japan_debt_trend_YYYYMMDD.png`\n\n### Step 3: 圖表內容說明\n\n生成的綜合 Dashboard 包含五個區塊：\n\n| 區塊 | 說明 |\n|------|------|\n| **主趨勢圖** (上方) | Interest/Tax Ratio 完整歷史曲線，帶風險區間背景 |\n| **稅收 vs 利息** (中左) | 稅收與利息支出雙柱狀圖對比 |\n| **債務存量** (中右) | 政府債務存量趨勢（面積圖） |\n| **隱含利率** (下左) | 債務隱含平均利率演變 |\n| **風險分布** (下右) | 各風險等級年度數量統計 |\n\n## 關鍵發現（2015-2025）\n\n### 1. 整體趨勢\n\n根據最新分析：\n\n| 指標 | 數值 |\n|------|------|\n| **比率範圍** | 12.1% ~ 17.4% |\n| **平均比率** | 14.3% |\n| **FY2015** | 17.4%（最高） |\n| **FY2021** | 12.1%（最低） |\n| **FY2025** | 15.0%（當前） |\n\n**長期趨勢**：2015 → 2025 整體下降（17.4% → 15.0%）\n\n### 2. 階段性特徵\n\n**階段一：2015-2019（下降期）**\n- 比率從 17.4% 下降至 14.7%\n- 原因：稅收成長 + 利息支出下降（超低利率環境）\n\n**階段二：2020-2021（疫情衝擊後恢復）**\n- 比率降至歷史最低 12.1%（FY2021）\n- 原因：疫情後財政擴張，稅收強勁反彈\n\n**階段三：2022-2025（反彈期）**\n- 比率從 12.3% 反彈至 15.0%\n- 原因：利率正常化，利息支出快速上升\n\n### 3. 風險評估\n\n**所有年度均處於 🟢 GREEN 區**（<25%）\n- 表示財政彈性充足\n- 尚未進入警戒區域\n\n**但需注意**：\n1. 2024-2025 利息支出快速上升（8.5兆 → 10.5兆）\n2. 債務存量持續增長（838兆 → 1324兆，增長 58%）\n3. 隱含平均利率極低（~0.8%），未來再融資壓力大\n\n## 數據來源\n\n| 數據類型 | 來源 | 更新時間 |\n|----------|------|----------|\n| FY2015-FY2022 | MOF Settlement Data | 2026-01-20 更新 |\n| FY2023 | MOF FY2023 Settlement | 2024-07-01 |\n| FY2024 | MOF FY2024 Budget | 2024-04-01 |\n| FY2025 | MOF FY2025 Budget | 2025-04-01 |\n\n所有數據口徑：\n- 稅收：一般會計稅收\n- 利息：純利息支出（不含本金償還）\n- 債務：政府債務存量\n\n## 進階分析\n\n### 結合當前殖利率分析\n\n```bash\n# 執行完整分析（含當前殖利率狀態）\npython scripts/japan_debt_analyzer.py --full\n\n# 執行歷史趨勢分析\npython scripts/generate_historical_trend.py --output-dir ../../output\n```\n\n### 結合壓力測試\n\n```bash\n# 生成債務螺旋模擬（10年前瞻）\npython scripts/generate_spiral_chart.py --all --output-dir ../../output\n```\n\n將歷史趨勢與未來壓力情境結合，可評估：\n- 歷史比率低點（12.1%）是否可持續\n- 當前反彈速度（+2.7個百分點/2年）是否會延續\n- 不同利率情境下到達警戒區（25%）的時間\n\n## 輸出範例\n\n### 控制台輸出\n\n```\n================================================================================\n日本債務利息負擔歷史趨勢摘要 (2015-2025)\n================================================================================\n\n年度       稅收(兆)        利息(兆)        債務(兆)        比率         風險\n--------------------------------------------------------------------------------\nFY2015        56.28         9.80          838      17.4%  GREEN\nFY2016        55.46         9.20          865      16.6%  GREEN\nFY2017        58.79         8.90          882      15.1%  GREEN\nFY2018        60.35         8.80          897      14.6%  GREEN\nFY2019        58.44         8.60          917      14.7%  GREEN\nFY2020        60.83         8.20          990      13.5%  GREEN\nFY2021        67.03         8.10         1017      12.1%  GREEN\nFY2022        68.36         8.40         1013      12.3%  GREEN\nFY2023        69.44         8.50         1270      12.2%  GREEN\nFY2024        72.00        10.00         1286      13.9%  GREEN\nFY2025        70.00        10.50         1324      15.0%  GREEN\n================================================================================\n\n關鍵統計:\n  - 比率範圍: 12.1% ~ 17.4%\n  - 平均比率: 14.3%\n  - 當前比率 (FY2025): 15.0%\n  - 趨勢: 下降 (17.4% → 15.0%)\n\n風險分級分布:\n  - GREEN: 11 年度\n```\n\n### 視覺化 Dashboard\n\n參見生成的 PNG 檔案，包含：\n- 主趨勢線圖（帶風險區間背景）\n- 數值標註\n- 多維度子圖\n- 數據來源與生成時間戳記\n\n## 常見問題\n\n### Q1: 為何 2020-2021 比率大幅下降？\n\n**A**: 兩個主要原因：\n1. **利率環境**：BOJ 維持超低利率，存量債務再融資成本極低\n2. **疫情後稅收反彈**：2021 稅收達 67 兆（創歷史新高），分母效應\n\n### Q2: 為何 2024-2025 快速反彈？\n\n**A**:\n1. **利息支出飆升**：從 8.5 兆跳升至 10.5 兆（+23.5%）\n2. **利率正常化**：10Y JGB 從負利率升至 2%+\n3. **債務再定價**：存量債務陸續以更高利率再融資\n\n### Q3: 未來會進入黃色警戒區（25%）嗎？\n\n**A**: 需執行壓力測試：\n```bash\npython scripts/generate_spiral_chart.py --all --output-dir ../../output\n```\n\n根據不同利率情境：\n- **基準情境（+100bp）**：5-7 年內可能接近 25%\n- **壓力情境（+200bp）**：3-5 年內可能達到 25%\n- **極端情境（+300bp）**：2-3 年內可能突破 25%\n\n## 更新維護\n\n### 新增年度數據\n\n編輯 `config/fiscal_data.json`：\n\n```json\n{\n  \"data\": {\n    \"FY2026\": {\n      \"tax_revenue_jpy\": 73000000000000,\n      \"interest_payments_jpy\": 11000000000000,\n      \"debt_service_jpy\": 29000000000000,\n      \"debt_stock_jpy\": 1350000000000000,\n      \"source\": \"MOF FY2026 Budget\",\n      \"updated_at\": \"2026-04-01\",\n      \"notes\": \"FY2026 預算案數據\"\n    }\n  }\n}\n```\n\n然後重新執行分析腳本。\n\n### 數據驗證\n\n腳本會自動檢查數據合理性：\n- 稅收範圍：50-100 兆\n- 利息支出：5-35 兆\n- 債務存量：800-1500 兆\n\n超出範圍會發出警告。\n",
        "skills/analyze-japan-debt-service-tax-burden/workflows/quick-check.md": "# 快速檢查工作流\n\n快速查看日本當前利息/稅收比與殖利率狀態。\n\n## 執行步驟\n\n### Step 1: 執行快速檢查腳本\n\n```bash\ncd skills/analyze-japan-debt-service-tax-burden\npython scripts/japan_debt_analyzer.py --quick\n```\n\n### Step 2: 解讀結果\n\n輸出範例：\n```json\n{\n  \"yield_stats\": {\n    \"tenor\": \"10Y\",\n    \"latest\": 1.23,\n    \"percentile\": 0.97\n  },\n  \"fiscal\": {\n    \"interest_tax_ratio\": 0.333,\n    \"risk_band\": \"yellow\",\n    \"risk_band_emoji\": \"🟡\"\n  },\n  \"headline\": \"利息支出佔稅收 33.3%，處於🟡 YELLOW 區\"\n}\n```\n\n### Step 3: 風險分級解讀\n\n| 區間 | 含義 | 建議動作 |\n|------|------|----------|\n| 🟢 GREEN | 財政彈性充足 | 持續監控 |\n| 🟡 YELLOW | 彈性開始下降 | 留意殖利率走勢 |\n| 🟠 ORANGE | 政策空間受限 | 關注財政調整 |\n| 🔴 RED | 接近危險區 | 深度分析 |\n\n## 若需更詳細分析\n\n轉向 `workflows/full-analysis.md` 執行完整分析。\n",
        "skills/analyze-japan-debt-service-tax-burden/workflows/spiral-simulate.md": "# 債務螺旋模擬工作流\n\n模擬多年累積效應，視覺化展示 Interest/Tax Ratio 如何在持續高利率環境下逐年惡化。\n\n## 核心概念\n\n**債務螺旋邏輯**：\n```\nYear N: cumulative_pass_through = min(N × 0.15, 1.0)\n        additional_interest = debt_stock × cumulative_pass_through × delta_yield\n        ratio = (base_interest + additional_interest) / (tax × tax_growth^N)\n```\n\n隨著時間推移，越來越多存量債務以新高利率再融資，利息負擔逐年累積上升。\n\n## 快速執行\n\n### 完整多情境 Dashboard\n\n```bash\ncd skills/analyze-japan-debt-service-tax-burden\npython scripts/generate_spiral_chart.py --all --output-dir ../../../output\n```\n\n輸出包含 4 種情境：\n- 基準（維持現狀）\n- +200bp（利率正常化）\n- +200bp + 衰退（稅收 -3%/年）\n- +300bp 嚴重衝擊\n\n### 單一壓力情境\n\n```bash\n# +200bp 衝擊\npython scripts/generate_spiral_chart.py --stress 200 --output-dir ../../../output\n\n# +300bp 衝擊\npython scripts/generate_spiral_chart.py --stress 300 --output-dir ../../../output\n```\n\n### 自定義模擬年數\n\n```bash\n# 15 年模擬\npython scripts/generate_spiral_chart.py --years 15 --output-dir ../../../output\n```\n\n## 輸出圖表說明\n\n### 1. 螺旋比較圖（主圖）\n\n- **X 軸**：模擬年數（0-10 年）\n- **Y 軸**：Interest/Tax Ratio（0-70%）\n- **背景區間**：綠/黃/橙/紅風險區\n- **曲線**：各情境 Ratio 演變軌跡\n- **終點標註**：最終 Ratio 與風險等級\n\n### 2. 利息分解圖\n\n- 堆疊柱狀圖展示「原始利息 + 新增利息」\n- 清晰顯示利率上升帶來的增量負擔\n\n### 3. 摘要統計\n\n- 初始財政數據\n- 各情境 Year 10 結果與風險等級\n\n## 情境設計參考\n\n### 保守情境\n\n```python\n{\n    \"name\": \"温和升息\",\n    \"delta_yield_bp\": 100,\n    \"tax_growth\": 0.02,  # 經濟成長 2%\n}\n```\n\n### 壓力情境\n\n```python\n{\n    \"name\": \"+200bp + 經濟停滯\",\n    \"delta_yield_bp\": 200,\n    \"tax_growth\": 0.0,  # 稅收不變\n}\n```\n\n### 嚴重情境\n\n```python\n{\n    \"name\": \"+300bp + 衰退\",\n    \"delta_yield_bp\": 300,\n    \"tax_growth\": -0.05,  # 稅收年減 5%\n}\n```\n\n## 解讀指引\n\n### 風險區間含義\n\n| 區間 | Ratio | 含義 |\n|------|-------|------|\n| GREEN | <25% | 財政彈性充足 |\n| YELLOW | 25-40% | 政策空間開始受限 |\n| ORANGE | 40-55% | 需要政策調整 |\n| RED | >55% | 接近「利息吃掉 2/3 稅收」敘事區 |\n\n### 關鍵觀察點\n\n1. **曲線斜率**：斜率越陡，惡化速度越快\n2. **交叉點**：何時從綠區進入黃區？從黃區進入橙區？\n3. **收斂性**：是否在某年後趨於穩定（pass_through 達到 100%）\n4. **情境差異**：稅收成長/衰退對結果的影響有多大？\n\n## 與其他工作流搭配\n\n1. **先執行快速檢查**（quick-check.md）了解當前狀態\n2. **再執行螺旋模擬**了解長期風險\n3. **最後生成完整 Dashboard**（generate-chart.md）綜合報告\n",
        "skills/analyze-japan-debt-service-tax-burden/workflows/stress-test.md": "# 情境壓力測試工作流\n\n自定義殖利率衝擊情境，評估對利息負擔的影響。\n\n## 基本壓測\n\n### 單一利率衝擊\n\n```bash\n# +100bp 衝擊\npython scripts/japan_debt_analyzer.py --stress 100\n\n# +200bp 衝擊\npython scripts/japan_debt_analyzer.py --stress 200\n\n# +300bp 嚴重衝擊\npython scripts/japan_debt_analyzer.py --stress 300\n```\n\n## 進階壓測（修改腳本）\n\n### Step 1: 自定義情境\n\n編輯 `scripts/japan_debt_analyzer.py` 中的 `DEFAULT_SCENARIOS`：\n\n```python\nCUSTOM_SCENARIOS = [\n    {\n        \"name\": \"+150bp with 20% pass-through\",\n        \"delta_yield_bp\": 150,\n        \"pass_through_year1\": 0.20,  # 較高再定價速度\n        \"pass_through_year2\": 0.20,\n        \"tax_shock\": 0.0,\n    },\n    {\n        \"name\": \"+200bp + stagflation\",\n        \"delta_yield_bp\": 200,\n        \"pass_through_year1\": 0.15,\n        \"pass_through_year2\": 0.15,\n        \"tax_shock\": -0.10,  # 稅收下降 10%\n    },\n    {\n        \"name\": \"+250bp + fiscal consolidation\",\n        \"delta_yield_bp\": 250,\n        \"pass_through_year1\": 0.15,\n        \"pass_through_year2\": 0.15,\n        \"tax_shock\": 0.05,  # 稅收增加 5%（增稅）\n    },\n]\n```\n\n### Step 2: 理解壓測公式\n\n```\nadditional_interest = debt_stock × pass_through × delta_yield\nstressed_ratio = (interest + additional_interest) / (tax × (1 + tax_shock))\n```\n\n**關鍵參數**：\n\n| 參數 | 說明 | 預設值 |\n|------|------|--------|\n| delta_yield_bp | 殖利率上升幅度（bp） | - |\n| pass_through_year1 | Year 1 再定價比例 | 0.15 |\n| pass_through_year2 | Year 2 再定價比例 | 0.15 |\n| tax_shock | 稅收衝擊（負=下降） | 0.0 |\n\n### Step 3: 解讀結果\n\n| Year 2 Ratio | 風險分級 | 含義 |\n|--------------|----------|------|\n| < 0.40 | 🟡 YELLOW | 可控壓力 |\n| 0.40–0.55 | 🟠 ORANGE | 需政策調整 |\n| > 0.55 | 🔴 RED | 財政彈性極度受限 |\n\n## 情境設計建議\n\n### 保守情境\n- delta_yield_bp: 100–150\n- tax_shock: 0\n- 用途：基準風險評估\n\n### 中性情境\n- delta_yield_bp: 200\n- tax_shock: 0 或 -0.03\n- 用途：合理壓力測試\n\n### 嚴重情境\n- delta_yield_bp: 300+\n- tax_shock: -0.10\n- 用途：尾部風險評估\n\n### 反向情境（稅收增加）\n- delta_yield_bp: 200\n- tax_shock: +0.05（增稅）\n- 用途：政策調整效果評估\n",
        "skills/analyze-jgb-insurer-superlong-flow/SKILL.md": "---\nname: analyze-jgb-insurer-superlong-flow\ndescription: 從日本保險公司對超長期（10年以上）JGB 的淨買賣時間序列，自動產出「本月是否創紀錄淨賣出、連續淨賣出月數、期間累積淨賣出」等結論。\n---\n\n# 分析日本保險公司超長期 JGB 淨買賣流量 Skill\n\n以 JSDA 公開數據驗證「保險公司創紀錄賣超長端國債」等敘事，提供可複製的摘要（含 streak / record / 累積值）。\n\n<essential_principles>\n\n<principle name=\"jsda_data_source\">\n**核心數據來源：JSDA 公社債店頭売買高（Trading Volume of OTC Bonds）**\n\n日本證券業協會（JSDA）自 2018/05 起將投資人別交易統計整併進「Trading Volume of OTC Bonds」資料集。\n\n**數據位置**：\n- 當前財年：https://www.jsda.or.jp/shiryoshitsu/toukei/tentoubaibai/koushasai.xlsx\n- 歷史財年：https://www.jsda.or.jp/shiryoshitsu/toukei/tentoubaibai/koushasai{YYYY}.xlsx\n\n**關鍵 Sheet**：\n- `(Ｊ)合計差引` - 淨買賣額（Sell - Purchase）\n\n**數據特徵**：\n- 頻率：月度\n- 分類：投資人類型 × 債券類型 × 天期桶\n- 單位：億日圓（100 million yen）\n- 延遲：約 T+1 個月\n\n**注意**：2018/05 前的舊版「Trends in Bond Transactions (by investor type)」已停止更新。\n</principle>\n\n<principle name=\"sign_convention\">\n**符號慣例（重要！）**\n\nJSDA 使用「賣出 - 買入」作為差引計算方式：\n\n```\nnet_sale = 賣出金額 - 買入金額\n```\n\n- **正值 = 淨賣出**（賣出 > 買入，需求減少）\n- **負值 = 淨買入**（買入 > 賣出，需求增加）\n\n這與部分新聞報導的符號相反，需特別注意。\n</principle>\n\n<principle name=\"maturity_bucket_mapping\">\n**天期桶口徑對齊**\n\nJSDA Excel 欄位結構（第 4 列）：\n\n| JSDA 欄位 | 英文 | 說明 |\n|-----------|------|------|\n| 超長期 | Interest-bearing Long-term (over 10-year) | 10 年以上利付債 |\n| 利付長期 | Interest-bearing Long-term | 5-10 年利付債 |\n| 利付中期 | Interest-bearing Medium-term | 2-5 年利付債 |\n| 割引 | Zero-Coupon | 零息債 |\n| 国庫短期証券等 | Treasury Discount Bills | 短期國庫券 |\n\n**本 Skill 使用**：`超長期`（對應新聞常見的「10+ years」或「super-long」口徑）\n</principle>\n\n<principle name=\"investor_mapping\">\n**投資人分類**\n\n| JSDA 分類 | 英文 | 說明 |\n|-----------|------|------|\n| 生保・損保 | Life & Non-Life Insurance Companies | 壽險 + 產險合計 |\n| 都市銀行 | City Banks | 大型商業銀行 |\n| 地方銀行 | Regional Banks | 區域性銀行 |\n| 信託銀行 | Trust Banks | 含年金管理 |\n| 外国人 | Foreigners | 海外投資者 |\n\n**本 Skill 使用**：`生保・損保`（保險公司合計）\n</principle>\n\n<principle name=\"record_detection\">\n**歷史極值判斷邏輯**\n\n```python\nrecord_high = max(series)  # 最大淨賣出（正值最大）\nis_record_sale = (latest == record_high) AND (latest > 0)\n```\n\n**注意事項**：\n- 數據起點會影響「歷史紀錄」的判定，輸出必須說明樣本期間\n- 若僅為近期極值，需標註「近 N 個月新高」\n</principle>\n\n</essential_principles>\n\n<objective>\n驗證「日本保險公司創紀錄賣超長端 JGB」等敘事，並提供：\n1. **本月淨賣出/買入**：最新月份數值（億日圓）\n2. **是否創紀錄**：判斷是否為樣本最大淨賣出（正值最大）\n3. **連續淨賣出月數**：streak_len\n4. **本輪累積淨賣出**：cum_over_streak\n5. **Z-score 與分位數**：相對歷史的極端程度\n</objective>\n\n<quick_start>\n\n**最快的方式：執行快速分析**\n\n```bash\ncd .claude/skills/analyze-jgb-insurer-superlong-flow\npip install pandas numpy openpyxl  # 首次使用\npython scripts/jsda_flow_analyzer.py --quick\n```\n\n**輸出範例**（2025/12 實測結果）：\n\n```markdown\n## 日本保險公司超長期 JGB 淨買賣驗證報告\n\n**分析期間**：2022-04 ~ 2025-12（45 個月）\n\n### 核心結論\n\n| 指標 | 數值 | 說明 |\n|------|------|------|\n| 本月（2025-12）| **8,224 億日圓** | 淨賣出 |\n| 是否創歷史紀錄 | **✓ 是** | 全樣本 (45 個月) |\n| 連續淨賣出月數 | **5 個月** | 自 2025-08 起 |\n| 本輪累積淨賣出 | **13,959 億日圓** | 1.40 兆日圓 |\n\n### Headline Takeaways\n\n1. ✓ 驗證屬實：日本保險公司在 2025/12 創下歷史最大單月淨賣出\n2. 已連續 5 個月淨賣出超長期國債，累積 1.40 兆日圓\n3. 當前淨賣出規模處於歷史極端區間（Z-score: 2.71）\n```\n\n**完整分析（含歷史比較）**：\n```bash\npython scripts/jsda_flow_analyzer.py --full --format json\n```\n\n**強制重新下載數據**：\n```bash\npython scripts/jsda_flow_analyzer.py --quick --refresh\n```\n\n</quick_start>\n\n<intake>\n您想要執行什麼操作？\n\n1. **快速檢查** - 查看最新月份的淨買賣與連續淨賣出狀態\n2. **完整分析** - 執行完整的歷史比較與極值判斷\n3. **驗證新聞** - 輸入新聞的數字，對比 JSDA 原始數據\n4. **JSON 輸出** - 輸出結構化 JSON 供後續處理\n\n**請選擇或直接執行分析。**\n</intake>\n\n<routing>\n| Response                        | Action                              |\n|---------------------------------|-------------------------------------|\n| 1, \"快速\", \"quick\", \"check\"     | `python scripts/jsda_flow_analyzer.py --quick` |\n| 2, \"完整\", \"full\", \"analyze\"    | `python scripts/jsda_flow_analyzer.py --full`  |\n| 3, \"驗證\", \"verify\", \"新聞\"     | 讀取 workflows/verify-claim.md      |\n| 4, \"json\", \"JSON\"               | `python scripts/jsda_flow_analyzer.py --format json` |\n</routing>\n\n<input_schema>\n\n<parameter name=\"--quick\" required=\"false\">\n**Type**: flag\n**Description**: 快速檢查模式（使用快取數據）\n</parameter>\n\n<parameter name=\"--full\" required=\"false\">\n**Type**: flag\n**Description**: 完整分析模式\n</parameter>\n\n<parameter name=\"--start-year\" required=\"false\" default=\"2018\">\n**Type**: int\n**Description**: 起始財年（日本財年 4 月開始）\n</parameter>\n\n<parameter name=\"--lookback\" required=\"false\">\n**Type**: int\n**Description**: 回溯月數（預設全樣本）\n</parameter>\n\n<parameter name=\"--format\" required=\"false\" default=\"markdown\">\n**Type**: string\n**Options**: `json` | `markdown`\n**Description**: 輸出格式\n</parameter>\n\n<parameter name=\"--refresh\" required=\"false\">\n**Type**: flag\n**Description**: 強制重新下載數據\n</parameter>\n\n<parameter name=\"--output\" required=\"false\">\n**Type**: string\n**Description**: 輸出檔案路徑\n</parameter>\n\n</input_schema>\n\n<output_schema>\n\n**JSON 輸出結構**：\n```json\n{\n  \"skill\": \"analyze_jgb_insurer_superlong_flow\",\n  \"version\": \"1.0.0\",\n  \"as_of\": \"2026-01-26\",\n  \"data_source\": {\n    \"name\": \"JSDA Trading Volume of OTC Bonds (公社債店頭売買高)\",\n    \"url\": \"https://www.jsda.or.jp/shiryoshitsu/toukei/tentoubaibai/\",\n    \"sheet\": \"(Ｊ)合計差引\"\n  },\n  \"parameters\": {\n    \"investor_group\": \"life_and_nonlife_insurance\",\n    \"investor_label\": \"生保・損保 (Life & Non-Life Insurance Companies)\",\n    \"maturity_bucket\": \"super_long\",\n    \"maturity_label\": \"超長期 (Interest-bearing Long-term over 10-year)\",\n    \"sign_convention\": \"正值=淨賣出 (Sell-Purchase), 負值=淨買入\",\n    \"unit\": \"100 million yen (億円)\"\n  },\n  \"analysis_period\": {\n    \"start\": \"2022-04\",\n    \"end\": \"2025-12\",\n    \"months\": 45\n  },\n  \"latest_month\": {\n    \"date\": \"2025-12\",\n    \"net_sale_100m_yen\": 8224,\n    \"net_sale_trillion_yen\": 0.8224,\n    \"interpretation\": \"淨賣出\"\n  },\n  \"record_analysis\": {\n    \"is_record_sale\": true,\n    \"record_sale_100m_yen\": 8224,\n    \"record_sale_date\": \"2025-12\",\n    \"record_purchase_100m_yen\": -8889,\n    \"record_purchase_date\": \"2023-03\",\n    \"lookback_period\": \"全樣本 (45 個月)\"\n  },\n  \"streak_analysis\": {\n    \"consecutive_net_sale_months\": 5,\n    \"streak_start\": \"2025-08\",\n    \"cumulative_net_sale_100m_yen\": 13959,\n    \"cumulative_net_sale_trillion_yen\": 1.3959\n  },\n  \"historical_stats\": {\n    \"mean_100m_yen\": -2025,\n    \"std_100m_yen\": 3785,\n    \"latest_zscore\": 2.71,\n    \"latest_percentile\": 0.9778\n  },\n  \"headline_takeaways\": [\n    \"✓ 驗證屬實：日本保險公司在 2025/12 創下歷史最大單月淨賣出（8,224 億日圓）\",\n    \"已連續 5 個月淨賣出超長期國債，累積金額 13,959 億日圓（1.40 兆日圓）\",\n    \"當前淨賣出規模處於歷史極端區間（Z-score: 2.71，超過 2 個標準差）\"\n  ]\n}\n```\n</output_schema>\n\n<reference_index>\n**參考文件** (`references/`)\n\n| 文件              | 內容                                     |\n|-------------------|------------------------------------------|\n| data-sources.md   | JSDA 數據來源與 XLS 下載說明             |\n| methodology.md    | 計算方法論（streak、record、cumulative） |\n</reference_index>\n\n<scripts_index>\n| Script                 | Command       | Purpose            |\n|------------------------|---------------|--------------------|\n| jsda_flow_analyzer.py  | `--quick`     | 快速檢查           |\n| jsda_flow_analyzer.py  | `--full`      | 完整分析           |\n| jsda_flow_analyzer.py  | `--refresh`   | 強制重新下載數據   |\n</scripts_index>\n\n<success_criteria>\nSkill 成功執行時：\n\n- [x] 輸出最新月份淨賣出/買入數值\n- [x] 判斷是否為歷史極值（含回溯期間說明）\n- [x] 計算連續淨賣出月數與累積金額\n- [x] 明確標示天期桶與投資人口徑\n- [x] 提供 Z-score 與分位數\n- [x] 可操作的 headline takeaways\n</success_criteria>\n\n<directory_structure>\n```\nanalyze-jgb-insurer-superlong-flow/\n├── SKILL.md                           # 本文件（主入口）\n├── skill.yaml                         # 前端展示元數據\n├── workflows/\n│   ├── quick-check.md                 # 快速檢查工作流\n│   ├── full-analysis.md               # 完整分析工作流\n│   └── verify-claim.md                # 驗證新聞工作流\n├── references/\n│   ├── data-sources.md                # 資料來源說明\n│   └── methodology.md                 # 方法論與公式\n├── scripts/\n│   └── jsda_flow_analyzer.py          # 主分析腳本（含數據下載）\n└── data/\n    └── cache/                         # 自動緩存目錄（.gitignore）\n```\n</directory_structure>\n",
        "skills/analyze-jgb-insurer-superlong-flow/references/data-sources.md": "# 資料來源說明\n\n## 1. 主要數據來源：JSDA 公社債店頭売買高\n\n### 1.1 來源資訊\n\n| 項目 | 內容 |\n|------|------|\n| 機構 | 日本證券業協會（Japan Securities Dealers Association, JSDA） |\n| 數據類型 | Trading Volume of OTC Bonds（公社債店頭売買高） |\n| 網址 | https://www.jsda.or.jp/shiryoshitsu/toukei/tentoubaibai/ |\n| 格式 | Excel (XLSX) |\n| 頻率 | 月度 |\n| 延遲 | 約 T+1 個月（月底發布上月數據） |\n| 費用 | 免費 |\n\n### 1.2 下載路徑\n\n**當前財年（持續更新）**：\n```\nhttps://www.jsda.or.jp/shiryoshitsu/toukei/tentoubaibai/koushasai.xlsx\n```\n\n**歷史財年（日本財年 4 月開始）**：\n```\nhttps://www.jsda.or.jp/shiryoshitsu/toukei/tentoubaibai/koushasai{YYYY}.xlsx\n```\n\n例如：\n- `koushasai2024.xlsx` → FY2024（2024/04 ~ 2025/03）\n- `koushasai2023.xlsx` → FY2023（2023/04 ~ 2024/03）\n- `koushasai2022.xlsx` → FY2022（2022/04 ~ 2023/03）\n\n### 1.3 Excel 結構\n\n**關鍵 Sheet**：\n\n| Sheet 名稱 | 內容 |\n|------------|------|\n| `(Ａ)合計売買高` | 總交易量 |\n| `(Ｄ)合計売付額` | 總賣出額 |\n| `(Ｇ)合計買付額` | 總買入額 |\n| `(Ｊ)合計差引` | **淨買賣額（Sell - Purchase）** ← 本 Skill 使用 |\n\n**欄位結構（Sheet: 合計差引）**：\n\n| 欄位位置 | 內容 |\n|----------|------|\n| 第 0 列 | 年/月（如 2025/12） |\n| 第 1 列 | 投資人類型 |\n| 第 2 列 | 投資人類型（英文） |\n| 第 3 列 | 國債總計 |\n| **第 4 列** | **超長期（Interest-bearing Long-term over 10-year）** |\n| 第 5 列 | 利付長期（Interest-bearing Long-term） |\n| 第 6 列 | 利付中期（Interest-bearing Medium-term） |\n| 第 7 列 | 割引（Zero-Coupon） |\n| 第 8 列 | 国庫短期証券等（Treasury Discount Bills） |\n\n### 1.4 投資人分類\n\n| JSDA 分類 | 英文 | 說明 |\n|-----------|------|------|\n| 都市銀行 | City Banks & Long-Term Credit Banks | 大型商業銀行 |\n| 地方銀行 | Regional Banks | 區域性銀行 |\n| 信託銀行 | Trust Banks | 含年金管理 |\n| 農林系金融機関 | Fin.Insts. for Agr. & Forestry | 農林金融 |\n| 第二地銀協加盟行 | 2nd Regional | 第二地方銀行 |\n| 信用金庫 | Shinkin Banks | 信用金庫 |\n| その他金融機関 | Other Fin.Insts. | 其他金融機構 |\n| **生保・損保** | **Life & Non-Life Insurance Companies** | **壽險 + 產險** |\n| 投資信託 | Investment Trusts | 共同基金 |\n| 官公庁共済組合 | Mutual Aid Association of Govt.Offices | 政府互助會 |\n| 事業法人 | Business Corporations | 一般企業 |\n| その他法人 | Other Corporations | 其他法人 |\n| 外国人 | Foreigners | 海外投資者 |\n| 個人 | Individuals | 個人投資者 |\n| その他 | Others | 其他 |\n| 債券ディーラー | Bond Dealers | 債券交易商 |\n| 合計 | Total | 總計 |\n\n### 1.5 符號慣例\n\n**重要**：JSDA 的「差引」使用「賣出 - 買入」計算：\n\n```\n差引 = 売付額 - 買付額\n```\n\n- **正值 = 淨賣出**（賣出 > 買入）\n- **負值 = 淨買入**（買入 > 賣出）\n\n---\n\n## 2. 歷史沿革\n\n### 2.1 2018/05 改版\n\nJSDA 在 2018 年 5 月進行統計格式改版：\n\n- **舊版**：「Trends in Bond Transactions (by investor type)」單獨發布\n- **新版**：整併進「Trading Volume of OTC Bonds」資料集\n\n**影響**：\n- 英文版 Bonds 頁面的舊表只到 2018/05\n- 2018/05 後的數據需從新的 `koushasai.xlsx` 系列取得\n- 數據口徑和欄位結構有所調整\n\n### 2.2 數據可追溯性\n\n目前 JSDA 網站提供的歷史檔案：\n- `koushasai.xlsx` - 當前財年\n- `koushasai2024.xlsx` - FY2024\n- `koushasai2023.xlsx` - FY2023\n- `koushasai2022.xlsx` - FY2022\n- 更早年份可能需要向 JSDA 申請\n\n---\n\n## 3. 數據品質說明\n\n### 3.1 已知限制\n\n1. **延遲**：JSDA 數據約滯後 1 個月\n2. **修正**：歷史數據可能有修正，需定期更新\n3. **範圍**：僅包含店頭（OTC）交易，不含交易所交易\n4. **合併口徑**：「生保・損保」為壽險 + 產險合計，無法分拆\n\n### 3.2 快取策略\n\n腳本會自動快取下載的 Excel 檔案：\n\n```\ndata/cache/\n├── koushasai.xlsx        # 當前財年\n├── koushasai2024.xlsx    # FY2024\n├── koushasai2023.xlsx    # FY2023\n└── koushasai2022.xlsx    # FY2022\n```\n\n**快取邏輯**：\n- 檔案存在且大於 50KB → 使用快取\n- 使用 `--refresh` 參數 → 強制重新下載\n\n---\n\n## 4. 替代與補充數據來源\n\n### 4.1 日本銀行（BOJ）Flow of Funds\n\n| 項目 | 說明 |\n|------|------|\n| 數據類型 | 資金循環統計（Flow of Funds） |\n| 網址 | https://www.boj.or.jp/statistics/sj/ |\n| 優點 | 季度，含持倉存量 |\n| 缺點 | 天期分類較粗，延遲較長 |\n\n### 4.2 財務省（MOF）國債持有者統計\n\n| 項目 | 說明 |\n|------|------|\n| 數據類型 | JGB Investor Presentation |\n| 網址 | https://www.mof.go.jp/english/policy/jgbs/IR/ |\n| 優點 | 官方投資人報告 |\n| 缺點 | 季度，口徑可能與 JSDA 不同 |\n\n### 4.3 Bloomberg / Reuters（付費）\n\n| 項目 | 說明 |\n|------|------|\n| 數據類型 | 加工後的投資人流量數據 |\n| 優點 | 即時，易於使用 |\n| 缺點 | 付費，口徑可能經過調整 |\n\n---\n\n## 5. 數據驗證實例\n\n### 5.1 2025/12 數據驗證\n\n從 `koushasai.xlsx` 提取的「生保・損保」超長期國債數據：\n\n| 年月 | 淨賣出（億日圓） | 解讀 |\n|------|------------------|------|\n| 2025/12 | +8,224 | 淨賣出 8,224 億 |\n| 2025/11 | +451 | 淨賣出 451 億 |\n| 2025/10 | +2,767 | 淨賣出 2,767 億 |\n| 2025/09 | +2,258 | 淨賣出 2,258 億 |\n| 2025/08 | +259 | 淨賣出 259 億 |\n\n**結論**：2025/12 的 8,224 億日圓為樣本期間（2022/04~2025/12）最大單月淨賣出。\n",
        "skills/analyze-jgb-insurer-superlong-flow/references/input-schema.md": "# 輸入參數詳細定義\n\n## 必要參數\n\n### start_date\n\n| 項目 | 內容         |\n|------|--------------|\n| 類型 | string       |\n| 格式 | YYYY-MM      |\n| 必要 | 是           |\n| 說明 | 分析起始年月 |\n| 範例 | `\"2020-01\"`  |\n\n**驗證規則**：\n- 必須是有效的年月格式\n- 不能晚於 `end_date`\n- 不能早於 JSDA 數據起點（約 2010 年）\n\n### end_date\n\n| 項目 | 內容         |\n|------|--------------|\n| 類型 | string       |\n| 格式 | YYYY-MM      |\n| 必要 | 是           |\n| 說明 | 分析結束年月 |\n| 範例 | `\"2025-12\"`  |\n\n**驗證規則**：\n- 必須是有效的年月格式\n- 不能早於 `start_date`\n- 不能晚於最新可用數據月份\n\n### investor_group\n\n| 項目 | 內容                    |\n|------|-------------------------|\n| 類型 | string                  |\n| 必要 | 是                      |\n| 預設 | `\"insurance_companies\"` |\n| 說明 | 投資人分類（JSDA 定義） |\n\n**可用選項**：\n\n| 值                    | 說明         | JSDA 對應          |\n|-----------------------|--------------|--------------------|\n| `insurance_companies` | 全體保險公司 | 壽險 + 產險        |\n| `life_insurance`      | 壽險公司     | Life Insurance     |\n| `non_life_insurance`  | 產險公司     | Non-life Insurance |\n\n### maturity_bucket\n\n| 項目 | 內容           |\n|------|----------------|\n| 類型 | string         |\n| 必要 | 是             |\n| 預設 | `\"super_long\"` |\n| 說明 | 天期區間       |\n\n**可用選項**：\n\n| 值                     | 說明              | 典型範圍               |\n|------------------------|-------------------|------------------------|\n| `super_long`           | 超長端            | 20Y+ 或 30Y+           |\n| `long`                 | 長端              | 5-10Y 或 10Y           |\n| `10y_plus`             | 10 年以上         | 需確認 JSDA 是否有此桶 |\n| `long_plus_super_long` | 長端 + 超長端合併 | 需手動計算             |\n\n### measure\n\n| 項目 | 內容              |\n|------|-------------------|\n| 類型 | string            |\n| 必要 | 是                |\n| 預設 | `\"net_purchases\"` |\n| 說明 | 指標類型          |\n\n**可用選項**：\n\n| 值                | 說明           | 公式        |\n|-------------------|----------------|-------------|\n| `net_purchases`   | 淨買入（核心） | 買入 - 賣出 |\n| `gross_purchases` | 買入金額       | -           |\n| `gross_sales`     | 賣出金額       | -           |\n\n### frequency\n\n| 項目 | 內容        |\n|------|-------------|\n| 類型 | string      |\n| 必要 | 是          |\n| 預設 | `\"monthly\"` |\n| 說明 | 頻率        |\n\n**目前僅支援**：`monthly`（JSDA 僅提供月度數據）\n\n---\n\n## 選用參數\n\n### currency\n\n| 項目 | 內容     |\n|------|----------|\n| 類型 | string   |\n| 必要 | 否       |\n| 預設 | `\"JPY\"`  |\n| 說明 | 輸出幣別 |\n\n**可用選項**：\n\n| 值    | 說明               |\n|-------|--------------------|\n| `JPY` | 日圓（原始單位）   |\n| `USD` | 美元（需匯率換算） |\n\n### usd_fx_source\n\n| 項目 | 內容                             |\n|------|----------------------------------|\n| 類型 | string                           |\n| 必要 | 否（僅當 `currency=USD` 時需要） |\n| 說明 | USD 換算的匯率來源               |\n\n**可用選項**：\n\n| 值      | 來源            | 說明         |\n|---------|-----------------|--------------|\n| `fred`  | FRED DEXJPUS    | 美聯儲數據   |\n| `boe`   | Bank of England | 英格蘭銀行   |\n| `stooq` | Stooq           | 免費金融數據 |\n\n### record_lookback_years\n\n| 項目 | 內容                            |\n|------|---------------------------------|\n| 類型 | int                             |\n| 必要 | 否                              |\n| 預設 | `999`                           |\n| 說明 | 計算「歷史新高/新低」的回溯年數 |\n\n**說明**：\n- `999` = 全樣本（從數據起點至 `end_date`）\n- `5` = 近 5 年\n- `10` = 近 10 年\n\n### streak_sign\n\n| 項目 | 內容           |\n|------|----------------|\n| 類型 | string         |\n| 必要 | 否             |\n| 預設 | `\"negative\"`   |\n| 說明 | 連續判斷的符號 |\n\n**可用選項**：\n\n| 值         | 說明                    |\n|------------|-------------------------|\n| `negative` | 連續淨賣出（value < 0） |\n| `positive` | 連續淨買入（value > 0） |\n\n### output_format\n\n| 項目 | 內容         |\n|------|--------------|\n| 類型 | string       |\n| 必要 | 否           |\n| 預設 | `\"markdown\"` |\n| 說明 | 輸出格式     |\n\n**可用選項**：\n\n| 值         | 說明                      |\n|------------|---------------------------|\n| `json`     | JSON 格式（適合程式處理） |\n| `markdown` | Markdown 格式（適合報告） |\n\n---\n\n## 輸入範例\n\n### 快速檢查\n\n```json\n{\n  \"end_date\": \"2025-12\",\n  \"investor_group\": \"insurance_companies\",\n  \"maturity_bucket\": \"super_long\",\n  \"measure\": \"net_purchases\",\n  \"output_format\": \"markdown\"\n}\n```\n\n### 完整分析\n\n```json\n{\n  \"start_date\": \"2020-01\",\n  \"end_date\": \"2025-12\",\n  \"investor_group\": \"life_insurance\",\n  \"maturity_bucket\": \"long_plus_super_long\",\n  \"measure\": \"net_purchases\",\n  \"frequency\": \"monthly\",\n  \"currency\": \"USD\",\n  \"usd_fx_source\": \"fred\",\n  \"record_lookback_years\": 10,\n  \"streak_sign\": \"negative\",\n  \"output_format\": \"json\"\n}\n```\n\n### 驗證新聞\n\n```json\n{\n  \"end_date\": \"2025-12\",\n  \"investor_group\": \"insurance_companies\",\n  \"maturity_bucket\": \"super_long\",\n  \"verify_claim\": {\n    \"value_billion_jpy\": -800,\n    \"source\": \"新聞/Bloomberg\"\n  }\n}\n```\n",
        "skills/analyze-jgb-insurer-superlong-flow/references/jsda-structure.md": "# JSDA XLS 結構說明\n\n## 1. 數據來源概覽\n\n### 1.1 JSDA 統計頁面\n\n日本證券業協會（JSDA）在官網發布多種債券交易統計：\n\n```\nJSDA 統計\n├── Bonds（債券）\n│   ├── Trading Volume（交易量）\n│   ├── Trends in Bond Transactions (by investor type)  ← 本 Skill 使用\n│   ├── Government Bonds\n│   └── Corporate Bonds\n└── Stocks（股票）\n```\n\n### 1.2 目標數據集\n\n**Trends in Bond Transactions (by investor type)**\n\n| 項目 | 內容 |\n|------|------|\n| 更新頻率 | 月度 |\n| 發布時間 | 約次月月底 |\n| 格式 | Excel (XLS/XLSX) |\n| 歷史範圍 | 約 2010 年至今 |\n\n---\n\n## 2. XLS 結構\n\n### 2.1 Sheet 結構\n\n典型的 JSDA XLS 包含多個 sheet：\n\n```\nXLS 工作簿\n├── JGBs（國債）          ← 主要使用\n├── Corporate Bonds（公司債）\n├── Municipal Bonds（地方債）\n└── Notes / Definitions\n```\n\n### 2.2 JGBs Sheet 結構\n\n**列結構**（通常）：\n\n| 列 | 內容 |\n|----|------|\n| A | 年月 (YYYY/MM 或 YYYY-MM) |\n| B | 投資人類型 |\n| C | 天期桶 |\n| D | 買入金額 (Gross Purchases) |\n| E | 賣出金額 (Gross Sales) |\n| F | 淨買入 (Net Purchases) |\n\n**注意**：實際列順序可能因版本而異，需動態解析。\n\n### 2.3 投資人類型列舉\n\n| JSDA 英文 | JSDA 日文 | 本 Skill 映射 |\n|-----------|-----------|---------------|\n| City Banks | 都市銀行 | - |\n| Regional Banks | 地方銀行 | - |\n| Trust Banks | 信託銀行 | - |\n| Life Insurance | 生命保険 | `life_insurance` |\n| Non-life Insurance | 損害保険 | `non_life_insurance` |\n| Investment Trusts | 投資信託 | - |\n| Foreigners | 外国人 | - |\n| Others | その他 | - |\n\n### 2.4 天期桶列舉\n\n| JSDA 英文 | JSDA 日文 | 典型範圍 | 本 Skill 映射 |\n|-----------|-----------|----------|---------------|\n| Short-term | 短期 | < 1Y | - |\n| Medium-term | 中期 | 1-5Y | - |\n| Long-term | 長期 | 5-10Y | `long` |\n| Super-long | 超長期 | > 10Y | `super_long` |\n\n**注意**：\n- 天期桶定義可能隨時間調整\n- 部分年份可能有更細的分類（如 10Y、20Y、30Y 分開）\n\n---\n\n## 3. 解析邏輯\n\n### 3.1 讀取 XLS\n\n```python\nimport pandas as pd\nimport requests\nfrom io import BytesIO\n\ndef load_jsda_xls(xls_url: str) -> dict:\n    \"\"\"\n    下載並解析 JSDA XLS\n\n    Returns:\n        dict: {sheet_name: DataFrame}\n    \"\"\"\n    response = requests.get(xls_url, timeout=30)\n    response.raise_for_status()\n\n    # 讀取所有 sheet\n    xls = pd.ExcelFile(BytesIO(response.content))\n    sheets = {}\n\n    for sheet_name in xls.sheet_names:\n        sheets[sheet_name] = pd.read_excel(xls, sheet_name=sheet_name)\n\n    return sheets\n```\n\n### 3.2 提取目標數據\n\n```python\ndef extract_investor_series(\n    sheets: dict,\n    investor_group: str,\n    maturity_bucket: str,\n    target_sheet: str = \"JGBs\"\n) -> pd.Series:\n    \"\"\"\n    從 XLS 提取特定投資人 + 天期桶的淨買入序列\n\n    Returns:\n        pd.Series: index=日期, values=淨買入\n    \"\"\"\n    df = sheets.get(target_sheet)\n    if df is None:\n        raise ValueError(f\"Sheet '{target_sheet}' not found\")\n\n    # 1. 識別列名（動態處理不同格式）\n    date_col = find_date_column(df)\n    investor_col = find_investor_column(df)\n    maturity_col = find_maturity_column(df)\n    net_col = find_net_purchases_column(df)\n\n    # 2. 過濾\n    mask = (\n        df[investor_col].str.contains(INVESTOR_PATTERNS[investor_group], case=False) &\n        df[maturity_col].str.contains(MATURITY_PATTERNS[maturity_bucket], case=False)\n    )\n\n    filtered = df[mask].copy()\n\n    # 3. 轉換為序列\n    filtered[date_col] = pd.to_datetime(filtered[date_col])\n    series = filtered.set_index(date_col)[net_col]\n    series = pd.to_numeric(series, errors=\"coerce\")\n\n    return series.dropna().sort_index()\n```\n\n### 3.3 合併天期桶\n\n```python\ndef merge_maturity_buckets(\n    sheets: dict,\n    investor_group: str,\n    buckets: list = [\"long\", \"super_long\"]\n) -> pd.Series:\n    \"\"\"\n    合併多個天期桶（如 long + super_long = 10y_plus）\n    \"\"\"\n    series_list = []\n\n    for bucket in buckets:\n        s = extract_investor_series(sheets, investor_group, bucket)\n        series_list.append(s)\n\n    # 對齊日期並加總\n    combined = pd.concat(series_list, axis=1).sum(axis=1)\n    return combined\n```\n\n---\n\n## 4. 常見問題\n\n### 4.1 XLS 格式變更\n\n**問題**：JSDA 更新網站後，XLS 格式可能改變。\n\n**解決**：\n1. 使用動態列名識別（正則匹配）\n2. 保留原始 XLS 副本用於對照\n3. 在輸出中標註數據版本\n\n### 4.2 歷史數據不連續\n\n**問題**：部分歷史月份可能缺失。\n\n**解決**：\n1. 在解析時檢測缺失月份\n2. 輸出時標註數據完整性\n3. 計算 streak 時跳過缺失月份（或中斷計算）\n\n### 4.3 天期桶定義不一致\n\n**問題**：不同年份的天期桶定義可能不同。\n\n**解決**：\n1. 在 references/jsda-structure.md 記錄歷史變更\n2. 提供多口徑輸出讓用戶選擇\n3. 明確標註使用的定義\n\n---\n\n## 5. 數據驗證\n\n### 5.1 基本檢查\n\n```python\ndef validate_series(series: pd.Series, expected_start: str, expected_end: str) -> dict:\n    \"\"\"驗證序列完整性\"\"\"\n    return {\n        \"actual_start\": str(series.index.min()),\n        \"actual_end\": str(series.index.max()),\n        \"expected_months\": count_months(expected_start, expected_end),\n        \"actual_months\": len(series),\n        \"missing_pct\": 1 - len(series) / count_months(expected_start, expected_end),\n        \"has_null\": series.isnull().any()\n    }\n```\n\n### 5.2 數量級檢查\n\n```python\ndef sanity_check(series: pd.Series) -> dict:\n    \"\"\"數量級合理性檢查\"\"\"\n    return {\n        \"min\": series.min(),\n        \"max\": series.max(),\n        \"mean\": series.mean(),\n        \"unit_likely\": \"billion_jpy\" if abs(series.mean()) < 10000 else \"million_jpy\"\n    }\n```\n",
        "skills/analyze-jgb-insurer-superlong-flow/references/methodology.md": "# 方法論與計算邏輯\n\n## 1. 核心指標定義\n\n### 1.1 淨賣出 (Net Sale)\n\n**重要**：JSDA 使用「賣出 - 買入」計算差引：\n\n```\nnet_sale = 売付額 - 買付額 = gross_sales - gross_purchases\n```\n\n| 值  | 意義                      |\n|-----|---------------------------|\n| > 0 | 淨賣出（賣出 > 買入，需求減少）|\n| < 0 | 淨買入（買入 > 賣出，需求增加）|\n| = 0 | 買賣相抵                  |\n\n**單位**：億日圓（100 million yen）\n\n**注意**：此符號慣例與部分新聞報導相反，需特別留意。\n\n### 1.2 連續淨賣出月數 (Streak)\n\n從最新月份往回數，連續滿足「淨賣出 > 0」條件的月數。\n\n**計算邏輯**：\n```python\ndef calc_streak(series: pd.Series) -> int:\n    \"\"\"\n    計算連續淨賣出月數\n\n    Args:\n        series: 淨賣出時間序列，index 為日期，正值 = 淨賣出\n\n    Returns:\n        連續月數\n    \"\"\"\n    streak = 0\n    for v in reversed(series.values):\n        if v > 0:  # 正值 = 淨賣出\n            streak += 1\n        else:\n            break\n    return streak\n```\n\n**範例**：\n```\n月份:    2025-08  2025-09  2025-10  2025-11  2025-12\n淨賣出:     259    2,258    2,767      451    8,224\nstreak:                                         → 5 個月\n```\n\n### 1.3 本輪累積 (Cumulative over Streak)\n\n連續淨賣出期間的淨賣出總和。\n\n```python\ndef calc_cumulative(series: pd.Series, streak_len: int) -> float:\n    \"\"\"\n    計算本輪累積淨賣出\n\n    Args:\n        series: 淨賣出時間序列\n        streak_len: 連續月數\n\n    Returns:\n        累積金額（億日圓）\n    \"\"\"\n    return series.tail(streak_len).sum()\n```\n\n### 1.4 歷史極值判斷 (Record Detection)\n\n判斷最新月份是否為歷史最大淨賣出（正值最大）。\n\n```python\ndef is_record_sale(series: pd.Series) -> dict:\n    \"\"\"\n    判斷是否創下歷史最大淨賣出\n\n    Args:\n        series: 淨賣出時間序列\n\n    Returns:\n        dict: 包含 is_record, record_sale, record_date\n    \"\"\"\n    latest = series.iloc[-1]\n    record_high = series.max()  # 最大淨賣出（正值最大）\n    record_date = series.idxmax()\n\n    return {\n        \"is_record_sale\": (latest == record_high) and (latest > 0),\n        \"record_sale_100m_yen\": float(record_high),\n        \"record_date\": str(record_date),\n        \"lookback_period\": f\"全樣本 ({len(series)} 個月)\"\n    }\n```\n\n**注意**：\n- 數據起點會影響「歷史紀錄」的含義，輸出必須說明樣本期間\n- 若僅為近期極值，需標註「近 N 個月新高」\n\n---\n\n## 2. 統計指標\n\n### 2.1 歷史分布\n\n```python\ndef calc_historical_stats(series: pd.Series) -> dict:\n    \"\"\"計算歷史統計\"\"\"\n    return {\n        \"count\": len(series),\n        \"mean\": series.mean(),\n        \"std\": series.std(),\n        \"min\": series.min(),  # 最大淨買入（負值最小）\n        \"max\": series.max(),  # 最大淨賣出（正值最大）\n        \"median\": series.median(),\n        \"percentile_25\": series.quantile(0.25),\n        \"percentile_75\": series.quantile(0.75)\n    }\n```\n\n### 2.2 Z-score\n\n```python\ndef calc_zscore(value: float, mean: float, std: float) -> float:\n    \"\"\"計算 Z-score\"\"\"\n    if std == 0:\n        return 0\n    return (value - mean) / std\n```\n\n**解讀**：\n- Z-score > 2：極端淨賣出（超過 2 個標準差）\n- Z-score < -2：極端淨買入\n\n### 2.3 歷史分位數\n\n```python\ndef calc_percentile(series: pd.Series, value: float) -> float:\n    \"\"\"計算數值在歷史中的分位數\"\"\"\n    return (series <= value).mean()\n```\n\n**解讀**：\n- 分位數 > 0.95：歷史前 5% 的淨賣出\n- 分位數 < 0.05：歷史前 5% 的淨買入\n\n---\n\n## 3. 數據結構\n\n### 3.1 JSDA Excel 結構\n\n**來源 URL**：\n- 當前財年：`https://www.jsda.or.jp/shiryoshitsu/toukei/tentoubaibai/koushasai.xlsx`\n- 歷史財年：`https://www.jsda.or.jp/shiryoshitsu/toukei/tentoubaibai/koushasai{YYYY}.xlsx`\n\n**關鍵 Sheet**：`(Ｊ)合計差引`\n\n**欄位結構**：\n\n| 欄位位置 | 內容 |\n|----------|------|\n| 第 0 列 | 年/月（如 2025/12）|\n| 第 1 列 | 投資人類型（日文）|\n| 第 2 列 | 投資人類型（英文）|\n| 第 3 列 | 國債總計 |\n| **第 4 列** | **超長期（Interest-bearing Long-term over 10-year）** |\n| 第 5 列 | 利付長期 |\n| 第 6 列 | 利付中期 |\n| 第 7 列 | 割引 |\n| 第 8 列 | 國庫短期證券等 |\n\n### 3.2 投資人分類\n\n| JSDA 分類 | 英文 | 說明 |\n|-----------|------|------|\n| **生保・損保** | **Life & Non-Life Insurance Companies** | 壽險 + 產險（本 Skill 使用）|\n| 都市銀行 | City Banks | 大型商業銀行 |\n| 地方銀行 | Regional Banks | 區域性銀行 |\n| 信託銀行 | Trust Banks | 含年金管理 |\n| 外国人 | Foreigners | 海外投資者 |\n\n### 3.3 天期桶定義\n\n| 天期桶 | 英文 | 說明 |\n|--------|------|------|\n| **超長期** | Interest-bearing Long-term (over 10-year) | 10 年以上利付債（本 Skill 使用）|\n| 利付長期 | Interest-bearing Long-term | 5-10 年利付債 |\n| 利付中期 | Interest-bearing Medium-term | 2-5 年利付債 |\n| 割引 | Zero-Coupon | 零息債 |\n\n---\n\n## 4. 輸出格式\n\n### 4.1 核心輸出結構\n\n```json\n{\n  \"skill\": \"analyze_jgb_insurer_superlong_flow\",\n  \"version\": \"1.0.0\",\n  \"as_of\": \"2026-01-26\",\n  \"data_source\": {\n    \"name\": \"JSDA Trading Volume of OTC Bonds (公社債店頭売買高)\",\n    \"url\": \"https://www.jsda.or.jp/shiryoshitsu/toukei/tentoubaibai/\",\n    \"sheet\": \"(Ｊ)合計差引\"\n  },\n  \"parameters\": {\n    \"investor_group\": \"life_and_nonlife_insurance\",\n    \"investor_label\": \"生保・損保 (Life & Non-Life Insurance Companies)\",\n    \"maturity_bucket\": \"super_long\",\n    \"maturity_label\": \"超長期 (Interest-bearing Long-term over 10-year)\",\n    \"sign_convention\": \"正值=淨賣出 (Sell-Purchase), 負值=淨買入\",\n    \"unit\": \"100 million yen (億円)\"\n  },\n  \"analysis_period\": {\n    \"start\": \"2021-04\",\n    \"end\": \"2025-12\",\n    \"months\": 57\n  },\n  \"latest_month\": {\n    \"date\": \"2025-12\",\n    \"net_sale_100m_yen\": 8224,\n    \"net_sale_trillion_yen\": 0.8224,\n    \"interpretation\": \"淨賣出\"\n  },\n  \"record_analysis\": {\n    \"is_record_sale\": true,\n    \"record_sale_100m_yen\": 8224,\n    \"record_sale_date\": \"2025-12\",\n    \"lookback_period\": \"全樣本 (57 個月)\"\n  },\n  \"streak_analysis\": {\n    \"consecutive_net_sale_months\": 5,\n    \"streak_start\": \"2025-08\",\n    \"cumulative_net_sale_100m_yen\": 13959,\n    \"cumulative_net_sale_trillion_yen\": 1.3959\n  },\n  \"historical_stats\": {\n    \"count\": 57,\n    \"mean_100m_yen\": -2872,\n    \"std_100m_yen\": 3830,\n    \"latest_zscore\": 2.90,\n    \"latest_percentile\": 0.9825\n  },\n  \"headline_takeaways\": [\n    \"✓ 驗證屬實：日本保險公司在 2025/12 創下歷史最大單月淨賣出（8,224 億日圓）\",\n    \"已連續 5 個月淨賣出超長期國債，累積金額 13,959 億日圓（1.40 兆日圓）\",\n    \"當前淨賣出規模處於歷史極端區間（Z-score: 2.90，超過 2 個標準差）\"\n  ]\n}\n```\n\n---\n\n## 5. 注意事項\n\n### 5.1 單位轉換\n\n| 原始單位 | 目標單位 | 轉換 |\n|----------|----------|------|\n| 億日圓 | 兆日圓 | ÷ 10,000 |\n| 億日圓 | 十億日圓 | ÷ 10 |\n\n### 5.2 時間對齊\n\n- JSDA 月度數據以月末為基準\n- 日本財年從 4 月開始，歷史檔案依財年分割\n- 數據延遲約 T+1 個月\n\n### 5.3 邊界處理\n\n- 若 `streak_len = 0`，表示最新月份為淨買入\n- 若 `streak_len = 全樣本長度`，表示整個樣本期間都是淨賣出（極端情況）\n\n### 5.4 數據範圍限制\n\n- 僅包含店頭（OTC）交易，不含交易所交易\n- 「生保・損保」為壽險 + 產險合計，無法分拆\n- 2018/05 前的數據格式不同，需特別處理\n",
        "skills/analyze-jgb-insurer-superlong-flow/templates/output-json.md": "# JSON 輸出結構定義\n\n## 完整輸出結構\n\n```json\n{\n  \"skill\": \"analyze_jgb_insurer_superlong_flow\",\n  \"version\": \"0.1.0\",\n  \"as_of\": \"2026-01-26\",\n  \"status\": \"success\",\n\n  \"data_source\": {\n    \"name\": \"JSDA Trends in Bond Transactions (by investor type)\",\n    \"url\": \"https://www.jsda.or.jp/\",\n    \"fetch_timestamp\": \"2026-01-26T10:30:00+09:00\",\n    \"data_version\": \"2025-12\"\n  },\n\n  \"parameters\": {\n    \"start_date\": \"2020-01\",\n    \"end_date\": \"2025-12\",\n    \"investor_group\": \"insurance_companies\",\n    \"maturity_bucket\": \"super_long\",\n    \"measure\": \"net_purchases\",\n    \"frequency\": \"monthly\",\n    \"currency\": \"JPY\",\n    \"record_lookback_years\": 999,\n    \"streak_sign\": \"negative\"\n  },\n\n  \"latest_month\": {\n    \"date\": \"2025-12\",\n    \"net_purchases_billion_jpy\": -822.4,\n    \"net_purchases_trillion_jpy\": -0.8224,\n    \"net_purchases_usd_billion\": null,\n    \"interpretation\": \"淨賣出 ¥8,224 億\"\n  },\n\n  \"record_analysis\": {\n    \"is_record_sale\": true,\n    \"record_low_billion_jpy\": -822.4,\n    \"record_low_date\": \"2025-12\",\n    \"record_high_billion_jpy\": 500.0,\n    \"record_high_date\": \"2020-03\",\n    \"lookback_period\": \"全樣本 (2010-01 至 2025-12)\",\n    \"interpretation\": \"創下歷史最大單月淨賣出紀錄\"\n  },\n\n  \"streak_analysis\": {\n    \"consecutive_negative_months\": 5,\n    \"streak_start\": \"2025-08\",\n    \"streak_end\": \"2025-12\",\n    \"cumulative_over_streak_billion_jpy\": -1370.0,\n    \"cumulative_over_streak_trillion_jpy\": -1.37,\n    \"interpretation\": \"自 2025-08 起連續 5 個月淨賣出，累積 ¥1.37 兆\"\n  },\n\n  \"historical_stats\": {\n    \"sample_period\": {\n      \"start\": \"2010-01\",\n      \"end\": \"2025-12\"\n    },\n    \"count\": 192,\n    \"mean_billion_jpy\": 50.5,\n    \"std_billion_jpy\": 150.3,\n    \"min_billion_jpy\": -822.4,\n    \"max_billion_jpy\": 500.0,\n    \"median_billion_jpy\": 45.0,\n    \"percentile_25_billion_jpy\": -30.0,\n    \"percentile_75_billion_jpy\": 120.0,\n    \"latest_zscore\": -5.81,\n    \"latest_percentile\": 0.005,\n    \"interpretation\": \"當前值處於歷史 0.5% 分位，極端偏低\"\n  },\n\n  \"caliber_notes\": [\n    {\n      \"type\": \"maturity_bucket\",\n      \"used\": \"super_long\",\n      \"note\": \"JSDA 超長端分類，通常對應 20Y+ 或 30Y+。新聞若使用「10年以上」，數值可能略有差異。\"\n    },\n    {\n      \"type\": \"investor_group\",\n      \"used\": \"insurance_companies\",\n      \"note\": \"包含壽險 + 產險。若僅需壽險，請使用 life_insurance。\"\n    },\n    {\n      \"type\": \"unit\",\n      \"used\": \"billion_jpy\",\n      \"note\": \"十億日圓（¥B）。兆日圓 = 十億日圓 ÷ 1000。\"\n    }\n  ],\n\n  \"headline_takeaways\": [\n    \"日本保險公司在 2025-12 創下歷史最大單月淨賣出（-¥8,224 億）\",\n    \"已連續 5 個月淨賣出，累積金額達 ¥1.37 兆\",\n    \"當前淨賣出規模處於歷史 0.5% 分位，屬極端事件\"\n  ],\n\n  \"confidence\": {\n    \"level\": \"high\",\n    \"reasons\": [\n      \"數據來源為 JSDA 官方統計（公開可下載）\",\n      \"計算邏輯透明可重現\",\n      \"無需依賴付費終端\"\n    ],\n    \"caveats\": [\n      \"天期桶口徑與新聞可能不完全一致\",\n      \"JSDA 數據約滯後 1 個月發布\"\n    ]\n  },\n\n  \"artifacts\": [\n    {\n      \"type\": \"chart\",\n      \"path\": \"output/jgb_insurer_flow_20260126.png\",\n      \"description\": \"淨買賣月度走勢圖\"\n    }\n  ]\n}\n```\n\n---\n\n## 欄位說明\n\n### 頂層欄位\n\n| 欄位      | 類型   | 說明                        |\n|-----------|--------|-----------------------------|\n| `skill`   | string | Skill 識別碼                |\n| `version` | string | Skill 版本                  |\n| `as_of`   | string | 分析執行日期                |\n| `status`  | string | 執行狀態（success / error） |\n\n### data_source\n\n| 欄位              | 類型   | 說明                     |\n|-------------------|--------|--------------------------|\n| `name`            | string | 數據來源名稱             |\n| `url`             | string | 數據來源網址             |\n| `fetch_timestamp` | string | 數據抓取時間（ISO 8601） |\n| `data_version`    | string | 數據版本（最新可用月份） |\n\n### parameters\n\n記錄本次分析使用的所有參數，便於重現。\n\n### latest_month\n\n| 欄位                         | 類型       | 說明                         |\n|------------------------------|------------|------------------------------|\n| `date`                       | string     | 月份（YYYY-MM）              |\n| `net_purchases_billion_jpy`  | float      | 淨買入（十億日圓）           |\n| `net_purchases_trillion_jpy` | float      | 淨買入（兆日圓）             |\n| `net_purchases_usd_billion`  | float/null | 淨買入（十億美元，若有換算） |\n| `interpretation`             | string     | 中文解讀                     |\n\n### record_analysis\n\n| 欄位                      | 類型    | 說明                 |\n|---------------------------|---------|----------------------|\n| `is_record_sale`          | boolean | 是否為歷史最大淨賣出 |\n| `record_low_billion_jpy`  | float   | 歷史最低值           |\n| `record_low_date`         | string  | 歷史最低值日期       |\n| `record_high_billion_jpy` | float   | 歷史最高值           |\n| `record_high_date`        | string  | 歷史最高值日期       |\n| `lookback_period`         | string  | 回溯期間說明         |\n| `interpretation`          | string  | 中文解讀             |\n\n### streak_analysis\n\n| 欄位                                  | 類型   | 說明                 |\n|---------------------------------------|--------|----------------------|\n| `consecutive_negative_months`         | int    | 連續淨賣出月數       |\n| `streak_start`                        | string | 本輪起始月           |\n| `streak_end`                          | string | 本輪結束月           |\n| `cumulative_over_streak_billion_jpy`  | float  | 本輪累積（十億日圓） |\n| `cumulative_over_streak_trillion_jpy` | float  | 本輪累積（兆日圓）   |\n| `interpretation`                      | string | 中文解讀             |\n\n### historical_stats\n\n| 欄位                | 類型  | 說明                      |\n|---------------------|-------|---------------------------|\n| `count`             | int   | 樣本月數                  |\n| `mean_billion_jpy`  | float | 平均值                    |\n| `std_billion_jpy`   | float | 標準差                    |\n| `latest_zscore`     | float | 當前值的 Z-score          |\n| `latest_percentile` | float | 當前值的歷史分位數（0-1） |\n\n### caliber_notes\n\n口徑說明陣列，每個元素包含：\n\n| 欄位   | 類型   | 說明                                                |\n|--------|--------|-----------------------------------------------------|\n| `type` | string | 口徑類型（maturity_bucket / investor_group / unit） |\n| `used` | string | 本次使用的口徑                                      |\n| `note` | string | 說明與警示                                          |\n\n### confidence\n\n| 欄位      | 類型   | 說明                            |\n|-----------|--------|---------------------------------|\n| `level`   | string | 信心水準（high / medium / low） |\n| `reasons` | array  | 支持信心水準的理由              |\n| `caveats` | array  | 注意事項                        |\n\n---\n\n## 錯誤輸出結構\n\n```json\n{\n  \"skill\": \"analyze_jgb_insurer_superlong_flow\",\n  \"version\": \"0.1.0\",\n  \"as_of\": \"2026-01-26\",\n  \"status\": \"error\",\n  \"error\": {\n    \"code\": \"DATA_FETCH_FAILED\",\n    \"message\": \"無法從 JSDA 下載數據\",\n    \"details\": \"HTTP 503 Service Unavailable\",\n    \"suggestion\": \"請檢查 JSDA 網站是否可用，或使用本地快取數據\"\n  },\n  \"fallback\": {\n    \"used\": true,\n    \"cache_date\": \"2025-11\",\n    \"note\": \"使用快取數據，非最新\"\n  }\n}\n```\n",
        "skills/analyze-jgb-insurer-superlong-flow/templates/output-markdown.md": "# Markdown 報告模板\n\n## 快速檢查報告模板\n\n```markdown\n### 日本保險公司超長端 JGB 淨買入驗證（JSDA 公開數據）\n\n**分析日期**：{as_of}\n**數據來源**：JSDA Trends in Bond Transactions (by investor type)\n\n---\n\n#### 核心指標\n\n| 指標                        | 數值                      | 說明                       |\n|-----------------------------|---------------------------|----------------------------|\n| 本月（{latest_date}）淨買入 | **{latest_value} 兆日圓** | {interpretation}           |\n| 是否創紀錄                  | **{is_record}**           | {record_note}              |\n| 連續淨賣出月數              | **{streak_len} 個月**     | 自 {streak_start} 起       |\n| 本輪累積淨賣出              | **{cumulative} 兆日圓**   | 過去 {streak_len} 個月合計 |\n\n---\n\n#### 口徑說明\n\n- 投資人分類：{investor_group}\n- 天期桶：{maturity_bucket}\n\n> 若新聞口徑與本分析不同，數值可能略有差異。\n\n---\n\n**Headline**: {headline}\n```\n\n---\n\n## 完整分析報告模板\n\n```markdown\n### 日本保險公司超長端 JGB 淨買入完整分析\n\n**分析期間**：{start_date} 至 {end_date}\n**分析日期**：{as_of}\n**數據來源**：JSDA Trends in Bond Transactions (by investor type)\n\n---\n\n#### 一、最新月份狀態\n\n| 指標       | 數值                          | 說明               |\n|------------|-------------------------------|--------------------|\n| 本月淨買入 | {latest_value_billion} 億日圓 | {interpretation}   |\n| 是否創紀錄 | {is_record}                   | {record_note}      |\n| 歷史最低值 | {record_low_billion} 億日圓   | {record_low_date}  |\n| 歷史最高值 | {record_high_billion} 億日圓  | {record_high_date} |\n\n---\n\n#### 二、連續賣超分析\n\n| 指標           | 數值                         |\n|----------------|------------------------------|\n| 連續淨賣出月數 | {streak_len} 個月            |\n| 本輪起始月     | {streak_start}               |\n| 本輪累積淨賣出 | {cumulative_trillion} 兆日圓 |\n\n**趨勢解讀**：{streak_interpretation}\n\n---\n\n#### 三、歷史分布\n\n| 統計量         | 數值                           |\n|----------------|--------------------------------|\n| 樣本期間       | {sample_start} 至 {sample_end} |\n| 樣本月數       | {sample_count} 個月            |\n| 平均淨買入     | {mean_billion} 億日圓/月       |\n| 標準差         | {std_billion} 億日圓           |\n| 當前值 Z-score | {zscore}                       |\n| 當前值分位數   | {percentile}%                  |\n\n**分布解讀**：{distribution_interpretation}\n\n---\n\n#### 四、口徑說明\n\n##### 4.1 投資人分類\n\n| 本分析使用       | 說明            |\n|------------------|-----------------|\n| {investor_group} | {investor_note} |\n\n##### 4.2 天期桶\n\n| 本分析使用        | 說明            |\n|-------------------|-----------------|\n| {maturity_bucket} | {maturity_note} |\n\n**口徑警示**：{caliber_warning}\n\n---\n\n#### 五、結論與建議\n\n**Headline Takeaways**：\n1. {takeaway_1}\n2. {takeaway_2}\n3. {takeaway_3}\n\n**信心水準**：{confidence_level}\n\n**注意事項**：\n- {caveat_1}\n- {caveat_2}\n\n---\n\n*本報告基於 JSDA 公開數據生成，計算邏輯透明可重現。*\n```\n\n---\n\n## 驗證報告模板\n\n```markdown\n### 新聞數字驗證報告\n\n**驗證日期**：{as_of}\n\n---\n\n#### 新聞聲稱\n\n| 項目 | 內容            |\n|------|-----------------|\n| 數字 | {claim_value}   |\n| 時間 | {claim_date}    |\n| 口徑 | {claim_caliber} |\n| 來源 | {claim_source}  |\n\n---\n\n#### JSDA 原始數據對照\n\n| 口徑              | JSDA 數值         | 與新聞差異        | 說明              |\n|-------------------|-------------------|-------------------|-------------------|\n| super_long        | {jsda_super_long} | {diff_super_long} | {note_super_long} |\n| long              | {jsda_long}       | {diff_long}       | {note_long}       |\n| long + super_long | {jsda_combined}   | {diff_combined}   | {note_combined}   |\n\n---\n\n#### 驗證結論\n\n| 檢查項     | 結果              | 說明             |\n|------------|-------------------|------------------|\n| 數量級一致 | {magnitude_match} | {magnitude_note} |\n| 符號一致   | {sign_match}      | {sign_note}      |\n| 口徑對齊   | {caliber_match}   | {caliber_note}   |\n\n**總體評估**：{overall_assessment}\n\n**建議**：{recommendation}\n```\n\n---\n\n## 變數說明\n\n| 變數                     | 類型   | 說明                     |\n|--------------------------|--------|--------------------------|\n| `{as_of}`                | string | 分析日期                 |\n| `{start_date}`           | string | 分析起始年月             |\n| `{end_date}`             | string | 分析結束年月             |\n| `{latest_date}`          | string | 最新月份                 |\n| `{latest_value}`         | string | 最新月份淨買入（兆日圓） |\n| `{latest_value_billion}` | string | 最新月份淨買入（億日圓） |\n| `{is_record}`            | string | 是否創紀錄（是/否）      |\n| `{record_note}`          | string | 紀錄說明                 |\n| `{streak_len}`           | int    | 連續月數                 |\n| `{streak_start}`         | string | 本輪起始月               |\n| `{cumulative}`           | string | 累積金額（兆日圓）       |\n| `{investor_group}`       | string | 投資人分類               |\n| `{maturity_bucket}`      | string | 天期桶                   |\n| `{interpretation}`       | string | 解讀（淨買入/淨賣出）    |\n| `{headline}`             | string | 一句話結論               |\n| `{zscore}`               | float  | Z-score                  |\n| `{percentile}`           | float  | 分位數（%）              |\n| `{confidence_level}`     | string | 信心水準（高/中/低）     |\n",
        "skills/analyze-jgb-insurer-superlong-flow/workflows/full-analysis.md": "# Workflow: 完整分析\n\n<required_reading>\n**執行前請先閱讀**：\n1. references/data-sources.md - 確認 JSDA 數據可用性與下載方式\n2. references/methodology.md - 了解 streak、record、cumulative 計算邏輯\n</required_reading>\n\n<process>\n\n## Step 1: 確認分析參數\n\n**可選參數**：\n- `--start-year`: 起始財年（預設 2018，日本財年 4 月開始）\n- `--lookback`: 回溯月數（預設全樣本）\n- `--format`: 輸出格式（`json` 或 `markdown`，預設 markdown）\n- `--refresh`: 強制重新下載數據\n\n## Step 2: 抓取 JSDA 數據\n\n數據會自動從 JSDA 網站下載並緩存：\n\n```bash\ncd .claude/skills/analyze-jgb-insurer-superlong-flow\npython scripts/jsda_flow_analyzer.py --full --refresh\n```\n\n**數據來源**：\n- 當前財年：`https://www.jsda.or.jp/shiryoshitsu/toukei/tentoubaibai/koushasai.xlsx`\n- 歷史財年：`https://www.jsda.or.jp/shiryoshitsu/toukei/tentoubaibai/koushasai{YYYY}.xlsx`\n\n腳本會：\n1. 從 JSDA 下載最新 Excel 檔案\n2. 解析 Sheet「(Ｊ)合計差引」\n3. 提取「生保・損保」的「超長期」淨賣出數據\n4. 緩存到 `data/cache/` 目錄\n\n## Step 3: 執行完整分析\n\n```bash\n# Markdown 格式輸出\npython scripts/jsda_flow_analyzer.py --full\n\n# JSON 格式輸出\npython scripts/jsda_flow_analyzer.py --full --format json\n\n# 指定起始年份\npython scripts/jsda_flow_analyzer.py --full --start-year 2020\n\n# 輸出到檔案\npython scripts/jsda_flow_analyzer.py --full --format json --output ../../output/analysis.json\n```\n\n## Step 4: 計算關鍵指標\n\n### 4.1 符號慣例（重要）\n\nJSDA 使用「賣出 - 買入」計算差引：\n```\nnet_sale = 売付額 - 買付額\n```\n\n- **正值 = 淨賣出**（賣出 > 買入，需求減少）\n- **負值 = 淨買入**（買入 > 賣出，需求增加）\n\n### 4.2 判斷是否為歷史極值\n\n```python\nrecord_high = max(series)  # 最大淨賣出（正值最大）\nis_record_sale = (latest == record_high) and (latest > 0)\n```\n\n### 4.3 計算連續淨賣出月數\n\n```python\ndef calc_streak(series):\n    streak = 0\n    for v in reversed(series.values):\n        if v > 0:  # 正值 = 淨賣出\n            streak += 1\n        else:\n            break\n    return streak\n```\n\n### 4.4 計算本輪累積淨賣出\n\n```python\ncumulative = series.tail(streak_len).sum()\n```\n\n## Step 5: 口徑說明\n\n**數據口徑**：\n- **投資人分類**：生保・損保（Life & Non-Life Insurance Companies）\n- **天期桶**：超長期（Interest-bearing Long-term over 10-year）\n- **交易類型**：店頭交易（OTC），不含交易所交易\n- **單位**：億日圓（100 million yen）\n\n## Step 6: 生成完整報告\n\nMarkdown 輸出範例：\n\n```markdown\n## 日本保險公司超長期 JGB 淨買賣驗證報告\n\n**分析期間**：2021-04 ~ 2025-12（57 個月）\n\n### 核心結論\n\n| 指標 | 數值 | 說明 |\n|------|------|------|\n| 本月（2025-12）| **8,224 億日圓** | 淨賣出 |\n| 是否創歷史紀錄 | **✓ 是** | 全樣本 (57 個月) |\n| 連續淨賣出月數 | **5 個月** | 自 2025-08 起 |\n| 本輪累積淨賣出 | **13,959 億日圓** | 1.40 兆日圓 |\n\n### 歷史統計\n\n| 指標 | 數值 |\n|------|------|\n| 平均值 | -2,872 億/月（淨買入為主）|\n| 標準差 | 3,830 億 |\n| Z-score | 2.90（極端淨賣出）|\n| 分位數 | 98.25%（歷史高位）|\n\n### Headline Takeaways\n\n1. ✓ 驗證屬實：日本保險公司在 2025/12 創下歷史最大單月淨賣出\n2. 已連續 5 個月淨賣出超長期國債，累積 1.40 兆日圓\n3. 當前淨賣出規模處於歷史極端區間（Z-score: 2.90）\n```\n\n## Step 7: 輸出 JSON（結構化）\n\n```bash\npython scripts/jsda_flow_analyzer.py --full --format json --output ../../output/jgb-insurer-superlong-flow-2025-12.json\n```\n\nJSON 輸出包含完整的數據來源、參數、分析結果和 headline takeaways。\n\n</process>\n\n<success_criteria>\n完整分析完成時：\n\n- [x] 成功抓取指定期間的 JSDA 數據\n- [x] 計算並輸出最新月份淨賣出數值\n- [x] 判斷是否為歷史極值（含回溯期間說明）\n- [x] 計算連續淨賣出月數與累積金額\n- [x] 提供歷史分布統計（均值、標準差、Z-score）\n- [x] 明確標示天期桶與投資人口徑\n- [x] 生成完整 Markdown 或 JSON 報告\n</success_criteria>\n",
        "skills/analyze-jgb-insurer-superlong-flow/workflows/generate-chart.md": "# Workflow: 生成視覺化圖表\n\n<required_reading>\n**執行前請先閱讀**：\n1. references/data-sources.md - 確認數據可用性\n2. thoughts/shared/guide/bloomberg-style-chart-guide.md - Bloomberg 風格設計規範\n</required_reading>\n\n<process>\n\n## Step 1: 確認圖表參數\n\n**可選參數**：\n- `--output-dir`: 輸出目錄（預設專案根目錄 `output/`）\n- `--filename`: 輸出檔名（預設 `jgb-insurer-superlong-flow-YYYYMMDD.png`）\n- `--no-rolling`: 不顯示 12M 滾動累積線\n- `--no-stats`: 不顯示統計摘要面板\n- `--no-record`: 不標記創紀錄月份\n- `--refresh`: 強制重新下載數據\n\n## Step 2: 安裝依賴\n\n```bash\npip install pandas numpy openpyxl matplotlib\n```\n\n## Step 3: 生成圖表\n\n```bash\ncd .claude/skills/analyze-jgb-insurer-superlong-flow\npython scripts/generate_flow_chart.py --output-dir ../../../output\n```\n\n輸出：`output/jgb-insurer-superlong-flow-YYYYMMDD.png`\n\n## Step 4: 圖表內容說明\n\n生成的圖表遵循 Bloomberg 風格設計：\n\n### 4.1 配色方案\n\n| 元素 | 顏色 | 說明 |\n|------|------|------|\n| 背景 | #1a1a2e | 深藍黑色 |\n| 網格 | #2d2d44 | 暗灰紫色 |\n| 淨賣出柱 | #ff4444 | 紅色（需求↓）|\n| 淨買入柱 | #00ff88 | 綠色（需求↑）|\n| 12M 滾動線 | #ffaa00 | 橙黃色 |\n| 創紀錄標記 | #ff00ff | 品紅色 |\n\n### 4.2 主圖：淨賣出/買入柱狀圖\n\n- X 軸：時間（月度，年為主刻度）\n- Y 軸：淨賣出金額（億日圓）\n- 正值（紅色）：淨賣出（賣出 > 買入）\n- 負值（綠色）：淨買入（買入 > 賣出）\n- 零線：水平參考線\n\n### 4.3 疊加：12M 滾動累積線\n\n- 橙黃色虛線\n- 顯示過去 12 個月的累積淨賣出\n- 便於識別中期趨勢轉向\n\n### 4.4 創紀錄月份標記\n\n- 品紅色箭頭標註\n- 顯示紀錄值（億日圓）\n\n### 4.5 統計摘要面板\n\n位於左上角，包含：\n- 最新月份與數值\n- 連續淨賣出月數\n- 本輪累積金額\n- Z-score\n- 創紀錄月份與數值\n\n### 4.6 頁尾資訊\n\n- 資料來源：JSDA 公社債店頭売買高\n- 截至日期、投資人類型、天期桶\n\n## Step 5: 自訂選項\n\n```bash\n# 不顯示滾動線\npython scripts/generate_flow_chart.py --no-rolling\n\n# 不顯示統計面板\npython scripts/generate_flow_chart.py --no-stats\n\n# 指定檔名\npython scripts/generate_flow_chart.py --filename my-chart.png\n\n# 完整選項\npython scripts/generate_flow_chart.py \\\n  --output-dir ../../../output \\\n  --filename jgb-flow-custom.png \\\n  --refresh\n```\n\n## Step 6: 輸出範例\n\n生成的圖表範例位置：\n```\noutput/jgb-insurer-superlong-flow-20260126.png\n```\n\n圖表特點：\n- Bloomberg 終端風格深色背景\n- 清晰的紅綠對比顯示淨賣出/買入\n- 12M 滾動線便於識別趨勢\n- 左上角統計摘要面板\n- 創紀錄月份明確標記\n- 完整的頁尾資訊標註\n\n</process>\n\n<success_criteria>\n圖表生成完成時：\n\n- [x] 成功生成 PNG 圖表\n- [x] 採用 Bloomberg 風格深色背景\n- [x] 正確顯示淨賣出（紅色）vs 淨買入（綠色）\n- [x] 顯示 12M 滾動累積線\n- [x] 標記創紀錄月份\n- [x] 包含統計摘要面板\n- [x] 明確標示天期桶口徑與數據來源\n- [x] 輸出到指定目錄\n</success_criteria>\n",
        "skills/analyze-jgb-insurer-superlong-flow/workflows/quick-check.md": "# Workflow: 快速檢查\n\n<required_reading>\n**執行前請先閱讀**：\n1. references/data-sources.md - 確認 JSDA 數據可用性\n2. references/methodology.md - 了解計算邏輯\n</required_reading>\n\n<process>\n\n## Step 1: 執行快速分析腳本\n\n```bash\ncd .claude/skills/analyze-jgb-insurer-superlong-flow\npython scripts/jsda_flow_analyzer.py --quick\n```\n\n若首次使用，先安裝依賴：\n```bash\npip install pandas numpy openpyxl\n```\n\n## Step 2: 檢視輸出結果\n\n腳本將輸出最新月份的關鍵指標：\n\n```json\n{\n  \"skill\": \"analyze_jgb_insurer_superlong_flow\",\n  \"latest_month\": {\n    \"date\": \"2025-12\",\n    \"net_sale_100m_yen\": 8224,\n    \"net_sale_trillion_yen\": 0.8224,\n    \"interpretation\": \"淨賣出\"\n  },\n  \"record_analysis\": {\n    \"is_record_sale\": true,\n    \"record_sale_100m_yen\": 8224,\n    \"record_sale_date\": \"2025-12\"\n  },\n  \"streak_analysis\": {\n    \"consecutive_net_sale_months\": 5,\n    \"cumulative_net_sale_100m_yen\": 13959\n  }\n}\n```\n\n## Step 3: 解讀結果\n\n**符號慣例（重要）**：\n\nJSDA 使用「賣出 - 買入」計算差引：\n- **正值 = 淨賣出**（賣出 > 買入，需求減少）\n- **負值 = 淨買入**（買入 > 賣出，需求增加）\n\n**關鍵指標解讀**：\n\n| 指標                             | 意義                            |\n|----------------------------------|---------------------------------|\n| `net_sale_100m_yen`              | 最新月份淨賣出（億日圓）        |\n| `is_record_sale`                 | 是否為歷史最大淨賣出（正值最大）|\n| `consecutive_net_sale_months`    | 連續淨賣出月數                  |\n| `cumulative_net_sale_100m_yen`   | 本輪連續淨賣出的累積金額        |\n\n## Step 4: 生成摘要\n\n根據結果生成可複製的摘要：\n\n```markdown\n### 日本保險公司超長期 JGB 淨買賣驗證（JSDA 公開數據）\n\n- 本月（2025-12）：**淨賣出 8,224 億日圓**（0.82 兆日圓）\n- 是否創紀錄：**是**（全樣本最大淨賣出）\n- 連續淨賣出月數：**5 個月**（自 2025-08 起）\n- 本輪累積淨賣出：**13,959 億日圓**（1.40 兆日圓）\n\n> 註：天期桶採用 JSDA「超長期」分類（10 年以上利付債）。\n> 數據來源：JSDA 公社債店頭売買高 (Trading Volume of OTC Bonds)\n```\n\n## Step 5: 強制重新下載數據（可選）\n\n若需要最新數據，使用 `--refresh` 參數：\n\n```bash\npython scripts/jsda_flow_analyzer.py --quick --refresh\n```\n\n</process>\n\n<success_criteria>\n快速檢查完成時：\n\n- [x] 成功抓取最新月份數據\n- [x] 輸出淨賣出數值與正負判斷\n- [x] 判斷是否為歷史極值\n- [x] 計算連續淨賣出月數\n- [x] 生成可複製的摘要\n</success_criteria>\n",
        "skills/analyze-jgb-insurer-superlong-flow/workflows/verify-claim.md": "# Workflow: 驗證新聞/媒體報導\n\n<required_reading>\n**執行前請先閱讀**：\n1. references/data-sources.md - 確認 JSDA 數據可用性\n2. references/methodology.md - 了解計算邏輯與符號慣例\n</required_reading>\n\n<process>\n\n## Step 1: 收集新聞/報導的聲稱\n\n請用戶提供以下資訊：\n\n1. **聲稱的數字**：如「創紀錄賣超 ¥8,000 億」\n2. **時間點**：如「2025 年 12 月」\n3. **天期桶口徑**：如「10 年以上」或「超長端」\n4. **投資人類型**：如「保險公司」或「壽險公司」\n5. **來源**：如「Bloomberg」或「JSDA」\n\n## Step 2: 對照 JSDA 原始數據\n\n```bash\ncd .claude/skills/analyze-jgb-insurer-superlong-flow\npython scripts/jsda_flow_analyzer.py --full --format json\n```\n\n## Step 3: 符號慣例確認（重要）\n\n**JSDA 符號慣例**：\n```\nnet_sale = 売付額 - 買付額\n```\n\n| JSDA 數值 | 意義 | 新聞常見表達 |\n|-----------|------|--------------|\n| **正值** | 淨賣出（賣出 > 買入）| 「賣超」、「減持」|\n| **負值** | 淨買入（買入 > 賣出）| 「買超」、「增持」|\n\n**注意**：部分新聞使用相反的符號慣例（負值 = 淨賣出），需確認。\n\n## Step 4: 口徑對照分析\n\n### 4.1 天期桶對照\n\n| 新聞口徑   | JSDA 對應                | 說明 |\n|------------|--------------------------|------|\n| 10+ years  | 超長期（over 10-year）   | 直接對應 |\n| super-long | 超長期（over 10-year）   | 直接對應 |\n| long-term  | 利付長期（5-10 年）      | 不同天期桶 |\n| 10年以上   | 超長期                   | 直接對應 |\n\n### 4.2 投資人分類對照\n\n| 新聞口徑 | JSDA 對應 | 說明 |\n|----------|-----------|------|\n| 保險公司 | 生保・損保 | 壽險 + 產險合計 |\n| 壽險公司 | （無法分拆）| JSDA 僅提供合計 |\n| 產險公司 | （無法分拆）| JSDA 僅提供合計 |\n\n## Step 5: 生成驗證報告\n\n```markdown\n### 新聞數字驗證報告\n\n**新聞聲稱**：\n- 數字：¥8,000 億（淨賣出）\n- 時間：2025-12\n- 口徑：10 年以上 / 保險公司\n\n**JSDA 原始數據對照**：\n\n| 指標 | JSDA 數值 | 說明 |\n|------|-----------|------|\n| 超長期淨賣出 | +8,224 億日圓 | 正值 = 淨賣出 |\n| 與新聞差異 | +2.8% | 新聞數字略低 |\n\n**驗證結論**：\n\n✓ 數量級一致（約 ¥8,000 億）\n✓ 方向一致（確實為淨賣出）\n✓ 口徑一致（超長期 = 10 年以上）\n✓ 創紀錄屬實（樣本期間最大淨賣出）\n\n**結論**：新聞報導數字基本準確。\n```\n\n## Step 6: 常見差異原因\n\n若數字有顯著差異，檢查以下原因：\n\n1. **符號慣例**：JSDA 正值 = 淨賣出，部分來源相反\n2. **天期桶口徑**：超長期 vs 長期 vs 合併 10Y+\n3. **投資人細分**：全保險 vs 僅壽險（JSDA 無法分拆）\n4. **時間點**：月份是否對齊\n5. **單位**：億 vs 十億 vs 兆\n6. **數據版本**：JSDA 可能有修正值\n7. **數據來源**：店頭 vs 交易所\n\n## Step 7: 輸出驗證摘要\n\n```json\n{\n  \"verification_result\": {\n    \"claim\": {\n      \"value_100m_jpy\": 8000,\n      \"direction\": \"淨賣出\",\n      \"date\": \"2025-12\",\n      \"source\": \"新聞/Bloomberg\"\n    },\n    \"jsda_data\": {\n      \"super_long_100m_jpy\": 8224,\n      \"sign_convention\": \"正值=淨賣出\"\n    },\n    \"match_assessment\": {\n      \"magnitude_match\": true,\n      \"direction_match\": true,\n      \"exact_match\": false,\n      \"difference_pct\": 2.8\n    },\n    \"recommendation\": \"數字準確，創紀錄屬實\"\n  }\n}\n```\n\n</process>\n\n<success_criteria>\n驗證工作流完成時：\n\n- [x] 收集新聞/報導的具體聲稱\n- [x] 確認符號慣例（JSDA 正值 = 淨賣出）\n- [x] 抓取對應時間點的 JSDA 原始數據\n- [x] 進行口徑對照分析\n- [x] 計算數值差異百分比\n- [x] 識別可能的差異原因\n- [x] 生成驗證結論與建議\n- [x] 輸出結構化驗證報告\n</success_criteria>\n",
        "skills/analyze-move-risk-gauges-leadlag/SKILL.md": "---\nname: analyze-move-risk-gauges-leadlag\ndescription: 用公開市場數據檢查「利率波動率（MOVE）是否對利率事件（如 JGB 殖利率變動）不恐慌，並且是否領先帶動 VIX / 信用利差走低」。\n---\n\n<essential_principles>\n\n<principle name=\"move_as_leading_indicator\">\n**MOVE 作為利率波動率領先指標**\n\nMOVE Index（美林期權波動率指數）是衡量美國國債選擇權隱含波動率的指標：\n- **MOVE 低/下降**：利率市場對未來波動預期降低，風險偏好上升\n- **MOVE 高/上升**：利率市場恐慌，避險需求增加\n\nMOVE 常被視為「債市的 VIX」，可作為其他風險指標的領先訊號。\n</principle>\n\n<principle name=\"leadlag_cross_correlation\">\n**交叉相關判斷領先落後**\n\n使用 Cross-Correlation 判斷兩序列的領先/落後關係：\n- 在 [-L, +L] 位移範圍內計算相關係數\n- **最大相關出現在 lag > 0**：X 領先 Y\n- **最大相關出現在 lag < 0**：X 落後 Y\n- **最大相關出現在 lag ≈ 0**：同步移動\n\n典型設定：L = 20（交易日），配合平滑處理降低噪音。\n</principle>\n\n<principle name=\"shock_event_reaction\">\n**事件窗檢定：是否被嚇到**\n\n檢驗「利率事件（如 JGB 殖利率跳升）發生時，MOVE 是否恐慌」：\n1. 定義衝擊事件：|ΔY[t-k:t]| ≥ threshold（如 15bp）\n2. 檢查事件窗內 MOVE 變化\n3. 若 MOVE 反應 < 歷史分布中位數 → \"not spooked\"\n\n此邏輯可驗證「利率波動率對某事件不敏感」的敘事。\n</principle>\n\n<principle name=\"data_access\">\n**資料取得方式**\n\n本 skill 使用 **Chrome CDP** 連接到 MacroMicro 抓取真實數據：\n- **MOVE Index**: MacroMicro (CDP) - https://en.macromicro.me/charts/35584/us-treasury-move-index\n- **JGB 10Y**: MacroMicro (CDP) - https://en.macromicro.me/charts/944/jp-10-year-goverment-bond-yield\n- **VIX**: Yahoo Finance (yfinance)\n- **Credit (IG OAS)**: FRED (BAMLC0A0CM)\n\n**重要**：MOVE 和 JGB 需要透過 Chrome CDP 爬蟲取得，請參照 `<quick_start>` 的步驟啟動 Chrome。\n</principle>\n\n</essential_principles>\n\n<objective>\n實作利率波動率與風險指標的領先落後分析：\n\n1. **數據抓取**：從公開來源取得 MOVE、VIX、信用利差、JGB 殖利率\n2. **標準化處理**：Z 分數、平滑處理、頻率對齊\n3. **領先落後分析**：交叉相關找出 MOVE vs VIX / 信用利差的 lead/lag\n4. **事件窗檢定**：JGB 衝擊事件中 MOVE 是否「不恐慌」\n5. **方向一致性**：MOVE 下行時，其他風險指標是否同步下行\n\n輸出：領先落後判定、恐慌檢定結果、方向一致性比例、量化證據。\n</objective>\n\n<quick_start>\n\n**執行分析前，必須先啟動 Chrome 調試模式**\n\n**Step 1：關閉所有 Chrome 視窗**\n\n**Step 2：用調試端口啟動 Chrome（Windows）**\n\n```bash\n\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" ^\n  --remote-debugging-port=9222 ^\n  --remote-allow-origins=* ^\n  --user-data-dir=\"%USERPROFILE%\\.chrome-debug-profile\" ^\n  \"https://en.macromicro.me/charts/35584/us-treasury-move-index\"\n```\n\n**Step 3：在瀏覽器中開啟第二個分頁，載入 JGB 頁面**\n\n```\nhttps://en.macromicro.me/charts/944/jp-10-year-goverment-bond-yield\n```\n\n**Step 4：等待兩個頁面的圖表都完全載入（約 30-40 秒）**\n\n**Step 5：執行分析**\n\n```bash\ncd .claude/skills/analyze-move-risk-gauges-leadlag/scripts\npip install pandas numpy yfinance requests websocket-client matplotlib  # 首次使用\npython analyze.py --start 2024-01-01 --end 2026-01-31 --output-mode markdown\n```\n\n**Step 6（可選）：生成 Bloomberg 風格視覺化圖表**\n\n```bash\n# 方式一：分析時同時生成圖表\npython analyze.py --start 2024-01-01 --end 2026-01-31 --output-mode markdown --chart\n\n# 方式二：單獨生成圖表（自動使用快取數據）\npython visualize.py --start 2024-01-01 --end 2026-01-31\n```\n\n圖表預設輸出路徑：`{專案根目錄}/output/move-leadlag-YYYY-MM-DD.png`\n\n輸出範例：\n```\n## 結論\n\n- 利率波動率（MOVE）對「JGB 殖利率衝擊」反應偏弱 / 未顯著升溫 → **not spooked**\n- MOVE 的變化在統計上呈現 **領先 4-6 天** 的特徵\n- MOVE 下行時，VIX / 信用利差同步走低的比例：VIX = 62%、Credit = 60%\n```\n\n</quick_start>\n\n<intake>\n需要進行什麼操作？\n\n1. **快速檢查** - 查看目前 MOVE 的領先落後狀態與恐慌程度\n2. **完整分析** - 執行完整的領先落後與事件窗分析\n3. **視覺化圖表** - 生成多面板分析結果圖表\n4. **方法論學習** - 了解 Lead/Lag 分析與事件窗檢定的邏輯\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                     | Action                                                               |\n|------------------------------|----------------------------------------------------------------------|\n| 1, \"快速\", \"quick\", \"check\"  | 確認 Chrome CDP 已啟動，執行 `python scripts/analyze.py --quick`     |\n| 2, \"完整\", \"full\", \"analyze\" | 閱讀 `workflows/analyze.md` 並執行                                   |\n| 3, \"視覺化\", \"chart\", \"plot\" | 閱讀 `workflows/visualize.md` 並執行                                 |\n| 4, \"學習\", \"方法論\", \"why\"   | 閱讀 `references/methodology.md`                                     |\n| 提供參數 (如日期範圍)        | 閱讀 `workflows/analyze.md` 並使用參數執行                           |\n\n**重要**：執行分析前必須確保 Chrome CDP 已啟動並載入 MOVE 和 JGB 頁面。\n</routing>\n\n<directory_structure>\n```\nanalyze-move-risk-gauges-leadlag/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元數據\n├── cache/                             # 數據快取目錄\n├── workflows/\n│   ├── analyze.md                     # 完整分析工作流\n│   └── visualize.md                   # 視覺化工作流\n├── references/\n│   ├── data-sources.md                # 資料來源與替代方案\n│   ├── methodology.md                 # Lead/Lag 與事件窗方法論\n│   └── input-schema.md                # 完整輸入參數定義\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n└── scripts/\n    ├── analyze.py                     # 主分析腳本\n    ├── fetch_data.py                  # 數據抓取工具 (CDP + FRED + Yahoo)\n    ├── visualize.py                   # Lead/Lag 綜合圖表繪圖工具\n    └── visualize_rates_move.py        # 利率 vs MOVE 恐慌專題圖表（可帶入任何國家債券）\n```\n</directory_structure>\n\n<reference_index>\n\n**方法論**: references/methodology.md\n- Lead/Lag 交叉相關分析\n- Z 分數標準化\n- 事件窗檢定邏輯\n\n**資料來源**: references/data-sources.md\n- MOVE Index: MacroMicro CDP\n- JGB 10Y: MacroMicro CDP\n- VIX: Yahoo Finance\n- Credit (IG OAS): FRED\n- 數據頻率與對齊\n\n**輸入參數**: references/input-schema.md\n- 完整參數定義\n- 預設值與建議範圍\n\n</reference_index>\n\n<workflows_index>\n| Workflow     | Purpose          | 使用時機           |\n|--------------|------------------|--------------------|\n| analyze.md   | 完整領先落後分析 | 需要詳細分析報告時 |\n| visualize.md | 生成視覺化圖表   | 需要圖表展示時     |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構定義 |\n| output-markdown.md | Markdown 報告模板 |\n</templates_index>\n\n<scripts_index>\n| Script               | Command                                                              | Purpose                           |\n|----------------------|----------------------------------------------------------------------|-----------------------------------|\n| analyze.py           | `--quick`                                                            | 快速檢查當前狀態                  |\n| analyze.py           | `--start DATE --end DATE`                                            | 完整分析                          |\n| analyze.py           | `--start DATE --end DATE --chart`                                    | 分析並生成 Lead/Lag 綜合圖表      |\n| analyze.py           | `--start DATE --end DATE --rates-chart`                              | 分析並生成利率 vs MOVE 專題圖表   |\n| analyze.py           | `--rates-chart --rates-col BUND10Y --rates-name \"Bund 10Y\"`          | 指定其他國家債券分析              |\n| fetch_data.py        | `--start DATE --end DATE`                                            | 單獨抓取數據                      |\n| visualize.py         | `--start DATE --end DATE`                                            | 獨立生成 Lead/Lag 綜合圖表        |\n| visualize_rates_move.py | `--start DATE --end DATE --rates-col JGB10Y --rates-name \"JGB 10Y\"` | 獨立生成利率 vs MOVE 恐慌專題圖表 |\n</scripts_index>\n\n<input_schema_summary>\n\n**核心參數**\n\n| 參數                 | 類型   | 預設值       | 說明                  |\n|----------------------|--------|--------------|-----------------------|\n| start_date           | string | -            | 起始日期 (YYYY-MM-DD) |\n| end_date             | string | -            | 結束日期 (YYYY-MM-DD) |\n| rates_vol_symbol     | string | MOVE         | 利率波動率指標        |\n| equity_vol_symbol    | string | VIX          | 股市波動率指標        |\n| credit_spread_symbol | string | CDX_IG_PROXY | 信用利差/風險指標     |\n| jgb_yield_symbol     | string | JGB10Y       | 日本 10Y 殖利率       |\n\n**分析參數**\n\n| 參數                | 類型   | 預設值   | 說明                 |\n|---------------------|--------|----------|----------------------|\n| freq                | string | D        | 頻率（D=日 / W=週）  |\n| smooth_window       | int    | 5        | 平滑移動平均窗       |\n| zscore_window       | int    | 60       | Z 分數回看窗         |\n| lead_lag_max_days   | int    | 20       | 交叉相關最大位移天數 |\n| shock_window_days   | int    | 5        | 事件窗天數           |\n| shock_threshold_bps | float  | 15       | JGB 衝擊門檻 (bps)   |\n| output_mode         | string | markdown | 輸出格式             |\n\n完整參數定義見 `references/input-schema.md`。\n\n</input_schema_summary>\n\n<output_schema_summary>\n```json\n{\n  \"skill\": \"analyze-move-risk-gauges-leadlag\",\n  \"as_of\": \"2026-01-23\",\n  \"status\": \"ok\",\n  \"headline\": \"MOVE not spooked by JGB yield moves and appears to lead VIX/Credit lower.\",\n  \"leadlag\": {\n    \"MOVE_vs_VIX\": {\"best_lag_days\": 6, \"corr\": 0.72},\n    \"MOVE_vs_CREDIT\": {\"best_lag_days\": 4, \"corr\": 0.61}\n  },\n  \"spooked_check\": {\n    \"shock_definition\": \"abs(JGB10Y change over 5d) >= 15bp\",\n    \"shock_count\": 3,\n    \"mean_MOVE_reaction_on_shocks\": 0.8,\n    \"MOVE_zscore_now\": -0.4\n  },\n  \"direction_alignment\": {\n    \"MOVE_down_and_VIX_down_ratio\": 0.58,\n    \"MOVE_down_and_CREDIT_down_ratio\": 0.55\n  }\n}\n```\n\n完整輸出結構見 `templates/output-json.md`。\n</output_schema_summary>\n\n<success_criteria>\n執行成功時應產出：\n\n- [ ] MOVE vs VIX / Credit 的最佳領先天數與相關係數\n- [ ] JGB 衝擊事件數量與 MOVE 平均反應\n- [ ] MOVE 當前 Z 分數（恐慌程度）\n- [ ] 方向一致性比例\n- [ ] 一句話結論與量化證據\n- [ ] 視覺化圖表（可選）\n</success_criteria>\n\n<chrome_cdp_reference>\n\n## Chrome CDP 啟動指令\n\n### Windows\n\n```bash\n\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" ^\n  --remote-debugging-port=9222 ^\n  --remote-allow-origins=* ^\n  --user-data-dir=\"%USERPROFILE%\\.chrome-debug-profile\" ^\n  \"https://en.macromicro.me/charts/35584/us-treasury-move-index\"\n```\n\n### macOS\n\n```bash\n/Applications/Google\\ Chrome.app/Contents/MacOS/Google\\ Chrome \\\n  --remote-debugging-port=9222 \\\n  --remote-allow-origins=* \\\n  --user-data-dir=\"$HOME/.chrome-debug-profile\" \\\n  \"https://en.macromicro.me/charts/35584/us-treasury-move-index\"\n```\n\n### 驗證連線\n\n```bash\ncurl -s http://127.0.0.1:9222/json\n```\n\n### 需要開啟的頁面\n\n1. **MOVE Index**: https://en.macromicro.me/charts/35584/us-treasury-move-index\n2. **JGB 10Y**: https://en.macromicro.me/charts/944/jp-10-year-goverment-bond-yield\n\n</chrome_cdp_reference>\n\n<visualization_reference>\n\n## Bloomberg 風格視覺化圖表\n\n本 skill 生成的圖表遵循 `thoughts/shared/guide/bloomberg-style-chart-guide.md` 規範。\n\n### 圖表結構（2x3 佈局）\n\n```\n┌──────────────┬─────────────────────────────────┐\n│ 交叉相關分析  │ 波動率指標時間序列               │\n│   (1,1)      │      (1,2) + (1,3)              │\n├──────────────┼─────────────────────────────────┤\n│ 事件反應分布  │ 標準化序列（Z 分數）            │\n│   (2,1)      │      (2,2) + (2,3)              │\n└──────────────┴─────────────────────────────────┘\n```\n\n| 位置          | 面板名稱           | 內容                                   |\n|---------------|--------------------|----------------------------------------|\n| 左上 (1,1)    | 交叉相關分析       | MOVE vs VIX/Credit 的 lead/lag 曲線    |\n| 左下 (2,1)    | 事件反應分布       | JGB 衝擊時 MOVE 變化直方圖 + 判定結果  |\n| 右上 (跨2格)  | 波動率時間序列     | MOVE Index + VIX（雙軸）+ 衝擊事件標記 |\n| 右下 (跨2格)  | 標準化序列         | MOVE/VIX/Credit Z 分數 + 當前 MOVE 標記|\n\n### 配色方案\n\n```python\nCOLORS = {\n    \"background\": \"#1a1a2e\",   # 深藍黑色背景\n    \"primary\": \"#ff6b35\",       # 橙紅色（MOVE）\n    \"secondary\": \"#ffaa00\",     # 橙黃色（VIX）\n    \"tertiary\": \"#ffff00\",      # 黃色（Credit）\n    \"jgb\": \"#00ff88\",           # 綠色（JGB/未恐慌）\n    \"shock_line\": \"#ff4444\",    # 紅色（衝擊/恐慌）\n}\n```\n\n### 圖表輸出\n\n- **預設路徑**: `{專案根目錄}/output/move-leadlag-YYYY-MM-DD.png`\n- **解析度**: 150 DPI\n- **尺寸**: 18x10 英寸\n- **格式**: PNG\n\n### CLI 參數\n\n```bash\n# 分析時自動生成 Lead/Lag 綜合圖表\npython analyze.py --start 2024-01-01 --end 2026-01-31 --chart\n\n# 生成利率 vs MOVE 恐慌專題圖表（預設 JGB 10Y）\npython analyze.py --start 2024-01-01 --end 2026-01-31 --rates-chart\n\n# 指定其他國家債券（如 Bund 10Y）\npython analyze.py --start 2024-01-01 --end 2026-01-31 --rates-chart \\\n  --rates-col BUND10Y --rates-name \"Bund 10Y\"\n\n# 同時生成兩種圖表\npython analyze.py --start 2024-01-01 --end 2026-01-31 --chart --rates-chart\n\n# 單獨生成圖表\npython visualize.py --start 2024-01-01 --end 2026-01-31\npython visualize_rates_move.py --start 2024-01-01 --end 2026-01-31 --rates-col JGB10Y --rates-name \"JGB 10Y\"\n```\n\n</visualization_reference>\n\n<rates_move_chart_reference>\n\n## 利率 vs MOVE 恐慌專題圖表\n\n通用的利率波動率恐慌分析圖表，**可帶入任何國家/地區的債券殖利率**。\n\n專注於回答：「MOVE 是否對 [指定債券] 殖利率變動感到恐慌？」\n\n### 支援的債券（需在數據中存在）\n\n| 參數值 (--rates-col) | 顯示名稱 (--rates-name) | 說明 |\n|---------------------|------------------------|------|\n| JGB10Y | \"JGB 10Y\" | 日本 10 年期公債（預設） |\n| UST10Y | \"UST 10Y\" | 美國 10 年期公債 |\n| BUND10Y | \"Bund 10Y\" | 德國 10 年期公債 |\n| GILT10Y | \"Gilt 10Y\" | 英國 10 年期公債 |\n| （自訂） | （自訂） | 任何在數據中存在的利率欄位 |\n\n### 使用範例\n\n```bash\n# 分析 JGB 10Y vs MOVE（預設）\npython analyze.py --start 2024-01-01 --end 2026-01-31 --rates-chart\n\n# 分析 Bund 10Y vs MOVE\npython analyze.py --start 2024-01-01 --end 2026-01-31 --rates-chart \\\n  --rates-col BUND10Y --rates-name \"Bund 10Y\"\n\n# 獨立生成圖表\npython visualize_rates_move.py --start 2024-01-01 --end 2026-01-31 \\\n  --rates-col JGB10Y --rates-name \"JGB 10Y\"\n```\n\n### 圖表結構\n\n```\n┌─────────────────────────────────────────────────┐\n│           [利率名稱] vs MOVE 時序圖              │\n│           （雙軸對比 + 衝擊事件標記）            │\n├───────────────────────┬─────────────────────────┤\n│   利率變化 vs MOVE    │     恐慌判定儀表板       │\n│   反應散點圖 + 回歸線  │   （統計數據 + 結論）    │\n└───────────────────────┴─────────────────────────┘\n```\n\n| 位置 | 面板名稱 | 內容 |\n|------|----------|------|\n| 上方 | 時序對比 | 指定利率（綠）+ MOVE（橙）雙軸圖，黃色虛線標記衝擊事件 |\n| 左下 | 散點分析 | 利率變化(bps) vs MOVE 變化，含回歸線與相關係數 |\n| 右下 | 判定儀表板 | 恐慌/未恐慌判定結果、統計數據、解讀說明 |\n\n### 配色方案\n\n```python\nCOLORS = {\n    \"move\": \"#ff6b35\",          # 橙紅色（MOVE）\n    \"rates\": \"#00ff88\",         # 綠色（利率）\n    \"spooked\": \"#ff4444\",       # 紅色（恐慌判定）\n    \"not_spooked\": \"#00ff88\",   # 綠色（未恐慌判定）\n    \"shock_marker\": \"#ffff00\",  # 黃色（衝擊事件標記）\n}\n```\n\n### 輸出路徑\n\n- **預設路徑**: `{專案根目錄}/output/{rates-name}-move-panic-YYYY-MM-DD.png`\n- 範例：`output/jgb-10y-move-panic-2026-01-23.png`\n\n</rates_move_chart_reference>\n",
        "skills/analyze-move-risk-gauges-leadlag/references/data-sources.md": "# 數據來源 (Data Sources)\n\n本技能需要四條主要時間序列，使用 Chrome CDP 連接到 MacroMicro 抓取真實數據。\n\n## 數據需求概覽\n\n| 指標 | 來源 | 方式 | 頻率 |\n|------|------|------|------|\n| **MOVE** | MacroMicro | Chrome CDP 爬蟲 | 日 |\n| **JGB 10Y** | MacroMicro | Chrome CDP 爬蟲 | 日 |\n| **VIX** | Yahoo Finance | yfinance API | 日 |\n| **Credit (IG OAS)** | FRED | HTTP CSV | 日 |\n\n---\n\n## MOVE Index（利率波動率）\n\n### 主要來源：MacroMicro (CDP)\n\n**URL**: https://en.macromicro.me/charts/35584/us-treasury-move-index\n\n**技術細節**：\n- 使用 Chrome DevTools Protocol (CDP) 連接到已開啟的 Chrome\n- 透過 JavaScript 執行從 Highcharts 對象提取時間序列數據\n- 無需 API key，繞過 Cloudflare 防護\n\n**數據特性**：\n- 頻率：日\n- 延遲：T+1\n- 歷史深度：完整（視圖表顯示範圍）\n\n### 程式碼範例\n\n```python\nfrom fetch_data import fetch_macromicro_via_cdp\n\n# 確保 Chrome 已用 CDP 模式啟動並開啟 MOVE 頁面\nmove = fetch_macromicro_via_cdp(\"MOVE\", port=9222)\nprint(f\"MOVE: {len(move)} 筆, {move.index.min()} ~ {move.index.max()}\")\n```\n\n---\n\n## JGB 10Y（日本 10 年期國債殖利率）\n\n### 主要來源：MacroMicro (CDP)\n\n**URL**: https://en.macromicro.me/charts/944/jp-10-year-goverment-bond-yield\n\n**技術細節**：\n- 同 MOVE，使用 Chrome CDP 爬蟲\n- 數據單位：%（殖利率）\n\n**數據特性**：\n- 頻率：日\n- 延遲：T+1\n- 歷史深度：完整\n\n### 程式碼範例\n\n```python\nfrom fetch_data import fetch_macromicro_via_cdp\n\n# 確保 Chrome 已開啟 JGB 頁面\njgb = fetch_macromicro_via_cdp(\"JGB10Y\", port=9222)\nprint(f\"JGB10Y: {len(jgb)} 筆, {jgb.index.min()} ~ {jgb.index.max()}\")\n```\n\n---\n\n## VIX（股市波動率）\n\n### 主要來源：Yahoo Finance\n\n```python\nimport yfinance as yf\n\ndef fetch_vix(start_date: str, end_date: str) -> pd.Series:\n    \"\"\"從 Yahoo Finance 取得 VIX\"\"\"\n    data = yf.download(\"^VIX\", start=start_date, end=end_date, progress=False)\n    # Handle MultiIndex columns\n    if isinstance(data.columns, pd.MultiIndex):\n        return data[(\"Close\", \"^VIX\")]\n    return data[\"Close\"]\n```\n\n### 替代來源：FRED\n\n| 系列代碼 | 名稱 | 頻率 |\n|----------|------|------|\n| VIXCLS | CBOE Volatility Index: VIX | 日 |\n\n```\nhttps://fred.stlouisfed.org/graph/fredgraph.csv?id=VIXCLS&cosd=2020-01-01&coed=2026-01-01\n```\n\n---\n\n## CDX IG（信用利差/風險指標）\n\n### 公開替代：FRED IG OAS\n\nCDX IG 指數需要訂閱，公開替代使用 ICE BofA 投資級公司債利差：\n\n| 系列代碼 | 名稱 | 說明 |\n|----------|------|------|\n| BAMLC0A0CM | ICE BofA US Corporate Index OAS | 全投資級公司債利差 |\n| BAMLC0A4CBBB | ICE BofA BBB US Corporate Index OAS | BBB 級公司債利差 |\n| BAMLH0A0HYM2 | ICE BofA US High Yield Index OAS | 高收益債利差（更敏感） |\n\n```python\ndef fetch_ig_oas(start_date: str, end_date: str) -> pd.Series:\n    \"\"\"從 FRED 取得 IG 信用利差\"\"\"\n    url = \"https://fred.stlouisfed.org/graph/fredgraph.csv\"\n    params = {\n        \"id\": \"BAMLC0A0CM\",\n        \"cosd\": start_date,\n        \"coed\": end_date\n    }\n    response = requests.get(url, params=params)\n    df = pd.read_csv(io.StringIO(response.text))\n    df.columns = [\"DATE\", \"BAMLC0A0CM\"]\n    df[\"DATE\"] = pd.to_datetime(df[\"DATE\"])\n    df[\"BAMLC0A0CM\"] = pd.to_numeric(df[\"BAMLC0A0CM\"].replace(\".\", pd.NA), errors=\"coerce\")\n    df = df.dropna().set_index(\"DATE\")\n    return df[\"BAMLC0A0CM\"]\n```\n\n---\n\n## Chrome CDP 啟動方式\n\n### Windows\n\n```bash\n\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" ^\n  --remote-debugging-port=9222 ^\n  --remote-allow-origins=* ^\n  --user-data-dir=\"%USERPROFILE%\\.chrome-debug-profile\" ^\n  \"https://en.macromicro.me/charts/35584/us-treasury-move-index\"\n```\n\n### macOS\n\n```bash\n/Applications/Google\\ Chrome.app/Contents/MacOS/Google\\ Chrome \\\n  --remote-debugging-port=9222 \\\n  --remote-allow-origins=* \\\n  --user-data-dir=\"$HOME/.chrome-debug-profile\" \\\n  \"https://en.macromicro.me/charts/35584/us-treasury-move-index\"\n```\n\n### 需要開啟的頁面\n\n1. **MOVE Index**: https://en.macromicro.me/charts/35584/us-treasury-move-index\n2. **JGB 10Y**: https://en.macromicro.me/charts/944/jp-10-year-goverment-bond-yield\n\n### 驗證連線\n\n```bash\ncurl -s http://127.0.0.1:9222/json\n```\n\n成功回應範例：\n```json\n[{\n   \"title\": \"US Treasury MOVE Index\",\n   \"url\": \"https://en.macromicro.me/charts/35584/us-treasury-move-index\",\n   \"webSocketDebuggerUrl\": \"ws://127.0.0.1:9222/devtools/page/XXXXXX\"\n}]\n```\n\n---\n\n## 數據對齊 (Data Alignment)\n\n### 頻率處理\n\n所有數據統一對齊到**交易日（Business Day）**：\n\n```python\ndef align_to_business_days(df: pd.DataFrame) -> pd.DataFrame:\n    \"\"\"將數據對齊到交易日，缺值前向填充\"\"\"\n    df = df.sort_index()\n    df.index = pd.to_datetime(df.index)\n    df = df.ffill()\n    return df\n```\n\n### 時區\n\n- FRED 數據：美東時間 (America/New_York)\n- Yahoo 數據：美東時間\n- MacroMicro 數據：UTC\n- JGB 數據：日本時間 (Asia/Tokyo)\n- 統一轉換為 **UTC** 或 **America/New_York**\n\n### 發布延遲\n\n| 數據 | 典型延遲 | 說明 |\n|------|----------|------|\n| VIX | 即時 | 交易時間即時更新 |\n| MOVE | T+1 | MacroMicro 次日更新 |\n| IG OAS | T+1 | FRED 次日更新 |\n| JGB 10Y | T+1 | MacroMicro 次日更新 |\n\n**實務建議**：分析時使用 T-1 日數據，模擬真實可得資訊。\n\n---\n\n## 快取機制\n\n為避免重複請求，腳本內建 12 小時快取：\n\n```python\nCACHE_DIR = Path(__file__).parent.parent / \"cache\"\nCACHE_MAX_AGE = timedelta(hours=12)\n\ndef is_cache_valid(key: str) -> bool:\n    cache_file = CACHE_DIR / f\"{key}.json\"\n    if not cache_file.exists():\n        return False\n    mtime = datetime.fromtimestamp(cache_file.stat().st_mtime)\n    return (datetime.now() - mtime) < CACHE_MAX_AGE\n```\n\n使用 `--no-cache` 參數可強制重新抓取：\n\n```bash\npython fetch_data.py --start 2024-01-01 --end 2026-01-31 --no-cache\n```\n\n---\n\n## Fallback 策略\n\n| 主要來源 | Fallback |\n|----------|----------|\n| MOVE (MacroMicro CDP) | 利率實現波動率（DGS10 衍生） |\n| JGB (MacroMicro CDP) | FRED 月頻數據 / 日銀公開數據 |\n| VIX (Yahoo) | FRED VIXCLS |\n| IG OAS (FRED) | LQD 價格反向 |\n\n### 利率實現波動率代理（備選）\n\n若 MacroMicro 無法連接，可使用 10Y 國債殖利率的實現波動率作為 MOVE 代理：\n\n```python\ndef compute_rates_vol_proxy(dgs10: pd.Series, window: int = 21) -> pd.Series:\n    \"\"\"使用 10 年期國債殖利率的 21 日實現波動率作為 MOVE 代理\"\"\"\n    daily_change = dgs10.diff() * 100  # 殖利率變化（bps）\n    realized_vol = daily_change.rolling(window).std() * (252 ** 0.5)  # 年化\n    return realized_vol\n```\n\n**注意**：實現波動率是後視（backward-looking），而 MOVE 是前瞻（forward-looking，隱含波動率）。\n\n---\n\n## 完整數據抓取流程\n\n```bash\n# Step 1: 啟動 Chrome CDP\n\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" ^\n  --remote-debugging-port=9222 ^\n  --remote-allow-origins=* ^\n  --user-data-dir=\"%USERPROFILE%\\.chrome-debug-profile\" ^\n  \"https://en.macromicro.me/charts/35584/us-treasury-move-index\"\n\n# Step 2: 在 Chrome 中開啟 JGB 頁面\n# https://en.macromicro.me/charts/944/jp-10-year-goverment-bond-yield\n\n# Step 3: 等待圖表載入（約 30-40 秒）\n\n# Step 4: 執行抓取\npython fetch_data.py --start 2024-01-01 --end 2026-01-31 --output data.csv\n```\n",
        "skills/analyze-move-risk-gauges-leadlag/references/input-schema.md": "# 輸入參數定義 (Input Schema)\n\n本文檔定義 `analyze-move-risk-gauges-leadlag` 技能的完整輸入參數。\n\n---\n\n## 核心參數（必填）\n\n| 參數         | 類型   | 說明                      | 範例           |\n|--------------|--------|---------------------------|----------------|\n| `start_date` | string | 分析起始日期 (YYYY-MM-DD) | `\"2024-01-01\"` |\n| `end_date`   | string | 分析結束日期 (YYYY-MM-DD) | `\"2026-01-01\"` |\n\n---\n\n## 指標參數（選填）\n\n### 利率波動率指標\n\n| 參數               | 類型   | 預設值   | 說明               |\n|--------------------|--------|----------|--------------------|\n| `rates_vol_symbol` | string | `\"MOVE\"` | 利率波動率指標代碼 |\n\n**可用值**：\n- `\"MOVE\"`: ICE BofA MOVE Index（需爬蟲或代理）\n- `\"RATES_VOL_PROXY\"`: 使用 DGS10 計算的實現波動率代理\n\n### 股市波動率指標\n\n| 參數                | 類型   | 預設值  | 說明               |\n|---------------------|--------|---------|--------------------|\n| `equity_vol_symbol` | string | `\"VIX\"` | 股市波動率指標代碼 |\n\n**可用值**：\n- `\"VIX\"`: CBOE VIX Index（Yahoo: ^VIX）\n- `\"VIXCLS\"`: FRED VIX 系列\n\n### 信用利差/風險指標\n\n| 參數                   | 類型   | 預設值           | 說明                  |\n|------------------------|--------|------------------|-----------------------|\n| `credit_spread_symbol` | string | `\"CDX_IG_PROXY\"` | 信用利差/風險指標代碼 |\n\n**可用值**：\n- `\"CDX_IG_PROXY\"`: 使用 FRED IG OAS 作為 CDX IG 代理\n- `\"BAMLC0A0CM\"`: ICE BofA US Corporate Index OAS\n- `\"BAMLC0A4CBBB\"`: ICE BofA BBB US Corporate Index OAS\n- `\"BAMLH0A0HYM2\"`: ICE BofA US High Yield Index OAS\n\n### 日本國債殖利率\n\n| 參數               | 類型   | 預設值     | 說明                |\n|--------------------|--------|------------|---------------------|\n| `jgb_yield_symbol` | string | `\"JGB10Y\"` | 日本 10Y 殖利率代碼 |\n\n**可用值**：\n- `\"JGB10Y\"`: 日本 10 年期國債殖利率（需爬蟲）\n- `\"INTGSTJPM193N\"`: FRED 月頻 JGB 數據（不建議用於日頻分析）\n\n---\n\n## 分析參數（選填）\n\n### 頻率\n\n| 參數   | 類型   | 預設值 | 說明     |\n|--------|--------|--------|----------|\n| `freq` | string | `\"D\"`  | 資料頻率 |\n\n**可用值**：\n- `\"D\"`: 日頻（建議）\n- `\"W\"`: 週頻（每週五或最後交易日）\n\n### 平滑處理\n\n| 參數            | 類型 | 預設值 | 範圍 | 說明                             |\n|-----------------|------|--------|------|----------------------------------|\n| `smooth_window` | int  | `5`    | 0-20 | 平滑用移動平均窗（0 表示不平滑） |\n\n**建議**：\n- `5`: 一週平滑，適合中期分析\n- `10`: 兩週平滑，更平滑但可能損失訊號\n- `0`: 不平滑，保留所有噪音\n\n### Z 分數標準化\n\n| 參數            | 類型 | 預設值 | 範圍   | 說明                   |\n|-----------------|------|--------|--------|------------------------|\n| `zscore_window` | int  | `60`   | 20-252 | 標準化回看窗（交易日） |\n\n**建議**：\n- `60`: 約 3 個月，適合中期視角\n- `252`: 1 年，更穩定但反應較慢\n- `20`: 1 個月，對近期變化更敏感\n\n### 領先落後分析\n\n| 參數                | 類型 | 預設值 | 範圍 | 說明                 |\n|---------------------|------|--------|------|----------------------|\n| `lead_lag_max_days` | int  | `20`   | 5-60 | 交叉相關最大位移天數 |\n\n**建議**：\n- `20`: 約 1 個月，適合大多數分析\n- `10`: 短期視角\n- `40`: 長期視角（但樣本量減少）\n\n### 事件窗檢定\n\n| 參數                  | 類型  | 預設值 | 範圍 | 說明               |\n|-----------------------|-------|--------|------|--------------------|\n| `shock_window_days`   | int   | `5`    | 1-20 | 事件窗天數         |\n| `shock_threshold_bps` | float | `15`   | 5-50 | JGB 衝擊門檻 (bps) |\n\n**建議**：\n- `shock_window_days = 5`: 一週窗口，捕捉短期衝擊\n- `shock_threshold_bps = 15`: 15 bps 變動代表顯著的殖利率波動\n\n**歷史參考**（JGB 10Y 單日變動）：\n- 正常：1-5 bps\n- 偏大：5-15 bps\n- 顯著：15-30 bps\n- 極端：> 30 bps（如 2022 年 BOJ 政策轉向）\n\n### 輸出格式\n\n| 參數          | 類型   | 預設值       | 說明     |\n|---------------|--------|--------------|----------|\n| `output_mode` | string | `\"markdown\"` | 輸出格式 |\n\n**可用值**：\n- `\"markdown\"`: Markdown 格式，適合人類閱讀\n- `\"json\"`: JSON 格式，適合程式處理\n\n---\n\n## 參數組合範例\n\n### 快速檢查\n\n```json\n{\n  \"start_date\": \"2025-01-01\",\n  \"end_date\": \"2026-01-23\",\n  \"smooth_window\": 5,\n  \"output_mode\": \"markdown\"\n}\n```\n\n### 詳細分析\n\n```json\n{\n  \"start_date\": \"2024-01-01\",\n  \"end_date\": \"2026-01-23\",\n  \"rates_vol_symbol\": \"MOVE\",\n  \"equity_vol_symbol\": \"VIX\",\n  \"credit_spread_symbol\": \"CDX_IG_PROXY\",\n  \"jgb_yield_symbol\": \"JGB10Y\",\n  \"freq\": \"D\",\n  \"smooth_window\": 5,\n  \"zscore_window\": 60,\n  \"lead_lag_max_days\": 20,\n  \"shock_window_days\": 5,\n  \"shock_threshold_bps\": 15,\n  \"output_mode\": \"json\"\n}\n```\n\n### 長期視角\n\n```json\n{\n  \"start_date\": \"2020-01-01\",\n  \"end_date\": \"2026-01-23\",\n  \"zscore_window\": 252,\n  \"lead_lag_max_days\": 40,\n  \"shock_threshold_bps\": 20,\n  \"output_mode\": \"markdown\"\n}\n```\n\n### 使用代理數據\n\n```json\n{\n  \"start_date\": \"2024-01-01\",\n  \"end_date\": \"2026-01-23\",\n  \"rates_vol_symbol\": \"RATES_VOL_PROXY\",\n  \"credit_spread_symbol\": \"BAMLC0A4CBBB\",\n  \"output_mode\": \"json\"\n}\n```\n\n---\n\n## 參數驗證規則\n\n### 日期驗證\n\n```python\nfrom datetime import datetime\n\ndef validate_dates(start_date: str, end_date: str) -> bool:\n    start = datetime.strptime(start_date, \"%Y-%m-%d\")\n    end = datetime.strptime(end_date, \"%Y-%m-%d\")\n\n    # 結束日期必須晚於起始日期\n    if end <= start:\n        raise ValueError(\"end_date must be after start_date\")\n\n    # 分析區間至少 60 天（zscore_window 最小需求）\n    if (end - start).days < 60:\n        raise ValueError(\"Analysis period must be at least 60 days\")\n\n    return True\n```\n\n### 窗口參數驗證\n\n```python\ndef validate_windows(params: dict) -> bool:\n    smooth = params.get(\"smooth_window\", 5)\n    zscore = params.get(\"zscore_window\", 60)\n    leadlag = params.get(\"lead_lag_max_days\", 20)\n    shock = params.get(\"shock_window_days\", 5)\n\n    # 平滑窗口不能超過 Z 分數窗口的 1/3\n    if smooth > zscore / 3:\n        raise ValueError(\"smooth_window should be less than zscore_window / 3\")\n\n    # 領先落後窗口不能超過數據長度的 1/4\n    # （需在運行時根據實際數據長度檢查）\n\n    return True\n```\n\n---\n\n## 預設配置\n\n```python\nDEFAULT_CONFIG = {\n    \"rates_vol_symbol\": \"MOVE\",\n    \"equity_vol_symbol\": \"VIX\",\n    \"credit_spread_symbol\": \"CDX_IG_PROXY\",\n    \"jgb_yield_symbol\": \"JGB10Y\",\n    \"freq\": \"D\",\n    \"smooth_window\": 5,\n    \"zscore_window\": 60,\n    \"lead_lag_max_days\": 20,\n    \"shock_window_days\": 5,\n    \"shock_threshold_bps\": 15.0,\n    \"output_mode\": \"markdown\"\n}\n```\n",
        "skills/analyze-move-risk-gauges-leadlag/references/methodology.md": "本 skill 回答三個核心問題：\n\n| 問題                          | 方法                               | 輸出                     |\n|-------------------------------|------------------------------------|--------------------------|\n| MOVE 是否領先其他風險指標？   | 交叉相關 (Cross-Correlation)       | 最佳 lag 天數 + 相關係數 |\n| MOVE 對利率事件是否恐慌？     | 事件窗檢定 (Event Window)          | 平均反應 + Z 分數        |\n| MOVE 下行時其他指標是否同步？ | 方向一致性 (Directional Alignment) | 同向比例                 |\n\n---\n\n## 2. 數據預處理\n\n### 2.1 對齊到交易日\n\n所有時間序列對齊到 Business Day 索引，缺值使用前向填充（forward fill）：\n\n```python\ndf = df.sort_index().asfreq(\"B\").ffill()\n```\n\n**記錄缺值比例**：若缺值比例超過 5%，應在輸出中標註。\n\n### 2.2 平滑處理\n\n為降低短期噪音對 lead/lag 判斷的干擾，使用移動平均平滑：\n\n```python\nif smooth_window > 0:\n    df_smooth = df.rolling(smooth_window).mean()\nelse:\n    df_smooth = df.copy()\n```\n\n**建議設定**：`smooth_window = 5`（一週）\n\n### 2.3 Z 分數標準化\n\n將不同尺度的指標轉換為可比較的單位：\n\n$$z_t = \\frac{x_t - \\mu_{t,w}}{\\sigma_{t,w}}$$\n\n其中：\n- $x_t$：當期數值\n- $\\mu_{t,w}$：過去 $w$ 期的滾動平均\n- $\\sigma_{t,w}$：過去 $w$ 期的滾動標準差\n\n```python\ndef rolling_zscore(s: pd.Series, window: int) -> pd.Series:\n    mu = s.rolling(window).mean()\n    sd = s.rolling(window).std()\n    return (s - mu) / sd\n```\n\n**建議設定**：`zscore_window = 60`（約 3 個月）\n\n**解讀**：\n- Z > +2：極端高位（歷史 97.7% 分位以上）\n- Z ∈ [-1, +1]：正常區間\n- Z < -2：極端低位\n\n---\n\n## 3. Lead/Lag 分析：交叉相關\n\n### 3.1 原理\n\n交叉相關（Cross-Correlation）衡量兩序列在不同時間位移下的相關性：\n\n$$\\text{CrossCorr}(X, Y, k) = \\text{Corr}(X_{t+k}, Y_t)$$\n\n- **k > 0**：X 領先 Y（X 的變化先發生）\n- **k < 0**：X 落後 Y（Y 的變化先發生）\n- **k = 0**：同步\n\n### 3.2 實作\n\n```python\ndef crosscorr_leadlag(x: pd.Series, y: pd.Series, max_lag: int) -> tuple:\n    \"\"\"\n    計算 x 對 y 的交叉相關，找出最佳 lag\n\n    返回：(best_lag, best_corr)\n    - best_lag > 0：x 領先 y\n    - best_lag < 0：x 落後 y\n    \"\"\"\n    best_lag, best_corr = 0, -np.inf\n\n    for lag in range(-max_lag, max_lag + 1):\n        if lag > 0:\n            # x 領先：比較 x[:-lag] 與 y[lag:]\n            corr = x.shift(lag).corr(y)\n        else:\n            # x 落後：比較 x[-lag:] 與 y[:lag]\n            corr = x.shift(lag).corr(y)\n\n        if corr is not None and not np.isnan(corr) and corr > best_corr:\n            best_corr, best_lag = corr, lag\n\n    return best_lag, best_corr\n```\n\n### 3.3 解讀\n\n| 結果                                | 意義                                     |\n|-------------------------------------|------------------------------------------|\n| `MOVE_vs_VIX: lag=+6, corr=0.72`    | MOVE 變化領先 VIX 約 6 天，相關係數 0.72 |\n| `MOVE_vs_CREDIT: lag=+4, corr=0.61` | MOVE 變化領先信用利差約 4 天             |\n| `lag ≈ 0, corr > 0.8`               | 兩者同步移動                             |\n| `lag < 0`                           | MOVE 反而落後（需檢查數據品質）          |\n\n### 3.4 注意事項\n\n1. **相關不等於因果**：lead/lag 只表示統計上的時序關係\n2. **穩定性**：不同時期的 lead/lag 可能不同，建議計算滾動 lead/lag\n3. **顯著性**：可用 bootstrap 或 Fisher z-transform 檢定相關係數顯著性\n\n---\n\n## 4. 事件窗檢定：是否被嚇到\n\n### 4.1 原理\n\n檢驗「當利率事件發生時，MOVE 是否恐慌」：\n\n1. **定義事件**：JGB 殖利率在 $k$ 天內變動超過門檻\n2. **計算反應**：事件窗內 MOVE 的變化\n3. **比較歷史**：反應是否低於歷史分布中位數\n\n### 4.2 事件定義\n\n$$\\text{Shock}_t = \\mathbb{1}\\left[ |Y_t - Y_{t-k}| \\geq \\tau \\right]$$\n\n其中：\n- $Y_t$：JGB 10Y 殖利率\n- $k$：事件窗天數（預設 5）\n- $\\tau$：門檻（預設 15 bps）\n\n```python\ndef identify_shock_events(jgb: pd.Series, window: int, threshold_bps: float) -> pd.Series:\n    \"\"\"識別 JGB 衝擊事件\"\"\"\n    # 計算 k 日變化（bps）\n    change_bps = (jgb - jgb.shift(window)) * 100\n    # 標記衝擊\n    shock = change_bps.abs() >= threshold_bps\n    return shock\n```\n\n### 4.3 MOVE 反應計算\n\n$$\\text{MOVE\\_reaction}_t = \\text{MOVE}_t - \\text{MOVE}_{t-k}$$\n\n```python\ndef compute_move_reaction(move: pd.Series, shock: pd.Series, window: int) -> dict:\n    \"\"\"計算 MOVE 對衝擊事件的反應\"\"\"\n    move_change = move - move.shift(window)\n    reactions = move_change[shock].dropna()\n\n    return {\n        \"shock_count\": int(shock.sum()),\n        \"mean_reaction\": float(reactions.mean()) if len(reactions) else np.nan,\n        \"median_reaction\": float(reactions.median()) if len(reactions) else np.nan,\n        \"reactions\": reactions.tolist()\n    }\n```\n\n### 4.4 「不恐慌」判定\n\n| 條件                  | 判定                     |\n|-----------------------|--------------------------|\n| 平均反應 < 歷史中位數 | Not spooked              |\n| 平均反應 ≥ 歷史中位數 | Spooked                  |\n| 當前 MOVE Z 分數 < 0  | 目前偏低（利率市場平靜） |\n| 當前 MOVE Z 分數 > +1 | 目前偏高（利率市場緊張） |\n\n---\n\n## 5. 方向一致性\n\n### 5.1 原理\n\n檢驗「當 MOVE 下行時，其他風險指標是否也下行」：\n\n$$\\text{Alignment}_{X,Y} = \\frac{\\sum \\mathbb{1}[\\Delta X_t < 0 \\land \\Delta Y_t < 0]}{\\sum \\mathbb{1}[\\Delta X_t < 0]}$$\n\n### 5.2 實作\n\n```python\ndef compute_direction_alignment(df: pd.DataFrame) -> dict:\n    \"\"\"計算方向一致性\"\"\"\n    d = df.diff()\n\n    move_down = d[\"MOVE\"] < 0\n    vix_down = d[\"VIX\"] < 0\n    credit_down = d[\"CREDIT\"] < 0\n\n    align_vix = float((move_down & vix_down).sum() / move_down.sum())\n    align_credit = float((move_down & credit_down).sum() / move_down.sum())\n\n    return {\n        \"MOVE_down_and_VIX_down_ratio\": align_vix,\n        \"MOVE_down_and_CREDIT_down_ratio\": align_credit\n    }\n```\n\n### 5.3 解讀\n\n| 比例      | 意義                                      |\n|-----------|-------------------------------------------|\n| > 0.6     | 高度同向（符合「MOVE 帶動其他指標下行」） |\n| 0.4 - 0.6 | 中等同向                                  |\n| < 0.4     | 低同向（可能存在結構性差異）              |\n\n---\n\n## 6. 綜合判定邏輯\n\n### 6.1 結論生成\n\n```python\ndef generate_headline(leadlag: dict, spooked: dict, alignment: dict) -> str:\n    \"\"\"生成一句話結論\"\"\"\n    parts = []\n\n    # 恐慌檢定\n    if spooked[\"mean_reaction\"] < 1.0:\n        parts.append(\"MOVE not spooked by JGB yield moves\")\n    else:\n        parts.append(\"MOVE appears spooked by JGB yield moves\")\n\n    # 領先判定\n    move_vs_vix = leadlag[\"MOVE_vs_VIX\"][\"best_lag_days\"]\n    move_vs_credit = leadlag[\"MOVE_vs_CREDIT\"][\"best_lag_days\"]\n\n    if move_vs_vix > 0 and move_vs_credit > 0:\n        parts.append(\"and appears to lead VIX/Credit lower\")\n    elif move_vs_vix < 0 or move_vs_credit < 0:\n        parts.append(\"but may lag VIX/Credit\")\n    else:\n        parts.append(\"and moves in sync with VIX/Credit\")\n\n    return \" \".join(parts) + \".\"\n```\n\n### 6.2 信心水準\n\n| 信心   | 條件                                       |\n|--------|--------------------------------------------|\n| HIGH   | lead/lag 相關 > 0.7 且方向一致性 > 0.6     |\n| MEDIUM | lead/lag 相關 0.5-0.7 或方向一致性 0.4-0.6 |\n| LOW    | lead/lag 相關 < 0.5 或數據不足             |\n\n---\n\n## 7. 數學公式總結\n\n### Z 分數\n$$z_t = \\frac{x_t - \\bar{x}_{t-w:t}}{\\sigma_{t-w:t}}$$\n\n### 交叉相關\n$$\\rho_{XY}(k) = \\frac{\\text{Cov}(X_{t+k}, Y_t)}{\\sigma_X \\sigma_Y}$$\n\n### 事件窗反應\n$$R_t = \\text{MOVE}_t - \\text{MOVE}_{t-k} \\quad \\text{when} \\quad |\\Delta\\text{JGB}_{t-k:t}| \\geq \\tau$$\n\n### 方向一致性\n$$\\text{Align}_{XY} = P(\\Delta Y < 0 | \\Delta X < 0)$$\n\n---\n\n## 8. 參考文獻\n\n1. **Lead-Lag Analysis**: Hamilton, J.D. (1994). Time Series Analysis\n2. **Cross-Correlation**: Brockwell, P.J. & Davis, R.A. (2016). Introduction to Time Series and Forecasting\n3. **Event Studies**: MacKinlay, A.C. (1997). Event Studies in Economics and Finance\n\n---\n\n## 9. 程式碼：完整分析函數\n\n```python\nimport pandas as pd\nimport numpy as np\n\ndef analyze_rates_vol_leadlag(\n    df: pd.DataFrame,\n    smooth_window: int = 5,\n    zscore_window: int = 60,\n    lead_lag_max_days: int = 20,\n    shock_window_days: int = 5,\n    shock_threshold_bps: float = 15.0\n) -> dict:\n    \"\"\"\n    完整的利率波動率領先落後分析\n\n    Parameters:\n    -----------\n    df : DataFrame with columns [\"MOVE\", \"VIX\", \"CREDIT\", \"JGB10Y\"]\n\n    Returns:\n    --------\n    dict with leadlag, spooked_check, direction_alignment, headline\n    \"\"\"\n\n    # 1. 對齊\n    df = df.sort_index().asfreq(\"B\").ffill()\n\n    # 2. 平滑\n    if smooth_window > 0:\n        df_s = df.rolling(smooth_window).mean()\n    else:\n        df_s = df.copy()\n\n    # 3. Z 分數\n    z = df_s.apply(lambda c: rolling_zscore(c, zscore_window))\n\n    # 4. Lead/Lag\n    lag_vix, corr_vix = crosscorr_leadlag(df_s[\"MOVE\"], df_s[\"VIX\"], lead_lag_max_days)\n    lag_cr, corr_cr = crosscorr_leadlag(df_s[\"MOVE\"], df_s[\"CREDIT\"], lead_lag_max_days)\n\n    leadlag = {\n        \"MOVE_vs_VIX\": {\"best_lag_days\": int(lag_vix), \"corr\": round(corr_vix, 3)},\n        \"MOVE_vs_CREDIT\": {\"best_lag_days\": int(lag_cr), \"corr\": round(corr_cr, 3)}\n    }\n\n    # 5. 事件窗檢定\n    jgb_change_bps = (df_s[\"JGB10Y\"] - df_s[\"JGB10Y\"].shift(shock_window_days)) * 100\n    shock = jgb_change_bps.abs() >= shock_threshold_bps\n\n    move_react = df_s[\"MOVE\"] - df_s[\"MOVE\"].shift(shock_window_days)\n    reactions = move_react[shock].dropna()\n\n    spooked_check = {\n        \"shock_definition\": f\"abs(JGB10Y change over {shock_window_days}d) >= {shock_threshold_bps}bp\",\n        \"shock_count\": int(shock.sum()),\n        \"mean_MOVE_reaction_on_shocks\": round(float(reactions.mean()), 2) if len(reactions) else None,\n        \"MOVE_zscore_now\": round(float(z[\"MOVE\"].iloc[-1]), 2)\n    }\n\n    # 6. 方向一致性\n    d = df_s.diff()\n    move_down = d[\"MOVE\"] < 0\n\n    alignment = {\n        \"MOVE_down_and_VIX_down_ratio\": round(float((move_down & (d[\"VIX\"] < 0)).sum() / move_down.sum()), 2),\n        \"MOVE_down_and_CREDIT_down_ratio\": round(float((move_down & (d[\"CREDIT\"] < 0)).sum() / move_down.sum()), 2)\n    }\n\n    # 7. 生成結論\n    headline = generate_headline(leadlag, spooked_check, alignment)\n\n    return {\n        \"status\": \"ok\",\n        \"headline\": headline,\n        \"leadlag\": leadlag,\n        \"spooked_check\": spooked_check,\n        \"direction_alignment\": alignment\n    }\n```\n",
        "skills/analyze-move-risk-gauges-leadlag/templates/output-json.md": "# JSON 輸出模板 (Output JSON Template)\n\n本文檔定義 `analyze-move-risk-gauges-leadlag` 技能的 JSON 輸出結構。\n\n---\n\n## 完整輸出結構\n\n```json\n{\n  \"skill\": \"analyze-move-risk-gauges-leadlag\",\n  \"version\": \"0.1.0\",\n  \"as_of\": \"2026-01-23\",\n  \"params\": {\n    \"start_date\": \"2024-01-01\",\n    \"end_date\": \"2026-01-23\",\n    \"rates_vol_symbol\": \"MOVE\",\n    \"equity_vol_symbol\": \"VIX\",\n    \"credit_spread_symbol\": \"CDX_IG_PROXY\",\n    \"jgb_yield_symbol\": \"JGB10Y\",\n    \"freq\": \"D\",\n    \"smooth_window\": 5,\n    \"zscore_window\": 60,\n    \"lead_lag_max_days\": 20,\n    \"shock_window_days\": 5,\n    \"shock_threshold_bps\": 15\n  },\n  \"status\": \"ok\",\n  \"headline\": \"MOVE not spooked by JGB yield moves and appears to lead VIX/Credit lower.\",\n  \"confidence\": \"HIGH\",\n  \"leadlag\": {\n    \"MOVE_vs_VIX\": {\n      \"best_lag_days\": 6,\n      \"corr\": 0.72,\n      \"interpretation\": \"MOVE leads VIX by ~6 trading days\"\n    },\n    \"MOVE_vs_CREDIT\": {\n      \"best_lag_days\": 4,\n      \"corr\": 0.61,\n      \"interpretation\": \"MOVE leads Credit Spread by ~4 trading days\"\n    }\n  },\n  \"spooked_check\": {\n    \"shock_definition\": \"abs(JGB10Y change over 5d) >= 15bp\",\n    \"shock_count\": 3,\n    \"shock_dates\": [\"2024-03-15\", \"2024-07-22\", \"2025-01-10\"],\n    \"mean_MOVE_reaction_on_shocks\": 0.8,\n    \"median_MOVE_reaction_on_shocks\": 0.5,\n    \"historical_median_reaction\": 4.6,\n    \"MOVE_zscore_now\": -0.4,\n    \"spooked_verdict\": \"NOT_SPOOKED\"\n  },\n  \"direction_alignment\": {\n    \"MOVE_down_and_VIX_down_ratio\": 0.58,\n    \"MOVE_down_and_CREDIT_down_ratio\": 0.55,\n    \"interpretation\": \"When MOVE declines, VIX and Credit follow 55-58% of the time\"\n  },\n  \"data_quality\": {\n    \"total_observations\": 520,\n    \"missing_ratio\": {\n      \"MOVE\": 0.02,\n      \"VIX\": 0.0,\n      \"CREDIT\": 0.01,\n      \"JGB10Y\": 0.03\n    },\n    \"data_sources_used\": {\n      \"MOVE\": \"rates_vol_proxy\",\n      \"VIX\": \"yahoo_finance\",\n      \"CREDIT\": \"fred_bamlc0a0cm\",\n      \"JGB10Y\": \"investing_com\"\n    },\n    \"warnings\": []\n  },\n  \"artifacts\": {\n    \"chart_path\": \"output/leadlag_analysis_2026-01-23.png\",\n    \"data_cache_path\": \"cache/data.csv\"\n  },\n  \"reasons\": [\n    \"MOVE reaction to JGB shocks (mean +0.8) is below historical median (+4.6)\",\n    \"MOVE vs VIX cross-correlation peaks at lag +6 days with corr 0.72\",\n    \"MOVE vs Credit cross-correlation peaks at lag +4 days with corr 0.61\",\n    \"Direction alignment: 58% of MOVE declines are accompanied by VIX declines\"\n  ],\n  \"notes\": [\n    \"MOVE data is proxied using DGS10 realized volatility due to fetch failure\",\n    \"CDX IG is proxied by ICE BofA IG OAS (BAMLC0A0CM)\"\n  ]\n}\n```\n\n---\n\n## 欄位說明\n\n### 頂層欄位\n\n| 欄位         | 類型   | 說明                                  |\n|--------------|--------|---------------------------------------|\n| `skill`      | string | 技能名稱                              |\n| `version`    | string | 技能版本                              |\n| `as_of`      | string | 分析日期 (YYYY-MM-DD)                 |\n| `params`     | object | 使用的參數                            |\n| `status`     | string | 執行狀態 (`ok` / `error` / `warning`) |\n| `headline`   | string | 一句話結論                            |\n| `confidence` | string | 信心水準 (`HIGH` / `MEDIUM` / `LOW`)  |\n\n### leadlag 物件\n\n| 欄位             | 類型   | 說明                          |\n|------------------|--------|-------------------------------|\n| `best_lag_days`  | int    | 最大相關出現的 lag（正=領先） |\n| `corr`           | float  | 最大相關係數                  |\n| `interpretation` | string | 人類可讀的解讀                |\n\n### spooked_check 物件\n\n| 欄位                             | 類型   | 說明                                 |\n|----------------------------------|--------|--------------------------------------|\n| `shock_definition`               | string | 衝擊事件定義                         |\n| `shock_count`                    | int    | 識別到的衝擊事件數                   |\n| `shock_dates`                    | array  | 衝擊事件日期列表                     |\n| `mean_MOVE_reaction_on_shocks`   | float  | 衝擊時 MOVE 平均反應                 |\n| `median_MOVE_reaction_on_shocks` | float  | 衝擊時 MOVE 中位數反應               |\n| `historical_median_reaction`     | float  | 歷史中位數反應（用於比較）           |\n| `MOVE_zscore_now`                | float  | 當前 MOVE 的 Z 分數                  |\n| `spooked_verdict`                | string | 判定結果 (`SPOOKED` / `NOT_SPOOKED`) |\n\n### direction_alignment 物件\n\n| 欄位                              | 類型   | 說明                            |\n|-----------------------------------|--------|---------------------------------|\n| `MOVE_down_and_VIX_down_ratio`    | float  | MOVE 下行時 VIX 也下行的比例    |\n| `MOVE_down_and_CREDIT_down_ratio` | float  | MOVE 下行時 Credit 也下行的比例 |\n| `interpretation`                  | string | 人類可讀的解讀                  |\n\n### data_quality 物件\n\n| 欄位                 | 類型   | 說明               |\n|----------------------|--------|--------------------|\n| `total_observations` | int    | 總觀察數           |\n| `missing_ratio`      | object | 各序列缺值比例     |\n| `data_sources_used`  | object | 實際使用的數據來源 |\n| `warnings`           | array  | 數據品質警告       |\n\n### artifacts 物件\n\n| 欄位              | 類型   | 說明           |\n|-------------------|--------|----------------|\n| `chart_path`      | string | 生成圖表的路徑 |\n| `data_cache_path` | string | 數據快取路徑   |\n\n### reasons 陣列\n\n結論的支持證據列表，每項為一個字串。\n\n### notes 陣列\n\n分析過程中的註記（如使用代理數據）。\n\n---\n\n## 精簡輸出（Quick Mode）\n\n快速模式輸出較少欄位：\n\n```json\n{\n  \"status\": \"ok\",\n  \"headline\": \"MOVE not spooked by JGB yield moves and appears to lead VIX/Credit lower.\",\n  \"leadlag\": {\n    \"MOVE_vs_VIX\": {\"best_lag_days\": 6, \"corr\": 0.72},\n    \"MOVE_vs_CREDIT\": {\"best_lag_days\": 4, \"corr\": 0.61}\n  },\n  \"spooked_check\": {\n    \"shock_count\": 3,\n    \"mean_MOVE_reaction_on_shocks\": 0.8,\n    \"MOVE_zscore_now\": -0.4\n  },\n  \"direction_alignment\": {\n    \"MOVE_down_and_VIX_down_ratio\": 0.58,\n    \"MOVE_down_and_CREDIT_down_ratio\": 0.55\n  }\n}\n```\n\n---\n\n## 錯誤輸出\n\n當執行失敗時：\n\n```json\n{\n  \"skill\": \"analyze-move-risk-gauges-leadlag\",\n  \"as_of\": \"2026-01-23\",\n  \"status\": \"error\",\n  \"error\": {\n    \"code\": \"DATA_FETCH_FAILED\",\n    \"message\": \"Failed to fetch JGB10Y data from all sources\",\n    \"details\": {\n      \"primary_source\": \"investing.com - connection timeout\",\n      \"fallback_source\": \"FRED - series not available in requested frequency\"\n    }\n  },\n  \"partial_result\": {\n    \"leadlag\": {\n      \"MOVE_vs_VIX\": {\"best_lag_days\": 6, \"corr\": 0.72}\n    },\n    \"note\": \"JGB-related analysis skipped due to data unavailability\"\n  }\n}\n```\n\n---\n\n## 驗證範例\n\n```python\nimport json\nfrom jsonschema import validate\n\nschema = {\n    \"type\": \"object\",\n    \"required\": [\"status\", \"headline\", \"leadlag\", \"spooked_check\", \"direction_alignment\"],\n    \"properties\": {\n        \"status\": {\"type\": \"string\", \"enum\": [\"ok\", \"error\", \"warning\"]},\n        \"headline\": {\"type\": \"string\"},\n        \"confidence\": {\"type\": \"string\", \"enum\": [\"HIGH\", \"MEDIUM\", \"LOW\"]},\n        \"leadlag\": {\n            \"type\": \"object\",\n            \"properties\": {\n                \"MOVE_vs_VIX\": {\n                    \"type\": \"object\",\n                    \"properties\": {\n                        \"best_lag_days\": {\"type\": \"integer\"},\n                        \"corr\": {\"type\": \"number\", \"minimum\": -1, \"maximum\": 1}\n                    }\n                }\n            }\n        },\n        \"spooked_check\": {\n            \"type\": \"object\",\n            \"properties\": {\n                \"shock_count\": {\"type\": \"integer\", \"minimum\": 0},\n                \"mean_MOVE_reaction_on_shocks\": {\"type\": [\"number\", \"null\"]},\n                \"MOVE_zscore_now\": {\"type\": \"number\"}\n            }\n        }\n    }\n}\n\n# Validate output\nwith open(\"result.json\", \"r\") as f:\n    result = json.load(f)\n    validate(instance=result, schema=schema)\n```\n",
        "skills/analyze-move-risk-gauges-leadlag/templates/output-markdown.md": "# Markdown 輸出模板 (Output Markdown Template)\n\n本文檔定義 `analyze-move-risk-gauges-leadlag` 技能的 Markdown 報告模板。\n\n---\n\n## 完整報告模板\n\n```markdown\n# Rates Vol Lead/Lag Check (MOVE vs VIX vs Credit) — Summary\n\n**分析日期**: {as_of}\n**分析區間**: {start_date} 至 {end_date}\n**信心水準**: {confidence}\n\n---\n\n## 結論\n\n- 利率波動率（MOVE）對「JGB 殖利率衝擊」反應{spooked_verdict_zh} → **{spooked_verdict_en}**\n- MOVE 的變化在統計上對 VIX 與信用風險代理指標呈現 **{lead_verdict}** 的特徵 → **{lead_interpretation}**\n- 最近一段 MOVE 下行期間，VIX / 信用利差同步走低的比例為：VIX = {align_vix}%、Credit = {align_credit}%\n\n---\n\n## 證據（量化）\n\n### 領先落後分析\n\n| 指標對         | 最佳 Lag         | 相關係數      | 解讀            |\n|----------------|------------------|---------------|-----------------|\n| MOVE vs VIX    | +{lag_vix} 天    | {corr_vix}    | {interp_vix}    |\n| MOVE vs Credit | +{lag_credit} 天 | {corr_credit} | {interp_credit} |\n\n### 事件窗檢定\n\n| 項目             | 數值                                |\n|------------------|-------------------------------------|\n| 衝擊定義         | abs(JGB10Y 5日變動) ≥ {threshold}bp |\n| 衝擊事件數       | {shock_count} 次                    |\n| MOVE 平均反應    | {mean_reaction}                     |\n| 歷史中位數反應   | {historical_median}                 |\n| MOVE 當前 Z 分數 | {move_z_now}                        |\n| 判定             | {spooked_verdict}                   |\n\n### 方向一致性\n\n| MOVE 下行時... | 同向比例        |\n|----------------|-----------------|\n| VIX 也下行     | {align_vix}%    |\n| Credit 也下行  | {align_credit}% |\n\n---\n\n## 一句話摘要\n\n> {headline}\n\n---\n\n## 分析依據\n\n{reasons_list}\n\n---\n\n## 注意事項\n\n{notes_list}\n\n---\n\n## 數據品質\n\n| 指標   | 觀察數 | 缺值比例          | 數據來源        |\n|--------|--------|-------------------|-----------------|\n| MOVE   | {obs}  | {missing_move}%   | {source_move}   |\n| VIX    | {obs}  | {missing_vix}%    | {source_vix}    |\n| Credit | {obs}  | {missing_credit}% | {source_credit} |\n| JGB10Y | {obs}  | {missing_jgb}%    | {source_jgb}    |\n\n---\n\n## 圖表\n\n![Lead/Lag Analysis]({chart_path})\n\n---\n\n*Generated by analyze-move-risk-gauges-leadlag v{version}*\n```\n\n---\n\n## 精簡報告模板\n\n```markdown\n# MOVE Lead/Lag 快速檢查\n\n**日期**: {as_of}\n\n## 結論\n\n{headline}\n\n## 關鍵數據\n\n| 指標             | 數值                              |\n|------------------|-----------------------------------|\n| MOVE 領先 VIX    | {lag_vix} 天 (r={corr_vix})       |\n| MOVE 領先 Credit | {lag_credit} 天 (r={corr_credit}) |\n| JGB 衝擊事件     | {shock_count} 次                  |\n| MOVE 平均反應    | {mean_reaction}                   |\n| MOVE 當前 Z 分數 | {move_z_now}                      |\n\n## 判定\n\n- 恐慌程度: {spooked_verdict}\n- 領先關係: {lead_verdict}\n- 方向一致性: VIX {align_vix}% / Credit {align_credit}%\n```\n\n---\n\n## 欄位說明與填充規則\n\n### 恐慌判定\n\n```python\nif mean_reaction < 1.0:\n    spooked_verdict_zh = \"偏弱 / 未顯著升溫\"\n    spooked_verdict_en = \"not too spooked\"\nelse:\n    spooked_verdict_zh = \"明顯上升\"\n    spooked_verdict_en = \"spooked\"\n```\n\n### 領先判定\n\n```python\nif lag_vix > 0 and lag_credit > 0:\n    lead_verdict = f\"領先 {min(lag_vix, lag_credit)}-{max(lag_vix, lag_credit)} 天\"\n    lead_interpretation = \"可能具領先性\"\nelif lag_vix < 0 and lag_credit < 0:\n    lead_verdict = \"落後\"\n    lead_interpretation = \"反而落後於其他指標\"\nelse:\n    lead_verdict = \"無明確領先/落後\"\n    lead_interpretation = \"與其他指標同步\"\n```\n\n### 方向一致性解讀\n\n```python\nif align_vix > 0.6 and align_credit > 0.6:\n    align_interpretation = \"符合「MOVE 領先帶動其他風險指標走低」的敘事\"\nelif align_vix > 0.4 and align_credit > 0.4:\n    align_interpretation = \"中等程度符合敘事\"\nelse:\n    align_interpretation = \"敘事支持度較低\"\n```\n\n### 證據列表\n\n```python\nreasons_list = \"\\n\".join([f\"- {reason}\" for reason in reasons])\n```\n\n範例：\n```markdown\n- MOVE 對 JGB 衝擊的平均反應 (+0.8) 低於歷史中位數 (+4.6)\n- MOVE vs VIX 交叉相關峰值出現在 +6 天 (r=0.72)\n- MOVE vs Credit 交叉相關峰值出現在 +4 天 (r=0.61)\n- MOVE 下行時 VIX 同步下行比例達 58%\n```\n\n### 注意事項列表\n\n```python\nnotes_list = \"\\n\".join([f\"- {note}\" for note in notes])\n```\n\n範例：\n```markdown\n- MOVE 數據使用 DGS10 實現波動率代理（原始數據抓取失敗）\n- CDX IG 使用 ICE BofA IG OAS (BAMLC0A0CM) 作為代理\n```\n\n---\n\n## 範例輸出\n\n```markdown\n# Rates Vol Lead/Lag Check (MOVE vs VIX vs Credit) — Summary\n\n**分析日期**: 2026-01-23\n**分析區間**: 2024-01-01 至 2026-01-23\n**信心水準**: HIGH\n\n---\n\n## 結論\n\n- 利率波動率（MOVE）對「JGB 殖利率衝擊」反應偏弱 / 未顯著升溫 → **not too spooked**\n- MOVE 的變化在統計上對 VIX 與信用風險代理指標呈現 **領先 4-6 天** 的特徵 → **可能具領先性**\n- 最近一段 MOVE 下行期間，VIX / 信用利差同步走低的比例為：VIX = 58%、Credit = 55%\n\n---\n\n## 證據（量化）\n\n### 領先落後分析\n\n| 指標對         | 最佳 Lag | 相關係數 | 解讀                               |\n|----------------|----------|----------|------------------------------------|\n| MOVE vs VIX    | +6 天    | 0.72     | MOVE 變化領先 VIX 約 6 個交易日    |\n| MOVE vs Credit | +4 天    | 0.61     | MOVE 變化領先信用利差約 4 個交易日 |\n\n### 事件窗檢定\n\n| 項目             | 數值                       |\n|------------------|----------------------------|\n| 衝擊定義         | abs(JGB10Y 5日變動) ≥ 15bp |\n| 衝擊事件數       | 3 次                       |\n| MOVE 平均反應    | +0.8                       |\n| 歷史中位數反應   | +4.6                       |\n| MOVE 當前 Z 分數 | -0.4                       |\n| 判定             | NOT SPOOKED                |\n\n### 方向一致性\n\n| MOVE 下行時... | 同向比例 |\n|----------------|----------|\n| VIX 也下行     | 58%      |\n| Credit 也下行  | 55%      |\n\n---\n\n## 一句話摘要\n\n> MOVE not spooked by JGB yield moves and appears to lead VIX/Credit lower.\n\n---\n\n## 分析依據\n\n- MOVE 對 JGB 衝擊的平均反應 (+0.8) 低於歷史中位數 (+4.6)\n- MOVE vs VIX 交叉相關峰值出現在 +6 天 (r=0.72)\n- MOVE vs Credit 交叉相關峰值出現在 +4 天 (r=0.61)\n- MOVE 下行時 VIX 同步下行比例達 58%\n\n---\n\n## 注意事項\n\n- CDX IG 使用 ICE BofA IG OAS (BAMLC0A0CM) 作為代理\n\n---\n\n## 數據品質\n\n| 指標   | 觀察數 | 缺值比例 | 數據來源           |\n|--------|--------|----------|--------------------|\n| MOVE   | 520    | 2.0%     | MacroMicro 爬蟲    |\n| VIX    | 520    | 0.0%     | Yahoo Finance      |\n| Credit | 520    | 1.0%     | FRED BAMLC0A0CM    |\n| JGB10Y | 520    | 3.0%     | Investing.com 爬蟲 |\n\n---\n\n*Generated by analyze-move-risk-gauges-leadlag v0.1.0*\n```\n",
        "skills/analyze-move-risk-gauges-leadlag/workflows/analyze.md": "# Workflow: 完整領先落後分析\n\n<required_reading>\n**執行前請閱讀：**\n1. references/data-sources.md - 了解數據來源與 CDP 爬蟲設定\n2. references/methodology.md - 了解分析方法論\n3. references/input-schema.md - 了解可用參數\n</required_reading>\n\n<prerequisites>\n**重要：執行前必須完成以下步驟**\n\n## Chrome CDP 設定\n\nMOVE 和 JGB 數據需要透過 Chrome CDP 從 MacroMicro 抓取。\n\n### Step 1: 關閉所有 Chrome 視窗\n\n### Step 2: 用調試端口啟動 Chrome（Windows）\n\n```bash\n\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" ^\n  --remote-debugging-port=9222 ^\n  --remote-allow-origins=* ^\n  --user-data-dir=\"%USERPROFILE%\\.chrome-debug-profile\" ^\n  \"https://en.macromicro.me/charts/35584/us-treasury-move-index\"\n```\n\n### Step 3: 在瀏覽器中開啟第二個分頁\n\n開啟 JGB 頁面：\n```\nhttps://en.macromicro.me/charts/944/jp-10-year-goverment-bond-yield\n```\n\n### Step 4: 等待圖表載入\n\n兩個頁面的圖表都需要完全載入（約 30-40 秒）\n\n### Step 5: 驗證連線\n\n```bash\ncurl -s http://127.0.0.1:9222/json\n```\n\n應該看到兩個 MacroMicro 頁面。\n</prerequisites>\n\n<process>\n\n## Step 1: 確認參數\n\n確認使用者提供的參數，填充預設值：\n\n```python\nparams = {\n    \"start_date\": user_start_date,  # 必填\n    \"end_date\": user_end_date,      # 必填\n    \"rates_vol_symbol\": \"MOVE\",\n    \"equity_vol_symbol\": \"VIX\",\n    \"credit_spread_symbol\": \"CDX_IG_PROXY\",\n    \"jgb_yield_symbol\": \"JGB10Y\",\n    \"freq\": \"D\",\n    \"smooth_window\": 5,\n    \"zscore_window\": 60,\n    \"lead_lag_max_days\": 20,\n    \"shock_window_days\": 5,\n    \"shock_threshold_bps\": 15.0,\n    \"output_mode\": \"markdown\"\n}\n```\n\n## Step 2: 抓取數據\n\n執行 `scripts/analyze.py` 會自動抓取所需數據：\n\n```bash\ncd .claude/skills/analyze-move-risk-gauges-leadlag/scripts\npython analyze.py \\\n  --start {start_date} \\\n  --end {end_date} \\\n  --output-mode markdown\n```\n\n數據來源：\n- **MOVE**: MacroMicro (CDP) https://en.macromicro.me/charts/35584/us-treasury-move-index\n- **JGB10Y**: MacroMicro (CDP) https://en.macromicro.me/charts/944/jp-10-year-goverment-bond-yield\n- **VIX**: Yahoo Finance (`^VIX`)\n- **CREDIT**: FRED (`BAMLC0A0CM`)\n\n**注意**：\n- 確保 Chrome CDP 已啟動並載入 MOVE 和 JGB 頁面\n- 數據會自動快取 12 小時，使用 `--no-cache` 強制重新抓取\n\n## Step 3: 數據預處理\n\n腳本自動執行數據預處理：\n\n1. **對齊到交易日**：使用 Business Day 索引\n2. **缺值處理**：前向填充，記錄缺值比例\n3. **平滑處理**：`smooth_window` 日移動平均\n4. **Z 分數標準化**：`zscore_window` 日滾動標準化\n\n```python\n# 內部執行\ndf = load_data(\"cache/data.csv\")\ndf = df.sort_index().ffill()\n\n# 記錄數據品質\nmissing_ratio = df.isna().mean()\nif missing_ratio.max() > 0.05:\n    warnings.append(f\"High missing ratio: {missing_ratio.to_dict()}\")\n\n# 平滑與標準化\ndf_smooth = df.rolling(smooth_window).mean() if smooth_window > 0 else df\ndf_z = df_smooth.apply(lambda c: rolling_zscore(c, zscore_window))\n```\n\n## Step 4: Lead/Lag 分析\n\n計算 MOVE 對 VIX 和 Credit 的交叉相關：\n\n```python\nfrom scripts.analyze import crosscorr_leadlag\n\nlag_vix, corr_vix = crosscorr_leadlag(df_smooth[\"MOVE\"], df_smooth[\"VIX\"], lead_lag_max_days)\nlag_credit, corr_credit = crosscorr_leadlag(df_smooth[\"MOVE\"], df_smooth[\"CREDIT\"], lead_lag_max_days)\n\nleadlag = {\n    \"MOVE_vs_VIX\": {\"best_lag_days\": lag_vix, \"corr\": corr_vix},\n    \"MOVE_vs_CREDIT\": {\"best_lag_days\": lag_credit, \"corr\": corr_credit}\n}\n```\n\n**解讀**：\n- `best_lag_days > 0`：MOVE 領先\n- `corr > 0.7`：強相關，結果可信\n- `corr < 0.5`：弱相關，需謹慎解讀\n\n## Step 5: 事件窗檢定\n\n識別 JGB 衝擊事件，計算 MOVE 反應：\n\n```python\n# 識別衝擊事件\njgb_change = (df_smooth[\"JGB10Y\"] - df_smooth[\"JGB10Y\"].shift(shock_window_days)) * 100\nshock_events = jgb_change.abs() >= shock_threshold_bps\n\n# 計算 MOVE 反應\nmove_change = df_smooth[\"MOVE\"] - df_smooth[\"MOVE\"].shift(shock_window_days)\nreactions = move_change[shock_events].dropna()\n\nspooked_check = {\n    \"shock_definition\": f\"abs(JGB10Y change over {shock_window_days}d) >= {shock_threshold_bps}bp\",\n    \"shock_count\": shock_events.sum(),\n    \"mean_MOVE_reaction_on_shocks\": reactions.mean(),\n    \"MOVE_zscore_now\": df_z[\"MOVE\"].iloc[-1]\n}\n```\n\n**判定規則**：\n- `mean_reaction < 1.0`：Not spooked\n- `mean_reaction >= 1.0`：Spooked\n- `MOVE_zscore_now < 0`：目前 MOVE 偏低\n\n## Step 6: 方向一致性\n\n計算 MOVE 下行時其他指標的同向比例：\n\n```python\nd = df_smooth.diff()\nmove_down = d[\"MOVE\"] < 0\n\nalignment = {\n    \"MOVE_down_and_VIX_down_ratio\": (move_down & (d[\"VIX\"] < 0)).sum() / move_down.sum(),\n    \"MOVE_down_and_CREDIT_down_ratio\": (move_down & (d[\"CREDIT\"] < 0)).sum() / move_down.sum()\n}\n```\n\n**解讀**：\n- `> 0.6`：高度同向，支持「MOVE 領先帶動下行」的敘事\n- `0.4-0.6`：中等同向\n- `< 0.4`：低同向，敘事可能不成立\n\n## Step 7: 生成報告\n\n根據分析結果生成輸出：\n\n**Markdown 格式**（見 `templates/output-markdown.md`）：\n```markdown\n# Rates Vol Lead/Lag Check (MOVE vs VIX vs Credit) — Summary\n\n## 結論\n- [恐慌判定結果]\n- [領先落後判定結果]\n- [方向一致性判定結果]\n\n## 證據（量化）\n| 指標           | 領先天數      | 相關係數      |\n|----------------|---------------|---------------|\n| MOVE vs VIX    | +{lag_vix}    | {corr_vix}    |\n| MOVE vs Credit | +{lag_credit} | {corr_credit} |\n```\n\n**JSON 格式**（見 `templates/output-json.md`）：\n```json\n{\n  \"status\": \"ok\",\n  \"headline\": \"...\",\n  \"leadlag\": {...},\n  \"spooked_check\": {...},\n  \"direction_alignment\": {...}\n}\n```\n\n## Step 8: 輸出結果\n\n根據 `output_mode` 輸出結果：\n\n```bash\n# Markdown（預設）\npython scripts/analyze.py --start 2024-01-01 --end 2026-01-01 --output-mode markdown\n\n# JSON\npython scripts/analyze.py --start 2024-01-01 --end 2026-01-01 --output-mode json --output result.json\n\n# 快速檢查（最近 6 個月）\npython scripts/analyze.py --quick\n```\n\n</process>\n\n<error_handling>\n\n## 常見錯誤處理\n\n### Chrome CDP 連接失敗\n\n```\nError: Chrome CDP not available\n```\n\n**解決方案**：\n1. 確認已關閉所有 Chrome 視窗\n2. 用調試端口重新啟動 Chrome\n3. 確認兩個 MacroMicro 頁面都已開啟\n4. 等待圖表完全載入後再執行\n\n### 找不到 MOVE 或 JGB 頁面\n\n```\nError: 無法找到 MOVE 頁面\n```\n\n**解決方案**：\n1. 確認 Chrome 中已開啟正確的 URL\n2. 等待圖表完全載入（約 30-40 秒）\n3. 使用 `curl -s http://127.0.0.1:9222/json` 確認頁面已載入\n\n### Highcharts not found\n\n```\nError: 提取失敗: Highcharts not found\n```\n\n**解決方案**：\n1. 圖表尚未完全載入，請再等待 10-20 秒\n2. 嘗試捲動頁面觸發載入\n3. 重新整理頁面後再試\n\n### 數據不足\n\n```python\nif len(df) < zscore_window + lead_lag_max_days:\n    raise ValueError(f\"Insufficient data: need {zscore_window + lead_lag_max_days} days, got {len(df)}\")\n```\n\n### 無衝擊事件\n\n```python\nif shock_events.sum() == 0:\n    spooked_check = {\n        \"shock_count\": 0,\n        \"mean_MOVE_reaction_on_shocks\": None,\n        \"note\": f\"No shock events (|ΔJGB| >= {shock_threshold_bps}bp) in period\"\n    }\n```\n\n</error_handling>\n\n<success_criteria>\n完成此 workflow 時：\n\n- [ ] Chrome CDP 已連接並載入 MOVE 和 JGB 頁面\n- [ ] 成功抓取所有數據（MOVE, VIX, CREDIT, JGB10Y）\n- [ ] 記錄缺值比例（若 > 5% 需警告）\n- [ ] 計算 MOVE vs VIX / Credit 的 lead/lag\n- [ ] 識別 JGB 衝擊事件並計算 MOVE 反應\n- [ ] 計算方向一致性比例\n- [ ] 生成一句話結論\n- [ ] 輸出完整報告（Markdown 或 JSON）\n</success_criteria>\n",
        "skills/analyze-move-risk-gauges-leadlag/workflows/visualize.md": "# Workflow: Bloomberg 風格視覺化圖表\n\n<required_reading>\n**執行前請閱讀：**\n1. references/methodology.md - 了解各圖表的含義\n2. thoughts/shared/guide/bloomberg-style-chart-guide.md - Bloomberg 風格規範\n</required_reading>\n\n<process>\n\n## Step 1: 執行視覺化\n\n### 方式一：分析時同時生成圖表（推薦）\n\n```bash\ncd .claude/skills/analyze-move-risk-gauges-leadlag/scripts\npython analyze.py --start 2024-01-01 --end 2026-01-31 --output-mode markdown --chart\n```\n\n### 方式二：單獨生成圖表\n\n```bash\n# 使用快取數據（若有）\npython visualize.py --start 2024-01-01 --end 2026-01-31\n\n# 指定輸出路徑\npython visualize.py --start 2024-01-01 --end 2026-01-31 -o output/custom-chart.png\n\n# 高解析度輸出\npython visualize.py --start 2024-01-01 --end 2026-01-31 --dpi 300\n```\n\n圖表預設輸出路徑：`output/move-leadlag-YYYY-MM-DD.png`\n\n## Step 2: 圖表說明\n\n### 2x3 多面板結構\n\n```\n┌──────────────────────┬─────────────────────────────────────────────┐\n│ 左上 (1,1): 交叉相關  │ 右上 (1,2)+(1,3): 波動率指標時間序列         │\n│   • MOVE vs VIX 曲線  │   • MOVE Index（左軸，橙紅）                 │\n│   • MOVE vs Credit   │   • VIX（右軸，橙黃）                        │\n│   • 最佳 lag 標記     │   • JGB 衝擊事件（紅色虛線）                 │\n│                      │   • 最新 MOVE 數值標註                       │\n├──────────────────────┼─────────────────────────────────────────────┤\n│ 左下 (2,1): 事件反應  │ 右下 (2,2)+(2,3): 標準化序列（Z 分數）       │\n│   • 直方圖（橙紅）    │   • MOVE Z（橙紅）                          │\n│   • 平均反應線       │   • VIX Z（橙黃）                           │\n│   • 恐慌判定框       │   • Credit Z（黃色）                        │\n│                      │   • 當前 MOVE Z 標記點                       │\n└──────────────────────┴─────────────────────────────────────────────┘\n```\n\n### Bloomberg 配色方案\n\n| 元素           | 顏色代碼   | 說明                 |\n|----------------|------------|----------------------|\n| 背景           | `#1a1a2e`  | 深藍黑色             |\n| MOVE           | `#ff6b35`  | 橙紅色（主要指標）   |\n| VIX            | `#ffaa00`  | 橙黃色（次要指標）   |\n| Credit         | `#ffff00`  | 黃色（第三指標）     |\n| JGB/未恐慌     | `#00ff88`  | 綠色                 |\n| 衝擊/恐慌      | `#ff4444`  | 紅色                 |\n| 網格線         | `#2d2d44`  | 暗灰紫               |\n| 文字           | `#ffffff`  | 白色                 |\n\n### Panel 1: 交叉相關分析（左上）\n\n- **X 軸**: Lag（天數），正值 = MOVE 領先\n- **Y 軸**: 相關係數\n- **曲線**: MOVE vs VIX（橙黃）、MOVE vs Credit（綠色）\n- **最佳點**: 最大相關係數位置以圓點標記，並標註 lag 與 r 值\n\n### Panel 2: 事件反應分布（左下）\n\n- **直方圖**: JGB 衝擊發生時 MOVE 的變化分布（橙紅）\n- **平均線**: 橙黃色虛線標示平均反應\n- **判定框**: 右上角顯示「判定: 恐慌」或「判定: 未恐慌」\n\n### Panel 3: 波動率時間序列（右上，跨兩格）\n\n- **左軸**: MOVE Index（橙紅線，線寬 2）\n- **右軸**: VIX（橙黃線，透明度 0.8）\n- **衝擊事件**: JGB 殖利率變動 ≥ 15bp 時標記紅色虛線\n- **最新值標註**: 圖表右端顯示當前 MOVE 數值\n\n### Panel 4: Z 分數標準化序列（右下，跨兩格）\n\n- **三條曲線**: MOVE Z、VIX Z、Credit Z（同一尺度）\n- **參考線**: Z = 0（實線）、Z = ±1（灰虛線）、Z = ±2（紅虛線）\n- **當前標記**: 最新 MOVE Z 分數以圓點標記\n\n### 頁尾資訊\n\n- **中央偏左**: 一句話結論（headline）\n- **右下**: 截止日期\n\n## Step 3: 輸出選項\n\n### CLI 參數\n\n```bash\nusage: visualize.py [-h] [-i INPUT] [-o OUTPUT] [--start START] [--end END] [--dpi DPI]\n\noptions:\n  -i, --input   輸入 JSON 結果檔案（可選，會自動執行分析）\n  -o, --output  輸出圖片路徑（預設: output/move-leadlag-YYYY-MM-DD.png）\n  --start       起始日期 (YYYY-MM-DD)\n  --end         結束日期 (YYYY-MM-DD)\n  --dpi         解析度（預設: 150，印刷用: 300）\n```\n\n### 輸出範例\n\n```bash\n# 標準輸出\npython visualize.py --start 2024-01-01 --end 2026-01-31\n# → output/move-leadlag-2026-01-23.png (16x12 in, 150 DPI)\n\n# 高解析度印刷\npython visualize.py --start 2024-01-01 --end 2026-01-31 --dpi 300\n# → output/move-leadlag-2026-01-23.png (16x12 in, 300 DPI)\n\n# 自定義路徑\npython visualize.py --start 2024-01-01 --end 2026-01-31 -o reports/2026Q1.png\n```\n\n</process>\n\n<success_criteria>\n完成此 workflow 時：\n\n- [ ] 生成 Bloomberg 風格 2x3 佈局圖表\n- [ ] 左上 (1,1): 交叉相關分析與最佳 lag 標註\n- [ ] 左下 (2,1): 事件反應分布與恐慌判定\n- [ ] 右上 (跨2格): MOVE/VIX 時間序列與衝擊事件標記\n- [ ] 右下 (跨2格): Z 分數與當前 MOVE 標記\n- [ ] 圖表包含截止日期、結論\n- [ ] 圖表已保存到指定路徑\n</success_criteria>\n",
        "skills/analyze-platinum-to-brazil-equities-transmission/SKILL.md": "---\nname: analyze-platinum-to-brazil-equities-transmission\ndescription: 使用公開市場資料量化驗證鉑/白金對巴西股市（EWZ）的長週期傳導/連動關係，輸出雙軸圖、領先落後分析、關聯強度分數與監控訊號。\n---\n\n<essential_principles>\n\n<principle name=\"transmission_verification\">\n**傳導驗證而非預測**\n\n本技能專注於「用數據驗證敘事」：\n- 輸入：社群/新聞宣稱「白金走勢可能領先或驅動巴西股市」\n- 輸出：長週期時間序列上的傳導假說檢驗結果\n\n不做價格預測，只回答：「白金→巴西股市的傳導結構在數據上是否存在？」\n</principle>\n\n<principle name=\"lead_lag_cross_correlation\">\n**交叉相關判斷領先落後**\n\n使用 Cross-Correlation 掃描 [-lead_lag_max, +lead_lag_max] 範圍：\n- `corr(r_ewz, r_platinum.shift(lag))`\n- **lag > 0**：白金領先 EWZ（platinum leads）\n- **lag < 0**：EWZ 領先白金\n- **lag ≈ 0**：同步移動\n\n典型設定：週頻 lag max = 52（一年），找 |corr| 最大的 lag。\n</principle>\n\n<principle name=\"regime_awareness\">\n**Regime-Dependent 關聯**\n\n白金與巴西股市的關聯具有週期性特徵：\n- **linked_upcycle**：兩者趨勢同向上行，傳導結構穩固\n- **decoupled**：關聯斷裂，各走各的\n- **brazil_idiosyncratic**：巴西特有風險（政治/匯率/商品結構）主導\n\n長期 regime 判斷使用 regime_window（預設 104 週 ≈ 2 年）內的趨勢一致性。\n</principle>\n\n<principle name=\"transmission_strength_score\">\n**傳導強度分數（0–100）**\n\n綜合三個維度量化傳導可信度：\n\n| 維度                   | 權重 | 說明                            |\n|------------------------|------|---------------------------------|\n| best_lead_lag_corr     | 30%  | 最佳領先落後相關係數            |\n| rolling_corr_stability | 30%  | rolling corr > 0 的佔比與連續性 |\n| trend_agreement        | 40%  | 長期趨勢一致程度                |\n\n分數解讀：≥70 強傳導、50-69 中等、<50 弱/不穩定。\n</principle>\n\n<principle name=\"data_source\">\n**資料來源**\n\n主要使用 Yahoo Finance（免費、無需 API key）：\n- **白金期貨**：`PL=F`\n- **巴西股市 ETF**：`EWZ`\n\n頻率建議：1wk（週頻）用於長週期分析，避免日頻噪音干擾。\n對齊方式：inner join（只保留共同交易日），避免補值造成假相關。\n</principle>\n\n</essential_principles>\n\n<objective>\n量化驗證「白金（Platinum）→ 巴西股市（EWZ）」的長週期傳導關係：\n\n1. **數據取得**：從 Yahoo Finance 取得白金期貨與 EWZ 歷史價格\n2. **雙軸圖與正規化圖**：Bloomberg 風格原值雙軸圖 + 正規化同軸對比\n3. **領先落後分析**：交叉相關找出白金是否領先 EWZ 及滯後期數\n4. **Rolling Correlation**：滾動相關觀察關聯的時變結構\n5. **Regime 判斷**：長期趨勢一致性判斷當前處於哪種傳導體制\n6. **傳導強度分數**：綜合評分（0-100）量化傳導可信度\n\n輸出：傳導強度分數、領先落後判定、regime label、監控清單、Bloomberg 風格圖表。\n</objective>\n\n<quick_start>\n\n**Step 1：安裝依賴**\n```bash\npip install yfinance pandas numpy matplotlib scipy\n```\n\n**Step 2：執行完整分析**\n```bash\ncd scripts\npython analyze.py --start 2003-01-01\n```\n\n**Step 3：生成 Bloomberg 風格視覺化圖表**\n```bash\npython visualize.py --start 2003-01-01\n# 輸出到: output/platinum_vs_ewz_YYYY-MM-DD.png\n```\n\n**輸出範例**：\n```json\n{\n  \"signal\": \"transmission_moderate\",\n  \"confidence\": \"medium\",\n  \"transmission_strength_score\": 74,\n  \"best_lead_lag\": {\n    \"lag_weeks\": 12,\n    \"meaning\": \"Platinum leads EWZ by ~12 weeks\",\n    \"corr\": 0.52\n  },\n  \"rolling_corr\": {\n    \"window\": 52,\n    \"latest\": 0.41,\n    \"positive_share_5y\": 0.68\n  },\n  \"regime_label\": \"linked_upcycle\",\n  \"monitoring_notes\": [\n    \"若 PL=F 突破長期區間，觀察 EWZ 在 8-16 週內是否趨勢翻多\",\n    \"要求 52 週 rolling corr 維持正值至少 26 週作為確認\",\n    \"若白金大漲而 EWZ 不動且 corr 轉負，視為 regime break\"\n  ]\n}\n```\n\n</quick_start>\n\n<intake>\n需要進行什麼分析？\n\n1. **快速檢查** - 查看白金與巴西股市目前的傳導狀態\n2. **完整分析** - 執行完整傳導檢驗並生成報告\n3. **視覺化圖表** - 生成 Bloomberg 風格雙軸圖與相關分析圖表\n4. **方法論學習** - 了解傳導分析、交叉相關與 regime 判斷的原理\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                     | Action                                       |\n|------------------------------|----------------------------------------------|\n| 1, \"快速\", \"quick\", \"check\"  | 閱讀 `workflows/analyze.md` 並以預設參數執行 |\n| 2, \"完整\", \"full\", \"analyze\" | 閱讀 `workflows/analyze.md` 並執行           |\n| 3, \"視覺化\", \"chart\", \"plot\" | 閱讀 `workflows/visualize.md` 並執行         |\n| 4, \"學習\", \"方法論\", \"why\"   | 閱讀 `references/methodology.md`             |\n| 提供參數 (如日期/ticker)     | 閱讀 `workflows/analyze.md` 並使用參數執行   |\n\n**路由後，閱讀對應文件並執行。**\n</routing>\n\n<directory_structure>\n```\nanalyze-platinum-to-brazil-equities-transmission/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元資料\n├── workflows/\n│   ├── analyze.md                     # 完整傳導分析工作流\n│   └── visualize.md                   # 視覺化工作流\n├── references/\n│   ├── data-sources.md                # 資料來源與替代方案\n│   ├── methodology.md                 # 傳導分析方法論\n│   └── input-schema.md                # 完整輸入參數定義\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n├── scripts/\n│   ├── analyze.py                     # 主分析腳本\n│   ├── fetch_data.py                  # 數據抓取工具（Yahoo Finance）\n│   └── visualize.py                   # Bloomberg 風格視覺化\n└── examples/\n    └── sample_output.json             # 範例輸出\n```\n</directory_structure>\n\n<reference_index>\n\n**方法論**: references/methodology.md\n- 交叉相關領先落後分析\n- Rolling Correlation 時變結構\n- Regime 判斷邏輯\n- 傳導強度分數計算\n\n**資料來源**: references/data-sources.md\n- Yahoo Finance（PL=F, EWZ）\n- 頻率處理與對齊\n- 備援數據源\n\n**輸入參數**: references/input-schema.md\n- 完整參數定義與預設值\n- start_date, frequency, corr_window, lead_lag_max 等\n\n</reference_index>\n\n<workflows_index>\n| Workflow     | Purpose        | 使用時機                  |\n|--------------|----------------|---------------------------|\n| analyze.md   | 完整傳導分析   | 需要驗證傳導敘事時        |\n| visualize.md | 生成視覺化圖表 | 需要 Bloomberg 風格圖表時 |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構定義 |\n| output-markdown.md | Markdown 報告模板 |\n</templates_index>\n\n<scripts_index>\n| Script        | Command                                  | Purpose              |\n|---------------|------------------------------------------|----------------------|\n| analyze.py    | `--start DATE [--end DATE] [--freq 1wk]` | 完整傳導分析         |\n| fetch_data.py | `--start DATE [--end DATE] [--freq 1wk]` | 數據抓取與快取       |\n| visualize.py  | `--start DATE [--end DATE]`              | Bloomberg 風格視覺化 |\n</scripts_index>\n\n<input_schema>\n\n<parameter name=\"start_date\" required=\"true\">\n**Type**: string (ISO YYYY-MM-DD)\n**Description**: 分析起始日期\n**Example**: \"2003-01-01\"\n**Note**: EWZ 上市於 2000 年 7 月，建議不早於 2000-07-01\n</parameter>\n\n<parameter name=\"end_date\" required=\"false\">\n**Type**: string (ISO YYYY-MM-DD)\n**Description**: 分析結束日期（預設今日）\n**Example**: \"2026-01-28\"\n</parameter>\n\n<parameter name=\"frequency\" required=\"false\">\n**Type**: string\n**Default**: \"1wk\"\n**Options**: \"1d\" / \"1wk\" / \"1mo\"\n**Description**: 資料頻率。建議 1wk 或 1mo 用於長週期分析\n</parameter>\n\n<parameter name=\"platinum_ticker\" required=\"false\">\n**Type**: string\n**Default**: \"PL=F\"\n**Description**: 白金價格 ticker\n</parameter>\n\n<parameter name=\"brazil_ticker\" required=\"false\">\n**Type**: string\n**Default**: \"EWZ\"\n**Description**: 巴西股市 proxy ticker\n</parameter>\n\n<parameter name=\"normalize_base\" required=\"false\">\n**Type**: number\n**Default**: 100\n**Description**: 正規化基準\n</parameter>\n\n<parameter name=\"corr_window\" required=\"false\">\n**Type**: int\n**Default**: 52\n**Description**: Rolling correlation 視窗（以 frequency 單位）\n</parameter>\n\n<parameter name=\"lead_lag_max\" required=\"false\">\n**Type**: int\n**Default**: 52\n**Description**: 領先/落後最大掃描期數\n</parameter>\n\n<parameter name=\"regime_window\" required=\"false\">\n**Type**: int\n**Default**: 104\n**Description**: 長期 regime 判斷窗口\n</parameter>\n\n<parameter name=\"output_mode\" required=\"false\">\n**Type**: string\n**Default**: \"both\"\n**Options**: \"markdown\" / \"json\" / \"both\"\n</parameter>\n\n</input_schema>\n\n<output_schema>\n參見 `templates/output-json.md` 的完整結構定義。\n\n**摘要**：\n```json\n{\n  \"signal\": \"transmission_strong | transmission_moderate | transmission_weak | inconclusive\",\n  \"confidence\": \"high | medium | low\",\n  \"transmission_strength_score\": 74,\n  \"best_lead_lag\": {\n    \"lag_weeks\": 12,\n    \"corr\": 0.52,\n    \"meaning\": \"Platinum leads EWZ by ~12 weeks\"\n  },\n  \"rolling_corr\": {\n    \"window\": 52,\n    \"latest\": 0.41,\n    \"positive_share_5y\": 0.68\n  },\n  \"regime_label\": \"linked_upcycle | decoupled | brazil_idiosyncratic\",\n  \"monitoring_notes\": [\"...\"],\n  \"artifacts\": {\n    \"charts\": [\"output/platinum_vs_ewz_YYYY-MM-DD.png\"]\n  }\n}\n```\n</output_schema>\n\n<success_criteria>\n分析成功時應產出：\n\n- [ ] 白金與 EWZ 的領先落後天（週）數與相關係數\n- [ ] 52 週 Rolling Correlation 最新值與正值佔比\n- [ ] 傳導強度分數（0-100）\n- [ ] 當前 Regime Label（linked_upcycle / decoupled / brazil_idiosyncratic）\n- [ ] 傳導結論與替代解釋\n- [ ] 監控清單（非短線）\n- [ ] **Bloomberg 風格雙軸圖**（output/platinum_vs_ewz_YYYY-MM-DD.png）\n- [ ] 明確標註資料限制與假設\n</success_criteria>\n",
        "skills/analyze-platinum-to-brazil-equities-transmission/references/data-sources.md": "# 資料來源\n\n---\n\n## 主要來源：Yahoo Finance\n\n**存取方式**：`yfinance` Python 套件（免費、無需 API key、無速率限制）\n\n### Ticker 對應\n\n| 資產 | Ticker | 名稱 | 單位 | 上市日期 |\n|------|--------|------|------|----------|\n| 白金期貨 | `PL=F` | Platinum Futures | USD/oz | 長期可用 |\n| 巴西股市 ETF | `EWZ` | iShares MSCI Brazil ETF | USD | 2000-07-10 |\n\n### 欄位選擇\n\n| Ticker | 欄位 | 原因 |\n|--------|------|------|\n| EWZ | `Adj Close` | ETF 需反映股息再投資與分割調整 |\n| PL=F | `Close`（或 `Adj Close`） | 期貨無股息，兩者等價 |\n\n### 頻率\n\n| 參數值 | yfinance 等效 | 說明 |\n|--------|---------------|------|\n| `1d` | `1d` | 日頻（每個交易日） |\n| `1wk` | `1wk` | 週頻（每週五收盤） |\n| `1mo` | `1mo` | 月頻（每月最後交易日） |\n\n### 數據品質注意事項\n\n1. **EWZ 早期流動性較低**：2000-2002 年成交量偏低，價格可能不穩定\n2. **PL=F 合約展延**：期貨在展延日可能出現價格跳動\n3. **假日差異**：白金（NYMEX）與 EWZ（NYSE）交易日不完全重疊\n\n---\n\n## 備援來源\n\n### Trading Economics（白金現貨）\n\n| 項目 | 說明 |\n|------|------|\n| URL | `https://tradingeconomics.com/commodity/platinum` |\n| 存取方式 | Chrome CDP 爬取 Highcharts 數據 |\n| 頻率 | 日頻（1Y）/ 週頻（5Y） |\n| 限制 | 免費版最多 5 年歷史 |\n\n適用場景：需要現貨價格而非期貨價格時。\n\n### FRED（間接指標）\n\nFRED 沒有直接的白金或 EWZ 數據，但可取得相關宏觀指標：\n\n| 系列代碼 | 名稱 | 用途 |\n|----------|------|------|\n| DEXBZUS | Brazil / U.S. Foreign Exchange Rate | 巴西匯率（BRL/USD） |\n| DTWEXBGS | Trade Weighted U.S. Dollar Index | 美元指數（做 DXY 調整用） |\n\n---\n\n## 快取策略\n\n| 層級 | 格式 | 有效期 | 用途 |\n|------|------|--------|------|\n| 原始快取 | JSON | 12 小時 | 保留原始下載數據 |\n| 整理快取 | CSV | 12 小時 | `date,platinum,ewz` 三欄 |\n\n### 快取路徑\n\n```\ndata/cache/\n├── platinum_ewz_raw.json    # 原始 yfinance 數據\n└── platinum_ewz.csv         # 整理後對齊數據\n```\n\n### 強制更新\n\n```bash\npython fetch_data.py --start 2003-01-01 --force-refresh\n```\n",
        "skills/analyze-platinum-to-brazil-equities-transmission/references/input-schema.md": "# 輸入參數定義\n\n---\n\n## 必要參數\n\n| 參數 | 類型 | 說明 | 範例 |\n|------|------|------|------|\n| `start_date` | string (YYYY-MM-DD) | 分析起始日期 | `\"2003-01-01\"` |\n\n**注意**：EWZ 上市於 2000-07-10，建議 start_date 不早於 2000-08-01。推薦使用 2003-01-01 以獲得穩定數據。\n\n---\n\n## 選用參數\n\n| 參數 | 類型 | 預設值 | 說明 |\n|------|------|--------|------|\n| `end_date` | string (YYYY-MM-DD) | 今日 | 分析結束日期 |\n| `frequency` | string | `\"1wk\"` | 資料頻率：`1d` / `1wk` / `1mo` |\n| `platinum_ticker` | string | `\"PL=F\"` | 白金價格 ticker |\n| `brazil_ticker` | string | `\"EWZ\"` | 巴西股市 proxy ticker |\n| `price_field` | string | `\"auto\"` | 價格欄位：`auto` / `Adj Close` / `Close` |\n| `normalize_base` | number | `100` | 正規化基準 |\n| `corr_window` | int | `52` | Rolling correlation 視窗（frequency 單位） |\n| `lead_lag_max` | int | `52` | 領先/落後最大掃描期數 |\n| `regime_window` | int | `104` | 長期 regime 判斷窗口（frequency 單位） |\n| `output_mode` | string | `\"both\"` | 輸出格式：`markdown` / `json` / `both` |\n\n---\n\n## 參數建議\n\n### frequency 選擇\n\n| 頻率 | 適用場景 | corr_window 建議 | lead_lag_max 建議 |\n|------|----------|-------------------|-------------------|\n| `1wk` | 長週期傳導分析（推薦） | 52（1年） | 52（1年） |\n| `1mo` | 超長週期概覽 | 12（1年） | 24（2年） |\n| `1d` | 短期細節觀察 | 252（1年） | 252（1年） |\n\n### price_field = \"auto\" 邏輯\n\n```python\nif ticker is ETF (e.g., EWZ):\n    use \"Adj Close\"  # 反映股息再投資\nelse:\n    use \"Adj Close\" if available, else \"Close\"\n```\n\n### regime_window 選擇\n\n| 值 | 等效 | 適用場景 |\n|----|------|----------|\n| 52 | 1 年 | 較敏感，適合觀察近期 regime 變化 |\n| 104 | 2 年 | 預設，平衡敏感度與穩定性 |\n| 156 | 3 年 | 更穩定，適合判斷長期結構 |\n",
        "skills/analyze-platinum-to-brazil-equities-transmission/references/methodology.md": "## 1. 數據預處理\n\n### 1.1 頻率重採樣\n\n```python\n# 日頻 → 週頻重採樣\nrule = {\"1wk\": \"W-FRI\", \"1mo\": \"ME\"}[frequency]\nseries = series.resample(rule).last().dropna()\n```\n\n**為何用 W-FRI**：週五收盤價最能反映一週的市場定價。\n\n### 1.2 對齊\n\n```python\nprices = pd.concat([platinum, ewz], axis=1).dropna()  # inner join\n```\n\n**為何用 inner join**：白金期貨與 EWZ 的交易日不完全重疊（如巴西假日），使用 ffill 或 interpolate 會引入假訊號。\n\n### 1.3 價格欄位選擇\n\n| Ticker | 欄位選擇              | 原因                 |\n|--------|-----------------------|----------------------|\n| EWZ    | Adj Close             | ETF 需反映股息再投資 |\n| PL=F   | Close（或 Adj Close） | 期貨無股息，兩者等價 |\n\n---\n\n## 2. 正規化\n\n```\nP_norm(t) = P(t) / P(0) × normalize_base\n```\n\n其中 P(0) 為序列第一個有效值，normalize_base 預設 100。\n\n正規化使不同量級的資產（白金 ~$1000/oz vs EWZ ~$30）可在同軸比較。\n\n---\n\n## 3. Log Return\n\n```\nr(t) = ln(P(t)) - ln(P(t-1)) = ln(P(t) / P(t-1))\n```\n\n使用 log return 而非 simple return 的原因：\n- 時間可加性：多期 log return 可直接相加\n- 統計特性更好：更接近常態分佈\n- 與百分比變化在小幅變動時近似\n\n---\n\n## 4. Rolling Correlation\n\n```\nρ_rolling(t) = corr(r_platinum[t-w+1:t], r_ewz[t-w+1:t])\n```\n\n其中 w = corr_window（預設 52 週 ≈ 1 年）。\n\n### 解讀\n\n| ρ 值       | 含義       | 傳導意涵     |\n|------------|------------|--------------|\n| > 0.5      | 強正相關   | 傳導結構穩固 |\n| 0.2 ~ 0.5  | 中等正相關 | 有關聯但不強 |\n| -0.2 ~ 0.2 | 接近零     | 無明顯關聯   |\n| < -0.2     | 負相關     | 反向或脫鉤   |\n\n### Stability 指標\n\n```\nrolling_corr_stability = count(ρ > 0) / total_count\n```\n\nstability ≥ 0.6 表示「多數時間正相關」，為傳導穩定性的基本門檻。\n\n---\n\n## 5. Lead-Lag Cross-Correlation\n\n### 公式\n\n```\nCC(lag) = corr(r_ewz(t), r_platinum(t - lag))\n```\n\n掃描範圍：lag ∈ [-lead_lag_max, +lead_lag_max]\n\n### 最佳 Lag\n\n```\nbest_lag = argmax_{lag} |CC(lag)|\nbest_corr = CC(best_lag)\n```\n\n### 解讀規則\n\n| best_lag | 含義                           |\n|----------|--------------------------------|\n| > 0      | 白金領先 EWZ（platinum leads） |\n| = 0      | 同步移動                       |\n| < 0      | EWZ 領先白金                   |\n\n### 合理範圍\n\n對於商品→新興市場股市的傳導，合理的領先期為 4-26 週（1-6 個月）。\n\n---\n\n## 6. Regime 判斷\n\n### 趨勢一致性\n\n在 regime_window（預設 104 週 ≈ 2 年）內計算：\n\n```python\n# 方法一：均線斜率同向比例\nma_platinum = platinum.rolling(26).mean()\nma_ewz = ewz.rolling(26).mean()\n\nslope_platinum = ma_platinum.diff()\nslope_ewz = ma_ewz.diff()\n\n# 兩者斜率符號相同的比例\ntrend_agreement = (np.sign(slope_platinum) == np.sign(slope_ewz)).mean()\n```\n\n### Regime Label 判定\n\n| 條件                                             | Label                  | 含義                   |\n|--------------------------------------------------|------------------------|------------------------|\n| trend_agreement ≥ 0.6 且 rolling_corr_latest > 0 | `linked_upcycle`       | 連動上行（或下行）週期 |\n| trend_agreement < 0.4 或 rolling_corr_latest ≤ 0 | `decoupled`            | 脫鉤                   |\n| rolling_corr_latest < -0.2 且 EWZ 累積報酬 < 0   | `brazil_idiosyncratic` | 巴西特有風險主導       |\n\n---\n\n## 7. 傳導強度分數（Transmission Strength Score）\n\n### 三維度加權\n\n```\nscore = w1 × S_corr + w2 × S_stability + w3 × S_trend\n```\n\n| 維度           | 符號        | 權重 | 計算方式                     |\n|----------------|-------------|------|------------------------------|\n| 最佳相關       | S_corr      | 30%  | min(                         |\n| Rolling 穩定性 | S_stability | 30%  | rolling_corr_stability × 100 |\n| 趨勢一致性     | S_trend     | 40%  | trend_agreement × 100        |\n\n### 分數解讀\n\n| 分數區間 | 等級     | 含義                             |\n|----------|----------|----------------------------------|\n| ≥ 70     | 強傳導   | 白金對 EWZ 有穩定的領先/連動關係 |\n| 50-69    | 中等傳導 | 存在關聯但有 regime 依賴性       |\n| < 50     | 弱傳導   | 關聯不穩定，敘事可信度低         |\n\n---\n\n## 8. 傳導結論模板\n\n### 傳導成立\n\n條件：best lag > 0 且 |corr| ≥ 0.35 且 rolling corr 正值佔比 ≥ 0.5\n\n> 「白金具備中度/高度領先 EWZ 的傳導特徵，最佳領先期約 {lag} 週，\n> 52 週 rolling correlation 有 {pct}% 時間為正。當前處於 {regime} 體制。」\n\n### 傳導不穩定\n\n條件：lag 不穩定或 rolling corr 多數時間接近 0 / 負\n\n> 「白金與 EWZ 的關聯具 regime-dependent 性質，需警惕敘事失效。\n> Rolling correlation 正值佔比僅 {pct}%，當前處於 {regime} 體制。」\n\n### 傳導不成立\n\n條件：|best_corr| < 0.2 或 best_lag < 0\n\n> 「數據不支持白金領先 EWZ 的敘事。最佳 lag = {lag}（{meaning}），\n> 相關係數僅 {corr}。建議探索其他傳導路徑或驅動因素。」\n",
        "skills/analyze-platinum-to-brazil-equities-transmission/templates/output-json.md": "# JSON 輸出模板\n\n```json\n{\n  \"skill\": \"analyze-platinum-to-brazil-equities-transmission\",\n  \"as_of\": \"YYYY-MM-DD\",\n  \"status\": \"ok | error | partial\",\n\n  \"pair\": {\n    \"platinum\": \"PL=F\",\n    \"brazil_equities\": \"EWZ\"\n  },\n\n  \"period\": {\n    \"start\": \"YYYY-MM-DD\",\n    \"end\": \"YYYY-MM-DD\",\n    \"frequency\": \"1wk\",\n    \"data_points\": 1100\n  },\n\n  \"signal\": \"transmission_strong | transmission_moderate | transmission_weak | inconclusive\",\n  \"confidence\": \"high | medium | low\",\n\n  \"transmission\": {\n    \"transmission_strength_score_0_100\": 74,\n\n    \"best_lead_lag\": {\n      \"lag_weeks\": 12,\n      \"meaning\": \"Platinum leads EWZ by ~12 weeks\",\n      \"corr\": 0.52\n    },\n\n    \"rolling_corr\": {\n      \"window_weeks\": 52,\n      \"latest\": 0.41,\n      \"positive_share_full\": 0.62,\n      \"positive_share_5y\": 0.68,\n      \"max_consecutive_positive_weeks\": 78,\n      \"max_consecutive_negative_weeks\": 34\n    },\n\n    \"regime\": {\n      \"window_weeks\": 104,\n      \"label\": \"linked_upcycle | decoupled | brazil_idiosyncratic\",\n      \"trend_agreement\": 0.65,\n      \"detail\": \"Regime 判斷說明\"\n    },\n\n    \"score_breakdown\": {\n      \"best_corr_component\": 22.3,\n      \"rolling_stability_component\": 20.4,\n      \"trend_agreement_component\": 26.0,\n      \"weights\": {\n        \"best_corr\": 0.30,\n        \"rolling_stability\": 0.30,\n        \"trend_agreement\": 0.40\n      }\n    }\n  },\n\n  \"interpretation\": \"一句話結論\",\n\n  \"monitoring_notes\": [\n    \"若 PL=F 突破長期區間，觀察 EWZ 在 8-16 週內是否趨勢翻多\",\n    \"要求 52 週 rolling corr 維持正值至少 26 週作為確認\",\n    \"若白金大漲而 EWZ 不動且 corr 轉負，視為 regime break\"\n  ],\n\n  \"data_limitations\": [\n    \"交叉相關只顯示統計關聯，不代表因果關係\",\n    \"EWZ 以美元計價，受 BRL/USD 匯率影響\",\n    \"期貨價格在展延日可能出現非市場因素的跳動\"\n  ],\n\n  \"artifacts\": {\n    \"charts\": [\n      \"output/platinum_vs_ewz_YYYY-MM-DD.png\"\n    ],\n    \"data_cache\": [\n      \"data/cache/platinum_ewz.csv\"\n    ]\n  }\n}\n```\n\n## 欄位說明\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| `status` | string | 執行狀態：ok / error / partial |\n| `signal` | string | 傳導訊號等級 |\n| `confidence` | string | 信心水準 |\n| `transmission_strength_score_0_100` | int | 傳導強度分數（0-100） |\n| `best_lead_lag.lag_weeks` | int | 最佳領先落後週數（正=白金領先） |\n| `best_lead_lag.corr` | float | 最佳 lag 的相關係數 |\n| `rolling_corr.latest` | float | 最新 rolling correlation 值 |\n| `rolling_corr.positive_share_5y` | float | 近 5 年 rolling corr 正值佔比 |\n| `regime.label` | string | 當前 regime 標籤 |\n| `regime.trend_agreement` | float | 趨勢一致性比例 |\n| `monitoring_notes` | string[] | 監控建議清單 |\n| `data_limitations` | string[] | 資料限制說明 |\n",
        "skills/analyze-platinum-to-brazil-equities-transmission/templates/output-markdown.md": "# Markdown 報告模板\n\n```markdown\n## 白金（PL=F）→ 巴西股市（EWZ）傳導分析\n\n**分析日期**: {as_of}\n**分析區間**: {start} ~ {end}（{frequency}，{data_points} 筆資料）\n\n---\n\n### TL;DR\n\n{一句話結論，例如：「白金具備中度領先 EWZ 的傳導特徵，最佳領先期約 12 週，傳導強度分數 74/100。」}\n\n---\n\n### 傳導強度分數：{score}/100\n\n| 維度 | 分數 | 權重 | 加權貢獻 |\n|------|------|------|----------|\n| 最佳相關 | {s_corr} | 30% | {w_corr} |\n| Rolling 穩定性 | {s_stability} | 30% | {w_stability} |\n| 趨勢一致性 | {s_trend} | 40% | {w_trend} |\n\n---\n\n### 領先落後分析\n\n| 項目 | 結果 |\n|------|------|\n| 最佳 Lag | {lag} 週 |\n| 含義 | {meaning} |\n| 相關係數 | {corr} |\n\n---\n\n### Rolling Correlation（{corr_window} 週窗口）\n\n| 指標 | 數值 |\n|------|------|\n| 最新值 | {latest} |\n| 全期正值佔比 | {positive_share_full} |\n| 近 5 年正值佔比 | {positive_share_5y} |\n| 最長連續正值 | {max_pos} 週 |\n| 最長連續負值 | {max_neg} 週 |\n\n---\n\n### 當前 Regime\n\n**Label**: {regime_label}\n**趨勢一致性**: {trend_agreement}\n**說明**: {regime_detail}\n\n---\n\n### 傳導結論\n\n{基於三維度綜合判斷的結論段落}\n\n---\n\n### 監控清單（非短線）\n\n- {monitoring_note_1}\n- {monitoring_note_2}\n- {monitoring_note_3}\n\n---\n\n### 替代解釋\n\n- 巴西股市受政治風險、匯率（BRL）、大宗商品結構等多重因素影響\n- 白金與 EWZ 可能由共同的第三因素驅動（如全球風險偏好、美元走勢）\n- 交叉相關只顯示統計關聯，不代表白金「驅動」巴西股市\n\n---\n\n### 資料限制\n\n- EWZ 以美元計價，受 BRL/USD 匯率影響\n- 白金期貨（PL=F）在合約展延日可能出現價格跳動\n- Inner join 對齊可能丟失少量交易日資料\n- {frequency} 頻率下，領先落後精度為 1 個 {frequency} 單位\n\n---\n\n### 圖表\n\n![白金 vs EWZ 傳導分析](output/platinum_vs_ewz_{date}.png)\n```\n\n## 使用方式\n\n腳本根據分析結果填入 `{}` 佔位符，生成完整報告。\n\n### Signal 對應 TL;DR 模板\n\n| signal | TL;DR 模板 |\n|--------|-----------|\n| `transmission_strong` | 「白金具備高度領先 EWZ 的傳導特徵，最佳領先期約 {lag} 週，傳導強度分數 {score}/100。」 |\n| `transmission_moderate` | 「白金具備中度領先 EWZ 的傳導特徵，但關聯具有 regime 依賴性。」 |\n| `transmission_weak` | 「白金與 EWZ 的傳導關係較弱，敘事可信度偏低。」 |\n| `inconclusive` | 「數據不足以判斷白金與 EWZ 的傳導關係。」 |\n",
        "skills/analyze-platinum-to-brazil-equities-transmission/workflows/analyze.md": "# Workflow: 完整傳導分析\n\n<required_reading>\n閱讀以下參考文件：\n1. references/methodology.md - 傳導分析方法論\n2. references/data-sources.md - 資料來源與替代方案\n3. references/input-schema.md - 完整輸入參數定義\n</required_reading>\n\n<process>\n\n## Step 1: 數據取得\n\n使用 Yahoo Finance 取得白金期貨與巴西股市 ETF 的歷史價格。\n\n```bash\ncd scripts\npython fetch_data.py --start 2003-01-01 --freq 1wk\n```\n\n腳本會自動：\n1. 下載 PL=F（白金期貨）與 EWZ（巴西股市 ETF）的歷史價格\n2. 依 frequency 參數重採樣（週頻：W-FRI 取 last）\n3. 使用 inner join 對齊（只保留共同交易日）\n4. 存入 `data/cache/` 快取\n\n### 數據品質確認\n\n- [ ] 兩序列時間範圍一致\n- [ ] 無大量連續缺值（超過 4 週）\n- [ ] 價格序列無負值或零值\n\n---\n\n## Step 2: 數據處理與分析\n\n```bash\npython analyze.py --start 2003-01-01 --freq 1wk --output-mode both\n```\n\n### 2.1 生成衍生數據\n\n| 數據 | 計算方式 | 用途 |\n|------|----------|------|\n| 原值 | 原始收盤價 | 雙軸圖 |\n| 正規化 | P / P[0] × normalize_base | 同軸對比 |\n| Log Return | ln(P).diff() | 相關分析 |\n| Rolling Corr | corr(r_pl, r_ewz, window=52) | 時變關聯 |\n\n### 2.2 領先落後分析\n\n掃描 [-52, +52] 週的 lag：\n```\ncorr(r_ewz, r_platinum.shift(lag))\n```\n\n找 |corr| 最大的 lag：\n- lag > 0：白金領先 EWZ\n- lag < 0：EWZ 領先白金\n- lag ≈ 0：同步移動\n\n### 2.3 Regime 判斷\n\n在 regime_window（預設 104 週）內估計趨勢一致性：\n\n```\ntrend_agreement = 均線斜率同向比例\n```\n\n| trend_agreement | Regime Label |\n|-----------------|--------------|\n| ≥ 0.6 且 corr > 0 | linked_upcycle |\n| < 0.4 或 corr < 0 | decoupled |\n| corr < -0.2 且 EWZ 下跌 | brazil_idiosyncratic |\n\n### 2.4 傳導強度分數\n\n```\nscore = best_corr × 30 + rolling_stability × 30 + trend_agreement × 40\n```\n\n其中：\n- `best_corr`：最佳 lag 的 |corr|，映射到 0-100\n- `rolling_stability`：rolling corr > 0 的佔比 × 100\n- `trend_agreement`：趨勢同向比例 × 100\n\n---\n\n## Step 3: 生成報告\n\n根據 output_mode 生成對應格式：\n\n### Markdown 報告（output_mode = markdown / both）\n\n參照 `templates/output-markdown.md` 模板：\n1. **TL;DR**：一句話結論\n2. **量化證據**：lead-lag、rolling corr、score、regime\n3. **傳導結論**：基於三維度綜合判斷\n4. **監控清單**：非短線追蹤建議\n5. **資料限制**：假設與注意事項\n\n### JSON 報告（output_mode = json / both）\n\n參照 `templates/output-json.md` 模板。\n\n---\n\n## Step 4: 視覺化（可選）\n\n```bash\npython visualize.py --start 2003-01-01\n```\n\n生成 Bloomberg 風格多面板圖表，包含：\n1. 原值雙軸圖（左軸 EWZ、右軸 Platinum）\n2. 正規化同軸對比圖\n3. Rolling Correlation 時間序列\n4. Lead-Lag Cross-Correlation 條形圖\n\n輸出到：`output/platinum_vs_ewz_YYYY-MM-DD.png`\n\n---\n\n## Step 5: 傳導結論判讀\n\n### 傳導成立條件\n\n若以下三個條件同時滿足：\n1. best lag > 0（白金領先）\n2. |corr| ≥ 0.35（關聯達門檻）\n3. rolling corr 正值佔比 ≥ 0.5（長期偏正）\n\n→ 「白金具備中度/高度領先 EWZ 的傳導特徵」\n\n### 傳導不穩定\n\n若 lag 不穩定或 rolling corr 多數時間接近 0 / 負：\n\n→ 「關聯具 regime-dependent 性質，需警惕敘事失效」\n\n### 監控清單輸出\n\n根據分析結果自動生成：\n- 白金突破長期區間後 X–Y 週內，EWZ 是否趨勢翻多\n- Rolling corr 是否由負轉正並維持至少 N 週\n- 若白金大漲而 EWZ 不動且 corr 轉負 → 可能為巴西特有風險主導\n\n</process>\n\n<success_criteria>\n完整分析完成時應有：\n\n- [ ] 白金與 EWZ 的歷史價格數據（inner join 對齊）\n- [ ] 最佳領先落後週數與相關係數\n- [ ] 52 週 Rolling Correlation 最新值與正值佔比\n- [ ] 傳導強度分數（0-100）\n- [ ] 當前 Regime Label\n- [ ] 傳導結論（成立/不穩定/不成立）\n- [ ] 監控清單\n- [ ] JSON 與/或 Markdown 報告\n- [ ] Bloomberg 風格圖表（可選）\n</success_criteria>\n\n<troubleshooting>\n\n### yfinance 下載失敗\n\n**問題**：`No data found for ticker PL=F`\n\n**解決**：\n1. 檢查網路連線\n2. 確認 ticker 名稱正確（白金期貨在 Yahoo Finance 為 `PL=F`）\n3. 嘗試更短的時間範圍\n\n### 數據不足\n\n**問題**：rolling correlation 視窗不夠\n\n**解決**：\n1. 確保 start_date 足夠早（建議至少比 corr_window 多 2 倍）\n2. 降低 corr_window 參數（如 26 週）\n\n### EWZ 上市日限制\n\n**問題**：EWZ 上市於 2000-07-10\n\n**解決**：\n1. start_date 不要早於 2000-08-01\n2. 建議使用 2003-01-01 以獲得穩定數據\n\n</troubleshooting>\n",
        "skills/analyze-platinum-to-brazil-equities-transmission/workflows/visualize.md": "# Workflow: 視覺化圖表\n\n<required_reading>\n閱讀以下參考文件：\n1. references/methodology.md - 了解圖表對應的分析邏輯\n</required_reading>\n\n<process>\n\n## Step 1: 確認數據可用\n\n確認已有快取數據或先執行數據抓取：\n\n```bash\ncd scripts\n\n# 若需重新抓取\npython fetch_data.py --start 2003-01-01 --freq 1wk\n\n# 生成圖表\npython visualize.py --start 2003-01-01\n```\n\n---\n\n## Step 2: 圖表結構\n\nBloomberg 風格多面板佈局：\n\n```\n┌─────────────────────────────────────────────────┐\n│       白金（PL=F）vs 巴西股市（EWZ）原值雙軸圖    │\n│       左軸：EWZ（橙色）  右軸：Platinum（青色）   │\n├─────────────────────┬───────────────────────────┤\n│  正規化同軸對比圖    │  Lead-Lag Cross-Corr      │\n│  （base=100）       │  條形圖                   │\n├─────────────────────┴───────────────────────────┤\n│       52-Week Rolling Correlation               │\n│       （含零線、±0.5 參考線）                    │\n└─────────────────────────────────────────────────┘\n```\n\n### 面板說明\n\n| 位置 | 面板名稱 | 內容 |\n|------|----------|------|\n| 上方（跨整列） | 原值雙軸圖 | EWZ（左軸）+ Platinum（右軸），Bloomberg 深色背景 |\n| 左中 | 正規化對比 | 兩者正規化至 base=100，同軸直接比較走勢 |\n| 右中 | Lead-Lag | 交叉相關條形圖，標示最佳 lag 位置 |\n| 下方（跨整列） | Rolling Corr | 52 週滾動相關時間序列，含正/負區域著色 |\n\n### 配色方案\n\n```python\nCOLORS = {\n    \"background\": \"#1a1a2e\",\n    \"grid\": \"#2d2d44\",\n    \"text\": \"#ffffff\",\n    \"platinum\": \"#00bcd4\",   # 青色\n    \"ewz\": \"#ff9800\",        # 橙色\n    \"positive_corr\": \"#4caf50\",  # 綠色（正相關）\n    \"negative_corr\": \"#f44336\",  # 紅色（負相關）\n    \"best_lag\": \"#ffeb3b\",   # 黃色（最佳 lag 標記）\n}\n```\n\n---\n\n## Step 3: 輸出\n\n- **預設路徑**：`{專案根目錄}/output/platinum_vs_ewz_YYYY-MM-DD.png`\n- **解析度**：150 DPI\n- **尺寸**：16x12 英寸\n- **格式**：PNG\n\n---\n\n## Step 4: 解讀指南\n\n### 原值雙軸圖\n- 觀察兩條線是否長期同向移動\n- 注意分歧期（一升一降）→ 可能的 decoupled regime\n\n### 正規化對比圖\n- 起點對齊後，觀察累積報酬的差異\n- 差距擴大 → 表現分化；收斂 → 回歸連動\n\n### Lead-Lag Cross-Correlation\n- 峰值在正 lag → 白金領先\n- 峰值高度代表最大可解釋程度\n- 多個峰值 → 關聯可能是周期性的\n\n### Rolling Correlation\n- 持續正值（綠色區域）→ 傳導結構穩定\n- 頻繁穿越零線 → regime-dependent\n- 持續負值 → 反向關聯或脫鉤\n\n</process>\n\n<success_criteria>\n視覺化完成時應有：\n\n- [ ] 四面板 Bloomberg 風格圖表\n- [ ] 原值雙軸圖（左軸 EWZ、右軸 Platinum）\n- [ ] 正規化同軸對比圖\n- [ ] Lead-Lag Cross-Correlation 條形圖\n- [ ] Rolling Correlation 時間序列圖\n- [ ] 輸出 PNG 檔案至 output/ 目錄\n</success_criteria>\n",
        "skills/analyze-rolex-market-index-liquidity-proxy/SKILL.md": "---\nname: analyze-rolex-market-index-liquidity-proxy\ndescription: 用勞力士市場指數（WatchCharts Rolex Market Index）作為高 β 的風險偏好／流動性代理，判讀「流動性改善但未到投機狂熱」的狀態\n---\n\n<essential_principles>\n**以勞力士指數分析流動性投機程度 核心原則**\n\n<principle name=\"rolex_as_liquidity_proxy\">\n**勞力士市場指數是全球流動性與財富效應的高 β 代理**\n勞力士二級市場價格對流動性環境極為敏感。當全球流動性擴張時，勞力士二手錶價格率先上漲；當流動性收縮時，也率先下跌。其波動幅度（β）遠高於傳統金融資產，是觀察流動性週期的敏感指標。\n</principle>\n\n<principle name=\"grinding_vs_fever\">\n**區分「緩慢磨高」與「投機狂熱」**\n- **Grinding Higher（緩慢磨高）**：斜率為正、價格在均線之上、但距離歷史峰值仍遠。代表流動性改善的早中期階段。\n- **Speculative Fever（投機狂熱）**：z-score 極端（≥2.0）、實質利率為負或大幅下行、流動性加速擴張。代表 2021/22 式的泡沫頂部。\n</principle>\n\n<principle name=\"net_liquidity_formula\">\n**Fed 淨流動性公式**\n```\nNet Liquidity ≈ WALCL − RRPONTSYD − WTREGEN\n```\n- WALCL：Fed 資產負債表總資產\n- RRPONTSYD：隔夜逆回購（ON RRP）\n- WTREGEN：美國財政部一般帳戶（TGA）\n\n淨流動性上升 → 金融體系實際可用資金增加 → 風險資產與勞力士二級市場受益\n</principle>\n\n<principle name=\"real_yield_regime\">\n**實質利率區間決定 β 強度**\n在不同 DFII10（10Y TIPS 實質利率）區間下，勞力士市場指數對流動性的敏感度不同：\n- DFII10 < 0（負實質利率）：高 β，最容易出現投機狂熱\n- DFII10 ≈ 0~1%（接近零）：中 β，改善中但未到狂熱\n- DFII10 > 1.5%（正高檔）：低 β，流動性改善效果被高利率壓制\n</principle>\n\n<principle name=\"data_provenance\">\n**數據可重現性優先**\n勞力士市場指數透過 Chrome CDP 自動從 WatchCharts 頁面抓取，本地快取 TTL 24 小時。FRED 數據（DFII10、WALCL、RRPONTSYD、WTREGEN）透過公開 CSV endpoint 取得，確保完全可重現。\n</principle>\n</essential_principles>\n\n<objective>\n**分析目標**\n\n以勞力士市場指數為核心，對照 Fed 淨流動性與實質利率，完成以下判斷：\n\n1. **確認參數**：時間範圍、頻率、流動性模型\n2. **取得數據**：從 FRED 取得流動性與利率數據，透過 CDP 抓取勞力士市場指數\n3. **計算指標**：z-score、滾動斜率、滾動 β、距峰值距離\n4. **判讀狀態**：grinding_higher（緩慢磨高）或 speculative_fever（投機狂熱）\n5. **產出報告**：結構化 JSON + Markdown 摘要\n6. **提供建議**：下一步監控重點與交叉驗證方向\n</objective>\n\n<quick_start>\n**快速開始**\n\n```bash\n# 1. 安裝依賴\npip install pandas numpy requests websocket-client matplotlib\n\n# 2. 啟動 Chrome 調試模式並開啟 WatchCharts 頁面\n#    Windows:\n#      \"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" ^\n#        --remote-debugging-port=9222 ^\n#        --remote-allow-origins=* ^\n#        --user-data-dir=\"%USERPROFILE%\\.chrome-debug-profile\" ^\n#        \"https://watchcharts.com/watches/brand_index/rolex\"\n#\n#    macOS:\n#      /Applications/Google\\ Chrome.app/Contents/MacOS/Google\\ Chrome \\\n#        --remote-debugging-port=9222 \\\n#        --remote-allow-origins=* \\\n#        --user-data-dir=\"$HOME/.chrome-debug-profile\" \\\n#        \"https://watchcharts.com/watches/brand_index/rolex\"\n\n# 3. 等待頁面完全載入（圖表顯示），然後執行分析\npython scripts/rolex_market_index_analyzer.py \\\n  --start-date 2019-01-01 \\\n  --end-date 2026-01-29 \\\n  --freq W \\\n  --liquidity-model fed_net_liquidity \\\n  --cdp-port 9222 \\\n  --output result.json\n```\n</quick_start>\n\n<intake>\n**您想要分析什麼？**\n\n1. **完整分析** - 從數據取得到狀態判讀的完整流程（推薦）\n2. **僅取得數據** - 只取得 FRED 數據與透過 CDP 抓取勞力士市場指數\n3. **僅計算指標** - 假設數據已備妥，直接計算所有指標\n4. **僅判讀狀態** - 假設指標已計算，判讀 grinding/fever 狀態\n\n**等待回應後再繼續。**\n</intake>\n\n<routing>\n| Response                         | Workflow             | Description                         |\n|----------------------------------|----------------------|-------------------------------------|\n| 1, \"完整分析\", \"full\", \"analyze\" | workflows/analyze.md | 完整的端到端分析流程                |\n| 2, \"取得數據\", \"fetch\", \"data\"   | workflows/analyze.md | 執行 Step 1~2（數據取得與載入）     |\n| 3, \"計算指標\", \"compute\"         | workflows/analyze.md | 執行 Step 3~4（指標計算與狀態判讀） |\n| 4, \"判讀狀態\", \"interpret\"       | workflows/analyze.md | 執行 Step 4~5（狀態判讀與報告產出） |\n\n**讀取工作流程後，請完全遵循其步驟。**\n</routing>\n\n<directory_structure>\n```\nskills/analyze-rolex-market-index-liquidity-proxy/\n├── SKILL.md                          # 本檔案（路由與核心原則）\n├── skill.yaml                        # 前端展示設定\n├── manifest.json                     # 技能元資料\n├── workflows/\n│   └── analyze.md                    # 主要分析工作流（6 步驟）\n├── references/\n│   ├── methodology.md                # 方法論（公式、規則、判讀邏輯）\n│   ├── input-schema.md               # 輸入參數定義\n│   └── data-sources.md               # 數據來源文檔\n├── templates/\n│   ├── output-json.md                # JSON 輸出模板\n│   └── output-markdown.md            # Markdown 報告模板\n├── scripts/\n│   ├── fetch_rolex_index.py           # CDP 爬蟲（WatchCharts Rolex Index）\n│   ├── rolex_market_index_analyzer.py # 主要分析腳本\n│   └── rolex_market_index_plotter.py  # 視覺化腳本（選配）\n└── examples/\n    └── sample-output.json            # 範例輸出\n```\n</directory_structure>\n\n<reference_index>\n**參考文件** (`references/`)\n\n| 文件            | 內容                                                       |\n|-----------------|------------------------------------------------------------|\n| methodology.md  | 方法論：z-score、滾動斜率、滾動 β、grinding/fever 判讀規則 |\n| input-schema.md | 所有輸入參數的定義、型別、預設值、可選值                   |\n| data-sources.md | FRED 系列代碼、WatchCharts CDP 抓取、fallback 方案         |\n</reference_index>\n\n<workflows_index>\n| Workflow   | Purpose                                                                   |\n|------------|---------------------------------------------------------------------------|\n| analyze.md | 完整分析流程（6 步驟：確認參數→取得數據→計算指標→判讀狀態→產出報告→建議） |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose                                                           |\n|--------------------|-------------------------------------------------------------------|\n| output-json.md     | 結構化 JSON 輸出模板（含 summary、metrics、signals、diagnostics） |\n| output-markdown.md | Markdown 報告模板（含 TL;DR、依據、風險、下一步）                 |\n</templates_index>\n\n<scripts_index>\n| Script                         | Purpose                                                          |\n|--------------------------------|------------------------------------------------------------------|\n| fetch_rolex_index.py           | CDP 爬蟲：從 WatchCharts 自動抓取 Rolex Market Index             |\n| rolex_market_index_analyzer.py | 主要分析腳本：FRED 數據取得、CDP 抓取、指標計算、狀態判讀        |\n| rolex_market_index_plotter.py  | 視覺化腳本：雙軸圖（勞力士市場指數 vs 淨流動性）、z-score 熱力圖 |\n\n**執行範例：**\n```bash\n# 完整分析（需先啟動 Chrome 調試模式並開啟 WatchCharts 頁面）\npython scripts/rolex_market_index_analyzer.py \\\n  --start-date 2019-01-01 \\\n  --end-date 2026-01-29 \\\n  --freq W \\\n  --liquidity-model fed_net_liquidity \\\n  --cdp-port 9222 \\\n  --output result.json\n\n# 視覺化（選配）\npython scripts/rolex_market_index_plotter.py \\\n  --input result.json \\\n  --output-dir output/\n```\n</scripts_index>\n\n<input_schema_summary>\n**輸入參數摘要**\n\n| 參數               | 型別    | 必要 | 預設值              | 說明                     |\n|--------------------|---------|------|---------------------|--------------------------|\n| start_date         | string  | ✅    | -                   | 分析起始日（YYYY-MM-DD） |\n| end_date           | string  | ✅    | -                   | 分析結束日（YYYY-MM-DD） |\n| frequency          | string  | ❌    | \"W\"                 | 頻率：D/W/M              |\n| liquidity_scope    | string  | ❌    | \"US\"                | US 或 GLOBAL             |\n| include_real_yield | boolean | ❌    | true                | 是否加入 DFII10          |\n| real_yield_series  | string  | ❌    | \"DFII10\"            | FRED 實質利率代號        |\n| liquidity_model    | string  | ❌    | \"fed_net_liquidity\" | 流動性模型               |\n| benchmark_assets   | array   | ❌    | []                  | 參考資產代號             |\n| fever_threshold_z  | number  | ❌    | 2.0                 | 投機狂熱 z-score 閾值    |\n| grind_window       | int     | ❌    | 13                  | 斜率/均線滾動窗口        |\n\n完整定義請見 `references/input-schema.md`。\n</input_schema_summary>\n\n<output_schema_summary>\n**輸出結構摘要**\n\n```json\n{\n  \"skill\": \"analyze_veblen_goods_liquidity_proxy\",\n  \"inputs\": { \"...\" },\n  \"summary\": {\n    \"state\": \"grinding_higher | speculative_fever | neutral | declining\",\n    \"interpretation\": [\"...\"]\n  },\n  \"metrics\": {\n    \"latest_index\": 28400,\n    \"pct_below_peak\": -0.33,\n    \"grind_slope\": 12.4,\n    \"rolex_zscore\": 0.6,\n    \"dfii10_level\": 1.9,\n    \"net_liquidity_change\": 2.1e10,\n    \"rolling_beta_vs_net_liquidity\": 1.8\n  },\n  \"signals\": {\n    \"grinding_higher\": true,\n    \"speculative_fever\": false\n  },\n  \"diagnostics\": { \"...\" }\n}\n```\n\n完整模板請見 `templates/output-json.md`。\n</output_schema_summary>\n\n<success_criteria>\nSkill 成功執行時：\n- [ ] FRED 數據（DFII10、WALCL、RRPONTSYD、WTREGEN）成功取得\n- [ ] WatchCharts Rolex Market Index CDP 自動抓取成功且缺值比例 < 5%\n- [ ] 所有頻率對齊完成（resample + forward-fill）\n- [ ] z-score、滾動斜率、滾動 β 計算完成\n- [ ] grinding_higher / speculative_fever 狀態判讀完成\n- [ ] JSON 輸出包含 summary、metrics、signals、diagnostics\n- [ ] Markdown 報告包含 TL;DR、依據、風險、下一步\n- [ ] 距峰值百分比（pct_below_peak）正確反映當前位置\n</success_criteria>\n",
        "skills/analyze-rolex-market-index-liquidity-proxy/references/data-sources.md": "# 數據來源文檔\n\n## 1. FRED 數據（主要來源）\n\n### 1.1 來源資訊\n\n| 屬性     | 值                                                                                       |\n|----------|------------------------------------------------------------------------------------------|\n| 來源名稱 | Federal Reserve Economic Data (FRED)                                                     |\n| 來源等級 | 官方（Federal Reserve Bank of St. Louis）                                                |\n| 取得方式 | CSV endpoint（無需 API key）                                                             |\n| URL 模板 | `https://fred.stlouisfed.org/graph/fredgraph.csv?id={series_id}&cosd={start}&coed={end}` |\n| 更新延遲 | T+1（多數系列）                                                                          |\n| 授權     | 公開使用                                                                                 |\n\n### 1.2 使用的系列\n\n| 系列代碼  | 名稱                     | 頻率 | 單位       | 用途           |\n|-----------|--------------------------|------|------------|----------------|\n| DFII10    | 10-Year TIPS Real Yield  | 日   | 百分比 (%) | 實質利率水準   |\n| WALCL     | Fed Total Assets         | 週   | 百萬美元   | Fed 資產負債表 |\n| RRPONTSYD | ON RRP                   | 日   | 十億美元   | 隔夜逆回購餘額 |\n| WTREGEN   | Treasury General Account | 週   | 百萬美元   | 財政部一般帳戶 |\n\n**注意：** RRPONTSYD 單位為十億美元，WALCL 和 WTREGEN 為百萬美元，計算淨流動性時需統一單位。\n\n### 1.3 抓取規範\n\n依照 `thoughts/shared/guide/fred-data-fetching-guide.md`：\n\n```python\nFRED_CSV_URL = \"https://fred.stlouisfed.org/graph/fredgraph.csv\"\n\ndef fetch_fred_series(series_id: str, start_date: str, end_date: str) -> pd.Series:\n    params = {\"id\": series_id, \"cosd\": start_date, \"coed\": end_date}\n    response = requests.get(FRED_CSV_URL, params=params, timeout=30)\n    response.raise_for_status()\n\n    df = pd.read_csv(StringIO(response.text))\n    df.columns = [\"DATE\", series_id]\n    df[\"DATE\"] = pd.to_datetime(df[\"DATE\"])\n    df[series_id] = df[series_id].replace(\".\", pd.NA)\n    df[series_id] = pd.to_numeric(df[series_id], errors=\"coerce\")\n    df = df.dropna()\n    df = df.set_index(\"DATE\")\n    return df[series_id]\n```\n\n### 1.4 Fallback 方案\n\n| 主要來源          | Fallback                     | 說明       |\n|-------------------|------------------------------|------------|\n| FRED CSV endpoint | pandas_datareader + FRED API | 需 API key |\n| FRED CSV endpoint | 手動下載並放入 cache/        | 離線使用   |\n\n---\n\n## 2. 勞力士市場指數（Chrome CDP 自動抓取）\n\n### 2.1 主要來源：WatchCharts Rolex Market Index\n\n| 屬性     | 值                                                          |\n|----------|-------------------------------------------------------------|\n| 來源名稱 | WatchCharts                                                 |\n| 來源等級 | 商業（社群數據聚合）                                        |\n| URL      | https://watchcharts.com/watches/brand_index/rolex            |\n| 取得方式 | Chrome CDP 自動抓取（本地快取 TTL 24 小時）                 |\n| 更新頻率 | 約每週                                                      |\n| 更新延遲 | 約每週更新，本地快取 TTL 24 小時                            |\n| 授權     | 個人使用（需確認最新條款）                                  |\n\n### 2.2 CDP 啟動指令\n\n**Windows：**\n```cmd\n\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" ^\n  --remote-debugging-port=9222 ^\n  --remote-allow-origins=* ^\n  --user-data-dir=\"%USERPROFILE%\\.chrome-debug-profile\" ^\n  \"https://watchcharts.com/watches/brand_index/rolex\"\n```\n\n**macOS：**\n```bash\n/Applications/Google\\ Chrome.app/Contents/MacOS/Google\\ Chrome \\\n  --remote-debugging-port=9222 \\\n  --remote-allow-origins=* \\\n  --user-data-dir=\"$HOME/.chrome-debug-profile\" \\\n  \"https://watchcharts.com/watches/brand_index/rolex\"\n```\n\n### 2.3 提取策略優先順序\n\n| 優先級 | 策略         | 說明                                     |\n|--------|-------------|------------------------------------------|\n| 1      | Highcharts  | 最常見的圖表庫，優先嘗試                 |\n| 2      | Chart.js    | 輕量圖表庫                               |\n| 3      | ApexCharts  | 現代圖表庫                               |\n| 4      | ECharts     | 百度開源圖表庫                           |\n| 5      | DOM Table   | 從 HTML 表格中提取                       |\n| 6      | Global Vars | 掃描頁面全域變數                         |\n\n腳本會依序嘗試每個策略，選擇第一個成功且數據量最大的結果。\n\n### 2.4 替代來源\n\n| 來源          | 類型               | 可用性   | 說明                                   |\n|---------------|--------------------|----------|----------------------------------------|\n| Chrono24      | 手錶二級市場       | 手動查詢 | 個別勞力士型號價格，需自行建構加權指數 |\n| Bob's Watches | 勞力士專門二手錶商 | 手動查詢 | 提供部分勞力士型號歷史成交價           |\n| 自建指數      | 多來源加權         | 自訂     | 用多個二手錶平台的勞力士報價加權建構   |\n\n---\n\n## 3. 數據品質管控\n\n### 3.1 品質檢查項目\n\n| 檢查項     | 規則               | 處理方式                      |\n|------------|--------------------|-------------------------------|\n| 缺值比例   | < 5% 為正常        | forward-fill + 記錄           |\n| 缺值比例   | ≥ 5%               | 警告 + 標記 data_quality 降級 |\n| 極端跳點   | 單期變動 > 3σ      | 標記但不自動移除              |\n| 日期連續性 | 無大段缺失         | 記錄最大連續缺失天數          |\n| 單位一致性 | RRPONTSYD vs WALCL | 統一為相同單位                |\n\n### 3.2 快取機制\n\n```\ncache/\n├── DFII10_{start}_{end}.json\n├── WALCL_{start}_{end}.json\n├── RRPONTSYD_{start}_{end}.json\n└── WTREGEN_{start}_{end}.json\n```\n\n快取有效期：24 小時（可配置）\n\n每個快取檔包含：\n```json\n{\n  \"cached_at\": \"2026-01-29T10:00:00\",\n  \"series_id\": \"DFII10\",\n  \"start_date\": \"2019-01-01\",\n  \"end_date\": \"2026-01-29\",\n  \"row_count\": 1750,\n  \"data\": [...]\n}\n```\n",
        "skills/analyze-rolex-market-index-liquidity-proxy/references/input-schema.md": "# 輸入參數定義\n\n## 必要參數\n\n### start_date\n\n| Property | Value |\n|----------|-------|\n| Type | string (YYYY-MM-DD) |\n| Required | ✅ Required |\n| Default | — |\n| Description | 分析起始日 |\n\n建議值：`2019-01-01`（覆蓋 2021/22 狂熱前的基期）\n\n---\n\n### end_date\n\n| Property | Value |\n|----------|-------|\n| Type | string (YYYY-MM-DD) |\n| Required | ✅ Required |\n| Default | — |\n| Description | 分析結束日 |\n\n建議值：當天日期\n\n---\n\n## 選用參數\n\n### frequency\n\n| Property | Value |\n|----------|-------|\n| Type | string |\n| Required | ❌ Optional |\n| Default | `\"W\"` |\n| Description | 數據頻率 |\n\n可用選項：\n- `\"D\"` - 日頻（不建議，WatchCharts Rolex Market Index 通常為週頻更新）\n- `\"W\"` - 週頻（**推薦**）\n- `\"M\"` - 月頻\n\n---\n\n### liquidity_scope\n\n| Property | Value |\n|----------|-------|\n| Type | string |\n| Required | ❌ Optional |\n| Default | `\"US\"` |\n| Description | 流動性範圍 |\n\n可用選項：\n- `\"US\"` - 美國（使用 FRED 數據）\n- `\"GLOBAL\"` - 全球（需額外提供 ECB/BoJ 等資料，目前以 custom 方式支援）\n\n---\n\n### include_real_yield\n\n| Property | Value |\n|----------|-------|\n| Type | boolean |\n| Required | ❌ Optional |\n| Default | `true` |\n| Description | 是否加入 10Y TIPS 實質利率分析 |\n\n設為 `false` 時，跳過 DFII10 相關指標與區間判讀。\n\n---\n\n### real_yield_series\n\n| Property | Value |\n|----------|-------|\n| Type | string |\n| Required | ❌ Optional |\n| Default | `\"DFII10\"` |\n| Description | FRED 實質利率系列代碼 |\n\n可用選項：\n- `\"DFII10\"` - 10-Year Treasury Inflation-Indexed Security, Constant Maturity（推薦）\n- `\"DFII5\"` - 5-Year TIPS\n- `\"DFII20\"` - 20-Year TIPS\n\n---\n\n### liquidity_model\n\n| Property | Value |\n|----------|-------|\n| Type | string |\n| Required | ❌ Optional |\n| Default | `\"fed_net_liquidity\"` |\n| Description | 流動性模型選擇 |\n\n可用選項：\n\n| 模型 | 公式 | FRED 系列 | 說明 |\n|------|------|-----------|------|\n| `fed_net_liquidity` | WALCL − RRP − TGA | WALCL, RRPONTSYD, WTREGEN | 推薦：最完整的淨流動性估算 |\n| `simple_balance_sheet` | WALCL | WALCL | 簡化版：只用 Fed 資產負債表 |\n| `custom` | 使用者自訂 | — | 需提供自訂流動性數據 |\n\n---\n\n### benchmark_assets\n\n| Property | Value |\n|----------|-------|\n| Type | array[string] |\n| Required | ❌ Optional |\n| Default | `[]` |\n| Description | 參考資產代號（用於交叉比對，目前版本不自動取得） |\n\n範例：`[\"SPX\", \"BTC\"]`\n\n**注意：** 當前版本不會自動取得參考資產價格，僅在報告中提及建議比對方向。\n\n---\n\n### fever_threshold_z\n\n| Property | Value |\n|----------|-------|\n| Type | number |\n| Required | ❌ Optional |\n| Default | `2.0` |\n| Description | 判斷「投機狂熱」的 z-score 閾值 |\n\n建議範圍：1.5 ~ 2.5\n\n| 閾值 | 敏感度 | 適用場景 |\n|------|--------|----------|\n| 1.5 | 高 | 想更早偵測過熱訊號 |\n| 2.0 | 中（推薦） | 平衡準確度與誤報率 |\n| 2.5 | 低 | 只在極端情況觸發 |\n\n---\n\n### grind_window\n\n| Property | Value |\n|----------|-------|\n| Type | int |\n| Required | ❌ Optional |\n| Default | `13` |\n| Description | 滾動斜率與均線的窗口大小 |\n| Unit | 與 frequency 同單位（週頻 = 13 週 ≈ 一季） |\n\n建議範圍：\n\n| frequency | 建議 grind_window | 對應時間 |\n|-----------|-------------------|----------|\n| W | 8 ~ 13 | 2~3 個月 |\n| M | 3 ~ 6 | 一季~半年 |\n\n---\n\n## 參數組合範例\n\n### 標準分析（推薦）\n\n```\nstart_date: 2019-01-01\nend_date: 2026-01-29\nfrequency: W\nliquidity_model: fed_net_liquidity\ninclude_real_yield: true\nfever_threshold_z: 2.0\ngrind_window: 13\n```\n\n### 快速簡化分析\n\n```\nstart_date: 2021-01-01\nend_date: 2026-01-29\nfrequency: M\nliquidity_model: simple_balance_sheet\ninclude_real_yield: true\nfever_threshold_z: 2.0\ngrind_window: 6\n```\n\n### 高敏感度偵測\n\n```\nstart_date: 2019-01-01\nend_date: 2026-01-29\nfrequency: W\nliquidity_model: fed_net_liquidity\ninclude_real_yield: true\nfever_threshold_z: 1.5\ngrind_window: 8\n```\n",
        "skills/analyze-rolex-market-index-liquidity-proxy/references/methodology.md": "勞力士市場指數（WatchCharts Rolex Market Index）是全球流動性與財富效應的高 β 代理。本 Skill 透過量化指標判讀兩種狀態：\n\n- **Grinding Higher（緩慢磨高）**：流動性改善的早中期，價格穩步上升但距峰值仍遠\n- **Speculative Fever（投機狂熱）**：流動性過度擴張的後期，價格達到歷史極端\n\n---\n\n## 2. 數學公式\n\n### 2.1 Z-Score（標準化分數）\n\n**全樣本 Z-Score：**\n\n```\nzscore(x) = (x - μ) / σ\n```\n\n其中 μ = 全樣本均值，σ = 全樣本標準差（ddof=0）\n\n**滾動窗口 Z-Score：**\n\n```\nzscore(x, w) = (x - μ_w) / σ_w\n```\n\n其中 μ_w = rolling(w).mean()，σ_w = rolling(w).std(ddof=0)\n\n```python\ndef zscore(s: pd.Series, window: int | None = None):\n    if window is None:\n        return (s - s.mean()) / s.std(ddof=0)\n    m = s.rolling(window).mean()\n    sd = s.rolling(window).std(ddof=0)\n    return (s - m) / sd\n```\n\n### 2.2 滾動斜率（Rolling Slope）\n\n用於判斷「grinding higher」的方向性：\n\n```\nslope = polyfit(x=[0,1,...,w-1], y=rolex[t-w+1:t], degree=1)[0]\n```\n\n```python\ndef rolling_slope(y: pd.Series, window: int):\n    idx = np.arange(window)\n    def _slope(a):\n        return np.polyfit(idx, a, 1)[0]\n    return y.rolling(window).apply(_slope, raw=True)\n```\n\n**解讀：**\n- slope > 0：價格趨勢向上\n- slope ≈ 0：橫盤\n- slope < 0：價格趨勢向下\n\n### 2.3 滾動 β（Rolling Beta）\n\n衡量勞力士市場指數報酬對流動性變化的敏感度：\n\n```\nβ = Cov(rolex_ret, liq_chg) / Var(liq_chg)\n```\n\n```python\ndef rolling_beta(y_ret: pd.Series, x_ret: pd.Series, window: int):\n    cov = y_ret.rolling(window).cov(x_ret)\n    var = x_ret.rolling(window).var()\n    return cov / var\n```\n\n**解讀：**\n- β > 1：勞力士市場指數對流動性變化的放大效果（高 β）\n- β ≈ 1：等比例反應\n- β < 1：反應遲鈍\n\n### 2.4 距峰值百分比\n\n```\npct_below_peak = (current_value / peak_value) - 1.0\n```\n\n- 結果為負數表示低於峰值\n- 例如 -0.33 表示低於峰值 33%\n\n### 2.5 Fed 淨流動性\n\n```\nNet Liquidity = WALCL - RRPONTSYD - WTREGEN\n```\n\n| 組成      | FRED 代碼  | 含義                            |\n|-----------|------------|---------------------------------|\n| WALCL     | Fed 總資產 | 注入金融體系的總資金            |\n| RRPONTSYD | ON RRP     | 金融機構存回 Fed 的資金（鎖住） |\n| WTREGEN   | TGA        | 財政部在 Fed 的存款（鎖住）     |\n\n---\n\n## 3. 判讀規則\n\n### 3.1 Grinding Higher 規則\n\n| 條件       | 公式                                     | 閾值      |\n|------------|------------------------------------------|-----------|\n| 斜率為正   | `rolling_slope(rolex, grind_window) > 0` | slope > 0 |\n| 在均線之上 | `rolex > MA(rolex, grind_window)`        | 布林值    |\n| 距峰值仍遠 | `pct_below_peak < -0.10`                 | < -10%    |\n\n**判讀：** 至少滿足「斜率為正」+「距峰值仍遠」即判定為 grinding_higher。\n\n### 3.2 Speculative Fever 規則\n\n| 條件         | 公式                                | 閾值          |\n|--------------|-------------------------------------|---------------|\n| Z-Score 極端 | `rolex_zscore >= fever_threshold_z` | ≥ 2.0（預設） |\n| 實質利率為負 | `DFII10 < 0`                        | < 0           |\n| 流動性改善   | `net_liq_chg > 0`                   | > 0           |\n\n**判讀：** 需同時滿足三個條件才判定為 speculative_fever。\n\n### 3.3 實質利率 β 區間\n\n| DFII10 區間 | 標籤                | 預期 β 強度     |\n|-------------|---------------------|-----------------|\n| < 0%        | negative_real       | 高（1.5~3.0+）  |\n| 0~1.0%      | near_zero           | 中（0.8~1.5）   |\n| 1.0~2.0%    | moderately_positive | 中低（0.3~0.8） |\n| > 2.0%      | restrictive         | 低（< 0.3）     |\n\n---\n\n## 4. 數據處理規則\n\n### 4.1 頻率對齊\n\n所有數據 resample 至指定 frequency（W/M），使用 `.last().ffill()`：\n- `.last()`：取該期間最後一個觀察值\n- `.ffill()`：前值填充缺失值\n\n### 4.2 缺值處理\n\n| 情況             | 處理方式                         |\n|------------------|----------------------------------|\n| 零星缺值（< 5%） | forward-fill                     |\n| 大段缺值（≥ 5%） | 記錄警告，標記 data_quality 降級 |\n| 時間範圍不重疊   | 取交集，記錄有效起始日           |\n\n### 4.3 對數轉換\n\n勞力士市場指數使用對數價格計算報酬：\n```\nlog_price = log(index_value)\nreturn = diff(log_price)\n```\n\n---\n\n## 5. 參考文獻\n\n- 勞力士二級市場價格作為流動性代理：多位宏觀分析師在 2020-2022 QE→Taper→QT 週期中的實證觀察\n- Fed 淨流動性概念：標準宏觀流動性分析公式\n- Z-Score 在金融中的應用：標準統計方法\n",
        "skills/analyze-rolex-market-index-liquidity-proxy/templates/output-json.md": "# JSON 輸出模板\n\n## 完整結構\n\n```json\n{\n  \"skill\": \"analyze_veblen_goods_liquidity_proxy\",\n  \"version\": \"0.1.0\",\n  \"generated_at\": \"2026-01-29T10:30:00Z\",\n\n  \"inputs\": {\n    \"start_date\": \"string — 分析起始日 (YYYY-MM-DD)\",\n    \"end_date\": \"string — 分析結束日 (YYYY-MM-DD)\",\n    \"frequency\": \"string — 數據頻率 (D/W/M)\",\n    \"liquidity_scope\": \"string — 流動性範圍 (US/GLOBAL)\",\n    \"liquidity_model\": \"string — 流動性模型\",\n    \"real_yield_series\": \"string — FRED 實質利率代號\",\n    \"fever_threshold_z\": \"number — 狂熱閾值 z-score\",\n    \"grind_window\": \"int — 滾動窗口大小\"\n  },\n\n  \"summary\": {\n    \"state\": \"string — grinding_higher | speculative_fever | neutral | declining\",\n    \"interpretation\": [\n      \"string — 第一條解讀（勞力士市場指數趨勢）\",\n      \"string — 第二條解讀（距峰值距離）\",\n      \"string — 第三條解讀（實質利率環境）\"\n    ]\n  },\n\n  \"metrics\": {\n    \"latest_index\": \"number — 勞力士市場指數最新值\",\n    \"latest_date\": \"string — 最新數據日期\",\n    \"pct_below_peak\": \"number — 距歷史峰值百分比（負數表示低於峰值）\",\n    \"peak_value\": \"number — 歷史峰值\",\n    \"peak_date\": \"string — 峰值日期\",\n    \"grind_slope\": \"number — 滾動斜率\",\n    \"rolex_zscore\": \"number — 勞力士市場指數 z-score\",\n    \"rolex_above_ma\": \"boolean — 是否在均線之上\",\n    \"dfii10_level\": \"number — 10Y TIPS 實質利率水準 (%)\",\n    \"dfii10_delta\": \"number — 實質利率近期變化\",\n    \"net_liquidity_level\": \"number — Fed 淨流動性水準\",\n    \"net_liquidity_change\": \"number — 淨流動性近期變化\",\n    \"liquidity_zscore\": \"number — 淨流動性 z-score\",\n    \"rolling_beta_vs_net_liquidity\": \"number — 對淨流動性的滾動 β\",\n    \"rolling_return_cumulative\": \"number — grind_window 期間累積報酬\"\n  },\n\n  \"signals\": {\n    \"grinding_higher\": \"boolean — 是否處於「緩慢磨高」狀態\",\n    \"speculative_fever\": \"boolean — 是否處於「投機狂熱」狀態\",\n    \"grinding_conditions\": {\n      \"slope_positive\": \"boolean\",\n      \"above_ma\": \"boolean\",\n      \"below_peak_10pct\": \"boolean\"\n    },\n    \"fever_conditions\": {\n      \"zscore_extreme\": \"boolean\",\n      \"real_yield_negative\": \"boolean\",\n      \"liquidity_improving\": \"boolean\"\n    }\n  },\n\n  \"regime\": {\n    \"real_yield_regime\": \"string — negative_real | near_zero | moderately_positive | restrictive\",\n    \"real_yield_regime_label\": \"string — 中文標籤\",\n    \"expected_beta_strength\": \"string — 高 | 中 | 中低 | 低\",\n    \"liquidity_direction\": \"string — improving | stable | contracting\"\n  },\n\n  \"diagnostics\": {\n    \"data_quality\": {\n      \"rolex_missing_ratio\": \"number — 勞力士市場指數缺值比例\",\n      \"fred_missing_ratio\": \"number — FRED 數據缺值比例\",\n      \"effective_start_date\": \"string — 實際有效起始日（取交集後）\",\n      \"effective_end_date\": \"string — 實際有效結束日\",\n      \"total_observations\": \"int — 總觀察值數量\"\n    },\n    \"regime_rules\": {\n      \"fever_threshold_z\": \"number — 使用的狂熱閾值\",\n      \"fever_requires_real_yield_negative\": true,\n      \"fever_requires_liquidity_improving\": true,\n      \"grind_window\": \"int — 使用的滾動窗口\",\n      \"grind_requires_below_peak_10pct\": true\n    }\n  },\n\n  \"notes\": [\n    \"string — 分析注意事項或補充說明\"\n  ],\n\n  \"recommended_next_checks\": [\n    \"string — 建議的後續驗證方向\"\n  ]\n}\n```\n\n## 欄位說明\n\n| 區塊        | 欄位              | 類型     | 說明                        |\n|-------------|-------------------|----------|-----------------------------|\n| summary     | state             | string   | 綜合狀態判讀                |\n| summary     | interpretation    | string[] | 人類可讀的解讀文字          |\n| metrics     | pct_below_peak    | number   | 負值 = 低於峰值，0 = 在峰值 |\n| metrics     | grind_slope       | number   | 正值 = 上升趨勢             |\n| metrics     | rolex_zscore      | number   | >2.0 為極端（依閾值設定）   |\n| signals     | grinding_higher   | boolean  | 核心判讀結果                |\n| signals     | speculative_fever | boolean  | 核心判讀結果                |\n| regime      | real_yield_regime | string   | 實質利率所處區間            |\n| diagnostics | data_quality      | object   | 數據品質指標                |\n",
        "skills/analyze-rolex-market-index-liquidity-proxy/templates/output-markdown.md": "# Markdown 報告模板\n\n## 報告結構\n\n```markdown\n# 以勞力士指數分析流動性投機程度報告\n\n> **分析日期：** {generated_at}\n> **數據範圍：** {start_date} ~ {end_date}（{frequency} 頻率）\n> **勞力士市場指數來源：** WatchCharts Rolex Market Index（Chrome CDP 自動抓取）\n> **流動性模型：** {liquidity_model}\n\n---\n\n## TL;DR\n\n{summary.state 對應的一句話結論}\n\n- **狀態判讀：** {state_label}\n- **距 2021/22 峰值：** {pct_below_peak}（{peak_value} @ {peak_date}）\n- **Fed 淨流動性：** {liquidity_direction_label}\n\n---\n\n## 核心數據\n\n| 指標                  | 最新值                         | 解讀                                        |\n|-----------------------|--------------------------------|---------------------------------------------|\n| 勞力士市場指數        | {latest_index} ({latest_date}) | {index_trend_label}                         |\n| 距峰值百分比          | {pct_below_peak}               | {peak_distance_label}                       |\n| Z-Score               | {rolex_zscore}                 | {zscore_label}（閾值：{fever_threshold_z}） |\n| 滾動斜率              | {grind_slope}                  | {slope_label}                               |\n| 在均線之上            | {rolex_above_ma}               | —                                           |\n| 10Y TIPS 實質利率     | {dfii10_level}%                | {real_yield_regime_label}                   |\n| Fed 淨流動性變化      | {net_liquidity_change}         | {liq_change_label}                          |\n| 滾動 β（vs 淨流動性） | {rolling_beta}                 | {beta_label}                                |\n\n---\n\n## 判讀依據\n\n### Grinding Higher（緩慢磨高）：{grinding_higher}\n\n| 條件           | 結果               | 說明             |\n|----------------|--------------------|------------------|\n| 滾動斜率 > 0   | {slope_positive}   | 價格趨勢方向     |\n| 價格在均線之上 | {above_ma}         | 中期強勢         |\n| 距峰值 > 10%   | {below_peak_10pct} | 尚未回到狂熱水準 |\n\n### Speculative Fever（投機狂熱）：{speculative_fever}\n\n| 條件                          | 結果                  | 說明           |\n|-------------------------------|-----------------------|----------------|\n| Z-Score ≥ {fever_threshold_z} | {zscore_extreme}      | 價格極端程度   |\n| DFII10 < 0                    | {real_yield_negative} | 負實質利率環境 |\n| 淨流動性改善                  | {liquidity_improving} | 流動性正在擴張 |\n\n---\n\n## 實質利率區間分析\n\n- **當前 DFII10：** {dfii10_level}%\n- **所處區間：** {real_yield_regime_label}\n- **預期 β 強度：** {expected_beta_strength}\n- **含義：** {regime_interpretation}\n\n---\n\n## 風險與假設\n\n1. **數據延遲：** WatchCharts Rolex Market Index 約每週更新，本地快取 TTL 24 小時\n2. **模型假設：** Fed 淨流動性公式假設 WALCL − RRP − TGA 能代表市場可用流動性\n3. **歷史不等於未來：** 2021/22 的狂熱模式不一定在下次完全重現\n4. **數據品質：** 勞力士市場指數缺值比例 {rolex_missing_ratio}，FRED 缺值比例 {fred_missing_ratio}\n\n---\n\n## 下一步\n\n1. **持續監控：** {monitoring_suggestion}\n2. **交叉驗證：** {cross_validation_suggestion}\n3. **觸發條件：** {trigger_conditions}\n4. **對沖提示：** {hedge_suggestion}\n\n---\n\n*本報告由 analyze-rolex-market-index-liquidity-proxy v{version} 產出*\n```\n\n## TL;DR 模板（依 state）\n\n| state             | TL;DR 模板                                                                                |\n|-------------------|-------------------------------------------------------------------------------------------|\n| grinding_higher   | 勞力士市場指數緩慢磨高中，距 2021/22 峰值仍有 {pct}% 距離。流動性環境改善但未到投機狂熱。 |\n| speculative_fever | ⚠️ 勞力士市場指數 z-score 達 {z}，搭配負實質利率與流動性加速擴張，已進入投機狂熱區間。     |\n| neutral           | 勞力士市場指數橫盤整理，無明確方向性。流動性環境 {liq_direction}。                        |\n| declining         | 勞力士市場指數走弱中，斜率為負。流動性環境可能正在收縮。                                  |\n",
        "skills/analyze-rolex-market-index-liquidity-proxy/workflows/analyze.md": "# 以勞力士指數分析流動性投機程度 - 完整工作流\n\n## 概述\n\n本工作流從數據取得到狀態判讀，完成勞力士市場指數與流動性的完整分析。\n\n---\n\n## Step 1：確認分析參數\n\n向使用者確認以下參數，未指定者使用預設值：\n\n| 參數               | 預設值            | 使用者值 |\n|--------------------|-------------------|----------|\n| cdp_port           | 9222              |          |\n| cache_dir          | cache             |          |\n| force_refresh      | false             |          |\n| start_date         | 2019-01-01        |          |\n| end_date           | （今天）          |          |\n| frequency          | W                 |          |\n| liquidity_scope    | US                |          |\n| include_real_yield | true              |          |\n| real_yield_series  | DFII10            |          |\n| liquidity_model    | fed_net_liquidity |          |\n| benchmark_assets   | []                |          |\n| fever_threshold_z  | 2.0               |          |\n| grind_window       | 13                |          |\n\n**確認後繼續 Step 2。**\n\n---\n\n## Step 2：取得數據\n\n### 2.1 FRED 數據取得\n\n從 FRED 取得以下系列（依 `liquidity_model` 與 `include_real_yield` 決定）：\n\n**fed_net_liquidity 模型（推薦）：**\n\n| 系列代碼  | 名稱                 | 頻率 | 用途         |\n|-----------|----------------------|------|--------------|\n| WALCL     | Fed 資產負債表總資產 | 週   | 淨流動性分子 |\n| RRPONTSYD | 隔夜逆回購餘額       | 日   | 淨流動性減項 |\n| WTREGEN   | 財政部一般帳戶       | 週   | 淨流動性減項 |\n| DFII10    | 10Y TIPS 實質利率    | 日   | 利率區間判讀 |\n\n**simple_balance_sheet 模型：**\n\n| 系列代碼 | 名稱                 | 頻率 | 用途         |\n|----------|----------------------|------|--------------|\n| WALCL    | Fed 資產負債表總資產 | 週   | 流動性代理   |\n| DFII10   | 10Y TIPS 實質利率    | 日   | 利率區間判讀 |\n\n執行取得：\n\n```bash\npython scripts/rolex_market_index_analyzer.py \\\n  --fetch-only \\\n  --start-date {start_date} \\\n  --end-date {end_date} \\\n  --liquidity-model {liquidity_model} \\\n  --real-yield-series {real_yield_series} \\\n  --cdp-port {cdp_port}\n```\n\n**驗證點：**\n- [ ] 每個 FRED 系列的數據筆數 > 0\n- [ ] 日期範圍涵蓋 start_date 至 end_date\n- [ ] 無異常缺值（缺值比例 < 5%）\n\n### 2.2 勞力士市場指數 CDP 抓取\n\n透過 Chrome CDP 從 WatchCharts 自動抓取 Rolex Market Index。\n\n**前置條件：**\n1. 關閉所有 Chrome 視窗\n2. 用調試端口啟動 Chrome 並開啟 WatchCharts Rolex 頁面\n3. 等待頁面完全載入（圖表顯示）\n\n```bash\n# Windows:\n\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" ^\n  --remote-debugging-port=9222 ^\n  --remote-allow-origins=* ^\n  --user-data-dir=\"%USERPROFILE%\\.chrome-debug-profile\" ^\n  \"https://watchcharts.com/watches/brand_index/rolex\"\n\n# macOS:\n/Applications/Google\\ Chrome.app/Contents/MacOS/Google\\ Chrome \\\n  --remote-debugging-port=9222 \\\n  --remote-allow-origins=* \\\n  --user-data-dir=\"$HOME/.chrome-debug-profile\" \\\n  \"https://watchcharts.com/watches/brand_index/rolex\"\n```\n\n**抓取流程：**\n1. **自動切換 Max 時間範圍**（預設開啟）：腳本透過 CDP 自動點擊頁面上的 \"Max\" 按鈕，確保取得完整歷史數據（WatchCharts 預設顯示 1Y）。可用 `--no-auto-max` 停用。\n2. **多策略提取**：依序嘗試 Highcharts → Chart.js → ApexCharts → ECharts → DOM 表格 → 全域變數，選擇最長的時間序列。\n3. **Chart.js v3 支援**：WatchCharts 使用 Chart.js v3.9.1，數據格式為 `{x: \"ISO-date\", y: value}` 物件（非傳統 labels+data）。腳本已支援此格式。\n4. **時區處理**：CDP 抓取的 ISO 日期字串帶 UTC 時區（`Z` 後綴），轉換時自動移除 tzinfo 以避免與 FRED tz-naive 數據 join 時報錯。\n\n**驗證點：**\n- [ ] CDP 連接成功\n- [ ] Max 時間範圍已選中（或 `--no-auto-max` 已指定）\n- [ ] 至少一個提取策略成功（通常為 Chart.js）\n- [ ] 數據點數 > 10（Max 模式約 100 個點，跨 ~8 年）\n- [ ] 時間範圍與 FRED 數據重疊\n\n**故障排除：**\n- 若連接失敗：確認 Chrome 已用 `--remote-debugging-port` 啟動\n- 若提取失敗：確認頁面已完全載入（圖表已顯示）\n- 若被 Cloudflare 擋住：手動在 Chrome 中完成驗證後重試\n- 若 Max 按鈕切換後數據仍為 1Y：等待數秒後重試，或手動在頁面上點擊 Max\n- 快取有效期 24 小時，可用 `--force-refresh` 強制重新抓取\n\n---\n\n## Step 3：數據處理與指標計算\n\n### 3.1 頻率對齊\n\n```python\n# 全部 resample 到 frequency\nveblen = veblen_raw.resample(freq).last().ffill()\ndfii10 = dfii10_raw.resample(freq).last().ffill()\nwalcl = walcl_raw.resample(freq).last().ffill()\nrrp = rrp_raw.resample(freq).last().ffill()\ntga = tga_raw.resample(freq).last().ffill()\n```\n\n記錄各系列的缺值比例：`missing_ratio = nulls / total_rows`\n\n### 3.2 淨流動性計算\n\n依 `liquidity_model`：\n\n- **fed_net_liquidity**：`net_liq = WALCL - RRPONTSYD - WTREGEN`\n- **simple_balance_sheet**：`net_liq = WALCL`\n- **custom**：使用者自訂公式\n\n### 3.3 指標計算\n\n| 指標               | 公式                                 | 用途             |\n|--------------------|--------------------------------------|------------------|\n| `veblen_log`       | `log(rolex_index)`                   | 標準化價格       |\n| `veblen_ret`       | `diff(veblen_log)`                   | 週/月報酬        |\n| `rolex_zscore`     | `(v - mean) / std`                   | 判斷極端程度     |\n| `grind_slope`      | `rolling_slope(rolex, grind_window)` | 判斷上升趨勢     |\n| `rolex_above_MA`   | `rolex > MA(grind_window)`           | 均線之上         |\n| `pct_below_peak`   | `rolex / max(rolex) - 1`             | 距峰值距離       |\n| `net_liq_chg`      | `diff(net_liq)`                      | 流動性變化方向   |\n| `liq_zscore`       | `zscore(net_liq)`                    | 流動性極端程度   |\n| `delta_real_yield` | `diff(DFII10)`                       | 實質利率變化方向 |\n| `rolling_beta`     | `cov(v_ret, liq_chg) / var(liq_chg)` | 對流動性的敏感度 |\n\n### 3.4 公式參考\n\n詳見 `references/methodology.md`。\n\n---\n\n## Step 4：狀態判讀\n\n### 4.1 Grinding Higher（緩慢磨高）\n\n**條件（至少滿足 2 項）：**\n\n1. `grind_slope > 0`（滾動斜率為正）\n2. `rolex_above_MA == True`（價格在中期均線之上）\n3. `pct_below_peak < -0.10`（距峰值仍有 10%+ 距離）\n\n```python\ngrinding = (grind_slope > 0) and (pct_below_peak < -0.10)\n```\n\n### 4.2 Speculative Fever（投機狂熱）\n\n**條件（需同時滿足）：**\n\n1. `rolex_zscore >= fever_threshold_z`（z-score 極端）\n2. `DFII10 < 0` 或 `delta_real_yield` 持續下行（實質利率環境寬鬆）\n3. `net_liq_chg > 0`（流動性正在改善/加速）\n\n```python\nfever = (rolex_zscore >= fever_z) and (dfii10 < 0) and (net_liq_chg > 0)\n```\n\n### 4.3 綜合狀態\n\n| 條件組合                             | 狀態                | 解讀                           |\n|--------------------------------------|---------------------|--------------------------------|\n| grinding=True, fever=False           | `grinding_higher`   | 流動性改善中，未到狂熱         |\n| grinding=True, fever=True            | `speculative_fever` | 進入投機過熱區間               |\n| grinding=False, fever=False, slope<0 | `declining`         | 流動性收縮，勞力士市場指數走弱 |\n| grinding=False, fever=False, slope≈0 | `neutral`           | 橫盤整理                       |\n\n### 4.4 實質利率區間判讀\n\n| DFII10 區間 | 標籤                  | β 強度 | 說明                 |\n|-------------|-----------------------|--------|----------------------|\n| < 0         | `negative_real`       | 高     | 最容易出現投機狂熱   |\n| 0 ~ 1.0%    | `near_zero`           | 中     | 改善中但未到狂熱     |\n| 1.0% ~ 2.0% | `moderately_positive` | 中低   | 高利率壓制風險偏好   |\n| > 2.0%      | `restrictive`         | 低     | 流動性改善效果被壓制 |\n\n---\n\n## Step 5：產出報告\n\n### 5.1 JSON 輸出\n\n依照 `templates/output-json.md` 產出結構化 JSON，包含：\n\n- `inputs`：所有輸入參數\n- `summary`：state + interpretation\n- `metrics`：所有核心指標最新值\n- `signals`：grinding_higher, speculative_fever\n- `regime`：real_yield_regime, beta_regime\n- `diagnostics`：data_quality, regime_rules\n\n### 5.2 Markdown 報告\n\n依照 `templates/output-markdown.md` 產出，包含：\n\n- **TL;DR**：一句話結論\n- **核心數據**：表格呈現關鍵指標\n- **判讀依據**：grinding / fever 的具體判斷理由\n- **風險與假設**：數據延遲、模型限制\n- **下一步**：監控重點、交叉驗證方向\n\n### 5.3 視覺化（Bloomberg 風格）\n\n```bash\npython scripts/rolex_market_index_plotter.py \\\n  --cdp-port 9222 \\\n  --output-dir output/\n```\n\n產出 **單張三面板 Bloomberg 風格圖表**（深藍黑色背景，遵循 `bloomberg-style-chart-guide.md`）：\n1. **面板 1（主圖）**：勞力士市場指數（橙紅，R1）vs Fed 淨流動性面積圖（L2），含 13 週均線\n2. **面板 2**：Z-Score 時間序列，含 ±2.0 狂熱閾值線與極端區域填充\n3. **面板 3**：10Y TIPS 實質利率 + 利率區間色帶（負實質利率=紅色，接近零=黃色，正值偏高=藍色，緊縮=灰色）\n\n輸出檔名格式：`rolex-liquidity-proxy-{YYYY-MM-DD}.png`\n\n---\n\n## Step 6：交叉驗證建議\n\n分析完成後，建議使用者進一步驗證：\n\n1. **對比風險資產**：S&P 500、BTC 是否也在 grinding higher\n2. **對比信用利差**：HY spread 是否收窄（風險偏好一致性）\n3. **檢查 Google Trends**：「Rolex investment」「luxury watch」搜尋趨勢\n4. **對比其他二手錶平台**：Chrono24 等平台的勞力士報價是否同向\n5. **使用本專案其他 Skill**：\n   - `analyze-move-risk-gauges-leadlag`：檢查利率波動率環境\n   - `detect-us-equity-valuation-percentile-extreme`：檢查股市估值位置\n   - `zeberg-salomon-rotator`：檢查景氣循環階段\n\n---\n\n## 成功標準\n\n- [ ] FRED 數據全部成功取得\n- [ ] 勞力士市場指數 CDP 抓取成功\n- [ ] 頻率對齊無異常\n- [ ] 所有指標計算完成\n- [ ] grinding_higher / speculative_fever 判讀邏輯正確\n- [ ] JSON 輸出格式符合模板\n- [ ] Markdown 報告包含 TL;DR + 依據 + 風險 + 下一步\n",
        "skills/analyze-silver-miner-metal-ratio/SKILL.md": "---\nname: analyze-silver-miner-metal-ratio\ndescription: 以「銀礦股價格 ÷ 白銀價格」的相對比率衡量礦業股板塊相對於金屬本體的估值區間（偏貴/偏便宜），並用歷史分位數與類比區間推導「底部/頂部」訊號與情境推演。\n---\n\n<essential_principles>\n\n<principle name=\"ratio_definition\">\n**比率定義與意義**\n\n礦業股/金屬比率（Miner-to-Metal Ratio）：\n\n```\nratio_t = miner_price_t / metal_price_t\n```\n\n其中：\n- **miner_price**：銀礦股代表（ETF 如 SIL/SILJ，或自建礦業股指數）\n- **metal_price**：白銀價格（期貨 SI=F、現貨 XAGUSD、ETF SLV）\n\n此比率衡量「礦業股相對於金屬本體」的估值水位：\n- **比率高**：礦業股相對白銀偏貴（可能過度樂觀、槓桿溢價高）\n- **比率低**：礦業股相對白銀偏便宜（可能被低估、或反映成本/股權稀釋風險）\n</principle>\n\n<principle name=\"quantile_interpretation\">\n**分位數解讀邏輯**\n\n使用歷史分位數（Percentile Rank）判斷當前比率位置：\n\n| 分位數區間 | 標籤           | 直覺                       |\n|------------|----------------|----------------------------|\n| ≤ 20%      | bottom (底部)  | 礦業股相對白銀歷史上很便宜 |\n| 20-40%     | low (偏低)     | 礦業股相對估值偏低         |\n| 40-60%     | neutral (中性) | 歷史中位區間               |\n| 60-80%     | high (偏高)    | 礦業股相對估值偏高         |\n| ≥ 80%      | top (頂部)     | 礦業股相對白銀歷史上很貴   |\n\n**底部區間不等於白銀必漲**：可能是礦業股因成本/稀釋被合理定價。\n</principle>\n\n<principle name=\"divergence_signal\">\n**背離訊號的意義**\n\n當出現「比率低 + 白銀高」的組合：\n\n- **比率處於底部區**：礦業股相對白銀偏便宜\n- **白銀處於高位**：金屬價格已在歷史高檔\n\n此「背離」意味著：\n1. 礦業股可能有追趕空間（均值回歸邏輯）\n2. 或礦業股正確反映了結構性問題（成本、稀釋、地緣風險）\n\n需結合基本面交叉驗證，而非盲目視為買入訊號。\n</principle>\n\n<principle name=\"scenario_math\">\n**情境推演計算**\n\n目標：若比率要回到歷史頂部（或中位），需要什麼條件？\n\n假設當前比率 = 1.14，目標比率（頂部門檻）= 2.45：\n\n**情境 A：白銀不變，礦業股需漲多少？**\n```\nminer_multiplier = target_ratio / current_ratio\n                 = 2.45 / 1.14 = 2.15x (需漲 115%)\n```\n\n**情境 B：礦業股不變，白銀需跌多少？**\n```\nmetal_multiplier = current_ratio / target_ratio\n                 = 1.14 / 2.45 = 0.46 (需跌 54%)\n```\n\n此推演提供「極端情境」的量化參考，非預測。\n</principle>\n\n<principle name=\"data_alignment\">\n**數據對齊原則**\n\n- **頻率選擇**：長週期訊號建議使用週頻（1wk）或月頻（1mo）\n- **平滑視窗**：可選 4 週或 3 個月移動平均降低雜訊\n- **事件去重**：類比事件間隔需 ≥ min_separation_days（如 180 天）\n\n本 skill 使用 yfinance 取得 ETF/期貨數據，預設週頻對齊。\n</principle>\n\n</essential_principles>\n\n<objective>\n實作「銀礦股價 / 銀價比率」分析模型：\n\n1. **數據整合**：取得礦業股代理與白銀價格序列\n2. **比率計算**：計算相對比率並可選平滑\n3. **分位數判斷**：當前比率在歷史的位置\n4. **類比事件**：歷史底部區間的事件識別\n5. **前瞻驗證**：底部事件後白銀的 1/2/3 年表現\n6. **情境推演**：礦業股需漲多少 / 白銀需跌多少才回到頂部\n\n輸出：當前狀態、歷史類比、情境推演、風險提示。\n</objective>\n\n<quick_start>\n\n**最快的方式：執行預設情境分析**\n\n```bash\ncd skills/analyze-silver-miner-metal-ratio\npip install pandas numpy yfinance matplotlib  # 首次使用\npython scripts/ratio_analyzer.py --quick\n```\n\n**生成視覺化圖表（基本版）**\n\n```bash\npython scripts/ratio_plotter.py --quick --output-dir ../../output\n```\n\n**生成完整版圖表（含底部事件、前瞻報酬統計）**\n\n```bash\npython scripts/ratio_plotter.py --comprehensive --start-date 2010-01-01 --output-dir ../../output\n```\n\n圖表輸出路徑：\n- 基本版：`output/sil_silver_ratio_YYYY-MM-DD.png`\n- 完整版：`output/sil_silver_ratio_comprehensive_YYYY-MM-DD.png`\n\n輸出範例：\n```json\n{\n  \"skill\": \"analyze_silver_miner_metal_ratio\",\n  \"current\": {\n    \"ratio\": 1.14,\n    \"ratio_percentile\": 18.7,\n    \"zone\": \"bottom\",\n    \"bottom_threshold\": 1.16,\n    \"top_threshold\": 2.45\n  },\n  \"history_analogs\": {\n    \"bottom_event_dates\": [\"2010-08-06\", \"2016-01-29\", \"2020-03-20\"],\n    \"forward_metal_returns\": {\n      \"252\": {\"count\": 3, \"median\": 0.42, \"win_rate\": 1.0}\n    }\n  },\n  \"scenarios\": {\n    \"target\": \"return_to_top\",\n    \"miner_multiplier_if_metal_flat\": 2.15,\n    \"metal_drop_pct_if_miner_flat\": 0.54\n  }\n}\n```\n\n**完整情境分析**：\n```bash\npython scripts/ratio_analyzer.py \\\n  --miner-proxy SIL \\\n  --metal-proxy SI=F \\\n  --start-date 2008-01-01 \\\n  --freq 1wk \\\n  --smoothing-window 4 \\\n  --bottom-quantile 0.20 \\\n  --top-quantile 0.80 \\\n  --output result.json\n```\n\n</quick_start>\n\n<intake>\n需要進行什麼操作？\n\n1. **快速分析** - 使用預設參數（SIL / SI=F）計算當前比率狀態\n2. **完整分析** - 自訂參數進行情境分析（可選擇礦業股/金屬代理、分位門檻）\n3. **視覺化圖表** - 生成比率走勢圖，標記當前位置與分位數區間\n4. **歷史驗證** - 查看底部區間事件的前瞻報酬統計\n5. **情境推演** - 計算「回到頂部」需要的礦業股漲幅或白銀跌幅\n6. **方法論學習** - 了解比率邏輯與分位數解讀\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                      | Action                                                              |\n|-------------------------------|---------------------------------------------------------------------|\n| 1, \"快速\", \"quick\", \"分析\"    | 執行 `python scripts/ratio_analyzer.py --quick`                     |\n| 2, \"完整\", \"full\", \"自訂\"     | 閱讀 `workflows/analyze.md` 並執行                                  |\n| 3, \"圖表\", \"chart\", \"視覺化\"  | 執行 `python scripts/ratio_plotter.py --quick --output-dir output/` |\n| 4, \"歷史\", \"驗證\", \"backtest\" | 閱讀 `workflows/analyze.md` 並聚焦歷史類比                          |\n| 5, \"情境\", \"scenario\", \"推演\" | 閱讀 `workflows/analyze.md` 並聚焦情境推演                          |\n| 6, \"學習\", \"方法論\", \"why\"    | 閱讀 `references/methodology.md`                                    |\n| 提供參數 (如礦業股/金屬代理)  | 閱讀 `workflows/analyze.md` 並使用參數執行                          |\n\n**路由後，閱讀對應文件並執行。**\n</routing>\n\n<directory_structure>\n```\nanalyze-silver-miner-metal-ratio/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元數據\n├── workflows/\n│   ├── analyze.md                     # 完整情境分析工作流\n│   └── data-research.md               # 數據源研究與替代方案\n├── references/\n│   ├── methodology.md                 # 方法論與計算邏輯\n│   ├── input-schema.md                # 完整輸入參數定義\n│   └── data-sources.md                # 數據來源與獲取方式\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n├── scripts/\n│   ├── ratio_analyzer.py              # 主計算腳本\n│   └── ratio_plotter.py               # 視覺化圖表腳本\n└── examples/\n    └── sample-output.json             # 範例輸出\n```\n</directory_structure>\n\n<reference_index>\n\n**方法論**: references/methodology.md\n- 比率定義與直覺\n- 分位數解讀邏輯\n- 背離訊號的意義\n- 情境推演數學\n- 歷史驗證方法\n\n**資料來源**: references/data-sources.md\n- 礦業股代理（ETF/指數）\n- 白銀價格代理\n- 數據對齊原則\n\n**輸入參數**: references/input-schema.md\n- 完整參數定義\n- 預設值與建議範圍\n\n</reference_index>\n\n<workflows_index>\n| Workflow         | Purpose      | 使用時機                          |\n|------------------|--------------|-----------------------------------|\n| analyze.md       | 完整情境分析 | 需要自訂參數計算比率與情境        |\n| data-research.md | 數據源研究   | 了解如何獲取或替代礦業股/金屬數據 |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構定義 |\n| output-markdown.md | Markdown 報告模板 |\n</templates_index>\n\n<scripts_index>\n| Script            | Command                                                    | Purpose                                |\n|-------------------|------------------------------------------------------------|----------------------------------------|\n| ratio_analyzer.py | `--quick`                                                  | 快速分析 SIL/SI=F                      |\n| ratio_analyzer.py | `--miner-proxy SILJ --freq 1mo`                            | 自訂礦業股與頻率                       |\n| ratio_analyzer.py | `--scenario-target return_to_median`                       | 回到中位數情境                         |\n| ratio_plotter.py  | `--quick --output-dir ../../output`                        | 快速生成基本版圖表                     |\n| ratio_plotter.py  | `--comprehensive --start-date 2010-01-01 --output-dir ...` | 完整版圖表（含底部事件、前瞻報酬統計） |\n</scripts_index>\n\n<input_schema_summary>\n\n**核心參數**\n\n| 參數        | 類型   | 預設值  | 說明                          |\n|-------------|--------|---------|-------------------------------|\n| miner_proxy | string | SIL     | 銀礦股代表（ETF/指數代號）    |\n| metal_proxy | string | SI=F    | 白銀價格代表（期貨/現貨/ETF） |\n| start_date  | string | 10 年前 | 歷史回溯起點（YYYY-MM-DD）    |\n| end_date    | string | today   | 分析終點                      |\n| freq        | string | 1wk     | 取樣頻率（1d/1wk/1mo）        |\n\n**進階參數**\n\n| 參數                | 類型   | 預設值         | 說明                             |\n|---------------------|--------|----------------|----------------------------------|\n| smoothing_window    | int    | 4              | 比率平滑視窗（週數/月數）        |\n| bottom_quantile     | float  | 0.20           | 底部估值區分位數門檻             |\n| top_quantile        | float  | 0.80           | 頂部估值區分位數門檻             |\n| min_separation_days | int    | 180            | 類比事件去重間隔                 |\n| forward_horizons    | list   | [52, 104, 156] | 前瞻期（週數，對應 1/2/3 年）    |\n| scenario_target     | string | return_to_top  | 情境目標（return_to_top/median） |\n\n完整參數定義見 `references/input-schema.md`。\n\n</input_schema_summary>\n\n<output_schema_summary>\n```json\n{\n  \"skill\": \"analyze_silver_miner_metal_ratio\",\n  \"inputs\": {\n    \"miner_proxy\": \"SIL\",\n    \"metal_proxy\": \"SI=F\",\n    \"start_date\": \"2010-01-01\",\n    \"freq\": \"1wk\"\n  },\n  \"current\": {\n    \"ratio\": 1.14,\n    \"ratio_percentile\": 18.7,\n    \"zone\": \"bottom\",\n    \"bottom_threshold\": 1.16,\n    \"top_threshold\": 2.45\n  },\n  \"history_analogs\": {\n    \"bottom_event_dates\": [\"2010-08-06\", \"2016-01-29\", \"2020-03-20\"],\n    \"forward_metal_returns\": {\n      \"252\": {\"count\": 3, \"median\": 0.42, \"mean\": 0.39, \"win_rate\": 1.0, \"worst\": 0.18},\n      \"504\": {\"count\": 3, \"median\": 0.71, \"mean\": 0.66, \"win_rate\": 1.0, \"worst\": 0.31}\n    }\n  },\n  \"scenarios\": {\n    \"target\": \"return_to_top\",\n    \"target_ratio\": 2.45,\n    \"miner_multiplier_if_metal_flat\": 2.15,\n    \"metal_multiplier_if_miner_flat\": 0.46,\n    \"metal_drop_pct_if_miner_flat\": 0.54\n  },\n  \"summary\": \"銀礦股價 / 銀價比率落在歷史低分位，顯示礦業股相對白銀偏便宜...\",\n  \"notes\": [\n    \"比率訊號衡量的是『相對估值』，不是單邊價格保證。\",\n    \"礦業股與金屬可能同漲，但礦業股也可能因成本上升、地緣/政策風險、增發稀釋而落後。\",\n    \"建議搭配：礦業股獲利率(成本曲線)、白銀實質利率/美元、投機部位(COT)、ETF 流量等做交叉驗證。\"\n  ]\n}\n```\n\n完整輸出結構見 `templates/output-json.md`。\n</output_schema_summary>\n\n<success_criteria>\n執行成功時應產出：\n\n- [ ] 當前比率與歷史分位數\n- [ ] 估值區間判定（bottom/low/neutral/high/top）\n- [ ] 歷史底部事件列表與去重\n- [ ] 底部事件後的前瞻報酬統計（平均/中位/勝率/最差）\n- [ ] 情境推演（礦業股需漲多少 / 白銀需跌多少）\n- [ ] 結果輸出為指定格式（JSON 或 Markdown）\n- [ ] 視覺化圖表輸出（若需要）\n- [ ] 風險提示與後續研究建議\n</success_criteria>\n",
        "skills/analyze-silver-miner-metal-ratio/methodology.md": "### 比率說明\n\n這個分析把 **銀礦股公司（或礦業股類指數、基金）** 和 **白銀價格** 放在同一個尺度上比較，做成一個比率：\n\n> **相對估值比率 = 銀礦股價格 ÷ 白銀價格**\n\n它不是在問 **白銀會不會漲** ，而是在問更關鍵的一句話：\n\n> **在同樣的白銀價格背景下，市場給礦業股的估值是偏貴、偏便宜，還是普通？**\n\n因為礦業股本質上是 **用白銀賺錢的公司** ，理論上白銀上漲會改善礦業股收入與利潤，但市場不一定會立刻用同樣幅度去調整礦業股價。\n\n所以礦業股相對白銀常常會出現 **落後** 或 **超前** 的波動，這就是比率有用的地方。\n\n把礦業股價格除以白銀價格後，等於把 **白銀這個共同因素** 先扣掉，留下更接近 **市場給礦業股的相對評價** 。\n\n直覺上可以這樣理解：\n\n- **比率偏高**：礦業股相對白銀 **更貴**   \n  可能代表市場對礦業股的樂觀情緒更強、估值更熱，或礦業股的利潤被預期會大幅改善。\n\n- **比率偏低**：礦業股相對白銀 **更便宜**   \n  可能代表市場對礦業股比較保守、礦業股價跟不上白銀，或礦業股有成本、政策、經營等風險被放大解讀。\n\n### 怎麼用它判斷 **接近頂部或底部** ？\n\n這個方法通常會把長期歷史的比率分成三種區域：\n\n1. **底部區（相對低估）**  \n   比率落到歷史偏低的位置，代表 **礦業股相對白銀很便宜** 。\n2. **中性區**  \n   比率在歷史正常範圍，代表相對估值不特別極端。\n3. **頂部區（相對高估）**  \n   比率落到歷史偏高位置，代表 **礦業股相對白銀很貴** 。\n\n重點不是某個固定數字，而是 **在長期分布裡的位置** ：  \n比率越接近歷史低點，越像相對低估；越接近歷史高點，越像相對高估。\n\n### 使用這個方法時，應該注意什麼？\n\n1. **這是相對估值，不是保證獲利的買賣訊號**  \n   比率偏低只表示 **相對便宜** ，不代表立刻上漲。\n2. **礦業股不是白銀的完美影子**  \n   礦業股還受很多因素影響，例如：開採成本、能源價格、匯率、政策與稅制、礦區風險、公司是否增發稀釋、管理品質等。\n3. **最好搭配其他指標交叉驗證**  \n   例如：礦業股利潤狀況、成本曲線、資金流、整體風險偏好等，避免只靠單一比率下結論。",
        "skills/analyze-silver-miner-metal-ratio/references/data-sources.md": "# 數據來源\n\n## 1. 礦業股代理\n\n### 1.1 ETF（建議）\n\n| 代號 | 名稱                                 | 成立日期   | 特點                    |\n|------|--------------------------------------|------------|-------------------------|\n| SIL  | Global X Silver Miners ETF           | 2010-04-19 | 大型礦業股，較穩定      |\n| SILJ | ETFMG Prime Junior Silver Miners ETF | 2012-11-28 | 小型/初級礦業股，高波動 |\n| GDXJ | VanEck Junior Gold Miners ETF        | 2009-11-10 | 含部分銀礦股            |\n\n**SIL 主要成分股（2025 年）：**\n- Wheaton Precious Metals (WPM)\n- Pan American Silver (PAAS)\n- First Majestic Silver (AG)\n- Hecla Mining (HL)\n- Coeur Mining (CDE)\n\n### 1.2 自建指數\n\n若需自訂成分股，可使用以下股票建立等權/市值加權指數：\n\n**主要白銀生產商：**\n| 代號 | 名稱                  | 產量（Moz/年） |\n|------|-----------------------|----------------|\n| CDE  | Coeur Mining          | ~10            |\n| HL   | Hecla Mining          | ~15            |\n| AG   | First Majestic Silver | ~20            |\n| PAAS | Pan American Silver   | ~22            |\n| MAG  | MAG Silver            | 開發階段       |\n\n**計算方式：**\n```python\nminers = ['CDE', 'HL', 'AG', 'PAAS']\npx = yf.download(miners, start='2010-01-01', auto_adjust=True)['Close']\nminer_index = px.mean(axis=1)  # 等權平均\n```\n\n### 1.3 數據獲取\n\n使用 yfinance：\n\n```python\nimport yfinance as yf\n\n# ETF\nsil = yf.download('SIL', start='2010-01-01', auto_adjust=True)['Close']\n\n# 多檔股票\nminers = yf.download(['CDE', 'HL', 'AG'], start='2010-01-01', auto_adjust=True)['Close']\n```\n\n---\n\n## 2. 金屬代理\n\n### 2.1 可用選項\n\n| 代號     | 類型 | 來源    | 交易時間     | 特點             |\n|----------|------|---------|--------------|------------------|\n| SI=F     | 期貨 | COMEX   | 美股交易時間 | 直接反映現貨價   |\n| XAGUSD=X | 現貨 | Yahoo   | 24 小時      | 可能有報價滯後   |\n| SLV      | ETF  | iShares | 美股交易時間 | 含 ETF 溢價/折價 |\n\n**建議優先順序：** SI=F > SLV > XAGUSD=X\n\n### 2.2 數據獲取\n\n```python\nimport yfinance as yf\n\n# 期貨（建議）\nsilver = yf.download('SI=F', start='2010-01-01', auto_adjust=True)['Close']\n\n# ETF（備用）\nslv = yf.download('SLV', start='2010-01-01', auto_adjust=True)['Close']\n```\n\n### 2.3 期貨換月處理\n\nSI=F 代表 COMEX 白銀期貨「近月合約」：\n- 自動換月至下一個活躍合約\n- 可能在換月時產生價格跳躍\n- 長期趨勢分析影響不大\n\n---\n\n## 3. 數據對齊\n\n### 3.1 交易日對齊\n\n礦業股 ETF 與白銀期貨的交易日應相同：\n\n```python\n# 合併數據\npx = pd.concat([miner_series, metal_series], axis=1, join='inner')\npx.columns = ['miner', 'metal']\n```\n\n`join='inner'` 確保只保留兩者都有交易的日期。\n\n### 3.2 頻率轉換\n\n```python\n# 轉為週頻（週五收盤）\nif freq == '1wk':\n    px = px.resample('W-FRI').last()\n\n# 轉為月頻（月末）\nelif freq == '1mo':\n    px = px.resample('M').last()\n\n# 刪除缺值\npx = px.dropna()\n```\n\n### 3.3 缺值處理\n\n| 情況             | 處理方式         |\n|------------------|------------------|\n| 單日缺值（假日） | 前值填補 (ffill) |\n| 連續缺值（停牌） | 刪除該區間       |\n| 數據起點不同     | 取較晚的起點     |\n\n---\n\n## 4. 數據品質\n\n### 4.1 時間範圍\n\n**建議最小範圍：** 10 年\n\n| ETF  | 最早可用日期 | 建議起點   |\n|------|--------------|------------|\n| SIL  | 2010-04-19   | 2010-05-01 |\n| SILJ | 2012-11-28   | 2013-01-01 |\n| SI=F | 更早         | 2010-01-01 |\n\n### 4.2 品質檢查\n\n```python\n# 檢查數據完整性\nprint(f\"數據點數: {len(px)}\")\nprint(f\"缺值數量: {px.isna().sum()}\")\nprint(f\"時間範圍: {px.index.min()} 至 {px.index.max()}\")\n\n# 檢查異常值\nprint(f\"最小值: {px.min()}\")\nprint(f\"最大值: {px.max()}\")\n```\n\n**警告信號：**\n- 缺值超過 5%\n- 最小值為 0 或負值\n- 最大值異常跳躍（可能是股票分割未調整）\n\n---\n\n## 5. 替代數據源\n\n若 yfinance 不可用，考慮以下替代：\n\n### 5.1 免費 API\n\n| 數據源        | 優點          | 缺點       |\n|---------------|---------------|------------|\n| Alpha Vantage | 免費額度      | 需 API Key |\n| Yahoo Finance | yfinance 底層 | 可能有限流 |\n\n### 5.2 付費數據\n\n| 數據源        | 優點       | 缺點 |\n|---------------|------------|------|\n| Quandl/Nasdaq | 機構級品質 | 付費 |\n| Bloomberg     | 專業終端   | 昂貴 |\n\n### 5.3 爬蟲方案\n\n若需從網站抓取：\n- 設計原則見 `thoughts/shared/guide/design-human-like-crawler.md`\n- MacroMicro 爬蟲見 `thoughts/shared/guide/macromicro-highcharts-crawler.md`\n\n---\n\n## 6. 數據更新頻率\n\n| 用途     | 建議更新頻率 |\n|----------|--------------|\n| 長期研究 | 每月         |\n| 中期監控 | 每週         |\n| 短期交易 | 每日         |\n\n本 skill 建議使用週頻數據，每週末更新一次。\n",
        "skills/analyze-silver-miner-metal-ratio/references/input-schema.md": "# 輸入參數定義\n\n## 核心參數\n\n### miner_proxy\n\n| 屬性   | 值                                  |\n|--------|-------------------------------------|\n| 類型   | string                              |\n| 必要性 | Required                            |\n| 預設值 | SIL                                 |\n| 說明   | 銀礦股代表（ETF/指數/股票籃子代號） |\n\n**可用選項：**\n- `SIL` - Global X Silver Miners ETF（建議）\n- `SILJ` - ETFMG Prime Junior Silver Miners ETF\n- `GDXJ` - VanEck Junior Gold Miners ETF（含部分銀礦股）\n\n**自建指數範例：**\n```\nCDE,HL,AG,PAAS,MAG  # 以逗號分隔的股票代號\n```\n\n---\n\n### metal_proxy\n\n| 屬性   | 值                                 |\n|--------|------------------------------------|\n| 類型   | string                             |\n| 必要性 | Required                           |\n| 預設值 | SI=F                               |\n| 說明   | 白銀價格代表（現貨/期貨/ETF 代號） |\n\n**可用選項：**\n- `SI=F` - COMEX 白銀期貨近月（建議）\n- `XAGUSD=X` - 白銀現貨/美元\n- `SLV` - iShares Silver Trust ETF\n\n---\n\n### start_date\n\n| 屬性   | 值                  |\n|--------|---------------------|\n| 類型   | string (YYYY-MM-DD) |\n| 必要性 | Required            |\n| 預設值 | 10 年前             |\n| 說明   | 歷史回溯起點        |\n\n**建議：**\n- 至少 10 年以涵蓋多輪循環\n- SIL ETF 成立於 2010 年，最早可用 2010-04-19\n\n---\n\n### end_date\n\n| 屬性   | 值                  |\n|--------|---------------------|\n| 類型   | string (YYYY-MM-DD) |\n| 必要性 | Optional            |\n| 預設值 | 今日                |\n| 說明   | 分析終點            |\n\n---\n\n### freq\n\n| 屬性   | 值       |\n|--------|----------|\n| 類型   | string   |\n| 必要性 | Optional |\n| 預設值 | 1wk      |\n| 說明   | 取樣頻率 |\n\n**可用選項：**\n- `1d` - 日頻\n- `1wk` - 週頻（建議）\n- `1mo` - 月頻\n\n---\n\n## 進階參數\n\n### smoothing_window\n\n| 屬性   | 值                        |\n|--------|---------------------------|\n| 類型   | int                       |\n| 必要性 | Optional                  |\n| 預設值 | 4                         |\n| 說明   | 比率平滑視窗（週數/月數） |\n\n**建議：**\n- 週頻數據：4（約 1 個月）\n- 月頻數據：3\n\n設為 1 則不平滑。\n\n---\n\n### bottom_quantile\n\n| 屬性   | 值                   |\n|--------|----------------------|\n| 類型   | float (0-1)          |\n| 必要性 | Optional             |\n| 預設值 | 0.20                 |\n| 說明   | 底部估值區分位數門檻 |\n\n**建議範圍：** 0.10 - 0.25\n\n較小的值（如 0.10）定義更極端的底部區間。\n\n---\n\n### top_quantile\n\n| 屬性   | 值                   |\n|--------|----------------------|\n| 類型   | float (0-1)          |\n| 必要性 | Optional             |\n| 預設值 | 0.80                 |\n| 說明   | 頂部估值區分位數門檻 |\n\n**建議範圍：** 0.75 - 0.90\n\n較大的值（如 0.90）定義更極端的頂部區間。\n\n---\n\n### min_separation_days\n\n| 屬性   | 值                     |\n|--------|------------------------|\n| 類型   | int                    |\n| 必要性 | Optional               |\n| 預設值 | 180                    |\n| 說明   | 類比事件去重間隔（天） |\n\n**用途：** 避免同一段低估區間被多次計算。\n\n**建議：** 180（約 6 個月）\n\n---\n\n### forward_horizons\n\n| 屬性   | 值                       |\n|--------|--------------------------|\n| 類型   | list[int]                |\n| 必要性 | Optional                 |\n| 預設值 | [252, 504, 756]          |\n| 說明   | 驗證用的前瞻期（交易日） |\n\n**對應關係：**\n- 252 交易日 ≈ 1 年\n- 504 交易日 ≈ 2 年\n- 756 交易日 ≈ 3 年\n\n---\n\n### scenario_target\n\n| 屬性   | 值            |\n|--------|---------------|\n| 類型   | string        |\n| 必要性 | Optional      |\n| 預設值 | return_to_top |\n| 說明   | 情境推演目標  |\n\n**可用選項：**\n- `return_to_top` - 回到歷史頂部門檻\n- `return_to_median` - 回到歷史中位數\n\n---\n\n## 參數組合範例\n\n### 快速分析（所有預設）\n\n```bash\npython scripts/ratio_analyzer.py --quick\n```\n\n### 保守分析（更極端門檻）\n\n```bash\npython scripts/ratio_analyzer.py \\\n  --bottom-quantile 0.10 \\\n  --top-quantile 0.90 \\\n  --min-separation-days 365\n```\n\n### 短期交易訊號\n\n```bash\npython scripts/ratio_analyzer.py \\\n  --freq 1d \\\n  --smoothing-window 20 \\\n  --forward-horizons 21,63,126\n```\n\n### 長期循環研究\n\n```bash\npython scripts/ratio_analyzer.py \\\n  --freq 1mo \\\n  --smoothing-window 3 \\\n  --start-date 2010-01-01 \\\n  --forward-horizons 12,24,36\n```\n",
        "skills/analyze-silver-miner-metal-ratio/references/method.md": "# 方法論：銀礦股價/銀價比率分析\n\n## 1. 比率定義\n\n### 1.1 基本公式\n\n```\nratio_t = miner_price_t / metal_price_t\n```\n\n其中：\n- `miner_price_t`：t 時點的銀礦股代理價格（如 SIL ETF）\n- `metal_price_t`：t 時點的白銀價格（如 SI=F 期貨）\n\n### 1.2 經濟直覺\n\n此比率衡量「為了購買 1 單位白銀敞口，投資者願意支付多少礦業股權」：\n\n| 比率狀態 | 意義                                         |\n|----------|----------------------------------------------|\n| 比率高   | 礦業股相對白銀偏貴（槓桿溢價高、過度樂觀）   |\n| 比率低   | 礦業股相對白銀偏便宜（可能被低估或反映風險） |\n\n### 1.3 為何用比率而非價差？\n\n- **比率**：無單位，可跨時間比較\n- **價差**：受價格水位影響，2010 年的價差無法與 2025 年直接比較\n\n## 2. 數據處理\n\n### 2.1 頻率選擇\n\n| 頻率 | 適用場景                 | 雜訊程度 |\n|------|--------------------------|----------|\n| 日頻 | 短期交易訊號             | 高       |\n| 週頻 | 中期趨勢判斷（建議預設） | 中       |\n| 月頻 | 長期循環研究             | 低       |\n\n**建議：** 使用週頻（1wk）以平衡雜訊與及時性。\n\n### 2.2 平滑處理\n\n可選使用移動平均降低雜訊：\n\n```python\nratio_smooth = ratio.rolling(smoothing_window).mean()\n```\n\n**建議視窗：**\n- 週頻數據：4 週（約 1 個月）\n- 月頻數據：3 個月\n\n### 2.3 對數轉換（可選）\n\n對於長期研究，可使用對數比率：\n\n```python\nlog_ratio = np.log(miner_price) - np.log(metal_price)\n```\n\n對數比率在長期尺度更穩定，但直覺性較差。\n\n## 3. 分位數計算\n\n### 3.1 歷史分位數\n\n計算當前比率在歷史分佈中的位置：\n\n```python\nratio_pct = (ratio_smooth.rank(pct=True).iloc[-1]) * 100\n```\n\n結果為 0-100 的百分位數：\n- 10 百分位 → 歷史上 90% 的時間比率都比現在高\n- 90 百分位 → 歷史上 90% 的時間比率都比現在低\n\n### 3.2 門檻定義\n\n定義底部/頂部區間的門檻：\n\n```python\nbottom_thr = ratio_smooth.quantile(bottom_quantile)  # 如 0.20\ntop_thr = ratio_smooth.quantile(top_quantile)        # 如 0.80\n```\n\n### 3.3 區間標記\n\n根據當前比率與門檻判斷區間：\n\n```python\nif current_ratio <= bottom_thr:\n    zone = \"bottom\"\nelif current_ratio >= top_thr:\n    zone = \"top\"\nelse:\n    zone = \"neutral\"\n```\n\n## 4. 歷史事件偵測\n\n### 4.1 事件識別\n\n識別歷史上落入底部區間的日期：\n\n```python\nis_bottom = ratio_smooth <= bottom_thr\nbottom_dates = ratio_smooth[is_bottom].index\n```\n\n### 4.2 事件去重\n\n避免同一段低估區被重複計數：\n\n```python\ndedup = []\nlast = None\nfor d in bottom_dates:\n    if last is None or (d - last).days >= min_separation_days:\n        dedup.append(d)\n        last = d\n```\n\n**建議間隔：** 180 天（約 6 個月）\n\n### 4.3 前瞻報酬計算\n\n計算事件後的白銀報酬：\n\n```python\nfor H in forward_horizons:  # 如 [252, 504, 756] 交易日\n    for d in dedup:\n        i = metal.index.get_loc(d)\n        j = i + H\n        if j < len(metal):\n            ret = metal.iloc[j] / metal.iloc[i] - 1\n            returns.append(ret)\n```\n\n### 4.4 統計摘要\n\n計算前瞻報酬的統計量：\n\n| 統計量   | 意義         |\n|----------|--------------|\n| count    | 事件數量     |\n| median   | 中位數報酬   |\n| mean     | 平均報酬     |\n| win_rate | 正報酬的機率 |\n| worst    | 最差情境報酬 |\n\n## 5. 情境推演\n\n### 5.1 目標設定\n\n定義情境目標：\n\n| 目標             | 公式                         |\n|------------------|------------------------------|\n| return_to_top    | target_ratio = top_thr       |\n| return_to_median | target_ratio = median(ratio) |\n\n### 5.2 礦業股倍數計算\n\n若白銀不變，礦業股需要的倍數：\n\n```python\nminer_multiplier = target_ratio / current_ratio\n```\n\n例如：2.45 / 1.14 = 2.15x（需漲 115%）\n\n### 5.3 白銀跌幅計算\n\n若礦業股不變，白銀需要的變化：\n\n```python\nmetal_multiplier = current_ratio / target_ratio\nmetal_drop_pct = 1 - metal_multiplier\n```\n\n例如：1 - (1.14 / 2.45) = 54%（需跌 54%）\n\n## 6. 訊號解讀\n\n### 6.1 底部區間訊號\n\n當 `zone = \"bottom\"` 時：\n\n**正面解讀：**\n- 礦業股相對白銀歷史上很便宜\n- 歷史類比顯示後續白銀多有正報酬\n- 可能是中長期買入機會\n\n**風險提示：**\n- 礦業股可能因成本上升被合理定價\n- 股權稀釋可能壓低礦業股估值\n- 地緣/政策風險可能持續\n\n### 6.2 背離訊號\n\n當出現「比率低 + 白銀高」：\n\n```python\nif zone == \"bottom\" and silver_percentile > 70:\n    signal = \"divergence\"\n```\n\n此背離意味著：\n- 白銀價格已在高位\n- 但礦業股未同步上漲\n- 可能是礦業股追趕機會，或結構性問題\n\n### 6.3 頂部區間訊號\n\n當 `zone = \"top\"` 時：\n\n**可能意涵：**\n- 礦業股相對白銀過度樂觀\n- 槓桿溢價過高\n- 需警惕均值回歸風險\n\n## 7. 方法論限制\n\n### 7.1 樣本量問題\n\n- 歷史底部事件通常僅 3-5 次\n- 統計推論能力有限\n- 不應過度信賴勝率\n\n### 7.2 代理選擇偏誤\n\n- SIL vs SILJ 成分股差異大\n- ETF 可能有追蹤誤差\n- 自建指數需處理存活者偏誤\n\n### 7.3 結構性變化\n\n- 礦業股成本結構可能永久改變\n- 新礦山/技術可能改變供給曲線\n- 過往關係可能不再適用\n\n### 7.4 單因子限制\n\n- 比率訊號應結合其他因子\n- 建議搭配：成本曲線、COT 持倉、ETF 流量、美元/利率\n",
        "skills/analyze-silver-miner-metal-ratio/templates/output-json.md": "# JSON 輸出模板\n\n## 完整輸出結構\n\n```json\n{\n  \"skill\": \"analyze_silver_miner_metal_ratio\",\n  \"version\": \"0.1.0\",\n  \"generated_at\": \"2025-01-21T10:30:00Z\",\n\n  \"inputs\": {\n    \"miner_proxy\": \"SIL\",\n    \"metal_proxy\": \"SI=F\",\n    \"start_date\": \"2010-01-01\",\n    \"end_date\": \"2025-01-21\",\n    \"freq\": \"1wk\",\n    \"smoothing_window\": 4,\n    \"bottom_quantile\": 0.20,\n    \"top_quantile\": 0.80,\n    \"min_separation_days\": 180,\n    \"forward_horizons\": [252, 504, 756],\n    \"scenario_target\": \"return_to_top\"\n  },\n\n  \"current\": {\n    \"date\": \"2025-01-17\",\n    \"miner_price\": 29.45,\n    \"metal_price\": 30.82,\n    \"ratio\": 0.9555,\n    \"ratio_smoothed\": 0.9612,\n    \"ratio_percentile\": 12.5,\n    \"zone\": \"bottom\",\n    \"bottom_threshold\": 0.9800,\n    \"top_threshold\": 1.4200,\n    \"median_threshold\": 1.1500\n  },\n\n  \"history_analogs\": {\n    \"total_observations\": 780,\n    \"bottom_event_count\": 5,\n    \"bottom_event_dates\": [\n      \"2010-08-06\",\n      \"2015-12-18\",\n      \"2016-01-29\",\n      \"2020-03-20\",\n      \"2022-09-30\"\n    ],\n    \"forward_metal_returns\": {\n      \"252\": {\n        \"horizon_label\": \"1 year\",\n        \"count\": 5,\n        \"median\": 0.42,\n        \"mean\": 0.39,\n        \"std\": 0.25,\n        \"win_rate\": 0.80,\n        \"best\": 0.78,\n        \"worst\": -0.12\n      },\n      \"504\": {\n        \"horizon_label\": \"2 years\",\n        \"count\": 4,\n        \"median\": 0.65,\n        \"mean\": 0.58,\n        \"std\": 0.30,\n        \"win_rate\": 1.00,\n        \"best\": 0.95,\n        \"worst\": 0.22\n      },\n      \"756\": {\n        \"horizon_label\": \"3 years\",\n        \"count\": 3,\n        \"median\": 0.71,\n        \"mean\": 0.66,\n        \"std\": 0.28,\n        \"win_rate\": 1.00,\n        \"best\": 0.98,\n        \"worst\": 0.31\n      }\n    }\n  },\n\n  \"scenarios\": {\n    \"target\": \"return_to_top\",\n    \"target_ratio\": 1.4200,\n    \"current_ratio\": 0.9612,\n    \"miner_multiplier_if_metal_flat\": 1.4773,\n    \"miner_gain_pct_if_metal_flat\": 0.4773,\n    \"metal_multiplier_if_miner_flat\": 0.6769,\n    \"metal_drop_pct_if_miner_flat\": 0.3231,\n    \"interpretation\": {\n      \"miner_scenario\": \"若白銀不變，礦業股需漲 47.7% 才回到頂部估值\",\n      \"metal_scenario\": \"若礦業股不變，白銀需跌 32.3% 才回到頂部估值\"\n    }\n  },\n\n  \"divergence_check\": {\n    \"current_metal_percentile\": 75.2,\n    \"is_divergence\": true,\n    \"divergence_type\": \"ratio_low_metal_high\",\n    \"interpretation\": \"比率處於底部區間，但白銀價格處於相對高位，形成背離訊號\"\n  },\n\n  \"summary\": \"銀礦股價/銀價比率目前處於歷史 12.5 百分位（底部區間），顯示礦業股相對白銀偏便宜。歷史上類似情境後，白銀 1 年報酬中位數為 42%，勝率 80%。若白銀不變，礦業股需漲 47.7% 才回到頂部估值。\",\n\n  \"notes\": [\n    \"比率訊號衡量的是『相對估值』，不是單邊價格保證。\",\n    \"歷史類比樣本量僅 5 次，統計推論能力有限。\",\n    \"礦業股可能因成本上升、地緣/政策風險、增發稀釋而合理落後。\",\n    \"建議搭配：礦業股成本曲線、COT 持倉、ETF 流量、美元/實質利率做交叉驗證。\"\n  ],\n\n  \"recommended_next_checks\": [\n    \"檢查 SIL 主要成分股的 AISC 成本趨勢\",\n    \"查看 COT 報告中的投機淨部位\",\n    \"觀察 SLV ETF 持倉量變化\",\n    \"比較 GDX/GDXJ 是否有類似的比率低估\"\n  ]\n}\n```\n\n## 欄位說明\n\n### inputs\n\n| 欄位                | 類型   | 說明             |\n|---------------------|--------|------------------|\n| miner_proxy         | string | 礦業股代理代號   |\n| metal_proxy         | string | 金屬代理代號     |\n| start_date          | string | 分析起點         |\n| end_date            | string | 分析終點         |\n| freq                | string | 取樣頻率         |\n| smoothing_window    | int    | 平滑視窗         |\n| bottom_quantile     | float  | 底部門檻分位數   |\n| top_quantile        | float  | 頂部門檻分位數   |\n| min_separation_days | int    | 事件去重間隔     |\n| forward_horizons    | list   | 前瞻期（交易日） |\n| scenario_target     | string | 情境目標         |\n\n### current\n\n| 欄位             | 類型   | 說明                           |\n|------------------|--------|--------------------------------|\n| date             | string | 最新數據日期                   |\n| miner_price      | float  | 礦業股代理價格                 |\n| metal_price      | float  | 金屬價格                       |\n| ratio            | float  | 原始比率                       |\n| ratio_smoothed   | float  | 平滑後比率                     |\n| ratio_percentile | float  | 歷史分位數（0-100）            |\n| zone             | string | 區間標記（bottom/neutral/top） |\n| bottom_threshold | float  | 底部門檻值                     |\n| top_threshold    | float  | 頂部門檻值                     |\n| median_threshold | float  | 中位數值                       |\n\n### history_analogs.forward_metal_returns\n\n| 欄位          | 類型   | 說明       |\n|---------------|--------|------------|\n| horizon_label | string | 前瞻期標籤 |\n| count         | int    | 事件數量   |\n| median        | float  | 中位數報酬 |\n| mean          | float  | 平均報酬   |\n| std           | float  | 標準差     |\n| win_rate      | float  | 正報酬機率 |\n| best          | float  | 最佳報酬   |\n| worst         | float  | 最差報酬   |\n\n### scenarios\n\n| 欄位                           | 類型   | 說明                           |\n|--------------------------------|--------|--------------------------------|\n| target                         | string | 情境目標                       |\n| target_ratio                   | float  | 目標比率                       |\n| current_ratio                  | float  | 當前比率                       |\n| miner_multiplier_if_metal_flat | float  | 礦業股需要的倍數（白銀不變時） |\n| miner_gain_pct_if_metal_flat   | float  | 礦業股需要的漲幅百分比         |\n| metal_multiplier_if_miner_flat | float  | 白銀的倍數（礦業股不變時）     |\n| metal_drop_pct_if_miner_flat   | float  | 白銀需要下跌的百分比           |\n\n### divergence_check\n\n| 欄位                     | 類型    | 說明                 |\n|--------------------------|---------|----------------------|\n| current_metal_percentile | float   | 金屬價格的歷史分位數 |\n| is_divergence            | boolean | 是否存在背離         |\n| divergence_type          | string  | 背離類型             |\n| interpretation           | string  | 背離解讀             |\n",
        "skills/analyze-silver-miner-metal-ratio/templates/output-markdown.md": "# Markdown 報告模板\n\n## 報告結構\n\n```markdown\n# 銀礦股價/銀價比率分析報告\n\n**生成時間：** {generated_at}\n**數據區間：** {start_date} 至 {end_date}\n\n---\n\n## 一句話結論\n\n{summary}\n\n---\n\n## 當前狀態\n\n| 指標       | 數值                          |\n|------------|-------------------------------|\n| 礦業股代理 | {miner_proxy} ({miner_price}) |\n| 白銀代理   | {metal_proxy} ({metal_price}) |\n| 當前比率   | {ratio:.4f}                   |\n| 平滑比率   | {ratio_smoothed:.4f}          |\n| 歷史分位數 | {ratio_percentile:.1f}%       |\n| 估值區間   | {zone}                        |\n\n**門檻參考：**\n- 底部門檻（{bottom_quantile*100}%）：{bottom_threshold:.4f}\n- 頂部門檻（{top_quantile*100}%）：{top_threshold:.4f}\n- 歷史中位數：{median_threshold:.4f}\n\n---\n\n## 歷史類比分析\n\n### 底部事件列表\n\n歷史上比率落入底部區間（≤ {bottom_quantile*100}%）的日期：\n\n| # | 事件日期 | 備註 |\n|---|----------|------|\n| 1 | {date_1} |      |\n| 2 | {date_2} |      |\n| 3 | {date_3} |      |\n...\n\n### 前瞻報酬統計\n\n底部事件後白銀的表現：\n\n| 前瞻期 | 事件數 | 中位數報酬 | 平均報酬 | 勝率  | 最差情境 |\n|--------|--------|------------|----------|-------|----------|\n| 1 年   | {n}    | {median}%  | {mean}%  | {wr}% | {worst}% |\n| 2 年   | {n}    | {median}%  | {mean}%  | {wr}% | {worst}% |\n| 3 年   | {n}    | {median}%  | {mean}%  | {wr}% | {worst}% |\n\n**解讀：** 歷史上底部事件後 1 年，白銀中位數報酬為 {median_1y}%，勝率 {wr_1y}%。\n\n---\n\n## 情境推演\n\n**目標：** 比率回到{scenario_target_label}（{target_ratio:.4f}）\n\n### 情境 A：白銀不變\n\n若白銀價格維持 {metal_price}：\n- 礦業股需漲至 {target_miner_price}\n- **漲幅：{miner_gain_pct:.1f}%**\n\n### 情境 B：礦業股不變\n\n若礦業股價格維持 {miner_price}：\n- 白銀需跌至 {target_metal_price}\n- **跌幅：{metal_drop_pct:.1f}%**\n\n**解讀：** 這是極端情境的量化邊界，實際可能是兩者同時調整。\n\n---\n\n## 背離檢查\n\n| 指標           | 當前狀態                |\n|----------------|-------------------------|\n| 比率分位數     | {ratio_percentile:.1f}% |\n| 白銀價格分位數 | {metal_percentile:.1f}% |\n| 是否存在背離   | {is_divergence}         |\n\n{divergence_interpretation}\n\n---\n\n## 風險提示\n\n1. **比率訊號不是價格保證**：衡量「相對估值」，不預測單邊價格。\n\n2. **樣本量有限**：歷史底部事件僅 {event_count} 次，統計推論能力有限。\n\n3. **結構性風險**：礦業股可能因以下原因合理落後：\n   - 成本上升（AISC 走高）\n   - 股權稀釋（增發融資）\n   - 地緣/政策風險\n   - ESG 合規成本\n\n4. **ETF 結構差異**：SIL vs SILJ 成分股差異大，需注意代理選擇。\n\n---\n\n## 後續研究建議\n\n1. **成本驗證**：檢查 SIL 主要成分股的 AISC 成本趨勢\n2. **持倉分析**：查看 COT 報告中的白銀投機淨部位\n3. **資金流向**：觀察 SLV ETF 持倉量變化\n4. **跨市場比較**：比較 GDX/GDXJ 是否有類似的比率低估\n\n---\n\n## 附錄：分析參數\n\n| 參數         | 值                       |\n|--------------|--------------------------|\n| 礦業股代理   | {miner_proxy}            |\n| 金屬代理     | {metal_proxy}            |\n| 分析起點     | {start_date}             |\n| 分析終點     | {end_date}               |\n| 取樣頻率     | {freq}                   |\n| 平滑視窗     | {smoothing_window}       |\n| 底部分位門檻 | {bottom_quantile}        |\n| 頂部分位門檻 | {top_quantile}           |\n| 事件去重間隔 | {min_separation_days} 天 |\n| 前瞻期       | {forward_horizons}       |\n\n---\n\n*本報告由 analyze-silver-miner-metal-ratio skill 自動生成*\n```\n\n## 使用說明\n\n### 1. 從 JSON 輸出轉換\n\n```python\nimport json\n\nwith open('result.json') as f:\n    data = json.load(f)\n\n# 使用模板生成報告\nreport = generate_markdown_report(data)\n```\n\n### 2. 變數替換\n\n模板中的 `{variable}` 需替換為實際數值：\n\n| 變數               | 來源                                             |\n|--------------------|--------------------------------------------------|\n| {generated_at}     | 生成時間                                         |\n| {miner_proxy}      | inputs.miner_proxy                               |\n| {ratio_percentile} | current.ratio_percentile                         |\n| {zone}             | current.zone                                     |\n| {median_1y}        | history_analogs.forward_metal_returns.252.median |\n| {miner_gain_pct}   | scenarios.miner_gain_pct_if_metal_flat           |\n\n### 3. 條件區塊\n\n根據分析結果調整報告內容：\n\n```python\nif data['current']['zone'] == 'bottom':\n    conclusion = \"礦業股相對白銀處於歷史低估區間\"\nelif data['current']['zone'] == 'top':\n    conclusion = \"礦業股相對白銀處於歷史高估區間\"\nelse:\n    conclusion = \"礦業股相對白銀處於中性區間\"\n```\n",
        "skills/analyze-silver-miner-metal-ratio/workflows/analyze.md": "# Workflow: 完整情境分析\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/input-schema.md - 完整參數定義\n2. references/methodology.md - 方法論與計算邏輯\n3. references/data-sources.md - 數據來源說明\n</required_reading>\n\n<process>\n\n## Step 1: 確認分析參數\n\n確認用戶提供或使用預設的分析參數：\n\n| 參數                | 預設值          | 用戶指定值 |\n|---------------------|-----------------|------------|\n| miner_proxy         | SIL             |            |\n| metal_proxy         | SI=F            |            |\n| start_date          | 10 年前         |            |\n| end_date            | 今日            |            |\n| freq                | 1wk             |            |\n| smoothing_window    | 4               |            |\n| bottom_quantile     | 0.20            |            |\n| top_quantile        | 0.80            |            |\n| min_separation_days | 180             |            |\n| forward_horizons    | [252, 504, 756] |            |\n| scenario_target     | return_to_top   |            |\n\n若用戶未指定，使用預設值執行。\n\n## Step 2: 執行分析腳本\n\n使用確認的參數執行腳本：\n\n```bash\ncd skills/analyze-silver-miner-metal-ratio\npython scripts/ratio_analyzer.py \\\n  --miner-proxy {miner_proxy} \\\n  --metal-proxy {metal_proxy} \\\n  --start-date {start_date} \\\n  --freq {freq} \\\n  --smoothing-window {smoothing_window} \\\n  --bottom-quantile {bottom_quantile} \\\n  --top-quantile {top_quantile} \\\n  --min-separation-days {min_separation_days} \\\n  --scenario-target {scenario_target} \\\n  --output result.json\n```\n\n**快速執行（使用所有預設值）：**\n```bash\npython scripts/ratio_analyzer.py --quick\n```\n\n## Step 3: 解讀分析結果\n\n### 3.1 當前狀態判讀\n\n檢查 `current` 區塊：\n\n```json\n\"current\": {\n  \"ratio\": 1.14,\n  \"ratio_percentile\": 18.7,\n  \"zone\": \"bottom\",\n  \"bottom_threshold\": 1.16,\n  \"top_threshold\": 2.45\n}\n```\n\n**解讀邏輯：**\n- `ratio_percentile` < 20 → 礦業股相對白銀處於歷史低檔\n- `zone` = \"bottom\" → 確認處於底部估值區\n- 對照 `bottom_threshold` 和當前 `ratio` 驗證\n\n### 3.2 歷史類比分析\n\n檢查 `history_analogs` 區塊：\n\n```json\n\"history_analogs\": {\n  \"bottom_event_dates\": [\"2010-08-06\", \"2016-01-29\", \"2020-03-20\"],\n  \"forward_metal_returns\": {\n    \"252\": {\"count\": 3, \"median\": 0.42, \"win_rate\": 1.0, \"worst\": 0.18}\n  }\n}\n```\n\n**解讀邏輯：**\n- `bottom_event_dates`：歷史上落入底部區間的日期\n- `forward_metal_returns`：這些日期後白銀的 1/2/3 年報酬\n- `win_rate`：正報酬的機率\n- `worst`：最差情境的報酬\n\n**風險提示：** 樣本量僅 3 次，統計意義有限。\n\n### 3.3 情境推演\n\n檢查 `scenarios` 區塊：\n\n```json\n\"scenarios\": {\n  \"target\": \"return_to_top\",\n  \"target_ratio\": 2.45,\n  \"miner_multiplier_if_metal_flat\": 2.15,\n  \"metal_drop_pct_if_miner_flat\": 0.54\n}\n```\n\n**解讀邏輯：**\n- 若白銀不變，礦業股需漲 `2.15x`（115%）才回到頂部估值\n- 若礦業股不變，白銀需跌 `54%` 才回到頂部估值\n- 這是極端情境邊界，實際可能是兩者同時調整\n\n## Step 4: 生成視覺化圖表（可選）\n\n若需要視覺化，執行畫圖腳本：\n\n**基本版（比率走勢 + 價格）：**\n```bash\npython scripts/ratio_plotter.py --quick --output-dir ../../output\n```\n\n**完整版（含底部事件標記 + 前瞻報酬統計）：**\n```bash\npython scripts/ratio_plotter.py --comprehensive --start-date 2010-01-01 --output-dir ../../output\n```\n\n**完整版圖表包含：**\n1. 比率走勢圖 + 底部/頂部區間填充 + 底部事件垂直線標記\n2. 當前位置標記（含分位數百分比）\n3. 底部事件後白銀前瞻報酬柱狀圖（中位數報酬 + 勝率）\n4. 價格走勢對比（正規化）+ 情境推演標題\n\n圖表輸出路徑：\n- 基本版：`output/sil_silver_ratio_YYYY-MM-DD.png`\n- 完整版：`output/sil_silver_ratio_comprehensive_YYYY-MM-DD.png`\n\n## Step 5: 生成報告\n\n根據分析結果生成報告，使用 `templates/output-markdown.md` 或 `templates/output-json.md` 格式。\n\n**報告應包含：**\n1. 一句話結論（當前是相對低估/高估/中性）\n2. 當前比率與分位數\n3. 類比證據（歷史事件與前瞻報酬）\n4. 情境推演（回到頂部需要的條件）\n5. 視覺化圖表（若生成）\n6. 風險提示（比率訊號的限制）\n7. 後續研究建議\n\n## Step 6: 後續研究建議\n\n根據分析結果提供交叉驗證建議：\n\n**若處於底部區間：**\n- 檢查礦業股成本曲線（AISC 是否上升）\n- 檢查 ETF 流量（SLV、SIL 的資金流向）\n- 檢查 COT 持倉（投機部位是否極端）\n- 檢查白銀實質利率與美元指數\n\n**若處於頂部區間：**\n- 檢查礦業股是否有增產/併購動作\n- 檢查成本通膨（柴油、工資、試劑）\n- 評估均值回歸風險\n\n</process>\n\n<success_criteria>\n完成情境分析時應確認：\n\n- [ ] 參數確認（使用預設或用戶指定）\n- [ ] 腳本執行成功\n- [ ] 當前狀態解讀（比率、分位數、區間）\n- [ ] 歷史類比分析（事件日期、前瞻報酬）\n- [ ] 情境推演（礦業股倍數、白銀跌幅）\n- [ ] 視覺化圖表輸出（若需要）\n- [ ] 報告生成（含風險提示）\n- [ ] 後續研究建議\n</success_criteria>\n",
        "skills/analyze-silver-miner-metal-ratio/workflows/data-research.md": "# Workflow: 數據源研究\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/data-sources.md - 數據來源詳細說明\n</required_reading>\n\n<process>\n\n## Step 1: 理解數據需求\n\n本 skill 需要兩類數據：\n\n| 數據類型   | 用途                 | 預設代理    |\n|------------|----------------------|-------------|\n| 礦業股價格 | 銀礦股板塊的價格代表 | SIL (ETF)   |\n| 金屬價格   | 白銀本體的價格代表   | SI=F (期貨) |\n\n**關鍵要求：**\n- 兩者的交易日需可對齊\n- 建議使用相同的數據來源（如都用 yfinance）\n- 頻率可選日/週/月\n\n## Step 2: 礦業股代理選擇\n\n### 主要選項：ETF\n\n| ETF  | 名稱                                 | 特點                    |\n|------|--------------------------------------|-------------------------|\n| SIL  | Global X Silver Miners ETF           | 大型銀礦股，較穩定      |\n| SILJ | ETFMG Prime Junior Silver Miners ETF | 小型/初級礦業股，波動大 |\n| GDXJ | VanEck Junior Gold Miners ETF        | 含部分銀礦股，較混合    |\n\n**建議：** 使用 SIL 作為主要代理，SILJ 作為槓桿/投機參考。\n\n### 替代選項：自建指數\n\n若 ETF 不符合需求，可自建等權礦業股指數：\n\n```python\nminers = ['CDE', 'HL', 'AG', 'PAAS', 'MAG']  # 主要白銀生產商\nweights = [0.2] * 5  # 等權\n\n# 使用 yfinance 抓取\npx = yf.download(miners, start=start_date, auto_adjust=True)['Close']\nminer_index = (px * weights).sum(axis=1)\n```\n\n**注意：** 自建指數需處理缺值、除權除息、成分股變動。\n\n## Step 3: 金屬代理選擇\n\n### 主要選項\n\n| 代號     | 類型 | 來源    | 特點             |\n|----------|------|---------|------------------|\n| SI=F     | 期貨 | COMEX   | 直接反映現貨價   |\n| XAGUSD=X | 現貨 | Yahoo   | 24 小時交易      |\n| SLV      | ETF  | iShares | 含 ETF 溢價/折價 |\n\n**建議：** 優先使用 SI=F，若交易日對齊困難則使用 SLV。\n\n### 數據獲取\n\n使用 yfinance：\n\n```python\nimport yfinance as yf\n\n# 期貨\nsilver = yf.download('SI=F', start='2010-01-01', auto_adjust=True)['Close']\n\n# ETF\nsilver_etf = yf.download('SLV', start='2010-01-01', auto_adjust=True)['Close']\n```\n\n## Step 4: 數據對齊處理\n\n### 頻率轉換\n\n```python\n# 轉為週頻（週五收盤）\nif freq == '1wk':\n    px = px.resample('W-FRI').last()\n\n# 轉為月頻\nelif freq == '1mo':\n    px = px.resample('M').last()\n```\n\n### 缺值處理\n\n```python\n# 對齊交易日\npx = px.dropna(how='all')\n\n# 前值填補（適用於假日缺值）\npx = px.ffill()\n```\n\n### 常見問題\n\n| 問題                 | 解決方案              |\n|----------------------|-----------------------|\n| 期貨假日無交易       | 使用前值填補 (ffill)  |\n| ETF 與期貨交易日不同 | 取交集日期            |\n| 股票分割/配息        | 使用 auto_adjust=True |\n\n## Step 5: 數據品質檢查\n\n執行以下檢查：\n\n```python\n# 檢查時間範圍\nprint(f\"數據起點: {px.index.min()}\")\nprint(f\"數據終點: {px.index.max()}\")\n\n# 檢查缺值\nprint(f\"缺值數量: {px.isna().sum()}\")\n\n# 檢查異常值\nprint(f\"最小值: {px.min()}\")\nprint(f\"最大值: {px.max()}\")\n```\n\n**警告信號：**\n- 缺值超過 5% → 考慮換數據源\n- 最小值為 0 或負值 → 數據品質問題\n- 時間範圍不足 10 年 → 歷史類比可能不足\n\n## Step 6: 替代數據源\n\n若 yfinance 不可用或品質不佳，考慮以下替代：\n\n| 數據源        | 類型 | 適用場景     |\n|---------------|------|--------------|\n| Alpha Vantage | API  | 需要 API Key |\n| Quandl/Nasdaq | 付費 | 機構級數據   |\n| MacroMicro    | 爬蟲 | 含衍生指標   |\n| TradingView   | 手動 | 圖表匯出     |\n\n**爬蟲參考：**\n- 設計原則見 `thoughts/shared/guide/design-human-like-crawler.md`\n- MacroMicro 爬蟲見 `thoughts/shared/guide/macromicro-highcharts-crawler.md`\n\n</process>\n\n<success_criteria>\n數據研究完成時應確認：\n\n- [ ] 礦業股代理選定（ETF 或自建指數）\n- [ ] 金屬代理選定（期貨或 ETF）\n- [ ] 數據可通過 yfinance 獲取\n- [ ] 交易日可對齊\n- [ ] 缺值處理策略確定\n- [ ] 時間範圍足夠（建議 ≥10 年）\n- [ ] 品質檢查通過\n</success_criteria>\n",
        "skills/analyze-us-bank-credit-deposit-decoupling/SKILL.md": "---\nname: analyze-us-bank-credit-deposit-decoupling\ndescription: 分析銀行貸款與存款之間的「信貸創造脫鉤」現象，追蹤存款的絕對收縮與回升軌跡，用以辨識聯準會緊縮政策在銀行體系內部的真實傳導效果。\n---\n\n<essential_principles>\n\n<principle name=\"credit_deposit_accounting\">\n**信貸創造的基本會計邏輯**\n\n傳統銀行體系下，貸款創造存款：\n- 銀行發放貸款 → 借款人帳戶增加存款\n- 理論上：新增貸款 ≈ 新增存款\n\n當這個關係「脫鉤」時：\n- 貸款持續擴張，但存款沒有等比例增加\n- 代表有「力量」在抽走體系內的存款\n- QT 環境下，資金流向貨幣市場基金、國債等\n</principle>\n\n<principle name=\"deposit_dynamics\">\n**存款動態的關鍵觀察**\n\n2022-2023 年 QT 週期的關鍵特徵：\n\n1. **存款絕對收縮期**（2022 Q2 - 2023 Q1）\n   - 存款累積變化一度下探至 **-1.2 兆美元**\n   - 代表存款總量比基期（2022年6月）還少 1.2 兆\n\n2. **存款回升期**（2023 Q2 至今）\n   - 存款逐步回升，但仍遠落後貸款增量\n   - 當前存款累積變化約 +0.5 兆美元\n\n3. **持續脫鉤**\n   - 貸款累積增加約 +2.1 兆美元\n   - 落差（Gap）約 1.6 兆美元\n</principle>\n\n<principle name=\"key_metrics\">\n**核心分析指標**\n\n| 指標                   | 定義                                   | 意義                       |\n|------------------------|----------------------------------------|----------------------------|\n| 貸款累積變化           | loans(t) - loans(t0)                   | 銀行資產端擴張             |\n| 存款累積變化           | deposits(t) - deposits(t0)             | 銀行負債端變化             |\n| Decoupling Gap         | 貸款累積變化 - 存款累積變化            | 脫鉤程度                   |\n| 存款最大回撤           | min(存款累積變化)                      | 存款收縮最嚴重的程度       |\n| 存款回撤恢復比率       | (當前存款變化 - 最低點) / |最低點|     | 存款從低谷回升的程度       |\n| Deposit Stress Ratio   | Gap / 貸款累積變化                     | 每單位新增貸款的存款缺口比 |\n</principle>\n\n<principle name=\"data_sources\">\n**數據來源（FRED 公開 CSV，無需 API Key）**\n\n| 指標         | FRED Series ID   | 說明                                                  | 公開 URL                                              |\n|--------------|------------------|-------------------------------------------------------|-------------------------------------------------------|\n| 銀行貸款總量 | TOTLL            | Loans and Leases in Bank Credit, All Commercial Banks | https://fred.stlouisfed.org/graph/fredgraph.csv?id=TOTLL |\n| 銀行存款總量 | DPSACBW027SBOG   | Deposits, All Commercial Banks                        | https://fred.stlouisfed.org/graph/fredgraph.csv?id=DPSACBW027SBOG |\n\n資料頻率：Weekly（週頻）\n對齊方式：以最新共同日期為準\n</principle>\n\n</essential_principles>\n\n<objective>\n分析銀行信貸與存款的脫鉤現象，追蹤存款的收縮與回升動態。\n\n輸出三層訊號：\n1. **Cumulative Changes**: 貸款與存款的累積變化量\n2. **Deposit Dynamics**: 存款的最大回撤、回升程度、當前狀態\n3. **Decoupling Assessment**: 脫鉤程度評估與宏觀解讀\n</objective>\n\n<quick_start>\n\n**最快的方式：使用 FRED 公開 CSV（無需 API Key）**\n\n**Step 1：安裝依賴**\n```bash\npip install pandas numpy requests matplotlib\n```\n\n**Step 2：執行快速分析**\n```bash\ncd scripts\npython decoupling_analyzer.py --quick\n```\n\n**Step 3：執行完整分析（含視覺化）**\n```bash\npython decoupling_analyzer.py \\\n  --start 2022-06-01 \\\n  --output ../../output/decoupling_$(date +%Y-%m-%d).json\n```\n\n**Step 4：生成視覺化圖表（Bloomberg 風格面積圖）**\n```bash\npython visualize_decoupling.py \\\n  --start 2022-06-01 \\\n  --output ../../output/credit_deposit_decoupling_$(date +%Y-%m-%d).png\n```\n\n**輸出範例**：\n```json\n{\n  \"period\": \"2022-06 to 2026-01\",\n  \"cumulative_changes\": {\n    \"loans_billion_usd\": 2070.5,\n    \"deposits_billion_usd\": 506.8,\n    \"gap_billion_usd\": 1563.7\n  },\n  \"deposit_dynamics\": {\n    \"max_drawdown_billion_usd\": -1200.0,\n    \"max_drawdown_date\": \"2023-04-12\",\n    \"recovery_from_trough_billion_usd\": 1706.8,\n    \"recovery_ratio\": 1.42\n  },\n  \"assessment\": {\n    \"decoupling_status\": \"severe\",\n    \"deposit_stress_ratio\": 0.755,\n    \"phase\": \"recovery_but_lagging\"\n  }\n}\n```\n\n</quick_start>\n\n<intake>\n需要進行什麼分析？\n\n1. **快速檢查** - 查看最新的信貸-存款脫鉤狀態\n2. **完整分析** - 執行完整分析並生成視覺化圖表\n3. **方法論學習** - 了解信貸創造脫鉤的會計邏輯與宏觀意義\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                     | Action                                               |\n|------------------------------|------------------------------------------------------|\n| 1, \"快速\", \"quick\", \"check\"  | 執行 `python scripts/decoupling_analyzer.py --quick` |\n| 2, \"完整\", \"full\", \"analyze\" | 執行完整分析並生成圖表                               |\n| 3, \"學習\", \"方法論\", \"why\"   | 閱讀 `references/methodology.md`                     |\n| 提供參數 (如日期範圍)        | 使用指定參數執行分析                                 |\n\n**路由後，執行對應腳本並生成視覺化圖表。**\n</routing>\n\n<visualization>\n\n**視覺化輸出：信貸-存款脫鉤面積圖**\n\n採用 **Bloomberg Intelligence 風格**，參考 FRED 原生圖表設計：\n\n**圖表特徵**：\n1. **面積圖（Area Chart）**：清楚顯示累積變化的體量\n2. **藍色面積**：貸款累積變化（Loans & Leases）\n3. **紅色面積**：存款累積變化（Deposits）\n4. **0 軸線**：清楚標示基準線\n5. **數值標註**：最新數值標示在圖表右側\n\n**配色方案（遵循 Bloomberg 規範）**：\n- 背景：`#1a1a2e`（深藍黑）\n- 貸款面積：`#4a90d9`（藍色）\n- 存款面積：`#d94a4a`（紅色）\n- 文字：`#ffffff`（白色）\n- 網格：`#2d2d44`（暗灰）\n\n**快速繪圖**：\n```bash\ncd scripts\npython visualize_decoupling.py \\\n  --start 2022-06-01 \\\n  --output ../../output/credit_deposit_decoupling_YYYY-MM-DD.png\n```\n\n**輸出路徑**：`output/credit_deposit_decoupling_YYYY-MM-DD.png`\n\n**圖表解讀**：\n- 藍色面積持續擴大 → 銀行持續放貸\n- 紅色面積一度為負 → 存款絕對收縮（2022-2023）\n- 紅色面積回升但落後藍色 → 脫鉤持續\n\n</visualization>\n\n<input_schema>\n\n<parameter name=\"start_date\" required=\"true\">\n**Type**: string (ISO YYYY-MM-DD)\n**Description**: 分析起始日期\n**Default**: \"2022-06-01\"\n**Example**: \"2022-06-01\"\n</parameter>\n\n<parameter name=\"end_date\" required=\"false\">\n**Type**: string (ISO YYYY-MM-DD)\n**Description**: 分析結束日期\n**Default**: 今天\n</parameter>\n\n</input_schema>\n\n<output_schema>\n**完整輸出結構**：\n```json\n{\n  \"skill\": \"analyze_bank_credit_deposit_decoupling\",\n  \"version\": \"2.0.0\",\n  \"status\": \"success\",\n  \"analysis_period\": {\n    \"start\": \"2022-06-01\",\n    \"end\": \"2026-01-07\"\n  },\n  \"data_sources\": {\n    \"loans\": {\n      \"series_id\": \"TOTLL\",\n      \"url\": \"https://fred.stlouisfed.org/graph/fredgraph.csv?id=TOTLL\"\n    },\n    \"deposits\": {\n      \"series_id\": \"DPSACBW027SBOG\",\n      \"url\": \"https://fred.stlouisfed.org/graph/fredgraph.csv?id=DPSACBW027SBOG\"\n    }\n  },\n  \"cumulative_changes\": {\n    \"loans_billion_usd\": 2070.5,\n    \"deposits_billion_usd\": 506.8,\n    \"gap_billion_usd\": 1563.7,\n    \"gap_trillion_usd\": 1.56\n  },\n  \"deposit_dynamics\": {\n    \"max_drawdown_billion_usd\": -1200.0,\n    \"max_drawdown_date\": \"2023-04-12\",\n    \"current_vs_trough_billion_usd\": 1706.8,\n    \"recovery_ratio\": 1.42,\n    \"phase\": \"recovery_but_lagging\"\n  },\n  \"assessment\": {\n    \"decoupling_status\": \"severe\",\n    \"deposit_stress_ratio\": 0.755,\n    \"interpretation\": \"每新增 $1 貸款，僅有 $0.24 形成存款\"\n  },\n  \"macro_implication\": \"銀行信貸與存款出現嚴重脫鉤...\"\n}\n```\n</output_schema>\n\n<success_criteria>\n分析成功時應產出：\n\n- [ ] 銀行貸款、存款兩個指標的時序數據\n- [ ] 累積變化量計算（從基期開始）\n- [ ] 存款最大回撤（Maximum Drawdown）及日期\n- [ ] 存款回升程度（Recovery Ratio）\n- [ ] Decoupling Gap 與 Deposit Stress Ratio\n- [ ] **Bloomberg 風格面積圖**（output/credit_deposit_decoupling_YYYY-MM-DD.png）\n- [ ] 可操作的宏觀解讀\n</success_criteria>\n\n<scripts_index>\n| Script                  | Command                   | Purpose                    |\n|-------------------------|---------------------------|----------------------------|\n| decoupling_analyzer.py  | `--quick`                 | 快速檢查最新訊號           |\n| decoupling_analyzer.py  | `--start DATE`            | 完整分析                   |\n| visualize_decoupling.py | `--start DATE --output`   | 生成 Bloomberg 風格面積圖  |\n</scripts_index>\n",
        "skills/analyze-us-bank-credit-deposit-decoupling/references/data-sources.md": "# 數據來源說明\n\n本文件說明美國銀行信貸存款脫鉤分析所需的數據來源與獲取方式。\n\n---\n\n## 1. FRED API 概述\n\n### 1.1 什麼是 FRED\n\nFRED（Federal Reserve Economic Data）是聖路易斯聯邦儲備銀行維護的經濟數據庫：\n- 超過 800,000 個經濟時間序列\n- 完全免費、公開\n- 提供 REST API\n\n### 1.2 API Key 申請\n\n1. 前往 https://fred.stlouisfed.org/docs/api/api_key.html\n2. 註冊帳號（免費）\n3. 申請 API Key\n4. 設定環境變數：\n```bash\nexport FRED_API_KEY=\"your_api_key_here\"\n```\n\n---\n\n## 2. 核心數據指標\n\n### 2.1 銀行貸款總量 (TOTLL)\n\n| 屬性          | 值                                                    |\n|---------------|-------------------------------------------------------|\n| **Series ID** | TOTLL                                                 |\n| **名稱**      | Loans and Leases in Bank Credit, All Commercial Banks |\n| **單位**      | Billions of U.S. Dollars                              |\n| **頻率**      | Weekly, Ending Wednesday                              |\n| **季節調整**  | Not Seasonally Adjusted                               |\n| **起始日期**  | 1947-01-01                                            |\n\n**說明**：\n- 美國所有商業銀行的放款與租賃總額\n- 反映銀行「資產端」擴張\n- 高度領先於信用循環、經濟景氣\n\n**URL**: https://fred.stlouisfed.org/series/TOTLL\n\n### 2.2 銀行存款總量 (DPSACBW027SBOG)\n\n| 屬性          | 值                             |\n|---------------|--------------------------------|\n| **Series ID** | DPSACBW027SBOG                 |\n| **名稱**      | Deposits, All Commercial Banks |\n| **單位**      | Billions of U.S. Dollars       |\n| **頻率**      | Weekly, Ending Wednesday       |\n| **季節調整**  | Seasonally Adjusted            |\n| **起始日期**  | 1973-01-03                     |\n\n**說明**：\n- 美國所有商業銀行的存款總額\n- 反映銀行「負債端」資金來源\n- 與貨幣政策、資金流向高度相關\n\n**URL**: https://fred.stlouisfed.org/series/DPSACBW027SBOG\n\n### 2.3 隔夜逆回購 (RRPONTSYD)\n\n| 屬性          | 值                                                                                       |\n|---------------|------------------------------------------------------------------------------------------|\n| **Series ID** | RRPONTSYD                                                                                |\n| **名稱**      | Overnight Reverse Repurchase Agreements: Treasury Securities Sold by the Federal Reserve |\n| **單位**      | Billions of U.S. Dollars                                                                 |\n| **頻率**      | Daily                                                                                    |\n| **季節調整**  | Not Seasonally Adjusted                                                                  |\n| **起始日期**  | 2013-09-23                                                                               |\n\n**說明**：\n- 聯準會隔夜逆回購操作規模\n- 貨幣市場基金主要參與者\n- 作為「資金被吸出銀行體系」的 proxy\n\n**URL**: https://fred.stlouisfed.org/series/RRPONTSYD\n\n---\n\n## 3. 數據獲取程式碼\n\n### 3.1 使用 fredapi\n\n```python\nfrom fredapi import Fred\nimport os\n\n# 初始化\nfred = Fred(api_key=os.environ.get('FRED_API_KEY'))\n\n# 抓取數據\nloans = fred.get_series('TOTLL', start_date='2022-06-01', end_date='2026-01-23')\ndeposits = fred.get_series('DPSACBW027SBOG', start_date='2022-06-01', end_date='2026-01-23')\nrrp = fred.get_series('RRPONTSYD', start_date='2022-06-01', end_date='2026-01-23')\n```\n\n### 3.2 數據對齊\n\n由於 RRP 是日頻，需要對齊至週頻：\n\n```python\n# 將 RRP 重採樣至週頻（週三結束）\nrrp_weekly = rrp.resample('W-WED').last()\n\n# 對齊到共同日期\ncommon_dates = loans.index.intersection(deposits.index).intersection(rrp_weekly.index)\nloans = loans.loc[common_dates]\ndeposits = deposits.loc[common_dates]\nrrp = rrp_weekly.loc[common_dates]\n```\n\n---\n\n## 4. Fallback 替代方案\n\n### 4.1 當 FRED API 不可用時\n\n| 替代方案          | 說明                  |\n|-------------------|-----------------------|\n| **FRED 網站下載** | 直接從網站下載 CSV    |\n| **Quandl (FRED)** | Quandl 鏡像 FRED 數據 |\n| **本地快取**      | 使用已快取的歷史數據  |\n\n### 4.2 CSV 下載方式\n\n```\nhttps://fred.stlouisfed.org/graph/fredgraph.csv?id=TOTLL\nhttps://fred.stlouisfed.org/graph/fredgraph.csv?id=DPSACBW027SBOG\nhttps://fred.stlouisfed.org/graph/fredgraph.csv?id=RRPONTSYD\n```\n\n---\n\n## 5. 快取策略\n\n### 5.1 建議快取設定\n\n| 數據           | 更新頻率 | 建議快取時間 |\n|----------------|----------|--------------|\n| TOTLL          | 週頻     | 1 天         |\n| DPSACBW027SBOG | 週頻     | 1 天         |\n| RRPONTSYD      | 日頻     | 12 小時      |\n\n### 5.2 快取檔案結構\n\n```\ncache/\n├── loans_TOTLL.json\n│   ├── data: [...]\n│   ├── fetched_at: \"2026-01-23T10:00:00Z\"\n│   └── source: \"FRED\"\n├── deposits_DPSACBW027SBOG.json\n└── rrp_RRPONTSYD.json\n```\n\n---\n\n## 6. 數據品質檢查\n\n### 6.1 檢查清單\n\n- [ ] 數據起始日期正確\n- [ ] 無異常缺失值\n- [ ] 數值在合理範圍內\n- [ ] 日期索引連續（週頻）\n\n### 6.2 異常值處理\n\n```python\n# 檢查異常跳動（超過 20% 週變化）\npct_change = loans.pct_change()\nanomalies = pct_change[abs(pct_change) > 0.20]\nif len(anomalies) > 0:\n    print(f\"Warning: {len(anomalies)} anomalies detected\")\n```\n\n---\n\n## 7. 補充數據來源\n\n### 7.1 TGA（財政部一般帳戶）\n\n| 屬性          | 值                             |\n|---------------|--------------------------------|\n| **Series ID** | WTREGEN                        |\n| **說明**      | 可用於進一步分解流動性吸收來源 |\n\n### 7.2 銀行準備金\n\n| 屬性          | 值                      |\n|---------------|-------------------------|\n| **Series ID** | TOTRESNS                |\n| **說明**      | 銀行在 Fed 的準備金餘額 |\n\n### 7.3 H.8 原始報告\n\n更細緻的銀行資產負債表數據：\nhttps://www.federalreserve.gov/releases/h8/current/\n\n---\n\n## 8. API 使用限制\n\n### 8.1 FRED API 限制\n\n| 限制             | 值                   |\n|------------------|----------------------|\n| 請求頻率         | 120 requests/minute  |\n| 每次請求最大筆數 | 100,000 observations |\n\n### 8.2 最佳實踐\n\n- 使用本地快取減少 API 請求\n- 批量請求多個序列\n- 避免在迴圈中重複請求相同數據\n",
        "skills/analyze-us-bank-credit-deposit-decoupling/references/historical-episodes.md": "# 歷史案例對照\n\n本文件記錄歷史上的信貸-存款脫鉤事件，作為當前分析的參考基準。\n\n---\n\n## 1. 2017-2019 首次 QT 週期\n\n### 1.1 背景\n\n- **起始時間**：2017 年 10 月\n- **結束時間**：2019 年 9 月\n- **Fed 資產負債表**：從 4.5 兆縮減至約 3.8 兆美元\n\n### 1.2 脫鉤特徵\n\n| 指標 | 數值 |\n|------|------|\n| 累積貸款變化 | +$600B |\n| 累積存款變化 | +$200B |\n| Decoupling Gap | $400B |\n| deposit_stress_ratio | 0.67 |\n\n### 1.3 市場影響\n\n- 2018 年 Q4 股市大跌（Fed 政策失誤）\n- 銀行間隔夜利率波動加劇\n- Fed 被迫於 2019 年 9 月提前結束 QT\n\n### 1.4 關鍵教訓\n\n> 首次 QT 顯示：即使銀行繼續放貸，負債端壓力仍可導致金融條件收緊。\n\n---\n\n## 2. 2020 疫情 QE 期間\n\n### 2.1 背景\n\n- **起始時間**：2020 年 3 月\n- **結束時間**：2022 年 3 月\n- **Fed 資產負債表**：從 4 兆擴張至約 9 兆美元\n\n### 2.2 特徵（反向脫鉤）\n\n| 指標 | 數值 |\n|------|------|\n| 累積貸款變化 | +$500B |\n| 累積存款變化 | +$4.5T |\n| Decoupling Gap | -$4.0T（負值） |\n| deposit_stress_ratio | N/A（存款超額增加） |\n\n### 2.3 機制\n\n- QE 購買資產 → 銀行準備金增加 → 存款創造\n- 財政刺激 → 直接注入存款\n- 存款增長遠超貸款增長\n\n### 2.4 關鍵教訓\n\n> QE 環境下，信貸-存款關係逆轉：存款創造超過貸款。\n\n---\n\n## 3. 2022-2024 當前 QT 週期\n\n### 3.1 背景\n\n- **起始時間**：2022 年 6 月\n- **持續中**\n- **Fed 資產負債表**：從 9 兆目標縮減\n\n### 3.2 脫鉤特徵（截至 2024 年底）\n\n| 指標 | 數值 |\n|------|------|\n| 累積貸款變化 | +$1.8T |\n| 累積存款變化 | +$0.2T |\n| Decoupling Gap | $1.6T |\n| deposit_stress_ratio | 0.89 |\n| RRP 高峰 | $2.5T（2022 年底） |\n\n### 3.3 RRP 動態\n\n| 時期 | RRP 規模 | 影響 |\n|------|----------|------|\n| 2022 Q2-Q4 | 快速上升至 $2.5T | 大量存款流出銀行 |\n| 2023 Q1-Q4 | 維持高位 | 銀行負債端壓力持續 |\n| 2024 Q1-Q4 | 逐步下降至 $500B | 壓力部分緩解 |\n\n### 3.4 SVB 事件（2023 年 3 月）\n\n- **觸發因素**：存款外逃 + 債券虧損\n- **與脫鉤的關係**：\n  - SVB 過度依賴大額存款\n  - QT 環境下存款流失加速\n  - 凸顯 deposit_stress_ratio 高企的風險\n\n### 3.5 關鍵觀察\n\n> 當前 QT 週期的脫鉤程度（stress_ratio 0.89）遠超 2017-2019 首次 QT（0.67），但市場尚未出現類似 2018 Q4 的劇烈調整。\n\n---\n\n## 4. 歷史分位數參考\n\n### 4.1 deposit_stress_ratio 歷史分布\n\n| 分位數 | 數值 | 對應事件 |\n|--------|------|----------|\n| 10th | -0.5 | 強 QE 期間 |\n| 25th | -0.1 | 輕度 QE |\n| 50th | 0.2 | 正常環境 |\n| 75th | 0.5 | 輕度 QT |\n| 90th | 0.7 | 2017-2019 QT |\n| 95th | 0.9 | 當前 QT（2024） |\n\n### 4.2 歷史極值\n\n| 極值 | 數值 | 日期 | 事件 |\n|------|------|------|------|\n| 歷史最低 | -2.0 | 2020 Q2 | 疫情 QE 高峰 |\n| 歷史最高 | 0.9 | 2024 Q3 | 當前 QT |\n\n---\n\n## 5. 訊號對照表\n\n### 5.1 歷史訊號與後續表現\n\n| 日期 | stress_ratio | 訊號 | 3 個月後 SPX | 6 個月後 SPX |\n|------|-------------|------|-------------|-------------|\n| 2018-09 | 0.65 | high | -14% | -7% |\n| 2019-09 | 0.60 | high | +5% | +12% |\n| 2023-03 | 0.80 | extreme | +6% | +15% |\n| 2024-09 | 0.89 | extreme | ? | ? |\n\n### 5.2 解讀\n\n> 高 stress_ratio 本身不直接預測股市走勢，但會增加金融系統脆弱性。\n> 觸發因素（如 SVB）出現時，高壓力環境會放大衝擊。\n\n---\n\n## 6. 當前環境對照\n\n### 6.1 與 2017-2019 QT 比較\n\n| 維度 | 2017-2019 | 2022-present |\n|------|-----------|--------------|\n| stress_ratio 峰值 | 0.67 | 0.89 |\n| 持續時間 | 24 個月 | 30+ 個月 |\n| 銀行危機事件 | 無 | SVB, Signature, First Republic |\n| RRP 峰值 | $250B | $2.5T |\n| Fed 反應 | 提前結束 QT | 持續進行 |\n\n### 6.2 關鍵差異\n\n1. **RRP 規模**：當前 QT 的 RRP 規模遠大於首次 QT\n2. **起點更高**：從 9 兆縮表 vs 從 4.5 兆縮表\n3. **通膨背景**：高通膨限制 Fed 政策轉向空間\n4. **銀行韌性**：已有銀行危機事件（但已處理）\n\n---\n\n## 7. 使用指南\n\n### 7.1 如何使用歷史對照\n\n1. 計算當前 stress_ratio\n2. 對照歷史分位數，判斷當前位置\n3. 參考相似歷史時期的後續發展\n4. 注意差異因素（背景、政策、觸發條件）\n\n### 7.2 限制\n\n- 歷史不會簡單重複\n- 每次 QT 的背景條件不同\n- 市場結構與參與者會變化\n- RRP 工具在 2013 年後才存在\n",
        "skills/analyze-us-bank-credit-deposit-decoupling/references/methodology.md": "### 1.1 傳統銀行信貸創造\n\n在傳統銀行體系中，貸款創造存款（Loans Create Deposits）：\n\n```\n銀行發放 $100 貸款\n    ↓\n借款人帳戶增加 $100 存款\n    ↓\n銀行資產端：貸款 +$100\n銀行負債端：存款 +$100\n```\n\n**關鍵假設**：在封閉系統內，新增貸款 ≈ 新增存款\n\n### 1.2 脫鉤發生的條件\n\n當以下情況發生時，信貸-存款關係會脫鉤：\n\n| 情況         | 機制                       | 效果               |\n|--------------|----------------------------|--------------------|\n| **QT 縮表**  | Fed 減少資產負債表規模     | 系統性存款減少     |\n| **RRP 吸收** | 貨幣市場基金將資金存入 Fed | 存款流出銀行體系   |\n| **TGA 增加** | 財政部帳戶餘額增加         | 存款從銀行流向 Fed |\n\n---\n\n## 2. Decoupling Gap 計算\n\n### 2.1 核心公式\n\n以分析起始日 t₀ 為基準：\n\n```\nloan_change(t) = loans(t) - loans(t₀)      # 累積新增貸款\ndeposit_change(t) = deposits(t) - deposits(t₀)  # 累積新增存款\n\ndecoupling_gap(t) = loan_change(t) - deposit_change(t)\n```\n\n### 2.2 解讀\n\n| Gap 狀態       | 意義                                       |\n|----------------|--------------------------------------------|\n| Gap > 0 且擴大 | 貸款創造的存款「消失」了，被某處吸走       |\n| Gap ≈ 0        | 傳統信貸創造機制正常運作                   |\n| Gap < 0        | 存款增加超過貸款（可能來自 QE 或財政注入） |\n\n---\n\n## 3. Deposit Stress Ratio\n\n### 3.1 定義\n\n```\ndeposit_stress_ratio = decoupling_gap / loan_change\n```\n\n### 3.2 解讀\n\n| Ratio     | 壓力等級 | 意義                         |\n|-----------|----------|------------------------------|\n| < 0.3     | 低       | 正常信貸創造，存款跟上貸款   |\n| 0.3 - 0.5 | 中       | 輕度脫鉤，部分存款流失       |\n| 0.5 - 0.7 | 高       | 顯著脫鉤，銀行需搶存款       |\n| > 0.7     | 極高     | 嚴重負債端壓力，融資成本上升 |\n\n### 3.3 示例\n\n若在分析期間：\n- 累積新增貸款：2.1 兆美元\n- 累積新增存款：0.5 兆美元\n- Decoupling Gap：1.6 兆美元\n\n則：\n```\ndeposit_stress_ratio = 1.6 / 2.1 = 0.76\n```\n\n**解讀**：76% 的新增貸款沒有對應的存款創造，銀行面臨嚴重的負債端壓力。\n\n---\n\n## 4. RRP 中和效果驗證\n\n### 4.1 假設\n\n若 Gap 主要由 RRP 吸收解釋，則：\n\n```\ndecoupling_gap ≈ rrp_change\n```\n\n### 4.2 驗證方法\n\n計算相關係數：\n\n```python\ncorrelation = np.corrcoef(decoupling_gap, rrp_change)[0, 1]\n```\n\n### 4.3 解讀\n\n| 相關係數    | 解讀                                       |\n|-------------|--------------------------------------------|\n| r > 0.8     | 高度相關，RRP 是主要驅動因素               |\n| r = 0.5-0.8 | 中度相關，RRP 部分解釋                     |\n| r < 0.5     | 低相關，需考慮其他因素（TGA、QT 直接效果） |\n\n---\n\n## 5. 隱性緊縮判定邏輯\n\n### 5.1 判定標準\n\n| 條件組合                                          | 判定                                |\n|---------------------------------------------------|-------------------------------------|\n| 貸款持續上升 + 存款顯著落後 + Gap 與 RRP 高度相關 | **Hidden Balance Sheet Tightening** |\n| 貸款下降 + 存款下降                               | Traditional Credit Tightening       |\n| 貸款上升 + 存款同步上升                           | Neutral / Expansionary              |\n\n### 5.2 信心水準\n\n| 信心   | 條件                                                    |\n|--------|---------------------------------------------------------|\n| High   | deposit_stress_ratio > 0.5 且 RRP correlation > 0.8     |\n| Medium | deposit_stress_ratio 0.3-0.5 或 RRP correlation 0.5-0.8 |\n| Low    | 條件不明確或數據不完整                                  |\n\n---\n\n## 6. 宏觀意涵\n\n### 6.1 核心洞察\n\n當偵測到隱性緊縮時：\n- 緊縮並非來自銀行不放貸（傳統敘事）\n- 而是來自負債端（存款）被政策工具抽乾\n- 市場需要「額外搶存款」來支撐既有負債結構\n\n### 6.2 市場影響\n\n| 層面         | 影響                               |\n|--------------|------------------------------------|\n| **銀行**     | NIM（淨利差）壓力，存款成本上升    |\n| **信貸市場** | 信貸條件可能收緊（即使貸款量未縮） |\n| **利率**     | 短端利率可能上升，曲線可能反轉     |\n| **流動性**   | 系統性流動性收緊                   |\n\n---\n\n## 7. 限制與假設\n\n### 7.1 資料限制\n\n- FRED 數據為週頻，可能錯過日內波動\n- RRP 為日頻，需對齊至週頻\n- 部分數據有修正（revisions）\n\n### 7.2 模型假設\n\n- 假設封閉系統（忽略跨境資金流動）\n- 假設 RRP 是主要的存款吸收來源\n- 假設銀行資產負債表調整即時反映\n\n### 7.3 不適用情境\n\n- 金融危機期間（非常規政策干擾）\n- QE 環境（存款創造超過貸款）\n- 重大法規變更期間\n\n---\n\n## 8. 參考資料\n\n- Pozsar, Z. (2022). \"Money, Credit and Velocity\", Credit Suisse\n- Singh, M. (2016). \"Collateral and Monetary Policy\", IMF\n- Federal Reserve Statistical Release H.8\n- NY Fed Open Market Operations Data\n",
        "skills/analyze-us-bank-credit-deposit-decoupling/templates/output-json.md": "# JSON 輸出模板\n\n本文件定義美國銀行信貸存款脫鉤分析的 JSON 輸出結構。\n\n---\n\n## 完整輸出結構\n\n```json\n{\n  \"skill\": \"analyze_bank_credit_deposit_decoupling\",\n  \"version\": \"0.1.0\",\n  \"generated_at\": \"2026-01-23T10:30:00Z\",\n\n  \"status\": \"success\",\n\n  \"analysis_period\": {\n    \"start\": \"2022-06-01\",\n    \"end\": \"2026-01-23\",\n    \"frequency\": \"weekly\",\n    \"observation_count\": 187\n  },\n\n  \"data_sources\": {\n    \"loans\": {\n      \"series_id\": \"TOTLL\",\n      \"name\": \"Loans and Leases in Bank Credit, All Commercial Banks\",\n      \"unit\": \"Billions USD\",\n      \"latest_value\": 12450.5,\n      \"latest_date\": \"2026-01-22\"\n    },\n    \"deposits\": {\n      \"series_id\": \"DPSACBW027SBOG\",\n      \"name\": \"Deposits, All Commercial Banks\",\n      \"unit\": \"Billions USD\",\n      \"latest_value\": 17890.2,\n      \"latest_date\": \"2026-01-22\"\n    },\n    \"rrp\": {\n      \"series_id\": \"RRPONTSYD\",\n      \"name\": \"Overnight Reverse Repurchase Agreements\",\n      \"unit\": \"Billions USD\",\n      \"latest_value\": 520.8,\n      \"latest_date\": \"2026-01-22\"\n    }\n  },\n\n  \"cumulative_changes\": {\n    \"base_date\": \"2022-06-01\",\n    \"new_loans_billion_usd\": 2100.5,\n    \"new_deposits_billion_usd\": 520.3,\n    \"rrp_change_billion_usd\": 1450.2,\n    \"unit\": \"Billions USD\"\n  },\n\n  \"decoupling_metrics\": {\n    \"decoupling_gap_billion_usd\": 1580.2,\n    \"decoupling_gap_trillion_usd\": 1.58,\n    \"deposit_stress_ratio\": 0.752,\n    \"deposit_stress_ratio_percentile\": 0.94,\n    \"rrp_gap_correlation\": 0.87\n  },\n\n  \"time_series\": {\n    \"dates\": [\"2022-06-01\", \"2022-06-08\", \"...\"],\n    \"loan_change\": [0, 15.2, \"...\"],\n    \"deposit_change\": [0, 8.1, \"...\"],\n    \"rrp_change\": [0, 12.5, \"...\"],\n    \"decoupling_gap\": [0, 7.1, \"...\"],\n    \"stress_ratio\": [0, 0.47, \"...\"]\n  },\n\n  \"assessment\": {\n    \"tightening_type\": \"hidden_balance_sheet_tightening\",\n    \"tightening_type_label\": \"隱性資產負債表緊縮\",\n    \"primary_driver\": \"RRP_liquidity_absorption\",\n    \"primary_driver_label\": \"RRP 流動性吸收\",\n    \"confidence\": \"high\",\n    \"confidence_score\": 0.85\n  },\n\n  \"stress_level\": {\n    \"current\": \"extreme\",\n    \"thresholds\": {\n      \"low\": 0.3,\n      \"medium\": 0.5,\n      \"high\": 0.7,\n      \"extreme\": 0.85\n    }\n  },\n\n  \"historical_context\": {\n    \"current_percentile\": 0.94,\n    \"comparable_periods\": [\n      {\n        \"period\": \"2018 Q4\",\n        \"stress_ratio\": 0.67,\n        \"outcome\": \"Fed 提前結束 QT\"\n      },\n      {\n        \"period\": \"2023 Q1\",\n        \"stress_ratio\": 0.80,\n        \"outcome\": \"SVB 危機\"\n      }\n    ]\n  },\n\n  \"macro_implication\": \"本次緊縮並非來自銀行縮手放貸，而是聯準會透過 RRP 抽走體系存款，導致市場必須爭奪有限的存款來支撐既有負債結構，屬於「隱性金融緊縮」狀態。\",\n\n  \"recommended_next_checks\": [\n    \"監控 RRP 規模變化趨勢\",\n    \"觀察銀行存款利率是否上升\",\n    \"追蹤 SOFR-Fed Funds 利差變化\",\n    \"關注大額存款（>$250K）外逃跡象\"\n  ],\n\n  \"caveats\": [\n    \"本分析假設 RRP 是主要的存款吸收來源，忽略 TGA 等其他因素\",\n    \"週頻數據可能錯過日內波動\",\n    \"deposit_stress_ratio 歷史分位數基於 2013 年後數據\"\n  ],\n\n  \"artifacts\": {\n    \"chart_path\": \"output/decoupling_chart_2026-01-23.png\",\n    \"cache_files\": [\n      \"cache/loans_TOTLL.json\",\n      \"cache/deposits_DPSACBW027SBOG.json\",\n      \"cache/rrp_RRPONTSYD.json\"\n    ]\n  }\n}\n```\n\n---\n\n## 欄位說明\n\n### 頂層欄位\n\n| 欄位           | 類型   | 說明                                  |\n|----------------|--------|---------------------------------------|\n| `skill`        | string | 技能名稱                              |\n| `version`      | string | 輸出格式版本                          |\n| `generated_at` | string | 生成時間（ISO 8601）                  |\n| `status`       | string | 執行狀態（success / partial / error） |\n\n### analysis_period\n\n| 欄位                | 類型    | 說明         |\n|---------------------|---------|--------------|\n| `start`             | string  | 分析起始日期 |\n| `end`               | string  | 分析結束日期 |\n| `frequency`         | string  | 數據頻率     |\n| `observation_count` | integer | 觀測值數量   |\n\n### decoupling_metrics\n\n| 欄位                         | 類型  | 說明                 |\n|------------------------------|-------|----------------------|\n| `decoupling_gap_billion_usd` | float | 脫鉤落差（十億美元） |\n| `deposit_stress_ratio`       | float | 存款壓力比率（0-1）  |\n| `rrp_gap_correlation`        | float | RRP 與 Gap 相關係數  |\n\n### assessment\n\n| 欄位              | 類型   | 可能值                                                                  |\n|-------------------|--------|-------------------------------------------------------------------------|\n| `tightening_type` | string | hidden_balance_sheet_tightening, traditional_credit_tightening, neutral |\n| `primary_driver`  | string | RRP_liquidity_absorption, credit_contraction, both                      |\n| `confidence`      | string | high, medium, low                                                       |\n\n---\n\n## 簡化輸出（quick 模式）\n\n```json\n{\n  \"as_of\": \"2026-01-23\",\n  \"decoupling_gap_trillion_usd\": 1.58,\n  \"deposit_stress_ratio\": 0.75,\n  \"tightening_type\": \"hidden_balance_sheet_tightening\",\n  \"confidence\": \"high\",\n  \"summary\": \"銀行負債端壓力顯著，隱性緊縮狀態\"\n}\n```\n",
        "skills/analyze-us-bank-credit-deposit-decoupling/templates/output-markdown.md": "# Markdown 報告模板\n\n本文件定義美國銀行信貸存款脫鉤分析的 Markdown 報告格式。\n\n---\n\n## 報告模板\n\n```markdown\n# 銀行信貸-存款脫鉤分析報告\n\n**生成時間**: {{generated_at}}\n**分析期間**: {{start_date}} 至 {{end_date}}\n\n---\n\n## TL;DR\n\n{{macro_implication}}\n\n**關鍵數據**：\n- 脫鉤落差：{{decoupling_gap_trillion_usd}} 兆美元\n- 存款壓力比率：{{deposit_stress_ratio}} ({{stress_level}})\n- 緊縮類型：{{tightening_type_label}}\n- 信心水準：{{confidence}}\n\n---\n\n## 1. 數據摘要\n\n### 1.1 累積變化量（自 {{base_date}}）\n\n| 指標     | 累積變化                               |\n|----------|----------------------------------------|\n| 銀行貸款 | +{{new_loans_trillion_usd}} 兆美元     |\n| 銀行存款 | +{{new_deposits_trillion_usd}} 兆美元  |\n| 脫鉤落差 | {{decoupling_gap_trillion_usd}} 兆美元 |\n\n### 1.2 最新數據點\n\n| 指標         | 數值                  | 日期              |\n|--------------|-----------------------|-------------------|\n| 銀行貸款總量 | {{loans_latest}} B    | {{loans_date}}    |\n| 銀行存款總量 | {{deposits_latest}} B | {{deposits_date}} |\n| 隔夜逆回購   | {{rrp_latest}} B      | {{rrp_date}}      |\n\n---\n\n## 2. 脫鉤分析\n\n### 2.1 Decoupling Gap\n\n**定義**: 累積新增貸款 - 累積新增存款\n\n**當前值**: {{decoupling_gap_trillion_usd}} 兆美元\n\n**解讀**: {{decoupling_gap_interpretation}}\n\n### 2.2 Deposit Stress Ratio\n\n**定義**: Decoupling Gap / 累積新增貸款\n\n**當前值**: {{deposit_stress_ratio}} (歷史分位數: {{stress_percentile}})\n\n**壓力等級**: {{stress_level}}\n\n| 等級 | 門檻    | 意義           |\n|------|---------|----------------|\n| 低   | < 0.3   | 正常信貸創造   |\n| 中   | 0.3-0.5 | 輕度脫鉤       |\n| 高   | 0.5-0.7 | 顯著脫鉤       |\n| 極高 | > 0.7   | 嚴重負債端壓力 |\n\n### 2.3 RRP 相關性驗證\n\n**RRP 與 Gap 相關係數**: {{rrp_correlation}}\n\n**解讀**: {{rrp_correlation_interpretation}}\n\n---\n\n## 3. 緊縮判定\n\n### 3.1 判定結果\n\n- **緊縮類型**: {{tightening_type_label}}\n- **主要驅動因素**: {{primary_driver_label}}\n- **信心水準**: {{confidence}}\n\n### 3.2 判定依據\n\n{{assessment_reasoning}}\n\n---\n\n## 4. 歷史對照\n\n### 4.1 當前位置\n\n- 歷史分位數: {{historical_percentile}}\n- 可比較時期: {{comparable_periods}}\n\n### 4.2 類似歷史事件\n\n| 時期 | stress_ratio | 後續發展 |\n|------|--------------|----------|\n{{#each comparable_events}}\n| {{period}} | {{ratio}} | {{outcome}} |\n{{/each}}\n\n---\n\n## 5. 宏觀意涵\n\n{{macro_implication_detailed}}\n\n### 5.1 對銀行的影響\n\n{{bank_impact}}\n\n### 5.2 對信貸市場的影響\n\n{{credit_impact}}\n\n### 5.3 對流動性的影響\n\n{{liquidity_impact}}\n\n---\n\n## 6. 建議後續追蹤\n\n{{#each recommended_checks}}\n- {{this}}\n{{/each}}\n\n---\n\n## 7. 資料來源與限制\n\n### 7.1 數據來源\n\n| 指標       | FRED Series ID | 頻率   |\n|------------|----------------|--------|\n| 銀行貸款   | TOTLL          | Weekly |\n| 銀行存款   | DPSACBW027SBOG | Weekly |\n| 隔夜逆回購 | RRPONTSYD      | Daily  |\n\n### 7.2 分析限制\n\n{{#each caveats}}\n- {{this}}\n{{/each}}\n\n---\n\n## 8. 附錄：視覺化圖表\n\n![信貸-存款脫鉤分析圖]({{chart_path}})\n\n---\n\n*報告由 analyze-us-bank-credit-deposit-decoupling skill 生成*\n*版本: {{version}}*\n```\n\n---\n\n## 範例輸出\n\n```markdown\n# 銀行信貸-存款脫鉤分析報告\n\n**生成時間**: 2026-01-23 10:30:00 UTC\n**分析期間**: 2022-06-01 至 2026-01-23\n\n---\n\n## TL;DR\n\n本次緊縮並非來自銀行縮手放貸，而是聯準會透過 RRP 抽走體系存款，導致市場必須爭奪有限的存款來支撐既有負債結構，屬於「隱性金融緊縮」狀態。\n\n**關鍵數據**：\n- 脫鉤落差：1.6 兆美元\n- 存款壓力比率：0.76 (極高)\n- 緊縮類型：隱性資產負債表緊縮\n- 信心水準：高\n\n---\n\n## 1. 數據摘要\n\n### 1.1 累積變化量（自 2022-06-01）\n\n| 指標     | 累積變化    |\n|----------|-------------|\n| 銀行貸款 | +2.1 兆美元 |\n| 銀行存款 | +0.5 兆美元 |\n| 脫鉤落差 | 1.6 兆美元  |\n\n...（後續內容）\n```\n",
        "skills/analyze-us-bank-credit-deposit-decoupling/workflows/analyze.md": "# Workflow: 完整信貸-存款脫鉤分析\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/methodology.md - 理解計算邏輯與解讀方式\n2. references/data-sources.md - 了解數據來源與 API 使用\n</required_reading>\n\n<process>\n\n## Step 1: 環境準備\n\n**1.1 確認依賴已安裝**\n```bash\npip install pandas numpy fredapi matplotlib\n```\n\n**1.2 設定 FRED API Key**\n```bash\n# 從 https://fred.stlouisfed.org/docs/api/api_key.html 取得 API Key\nexport FRED_API_KEY=\"your_api_key_here\"\n```\n\n## Step 2: 資料擷取（Data Ingestion）\n\n**2.1 執行數據抓取腳本**\n```bash\ncd scripts\npython decoupling_analyzer.py \\\n  --fetch-only \\\n  --start 2022-06-01 \\\n  --end 2026-01-23\n```\n\n**2.2 驗證數據完整性**\n\n檢查輸出的 cache 檔案：\n```bash\nls cache/\n# 應包含：\n# - loans_TOTLL.json\n# - deposits_DPSACBW027SBOG.json\n# - rrp_RRPONTSYD.json\n```\n\n**2.3 數據來源說明**\n\n| 指標 | FRED Series ID | 單位 | 頻率 |\n|------|----------------|------|------|\n| 銀行貸款總量 | TOTLL | Billions USD | Weekly |\n| 銀行存款總量 | DPSACBW027SBOG | Billions USD | Weekly |\n| 隔夜逆回購 | RRPONTSYD | Billions USD | Daily |\n\n## Step 3: 資料處理（Data Processing）\n\n**3.1 計算累積變化量**\n\n以分析起始日為基準點，計算各指標的累積變化：\n\n```python\n# 虛擬碼\nloan_change = loans - loans.iloc[0]      # 累積新增貸款\ndeposit_change = deposits - deposits.iloc[0]  # 累積新增存款\nrrp_change = rrp - rrp.iloc[0]           # 累積 RRP 變化\n```\n\n**3.2 計算 Decoupling Gap**\n\n```python\ndecoupling_gap = loan_change - deposit_change\n```\n\n**3.3 計算 Deposit Stress Ratio**\n\n```python\ndeposit_stress_ratio = decoupling_gap / loan_change\n```\n\n**3.4 執行完整計算**\n```bash\npython decoupling_analyzer.py \\\n  --start 2022-06-01 \\\n  --end 2026-01-23 \\\n  --output result.json\n```\n\n## Step 4: 洞察生成（Insight Generation）\n\n**4.1 結構判定**\n\n根據以下條件判定緊縮類型：\n\n| 條件 | 判定 |\n|------|------|\n| 貸款上升 + 存款落後 + Gap 與 RRP 相關 | hidden_balance_sheet_tightening |\n| 貸款下降 + 存款下降 | traditional_credit_tightening |\n| 貸款上升 + 存款同步上升 | neutral |\n\n**4.2 壓力指標解讀**\n\n| deposit_stress_ratio | 壓力等級 | 意義 |\n|---------------------|----------|------|\n| < 0.3 | 低 | 正常信貸創造 |\n| 0.3 - 0.5 | 中 | 輕度脫鉤 |\n| 0.5 - 0.7 | 高 | 顯著脫鉤，銀行需搶存款 |\n| > 0.7 | 極高 | 嚴重負債端壓力 |\n\n**4.3 RRP 相關性驗證**\n\n計算 decoupling_gap 與 rrp_change 的相關係數：\n- r > 0.8：高度相關，RRP 是主要驅動因素\n- r = 0.5-0.8：中度相關，RRP 部分解釋\n- r < 0.5：低相關，需考慮其他因素\n\n## Step 5: 視覺化輸出\n\n**5.1 生成分析圖表**\n```bash\npython visualize_decoupling.py \\\n  --start 2022-06-01 \\\n  --output ../../output/decoupling_chart_$(date +%Y-%m-%d).png\n```\n\n**5.2 圖表內容**\n\n1. **上半部**：累積變化量對比\n   - 藍線：累積新增貸款\n   - 綠線：累積新增存款\n   - 紅線：累積 RRP 變化\n   - 灰色區域：Decoupling Gap\n\n2. **下半部**：壓力指標\n   - deposit_stress_ratio 時序圖\n   - 警戒水準標示（0.5, 0.7）\n\n## Step 6: 輸出結果\n\n**6.1 JSON 輸出**\n\n參考 `templates/output-json.md` 格式輸出完整分析結果。\n\n**6.2 Markdown 報告**\n\n參考 `templates/output-markdown.md` 格式生成人類可讀報告。\n\n</process>\n\n<success_criteria>\n此工作流完成時應達成：\n\n- [ ] 成功從 FRED 抓取三個核心指標數據\n- [ ] 計算累積變化量（貸款、存款、RRP）\n- [ ] 計算 Decoupling Gap 與 deposit_stress_ratio\n- [ ] 驗證 RRP 與 Gap 的相關性\n- [ ] 生成緊縮類型判定與信心水準\n- [ ] 輸出視覺化圖表\n- [ ] 輸出 JSON 與 Markdown 格式結果\n- [ ] 提供可操作的宏觀解讀\n</success_criteria>\n",
        "skills/analyze-us-bank-credit-deposit-decoupling/workflows/quick-check.md": "# Workflow: 快速檢查信貸-存款脫鉤狀態\n\n<required_reading>\n無需額外閱讀，直接執行即可。\n</required_reading>\n\n<process>\n\n## Step 1: 執行快速分析\n\n```bash\ncd scripts\npython decoupling_analyzer.py --quick\n```\n\n## Step 2: 解讀輸出\n\n快速分析會輸出以下摘要：\n\n```json\n{\n  \"as_of\": \"2026-01-23\",\n  \"decoupling_gap_trillion_usd\": 1.6,\n  \"deposit_stress_ratio\": 0.76,\n  \"tightening_type\": \"hidden_balance_sheet_tightening\",\n  \"confidence\": \"high\",\n  \"summary\": \"銀行負債端壓力顯著，隱性緊縮狀態\"\n}\n```\n\n## Step 3: 訊號解讀\n\n| 指標 | 當前值 | 意義 |\n|------|--------|------|\n| decoupling_gap | 正值且擴大 | 存款流失超過貸款創造 |\n| deposit_stress_ratio | > 0.5 | 銀行需要積極搶存款 |\n| tightening_type | hidden | 緊縮來自負債端而非資產端 |\n\n</process>\n\n<success_criteria>\n快速檢查完成時：\n\n- [ ] 取得最新的脫鉤狀態摘要\n- [ ] 了解當前壓力水準\n- [ ] 獲得可操作的訊號判定\n</success_criteria>\n",
        "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/SKILL.md": "---\nname: backsolve-miner-vs-metal-ratio-with-fundamentals\ndescription: 從網路自動抓取礦業公司財務報表與營運揭露（產量、成本、資本支出），回算「礦業股/金屬本體比率」的基本面解釋與區間門檻（如 1.2/1.7），並輸出可重現的估值拆解（成本因子 / 槓桿因子 / 倍數因子 / 稀釋因子）。\n---\n\n<essential_principles>\n\n<principle name=\"ratio_decomposition\">\n**比率拆解核心公式**\n\n礦業股/金屬價格比率可分解為四大基本面因子：\n\n```\nR_t ≈ K × M_t × (1-L_t) × C_t × D_t\n```\n\n其中：\n- **K**: 校準常數（由觀測值估計）\n- **M_t**: 倍數因子（EV/EBITDA）\n- **(1-L_t)**: 槓桿因子（1 - NetDebt/EV）\n- **C_t**: 成本因子（1 - AISC/S_t）\n- **D_t**: 稀釋因子（Shares_base / Shares_t）\n\n此拆解讓「比率變動」有可歸因的量化解釋。\n</principle>\n\n<principle name=\"aisc_extraction\">\n**AISC 抽取優先順序**\n\n全維持成本（AISC）是礦業股估值的核心驅動：\n\n| 優先級 | 來源            | 方法                                        |\n|--------|-----------------|---------------------------------------------|\n| 1      | MD&A / 財報附註 | 關鍵字抽取：「AISC」「all-in sustaining」   |\n| 2      | 年報簡報 PDF    | 解析表格：$/oz 或 $/ounce                   |\n| 3      | Proxy 回算      | (OpCost + SustCapex + G&A - Byproduct) / Oz |\n\n當直接揭露不可得時，以 proxy 回算補缺；記錄 `aisc_method` 以標註來源。\n</principle>\n\n<principle name=\"backsolve_logic\">\n**反推邏輯（Backsolve）**\n\n目標：給定目標比率 R*（如歷史頂部 1.7），反推需要哪些因子條件。\n\n**單因子反推**：假設其他因子不變，只調整單一因子\n\n```\nM* = M_now × (R*/R_now)         # 需要的倍數\n(1-L*) = (1-L_now) × (R*/R_now) # 需要的去槓桿\nC* = C_now × (R*/R_now)         # 需要的成本改善 → 反推 AISC*\nD* = D_now × (R*/R_now)         # 需要的稀釋折扣\n```\n\n**雙因子組合**：以網格列舉可行組合（如倍數 +20% + 白銀 -15%）。\n</principle>\n\n<principle name=\"event_study\">\n**事件研究方法**\n\n識別「比率落入底部分位」的歷史事件，回看事件當期的四大因子狀態：\n\n1. **AISC 是否上升**：成本壓力\n2. **NetDebt/EV 是否惡化**：槓桿壓力\n3. **EV/EBITDA 是否壓縮**：倍數壓力\n4. **Shares 是否上升**：稀釋壓力\n\n排名「哪個因子貢獻最大」，識別驅動底部的主因。\n</principle>\n\n<principle name=\"data_priority\">\n**數據來源優先順序**\n\n遵循「結構化優先」原則：\n\n1. **SEC XBRL (10-K/10-Q)**：直接取欄位（債務、現金、股數、CFO、Capex）\n2. **SEDAR+ (加拿大)**：銀礦公司常在加拿大上市\n3. **公司 IR 年報/MD&A**：補齊 AISC、產量等非標準欄位\n4. **ETF Holdings**：官方 CSV 或 SEC N-PORT\n\n抓取時使用 Selenium 模擬人類行為，避免被封鎖。\n</principle>\n\n</essential_principles>\n\n<objective>\n實作「礦業股/金屬價格比率」基本面回算系統：\n\n1. **數據整合**：抓取價格、ETF 持股、財務報表、營運揭露\n2. **因子計算**：計算 AISC、槓桿、倍數、稀釋四大因子\n3. **比率拆解**：建立 R_t ≈ K × M × (1-L) × C × D 近似式\n4. **門檻反推**：給定目標比率，反推需要的因子組合\n5. **事件研究**：歷史底部事件的因子驅動分析\n6. **輸出報告**：結構化 JSON 與可讀 Markdown\n\n目標用戶：看到 SIL/白銀比率極端時，想用「真實財報」驗證驅動因素。\n</objective>\n\n<quick_start>\n\n**最快的方式：使用預設參數分析**\n\n```bash\ncd skills/backsolve-miner-vs-metal-ratio-with-fundamentals\npip install pandas numpy yfinance matplotlib  # 首次使用\npython scripts/fundamental_analyzer.py --quick\n```\n\n**完整分析（含財報抓取）**\n\n```bash\npython scripts/fundamental_analyzer.py \\\n  --metal-symbol SI=F \\\n  --miner-universe etf:SIL \\\n  --region-profile us_sec \\\n  --start-date 2015-01-01 \\\n  --output result.json\n```\n\n**生成視覺化儀表板**\n\n```bash\npython scripts/visualize_factors.py --quick --output output/\n# 輸出: output/sil_silver_factor_analysis_YYYY-MM-DD.png\n```\n\n視覺化儀表板包含四個面板：\n1. **比率時間序列**：歷史走勢 + 分位數區間（底部/頂部）\n2. **因子雷達圖**：四大因子健康度一覽\n3. **因子評分長條圖**：成本、槓桿、倍數、稀釋各項評分\n4. **情境熱力圖**：倍數擴張 × 白銀變動的組合分析\n\n**共同上漲情境模擬**\n\n```bash\npython scripts/scenario_path_simulator.py --quick --output output/\n# 輸出: output/scenario_path_YYYY-MM-DD.png + return_heatmap_YYYY-MM-DD.png\n```\n\n核心公式：**礦業股漲幅 = (1 + 銀價漲幅) × (R₁/R₀) - 1**\n\n自訂參數：\n```bash\npython scripts/scenario_path_simulator.py \\\n  --silver-monthly 5 \\      # 銀價每月漲幅 5%\n  --ratio-start 1.10 \\      # 比率起點\n  --ratio-end 1.20 \\        # 比率終點\n  --months 6 \\              # 模擬 6 個月\n  --heatmap                 # 同時生成熱力圖\n```\n\n**輸出範例**：\n\n```json\n{\n  \"now\": {\n    \"metal_price\": 94.4,\n    \"miner_price\": 103.4,\n    \"ratio\": 1.13,\n    \"ratio_percentile\": 0.111\n  },\n  \"thresholds\": {\n    \"bottom_ratio\": 1.20,\n    \"top_ratio\": 1.70,\n    \"median_ratio\": 1.51\n  },\n  \"fundamentals_weighted\": {\n    \"aisc_usd_per_oz\": 28.0,\n    \"net_debt_to_ev\": 0.25,\n    \"ev_to_ebitda\": 6.4,\n    \"shares_yoy_change\": 0.12\n  },\n  \"factors_now\": {\n    \"cost_factor_C\": 0.7034,\n    \"leverage_factor_1_minus_L\": 0.75,\n    \"multiple_M\": 6.4,\n    \"dilution_discount_D\": 0.89\n  },\n  \"backsolve_to_top\": {\n    \"multiple_only_need\": 9.1,\n    \"deleverage_only_need_1_minus_L\": 1.12,\n    \"cost_only_implied_aisc\": 15.6,\n    \"dilution_only_need_D\": 1.26\n  }\n}\n```\n\n</quick_start>\n\n<intake>\n需要進行什麼操作？\n\n1. **快速分析** - 使用預設參數（SIL / SI=F）計算當前因子狀態\n2. **完整分析** - 抓取財報、計算因子、反推門檻\n3. **因子拆解** - 深入了解四大因子的計算邏輯\n4. **門檻反推** - 給定目標比率，計算需要的因子組合\n5. **事件研究** - 歷史底部事件的因子驅動排名\n6. **方法論學習** - 了解回算邏輯與數據來源\n7. **視覺化** - 生成四面板儀表板圖表\n8. **共同上漲情境** - 模擬銀價與礦業股同漲時的比例關係與路徑\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                       | Action                                                         |\n|--------------------------------|----------------------------------------------------------------|\n| 1, \"快速\", \"quick\", \"分析\"     | 執行 `python scripts/fundamental_analyzer.py --quick`          |\n| 2, \"完整\", \"full\", \"財報\"      | 閱讀 `workflows/analyze.md` 並執行                             |\n| 3, \"因子\", \"factor\", \"拆解\"    | 閱讀 `references/fundamental-factors.md`                       |\n| 4, \"反推\", \"backsolve\", \"門檻\" | 閱讀 `references/backsolve-math.md` 並執行反推分析             |\n| 5, \"事件\", \"event\", \"底部\"     | 閱讀 `workflows/analyze.md` 並聚焦事件研究                     |\n| 6, \"學習\", \"方法論\", \"why\"     | 閱讀 `references/fundamental-factors.md` + `backsolve-math.md` |\n| 7, \"視覺化\", \"圖\", \"chart\"     | 執行 `python scripts/visualize_factors.py --quick`             |\n| 8, \"共同上漲\", \"情境\", \"路徑\"  | 執行 `python scripts/scenario_path_simulator.py --quick`       |\n| \"比例關係\", \"漲幅\", \"要漲多少\" | 執行 `python scripts/scenario_path_simulator.py --quick`       |\n| 提供參數 (如 ETF/金屬代理)     | 閱讀 `workflows/analyze.md` 並使用參數執行                     |\n\n**路由後，閱讀對應文件並執行。**\n</routing>\n\n<directory_structure>\n```\nbacksolve-miner-vs-metal-ratio-with-fundamentals/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元數據\n├── workflows/\n│   ├── analyze.md                     # 完整分析工作流\n│   └── data-fetch.md                  # 數據抓取工作流\n├── references/\n│   ├── input-schema.md                # 完整輸入參數定義\n│   ├── data-sources.md                # 數據來源說明\n│   ├── fundamental-factors.md         # 四大因子計算邏輯\n│   └── backsolve-math.md              # 反推數學公式\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n├── scripts/\n│   ├── fundamental_analyzer.py        # 主計算腳本\n│   ├── visualize_factors.py           # 視覺化儀表板腳本\n│   └── scenario_path_simulator.py     # 共同上漲情境模擬器\n└── examples/\n    └── sample-output.json             # 範例輸出\n```\n</directory_structure>\n\n<reference_index>\n\n**輸入參數**: references/input-schema.md\n- 完整參數定義\n- 預設值與建議範圍\n- 各方法選項說明\n\n**數據來源**: references/data-sources.md\n- 價格數據（yfinance / stooq / alphavantage）\n- 財報數據（SEC EDGAR / SEDAR+ / 公司 IR）\n- ETF 持股（官方 CSV / N-PORT / 手動 URL）\n\n**因子計算**: references/fundamental-factors.md\n- AISC 成本因子\n- 槓桿因子\n- 倍數因子\n- 稀釋因子\n\n**反推數學**: references/backsolve-math.md\n- 單因子反推公式\n- 雙因子組合網格\n- 校準常數估計\n\n</reference_index>\n\n<workflows_index>\n| Workflow      | Purpose  | 使用時機                    |\n|---------------|----------|-----------------------------|\n| analyze.md    | 完整分析 | 需要抓取財報並計算因子      |\n| data-fetch.md | 數據抓取 | 了解如何抓取 ETF 持股與財報 |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構定義 |\n| output-markdown.md | Markdown 報告模板 |\n</templates_index>\n\n<scripts_index>\n| Script                     | Command                              | Purpose                    |\n|----------------------------|--------------------------------------|----------------------------|\n| fundamental_analyzer.py    | `--quick`                            | 快速分析 SIL/SI=F          |\n| fundamental_analyzer.py    | `--miner-universe etf:SILJ`          | 自訂礦業股 ETF             |\n| fundamental_analyzer.py    | `--backsolve-target 1.7`             | 指定反推目標比率           |\n| fundamental_analyzer.py    | `--event-study --min-separation 180` | 執行事件研究               |\n| visualize_factors.py       | `--quick --output output/`           | 生成四面板視覺化儀表板     |\n| visualize_factors.py       | `--input result.json`                | 從 JSON 結果生成圖表       |\n| scenario_path_simulator.py | `--quick`                            | 共同上漲情境路徑模擬       |\n| scenario_path_simulator.py | `--silver-monthly 5 --months 6`      | 自訂銀價月漲幅與模擬月數   |\n| scenario_path_simulator.py | `--ratio-start 1.10 --ratio-end 1.20`| 自訂比率起終點             |\n| scenario_path_simulator.py | `--heatmap`                          | 同時生成收益率熱力圖       |\n</scripts_index>\n\n<input_schema_summary>\n\n**核心參數**\n\n| 參數                 | 類型   | 預設值  | 說明                                    |\n|----------------------|--------|---------|-----------------------------------------|\n| metal_symbol         | string | SI=F    | 金屬價格代碼（SI=F 白銀、GC=F 黃金）    |\n| miner_universe       | object | etf:SIL | 礦業股/ETF 定義                         |\n| region_profile       | string | us_sec  | 監管與揭露來源（us_sec / canada_sedar） |\n| time_range.start     | string | 5 年前  | 分析起點（YYYY-MM-DD）                  |\n| time_range.end       | string | today   | 分析終點                                |\n| time_range.frequency | string | weekly  | 取樣頻率（daily/weekly/monthly）        |\n\n**因子方法選擇**\n\n| 參數                         | 類型   | 預設值              | 說明          |\n|------------------------------|--------|---------------------|---------------|\n| fundamental_methods.aisc     | string | hybrid              | AISC 抽取方法 |\n| fundamental_methods.leverage | string | net_debt_to_ev      | 槓桿計算方法  |\n| fundamental_methods.multiple | string | ev_to_ebitda        | 倍數計算方法  |\n| fundamental_methods.dilution | string | weighted_avg_shares | 稀釋計算方法  |\n\n**分位門檻**\n\n| 參數                    | 類型  | 預設值 | 說明           |\n|-------------------------|-------|--------|----------------|\n| ratio_thresholds.bottom | float | 0.20   | 底部分位數門檻 |\n| ratio_thresholds.top    | float | 0.80   | 頂部分位數門檻 |\n\n完整參數定義見 `references/input-schema.md`。\n\n</input_schema_summary>\n\n<output_schema_summary>\n```json\n{\n  \"skill\": \"backsolve_miner_vs_metal_ratio_with_fundamentals\",\n  \"inputs\": {\n    \"metal_symbol\": \"SI=F\",\n    \"miner_universe\": {\"type\": \"etf_holdings\", \"etf_ticker\": \"SIL\"},\n    \"region_profile\": \"us_sec\"\n  },\n  \"now\": {\n    \"metal_price\": 94.4,\n    \"miner_price\": 103.4,\n    \"ratio\": 1.13,\n    \"ratio_percentile\": 0.111\n  },\n  \"thresholds\": {\n    \"bottom_ratio\": 1.20,\n    \"top_ratio\": 1.70,\n    \"median_ratio\": 1.51\n  },\n  \"fundamentals_weighted\": {\n    \"aisc_usd_per_oz\": 28.0,\n    \"net_debt_to_ev\": 0.25,\n    \"ev_to_ebitda\": 6.4,\n    \"shares_yoy_change\": 0.12\n  },\n  \"factors_now\": {\n    \"cost_factor_C\": 0.7034,\n    \"leverage_factor_1_minus_L\": 0.75,\n    \"multiple_M\": 6.4,\n    \"dilution_discount_D\": 0.89\n  },\n  \"backsolve_to_top\": {\n    \"multiple_only_need\": 9.1,\n    \"deleverage_only_need_1_minus_L\": 1.12,\n    \"cost_only_implied_aisc\": 15.6,\n    \"dilution_only_need_D\": 1.26,\n    \"two_factor_grid_examples\": [\n      {\"multiple_up\": 1.20, \"metal_down\": -0.15, \"hits_top\": true},\n      {\"deleverage\": -0.10, \"multiple_up\": 1.15, \"hits_top\": true}\n    ]\n  },\n  \"event_study\": {\n    \"bottom_events\": [\n      {\n        \"date\": \"2026-01-02\",\n        \"ratio\": 1.13,\n        \"aisc\": 29.1,\n        \"net_debt_to_ev\": 0.27,\n        \"ev_to_ebitda\": 5.8,\n        \"shares_yoy\": 0.14,\n        \"dominant_driver\": \"multiple_compression\"\n      }\n    ]\n  },\n  \"summary\": \"比率處於歷史底部，主要驅動為倍數壓縮...\",\n  \"notes\": [\n    \"AISC 使用 hybrid 方法回算，部分公司為 proxy 值\",\n    \"建議交叉驗證：COT 持倉、ETF 流量、美元/實質利率\"\n  ]\n}\n```\n\n完整輸出結構見 `templates/output-json.md`。\n</output_schema_summary>\n\n<success_criteria>\n執行成功時應產出：\n\n- [ ] 當前比率與歷史分位數\n- [ ] 四大基本面因子（AISC、槓桿、倍數、稀釋）\n- [ ] 權重加總後的組合因子\n- [ ] 門檻反推結果（單因子 + 雙因子組合）\n- [ ] 歷史底部事件的因子驅動排名\n- [ ] 結果輸出為指定格式（JSON 或 Markdown）\n- [ ] 數據來源與方法標註（aisc_method 等）\n- [ ] 風險提示與後續研究建議\n- [ ] 視覺化儀表板（PNG 格式，檔名含日期）\n</success_criteria>\n",
        "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/methodology.md": "\n當你看到「礦業股（或礦業 ETF）相對金屬本體」的比率（例如 **SIL／白銀**）落在歷史極端（底部或頂部），市場常見的解釋會停在一句話：  \n> 「礦業股太便宜了／礦業股太貴了」\n\n但這句話不夠。因為礦業股的價格不是只跟金屬價格走，它還受 **成本、負債、估值倍數、股本稀釋**影響。  \n所以這個 Skill 的目標是：**把比率的變動拆成可驗證的財務原因**，而且用「公司申報的財報與營運揭露」去回算，不靠感覺。\n\n---\n\n## 核心原理：把「比率」拆成四個可量化因子\n我們觀察的比率是：\n\n- **比率 = 礦業股價格 ÷ 金屬價格**  \n  例如：`SIL 價格 ÷ 白銀價格`\n\n這個比率為什麼會上去或下來？Skill 會用財報把原因拆成四類：\n\n### 1) 成本因子：每盎司成本（例如全維持成本）相對金屬價格\n- 若金屬價格很高，但公司成本也跟著上升，**獲利不一定變好**  \n- Skill 會從公司揭露或財報文本中抓取「每盎司成本」與「產量」，必要時用財報科目做近似回算  \n- 結果是回答：  \n  **比率低，是不是因為成本上升把利潤吃掉？**\n\n### 2) 槓桿因子：負債與現金結構（資產負債表）\n- 負債高、現金少的公司，即使金屬漲，市場也會更保守  \n- Skill 會用財報計算「淨負債」並結合市值推估企業整體價值  \n- 結果是回答：  \n  **比率低，是不是因為槓桿風險折價？**\n\n### 3) 倍數因子：市場願意給的估值倍數\n- 即使獲利上升，市場仍可能用更低倍數定價（例如因為政策風險、項目不確定、景氣循環）  \n- Skill 會用財報推估獲利能力，再對照市場估值，得到「倍數」的高低  \n- 結果是回答：  \n  **比率低，是不是因為估值倍數被壓縮？**\n\n### 4) 稀釋因子：股本增加（每股價值被稀釋）\n- 礦業很常見「增資、可轉債、併購發股」  \n- 即使公司總獲利增加，如果股本膨脹得更快，每股價值反而上不去  \n- Skill 會追蹤股數變化，回算稀釋對比率的影響  \n- 結果是回答：  \n  **比率低，是不是因為股本稀釋把每股漲幅抵消？**\n\n---\n\n## 用 SIL／白銀案例示範：我們會怎麼做\n你目前的觀察重點是：\n\n- **SIL／白銀比率在歷史底部區**\n- 同時 **白銀價格處於歷史高位**\n- 形成「比率低 + 金屬高」的背離組合\n\n### 第一步：用市場數據確認「這是極端」\n- 把過去十多年每日的 `SIL／白銀` 比率做分位數\n- 確認當前落在底部區（例如低於 20% 分位）\n\n### 第二步：抓「SIL 主要成分股」的財報資料（真實回算）\n- 取權重最大的公司（例如前 10 大）  \n- 對每家公司抓：\n  1) 每盎司成本（能抓就抓，抓不到就用財報回算近似）\n  2) 負債與現金（淨負債）\n  3) 現金流與資本支出（是否被維持性支出吃掉）\n  4) 股本變化（是否持續稀釋）\n\n### 第三步：把「比率低」拆成四個可能原因，逐一量化\nSkill 會輸出像這樣的結論架構（每一項都對應到實際數據）：\n\n- **成本面**：如果多數公司每盎司成本上升明顯 → 比率低可能是合理折價  \n- **槓桿面**：若淨負債偏高、再融資壓力大 → 市場會壓低估值  \n- **倍數面**：若市場把倍數壓得很低 → 可能是情緒或風險溢酬在主導  \n- **稀釋面**：若股數增加快 → 即使銀價高，每股漲幅也會被稀釋抵消\n\n### 第四步：做你要的「回到 1.7」或「回到 1.2」的真實回算\n這是 Skill 最實用的一段：  \n它不是只算「礦業股要漲多少、白銀要跌多少」，而是會同時回答：\n\n- **如果要回到頂部區（例如 1.7）**\n  - 需要：倍數回升到什麼水平？  \n  - 或：淨負債要降到什麼程度？  \n  - 或：成本要改善到什麼程度？  \n  - 或：稀釋要停止到什麼程度？\n\n這個 Skill 的精髓是：  \n**先用分位數找出比率極端，再用財報把極端拆解成成本、槓桿、倍數、稀釋四種可驗證的原因，最後回算要回到頂部或中位數需要哪些“真實財務條件”。**",
        "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/references/backsolve-math.md": "# 反推數學公式\n\n本文件說明「門檻反推」的數學邏輯與計算方法。\n\n## 核心問題\n\n**問題**：若比率 R 要從當前值 R_now 達到目標值 R*（如歷史頂部），需要哪些因子變化？\n\n**約束**：\n\n```\nR_t ≈ K × M_t × (1-L_t) × C_t × D_t\n```\n\n---\n\n## 單因子反推\n\n假設其他因子不變，只調整單一因子。\n\n### 基本公式\n\n比率變動倍數：\n\n```\nRatio_multiplier = R* / R_now\n```\n\n### 只靠倍數擴張\n\n```\nM* = M_now × Ratio_multiplier\n```\n\n**範例**：\n- R_now = 1.13, R* = 1.70\n- Ratio_multiplier = 1.70 / 1.13 = 1.50\n- M_now = 6.4\n- M* = 6.4 × 1.50 = 9.6\n\n**解讀**：EV/EBITDA 需從 6.4x 升至 9.6x。\n\n---\n\n### 只靠去槓桿\n\n```\n(1-L*) = (1-L_now) × Ratio_multiplier\n```\n\n**範例**：\n- (1-L_now) = 0.75（即 NetDebt/EV = 25%）\n- (1-L*) = 0.75 × 1.50 = 1.125\n\n**解讀**：需要 (1-L) > 1，意味著需達到淨現金狀態且有大量現金超過負債。這通常不現實，說明單靠去槓桿無法達標。\n\n---\n\n### 只靠成本改善\n\n```\nC* = C_now × Ratio_multiplier\n```\n\n再反推 AISC*：\n\n```\nC* = 1 - AISC* / S\nAISC* = S × (1 - C*)\n```\n\n**範例**：\n- C_now = 0.703（AISC = $28, S = $94.4）\n- C* = 0.703 × 1.50 = 1.055\n\n**問題**：C* > 1 意味著 AISC* < 0，不可能。\n\n**解讀**：單靠成本改善無法達標。\n\n---\n\n### 只靠減少稀釋\n\n```\nD* = D_now × Ratio_multiplier\n```\n\n**範例**：\n- D_now = 0.89（股數較基期增加約 12%）\n- D* = 0.89 × 1.50 = 1.335\n\n**解讀**：需要股數減少 33%（大規模回購），通常不現實。\n\n---\n\n## 單因子反推摘要\n\n| 因子     | 需要的調整                           | 可行性         |\n|----------|--------------------------------------|----------------|\n| 倍數 M   | 從 6.4x 升至 9.6x (+50%)             | 可能但激進     |\n| 槓桿     | 達到大幅淨現金                       | 不現實         |\n| 成本 C   | AISC 需為負                          | 不可能         |\n| 稀釋 D   | 股數減少 33%                         | 不現實         |\n\n**結論**：單因子無法獨立達成目標，需要多因子組合。\n\n---\n\n## 雙因子組合\n\n更現實的情境是兩個因子同時調整。\n\n### 組合公式\n\n```\nR* / R_now = (M* / M_now) × ((1-L*) / (1-L_now)) × (C* / C_now) × (D* / D_now)\n```\n\n若只調整兩個因子（如 M 和金屬價格 S）：\n\n```\nR* / R_now = (M* / M_now) × (C* / C_now)\n```\n\n其中 C 會因 S 變化而變化：\n\n```\nC = 1 - AISC / S\n```\n\n### 組合網格\n\n```python\ndef generate_two_factor_grid(R_now, R_target, M_now, C_now, AISC, S):\n    \"\"\"\n    生成雙因子組合網格\n\n    組合 1: 倍數擴張 + 白銀下跌\n    組合 2: 倍數擴張 + 去槓桿\n    組合 3: 成本改善 + 倍數擴張\n    \"\"\"\n    target_ratio = R_target / R_now\n    results = []\n\n    # 組合 1: 倍數 + 白銀\n    for m_mult in [1.10, 1.15, 1.20, 1.25, 1.30]:\n        for s_mult in [0.85, 0.90, 0.95, 1.00]:  # 白銀下跌\n            new_S = S * s_mult\n            new_C = 1 - AISC / new_S\n            new_M = M_now * m_mult\n\n            # 假設其他因子不變\n            achieved_ratio = (m_mult) * (new_C / C_now)\n\n            results.append({\n                'scenario': 'multiple_plus_metal',\n                'multiple_change': m_mult - 1,\n                'metal_change': s_mult - 1,\n                'achieved_ratio': achieved_ratio,\n                'hits_target': achieved_ratio >= target_ratio\n            })\n\n    return results\n```\n\n### 範例輸出\n\n| 組合                    | 倍數調整 | 白銀調整 | 達標 |\n|-------------------------|----------|----------|------|\n| 倍數 +20%, 白銀 -15%    | +20%     | -15%     | ✓    |\n| 倍數 +30%, 白銀 不變    | +30%     | 0%       | ✓    |\n| 倍數 +10%, 白銀 -20%    | +10%     | -20%     | ✓    |\n| 倍數 +15%, 去槓桿 -10%  | +15%     | -10% ND/EV| ✓   |\n\n---\n\n## 校準常數 K 估計\n\n### 方法 1：當期校準\n\n```python\ndef calibrate_K(R_now, M_now, one_minus_L_now, C_now, D_now):\n    \"\"\"\n    由當前觀測值校準 K\n\n    K = R_now / (M_now × (1-L_now) × C_now × D_now)\n    \"\"\"\n    product = M_now * one_minus_L_now * C_now * D_now\n    if product == 0:\n        return None\n    K = R_now / product\n    return K\n```\n\n### 方法 2：回歸估計\n\n```python\nimport statsmodels.api as sm\nimport numpy as np\n\ndef estimate_K_regression(ratio_series, factors_df):\n    \"\"\"\n    使用回歸估計 K（更穩健）\n\n    log(R) = log(K) + log(M) + log(1-L) + log(C) + log(D) + ε\n    \"\"\"\n    # 取對數\n    y = np.log(ratio_series)\n    X = np.log(factors_df[['M', 'one_minus_L', 'C', 'D']])\n    X = sm.add_constant(X)\n\n    model = sm.OLS(y, X).fit()\n\n    # K = exp(intercept)\n    K = np.exp(model.params['const'])\n\n    return {\n        'K': K,\n        'r_squared': model.rsquared,\n        'coefficients': model.params.to_dict()\n    }\n```\n\n---\n\n## 情境推演框架\n\n### 完整推演流程\n\n```python\ndef full_scenario_analysis(current_state, target_ratio):\n    \"\"\"\n    完整情境推演\n\n    Parameters\n    ----------\n    current_state : dict\n        {'R': 1.13, 'M': 6.4, 'L': 0.25, 'C': 0.703, 'D': 0.89, 'AISC': 28, 'S': 94.4}\n    target_ratio : float\n        目標比率（如 1.7）\n\n    Returns\n    -------\n    dict\n        單因子反推 + 雙因子組合網格\n    \"\"\"\n    R_now = current_state['R']\n    ratio_mult = target_ratio / R_now\n\n    # 單因子反推\n    single_factor = {\n        'multiple_only': current_state['M'] * ratio_mult,\n        'leverage_only': (1 - current_state['L']) * ratio_mult,\n        'cost_only_C': current_state['C'] * ratio_mult,\n        'cost_only_aisc': current_state['S'] * (1 - current_state['C'] * ratio_mult),\n        'dilution_only': current_state['D'] * ratio_mult\n    }\n\n    # 可行性判斷\n    feasibility = {\n        'multiple_only': single_factor['multiple_only'] < 15,  # 合理上限\n        'leverage_only': single_factor['leverage_only'] <= 1.5,\n        'cost_only': 0 < single_factor['cost_only_aisc'] < current_state['AISC'],\n        'dilution_only': 0.5 < single_factor['dilution_only'] < 1.5\n    }\n\n    # 雙因子組合\n    two_factor_grid = generate_two_factor_grid(\n        R_now, target_ratio,\n        current_state['M'], current_state['C'],\n        current_state['AISC'], current_state['S']\n    )\n\n    return {\n        'target_ratio': target_ratio,\n        'ratio_multiplier': ratio_mult,\n        'single_factor': single_factor,\n        'feasibility': feasibility,\n        'two_factor_grid': two_factor_grid\n    }\n```\n\n---\n\n## 歷史類比驗證\n\n回顧歷史上比率從底部回到頂部的案例：\n\n| 期間              | 起始比率 | 終點比率 | 礦業股漲幅 | 白銀漲幅 | 主要驅動     |\n|-------------------|----------|----------|------------|----------|--------------|\n| 2016 Q1 → 2016 Q3 | 1.2      | 2.0      | +180%      | +50%     | 倍數擴張     |\n| 2020 Q1 → 2020 Q3 | 1.3      | 1.9      | +200%      | +140%    | 倍數 + 成本  |\n\n**洞察**：歷史上比率回升時，礦業股漲幅通常顯著跑贏白銀（槓桿效應）。\n\n---\n\n## 注意事項\n\n1. **非預測**：反推結果是「極端情境參考」，非價格預測\n2. **路徑依賴**：實際可能是多因子同時調整，路徑複雜\n3. **模型限制**：簡化模型忽略了許多細節（如稅率、匯率等）\n4. **樣本外風險**：歷史類比不保證未來重演\n",
        "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/references/data-sources.md": "# 數據來源說明\n\n本文件說明 `backsolve-miner-vs-metal-ratio-with-fundamentals` 技能使用的數據來源。\n\n## 價格數據\n\n### Yahoo Finance (yfinance)\n\n**主要來源**，透過 `yfinance` 套件取得。\n\n| 資產類型       | 代碼範例    | 可用歷史   | 頻率支援          |\n|----------------|-------------|------------|-------------------|\n| 金屬期貨       | SI=F, GC=F  | 20+ 年     | 日/週/月          |\n| 金屬現貨       | XAGUSD=X    | 10+ 年     | 日/週/月          |\n| 礦業 ETF       | SIL, GDX    | 上市至今   | 日/週/月          |\n| 礦業個股       | PAAS, AG    | 上市至今   | 日/週/月          |\n\n```python\nimport yfinance as yf\n\n# 白銀期貨週頻\nsilver = yf.download(\"SI=F\", start=\"2015-01-01\", interval=\"1wk\")\n\n# 銀礦 ETF 日頻\nsil = yf.download(\"SIL\", start=\"2015-01-01\", interval=\"1d\")\n```\n\n### 備援來源\n\n| 來源          | 優點                     | 缺點                       |\n|---------------|--------------------------|----------------------------|\n| Stooq         | 覆蓋範圍廣               | API 限制較多               |\n| Alpha Vantage | 支援更多指標             | 免費方案有日限額           |\n| FRED          | 官方來源                 | 金屬數據有限               |\n\n---\n\n## 財務報表數據\n\n### SEC EDGAR XBRL API（美國公司）\n\n**主要來源**，結構化程度最高。\n\n**API 端點**\n\n```\nhttps://data.sec.gov/api/xbrl/companyfacts/CIK{cik}.json\n```\n\n**可用欄位**\n\n| 類別           | 欄位                                            |\n|----------------|------------------------------------------------|\n| 資產負債表     | LongTermDebt, CashAndCashEquivalents, Assets    |\n| 損益表         | Revenues, OperatingIncomeLoss, NetIncome        |\n| 現金流量表     | NetCashProvidedByOperatingActivities, Capex     |\n| 股本           | CommonStockSharesOutstanding                    |\n\n**常見銀礦公司 CIK**\n\n| Ticker | CIK         | 公司名稱                    |\n|--------|-------------|-----------------------------|\n| PAAS   | 0001209028  | Pan American Silver Corp    |\n| AG     | 0001331877  | First Majestic Silver Corp  |\n| HL     | 0000719413  | Hecla Mining Company        |\n| CDE    | 0000018974  | Coeur Mining, Inc.          |\n| EXK    | 0001437419  | Endeavour Silver Corp       |\n| FSM    | 0001555280  | Fortuna Silver Mines Inc.   |\n| MAG    | 0001331255  | MAG Silver Corp             |\n\n**使用注意**\n\n- 需設定 User-Agent 標頭（含聯絡信箱）\n- 建議設定合理的請求間隔（1-2 秒）\n- 快取財報數據（季度更新）\n\n---\n\n### SEDAR+（加拿大公司）\n\n許多銀礦公司在加拿大上市，需從 SEDAR+ 取得揭露：\n\n**網址**\n\n```\nhttps://www.sedarplus.ca\n```\n\n**抓取方式**\n\n需使用 Selenium 模擬瀏覽器：\n1. 搜尋公司名稱\n2. 篩選文件類型（年報、MD&A）\n3. 下載 PDF 或 HTML\n\n**AISC 常見位置**\n\n- Management's Discussion & Analysis (MD&A)\n- Annual Information Form (AIF)\n- 年報的 Operations Review 章節\n\n---\n\n### 公司 Investor Relations\n\n當 SEC/SEDAR 無法取得 AISC 時：\n\n| 資訊類型       | 常見格式   | 位置                           |\n|----------------|-----------|--------------------------------|\n| 財報簡報       | PDF/PPT   | IR 網站 > Presentations        |\n| 季報摘要       | PDF       | IR 網站 > Quarterly Reports    |\n| 年報           | PDF       | IR 網站 > Annual Reports       |\n| 產量報告       | PDF/HTML  | IR 網站 > Operations           |\n\n---\n\n## ETF 持股數據\n\n### 官方 Holdings CSV（優先）\n\n| ETF 發行商     | 網址                              | 更新頻率   |\n|----------------|-----------------------------------|------------|\n| Global X       | globalxetfs.com/funds/{ticker}/   | 每日       |\n| VanEck         | vaneck.com/etf/{ticker}/          | 每日       |\n| iShares        | ishares.com/us/products/          | 每日       |\n\n**SIL Holdings 範例**\n\n```\nTicker, Name, Weight(%)\nPAAS, Pan American Silver, 12.5\nAG, First Majestic, 8.2\nHL, Hecla Mining, 7.1\n...\n```\n\n### SEC N-PORT（備援）\n\n基金季度持股申報（Form N-PORT）：\n\n```\nhttps://www.sec.gov/cgi-bin/browse-edgar?action=getcompany&CIK={fund_cik}&type=N-PORT\n```\n\n**解析方式**\n\nN-PORT 為 XML 格式，包含：\n- 持股清單\n- 市值\n- 權重\n\n**注意**\n\n- 季度申報，時滯 60 天\n- 格式較複雜\n\n---\n\n## AISC 專用來源\n\n### MD&A 文字抽取\n\nAISC 常見揭露格式：\n\n```\n\"All-in sustaining costs (AISC) were $28.50 per silver ounce...\"\n\"AISC of $27.80/oz for the quarter...\"\n\"The Company reported an AISC of US$29.10 per payable ounce...\"\n```\n\n**抽取正則**\n\n```python\npatterns = [\n    r'AISC\\s+(?:of\\s+)?\\$?([\\d.]+)\\s*(?:per\\s+)?(?:ounce|oz)',\n    r'all-in\\s+sustaining\\s+cost[s]?\\s+(?:of\\s+)?\\$?([\\d.]+)',\n    r'AISC\\s+(?:was|were)\\s+\\$?([\\d.]+)',\n]\n```\n\n### 產業報告\n\n| 報告來源               | 內容                        | 取得方式         |\n|------------------------|-----------------------------|------------------|\n| World Silver Survey    | 全球銀礦成本曲線            | 付費             |\n| S&P Global Market Intel| 個股成本估計                | 付費             |\n| 公司簡報               | 揭露 AISC                   | 免費（IR 網站）  |\n\n---\n\n## 數據品質與限制\n\n### 時滯問題\n\n| 數據類型       | 典型時滯      | 影響                         |\n|----------------|---------------|------------------------------|\n| 價格           | 即時/前一日   | 無                           |\n| 財報 (SEC)     | 1-2 月        | 因子反映過去                 |\n| AISC (揭露)    | 1-3 月        | 成本估計滯後                 |\n| ETF Holdings   | 1-2 日        | 權重基本準確                 |\n\n### 覆蓋率問題\n\n| 欄位           | 覆蓋率        | 補救措施                     |\n|----------------|---------------|------------------------------|\n| 價格           | 100%          | -                            |\n| 負債/現金      | 95%+          | 用 yfinance 財務摘要補        |\n| EBITDA         | 80%+          | 用 OperatingIncome + D&A proxy |\n| AISC (揭露)    | 60%           | 用 proxy 回算                |\n| 產量 (oz)      | 50%           | 從年報/簡報手動抽取          |\n\n### 口徑差異\n\n| 問題                 | 說明                                         | 處理方式              |\n|----------------------|----------------------------------------------|-----------------------|\n| AISC 定義不一致      | 各公司揭露標準略有差異                       | 使用同業中位數參考    |\n| 財年不同步           | 有些公司財年結束在 6 月                      | 以最近一期為準        |\n| 幣別差異             | 加拿大公司可能用 CAD 報告                    | 轉換為 USD            |\n\n---\n\n## 快取策略建議\n\n| 數據類型       | 快取時間      | 理由                         |\n|----------------|---------------|------------------------------|\n| 價格           | 1 小時        | 交易時段可能變動             |\n| ETF Holdings   | 1 天          | 每日更新                     |\n| 財報 (SEC)     | 7 天          | 季度更新                     |\n| AISC           | 30 天         | 季度揭露                     |\n\n```python\ncache_config = {\n    'prices': {'max_age_hours': 1},\n    'holdings': {'max_age_hours': 24},\n    'filings': {'max_age_hours': 168},    # 7 天\n    'aisc': {'max_age_hours': 720}        # 30 天\n}\n```\n",
        "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/references/fundamental-factors.md": "# 四大基本面因子\n\n本文件說明礦業股/金屬價格比率的四大基本面因子計算邏輯。\n\n## 概述\n\n礦業股/金屬價格比率可分解為四大可量化因子：\n\n```\nR_t ≈ K × M_t × (1-L_t) × C_t × D_t\n```\n\n| 符號    | 名稱     | 直覺                                 |\n|---------|----------|--------------------------------------|\n| R_t     | 比率     | 礦業股價格 / 金屬價格                |\n| K       | 校準常數 | 吸收模型細節的殘差項                 |\n| M_t     | 倍數因子 | 市場給予的估值倍數（EV/EBITDA）      |\n| (1-L_t) | 槓桿因子 | 財務槓桿的折扣（1 - NetDebt/EV）     |\n| C_t     | 成本因子 | 金屬價格與成本的差距（1 - AISC/S）   |\n| D_t     | 稀釋因子 | 股權稀釋的折扣（Shares_base/Shares） |\n\n---\n\n## 成本因子 (C)\n\n### 定義\n\n成本因子衡量金屬價格與開採成本的差距：\n\n```\nC_t = 1 - AISC_t / S_t\n```\n\n其中：\n- **AISC_t**：全維持成本（All-In Sustaining Cost），$/oz\n- **S_t**：金屬價格，$/oz\n\n### 直覺\n\n| C 值    | 解讀                         |\n|---------|------------------------------|\n| C > 0.5 | 成本遠低於價格，礦企獲利豐厚 |\n| C ≈ 0.3 | 成本約為價格 70%，正常獲利   |\n| C < 0.1 | 成本接近價格，獲利微薄或虧損 |\n| C < 0   | 成本高於價格，虧損           |\n\n### AISC 組成\n\n```\nAISC = Cash Cost + Sustaining Capex + G&A - Byproduct Credits\n```\n\n| 組成              | 說明                       |\n|-------------------|----------------------------|\n| Cash Cost         | 採礦、加工、精煉的直接成本 |\n| Sustaining Capex  | 維持現有產能的資本支出     |\n| G&A               | 一般與管理費用             |\n| Byproduct Credits | 副產品銷售抵減（如銅、鋅） |\n\n### 計算方法\n\n**方法 1：直接抽取（優先）**\n\n從 MD&A 或年報抽取揭露的 AISC：\n\n```python\n# 正則匹配\npattern = r'AISC\\s+(?:of\\s+)?\\$?([\\d.]+)\\s*(?:per\\s+)?(?:ounce|oz)'\nmatch = re.search(pattern, mda_text, re.IGNORECASE)\naisc = float(match.group(1))\n```\n\n**方法 2：Proxy 回算**\n\n當直接揭露不可得時：\n\n```python\ndef proxy_aisc(financials, production_oz):\n    operating_cost = financials['cost_of_revenue']\n    sustaining_capex = financials['capex'] * 0.6  # 假設 60% 維持性\n    ga = financials['ga_expense']\n    byproduct = financials['other_revenue'] * 0.5  # 估計值\n\n    aisc = (operating_cost + sustaining_capex + ga - byproduct) / production_oz\n    return aisc\n```\n\n---\n\n## 槓桿因子 (1-L)\n\n### 定義\n\n槓桿因子反映財務槓桿對估值的折扣：\n\n```\nL_t = NetDebt_t / EV_t\n(1-L_t) = 1 - NetDebt_t / EV_t\n```\n\n其中：\n- **NetDebt**：淨負債 = 總負債 - 現金\n- **EV**：企業價值 = 市值 + 總負債 - 現金\n\n### 直覺\n\n| (1-L) 值 | L 值    | 解讀                 |\n|----------|---------|----------------------|\n| > 1.0    | < 0     | 淨現金，財務非常健康 |\n| 0.7-1.0  | 0-0.3   | 槓桿適中             |\n| 0.5-0.7  | 0.3-0.5 | 槓桿偏高             |\n| < 0.5    | > 0.5   | 高槓桿，財務風險較高 |\n\n### 計算\n\n```python\ndef compute_leverage_factor(total_debt, cash, market_cap):\n    net_debt = total_debt - cash\n    ev = market_cap + net_debt\n\n    if ev <= 0:\n        return None  # 異常情況\n\n    L = net_debt / ev\n    one_minus_L = 1 - L\n\n    return {\n        'net_debt': net_debt,\n        'ev': ev,\n        'L': L,\n        'one_minus_L': one_minus_L\n    }\n```\n\n### 替代方法\n\n| 方法              | 公式                     | 適用場景         |\n|-------------------|--------------------------|------------------|\n| NetDebt/EV        | NetDebt / EV             | 標準方法（推薦） |\n| NetDebt/EBITDA    | NetDebt / EBITDA         | 獲利能力視角     |\n| Interest Coverage | EBITDA / InterestExpense | 償債能力視角     |\n\n---\n\n## 倍數因子 (M)\n\n### 定義\n\n倍數因子反映市場給予礦業股的估值倍數：\n\n```\nM_t = EV_t / EBITDA_t\n```\n\n### 直覺\n\n| M 值    | 解讀                           |\n|---------|--------------------------------|\n| M > 10  | 估值偏高，市場樂觀             |\n| M ≈ 6-8 | 礦業股歷史平均區間             |\n| M < 5   | 估值偏低，可能被低估或反映風險 |\n\n### EBITDA 計算\n\n若無直接欄位：\n\n```python\ndef compute_ebitda_proxy(operating_income, depreciation):\n    \"\"\"\n    EBITDA ≈ Operating Income + D&A\n    \"\"\"\n    return operating_income + depreciation\n```\n\n### 替代方法\n\n| 方法      | 公式            | 適用場景                   |\n|-----------|-----------------|----------------------------|\n| EV/EBITDA | EV / EBITDA     | 標準方法（推薦）           |\n| P/NAV     | Price / NAV     | 資產淨值視角（需礦區估值） |\n| FCF Yield | FCF / MarketCap | 自由現金流視角             |\n\n---\n\n## 稀釋因子 (D)\n\n### 定義\n\n稀釋因子反映股權稀釋對每股價值的影響：\n\n```\nD_t = Shares_base / Shares_t\n```\n\n其中：\n- **Shares_base**：基期股數（如 1 年前或分析起點）\n- **Shares_t**：當前股數\n\n### 直覺\n\n| D 值    | 解讀                           |\n|---------|--------------------------------|\n| D = 1   | 無稀釋                         |\n| D > 1   | 股數減少（回購），每股價值提升 |\n| D < 1   | 股數增加（增發），每股價值稀釋 |\n| D = 0.8 | 股數增加 25%，每股價值稀釋 20% |\n\n### 礦業公司常見稀釋來源\n\n| 來源       | 說明                     |\n|------------|--------------------------|\n| 股權融資   | 發行新股籌資（熊市常見） |\n| 可轉債轉換 | 債轉股                   |\n| 員工選擇權 | 管理層激勵               |\n| 併購對價   | 以股票支付收購           |\n\n### 計算\n\n```python\ndef compute_dilution_factor(shares_now, shares_base):\n    \"\"\"\n    D = Shares_base / Shares_now\n\n    D < 1 表示有稀釋\n    D > 1 表示有回購\n    \"\"\"\n    if shares_now <= 0:\n        return None\n\n    D = shares_base / shares_now\n    dilution_pct = 1 - D  # 正值表示稀釋，負值表示回購\n\n    return {\n        'D': D,\n        'dilution_pct': dilution_pct,\n        'shares_change': shares_now / shares_base - 1\n    }\n```\n\n---\n\n## 權重加總\n\n當分析 ETF 或股票組合時，需將個股因子加權匯總：\n\n```python\ndef weighted_aggregate(company_factors, weights):\n    \"\"\"\n    權重加總各因子\n\n    Parameters\n    ----------\n    company_factors : list[dict]\n        各公司的因子 {'C': ..., 'one_minus_L': ..., 'M': ..., 'D': ...}\n    weights : list[float]\n        權重，總和應為 1\n\n    Returns\n    -------\n    dict\n        加權匯總後的因子\n    \"\"\"\n    agg = {\n        'C': 0,\n        'one_minus_L': 0,\n        'M': 0,\n        'D': 0,\n        'aisc': 0,\n        'net_debt_to_ev': 0\n    }\n\n    for factors, w in zip(company_factors, weights):\n        agg['C'] += factors['C'] * w\n        agg['one_minus_L'] += factors['one_minus_L'] * w\n        agg['M'] += factors['M'] * w\n        agg['D'] += factors['D'] * w\n        agg['aisc'] += factors['aisc'] * w\n        agg['net_debt_to_ev'] += factors['L'] * w\n\n    return agg\n```\n\n---\n\n## 因子驅動分析\n\n識別比率變動的主要驅動因素：\n\n```python\ndef analyze_factor_contribution(factors_now, factors_base):\n    \"\"\"\n    分析各因子對比率變動的貢獻\n\n    Returns\n    -------\n    dict\n        各因子變化與貢獻排名\n    \"\"\"\n    changes = {\n        'cost': factors_now['C'] / factors_base['C'] - 1,\n        'leverage': factors_now['one_minus_L'] / factors_base['one_minus_L'] - 1,\n        'multiple': factors_now['M'] / factors_base['M'] - 1,\n        'dilution': factors_now['D'] / factors_base['D'] - 1\n    }\n\n    # 按絕對值排名\n    ranking = sorted(changes.items(), key=lambda x: abs(x[1]), reverse=True)\n\n    return {\n        'changes': changes,\n        'dominant_driver': ranking[0][0],\n        'ranking': [f[0] for f in ranking]\n    }\n```\n\n---\n\n## 敏感度分析\n\n各因子變動對比率的影響：\n\n| 因子變動            | 對比率 R 的影響           |\n|---------------------|---------------------------|\n| AISC 上升 10%       | C 下降 → R 下降約 3-5%    |\n| NetDebt/EV 上升 10% | (1-L) 下降 → R 下降約 10% |\n| EV/EBITDA 下降 10%  | M 下降 → R 下降約 10%     |\n| 股數增加 10%        | D 下降 → R 下降約 10%     |\n\n**關鍵洞察**：倍數因子（M）和槓桿因子（1-L）對比率的影響是 1:1 的線性關係，而成本因子（C）的影響取決於 AISC/S 的水平。\n",
        "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/references/input-schema.md": "# 輸入參數定義\n\n本文件定義 `backsolve-miner-vs-metal-ratio-with-fundamentals` 技能的完整輸入參數。\n\n## 核心參數\n\n### metal_symbol\n\n| 屬性     | 值                                |\n|----------|-----------------------------------|\n| 類型     | string                            |\n| 必要性   | Required                          |\n| 預設值   | `\"SI=F\"`                          |\n| 說明     | 金屬價格代碼（Yahoo Finance 格式）|\n\n**可用值**\n\n| 金屬   | 代碼      | 說明                   |\n|--------|-----------|------------------------|\n| 白銀   | SI=F      | COMEX 白銀期貨（推薦） |\n| 白銀   | XAGUSD=X  | 白銀現貨               |\n| 白銀   | SLV       | iShares 白銀 ETF       |\n| 黃金   | GC=F      | COMEX 黃金期貨         |\n| 黃金   | XAUUSD=X  | 黃金現貨               |\n| 黃金   | GLD       | SPDR 黃金 ETF          |\n\n---\n\n### miner_universe\n\n| 屬性     | 值                                              |\n|----------|-------------------------------------------------|\n| 類型     | object                                          |\n| 必要性   | Required                                        |\n| 說明     | 礦業股/ETF 定義                                 |\n\n**結構**\n\n```json\n{\n  \"type\": \"etf_holdings\" | \"ticker_list\",\n  \"etf_ticker\": \"SIL\",                    // type=etf_holdings 時必填\n  \"tickers\": [\"PAAS\", \"AG\", \"HL\", ...],   // type=ticker_list 時必填\n  \"weights\": [0.12, 0.08, 0.07, ...]      // 選填，空則等權\n}\n```\n\n**ETF 選項**\n\n| ETF   | 說明                              | 適用場景           |\n|-------|-----------------------------------|--------------------|\n| SIL   | Global X Silver Miners ETF        | 白銀礦業（推薦）   |\n| SILJ  | ETFMG Prime Junior Silver Miners  | 小型白銀礦業       |\n| GDX   | VanEck Gold Miners ETF            | 黃金礦業           |\n| GDXJ  | VanEck Junior Gold Miners ETF     | 小型黃金礦業       |\n\n---\n\n### region_profile\n\n| 屬性     | 值                                |\n|----------|-----------------------------------|\n| 類型     | string                            |\n| 必要性   | Required                          |\n| 預設值   | `\"us_sec\"`                        |\n| 說明     | 監管與揭露來源配置                |\n\n**可用值**\n\n| 值            | 說明                                             |\n|---------------|--------------------------------------------------|\n| us_sec        | 美國 SEC EDGAR（10-K/10-Q XBRL）                 |\n| canada_sedar  | 加拿大 SEDAR+（年報/MD&A）                       |\n| mixed         | 混合模式：依公司上市地自動選擇                   |\n\n---\n\n### time_range\n\n| 屬性     | 值                                |\n|----------|-----------------------------------|\n| 類型     | object                            |\n| 必要性   | Required                          |\n| 說明     | 分析時間區間                      |\n\n**結構**\n\n```json\n{\n  \"start\": \"2020-01-01\",    // YYYY-MM-DD\n  \"end\": \"2026-01-21\",      // YYYY-MM-DD 或 \"today\"\n  \"frequency\": \"weekly\"     // daily | weekly | monthly\n}\n```\n\n**頻率建議**\n\n| 頻率    | 適用場景                         |\n|---------|----------------------------------|\n| daily   | 短期分析、高精度回測             |\n| weekly  | 中長期分析（推薦）               |\n| monthly | 長期趨勢、降低雜訊               |\n\n---\n\n### ratio_thresholds\n\n| 屬性     | 值                                |\n|----------|-----------------------------------|\n| 類型     | object                            |\n| 必要性   | Optional                          |\n| 說明     | 統計門檻定義                      |\n\n**結構**\n\n```json\n{\n  \"bottom_quantile\": 0.20,   // 底部分位數（預設 20%）\n  \"top_quantile\": 0.80       // 頂部分位數（預設 80%）\n}\n```\n\n**建議範圍**\n\n| 風格     | bottom | top  | 說明                       |\n|----------|--------|------|----------------------------|\n| 標準     | 0.20   | 0.80 | 平衡敏感度與可靠性         |\n| 保守     | 0.10   | 0.90 | 更極端才觸發訊號           |\n| 積極     | 0.25   | 0.75 | 更早觸發訊號               |\n\n---\n\n## 因子方法選擇\n\n### fundamental_methods\n\n| 屬性     | 值                                |\n|----------|-----------------------------------|\n| 類型     | object                            |\n| 必要性   | Optional                          |\n| 說明     | 各因子的計算方法選擇              |\n\n**結構**\n\n```json\n{\n  \"aisc_method\": \"hybrid\",\n  \"leverage_method\": \"net_debt_to_ev\",\n  \"multiple_method\": \"ev_to_ebitda\",\n  \"dilution_method\": \"weighted_avg_shares\"\n}\n```\n\n---\n\n#### aisc_method\n\nAISC（全維持成本）的抽取方法。\n\n| 值                           | 說明                                              |\n|------------------------------|---------------------------------------------------|\n| reported_text_extract        | 從 MD&A 文字抽取揭露的 AISC                       |\n| proxy_cash_cost_plus_sustaining | Proxy 回算：(OpCost + SustCapex + G&A - Byproduct) / Oz |\n| hybrid                       | 優先抽取，缺失時用 proxy 補齊（推薦）             |\n\n---\n\n#### leverage_method\n\n槓桿因子的計算方法。\n\n| 值                  | 公式                        | 說明                     |\n|---------------------|-----------------------------|--------------------------|\n| net_debt_to_ev      | NetDebt / EV                | 推薦，直觀反映財務風險   |\n| net_debt_to_ebitda  | NetDebt / EBITDA            | 獲利能力視角             |\n| interest_coverage   | EBITDA / InterestExpense    | 償債能力視角             |\n\n---\n\n#### multiple_method\n\n倍數因子的計算方法。\n\n| 值           | 公式           | 說明                       |\n|--------------|----------------|----------------------------|\n| ev_to_ebitda | EV / EBITDA    | 推薦，業界標準估值倍數     |\n| p_to_nav_proxy | P / NAV      | 資產淨值視角（需礦區估值） |\n| fcf_yield    | FCF / MarketCap| 自由現金流視角             |\n\n---\n\n#### dilution_method\n\n稀釋因子的計算方法。\n\n| 值                  | 說明                                   |\n|---------------------|----------------------------------------|\n| weighted_avg_shares | 加權平均股數 YoY 變化（推薦）          |\n| shares_outstanding  | 流通股數 YoY 變化                      |\n\n---\n\n## 數據源偏好\n\n### data_sources\n\n| 屬性     | 值                                |\n|----------|-----------------------------------|\n| 類型     | object                            |\n| 必要性   | Optional                          |\n| 說明     | 數據源偏好設定                    |\n\n**結構**\n\n```json\n{\n  \"prices\": \"yfinance\",\n  \"filings\": \"sec_edgar\",\n  \"holdings\": \"etf_provider\"\n}\n```\n\n**選項**\n\n| 類別     | 選項                                             |\n|----------|--------------------------------------------------|\n| prices   | yfinance（預設）、stooq、alphavantage            |\n| filings  | sec_edgar（預設）、sedar_plus、company_reports   |\n| holdings | etf_provider（預設）、sec_nport、manual_csv_url  |\n\n---\n\n## 快取設定\n\n### cache\n\n| 屬性     | 值                                |\n|----------|-----------------------------------|\n| 類型     | object                            |\n| 必要性   | Optional                          |\n| 說明     | 快取與重現性設定                  |\n\n**結構**\n\n```json\n{\n  \"enabled\": true,\n  \"dir\": \"./cache\",\n  \"max_age_hours\": 168   // 7 天\n}\n```\n\n---\n\n## 輸出選項\n\n### output_options\n\n| 屬性     | 值                                |\n|----------|-----------------------------------|\n| 類型     | object                            |\n| 必要性   | Optional                          |\n| 說明     | 輸出內容控制                      |\n\n**結構**\n\n```json\n{\n  \"export_tables\": true,\n  \"export_charts\": true,\n  \"export_intermediate_json\": true,\n  \"output_format\": \"json\"    // json | markdown | both\n}\n```\n\n---\n\n## 完整輸入範例\n\n```json\n{\n  \"metal_symbol\": \"SI=F\",\n  \"miner_universe\": {\n    \"type\": \"etf_holdings\",\n    \"etf_ticker\": \"SIL\"\n  },\n  \"region_profile\": \"mixed\",\n  \"time_range\": {\n    \"start\": \"2015-01-01\",\n    \"end\": \"today\",\n    \"frequency\": \"weekly\"\n  },\n  \"ratio_thresholds\": {\n    \"bottom_quantile\": 0.20,\n    \"top_quantile\": 0.80\n  },\n  \"fundamental_methods\": {\n    \"aisc_method\": \"hybrid\",\n    \"leverage_method\": \"net_debt_to_ev\",\n    \"multiple_method\": \"ev_to_ebitda\",\n    \"dilution_method\": \"weighted_avg_shares\"\n  },\n  \"data_sources\": {\n    \"prices\": \"yfinance\",\n    \"filings\": \"sec_edgar\",\n    \"holdings\": \"etf_provider\"\n  },\n  \"cache\": {\n    \"enabled\": true,\n    \"dir\": \"./cache\"\n  },\n  \"output_options\": {\n    \"export_tables\": true,\n    \"export_charts\": true,\n    \"output_format\": \"json\"\n  }\n}\n```\n",
        "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/templates/output-json.md": "# JSON 輸出模板\n\n本文件定義 `backsolve-miner-vs-metal-ratio-with-fundamentals` 的標準 JSON 輸出結構。\n\n## 完整結構\n\n```json\n{\n  \"skill\": \"backsolve_miner_vs_metal_ratio_with_fundamentals\",\n  \"version\": \"0.1.0\",\n  \"generated_at\": \"2026-01-21T12:00:00Z\",\n\n  \"inputs\": {\n    \"metal_symbol\": \"SI=F\",\n    \"miner_universe\": {\n      \"type\": \"etf_holdings\",\n      \"etf_ticker\": \"SIL\"\n    },\n    \"region_profile\": \"us_sec\",\n    \"time_range\": {\n      \"start\": \"2015-01-01\",\n      \"end\": \"2026-01-21\",\n      \"frequency\": \"weekly\"\n    },\n    \"ratio_thresholds\": {\n      \"bottom_quantile\": 0.20,\n      \"top_quantile\": 0.80\n    },\n    \"fundamental_methods\": {\n      \"aisc_method\": \"hybrid\",\n      \"leverage_method\": \"net_debt_to_ev\",\n      \"multiple_method\": \"ev_to_ebitda\",\n      \"dilution_method\": \"weighted_avg_shares\"\n    }\n  },\n\n  \"now\": {\n    \"date\": \"2026-01-17\",\n    \"metal_price\": 94.4,\n    \"miner_price\": 103.4,\n    \"ratio\": 1.13,\n    \"ratio_percentile\": 0.111,\n    \"zone\": \"bottom\"\n  },\n\n  \"thresholds\": {\n    \"bottom_ratio\": 1.20,\n    \"top_ratio\": 1.70,\n    \"median_ratio\": 1.51,\n    \"current_vs_bottom\": -0.06,\n    \"current_vs_top\": -0.34\n  },\n\n  \"fundamentals_weighted\": {\n    \"aisc_usd_per_oz\": 28.0,\n    \"net_debt_millions\": 1250,\n    \"ev_millions\": 5000,\n    \"net_debt_to_ev\": 0.25,\n    \"ebitda_millions\": 780,\n    \"ev_to_ebitda\": 6.4,\n    \"shares_millions\": 450,\n    \"shares_yoy_change\": 0.12,\n    \"holdings_count\": 35,\n    \"top10_weight\": 0.62\n  },\n\n  \"factors_now\": {\n    \"cost_factor_C\": 0.7034,\n    \"leverage_factor_1_minus_L\": 0.75,\n    \"multiple_M\": 6.4,\n    \"dilution_discount_D\": 0.89,\n    \"calibration_K\": 0.27\n  },\n\n  \"factor_changes_yoy\": {\n    \"cost_factor_change\": -0.05,\n    \"leverage_factor_change\": -0.02,\n    \"multiple_change\": -0.18,\n    \"dilution_change\": -0.12,\n    \"dominant_driver\": \"multiple_compression\"\n  },\n\n  \"backsolve_to_top\": {\n    \"target_ratio\": 1.70,\n    \"ratio_multiplier\": 1.50,\n    \"single_factor\": {\n      \"multiple_only_need\": 9.6,\n      \"multiple_change_pct\": 0.50,\n      \"deleverage_only_need_1_minus_L\": 1.125,\n      \"deleverage_feasible\": false,\n      \"cost_only_need_C\": 1.055,\n      \"cost_only_implied_aisc\": -5.2,\n      \"cost_feasible\": false,\n      \"dilution_only_need_D\": 1.335,\n      \"dilution_feasible\": false\n    },\n    \"two_factor_grid\": [\n      {\n        \"scenario\": \"multiple_up_metal_down\",\n        \"multiple_change\": 0.20,\n        \"metal_change\": -0.15,\n        \"achieved_multiplier\": 1.52,\n        \"hits_target\": true\n      },\n      {\n        \"scenario\": \"multiple_up_metal_down\",\n        \"multiple_change\": 0.30,\n        \"metal_change\": 0.00,\n        \"achieved_multiplier\": 1.30,\n        \"hits_target\": false\n      },\n      {\n        \"scenario\": \"multiple_up_deleverage\",\n        \"multiple_change\": 0.15,\n        \"leverage_change\": -0.10,\n        \"achieved_multiplier\": 1.38,\n        \"hits_target\": false\n      }\n    ],\n    \"minimum_combination\": {\n      \"multiple_change\": 0.20,\n      \"metal_change\": -0.15,\n      \"or_equivalent\": \"EV/EBITDA 從 6.4x 升至 7.7x + 白銀從 $94 跌至 $80\"\n    }\n  },\n\n  \"backsolve_to_median\": {\n    \"target_ratio\": 1.51,\n    \"ratio_multiplier\": 1.34,\n    \"single_factor\": {\n      \"multiple_only_need\": 8.6,\n      \"multiple_change_pct\": 0.34\n    }\n  },\n\n  \"event_study\": {\n    \"bottom_threshold\": 1.20,\n    \"min_separation_days\": 180,\n    \"events_count\": 5,\n    \"bottom_events\": [\n      {\n        \"date\": \"2015-08-07\",\n        \"ratio\": 1.15,\n        \"aisc\": 18.5,\n        \"net_debt_to_ev\": 0.22,\n        \"ev_to_ebitda\": 5.2,\n        \"shares_yoy\": 0.08,\n        \"dominant_driver\": \"multiple_compression\",\n        \"context\": \"商品熊市末期\"\n      },\n      {\n        \"date\": \"2020-03-20\",\n        \"ratio\": 1.08,\n        \"aisc\": 22.0,\n        \"net_debt_to_ev\": 0.35,\n        \"ev_to_ebitda\": 4.5,\n        \"shares_yoy\": 0.15,\n        \"dominant_driver\": \"leverage_spike\",\n        \"context\": \"COVID 危機\"\n      },\n      {\n        \"date\": \"2022-09-02\",\n        \"ratio\": 1.12,\n        \"aisc\": 26.0,\n        \"net_debt_to_ev\": 0.28,\n        \"ev_to_ebitda\": 5.8,\n        \"shares_yoy\": 0.10,\n        \"dominant_driver\": \"cost_increase\",\n        \"context\": \"通膨推高 AISC\"\n      },\n      {\n        \"date\": \"2024-06-28\",\n        \"ratio\": 1.10,\n        \"aisc\": 27.5,\n        \"net_debt_to_ev\": 0.26,\n        \"ev_to_ebitda\": 5.5,\n        \"shares_yoy\": 0.14,\n        \"dominant_driver\": \"dilution\",\n        \"context\": \"\"\n      },\n      {\n        \"date\": \"2026-01-02\",\n        \"ratio\": 1.13,\n        \"aisc\": 28.0,\n        \"net_debt_to_ev\": 0.25,\n        \"ev_to_ebitda\": 6.4,\n        \"shares_yoy\": 0.12,\n        \"dominant_driver\": \"multiple_compression\",\n        \"context\": \"當前\"\n      }\n    ],\n    \"driver_frequency\": {\n      \"multiple_compression\": 3,\n      \"cost_increase\": 2,\n      \"leverage_spike\": 1,\n      \"dilution\": 2\n    }\n  },\n\n  \"holdings_detail\": [\n    {\n      \"ticker\": \"PAAS\",\n      \"name\": \"Pan American Silver\",\n      \"weight\": 0.125,\n      \"aisc\": 24.5,\n      \"aisc_method\": \"reported\",\n      \"net_debt_to_ev\": 0.18,\n      \"ev_to_ebitda\": 7.2,\n      \"shares_yoy\": 0.05\n    },\n    {\n      \"ticker\": \"AG\",\n      \"name\": \"First Majestic Silver\",\n      \"weight\": 0.082,\n      \"aisc\": 26.8,\n      \"aisc_method\": \"reported\",\n      \"net_debt_to_ev\": 0.22,\n      \"ev_to_ebitda\": 6.8,\n      \"shares_yoy\": 0.08\n    }\n  ],\n\n  \"summary\": \"SIL/白銀比率處於歷史底部區間（11.1% 分位數），主要驅動因素為倍數壓縮（EV/EBITDA 從 8x 壓縮至 6.4x）。回到歷史頂部需要倍數擴張約 50%，或結合倍數 +20% 與白銀回調 -15%。\",\n\n  \"notes\": [\n    \"AISC 使用 hybrid 方法回算，部分公司為 proxy 值\",\n    \"財報數據時滯 1-2 季，反映過去而非當前狀態\",\n    \"建議交叉驗證：COT 持倉、ETF 流量、美元/實質利率\",\n    \"比率訊號衡量「相對估值」，非單邊價格預測\"\n  ],\n\n  \"data_sources\": {\n    \"prices\": \"yfinance\",\n    \"filings\": \"sec_edgar\",\n    \"holdings\": \"globalxetfs.com\",\n    \"holdings_date\": \"2026-01-15\"\n  }\n}\n```\n\n## 欄位說明\n\n### 頂層欄位\n\n| 欄位         | 類型   | 說明                         |\n|--------------|--------|------------------------------|\n| skill        | string | 技能 ID                      |\n| version      | string | 技能版本                     |\n| generated_at | string | 輸出生成時間（ISO 8601）     |\n| inputs       | object | 輸入參數                     |\n| now          | object | 當前狀態                     |\n| thresholds   | object | 歷史分位門檻                 |\n| fundamentals_weighted | object | 權重加總後的基本面        |\n| factors_now  | object | 當前四大因子                 |\n| factor_changes_yoy | object | 因子 YoY 變化            |\n| backsolve_to_top | object | 反推到頂部               |\n| event_study  | object | 歷史事件研究                 |\n| holdings_detail | array | 持股明細                   |\n| summary      | string | 摘要                         |\n| notes        | array  | 注意事項                     |\n| data_sources | object | 數據來源標註                 |\n\n### now 欄位\n\n| 欄位             | 類型   | 說明                       |\n|------------------|--------|----------------------------|\n| date             | string | 數據日期                   |\n| metal_price      | number | 金屬價格                   |\n| miner_price      | number | 礦業股/ETF 價格            |\n| ratio            | number | 比率                       |\n| ratio_percentile | number | 歷史分位數（0-1）          |\n| zone             | string | 區間判定（bottom/low/...） |\n\n### factors_now 欄位\n\n| 欄位                   | 類型   | 說明                       |\n|------------------------|--------|----------------------------|\n| cost_factor_C          | number | 成本因子 = 1 - AISC/S      |\n| leverage_factor_1_minus_L | number | 槓桿因子 = 1 - ND/EV    |\n| multiple_M             | number | 倍數因子 = EV/EBITDA       |\n| dilution_discount_D    | number | 稀釋因子 = Shares_base/now |\n| calibration_K          | number | 校準常數                   |\n",
        "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/templates/output-markdown.md": "# Markdown 報告模板\n\n本文件定義 `backsolve-miner-vs-metal-ratio-with-fundamentals` 的 Markdown 報告格式。\n\n## 報告模板\n\n```markdown\n# 礦業股/金屬價格比率基本面分析\n\n**生成時間**：{generated_at}\n**分析標的**：{miner_universe.etf_ticker} / {metal_symbol}\n\n---\n\n## 當前狀態\n\n| 指標       | 數值                   | 解讀                        |\n|------------|------------------------|-----------------------------|\n| 金屬價格   | ${metal_price}         | {metal_symbol}              |\n| 礦業股價格 | ${miner_price}         | {miner_universe.etf_ticker} |\n| 當前比率   | {ratio}                | 礦業股 / 金屬               |\n| 歷史分位數 | {ratio_percentile:.1%} | {zone_description}          |\n| 區間判定   | {zone}                 |                             |\n\n---\n\n## 歷史門檻\n\n| 門檻       | 比率值         | 與當前差距               |\n|------------|----------------|--------------------------|\n| 底部 (20%) | {bottom_ratio} | {current_vs_bottom:+.1%} |\n| 中位數     | {median_ratio} |                          |\n| 頂部 (80%) | {top_ratio}    | {current_vs_top:+.1%}    |\n\n---\n\n## 四大基本面因子\n\n| 因子       | 當前值                | 說明                                                         |\n|------------|-----------------------|--------------------------------------------------------------|\n| 成本因子 C | {cost_factor_C:.3f}   | AISC = ${aisc}/oz，{cost_interpretation}                     |\n| 槓桿因子   | {leverage_factor:.3f} | NetDebt/EV = {net_debt_to_ev:.0%}，{leverage_interpretation} |\n| 倍數因子 M | {multiple_M:.1f}x     | EV/EBITDA，{multiple_interpretation}                         |\n| 稀釋因子 D | {dilution_D:.3f}      | 股數 YoY {shares_yoy:+.0%}，{dilution_interpretation}        |\n\n### 因子驅動排名（YoY 變化）\n\n1. **{driver_1}**：{driver_1_change:+.1%}\n2. **{driver_2}**：{driver_2_change:+.1%}\n3. **{driver_3}**：{driver_3_change:+.1%}\n4. **{driver_4}**：{driver_4_change:+.1%}\n\n**主要驅動**：{dominant_driver_description}\n\n---\n\n## 門檻反推：回到頂部需要什麼？\n\n**目標比率**：{target_ratio}（頂部 80% 分位）\n**當前比率**：{current_ratio}\n**需要倍數**：{ratio_multiplier:.2f}x\n\n### 單因子反推\n\n| 假設條件     | 需要的調整                                                       | 可行性       |\n|--------------|------------------------------------------------------------------|--------------|\n| 只靠倍數擴張 | EV/EBITDA 從 {M_now:.1f}x 升至 {M_target:.1f}x (+{M_change:.0%}) | {M_feasible} |\n| 只靠去槓桿   | NetDebt/EV 從 {ND_EV_now:.0%} 降至 {ND_EV_target:.0%}            | {L_feasible} |\n| 只靠成本改善 | AISC 從 ${AISC_now} 降至 ${AISC_target}                          | {C_feasible} |\n| 只靠減少稀釋 | 股數需減少 {D_change:.0%}                                        | {D_feasible} |\n\n### 雙因子組合\n\n| 組合            | 倍數調整           | 其他調整              | 達標         |\n|-----------------|--------------------|-----------------------|--------------|\n| 倍數 + 白銀回調 | +{combo1_M:.0%}    | 白銀 {combo1_S:+.0%}  | {combo1_hit} |\n| 倍數 + 去槓桿   | +{combo2_M:.0%}    | ND/EV {combo2_L:+.0%} | {combo2_hit} |\n| 成本改善 + 倍數 | AISC {combo3_AISC} | +{combo3_M:.0%}       | {combo3_hit} |\n\n---\n\n## 歷史底部事件研究\n\n過去 {lookback_years} 年偵測到 **{events_count} 次**底部區間事件（分位數 ≤ 20%）：\n\n| # | 日期 | 比率 | 主要驅動 | 背景說明 |\n|---|------|------|----------|----------|\n{event_rows}\n\n### 驅動因素統計\n\n| 因素     | 出現次數         | 頻率               |\n|----------|------------------|--------------------|\n| 倍數壓縮 | {multiple_count} | {multiple_pct:.0%} |\n| 成本上升 | {cost_count}     | {cost_pct:.0%}     |\n| 槓桿惡化 | {leverage_count} | {leverage_pct:.0%} |\n| 股權稀釋 | {dilution_count} | {dilution_pct:.0%} |\n\n---\n\n## 前 10 大持股基本面\n\n| Ticker | 公司 | 權重 | AISC | ND/EV | EV/EBITDA | 股數YoY |\n|--------|------|------|------|-------|-----------|---------|\n{holdings_rows}\n\n---\n\n## 摘要\n\n{summary}\n\n---\n\n## 注意事項\n\n{notes_list}\n\n---\n\n## 數據來源\n\n- **價格**：{prices_source}\n- **財報**：{filings_source}\n- **持股**：{holdings_source}（{holdings_date}）\n\n---\n\n*本報告由 backsolve-miner-vs-metal-ratio-with-fundamentals 技能生成*\n```\n\n## 範例輸出\n\n```markdown\n# 礦業股/金屬價格比率基本面分析\n\n**生成時間**：2026-01-21 12:00:00\n**分析標的**：SIL / SI=F\n\n---\n\n## 當前狀態\n\n| 指標       | 數值          | 解讀             |\n|------------|---------------|------------------|\n| 金屬價格   | $94.4         | SI=F             |\n| 礦業股價格 | $103.4        | SIL              |\n| 當前比率   | 1.13          | 礦業股 / 金屬    |\n| 歷史分位數 | 11.1%         | 處於歷史底部區間 |\n| 區間判定   | 底部 (bottom) |                  |\n\n---\n\n## 歷史門檻\n\n| 門檻       | 比率值 | 與當前差距 |\n|------------|--------|------------|\n| 底部 (20%) | 1.20   | -6.2%      |\n| 中位數     | 1.51   |            |\n| 頂部 (80%) | 1.70   | -33.5%     |\n\n---\n\n## 四大基本面因子\n\n| 因子       | 當前值 | 說明                       |\n|------------|--------|----------------------------|\n| 成本因子 C | 0.703  | AISC = $28/oz，成本偏高    |\n| 槓桿因子   | 0.750  | NetDebt/EV = 25%，槓桿中等 |\n| 倍數因子 M | 6.4x   | EV/EBITDA，倍數偏低        |\n| 稀釋因子 D | 0.890  | 股數 YoY +12%，有稀釋壓力  |\n\n### 因子驅動排名（YoY 變化）\n\n1. **倍數壓縮**：-18.0%\n2. **股權稀釋**：-12.0%\n3. **成本上升**：-5.0%\n4. **槓桿中性**：-2.0%\n\n**主要驅動**：比率落入底部主要由「倍數壓縮」驅動，EV/EBITDA 從 8x 壓縮至 6.4x。\n\n---\n\n## 門檻反推：回到頂部需要什麼？\n\n**目標比率**：1.70（頂部 80% 分位）\n**當前比率**：1.13\n**需要倍數**：1.50x\n\n### 單因子反推\n\n| 假設條件     | 需要的調整                         | 可行性     |\n|--------------|------------------------------------|------------|\n| 只靠倍數擴張 | EV/EBITDA 從 6.4x 升至 9.6x (+50%) | 可能但激進 |\n| 只靠去槓桿   | NetDebt/EV 從 25% 降至 <0%         | 不現實     |\n| 只靠成本改善 | AISC 從 $28 降至 <$0               | 不可能     |\n| 只靠減少稀釋 | 股數需減少 33%                     | 不現實     |\n\n### 雙因子組合\n\n| 組合            | 倍數調整 | 其他調整   | 達標 |\n|-----------------|----------|------------|------|\n| 倍數 + 白銀回調 | +20%     | 白銀 -15%  | ✓    |\n| 倍數 + 去槓桿   | +15%     | ND/EV -10% | ✗    |\n| 成本改善 + 倍數 | AISC -$5 | +10%       | ✗    |\n\n---\n\n## 歷史底部事件研究\n\n過去 10 年偵測到 **5 次**底部區間事件（分位數 ≤ 20%）：\n\n| # | 日期       | 比率 | 主要驅動 | 背景說明      |\n|---|------------|------|----------|---------------|\n| 1 | 2015-08-07 | 1.15 | 倍數壓縮 | 商品熊市末期  |\n| 2 | 2020-03-20 | 1.08 | 槓桿惡化 | COVID 危機    |\n| 3 | 2022-09-02 | 1.12 | 成本上升 | 通膨推高 AISC |\n| 4 | 2024-06-28 | 1.10 | 股權稀釋 |               |\n| 5 | 2026-01-02 | 1.13 | 倍數壓縮 | 當前          |\n\n### 驅動因素統計\n\n| 因素     | 出現次數 | 頻率 |\n|----------|----------|------|\n| 倍數壓縮 | 3        | 60%  |\n| 成本上升 | 2        | 40%  |\n| 槓桿惡化 | 1        | 20%  |\n| 股權稀釋 | 2        | 40%  |\n\n---\n\n## 摘要\n\nSIL/白銀比率處於歷史底部區間（11.1% 分位數），主要驅動因素為倍數壓縮（EV/EBITDA 從 8x 壓縮至 6.4x）。回到歷史頂部需要倍數擴張約 50%，或結合倍數 +20% 與白銀回調 -15%。\n\n---\n\n## 注意事項\n\n- AISC 使用 hybrid 方法回算，部分公司為 proxy 值\n- 財報數據時滯 1-2 季，反映過去而非當前狀態\n- 建議交叉驗證：COT 持倉、ETF 流量、美元/實質利率\n- 比率訊號衡量「相對估值」，非單邊價格預測\n\n---\n\n## 數據來源\n\n- **價格**：yfinance\n- **財報**：SEC EDGAR\n- **持股**：globalxetfs.com（2026-01-15）\n\n---\n\n*本報告由 backsolve-miner-vs-metal-ratio-with-fundamentals 技能生成*\n```\n",
        "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/workflows/analyze.md": "# Workflow: 完整基本面分析\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/input-schema.md - 完整參數定義\n2. references/fundamental-factors.md - 四大因子計算邏輯\n3. references/backsolve-math.md - 反推數學公式\n</required_reading>\n\n<process>\n\n## Step 1: 確認分析參數\n\n收集以下參數（若未提供則使用預設值）：\n\n```yaml\nmetal_symbol: SI=F          # 金屬價格代碼\nminer_universe:\n  type: etf_holdings         # etf_holdings 或 ticker_list\n  etf_ticker: SIL            # ETF 代碼\nregion_profile: us_sec       # us_sec / canada_sedar / mixed\ntime_range:\n  start: 2020-01-01\n  end: today\n  frequency: weekly\nratio_thresholds:\n  bottom_quantile: 0.20\n  top_quantile: 0.80\nfundamental_methods:\n  aisc_method: hybrid\n  leverage_method: net_debt_to_ev\n  multiple_method: ev_to_ebitda\n  dilution_method: weighted_avg_shares\n```\n\n## Step 2: 取得價格數據\n\n執行價格數據抓取：\n\n```python\nimport yfinance as yf\nimport pandas as pd\n\n# 金屬價格\nmetal = yf.download(\n    \"SI=F\",\n    start=\"2020-01-01\",\n    end=pd.Timestamp.today().strftime('%Y-%m-%d'),\n    interval=\"1wk\"\n)['Close']\n\n# 礦業 ETF 價格\nminer = yf.download(\n    \"SIL\",\n    start=\"2020-01-01\",\n    end=pd.Timestamp.today().strftime('%Y-%m-%d'),\n    interval=\"1wk\"\n)['Close']\n\n# 計算比率\nratio = miner / metal\n```\n\n## Step 3: 取得 ETF 持股與權重\n\n若使用 ETF holdings：\n\n```python\n# 方法 1: 官方 CSV（優先）\n# Global X SIL holdings: https://www.globalxetfs.com/funds/sil/\n\n# 方法 2: SEC N-PORT（備援）\n# 搜尋 CIK 並下載季度持股\n\n# 輸出格式\nholdings = {\n    \"PAAS\": 0.12,  # 權重\n    \"AG\": 0.08,\n    \"HL\": 0.07,\n    # ...\n}\n```\n\n## Step 4: 抓取財報數據\n\n對前 10 大持股執行財報抓取：\n\n```python\n# 對每家公司抓取：\n# 1. 資產負債表：TotalDebt, Cash, Shares\n# 2. 損益表：Revenue, OperatingIncome, NetIncome\n# 3. 現金流量表：CFO, Capex\n# 4. 補充揭露：AISC, 產量 (oz)\n\n# 參考 workflows/data-fetch.md 的詳細抓取流程\n```\n\n## Step 5: 計算四大因子\n\n對每家公司計算因子，再以權重加總：\n\n```python\ndef compute_factors(company_data, metal_price):\n    \"\"\"計算單一公司的四大因子\"\"\"\n    S = metal_price\n\n    # (A) 成本因子\n    aisc = company_data['aisc']\n    C = 1 - aisc / S\n\n    # (B) 槓桿因子\n    net_debt = company_data['total_debt'] - company_data['cash']\n    ev = company_data['market_cap'] + net_debt\n    L = net_debt / ev\n    one_minus_L = 1 - L\n\n    # (C) 倍數因子\n    ebitda = company_data['ebitda']\n    M = ev / ebitda\n\n    # (D) 稀釋因子\n    shares_now = company_data['shares_outstanding']\n    shares_base = company_data['shares_base']  # 基期\n    D = shares_base / shares_now\n\n    return {\n        'C': C,\n        'one_minus_L': one_minus_L,\n        'M': M,\n        'D': D\n    }\n\n# 權重加總\ndef weighted_aggregate(all_factors, weights):\n    C_agg = sum(f['C'] * w for f, w in zip(all_factors, weights))\n    # ... 其他因子類似\n    return {'C': C_agg, ...}\n```\n\n## Step 6: 計算比率分位數與門檻\n\n```python\n# 當前比率\nR_now = float(ratio.iloc[-1])\n\n# 歷史分位數\nR_percentile = (ratio <= R_now).mean()\n\n# 門檻\nR_bottom = ratio.quantile(0.20)\nR_top = ratio.quantile(0.80)\nR_median = ratio.quantile(0.50)\n\n# 區間判定\nif R_percentile <= 0.20:\n    zone = \"bottom\"\nelif R_percentile <= 0.40:\n    zone = \"low\"\nelif R_percentile <= 0.60:\n    zone = \"neutral\"\nelif R_percentile <= 0.80:\n    zone = \"high\"\nelse:\n    zone = \"top\"\n```\n\n## Step 7: 執行門檻反推（Backsolve）\n\n```python\ndef backsolve(R_now, R_target, factors_now, metal_price):\n    \"\"\"反推需要的因子組合\"\"\"\n    ratio_multiplier = R_target / R_now\n\n    C_now = factors_now['C']\n    L_now = factors_now['L']\n    M_now = factors_now['M']\n    D_now = factors_now['D']\n    S = metal_price\n\n    # 單因子反推\n    results = {\n        'multiple_only_need': M_now * ratio_multiplier,\n        'deleverage_only_need_1_minus_L': (1 - L_now) * ratio_multiplier,\n        'cost_only_need_C': C_now * ratio_multiplier,\n        'cost_only_implied_aisc': S * (1 - C_now * ratio_multiplier),\n        'dilution_only_need_D': D_now * ratio_multiplier,\n    }\n\n    # 雙因子組合網格\n    grid = []\n    for m_up in [1.10, 1.15, 1.20]:\n        for metal_down in [-0.10, -0.15, -0.20]:\n            new_ratio = R_now * m_up / (1 + metal_down)\n            hits_target = new_ratio >= R_target\n            grid.append({\n                'multiple_up': m_up,\n                'metal_down': metal_down,\n                'hits_target': hits_target\n            })\n\n    results['two_factor_grid'] = grid\n    return results\n```\n\n## Step 8: 執行事件研究\n\n```python\ndef event_study(ratio, factors_history, bottom_threshold, min_separation=180):\n    \"\"\"歷史底部事件的因子驅動分析\"\"\"\n    # 識別底部事件\n    is_bottom = ratio <= bottom_threshold\n    events = []\n\n    last_event = None\n    for date, val in ratio[is_bottom].items():\n        if last_event is None or (date - last_event).days >= min_separation:\n            events.append(date)\n            last_event = date\n\n    # 對每次事件，分析當期因子\n    results = []\n    for event_date in events:\n        factors = factors_history.loc[event_date]\n\n        # 排名因子貢獻\n        # 假設基期為前 1 年\n        base_date = event_date - pd.Timedelta(days=365)\n        base_factors = factors_history.loc[:base_date].iloc[-1]\n\n        changes = {\n            'aisc_change': factors['aisc'] / base_factors['aisc'] - 1,\n            'leverage_change': factors['leverage'] - base_factors['leverage'],\n            'multiple_change': factors['multiple'] / base_factors['multiple'] - 1,\n            'dilution_change': factors['dilution'] / base_factors['dilution'] - 1,\n        }\n\n        # 識別主要驅動\n        dominant = max(changes, key=lambda k: abs(changes[k]))\n\n        results.append({\n            'date': event_date.strftime('%Y-%m-%d'),\n            'ratio': float(ratio.loc[event_date]),\n            **factors.to_dict(),\n            'dominant_driver': dominant.replace('_change', '')\n        })\n\n    return results\n```\n\n## Step 9: 生成輸出\n\n```python\noutput = {\n    \"skill\": \"backsolve_miner_vs_metal_ratio_with_fundamentals\",\n    \"inputs\": {\n        \"metal_symbol\": \"SI=F\",\n        \"miner_universe\": {\"type\": \"etf_holdings\", \"etf_ticker\": \"SIL\"},\n        \"region_profile\": \"us_sec\"\n    },\n    \"now\": {\n        \"metal_price\": float(metal.iloc[-1]),\n        \"miner_price\": float(miner.iloc[-1]),\n        \"ratio\": R_now,\n        \"ratio_percentile\": R_percentile\n    },\n    \"thresholds\": {\n        \"bottom_ratio\": float(R_bottom),\n        \"top_ratio\": float(R_top),\n        \"median_ratio\": float(R_median)\n    },\n    \"fundamentals_weighted\": {\n        \"aisc_usd_per_oz\": aggregated_aisc,\n        \"net_debt_to_ev\": aggregated_leverage,\n        \"ev_to_ebitda\": aggregated_multiple,\n        \"shares_yoy_change\": aggregated_dilution\n    },\n    \"factors_now\": factors_now,\n    \"backsolve_to_top\": backsolve_results,\n    \"event_study\": {\"bottom_events\": event_results},\n    \"summary\": generate_summary(zone, dominant_factors),\n    \"notes\": [\n        f\"AISC 使用 {aisc_method} 方法回算\",\n        \"建議交叉驗證：COT 持倉、ETF 流量、美元/實質利率\"\n    ]\n}\n\n# 輸出 JSON\nimport json\nwith open('result.json', 'w') as f:\n    json.dump(output, f, indent=2, ensure_ascii=False)\n```\n\n</process>\n\n<success_criteria>\n此工作流完成時應產出：\n\n- [ ] 價格數據已取得並對齊\n- [ ] ETF 持股與權重已解析\n- [ ] 前 10 大持股的財報數據已抓取\n- [ ] 四大因子已計算並權重加總\n- [ ] 比率分位數與門檻已計算\n- [ ] 門檻反推結果已生成\n- [ ] 歷史底部事件已分析\n- [ ] 結果已輸出為 JSON 格式\n- [ ] 數據來源與方法已標註\n</success_criteria>\n",
        "skills/backsolve-miner-vs-metal-ratio-with-fundamentals/workflows/data-fetch.md": "# Workflow: 數據抓取\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/data-sources.md - 數據來源說明\n2. thoughts/shared/guide/design-human-like-crawler.md - 爬蟲設計指南\n</required_reading>\n\n<process>\n\n## Step 1: 價格數據抓取\n\n使用 yfinance 取得價格序列：\n\n```python\nimport yfinance as yf\nimport pandas as pd\n\ndef fetch_prices(symbol: str, start: str, end: str, interval: str = \"1wk\"):\n    \"\"\"\n    抓取價格數據\n\n    Parameters\n    ----------\n    symbol : str\n        Yahoo Finance 代碼（如 SI=F, SIL）\n    start : str\n        起始日期 YYYY-MM-DD\n    end : str\n        結束日期 YYYY-MM-DD\n    interval : str\n        取樣頻率（1d, 1wk, 1mo）\n\n    Returns\n    -------\n    pd.Series\n        收盤價序列\n    \"\"\"\n    data = yf.download(\n        symbol,\n        start=start,\n        end=end,\n        interval=interval,\n        progress=False\n    )\n    return data['Close'].dropna()\n```\n\n**常用代碼對照**\n\n| 資產           | Yahoo Finance 代碼 |\n|----------------|-------------------|\n| 白銀期貨       | SI=F              |\n| 黃金期貨       | GC=F              |\n| 白銀現貨       | XAGUSD=X          |\n| SIL 銀礦 ETF   | SIL               |\n| SILJ 小型銀礦  | SILJ              |\n| GDX 金礦 ETF   | GDX               |\n| SLV 白銀 ETF   | SLV               |\n\n## Step 2: ETF 持股抓取\n\n### 方法 1: 官方 CSV（優先）\n\n```python\nimport pandas as pd\nimport httpx\n\ndef fetch_etf_holdings_csv(etf_ticker: str) -> dict:\n    \"\"\"\n    從 ETF 發行商官網抓取持股 CSV\n\n    Returns\n    -------\n    dict\n        {ticker: weight} 格式\n    \"\"\"\n    # Global X SIL/SILJ\n    if etf_ticker in ['SIL', 'SILJ']:\n        url = f\"https://www.globalxetfs.com/funds/{etf_ticker.lower()}/\"\n        # 需解析 HTML 找到 CSV 下載連結\n        # 或使用已知的 holdings CSV URL\n\n    # VanEck GDX/GDXJ\n    elif etf_ticker in ['GDX', 'GDXJ']:\n        # VanEck 官網 holdings\n\n    # 解析 CSV\n    df = pd.read_csv(holdings_url)\n    holdings = dict(zip(df['Ticker'], df['Weight'] / 100))\n\n    return holdings\n```\n\n### 方法 2: SEC N-PORT（備援）\n\n```python\ndef fetch_nport_holdings(cik: str, filing_date: str = None):\n    \"\"\"\n    從 SEC N-PORT 抓取基金持股\n\n    Parameters\n    ----------\n    cik : str\n        基金的 CIK 編號\n    filing_date : str\n        申報日期（若空則取最新）\n    \"\"\"\n    # SEC EDGAR API\n    base_url = \"https://data.sec.gov/submissions/CIK{cik}.json\"\n\n    # 找到 N-PORT 申報\n    # 解析 XML 取得持股\n```\n\n### 方法 3: 手動 CSV\n\n若以上方法不可用，支援手動提供 CSV URL：\n\n```python\ndef fetch_manual_holdings(csv_url: str) -> dict:\n    df = pd.read_csv(csv_url)\n    # 假設欄位為 Ticker, Weight\n    return dict(zip(df['Ticker'], df['Weight']))\n```\n\n## Step 3: 財報數據抓取（SEC EDGAR）\n\n### 3.1 XBRL JSON API（推薦）\n\n```python\nimport httpx\n\ndef fetch_sec_xbrl(cik: str, ticker: str):\n    \"\"\"\n    使用 SEC XBRL JSON API 抓取財報數據\n\n    API 端點：\n    https://data.sec.gov/api/xbrl/companyfacts/CIK{cik}.json\n    \"\"\"\n    cik_padded = cik.zfill(10)\n    url = f\"https://data.sec.gov/api/xbrl/companyfacts/CIK{cik_padded}.json\"\n\n    headers = {\n        'User-Agent': 'YourApp/1.0 (your@email.com)',\n        'Accept': 'application/json'\n    }\n\n    response = httpx.get(url, headers=headers)\n    data = response.json()\n\n    # 提取常用欄位\n    facts = data.get('facts', {}).get('us-gaap', {})\n\n    result = {\n        'total_debt': extract_latest(facts, 'LongTermDebt'),\n        'cash': extract_latest(facts, 'CashAndCashEquivalentsAtCarryingValue'),\n        'shares': extract_latest(facts, 'CommonStockSharesOutstanding'),\n        'revenue': extract_latest(facts, 'Revenues'),\n        'operating_income': extract_latest(facts, 'OperatingIncomeLoss'),\n        'cfo': extract_latest(facts, 'NetCashProvidedByUsedInOperatingActivities'),\n        'capex': extract_latest(facts, 'PaymentsToAcquirePropertyPlantAndEquipment'),\n    }\n\n    return result\n\n\ndef extract_latest(facts: dict, concept: str):\n    \"\"\"從 XBRL facts 提取最新值\"\"\"\n    if concept not in facts:\n        return None\n\n    units = facts[concept].get('units', {})\n    # 通常是 USD 或 shares\n    values = units.get('USD', units.get('shares', []))\n\n    if not values:\n        return None\n\n    # 取最新申報\n    latest = sorted(values, key=lambda x: x.get('end', ''), reverse=True)[0]\n    return latest.get('val')\n```\n\n### 3.2 公司代碼到 CIK 映射\n\n```python\n# 常見銀礦公司 CIK\nSILVER_MINER_CIKS = {\n    'PAAS': '0001209028',  # Pan American Silver\n    'AG': '0001331877',    # First Majestic Silver\n    'HL': '0000719413',    # Hecla Mining\n    'MAG': '0001331255',   # MAG Silver\n    'EXK': '0001437419',   # Endeavour Silver\n    'CDE': '0000018974',   # Coeur Mining\n    'FSM': '0001555280',   # Fortuna Silver\n}\n```\n\n## Step 4: AISC 抽取（MD&A 文字）\n\n```python\nfrom bs4 import BeautifulSoup\nimport re\n\ndef extract_aisc_from_mda(mda_html: str) -> float:\n    \"\"\"\n    從 MD&A 文字中抽取 AISC\n\n    常見模式：\n    - \"AISC of $X.XX per ounce\"\n    - \"all-in sustaining cost of $X.XX/oz\"\n    - \"AISC was $X.XX per silver ounce\"\n    \"\"\"\n    soup = BeautifulSoup(mda_html, 'lxml')\n    text = soup.get_text()\n\n    patterns = [\n        r'AISC\\s+(?:of\\s+)?\\$?([\\d.]+)\\s*(?:per\\s+)?(?:ounce|oz)',\n        r'all-in\\s+sustaining\\s+cost\\s+(?:of\\s+)?\\$?([\\d.]+)',\n        r'AISC\\s+was\\s+\\$?([\\d.]+)',\n    ]\n\n    for pattern in patterns:\n        match = re.search(pattern, text, re.IGNORECASE)\n        if match:\n            return float(match.group(1))\n\n    return None\n\n\ndef proxy_aisc(financials: dict, production_oz: float) -> float:\n    \"\"\"\n    Proxy 回算 AISC（當直接抽取失敗時）\n\n    AISC ≈ (OpCost + SustainingCapex + G&A - ByproductCredits) / Oz\n    \"\"\"\n    operating_cost = financials.get('cost_of_revenue', 0)\n    sustaining_capex = financials.get('capex', 0) * 0.6  # 假設 60% 為維持性\n    ga = financials.get('ga_expense', 0)\n    byproduct = financials.get('byproduct_credits', 0)\n\n    if production_oz <= 0:\n        return None\n\n    aisc = (operating_cost + sustaining_capex + ga - byproduct) / production_oz\n    return aisc\n```\n\n## Step 5: 加拿大公司（SEDAR+）\n\n```python\ndef fetch_sedar_filing(issuer_name: str):\n    \"\"\"\n    從 SEDAR+ 抓取加拿大公司年報\n\n    注意：SEDAR+ 需要 Selenium 模擬瀏覽器\n    \"\"\"\n    from selenium import webdriver\n    from selenium.webdriver.chrome.options import Options\n    from selenium.webdriver.common.by import By\n    from selenium.webdriver.support.ui import WebDriverWait\n    from selenium.webdriver.support import expected_conditions as EC\n\n    chrome_options = Options()\n    chrome_options.add_argument('--headless')\n    chrome_options.add_argument('--no-sandbox')\n    chrome_options.add_argument('--disable-blink-features=AutomationControlled')\n\n    driver = webdriver.Chrome(options=chrome_options)\n\n    try:\n        # 搜尋公司\n        driver.get(f\"https://www.sedarplus.ca/csa-party/records/search\")\n        # ... 填寫搜尋表單\n        # ... 下載 MD&A PDF\n\n    finally:\n        driver.quit()\n```\n\n## Step 6: 快取策略\n\n```python\nfrom pathlib import Path\nimport json\nfrom datetime import datetime, timedelta\n\nclass DataCache:\n    \"\"\"數據快取管理\"\"\"\n\n    def __init__(self, cache_dir: str = \"cache\"):\n        self.cache_dir = Path(cache_dir)\n        self.cache_dir.mkdir(exist_ok=True)\n\n    def _cache_path(self, key: str) -> Path:\n        return self.cache_dir / f\"{key}.json\"\n\n    def is_fresh(self, key: str, max_age_hours: int = 24) -> bool:\n        path = self._cache_path(key)\n        if not path.exists():\n            return False\n\n        mtime = datetime.fromtimestamp(path.stat().st_mtime)\n        age = datetime.now() - mtime\n        return age < timedelta(hours=max_age_hours)\n\n    def get(self, key: str):\n        if not self.is_fresh(key):\n            return None\n        with open(self._cache_path(key)) as f:\n            return json.load(f)\n\n    def set(self, key: str, data):\n        with open(self._cache_path(key), 'w') as f:\n            json.dump(data, f, indent=2, default=str)\n\n\n# 使用範例\ncache = DataCache()\n\n# 財報快取 7 天（季報頻率）\nif not cache.is_fresh(f\"sec_{ticker}\", max_age_hours=24*7):\n    data = fetch_sec_xbrl(cik, ticker)\n    cache.set(f\"sec_{ticker}\", data)\nelse:\n    data = cache.get(f\"sec_{ticker}\")\n```\n\n## Step 7: 防偵測策略\n\n參考 `thoughts/shared/guide/design-human-like-crawler.md`：\n\n```python\nimport random\nimport time\n\n# 隨機延遲\ndef random_delay(min_sec=1.0, max_sec=3.0):\n    time.sleep(random.uniform(min_sec, max_sec))\n\n# User-Agent 輪換\nUSER_AGENTS = [\n    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) ...',\n    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) ...',\n]\n\ndef get_random_ua():\n    return random.choice(USER_AGENTS)\n```\n\n</process>\n\n<success_criteria>\n此工作流完成時應：\n\n- [ ] 價格數據已從 yfinance 取得\n- [ ] ETF 持股已從官方/N-PORT/手動來源取得\n- [ ] 財報數據已從 SEC EDGAR XBRL API 取得\n- [ ] AISC 已從 MD&A 抽取或 proxy 回算\n- [ ] 數據已快取以避免重複抓取\n- [ ] 爬蟲已設定防偵測策略\n- [ ] 數據來源已標註（aisc_method、data_source）\n</success_criteria>\n",
        "skills/compute-precious-miner-gross-margin/SKILL.md": "---\nname: compute-precious-miner-gross-margin\ndescription: 以公開金屬價格 + 礦業成本指標（AISC/All-in cost/現金成本）計算「黃金/白銀礦業毛利率代理值」，並判斷當前是否處於歷史高/低檔區間。\n---\n\n<essential_principles>\n\n<principle name=\"margin_proxy_definition\">\n**毛利率代理值定義**\n\n礦業毛利率代理（Margin Proxy）使用簡化公式：\n\n```\ngross_margin_proxy = (metal_price - unit_cost) / metal_price\n```\n\n其中：\n- **metal_price**：金屬現貨價或期貨近月價\n- **unit_cost**：AISC (All-In Sustaining Cost)、現金成本(C1)或全成本\n\n此指標**不等同會計報表的毛利率**，但能快速捕捉價格-成本關係的邊際變化。\n</principle>\n\n<principle name=\"cost_metric_hierarchy\">\n**成本指標口徑層次**\n\n| 口徑              | 包含項目                        | 適用場景             |\n|-------------------|---------------------------------|----------------------|\n| Cash Cost (C1)    | 現場採掘 + 加工 + 場內行政      | 現金流壓力測試       |\n| AISC              | C1 + 維持資本開支 + 勘探 + 行政 | 行業標準（WGC 定義） |\n| All-In Cost (AIC) | AISC + 成長資本開支             | 完整經濟成本         |\n\n建議優先使用 **AISC**，因其可比性最佳且資料可得性高。\n</principle>\n\n<principle name=\"aggregation_logic\">\n**籃子聚合邏輯**\n\n| 方法                | 公式                             | 直覺                       |\n|---------------------|----------------------------------|----------------------------|\n| equal_weight        | Σ margin_i / N                   | 簡單平均，每家公司等權     |\n| production_weighted | Σ (margin_i × prod_i) / Σ prod_i | 產量加權，反映「產業毛利」 |\n| marketcap_weighted  | Σ (margin_i × mcap_i) / Σ mcap_i | 市值加權，反映「股權曝險」 |\n\n建議使用 **production_weighted** 以更準確反映產業整體毛利結構。\n</principle>\n\n<principle name=\"data_frequency_alignment\">\n**數據頻率對齊**\n\n- **金屬價格**：日頻或月均價\n- **礦業成本**：季度（多數公司僅在季報揭露 AISC）\n- **對齊方式**：\n  - 將成本 forward-fill 至季度內各期\n  - 或使用同季均價（更乾淨）\n\n本 Skill 建議使用 **季度頻率** 作為基準，避免過度平滑。\n</principle>\n\n<principle name=\"data_sources\">\n**資料取得方式**\n\n本 skill 使用**公開數據**：\n- **金價**：LBMA Gold Price / COMEX 近月期貨\n- **銀價**：LBMA Silver Price / COMEX 近月期貨\n- **AISC**：公司 IR 投資人簡報 / 季報 MD&A / 新聞稿\n- **產量**：同上，單位 oz / GEO / AgEq oz\n\n腳本位於 `scripts/` 目錄，可直接執行。\n</principle>\n\n</essential_principles>\n\n<objective>\n實作「貴金屬礦業毛利率代理值」計算模型：\n\n1. **數據整合**：抓取金屬價格序列與礦業成本/產量數據\n2. **計算毛利率代理**：單一公司層級 + 籃子聚合\n3. **歷史分位數**：判斷當前水位在歷史區間的位置\n4. **驅動拆解**：區分價格驅動 vs 成本驅動\n5. **訊號生成**：極端高/低檔區間標記\n\n輸出：毛利率時序、歷史分位、驅動拆解、交易/研究連結。\n</objective>\n\n<quick_start>\n\n**最快的方式：執行預設情境分析**\n\n```bash\ncd skills/compute-precious-miner-gross-margin\npip install pandas numpy requests yfinance beautifulsoup4 lxml  # 首次使用\npython scripts/margin_calculator.py --quick --metal gold\n```\n\n輸出範例：\n```json\n{\n  \"skill\": \"compute_precious_miner_margin_proxy\",\n  \"metal\": \"gold\",\n  \"frequency\": \"quarterly\",\n  \"cost_metric\": \"AISC\",\n  \"basket\": {\n    \"miners\": [\"NEM\", \"GOLD\", \"AEM\"],\n    \"aggregation\": \"production_weighted\"\n  },\n  \"latest\": {\n    \"date\": \"2025-Q4\",\n    \"metal_price_usd_oz\": 2650.0,\n    \"unit_cost_proxy_usd_oz\": 1320.0,\n    \"gross_margin_proxy\": 0.502,\n    \"history_percentile\": 0.78,\n    \"regime_label\": \"high_margin\"\n  }\n}\n```\n\n**完整情境分析**：\n```bash\npython scripts/margin_calculator.py \\\n  --metal silver \\\n  --miners CDE,HL,AG \\\n  --start-date 2015-01-01 \\\n  --frequency quarterly \\\n  --cost-metric AISC \\\n  --aggregation production_weighted \\\n  --output result.json\n```\n\n</quick_start>\n\n<intake>\n需要進行什麼操作？\n\n1. **快速計算** - 使用預設參數計算主要礦業籃子的毛利率代理\n2. **完整分析** - 自訂參數進行情境分析（可選擇金屬、礦業、成本口徑）\n3. **數據研究** - 了解如何獲取 AISC / 成本數據（爬蟲設計）\n4. **訊號生成** - 將毛利率轉為交易/研究訊號\n5. **方法論學習** - 了解計算邏輯與數據來源\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                    | Action                                             |\n|-----------------------------|----------------------------------------------------|\n| 1, \"快速\", \"quick\", \"計算\"  | 執行 `python scripts/margin_calculator.py --quick` |\n| 2, \"完整\", \"full\", \"分析\"   | 閱讀 `workflows/analyze.md` 並執行                 |\n| 3, \"數據\", \"data\", \"爬蟲\"   | 閱讀 `workflows/data-research.md`                  |\n| 4, \"訊號\", \"signal\", \"交易\" | 閱讀 `workflows/signal-generation.md` 並執行       |\n| 5, \"學習\", \"方法論\", \"why\"  | 閱讀 `references/methodology.md`                   |\n| 提供參數 (如礦業清單)       | 閱讀 `workflows/analyze.md` 並使用參數執行         |\n\n**路由後，閱讀對應文件並執行。**\n</routing>\n\n<directory_structure>\n```\ncompute-precious-miner-gross-margin/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元數據\n├── workflows/\n│   ├── analyze.md                     # 完整情境分析工作流\n│   ├── data-research.md               # 數據源研究與爬蟲設計\n│   └── signal-generation.md           # 訊號生成工作流\n├── references/\n│   ├── data-sources.md                # 數據來源與獲取方式\n│   ├── methodology.md                 # 方法論與計算邏輯\n│   └── input-schema.md                # 完整輸入參數定義\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n├── scripts/\n│   └── margin_calculator.py           # 主計算腳本\n└── examples/\n    └── sample-output.json             # 範例輸出\n```\n</directory_structure>\n\n<reference_index>\n\n**方法論**: references/methodology.md\n- 毛利率代理值定義\n- 成本口徑層次解析\n- 聚合方法與直覺\n- 歷史分位數計算\n\n**資料來源**: references/data-sources.md\n- 金銀價格數據來源\n- AISC / 現金成本數據來源\n- 產量數據來源\n- 爬蟲設計指引\n\n**輸入參數**: references/input-schema.md\n- 完整參數定義\n- 預設值與建議範圍\n- 預設礦業籃子\n\n</reference_index>\n\n<workflows_index>\n| Workflow             | Purpose      | 使用時機                  |\n|----------------------|--------------|---------------------------|\n| analyze.md           | 完整情境分析 | 需要自訂參數計算毛利率    |\n| data-research.md     | 數據源研究   | 了解如何獲取成本數據      |\n| signal-generation.md | 訊號生成     | 將毛利率轉為交易/研究訊號 |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構定義 |\n| output-markdown.md | Markdown 報告模板 |\n</templates_index>\n\n<scripts_index>\n| Script               | Command                      | Purpose          |\n|----------------------|------------------------------|------------------|\n| margin_calculator.py | `--quick --metal gold`       | 快速計算黃金礦業 |\n| margin_calculator.py | `--quick --metal silver`     | 快速計算白銀礦業 |\n| margin_calculator.py | `--miners NEM,GOLD --freq Q` | 自訂礦業與頻率   |\n| margin_calculator.py | `--decompose`                | 驅動拆解分析     |\n</scripts_index>\n\n<input_schema_summary>\n\n**核心參數**\n\n| 參數        | 類型   | 預設值              | 說明                                   |\n|-------------|--------|---------------------|----------------------------------------|\n| metal       | string | gold                | 目標金屬（gold/silver）                |\n| miners      | array  | 預設籃子            | 礦業代號清單                           |\n| start_date  | string | 10 年前             | 計算起始日（YYYY-MM-DD）               |\n| end_date    | string | today               | 計算結束日                             |\n| frequency   | string | quarterly           | 頻率（daily/weekly/monthly/quarterly） |\n| cost_metric | string | AISC                | 成本口徑                               |\n| aggregation | string | production_weighted | 聚合方式                               |\n\n**進階參數**\n\n| 參數                 | 類型   | 預設值         | 說明           |\n|----------------------|--------|----------------|----------------|\n| price_series         | string | spot           | 價格口徑       |\n| fx_mode              | string | none           | 匯率處理       |\n| outlier_rule         | string | winsorize_1_99 | 離群處理       |\n| history_window_years | int    | 20             | 歷史分位數視窗 |\n\n完整參數定義見 `references/input-schema.md`。\n\n</input_schema_summary>\n\n<output_schema_summary>\n```json\n{\n  \"skill\": \"compute_precious_miner_margin_proxy\",\n  \"metal\": \"silver\",\n  \"frequency\": \"quarterly\",\n  \"cost_metric\": \"AISC\",\n  \"basket\": {\n    \"miners\": [\"CDE\", \"HL\", \"AG\"],\n    \"aggregation\": \"production_weighted\"\n  },\n  \"latest\": {\n    \"date\": \"2025-Q4\",\n    \"metal_price_usd_oz\": 31.50,\n    \"unit_cost_proxy_usd_oz\": 6.30,\n    \"gross_margin_proxy\": 0.80,\n    \"history_percentile\": 0.94,\n    \"regime_label\": \"extreme_high_margin\"\n  },\n  \"decomposition\": {\n    \"last_3m_price_change_pct\": 0.12,\n    \"last_3m_cost_change_pct\": -0.03,\n    \"driver\": \"mostly_price_up\"\n  },\n  \"notes\": [\n    \"gross_margin_proxy 使用 (price - AISC)/price 作為近似；不等同會計報表的毛利率口徑。\",\n    \"若成本為季度資料，已以季度內 forward-fill/同季均價對齊。\"\n  ],\n  \"recommended_next_checks\": [\n    \"用同一套 margin proxy 對照 SIL/SILJ 或個股的 3/6/12 個月前瞻報酬（事件研究）\",\n    \"檢查是否出現資本開支/併購升溫、或成本再通膨（柴油/工資/試劑）導致毛利回落\"\n  ]\n}\n```\n\n完整輸出結構見 `templates/output-json.md`。\n</output_schema_summary>\n\n<success_criteria>\n執行成功時應產出：\n\n- [ ] 毛利率代理值時序數據\n- [ ] 各礦業的單位成本與毛利率\n- [ ] 籃子聚合毛利率\n- [ ] 歷史分位數與區間標記（extreme_high/high/neutral/low/extreme_low）\n- [ ] 驅動拆解（價格驅動 vs 成本驅動）\n- [ ] 結果輸出為指定格式（JSON 或 Markdown）\n- [ ] 後續研究建議\n</success_criteria>\n",
        "skills/compute-precious-miner-gross-margin/references/data-sources.md": "# 數據來源指南\n\n## 金屬價格數據\n\n### 黃金價格\n\n| 來源                | 類型       | URL / API                               | 頻率 | 備註             |\n|---------------------|------------|-----------------------------------------|------|------------------|\n| **LBMA Gold Price** | 現貨指標價 | https://www.lbma.org.uk/prices-and-data | 日   | 最權威的現貨基準 |\n| **COMEX GC**        | 期貨近月   | yfinance `GC=F`                         | 日   | 流動性最佳       |\n| **Yahoo Finance**   | 現貨       | yfinance `GC=F` 或 `GOLD`               | 日   | 免費、方便       |\n| **FRED**            | 歷史       | fred `GOLDAMGBD228NLBM`                 | 日   | 長期歷史         |\n\n**建議**：使用 **yfinance `GC=F`**（COMEX 近月期貨），因：\n- 免費且無需 API key\n- 覆蓋足夠歷史\n- 與礦業實際結算價接近\n\n**Python 範例**：\n```python\nimport yfinance as yf\n\ngold = yf.download(\"GC=F\", start=\"2010-01-01\")\ngold_price = gold['Close']\n```\n\n### 白銀價格\n\n| 來源                  | 類型       | URL / API                               | 頻率 | 備註     |\n|-----------------------|------------|-----------------------------------------|------|----------|\n| **LBMA Silver Price** | 現貨指標價 | https://www.lbma.org.uk/prices-and-data | 日   | 最權威   |\n| **COMEX SI**          | 期貨近月   | yfinance `SI=F`                         | 日   | 流動性佳 |\n\n**Python 範例**：\n```python\nsilver = yf.download(\"SI=F\", start=\"2010-01-01\")\nsilver_price = silver['Close']\n```\n\n---\n\n## 礦業成本數據\n\n### AISC 數據來源\n\n成本數據是本 skill 的**核心難點**，因無單一公開資料庫，需從多來源收集：\n\n#### 1. 公司投資人簡報 (Investor Presentation)\n\n**優點**：\n- 通常有 AISC 摘要表格\n- 格式較結構化\n- 每季更新\n\n**缺點**：\n- PDF 格式需解析\n- 各公司格式不一\n\n**範例來源**：\n| 公司               | IR 頁面                                                 |\n|--------------------|---------------------------------------------------------|\n| Newmont (NEM)      | https://www.newmont.com/investors/presentations/        |\n| Barrick (GOLD)     | https://www.barrick.com/investors/presentations/        |\n| Agnico Eagle (AEM) | https://www.agnicoeagle.com/investors/presentations/    |\n| Coeur (CDE)        | https://www.coeur.com/investors/presentations/          |\n| Hecla (HL)         | https://www.hecla.com/investors/investor-presentations/ |\n\n#### 2. 季報新聞稿 (Earnings Release)\n\n**優點**：\n- 純文字，易解析\n- 發布最快\n- 通常在開頭摘要\n\n**缺點**：\n- 格式不固定\n- 需正則表達式匹配\n\n**解析範例**：\n```python\nimport re\n\ndef extract_aisc(text):\n    patterns = [\n        r'AISC\\s*(?:of|was|:)?\\s*\\$?([\\d,]+(?:\\.\\d+)?)\\s*(?:per|/)\\s*(?:oz|ounce)',\n        r'all-in sustaining cost[s]?\\s*(?:of|was|:)?\\s*\\$?([\\d,]+(?:\\.\\d+)?)',\n    ]\n    for pattern in patterns:\n        match = re.search(pattern, text, re.IGNORECASE)\n        if match:\n            return float(match.group(1).replace(',', ''))\n    return None\n```\n\n#### 3. SEC 10-Q / 10-K (MD&A)\n\n**優點**：\n- 最完整\n- 標準化格式\n- 可透過 EDGAR API 取得\n\n**缺點**：\n- 發布較慢\n- 需解析複雜文件\n\n**EDGAR API 範例**：\n```python\nimport requests\n\ndef get_sec_filings(ticker, filing_type='10-Q'):\n    # 透過 SEC EDGAR API\n    url = f\"https://data.sec.gov/submissions/CIK{cik}.json\"\n    # ... 實作\n```\n\n#### 4. 第三方彙整\n\n| 來源               | URL                     | 說明           |\n|--------------------|-------------------------|----------------|\n| Mining.com         | https://www.mining.com/ | 偶有彙整報導   |\n| Kitco              | https://www.kitco.com/  | 有成本追蹤報導 |\n| World Gold Council | https://www.gold.org/   | 產業報告       |\n\n---\n\n## 產量數據\n\n產量數據用於 production_weighted 聚合：\n\n### 來源\n\n| 來源     | 說明                  |\n|----------|-----------------------|\n| 公司季報 | 與 AISC 同一來源      |\n| 年報摘要 | 全年產量指引          |\n| 產業報告 | WGC、Silver Institute |\n\n### 單位轉換\n\n```python\n# 噸 (tonnes) → 盎司 (troy oz)\noz = tonnes * 32150.7465\n\n# 千盎司 (koz) → 盎司\noz = koz * 1000\n\n# 銀等量 (AgEq oz) = 實際銀 + 副產品折算\n# 通常使用固定比率（如 80:1 金銀比）\n```\n\n---\n\n## 數據更新頻率\n\n| 數據類型 | 披露頻率 | 滯後     | 更新建議   |\n|----------|----------|----------|------------|\n| 金銀價格 | 日       | 即時     | 日更新     |\n| AISC     | 季度     | 1-2 個月 | 季報發布後 |\n| 產量     | 季度     | 1-2 個月 | 同 AISC    |\n| 年度指引 | 年初     | -        | 年初一次   |\n\n**建議更新排程**：\n- 價格：每日自動更新\n- 成本/產量：每季度手動更新（可搭配爬蟲）\n\n---\n\n## 預設礦業籃子\n\n### 黃金礦業\n\n| 代碼 | 公司              | 2024 產量估 | 說明       |\n|------|-------------------|-------------|------------|\n| NEM  | Newmont           | ~6M oz      | 全球最大   |\n| GOLD | Barrick Gold      | ~4M oz      | 全球第二   |\n| AEM  | Agnico Eagle      | ~3.5M oz    | 加拿大為主 |\n| KGC  | Kinross Gold      | ~2M oz      | 美洲/西非  |\n| AU   | AngloGold Ashanti | ~2.5M oz    | 非洲/美洲  |\n\n**串流公司（不含在成本分析）**：\n- FNV (Franco-Nevada)\n- WPM (Wheaton Precious Metals)\n\n### 白銀礦業\n\n| 代碼 | 公司                | 2024 產量估  | 說明           |\n|------|---------------------|--------------|----------------|\n| CDE  | Coeur Mining        | ~10M oz Ag   | 美國為主       |\n| HL   | Hecla Mining        | ~15M oz Ag   | 美國最大銀礦業 |\n| AG   | First Majestic      | ~20M oz AgEq | 墨西哥         |\n| PAAS | Pan American Silver | ~20M oz Ag   | 拉美           |\n| MAG  | MAG Silver          | ~5M oz Ag    | 墨西哥         |\n\n---\n\n## 估算方法（缺乏數據時）\n\n若無法取得某礦業的 AISC，可使用以下估算：\n\n### 方法 1：營業成本推算\n\n```python\n# 使用財報數據\nestimated_unit_cost = cost_of_revenue / gold_sold_oz\n```\n\n**注意**：此方法會混入副產品、會計差異，僅作參考。\n\n### 方法 2：同業參照\n\n```python\n# 使用同類型礦業的 AISC 平均值\npeer_aisc = similar_miners_aisc.mean()\n```\n\n### 方法 3：成本曲線參照\n\n參考 WGC 或產業報告的成本曲線：\n- 低成本生產商：$900-1,100/oz\n- 中等成本：$1,100-1,300/oz\n- 高成本生產商：$1,300-1,600/oz\n\n---\n\n## 爬蟲設計指引\n\n詳細爬蟲設計請參考：\n- `thoughts/shared/guide/design-human-like-crawler.md`\n- `workflows/data-research.md`\n\n### 關鍵要點\n\n1. **使用 Selenium**：公司 IR 網站多為動態載入\n2. **防偵測**：隨機 UA、延遲、禁用自動化標記\n3. **多層選擇器**：網站可能改版\n4. **驗證機制**：抓取後人工驗證\n\n---\n\n## 資料儲存格式\n\n建議使用 JSON 格式儲存：\n\n```json\n{\n  \"metadata\": {\n    \"updated_at\": \"2025-01-15T10:00:00Z\",\n    \"source_version\": \"v1.0\"\n  },\n  \"gold\": {\n    \"NEM\": {\n      \"2024-Q4\": {\n        \"aisc_usd_oz\": 1350,\n        \"cash_cost_usd_oz\": 980,\n        \"production_oz\": 1600000,\n        \"source\": \"Q4 2024 Earnings Release\",\n        \"source_url\": \"https://...\"\n      }\n    }\n  },\n  \"silver\": {\n    \"CDE\": {\n      ...\n    }\n  }\n}\n```\n",
        "skills/compute-precious-miner-gross-margin/references/input-schema.md": "# 輸入參數定義 (Input Schema)\n\n## 核心參數\n\n### metal (string) - **必填**\n\n目標金屬類型。\n\n| 值       | 說明         |\n|----------|--------------|\n| `gold`   | 黃金（預設） |\n| `silver` | 白銀         |\n\n**範例**：\n```bash\n--metal gold\n```\n\n---\n\n### miners (list[string]) - 選填\n\n礦業或礦業股代號清單。\n\n**預設值**：\n- 黃金：`[\"NEM\", \"GOLD\", \"AEM\", \"KGC\", \"AU\"]`\n- 白銀：`[\"CDE\", \"HL\", \"AG\", \"PAAS\", \"MAG\"]`\n\n**範例**：\n```bash\n--miners NEM,GOLD,AEM\n--miners \"CDE,HL,AG\"\n```\n\n**注意**：\n- 使用逗號分隔\n- 需確保有對應的成本數據\n\n---\n\n### start_date (string, YYYY-MM-DD) - **必填**\n\n計算起始日期。\n\n**範例**：\n```bash\n--start-date 2015-01-01\n```\n\n**建議**：\n- 黃金：2013 年後（AISC 標準化後）\n- 至少 10 年以計算有意義的歷史分位數\n\n---\n\n### end_date (string, YYYY-MM-DD) - 選填\n\n計算結束日期。\n\n**預設值**：今天\n\n**範例**：\n```bash\n--end-date 2025-12-31\n```\n\n---\n\n### frequency (string) - **必填**\n\n數據頻率。\n\n| 值          | 說明         | 建議場景                       |\n|-------------|--------------|--------------------------------|\n| `daily`     | 日頻         | 短期交易訊號（需內插成本）     |\n| `weekly`    | 週頻         | 短期分析（需內插成本）         |\n| `monthly`   | 月頻         | 一般分析                       |\n| `quarterly` | 季頻（預設） | **建議**（與成本披露頻率一致） |\n\n**範例**：\n```bash\n--frequency quarterly\n```\n\n---\n\n### cost_metric (string) - **必填**\n\n成本口徑。\n\n| 值             | 說明                           | 典型值 (Gold)   |\n|----------------|--------------------------------|-----------------|\n| `AISC`         | All-In Sustaining Cost（預設） | $1,100-1,500/oz |\n| `cash_cost_C1` | 現金成本                       | $800-1,200/oz   |\n| `all_in_cost`  | 全成本（含成長資本開支）       | $1,300-1,800/oz |\n\n**範例**：\n```bash\n--cost-metric AISC\n```\n\n**建議**：優先使用 `AISC`，因其可比性最佳。\n\n---\n\n### aggregation (string) - 選填\n\n籃子聚合方式。\n\n| 值                    | 說明             | 適用場景                   |\n|-----------------------|------------------|----------------------------|\n| `equal_weight`        | 等權重平均       | 關注「典型礦業」           |\n| `production_weighted` | 產量加權（預設） | **建議**，反映「產業毛利」 |\n| `marketcap_weighted`  | 市值加權         | 與 GDX 曝險結構接近        |\n\n**範例**：\n```bash\n--aggregation production_weighted\n```\n\n---\n\n## 進階參數\n\n### price_series (string) - 選填\n\n價格口徑。\n\n| 值                  | 說明                                |\n|---------------------|-------------------------------------|\n| `spot`              | 現貨價（預設，LBMA 或近月期貨代理） |\n| `front_futures`     | 期貨近月合約                        |\n| `realized_estimate` | 公司實際銷售價估算（需額外數據）    |\n\n**預設值**：`spot`\n\n---\n\n### fx_mode (string) - 選填\n\n匯率處理方式。\n\n| 值             | 說明                             |\n|----------------|----------------------------------|\n| `none`         | 不處理（預設，假設成本已為 USD） |\n| `local_to_usd` | 將本地幣別成本轉為 USD           |\n\n**預設值**：`none`\n\n**說明**：多數礦業以 USD 報告 AISC，通常不需匯率轉換。\n\n---\n\n### outlier_rule (string) - 選填\n\n離群值處理規則。\n\n| 值               | 說明                         |\n|------------------|------------------------------|\n| `winsorize_1_99` | 縮尾至 1-99 分位數（預設）   |\n| `winsorize_5_95` | 縮尾至 5-95 分位數（更激進） |\n| `median_filter`  | 中位數濾波                   |\n| `none`           | 不處理                       |\n\n**預設值**：`winsorize_1_99`\n\n---\n\n### history_window_years (int) - 選填\n\n歷史分位數計算視窗（年）。\n\n| 值 | 覆蓋週期          | 說明   |\n|----|-------------------|--------|\n| 10 | ~2 個週期         | 較敏感 |\n| 15 | ~3 個週期         | 平衡   |\n| 20 | ~4 個週期（預設） | 穩健   |\n\n**預設值**：`20`\n\n**範例**：\n```bash\n--history-window 15\n```\n\n---\n\n## 輸出參數\n\n### output (string) - 選填\n\n輸出檔案路徑。\n\n**範例**：\n```bash\n--output result.json\n--output report.md\n```\n\n**格式判斷**：\n- `.json` → JSON 格式\n- `.md` → Markdown 報告\n\n---\n\n### format (string) - 選填\n\n強制指定輸出格式。\n\n| 值         | 說明              |\n|------------|-------------------|\n| `json`     | JSON 格式（預設） |\n| `markdown` | Markdown 報告     |\n\n---\n\n## 訊號生成參數\n\n### generate_signals (bool) - 選填\n\n是否生成交易/研究訊號。\n\n**預設值**：`false`\n\n**範例**：\n```bash\n--generate-signals\n```\n\n---\n\n### event_study (bool) - 選填\n\n是否執行極端事件研究。\n\n**預設值**：`false`\n\n**範例**：\n```bash\n--event-study\n```\n\n---\n\n### signal_horizons (list[int]) - 選填\n\n事件研究的前瞻報酬天數。\n\n**預設值**：`[63, 126, 252]`（約 3/6/12 個月）\n\n---\n\n## 完整範例\n\n### 快速計算\n\n```bash\npython scripts/margin_calculator.py --quick --metal gold\n```\n\n### 完整分析\n\n```bash\npython scripts/margin_calculator.py \\\n  --metal silver \\\n  --miners CDE,HL,AG \\\n  --start-date 2015-01-01 \\\n  --frequency quarterly \\\n  --cost-metric AISC \\\n  --aggregation production_weighted \\\n  --history-window 15 \\\n  --output result.json\n```\n\n### 訊號生成\n\n```bash\npython scripts/margin_calculator.py \\\n  --metal gold \\\n  --generate-signals \\\n  --event-study \\\n  --signal-horizons 63,126,252 \\\n  --output signals.json\n```\n\n---\n\n## 參數摘要表\n\n| 參數                   | 類型   | 必填 | 預設值              | 說明     |\n|------------------------|--------|------|---------------------|----------|\n| `metal`                | string | ✅    | gold                | 目標金屬 |\n| `miners`               | list   | ❌    | 預設籃子            | 礦業清單 |\n| `start_date`           | string | ✅    | -                   | 起始日   |\n| `end_date`             | string | ❌    | today               | 結束日   |\n| `frequency`            | string | ✅    | quarterly           | 頻率     |\n| `cost_metric`          | string | ✅    | AISC                | 成本口徑 |\n| `aggregation`          | string | ❌    | production_weighted | 聚合方式 |\n| `price_series`         | string | ❌    | spot                | 價格口徑 |\n| `fx_mode`              | string | ❌    | none                | 匯率處理 |\n| `outlier_rule`         | string | ❌    | winsorize_1_99      | 離群處理 |\n| `history_window_years` | int    | ❌    | 20                  | 歷史視窗 |\n| `output`               | string | ❌    | stdout              | 輸出路徑 |\n| `format`               | string | ❌    | json                | 輸出格式 |\n| `generate_signals`     | bool   | ❌    | false               | 生成訊號 |\n| `event_study`          | bool   | ❌    | false               | 事件研究 |\n",
        "skills/compute-precious-miner-gross-margin/references/methodology.md": "# 方法論：貴金屬礦業毛利率代理值\n\n## 核心概念\n\n### 毛利率代理值 (Gross Margin Proxy)\n\n本 skill 使用的「毛利率代理值」是一個簡化公式，用於快速估算礦業的邊際盈利能力：\n\n```\ngross_margin_proxy = (metal_price - unit_cost) / metal_price\n```\n\n**重要說明**：\n- 此指標**不等同會計報表的毛利率 (GAAP Gross Margin)**\n- 會計毛利率需考慮副產品收入、非現金項目、會計準則差異\n- 本代理值的優點是**可快速計算、跨公司可比、便於時序分析**\n\n### 與會計毛利率的差異\n\n| 項目       | Margin Proxy           | GAAP Gross Margin          |\n|------------|------------------------|----------------------------|\n| 計算方式   | (Price - AISC) / Price | (Revenue - COGS) / Revenue |\n| 副產品處理 | AISC 已扣除副產品收入  | 需單獨調整                 |\n| 非現金項目 | 不含                   | 含折舊/攤銷                |\n| 可比性     | 高（標準化公式）       | 低（會計政策差異）         |\n| 即時性     | 可用即時金價估算       | 需等財報披露               |\n\n---\n\n## 成本指標口徑\n\n### Cost Metric 層次\n\n```\n┌─────────────────────────────────────────────────────────┐\n│                    All-In Cost (AIC)                    │\n│  ┌───────────────────────────────────────────────────┐  │\n│  │               AISC (All-In Sustaining Cost)       │  │\n│  │  ┌─────────────────────────────────────────────┐  │  │\n│  │  │              Cash Cost (C1)                 │  │  │\n│  │  │  - 採掘成本                                 │  │  │\n│  │  │  - 加工成本                                 │  │  │\n│  │  │  - 場內一般行政                             │  │  │\n│  │  └─────────────────────────────────────────────┘  │  │\n│  │  + 維持資本開支 (Sustaining CapEx)               │  │\n│  │  + 勘探費用                                       │  │\n│  │  + 一般行政費用                                   │  │\n│  └───────────────────────────────────────────────────┘  │\n│  + 成長資本開支 (Growth CapEx)                          │\n│  + 併購相關費用                                          │\n└─────────────────────────────────────────────────────────┘\n```\n\n### 各口徑比較\n\n| 口徑           | 定義            | 典型值 (Gold)   | 適用場景                 |\n|----------------|-----------------|-----------------|--------------------------|\n| Cash Cost (C1) | 直接現場成本    | $800-1,200/oz   | 現金流壓力測試           |\n| AISC           | C1 + 維持開支   | $1,100-1,500/oz | **行業標準**（WGC 定義） |\n| All-In Cost    | AISC + 成長開支 | $1,300-1,800/oz | 完整經濟成本             |\n\n**建議**：優先使用 **AISC**，因其：\n- 由 World Gold Council 標準化定義（2013 年起）\n- 跨公司可比性最佳\n- 多數公司在季報中揭露\n\n---\n\n## 聚合方法\n\n### 籃子聚合邏輯\n\n當分析多家礦業時，需將個別毛利率聚合為「籃子毛利率」：\n\n**1. Equal Weight（等權重）**\n```python\nbasket_margin = Σ margin_i / N\n```\n- 每家公司貢獻相同\n- 適用於：關注「典型礦業」表現\n\n**2. Production Weighted（產量加權）**\n```python\nbasket_margin = Σ (margin_i × prod_i) / Σ prod_i\n```\n- 大型生產商貢獻較大\n- 適用於：反映「產業整體毛利」\n- **建議使用此方法**\n\n**3. Market Cap Weighted（市值加權）**\n```python\nbasket_margin = Σ (margin_i × mcap_i) / Σ mcap_i\n```\n- 與 GDX/GDXJ 等 ETF 曝險結構接近\n- 適用於：分析「股權曝險」毛利\n\n---\n\n## 歷史分位數計算\n\n### 方法\n\n使用滾動視窗計算當前毛利率在歷史分布中的位置：\n\n```python\ndef percentile_rank(series, window_years=20):\n    window = window_years * 4  # 季度\n    ranks = series.rolling(window, min_periods=4).apply(\n        lambda x: (x.iloc[-1] > x[:-1]).mean()\n    )\n    return ranks\n```\n\n### 區間標記\n\n| 分位數 | 標記                | 解讀                         |\n|--------|---------------------|------------------------------|\n| ≥ 90%  | extreme_high_margin | 毛利極端高，均值回歸風險     |\n| 70-90% | high_margin         | 毛利較高，礦業盈利良好       |\n| 30-70% | neutral             | 毛利中等                     |\n| 10-30% | low_margin          | 毛利較低，部分礦業壓力       |\n| < 10%  | extreme_low_margin  | 毛利極端低，可能觸及成本支撐 |\n\n### 視窗選擇考量\n\n| 視窗  | 覆蓋週期  | 優點   | 缺點             |\n|-------|-----------|--------|------------------|\n| 10 年 | ~2 個週期 | 較敏感 | 樣本較少         |\n| 15 年 | ~3 個週期 | 平衡   | -                |\n| 20 年 | ~4 個週期 | 穩健   | 可能錯過結構變化 |\n\n**建議**：使用 **15-20 年**，覆蓋 2-4 個完整商品週期。\n\n---\n\n## 驅動拆解\n\n### 毛利變化分解\n\n毛利率變化可歸因於價格或成本：\n\n```\nΔmargin ≈ f(Δprice, Δcost)\n```\n\n展開（一階近似）：\n```\nΔmargin ≈ (1/P) × ΔP - (1/P) × ΔC + O(...)\n         = (ΔP - ΔC) / P\n```\n\n### 驅動判斷規則\n\n```python\nif abs(price_change) > abs(cost_change) * 2:\n    driver = \"PRICE_DRIVEN\"\nelif abs(cost_change) > abs(price_change) * 2:\n    driver = \"COST_DRIVEN\"\nelse:\n    driver = \"MIXED\"\n```\n\n### 驅動類型與含義\n\n| 驅動類型       | 毛利變化 | 解讀                                  |\n|----------------|----------|---------------------------------------|\n| PRICE_RALLY    | ↑        | 金價上漲帶動，可持續性取決於金價      |\n| COST_DECLINE   | ↑        | 成本下降帶動，可能是暫時（油價/匯率） |\n| COST_INFLATION | ↓        | 成本通膨壓力，需關注趨勢              |\n| PRICE_DROP     | ↓        | 金價下跌帶動，需關注支撐位            |\n| MIXED          | -        | 價格與成本同向或幅度相近              |\n\n---\n\n## 數據對齊\n\n### 頻率處理\n\n金屬價格為日頻，成本數據為季頻，需要對齊：\n\n**方法 1：Forward Fill（建議）**\n```python\ncost_quarterly.reindex(daily_index, method=\"ffill\")\n```\n- 季度成本值延續到下一季報發布\n- 優點：簡單、避免前視偏誤\n\n**方法 2：同季均價**\n```python\nprice_quarterly = price_daily.resample('Q').mean()\n```\n- 將價格也降到季頻\n- 優點：數據乾淨、避免假精度\n\n**建議**：使用**季度頻率**作為基準，以 Method 2 對齊。\n\n### 缺值處理\n\n| 情況               | 處理方式                        |\n|--------------------|---------------------------------|\n| 某季成本缺失       | 前一季 forward-fill，或該季降權 |\n| 連續多季缺失       | 從籃子中剔除該公司              |\n| 成本異常（如重組） | Winsorize 或標記排除            |\n\n---\n\n## 離群處理\n\n### Winsorize 方法\n\n將極端值縮至指定分位數：\n\n```python\ndef winsorize(series, lower=0.01, upper=0.99):\n    low = series.quantile(lower)\n    high = series.quantile(upper)\n    return series.clip(low, high)\n```\n\n### 適用場景\n\n- **一次性減記**：成本異常飆高\n- **資產出售**：成本異常降低\n- **會計變更**：口徑不連續\n\n**建議**：使用 **winsorize_1_99**（1-99 分位數），保留 98% 數據。\n\n---\n\n## 模型限制\n\n1. **非會計毛利率**：不可直接與財報比較\n2. **成本滯後**：季報發布滯後 1-2 個月\n3. **口徑差異**：不同公司的 AISC 定義可能略有差異\n4. **副產品複雜**：白銀礦常有黃金/銅副產品，AISC 處理方式各異\n5. **串流公司除外**：FNV、WPM 等串流公司的成本結構不同，不適用本模型\n\n---\n\n## 參考文獻\n\n- World Gold Council (2013). \"Guidance Note on Non-GAAP Metrics – All-In Sustaining Costs and All-In Costs\"\n- VanEck (2024). \"The Case for Gold Mining Stocks\"\n- Kitco News. \"AISC Tracking Reports\"\n",
        "skills/compute-precious-miner-gross-margin/templates/output-json.md": "# JSON 輸出模板\n\n## 完整輸出結構\n\n```json\n{\n  \"skill\": \"compute_precious_miner_margin_proxy\",\n  \"generated_at\": \"2025-01-15T10:30:00Z\",\n  \"version\": \"0.1.0\",\n\n  \"parameters\": {\n    \"metal\": \"gold\",\n    \"miners\": [\"NEM\", \"GOLD\", \"AEM\"],\n    \"start_date\": \"2015-01-01\",\n    \"end_date\": \"2025-01-15\",\n    \"frequency\": \"quarterly\",\n    \"cost_metric\": \"AISC\",\n    \"aggregation\": \"production_weighted\",\n    \"price_series\": \"spot\",\n    \"history_window_years\": 20\n  },\n\n  \"data_sources\": {\n    \"metal_price\": {\n      \"source\": \"Yahoo Finance (GC=F)\",\n      \"last_update\": \"2025-01-15\"\n    },\n    \"miner_costs\": {\n      \"source\": \"Company IR / Earnings Releases\",\n      \"last_update\": \"2025-01-10\",\n      \"coverage\": {\n        \"NEM\": \"2015-Q1 to 2024-Q4\",\n        \"GOLD\": \"2015-Q1 to 2024-Q4\",\n        \"AEM\": \"2015-Q1 to 2024-Q4\"\n      }\n    }\n  },\n\n  \"basket\": {\n    \"miners\": [\"NEM\", \"GOLD\", \"AEM\"],\n    \"aggregation\": \"production_weighted\",\n    \"weights\": {\n      \"NEM\": 0.45,\n      \"GOLD\": 0.35,\n      \"AEM\": 0.20\n    }\n  },\n\n  \"latest\": {\n    \"date\": \"2024-Q4\",\n    \"metal_price_usd_oz\": 2650.0,\n    \"unit_cost_proxy_usd_oz\": 1320.0,\n    \"gross_margin_proxy\": 0.502,\n    \"history_percentile\": 0.78,\n    \"regime_label\": \"high_margin\"\n  },\n\n  \"miner_details\": [\n    {\n      \"ticker\": \"NEM\",\n      \"name\": \"Newmont\",\n      \"latest_quarter\": \"2024-Q4\",\n      \"aisc_usd_oz\": 1350.0,\n      \"production_oz\": 1600000,\n      \"margin_proxy\": 0.491,\n      \"margin_vs_basket\": -0.011\n    },\n    {\n      \"ticker\": \"GOLD\",\n      \"name\": \"Barrick Gold\",\n      \"latest_quarter\": \"2024-Q4\",\n      \"aisc_usd_oz\": 1290.0,\n      \"production_oz\": 1200000,\n      \"margin_proxy\": 0.513,\n      \"margin_vs_basket\": 0.011\n    },\n    {\n      \"ticker\": \"AEM\",\n      \"name\": \"Agnico Eagle\",\n      \"latest_quarter\": \"2024-Q4\",\n      \"aisc_usd_oz\": 1310.0,\n      \"production_oz\": 900000,\n      \"margin_proxy\": 0.506,\n      \"margin_vs_basket\": 0.004\n    }\n  ],\n\n  \"history\": {\n    \"summary\": {\n      \"min_margin\": 0.15,\n      \"max_margin\": 0.65,\n      \"mean_margin\": 0.38,\n      \"median_margin\": 0.40,\n      \"std_margin\": 0.12,\n      \"current_zscore\": 1.02\n    },\n    \"time_series\": [\n      {\"date\": \"2015-Q1\", \"margin\": 0.22, \"percentile\": 0.15},\n      {\"date\": \"2015-Q2\", \"margin\": 0.25, \"percentile\": 0.20}\n    ]\n  },\n\n  \"decomposition\": {\n    \"lookback_quarters\": 3,\n    \"price_change_pct\": 0.12,\n    \"cost_change_pct\": -0.03,\n    \"margin_change_pct\": 0.08,\n    \"driver\": \"mostly_price_up\",\n    \"interpretation\": \"毛利改善主要由金價上漲驅動（+12%），成本小幅下降（-3%）\"\n  },\n\n  \"regime_analysis\": {\n    \"current_regime\": \"high_margin\",\n    \"percentile_rank\": 0.78,\n    \"time_in_current_regime\": \"3 quarters\",\n    \"regime_transitions\": [\n      {\"date\": \"2024-Q2\", \"from\": \"neutral\", \"to\": \"high_margin\"}\n    ],\n    \"historical_avg_duration\": {\n      \"extreme_high_margin\": \"2.5 quarters\",\n      \"high_margin\": \"4 quarters\",\n      \"neutral\": \"6 quarters\",\n      \"low_margin\": \"3 quarters\",\n      \"extreme_low_margin\": \"2 quarters\"\n    }\n  },\n\n  \"signals\": {\n    \"regime_signal\": {\n      \"signal\": \"HIGH_MARGIN\",\n      \"strength\": 0.56,\n      \"interpretation\": \"毛利處於歷史高檔（78 百分位），但未達極端\"\n    },\n    \"driver_signal\": {\n      \"signal\": \"PRICE_DRIVEN_RALLY\",\n      \"quality\": \"MEDIUM\",\n      \"interpretation\": \"毛利改善依賴金價，需關注價格回調風險\"\n    },\n    \"capital_cycle_signal\": {\n      \"phase\": \"MID_EXPANSION\",\n      \"interpretation\": \"毛利較高，資本開支可能升溫\"\n    }\n  },\n\n  \"notes\": [\n    \"gross_margin_proxy 使用 (price - AISC)/price 作為近似；不等同會計報表的毛利率口徑。\",\n    \"成本為季度資料，已以同季均價對齊。\",\n    \"歷史分位數基於 20 年滾動視窗計算。\"\n  ],\n\n  \"recommended_next_checks\": [\n    \"用同一套 margin proxy 對照 GDX/GDXJ 的 3/6/12 個月前瞻報酬（事件研究）\",\n    \"檢查是否出現資本開支/併購升溫\",\n    \"監控成本通膨壓力（柴油/工資/試劑）\",\n    \"比較個別礦業的相對毛利強弱\"\n  ],\n\n  \"disclaimers\": [\n    \"本分析僅供研究參考，不構成投資建議。\",\n    \"毛利率代理值為估算值，與會計報表數字可能存在差異。\",\n    \"成本數據基於公開資料，可能存在滯後或不完整。\"\n  ]\n}\n```\n\n## 欄位說明\n\n### 頂層欄位\n\n| 欄位                      | 類型   | 說明                     |\n|---------------------------|--------|--------------------------|\n| `skill`                   | string | 技能識別符               |\n| `generated_at`            | string | 報告生成時間（ISO 8601） |\n| `version`                 | string | 技能版本號               |\n| `parameters`              | object | 輸入參數                 |\n| `data_sources`            | object | 數據來源資訊             |\n| `basket`                  | object | 籃子定義                 |\n| `latest`                  | object | 最新數據摘要             |\n| `miner_details`           | array  | 各礦業詳情               |\n| `history`                 | object | 歷史統計                 |\n| `decomposition`           | object | 驅動拆解                 |\n| `regime_analysis`         | object | 區間分析                 |\n| `signals`                 | object | 生成的訊號               |\n| `notes`                   | array  | 備註說明                 |\n| `recommended_next_checks` | array  | 後續建議                 |\n| `disclaimers`             | array  | 免責聲明                 |\n\n### latest 欄位\n\n| 欄位                     | 類型   | 說明                     |\n|--------------------------|--------|--------------------------|\n| `date`                   | string | 最新數據日期（季度格式） |\n| `metal_price_usd_oz`     | number | 金屬價格（USD/oz）       |\n| `unit_cost_proxy_usd_oz` | number | 加權平均成本（USD/oz）   |\n| `gross_margin_proxy`     | number | 毛利率代理值（0-1）      |\n| `history_percentile`     | number | 歷史分位數（0-1）        |\n| `regime_label`           | string | 區間標記                 |\n\n### regime_label 可能值\n\n| 值                    | 分位數範圍 | 說明       |\n|-----------------------|------------|------------|\n| `extreme_high_margin` | ≥ 0.9      | 極端高毛利 |\n| `high_margin`         | 0.7 - 0.9  | 高毛利     |\n| `neutral`             | 0.3 - 0.7  | 中等       |\n| `low_margin`          | 0.1 - 0.3  | 低毛利     |\n| `extreme_low_margin`  | < 0.1      | 極端低毛利 |\n\n### decomposition.driver 可能值\n\n| 值                  | 說明               |\n|---------------------|--------------------|\n| `mostly_price_up`   | 主要由價格上漲驅動 |\n| `mostly_price_down` | 主要由價格下跌驅動 |\n| `mostly_cost_down`  | 主要由成本下降驅動 |\n| `mostly_cost_up`    | 主要由成本上升驅動 |\n| `mixed`             | 價格與成本同時變化 |\n\n---\n\n## 精簡輸出\n\n若只需核心數據，可使用 `--compact` 參數：\n\n```json\n{\n  \"skill\": \"compute_precious_miner_margin_proxy\",\n  \"metal\": \"gold\",\n  \"date\": \"2024-Q4\",\n  \"basket_margin\": 0.502,\n  \"percentile\": 0.78,\n  \"regime\": \"high_margin\",\n  \"driver\": \"mostly_price_up\"\n}\n```\n",
        "skills/compute-precious-miner-gross-margin/templates/output-markdown.md": "# Markdown 報告模板\n\n## 報告範例\n\n---\n\n# 貴金屬礦業毛利率分析報告\n\n**生成時間**：2025-01-15 10:30:00 UTC\n**技能版本**：0.1.0\n\n---\n\n## 摘要\n\n| 指標     | 值                             |\n|----------|--------------------------------|\n| 目標金屬 | 黃金 (Gold)                    |\n| 分析籃子 | NEM, GOLD, AEM                 |\n| 聚合方式 | 產量加權 (production_weighted) |\n| 成本口徑 | AISC                           |\n| 數據期間 | 2015-01-01 ~ 2025-01-15        |\n\n### 最新數據（2024-Q4）\n\n| 指標                   | 值                      |\n|------------------------|-------------------------|\n| 金價 (USD/oz)          | $2,650.00               |\n| 加權平均 AISC (USD/oz) | $1,320.00               |\n| **毛利率代理值**       | **50.2%**               |\n| 歷史分位數             | 78%                     |\n| 區間標記               | 🟡 高毛利 (high_margin) |\n\n---\n\n## 各礦業詳情\n\n| 礦業               | AISC ($/oz) | 產量 (oz) | 權重 | 毛利率 | vs 籃子 |\n|--------------------|-------------|-----------|------|--------|---------|\n| NEM (Newmont)      | $1,350      | 1,600,000 | 45%  | 49.1%  | -1.1%   |\n| GOLD (Barrick)     | $1,290      | 1,200,000 | 35%  | 51.3%  | +1.1%   |\n| AEM (Agnico Eagle) | $1,310      | 900,000   | 20%  | 50.6%  | +0.4%   |\n\n---\n\n## 歷史分析\n\n### 歷史統計\n\n| 統計量       | 值            |\n|--------------|---------------|\n| 最低毛利率   | 15% (2015-Q4) |\n| 最高毛利率   | 65% (2020-Q3) |\n| 平均毛利率   | 38%           |\n| 中位數毛利率 | 40%           |\n| 標準差       | 12%           |\n| 當前 Z-Score | +1.02         |\n\n### 歷史分位數走勢\n\n```\n2015 |████░░░░░░░░░░░░░░░░| 20%\n2016 |██████░░░░░░░░░░░░░░| 30%\n2017 |████████░░░░░░░░░░░░| 40%\n2018 |██████░░░░░░░░░░░░░░| 30%\n2019 |████████████░░░░░░░░| 55%\n2020 |████████████████████| 95%\n2021 |████████████████░░░░| 80%\n2022 |██████████░░░░░░░░░░| 50%\n2023 |████████████░░░░░░░░| 60%\n2024 |████████████████░░░░| 78%\n```\n\n---\n\n## 驅動拆解\n\n**過去 3 季變化分析**：\n\n| 因素     | 變化   |\n|----------|--------|\n| 金價     | +12% ⬆️ |\n| 加權成本 | -3% ⬇️  |\n| 毛利率   | +8% ⬆️  |\n\n**驅動判斷**：🔴 **價格驅動上漲 (mostly_price_up)**\n\n> 毛利改善主要由金價上漲驅動（+12%），成本小幅下降（-3%）。\n> 若金價回調，毛利率可能快速收縮。\n\n---\n\n## 區間分析\n\n### 當前狀態\n\n- **當前區間**：🟡 高毛利 (high_margin)\n- **分位數排名**：78%\n- **持續時間**：3 個季度\n- **進入時間**：2024-Q2\n\n### 區間定義\n\n| 區間          | 分位數 | 說明             |\n|---------------|--------|------------------|\n| 🔴 極端高毛利 | ≥ 90%  | 均值回歸風險高   |\n| 🟡 高毛利     | 70-90% | ← **當前**       |\n| ⚪ 中性        | 30-70% | 正常波動         |\n| 🔵 低毛利     | 10-30% | 部分礦業壓力     |\n| 🟣 極端低毛利 | < 10%  | 可能觸及成本支撐 |\n\n---\n\n## 訊號\n\n### 區間訊號\n\n| 訊號 | 值          | 解讀                         |\n|------|-------------|------------------------------|\n| 類型 | HIGH_MARGIN | 高毛利區間                   |\n| 強度 | 56%         | 中等（距極端高毛利還有距離） |\n\n### 驅動訊號\n\n| 訊號 | 值                 | 解讀               |\n|------|--------------------|--------------------|\n| 類型 | PRICE_DRIVEN_RALLY | 價格驅動的毛利改善 |\n| 品質 | MEDIUM             | 依賴金價維持       |\n\n### 資本週期訊號\n\n| 訊號 | 值               | 解讀               |\n|------|------------------|--------------------|\n| 階段 | MID_EXPANSION    | 中期擴張           |\n| 建議 | 關注資本開支公告 | 高毛利可能引發增產 |\n\n---\n\n## 後續建議\n\n1. **事件研究**：用同一套 margin proxy 對照 GDX/GDXJ 的 3/6/12 個月前瞻報酬\n2. **資本開支監控**：檢查是否出現資本開支/併購升溫\n3. **成本通膨**：監控成本通膨壓力（柴油/工資/試劑）\n4. **相對強弱**：比較個別礦業的相對毛利強弱\n\n---\n\n## 備註\n\n- `gross_margin_proxy` 使用 `(price - AISC) / price` 作為近似；**不等同會計報表的毛利率口徑**。\n- 成本為季度資料，已以同季均價對齊。\n- 歷史分位數基於 20 年滾動視窗計算。\n\n---\n\n## 免責聲明\n\n- 本分析僅供研究參考，不構成投資建議。\n- 毛利率代理值為估算值，與會計報表數字可能存在差異。\n- 成本數據基於公開資料，可能存在滯後或不完整。\n\n---\n\n*報告由 compute-precious-miner-gross-margin skill 生成*\n\n---\n\n## 模板變數\n\n使用此模板時，替換以下變數：\n\n| 變數                             | 說明         |\n|----------------------------------|--------------|\n| `{{generated_at}}`               | 生成時間     |\n| `{{metal}}`                      | 金屬類型     |\n| `{{miners}}`                     | 礦業清單     |\n| `{{latest.date}}`                | 最新數據日期 |\n| `{{latest.metal_price}}`         | 金屬價格     |\n| `{{latest.unit_cost}}`           | 加權成本     |\n| `{{latest.margin}}`              | 毛利率       |\n| `{{latest.percentile}}`          | 歷史分位數   |\n| `{{latest.regime}}`              | 區間標記     |\n| `{{decomposition.price_change}}` | 價格變化     |\n| `{{decomposition.cost_change}}`  | 成本變化     |\n| `{{decomposition.driver}}`       | 驅動因素     |\n",
        "skills/compute-precious-miner-gross-margin/workflows/analyze.md": "# Workflow: 完整情境分析\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/methodology.md - 計算方法論\n2. references/input-schema.md - 完整參數定義\n3. references/data-sources.md - 數據來源\n</required_reading>\n\n<process>\n\n## Step 1: 確認分析參數\n\n收集以下必要參數：\n\n| 參數        | 預設值              | 說明                    |\n|-------------|---------------------|-------------------------|\n| metal       | gold                | 目標金屬（gold/silver） |\n| miners      | 預設籃子            | 礦業代號清單            |\n| start_date  | 10 年前             | 計算起始日              |\n| end_date    | today               | 計算結束日              |\n| frequency   | quarterly           | 頻率                    |\n| cost_metric | AISC                | 成本口徑                |\n| aggregation | production_weighted | 聚合方式                |\n\n若用戶未提供，使用預設值。\n\n**預設籃子**：\n- 黃金：NEM, GOLD, AEM, FNV, WPM\n- 白銀：CDE, HL, AG, PAAS, MAG\n\n## Step 2: 取得金屬價格序列\n\n執行腳本取得價格數據：\n\n```bash\npython scripts/margin_calculator.py \\\n  --step price \\\n  --metal {metal} \\\n  --start-date {start_date} \\\n  --end-date {end_date} \\\n  --frequency {frequency}\n```\n\n或使用 Python 直接執行：\n\n```python\nimport yfinance as yf\nimport pandas as pd\n\n# 期貨近月合約\nticker = \"GC=F\" if metal == \"gold\" else \"SI=F\"\ndf = yf.download(ticker, start=start_date, end=end_date)\n\n# 重採樣\nif frequency == \"quarterly\":\n    df_resampled = df['Close'].resample('Q').mean()\nelif frequency == \"monthly\":\n    df_resampled = df['Close'].resample('M').mean()\n```\n\n## Step 3: 取得礦業成本數據\n\n成本數據通常需從以下來源取得：\n\n1. **已建立的資料庫**：如有歷史資料庫，直接讀取\n2. **公司 IR 網站**：手動或爬蟲取得\n3. **使用估算值**：參考 references/data-sources.md 的估算方法\n\n**資料格式**：\n```python\ncost_data = {\n    \"NEM\": {\"2024-Q3\": 1380, \"2024-Q4\": 1350, ...},  # USD/oz\n    \"GOLD\": {\"2024-Q3\": 1290, \"2024-Q4\": 1310, ...},\n    ...\n}\nproduction_data = {\n    \"NEM\": {\"2024-Q3\": 1500000, \"2024-Q4\": 1600000, ...},  # oz\n    ...\n}\n```\n\n## Step 4: 計算毛利率代理值\n\n對齊數據並計算：\n\n```python\ndef margin_proxy(price, unit_cost):\n    \"\"\"計算毛利率代理值\"\"\"\n    return (price - unit_cost) / price\n\ndef align_cost_to_price_index(cost_quarterly, price_index):\n    \"\"\"將季度成本對齊到價格索引\"\"\"\n    return cost_quarterly.reindex(price_index, method=\"ffill\")\n\n# 計算每家公司的毛利率\nmargins = {}\nfor miner in miners:\n    aligned_cost = align_cost_to_price_index(cost_data[miner], price_index)\n    margins[miner] = margin_proxy(price_series, aligned_cost)\n```\n\n## Step 5: 聚合籃子毛利率\n\n根據聚合方式計算籃子毛利率：\n\n```python\ndef aggregate_margins(margins_df, weights_df=None, mode=\"production_weighted\"):\n    if mode == \"equal_weight\" or weights_df is None:\n        return margins_df.mean(axis=1)\n\n    # 正規化權重\n    w = weights_df.div(weights_df.sum(axis=1), axis=0).fillna(0.0)\n    return (margins_df * w).sum(axis=1)\n\nbasket_margin = aggregate_margins(\n    pd.DataFrame(margins),\n    pd.DataFrame(production_data),\n    mode=aggregation\n)\n```\n\n## Step 6: 計算歷史分位數與區間標記\n\n```python\ndef compute_percentile_rank(series, window_years=20):\n    \"\"\"計算滾動歷史分位數\"\"\"\n    window = window_years * 4  # 季度\n    ranks = series.rolling(window, min_periods=4).apply(\n        lambda x: (x.iloc[-1] > x[:-1]).mean()\n    )\n    return ranks\n\ndef regime_label(percentile):\n    \"\"\"區間標記\"\"\"\n    if percentile >= 0.9:\n        return \"extreme_high_margin\"\n    elif percentile >= 0.7:\n        return \"high_margin\"\n    elif percentile >= 0.3:\n        return \"neutral\"\n    elif percentile >= 0.1:\n        return \"low_margin\"\n    else:\n        return \"extreme_low_margin\"\n```\n\n## Step 7: 驅動拆解\n\n```python\ndef decompose_driver(price_series, cost_series, lookback=3):\n    \"\"\"拆解毛利率變化的驅動因素\"\"\"\n    price_change = (price_series.iloc[-1] / price_series.iloc[-lookback-1]) - 1\n    cost_change = (cost_series.iloc[-1] / cost_series.iloc[-lookback-1]) - 1\n\n    if abs(price_change) > abs(cost_change) * 2:\n        driver = \"mostly_price\" + (\"_up\" if price_change > 0 else \"_down\")\n    elif abs(cost_change) > abs(price_change) * 2:\n        driver = \"mostly_cost\" + (\"_down\" if cost_change < 0 else \"_up\")\n    else:\n        driver = \"mixed\"\n\n    return {\n        \"price_change_pct\": price_change,\n        \"cost_change_pct\": cost_change,\n        \"driver\": driver\n    }\n```\n\n## Step 8: 輸出結果\n\n使用 `templates/output-json.md` 格式輸出：\n\n```bash\npython scripts/margin_calculator.py \\\n  --metal {metal} \\\n  --miners {miners} \\\n  --start-date {start_date} \\\n  --frequency {frequency} \\\n  --cost-metric {cost_metric} \\\n  --aggregation {aggregation} \\\n  --output result.json\n```\n\n## Step 9: 生成報告\n\n若需要 Markdown 報告：\n\n```bash\npython scripts/margin_calculator.py \\\n  --output result.md \\\n  --format markdown\n```\n\n</process>\n\n<success_criteria>\n完成分析時應產出：\n\n- [ ] 金屬價格時序數據（已重採樣）\n- [ ] 各礦業成本數據（AISC/現金成本）\n- [ ] 各礦業毛利率代理值\n- [ ] 產量/市值加權的籃子毛利率\n- [ ] 歷史分位數排名\n- [ ] 區間標記（extreme_high/high/neutral/low/extreme_low）\n- [ ] 驅動拆解（價格 vs 成本）\n- [ ] JSON 或 Markdown 格式的輸出\n</success_criteria>\n",
        "skills/compute-precious-miner-gross-margin/workflows/data-research.md": "# Workflow: 數據源研究與爬蟲設計\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/data-sources.md - 數據來源詳情\n2. thoughts/shared/guide/design-human-like-crawler.md - 爬蟲設計指南\n</required_reading>\n\n<process>\n\n## Step 1: 識別目標礦業\n\n根據分析需求識別需要獲取數據的礦業：\n\n**黃金礦業**：\n| 代碼 | 公司名稱          | IR 網站                                     |\n|------|-------------------|---------------------------------------------|\n| NEM  | Newmont           | https://www.newmont.com/investors/          |\n| GOLD | Barrick Gold      | https://www.barrick.com/investors/          |\n| AEM  | Agnico Eagle      | https://www.agnicoeagle.com/investors/      |\n| KGC  | Kinross Gold      | https://www.kinross.com/investors/          |\n| AU   | AngloGold Ashanti | https://www.anglogoldashanti.com/investors/ |\n\n**白銀礦業**：\n| 代碼 | 公司名稱            | IR 網站                                      |\n|------|---------------------|----------------------------------------------|\n| CDE  | Coeur Mining        | https://www.coeur.com/investors/             |\n| HL   | Hecla Mining        | https://www.hecla.com/investors/             |\n| AG   | First Majestic      | https://www.firstmajestic.com/investors/     |\n| PAAS | Pan American Silver | https://www.panamericansilver.com/investors/ |\n| MAG  | MAG Silver          | https://www.magsilver.com/investors/         |\n\n## Step 2: 了解數據披露模式\n\n**AISC 披露特點**：\n- **頻率**：季度（部分公司半年）\n- **位置**：\n  - 季報新聞稿（最快取得）\n  - 投資人簡報 PDF（有表格）\n  - 10-Q / 10-K MD&A（最完整）\n- **單位**：USD/oz（黃金）、USD/oz AgEq（白銀）\n- **滯後**：財報發布約在季末後 1-2 個月\n\n**典型披露格式**：\n```\nProduction: 1,500,000 oz Au\nAISC: $1,320/oz\nCash Cost: $980/oz\n```\n\n## Step 3: 選擇數據獲取策略\n\n根據需求選擇策略：\n\n| 策略         | 優點             | 缺點       | 適用場景             |\n|--------------|------------------|------------|----------------------|\n| 手動收集     | 準確、無技術門檻 | 耗時       | 少量公司、一次性分析 |\n| 新聞稿爬蟲   | 結構化好         | 需維護     | 定期更新             |\n| PDF 表格抽取 | 資料完整         | 技術難度高 | 歷史回填             |\n| 第三方服務   | 省時             | 可能付費   | 生產環境             |\n\n**建議**：新聞稿爬蟲 + 手動驗證\n\n## Step 4: 爬蟲架構設計\n\n遵循 `design-human-like-crawler.md` 的指引：\n\n```python\nfrom selenium import webdriver\nfrom selenium.webdriver.chrome.options import Options\nfrom selenium.webdriver.common.by import By\nfrom selenium.webdriver.support.ui import WebDriverWait\nfrom selenium.webdriver.support import expected_conditions as EC\nfrom bs4 import BeautifulSoup\nimport random\nimport time\n\n# 防偵測配置\nchrome_options = Options()\nchrome_options.add_argument('--headless')\nchrome_options.add_argument('--disable-blink-features=AutomationControlled')\nchrome_options.add_experimental_option('excludeSwitches', ['enable-automation'])\n\nUSER_AGENTS = [\n    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) ...',\n    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) ...',\n]\n\nclass MinerAISCCrawler:\n    def __init__(self, miner_code: str):\n        self.miner_code = miner_code\n        self.ir_url = MINER_IR_URLS[miner_code]\n\n    async def fetch_quarterly_reports(self):\n        \"\"\"抓取季報連結\"\"\"\n        # 隨機延遲\n        await asyncio.sleep(random.uniform(1.0, 3.0))\n        # ... 實作\n\n    def parse_aisc_from_news(self, html: str) -> dict:\n        \"\"\"從新聞稿解析 AISC\"\"\"\n        soup = BeautifulSoup(html, 'lxml')\n        # 多層備用選擇器\n        selectors = [\n            r'AISC[:\\s]+\\$?([\\d,]+)',\n            r'All-in sustaining cost[s]?[:\\s]+\\$?([\\d,]+)',\n        ]\n        # ... 實作\n```\n\n## Step 5: 解析策略設計\n\n**新聞稿解析**：\n```python\nimport re\n\ndef extract_aisc_from_text(text: str) -> dict:\n    \"\"\"從文字中提取 AISC 數據\"\"\"\n    patterns = {\n        'aisc': [\n            r'AISC\\s*(?:of|was|:)?\\s*\\$?([\\d,]+(?:\\.\\d+)?)\\s*(?:per|/)\\s*(?:oz|ounce)',\n            r'all-in sustaining cost[s]?\\s*(?:of|was|:)?\\s*\\$?([\\d,]+(?:\\.\\d+)?)',\n        ],\n        'production': [\n            r'(?:gold )?production\\s*(?:of|was|:)?\\s*([\\d,]+(?:\\.\\d+)?)\\s*(?:thousand\\s)?(?:oz|ounces)',\n            r'produced\\s*([\\d,]+(?:\\.\\d+)?)\\s*(?:thousand\\s)?(?:oz|ounces)',\n        ],\n        'cash_cost': [\n            r'cash cost[s]?\\s*(?:of|was|:)?\\s*\\$?([\\d,]+(?:\\.\\d+)?)',\n        ]\n    }\n\n    result = {}\n    for key, pattern_list in patterns.items():\n        for pattern in pattern_list:\n            match = re.search(pattern, text, re.IGNORECASE)\n            if match:\n                result[key] = float(match.group(1).replace(',', ''))\n                break\n\n    return result\n```\n\n## Step 6: PDF 表格抽取（進階）\n\n若需要歷史數據回填，可使用 PDF 解析：\n\n```python\n# 選用：tabula-py 或 camelot\nimport tabula\n\ndef extract_tables_from_pdf(pdf_path: str):\n    \"\"\"從 PDF 抽取表格\"\"\"\n    tables = tabula.read_pdf(pdf_path, pages='all')\n\n    for table in tables:\n        # 尋找含 AISC 的表格\n        if 'AISC' in table.to_string():\n            return table\n\n    return None\n```\n\n**注意**：PDF 抽取不穩定，建議：\n- 優先使用新聞稿\n- PDF 僅作備用\n- 抽取後人工驗證\n\n## Step 7: 數據儲存格式\n\n設計標準化的儲存格式：\n\n```python\n# data/miner_costs.json\n{\n    \"NEM\": {\n        \"2024-Q4\": {\n            \"aisc_usd_oz\": 1350,\n            \"cash_cost_usd_oz\": 980,\n            \"production_oz\": 1600000,\n            \"source\": \"Q4 2024 Earnings Release\",\n            \"source_url\": \"https://...\",\n            \"scraped_at\": \"2025-01-15T10:30:00Z\"\n        },\n        \"2024-Q3\": {\n            ...\n        }\n    },\n    \"GOLD\": {\n        ...\n    }\n}\n```\n\n## Step 8: 建立更新排程\n\n```python\nfrom apscheduler.schedulers.asyncio import AsyncIOScheduler\nfrom apscheduler.triggers.cron import CronTrigger\n\nscheduler = AsyncIOScheduler()\n\n# 每月 15 日檢查（多數公司在季末後 45 天內發布）\nscheduler.add_job(\n    update_quarterly_costs,\n    CronTrigger(day=15, hour=6),\n    id='quarterly_cost_update'\n)\n```\n\n## Step 9: 驗證與品質控制\n\n```python\ndef validate_cost_data(data: dict) -> list:\n    \"\"\"驗證成本數據品質\"\"\"\n    issues = []\n\n    for miner, quarters in data.items():\n        for q, values in quarters.items():\n            # 合理範圍檢查\n            aisc = values.get('aisc_usd_oz', 0)\n            if aisc < 500 or aisc > 2500:\n                issues.append(f\"{miner} {q}: AISC {aisc} 超出合理範圍\")\n\n            # 連續性檢查\n            # ... 實作\n\n    return issues\n```\n\n</process>\n\n<success_criteria>\n數據研究完成時應有：\n\n- [ ] 目標礦業清單與 IR 網站\n- [ ] 數據披露模式理解（頻率、位置、格式）\n- [ ] 爬蟲架構設計（遵循防偵測指引）\n- [ ] 解析規則（正則表達式或選擇器）\n- [ ] 標準化儲存格式定義\n- [ ] 更新排程規劃\n- [ ] 品質驗證規則\n</success_criteria>\n\n<output_artifacts>\n完成本 workflow 後產出：\n- `scripts/crawler/miner_cost_crawler.py` - 爬蟲核心\n- `data/miner_costs.json` - 成本數據\n- `data/crawl_log.json` - 爬取記錄\n</output_artifacts>\n",
        "skills/compute-precious-miner-gross-margin/workflows/signal-generation.md": "# Workflow: 訊號生成\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/methodology.md - 理解毛利率代理值的含義\n2. workflows/analyze.md - 確保已完成基礎計算\n</required_reading>\n\n<process>\n\n## Step 1: 確認訊號生成目標\n\n訊號可用於：\n\n| 目標       | 訊號類型     | 適用場景               |\n|------------|--------------|------------------------|\n| 礦業股擇時 | 極端區間標記 | 配置 GDX/GDXJ/SIL/SILJ |\n| 個股選擇   | 相對毛利排名 | 選股因子               |\n| 事件研究   | 極端事件日期 | 回測前瞻報酬           |\n| 風險預警   | 均值回歸訊號 | 風險管理               |\n\n## Step 2: 極端區間訊號\n\n生成基於歷史分位數的區間訊號：\n\n```python\ndef generate_regime_signal(margin_series, percentile_series):\n    \"\"\"生成區間訊號\"\"\"\n    signals = []\n\n    for date in margin_series.index:\n        pct = percentile_series.loc[date]\n        margin = margin_series.loc[date]\n\n        if pct >= 0.9:\n            signal = {\n                \"date\": date,\n                \"signal\": \"EXTREME_HIGH\",\n                \"strength\": (pct - 0.9) / 0.1,  # 0-1\n                \"margin\": margin,\n                \"percentile\": pct,\n                \"interpretation\": \"毛利極端高，均值回歸風險升高\",\n                \"suggested_action\": \"減持礦業股或觀望\"\n            }\n        elif pct <= 0.1:\n            signal = {\n                \"date\": date,\n                \"signal\": \"EXTREME_LOW\",\n                \"strength\": (0.1 - pct) / 0.1,\n                \"margin\": margin,\n                \"percentile\": pct,\n                \"interpretation\": \"毛利極端低，可能接近成本支撐\",\n                \"suggested_action\": \"關注金價反彈潛力\"\n            }\n        else:\n            signal = {\n                \"date\": date,\n                \"signal\": \"NEUTRAL\",\n                \"margin\": margin,\n                \"percentile\": pct\n            }\n\n        signals.append(signal)\n\n    return pd.DataFrame(signals)\n```\n\n## Step 3: 驅動拆解訊號\n\n區分價格驅動與成本驅動的毛利變化：\n\n```python\ndef generate_driver_signal(price_series, cost_series, margin_series, lookback=3):\n    \"\"\"生成驅動拆解訊號\"\"\"\n    signals = []\n\n    for i in range(lookback, len(margin_series)):\n        date = margin_series.index[i]\n\n        price_change = (price_series.iloc[i] / price_series.iloc[i-lookback]) - 1\n        cost_change = (cost_series.iloc[i] / cost_series.iloc[i-lookback]) - 1\n        margin_change = margin_series.iloc[i] - margin_series.iloc[i-lookback]\n\n        # 判斷主要驅動因素\n        if margin_change > 0.05:  # 毛利率提升超過 5 個百分點\n            if price_change > 0.1 and cost_change < 0.05:\n                driver = \"PRICE_RALLY\"\n                quality = \"HIGH\"  # 價格驅動的毛利較可持續\n            elif cost_change < -0.05:\n                driver = \"COST_DECLINE\"\n                quality = \"MEDIUM\"  # 成本下降可能是暫時的\n            else:\n                driver = \"MIXED_IMPROVEMENT\"\n                quality = \"MEDIUM\"\n        elif margin_change < -0.05:\n            if price_change < -0.1:\n                driver = \"PRICE_DROP\"\n                quality = \"LOW\"\n            elif cost_change > 0.1:\n                driver = \"COST_INFLATION\"\n                quality = \"LOW\"\n            else:\n                driver = \"MIXED_DETERIORATION\"\n                quality = \"LOW\"\n        else:\n            driver = \"STABLE\"\n            quality = \"NEUTRAL\"\n\n        signals.append({\n            \"date\": date,\n            \"margin_change\": margin_change,\n            \"price_change\": price_change,\n            \"cost_change\": cost_change,\n            \"driver\": driver,\n            \"quality\": quality\n        })\n\n    return pd.DataFrame(signals)\n```\n\n## Step 4: 事件研究訊號\n\n標記極端事件並計算前瞻報酬：\n\n```python\nimport yfinance as yf\n\ndef event_study(extreme_dates: list, etf_ticker: str = \"GDX\",\n                horizons: list = [63, 126, 252]):\n    \"\"\"極端毛利事件的前瞻報酬研究\"\"\"\n\n    # 取得 ETF 價格\n    etf = yf.download(etf_ticker, start=\"2010-01-01\")['Adj Close']\n\n    results = []\n    for event_date in extreme_dates:\n        if event_date not in etf.index:\n            continue\n\n        event_idx = etf.index.get_loc(event_date)\n        event_price = etf.iloc[event_idx]\n\n        forward_returns = {}\n        for h in horizons:\n            if event_idx + h < len(etf):\n                future_price = etf.iloc[event_idx + h]\n                forward_returns[f\"{h}d_return\"] = (future_price / event_price) - 1\n\n        results.append({\n            \"event_date\": event_date,\n            **forward_returns\n        })\n\n    df = pd.DataFrame(results)\n\n    # 彙總統計\n    summary = {\n        \"n_events\": len(df),\n        \"avg_returns\": {\n            col: df[col].mean() for col in df.columns if col != \"event_date\"\n        },\n        \"median_returns\": {\n            col: df[col].median() for col in df.columns if col != \"event_date\"\n        },\n        \"win_rate\": {\n            col: (df[col] > 0).mean() for col in df.columns if col != \"event_date\"\n        }\n    }\n\n    return df, summary\n```\n\n## Step 5: 相對強弱訊號\n\n比較不同礦業的毛利率表現：\n\n```python\ndef relative_margin_ranking(margins_df: pd.DataFrame):\n    \"\"\"生成相對毛利率排名訊號\"\"\"\n\n    # 最新排名\n    latest = margins_df.iloc[-1].sort_values(ascending=False)\n\n    # 過去 4 季變化\n    change_4q = margins_df.iloc[-1] - margins_df.iloc[-4]\n\n    rankings = []\n    for miner in latest.index:\n        rankings.append({\n            \"miner\": miner,\n            \"current_margin\": latest[miner],\n            \"rank\": list(latest.index).index(miner) + 1,\n            \"margin_change_4q\": change_4q[miner],\n            \"signal\": \"OUTPERFORM\" if change_4q[miner] > 0.05 else (\n                \"UNDERPERFORM\" if change_4q[miner] < -0.05 else \"NEUTRAL\"\n            )\n        })\n\n    return pd.DataFrame(rankings)\n```\n\n## Step 6: 資本週期訊號\n\n結合毛利率與資本開支趨勢：\n\n```python\ndef capital_cycle_signal(margin_series, capex_series=None):\n    \"\"\"\n    資本週期訊號\n\n    邏輯：\n    1. 高毛利 + 低資本開支 → 早期擴張（看多）\n    2. 高毛利 + 高資本開支 → 週期高峰（謹慎）\n    3. 低毛利 + 高資本開支 → 產能過剩（看空）\n    4. 低毛利 + 低資本開支 → 觸底（潛在機會）\n    \"\"\"\n\n    margin_pct = margin_series.rank(pct=True).iloc[-1]\n\n    # 若無資本開支數據，僅用毛利率判斷\n    if capex_series is None:\n        if margin_pct > 0.8:\n            return {\n                \"phase\": \"LATE_CYCLE_WARNING\",\n                \"description\": \"毛利極高，通常引發資本開支週期，注意均值回歸\"\n            }\n        elif margin_pct < 0.2:\n            return {\n                \"phase\": \"POTENTIAL_BOTTOM\",\n                \"description\": \"毛利極低，可能接近成本支撐，關注價格反彈\"\n            }\n        else:\n            return {\n                \"phase\": \"MID_CYCLE\",\n                \"description\": \"毛利中等，無明顯週期訊號\"\n            }\n\n    # 有資本開支數據時的完整判斷\n    capex_pct = capex_series.rank(pct=True).iloc[-1]\n\n    if margin_pct > 0.7 and capex_pct < 0.3:\n        return {\"phase\": \"EARLY_EXPANSION\", \"signal\": \"BULLISH\"}\n    elif margin_pct > 0.7 and capex_pct > 0.7:\n        return {\"phase\": \"CYCLE_PEAK\", \"signal\": \"CAUTIOUS\"}\n    elif margin_pct < 0.3 and capex_pct > 0.7:\n        return {\"phase\": \"OVERCAPACITY\", \"signal\": \"BEARISH\"}\n    elif margin_pct < 0.3 and capex_pct < 0.3:\n        return {\"phase\": \"CYCLE_TROUGH\", \"signal\": \"WATCH_FOR_TURN\"}\n    else:\n        return {\"phase\": \"MID_CYCLE\", \"signal\": \"NEUTRAL\"}\n```\n\n## Step 7: 輸出訊號報告\n\n```python\ndef generate_signal_report(metal: str, basket_margin: pd.Series,\n                           percentile_series: pd.Series,\n                           miner_margins: pd.DataFrame = None):\n    \"\"\"生成完整訊號報告\"\"\"\n\n    report = {\n        \"skill\": \"compute_precious_miner_margin_proxy\",\n        \"metal\": metal,\n        \"generated_at\": datetime.now().isoformat(),\n\n        \"regime_signal\": generate_regime_signal(\n            basket_margin, percentile_series\n        ).iloc[-1].to_dict(),\n\n        \"capital_cycle\": capital_cycle_signal(basket_margin),\n\n        \"recommended_actions\": []\n    }\n\n    # 根據訊號生成建議\n    regime = report[\"regime_signal\"][\"signal\"]\n    if regime == \"EXTREME_HIGH\":\n        report[\"recommended_actions\"].extend([\n            \"檢視 GDX/GDXJ 相對 GLD 的強弱\",\n            \"監控資本開支公告與併購活動\",\n            \"考慮減持或對沖礦業股曝險\"\n        ])\n    elif regime == \"EXTREME_LOW\":\n        report[\"recommended_actions\"].extend([\n            \"關注金價是否觸及成本支撐\",\n            \"監控邊際礦業減產公告\",\n            \"考慮逆勢佈局機會\"\n        ])\n\n    if miner_margins is not None:\n        report[\"relative_ranking\"] = relative_margin_ranking(miner_margins).to_dict('records')\n\n    return report\n```\n\n## Step 8: 整合執行\n\n完整訊號生成流程：\n\n```bash\npython scripts/margin_calculator.py \\\n  --metal gold \\\n  --generate-signals \\\n  --event-study \\\n  --output signals.json\n```\n\n</process>\n\n<success_criteria>\n訊號生成完成時應產出：\n\n- [ ] 極端區間訊號（EXTREME_HIGH / EXTREME_LOW）\n- [ ] 驅動拆解訊號（PRICE_RALLY / COST_DECLINE 等）\n- [ ] 事件研究結果（極端事件的前瞻報酬統計）\n- [ ] 相對強弱排名（若有多個礦業）\n- [ ] 資本週期訊號\n- [ ] 綜合建議行動\n- [ ] JSON 格式的訊號報告\n</success_criteria>\n\n<risk_notes>\n**訊號使用注意事項**：\n\n1. **滯後性**：成本數據滯後 1-2 個月，短期訊號可能失真\n2. **樣本偏誤**：極端事件樣本小，前瞻報酬統計可能不穩健\n3. **結構變化**：成本結構可能因技術/併購而改變，歷史分位數需定期校驗\n4. **非充分條件**：毛利率僅為諸多因子之一，需結合其他分析\n</risk_notes>\n",
        "skills/cost-density-net-rr-calculator/SKILL.md": "---\nname: cost-density-net-rr-calculator\ndescription: 計算交易成本對風險報酬比的非線性衰減影響。將固定佣金與點差整合為「成本密度」指標，揭示停損大小與策略效率的雙曲線關係，識別「獲利事件視界」閾值。\n---\n\n<essential_principles>\n**成本密度模型核心原則**\n\n**1. 核心公式**\n\n所有計算基於以下關係：\n\n```\nCost Density = (c/V + s)           # 成本密度（pips 等效）\nx = Cost Density / P               # 負載係數\nRR_net = (RR_g - x) / (1 + x)      # 淨風險報酬比\nWR_min = (1 + x) / (1 + RR_g)      # 最低勝率\nP_critical = CostDensity × (RR_g + 2) / RR_g  # 效率減半點\n```\n\n**2. 參數定義**\n\n| 參數 | 定義                      | 單位         |\n|------|---------------------------|--------------|\n| RR_g | 毛風險報酬比（目標/停損） | 無單位       |\n| P    | 停損大小                  | pips/points  |\n| c    | 來回佣金（每手）          | 帳戶貨幣     |\n| s    | 來回點差                  | pips/points  |\n| V    | 每 pip 價值（每手）       | 帳戶貨幣/pip |\n| R    | 固定風險（可選，會抵消）  | 帳戶貨幣     |\n\n**3. 關鍵洞察**\n\n- **雙曲線衰減**: P → 0 時，x → ∞，RR_net → -1\n- **R 無關性**: RR_net 不依賴固定風險 R\n- **剪刀效應**: 短時間框架同時增加成本負擔與降低訊號品質\n\n**4. 單位一致性規則**\n\n- P 和 s 必須使用相同基準（都是 pips 或都是 points）\n- c 必須是 round-turn（來回）佣金\n- V 必須是每 pip 每手的價值\n</essential_principles>\n\n<intake>\n**您想要執行什麼操作？**\n\n1. **Compute** - 計算單一參數組合的成本密度與效率指標\n2. **Sweep** - 掃描停損範圍，生成 RR_net/WR_min 曲線表\n3. **Analyze** - 解讀結果，提供策略建議\n\n**等待回應後再繼續。**\n</intake>\n\n<routing>\n| Response                             | Workflow             | Description          |\n|--------------------------------------|----------------------|----------------------|\n| 1, \"compute\", \"calculate\", \"single\"  | workflows/compute.md | 單次計算成本密度指標 |\n| 2, \"sweep\", \"grid\", \"curve\", \"range\" | workflows/sweep.md   | 網格掃描與閾值搜尋   |\n| 3, \"analyze\", \"interpret\", \"explain\" | workflows/analyze.md | 結果解讀與策略建議   |\n\n**讀取工作流程後，請完全遵循其步驟。**\n</routing>\n\n<reference_index>\n**參考文件** (`references/`)\n\n| 文件        | 內容                     |\n|-------------|--------------------------|\n| formulas.md | 完整公式推導與數學證明   |\n| theory.md   | 市場微結構理論背景與文獻 |\n</reference_index>\n\n<workflows_index>\n| Workflow   | Purpose                    |\n|------------|----------------------------|\n| compute.md | 單次計算成本密度與效率指標 |\n| sweep.md   | 網格掃描與閾值搜尋         |\n| analyze.md | 結果解讀與策略建議         |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose          |\n|--------------------|------------------|\n| output-schema.yaml | 輸出 JSON schema |\n| input-schema.yaml  | 輸入參數 schema  |\n</templates_index>\n\n<scripts_index>\n| Script          | Purpose             |\n|-----------------|---------------------|\n| cost_density.py | Python 計算實作     |\n| cost_density.ts | TypeScript 計算實作 |\n</scripts_index>\n\n<quick_start>\n**快速計算（XAU/USD 範例）：**\n\n輸入：\n```json\n{\n  \"RR_g\": 3.0,\n  \"c\": 7.0,\n  \"s\": 1.5,\n  \"V\": 10.0,\n  \"P\": 20\n}\n```\n\n計算：\n```python\ncost_density = 7.0/10.0 + 1.5  # = 2.2 pips\nx = 2.2 / 20                    # = 0.11\nRR_net = (3.0 - 0.11) / (1 + 0.11)  # = 2.60\nWR_min = (1 + 0.11) / (1 + 3.0)     # = 27.7%\nP_critical = 2.2 * (3.0 + 2) / 3.0  # = 3.67 pips\n```\n\n輸出：\n```json\n{\n  \"cost_density\": 2.2,\n  \"x\": 0.11,\n  \"RR_net\": 2.60,\n  \"WR_min\": 0.277,\n  \"P_critical\": 3.67,\n  \"Loss_RR\": 0.133\n}\n```\n</quick_start>\n\n<success_criteria>\nSkill 成功執行時：\n- [ ] 輸入參數通過驗證（單位一致性）\n- [ ] 正確計算 cost_density、x、RR_net、WR_min\n- [ ] 識別是否處於高摩擦區（P < P_critical）\n- [ ] 輸出符合 outputs_schema\n- [ ] 提供 zh-TW 解釋說明\n</success_criteria>\n",
        "skills/cost-density-net-rr-calculator/references/formulas.md": "# Cost Density Model: Complete Formula Reference\n\n<notation>\n**符號定義**\n\n| 符號 | 名稱 | 定義 | 單位 |\n|------|------|------|------|\n| R | Fixed Risk | 每筆交易的固定風險金額 | 帳戶貨幣 (USD) |\n| RR_g | Gross Risk-Reward | 毛風險報酬比 = Target / Stop | 無單位 |\n| P | Stop-Loss Size | 停損大小 | pips 或 points |\n| V | Pip Value | 每 pip 每手的價值 | 帳戶貨幣/pip |\n| c | Commission | 來回佣金（每手） | 帳戶貨幣 |\n| s | Spread | 來回點差 | pips 或 points |\n| x | Load Coefficient | 負載係數 | 無單位 |\n</notation>\n\n<core_formulas>\n**1. 部位規模（固定風險框架）**\n\n```\nLot = R / (P × V)\n```\n\n推導：若風險 R 固定，停損 P pips，每 pip 價值 V，則：\n- 最大損失 = Lot × P × V = R\n- 因此 Lot = R / (P × V)\n\n**2. 總交易成本**\n\n```\nC_total(P) = Lot × (c + s × V)\n           = (R / (P × V)) × (c + s × V)\n           = R × (c/V + s) / P\n           = R × CostDensity / P\n```\n\n其中 **Cost Density = (c/V + s)** 是成本密度（pips 等效）。\n\n關鍵洞察：成本與 P 成反比（雙曲線關係）。\n\n**3. 淨風險報酬比**\n\n```\n實際利潤 = Lot × RR_g × P × V - C_total\n         = R × RR_g - R × CostDensity / P\n\n實際風險 = R + C_total\n         = R × (1 + CostDensity / P)\n\nRR_net = 實際利潤 / 實際風險\n       = (R × RR_g - R × CostDensity / P) / (R × (1 + CostDensity / P))\n       = (RR_g - CostDensity / P) / (1 + CostDensity / P)\n```\n\n令 **x = CostDensity / P**，得到正規形式：\n\n```\nRR_net = (RR_g - x) / (1 + x)\n```\n\n**重要性質：RR_net 與 R 無關**（R 在推導中被消去）。\n\n**4. 負載係數 x**\n\n```\nx = CostDensity / P = (c/V + s) / P\n```\n\nx 的物理意義：成本佔停損的比例。\n\n極限行為：\n- P → ∞：x → 0，RR_net → RR_g\n- P → 0：x → ∞，RR_net → -1\n\n**5. 效率損失**\n\n```\nLoss_RR = 1 - (RR_net / RR_g)\n        = (RR_g - RR_net) / RR_g\n        = x × (RR_g + 1) / (RR_g × (1 + x))\n```\n\n一階導數分析表明：Loss_RR 對 x 的增長是加速的。\n\n**6. 最低勝率（打平）**\n\n期望值 E = WR × Win - (1-WR) × Loss = 0\n\n在成本調整後：\n- Win = RR_net × Risk\n- Loss = Risk\n\n解得：\n```\nWR_min = 1 / (1 + RR_net)\n       = 1 / (1 + (RR_g - x)/(1 + x))\n       = (1 + x) / (1 + RR_g)\n```\n\nWR_min 隨 x 線性增長。\n\n**7. 臨界停損（效率減半點）**\n\n設 RR_net = 0.5 × RR_g，求 P_critical：\n\n```\n(RR_g - x) / (1 + x) = 0.5 × RR_g\nRR_g - x = 0.5 × RR_g × (1 + x)\nRR_g - x = 0.5 × RR_g + 0.5 × RR_g × x\n0.5 × RR_g = x × (1 + 0.5 × RR_g)\nx = 0.5 × RR_g / (1 + 0.5 × RR_g)\nx = RR_g / (2 + RR_g)\n```\n\n由 x = CostDensity / P：\n```\nP_critical = CostDensity / x\n           = CostDensity × (2 + RR_g) / RR_g\n           = CostDensity × (RR_g + 2) / RR_g\n```\n</core_formulas>\n\n<invariance_proof>\n**R 無關性證明**\n\n定理：RR_net 不依賴固定風險 R。\n\n證明：\n1. 設任意 R > 0\n2. Lot = R / (P × V)\n3. C_total = Lot × (c + s × V) = R × (c/V + s) / P\n4. 實際利潤 = Lot × RR_g × P × V - C_total = R × RR_g - R × x\n5. 實際風險 = R + C_total = R × (1 + x)\n6. RR_net = R × (RR_g - x) / (R × (1 + x)) = (RR_g - x) / (1 + x)\n\nR 在最後一步被完全消去。QED\n\n物理意義：效率衰減是結構性的，與資金規模無關。\n</invariance_proof>\n\n<limit_behavior>\n**極限行為分析**\n\n**Case 1: P → ∞ (大停損)**\n```\nx = CostDensity / P → 0\nRR_net = (RR_g - 0) / (1 + 0) = RR_g\nWR_min = (1 + 0) / (1 + RR_g) = 1 / (1 + RR_g)\n```\n成本影響趨近於零。\n\n**Case 2: P → 0+ (極小停損)**\n```\nx = CostDensity / P → ∞\nRR_net = (RR_g - ∞) / (1 + ∞) → -1\nWR_min = (1 + ∞) / (1 + RR_g) → ∞\n```\n策略變為必輸。\n\n**Case 3: P = CostDensity (停損等於成本)**\n```\nx = 1\nRR_net = (RR_g - 1) / 2\n```\n若 RR_g = 3，則 RR_net = 1（損失 67%）。\n\n**Case 4: P = RR_g × CostDensity (停損等於成本×毛RR)**\n```\nx = 1 / RR_g\nRR_net = (RR_g - 1/RR_g) / (1 + 1/RR_g)\n       = (RR_g² - 1) / (RR_g + 1)\n       = RR_g - 1\n```\n若 RR_g = 3，則 RR_net = 2（損失 33%）。\n</limit_behavior>\n\n<numerical_example>\n**XAU/USD 計算範例**\n\n參數：\n- RR_g = 3.0\n- c = $7.00 (round-turn commission)\n- s = 1.5 pips (spread)\n- V = $10/pip (standard lot)\n\nStep 1: Cost Density\n```\nCostDensity = c/V + s = 7/10 + 1.5 = 0.7 + 1.5 = 2.2 pips\n```\n\nStep 2: P_critical\n```\nP_critical = 2.2 × (3 + 2) / 3 = 2.2 × 5/3 = 3.67 pips\n```\n\nStep 3: 不同 P 值的結果\n\n| P (pips) | x     | RR_net | Loss_RR | WR_min |\n|----------|-------|--------|---------|--------|\n| 5        | 0.440 | 1.78   | 40.8%   | 36.0%  |\n| 10       | 0.220 | 2.28   | 24.1%   | 30.5%  |\n| 20       | 0.110 | 2.60   | 13.3%   | 27.7%  |\n| 50       | 0.044 | 2.83   | 5.6%    | 26.1%  |\n| 100      | 0.022 | 2.92   | 2.9%    | 25.6%  |\n\n觀察：\n- 停損從 20 降至 5 pips（縮小 75%），效率損失從 13% 增至 41%（增加 3 倍）\n- P = 5 時勝率需求 36%，P = 20 時僅需 27.7%\n</numerical_example>\n",
        "skills/cost-density-net-rr-calculator/references/theory.md": "# Market Microstructure Theory Background\n\n<overview>\n成本密度模型建立在市場微結構理論之上，特別是關於交易成本如何影響策略期望值的研究。本文件提供理論背景與文獻脈絡。\n</overview>\n\n<literature_foundations>\n**1. Kyle (1985): Continuous Auctions and Insider Trading**\n\nKyle 的模型揭示了信息交易者如何影響價格：\n- 做市商面臨逆向選擇風險\n- 價格影響與交易量成正比\n- 大單分拆可降低信息洩露\n\n與成本密度模型的關聯：\n- 點差反映做市商的逆向選擇補償\n- 高頻交易者面臨更大的點差成本比例\n\n**2. Glosten & Milgrom (1985): Bid-Ask Spread Model**\n\n解釋點差存在的原因：\n- 知情交易者與不知情交易者的分離均衡\n- 點差是做市商對信息不對稱的保護\n\n關鍵洞察：\n```\n點差 = 逆向選擇成本 + 存貨成本 + 訂單處理成本\n```\n\n成本密度模型將這些成本整合為單一指標。\n\n**3. Easley & O'Hara (1987): Price, Trade Size, and Information**\n\n研究交易規模與信息流的關係：\n- 大單被視為包含更多信息\n- 小單可能更頻繁但信息含量低\n- 每單成本比例在小單時更高\n\n這解釋了為何微型時間框架面臨「剪刀效應」。\n\n**4. O'Hara (1995): Market Microstructure Theory**\n\n系統性整理微結構理論：\n- 價格發現機制\n- 流動性與執行成本\n- 市場設計對成本的影響\n\n**5. Biais, Glosten & Spatt (2005): Survey**\n\n現代微結構實證研究綜述：\n- 電子化降低了固定成本\n- 但相對成本（作為 % 的）仍然顯著\n- 高頻策略面臨的微結構挑戰\n</literature_foundations>\n\n<hyperbolic_decay_intuition>\n**雙曲線衰減的直觀理解**\n\n為什麼成本與停損是反比關係？\n\n**1. 固定成本被較小的利潤稀釋**\n\n設每手固定成本為 C，預期利潤為 Profit：\n- 大停損：Profit 大，C/Profit 小\n- 小停損：Profit 小，C/Profit 大\n\n比例關係是 1/P，這就是雙曲線。\n\n**2. 部位規模放大效應**\n\n固定風險下，小停損需要更大部位：\n```\nLot = R / (P × V)\n```\n\n更大部位 = 更多佣金（佣金通常按手計）。\n\n**3. 頻率效應**\n\n小停損策略通常交易更頻繁：\n- 更多交易 = 更多成本累積\n- 成本在時間維度上也是非線性的\n</hyperbolic_decay_intuition>\n\n<scissors_effect>\n**剪刀效應 (Scissors Effect)**\n\n微型時間框架策略同時面臨兩個惡化因素：\n\n**上刀片：成本負擔增加**\n- 停損縮小 → x 增加 → RR_net 下降\n- 數學上無法規避\n\n**下刀片：訊號品質下降**\n- 短週期噪音比例更高\n- 預測準確度下降\n- 實際勝率更難達到 WR_min\n\n兩個因素相向而行，形成「剪刀」：\n\n```\n        成本負擔 ↗\n                   ╲\n                    ╲  獲利空間被壓縮\n                     ╲\n                      ╲\n        訊號品質 ↘ ════╳════ → 時間框架縮短\n```\n\n這是微型時間框架策略難以獲利的根本原因。\n</scissors_effect>\n\n<event_horizon_concept>\n**事件視界概念**\n\n借用黑洞物理學的比喻：\n\n**黑洞事件視界**\n- 光速在此處無法逃逸\n- 一旦越過，必然被吸入奇點\n\n**獲利事件視界**\n- 當 P < CostDensity 時，x > 1\n- RR_net = (RR_g - x) / (1 + x) 變為負值\n- 無論交易技術多好，期望值都是負的\n\n```\nP_critical 是「警戒線」（效率減半）\nP = CostDensity 是「事件視界」（RR_net = 0 的極限）\nP < CostDensity 是「黑洞內部」（必輸區）\n```\n\n這不是心理或技術問題，而是數學結構決定的。\n</event_horizon_concept>\n\n<practical_implications>\n**實務啟示**\n\n**1. 回測校正**\n\n傳統回測使用 RR_g 計算期望值：\n```\nE_naive = WR × RR_g - (1 - WR)\n```\n\n正確做法是使用 RR_net：\n```\nE_correct = WR × RR_net - (1 - WR) × (1 + C_ratio)\n```\n\n差異在短時間框架可達 20-40%。\n\n**2. 經紀商選擇**\n\n成本密度 = c/V + s\n\n降低成本密度的方法：\n- 選擇低佣金經紀商（降低 c）\n- 選擇低點差經紀商（降低 s）\n- 交易高 V 商品（如期貨 vs CFD）\n\n**3. 策略設計原則**\n\n- 設定最小可行停損 > P_critical × 1.5\n- 優先選擇高 RR_g 策略（降低 WR 需求）\n- 避免過度優化到極短時間框架\n\n**4. 風險管理**\n\n- 監控實際滑點（模型假設理想執行）\n- 流動性差時成本密度會增加\n- 新聞事件時點差擴大\n</practical_implications>\n\n<model_limitations>\n**模型限制**\n\n**1. 假設理想執行**\n- 無滑點\n- 無部分成交\n- 無市場影響\n\n**2. 不包含持倉成本**\n- 隔夜利息 (swap)\n- 借券成本\n- 資金成本\n\n**3. 靜態點差假設**\n- 實際點差會變動\n- 流動性事件時點差擴大\n- 夜盤點差通常較高\n\n**4. 單一交易分析**\n- 不考慮策略組合效應\n- 不考慮相關性對沖\n\n儘管有這些限制，模型在流動性良好的市場（如 XAU/USD、主要貨幣對）仍然是有效的「現實檢查」工具。\n</model_limitations>\n",
        "skills/cost-density-net-rr-calculator/workflows/analyze.md": "# Workflow: Analyze & Interpret\n\n<required_reading>\n**Read these reference files NOW:**\n1. references/formulas.md\n2. references/theory.md\n</required_reading>\n\n<process>\n## Step 1: 執行計算\n\n根據輸入決定執行 compute 或 sweep 工作流程，取得計算結果。\n\n## Step 2: 診斷當前狀態\n\n基於計算結果，診斷策略狀態：\n\n```python\ndef diagnose(results):\n    diagnosis = {\n        \"status\": None,\n        \"severity\": None,\n        \"issues\": [],\n        \"recommendations\": []\n    }\n\n    # 檢查是否在高摩擦區\n    if results[\"P\"] < results[\"P_critical\"]:\n        diagnosis[\"status\"] = \"critical\"\n        diagnosis[\"severity\"] = \"high\"\n        diagnosis[\"issues\"].append(\n            f\"停損 {results['P']} pips 低於臨界值 {results['P_critical']:.1f} pips\"\n        )\n\n    # 檢查效率損失\n    if results[\"Loss_RR\"] > 0.40:\n        diagnosis[\"severity\"] = \"high\"\n        diagnosis[\"issues\"].append(\n            f\"效率損失 {results['Loss_RR']*100:.1f}% 超過 40%\"\n        )\n    elif results[\"Loss_RR\"] > 0.20:\n        diagnosis[\"severity\"] = \"medium\"\n        diagnosis[\"issues\"].append(\n            f\"效率損失 {results['Loss_RR']*100:.1f}% 介於 20-40%\"\n        )\n\n    # 檢查勝率需求\n    if results[\"WR_min\"] > 0.50:\n        diagnosis[\"issues\"].append(\n            f\"需要 {results['WR_min']*100:.1f}% 勝率才能打平，難以實現\"\n        )\n\n    return diagnosis\n```\n\n## Step 3: 生成策略建議\n\n```python\ndef generate_recommendations(diagnosis, results):\n    recs = []\n\n    if diagnosis[\"severity\"] == \"high\":\n        recs.append({\n            \"priority\": \"urgent\",\n            \"action\": \"增加停損大小\",\n            \"target\": f\"至少 {results['P_critical'] * 1.5:.1f} pips\",\n            \"reason\": \"目前處於高摩擦區，成本侵蝕過度\"\n        })\n\n    if results[\"Loss_RR\"] > 0.20:\n        recs.append({\n            \"priority\": \"important\",\n            \"action\": \"在回測中使用 RR_net\",\n            \"target\": f\"將 RR 從 {results['RR_g']} 調整為 {results['RR_net']:.2f}\",\n            \"reason\": \"確保回測結果反映實際成本影響\"\n        })\n\n    if results[\"WR_min\"] > 0.40:\n        recs.append({\n            \"priority\": \"important\",\n            \"action\": \"提高毛 RR 目標\",\n            \"target\": \"考慮 RR_g >= 4.0\",\n            \"reason\": \"降低勝率門檻，增加策略容錯空間\"\n        })\n\n    # 通用建議\n    recs.append({\n        \"priority\": \"standard\",\n        \"action\": \"選擇低成本經紀商\",\n        \"target\": \"降低 c 或 s\",\n        \"reason\": \"直接減少成本密度\"\n    })\n\n    return recs\n```\n\n## Step 4: 解釋理論背景\n\n提供易懂的理論解釋：\n\n**雙曲線衰減現象**\n```\n當停損從 20 pips 縮小到 10 pips（減半），\n成本負載 x 從 0.11 增加到 0.22（翻倍）。\n這不是線性關係，而是反比關係：x = CostDensity / P\n\n這就是為什麼微型時間框架策略特別困難：\n1. 停損必須縮小以適應較小波動\n2. 成本負載因此非線性增加\n3. 同時訊號雜訊比下降（剪刀效應）\n```\n\n**事件視界概念**\n```\nP_critical 是策略的「事件視界」：\n- 低於此值，RR_net 衰減加速\n- 接近 P = CostDensity 時，RR_net → 0\n- 低於 CostDensity，RR_net 變為負值\n\n這是數學上的硬限制，與交易技術無關。\n```\n\n## Step 5: 組裝分析報告\n\n```json\n{\n  \"summary\": {\n    \"status\": \"warning\",\n    \"headline\": \"效率損失 24%，建議增加停損\"\n  },\n  \"diagnosis\": {\n    \"severity\": \"medium\",\n    \"issues\": [\n      \"效率損失 24% 介於 20-40%\",\n      \"停損接近臨界區域\"\n    ]\n  },\n  \"metrics\": {\n    \"RR_g\": 3.0,\n    \"RR_net\": 2.28,\n    \"efficiency\": 0.76,\n    \"WR_min\": 0.31,\n    \"P_current\": 10,\n    \"P_critical\": 3.67\n  },\n  \"recommendations\": [\n    {\n      \"priority\": \"important\",\n      \"action\": \"在回測中使用 RR_net\",\n      \"target\": \"將 RR 從 3.0 調整為 2.28\"\n    },\n    {\n      \"priority\": \"standard\",\n      \"action\": \"考慮增加停損至 15-20 pips\"\n    }\n  ],\n  \"theory_explanation\": \"...\",\n  \"notes\": [\n    \"您的策略目前在可接受範圍內，但接近警戒線\",\n    \"如果進一步縮小停損，效率會急劇下降\",\n    \"建議監控實際滑點，此模型假設理想執行\"\n  ]\n}\n```\n</process>\n\n<success_criteria>\n此工作流程完成時：\n- [ ] 正確診斷策略狀態（severity: low/medium/high）\n- [ ] 識別所有問題點\n- [ ] 生成優先級排序的建議\n- [ ] 提供易懂的理論解釋\n- [ ] 輸出完整的分析報告 JSON\n- [ ] 所有說明使用 zh-TW\n</success_criteria>\n",
        "skills/cost-density-net-rr-calculator/workflows/compute.md": "# Workflow: Compute Single\n\n<required_reading>\n**Read these reference files NOW:**\n1. references/formulas.md\n</required_reading>\n\n<process>\n## Step 1: 驗證輸入參數\n\n檢查必要參數：\n- `RR_g` (number, >= 0): 毛風險報酬比\n- `P` (number, > 0): 停損大小 (pips)\n- `c` (number, >= 0): 來回佣金 (帳戶貨幣)\n- `s` (number, >= 0): 來回點差 (pips)\n- `V` (number, > 0): 每 pip 價值 (帳戶貨幣/pip)\n\n驗證規則：\n```python\nassert RR_g >= 0, \"RR_g must be non-negative\"\nassert P > 0, \"P (stop-loss) must be positive\"\nassert V > 0, \"V (pip value) must be positive\"\n```\n\n## Step 2: 計算成本密度\n\n```python\ncost_density = (c / V) + s  # pips equivalent\n```\n\n說明：將佣金轉換為 pips 等效值，加上點差。\n\n## Step 3: 計算負載係數 x\n\n```python\nx = cost_density / P\n```\n\n說明：x 表示成本相對於停損的比例。P 越小，x 越大。\n\n## Step 4: 計算淨風險報酬比\n\n```python\nRR_net = (RR_g - x) / (1 + x)\n```\n\n關鍵洞察：\n- 當 x → 0 時，RR_net → RR_g\n- 當 x → ∞ 時，RR_net → -1\n\n## Step 5: 計算輔助指標\n\n```python\n# 效率損失\nLoss_RR = (x * (RR_g + 1)) / (RR_g * (1 + x))\n\n# 最低勝率\nWR_min = (1 + x) / (1 + RR_g)\n\n# 效率減半點\nP_critical = cost_density * (RR_g + 2) / RR_g\n```\n\n## Step 6: 判斷摩擦區域\n\n```python\nif P < P_critical:\n    zone = \"high_friction\"  # 高摩擦區\n    warning = \"停損低於 P_critical，效率損失超過 50%\"\nelse:\n    zone = \"normal\"\n```\n\n## Step 7: 組裝輸出\n\n```json\n{\n  \"cost_density\": 2.2,\n  \"x\": 0.11,\n  \"RR_net\": 2.60,\n  \"Loss_RR\": 0.133,\n  \"WR_min\": 0.277,\n  \"P_critical\": 3.67,\n  \"zone\": \"normal\",\n  \"notes\": [\n    \"成本密度 2.2 pips = 佣金等效 0.7 + 點差 1.5\",\n    \"淨 RR 從 3.0 降至 2.60，損失 13.3%\",\n    \"需 27.7% 勝率才能打平\"\n  ]\n}\n```\n</process>\n\n<success_criteria>\n此工作流程完成時：\n- [ ] 輸入參數通過驗證\n- [ ] cost_density 正確計算\n- [ ] x, RR_net, Loss_RR, WR_min, P_critical 正確計算\n- [ ] 正確識別摩擦區域\n- [ ] 輸出包含 zh-TW 說明 notes\n</success_criteria>\n",
        "skills/cost-density-net-rr-calculator/workflows/sweep.md": "# Workflow: Sweep Grid\n\n<required_reading>\n**Read these reference files NOW:**\n1. references/formulas.md\n</required_reading>\n\n<process>\n## Step 1: 解析網格參數\n\n從 `grid` 物件提取：\n```python\nP_min = grid.get(\"P_min\", 1)      # 最小停損\nP_max = grid.get(\"P_max\", 100)    # 最大停損\nsteps = grid.get(\"steps\", 20)     # 步數\n```\n\n驗證：\n```python\nassert P_min > 0, \"P_min must be positive\"\nassert P_max > P_min, \"P_max must be greater than P_min\"\nassert 3 <= steps <= 2000, \"steps must be between 3 and 2000\"\n```\n\n## Step 2: 生成 P 序列\n\n```python\nimport numpy as np\n\nP_values = np.linspace(P_min, P_max, steps)\n# 或使用對數刻度更清楚顯示低 P 區域\nP_values = np.logspace(np.log10(P_min), np.log10(P_max), steps)\n```\n\n## Step 3: 批量計算\n\n```python\nresults = []\nfor P in P_values:\n    x = cost_density / P\n    RR_net = (RR_g - x) / (1 + x)\n    WR_min = (1 + x) / (1 + RR_g)\n    Loss_RR = (x * (RR_g + 1)) / (RR_g * (1 + x))\n\n    results.append({\n        \"P\": round(P, 2),\n        \"x\": round(x, 4),\n        \"RR_net\": round(RR_net, 3),\n        \"WR_min\": round(WR_min, 4),\n        \"Loss_RR\": round(Loss_RR, 4)\n    })\n```\n\n## Step 4: 識別關鍵閾值\n\n```python\nthresholds = {}\n\n# RR_net > 0 的最小 P\nfor r in results:\n    if r[\"RR_net\"] > 0:\n        thresholds[\"P_breakeven\"] = r[\"P\"]\n        break\n\n# WR_min 達到特定水平的 P\nfor target_wr in [0.35, 0.40, 0.50]:\n    for r in results:\n        if r[\"WR_min\"] <= target_wr:\n            thresholds[f\"P_WR_{int(target_wr*100)}\"] = r[\"P\"]\n            break\n\n# Loss_RR 達到特定水平的 P\nfor target_loss in [0.20, 0.40, 0.60]:\n    for r in results:\n        if r[\"Loss_RR\"] <= target_loss:\n            thresholds[f\"P_Loss_{int(target_loss*100)}\"] = r[\"P\"]\n            break\n```\n\n## Step 5: 選取代表性數據點\n\n選擇 5-8 個關鍵點用於報表：\n```python\nkey_indices = [0, len(results)//4, len(results)//2,\n               3*len(results)//4, len(results)-1]\nsummary_table = [results[i] for i in key_indices]\n```\n\n## Step 6: 組裝輸出\n\n```json\n{\n  \"cost_density\": 2.2,\n  \"P_critical\": 3.67,\n  \"thresholds\": {\n    \"P_breakeven\": 2.2,\n    \"P_WR_35\": 5.5,\n    \"P_WR_40\": 8.8,\n    \"P_Loss_20\": 11.0\n  },\n  \"summary_table\": [\n    {\"P\": 5, \"x\": 0.44, \"RR_net\": 1.78, \"WR_min\": 0.36, \"Loss_RR\": 0.41},\n    {\"P\": 10, \"x\": 0.22, \"RR_net\": 2.28, \"WR_min\": 0.31, \"Loss_RR\": 0.24},\n    {\"P\": 20, \"x\": 0.11, \"RR_net\": 2.60, \"WR_min\": 0.28, \"Loss_RR\": 0.13},\n    {\"P\": 50, \"x\": 0.044, \"RR_net\": 2.83, \"WR_min\": 0.26, \"Loss_RR\": 0.06}\n  ],\n  \"full_results\": [...],\n  \"notes\": [\n    \"停損從 20 降至 5 pips，效率損失從 13% 增至 41%\",\n    \"P < 3.67 pips 進入高摩擦區\",\n    \"建議停損維持在 10 pips 以上以保持 Loss_RR < 25%\"\n  ]\n}\n```\n</process>\n\n<success_criteria>\n此工作流程完成時：\n- [ ] 網格參數正確解析\n- [ ] P 序列正確生成\n- [ ] 批量計算正確執行\n- [ ] 關鍵閾值正確識別\n- [ ] 輸出包含 summary_table 和 thresholds\n- [ ] 提供 zh-TW 策略建議 notes\n</success_criteria>\n",
        "skills/demographic-fiscal-trap-analyzer/SKILL.md": "---\nname: demographic-fiscal-trap-analyzer\ndescription: 分析人口老化、債務動態、官僚膨脹與通膨稀釋交互作用下的「財政陷阱」風險，量化各國/地區的財政脆弱度並識別潛在的貨幣稀釋路徑\n---\n\n<essential_principles>\n\n<principle name=\"fiscal_trap_definition\">\n**財政陷阱定義**\n\n「人口-財政陷阱」(Demographic-Fiscal Trap) 是指：當高齡化撫養比持續攀升、政府債務/GDP 居高不下、官僚體系低效膨脹、且名義成長無法覆蓋利息支出時，政府傾向透過「金融抑制」(financial repression) 或「通膨稀釋」(inflation erosion) 來削減實質負債。\n\n此陷阱的核心特徵：\n1. **人口結構剛性**：老年撫養比上升是不可逆的長期趨勢\n2. **債務自我強化**：r > g 時債務比率自動膨脹\n3. **政治阻力**：削減福利支出的政治成本極高\n4. **貨幣出口**：當財政改革無路可走，貨幣稀釋成為「最小阻力路徑」\n</principle>\n\n<principle name=\"four_pillar_framework\">\n**四支柱分析架構**\n\n本技能採用四維度評分框架：\n\n| 支柱                      | 權重(預設) | 核心指標                    |\n|---------------------------|------------|-----------------------------|\n| 老化壓力 (Aging Pressure) | 35%        | 老年撫養比水準 + 10年斜率   |\n| 債務動態 (Debt Dynamics)  | 35%        | 債務/GDP + 5年斜率 + (r-g)  |\n| 官僚膨脹 (Bloat Index)    | 15%        | 政府消費/GDP + 政府支出/GDP |\n| 成長拖累 (Growth Drag)    | 15%        | 名義GDP成長率（負向計分）   |\n\n最終 `fiscal_trap_score` = Σ(權重 × z-score) 加權總和\n</principle>\n\n<principle name=\"inflation_incentive\">\n**通膨激勵指數**\n\n通膨激勵指數 (Inflation Incentive Score) 衡量政府選擇「通膨稀釋」路徑的動機強度：\n\n```\ninflation_incentive =\n    0.40 × zscore(debt_level)           # 高債務 → 強動機\n  + 0.20 × zscore(r - g)                # r > g → 難以自然去槓桿\n  + 0.20 × zscore(neg_real_rate_share)  # 負實質利率持續 → 已在執行\n  + 0.20 × zscore(bloat_index)          # 高官僚膨脹 → 難以削減支出\n```\n\n當此指數 > 1.5 時，表示該經濟體有強烈動機維持負實質利率環境。\n</principle>\n\n<principle name=\"data_hierarchy\">\n**資料來源層級**\n\n本技能採用公開可重現的資料源：\n\n| 資料類型       | 首選來源        | 次選來源          | API/下載方式 |\n|----------------|-----------------|-------------------|--------------|\n| 撫養比         | World Bank WDI  | UN WPP            | API / CSV    |\n| 政府債務       | IMF WEO         | World Bank        | API / CSV    |\n| 政府支出       | IMF GFS         | World Bank        | API / CSV    |\n| 健康支出       | WHO GHED        | World Bank        | API / CSV    |\n| 名義GDP成長    | World Bank      | IMF WEO           | API          |\n| CPI通膨        | World Bank      | IMF               | API          |\n| 10年公債殖利率 | OECD / 各國央行 | Trading Economics | API / 爬蟲   |\n\n所有指標均可透過 `wbdata`、`imfpy` 或直接 API 取得。\n</principle>\n\n<principle name=\"zscore_normalization\">\n**Z-Score 標準化**\n\n為使跨國比較有意義，所有原始指標均轉換為 z-score：\n\n```python\nzscore(x) = (x - μ_cross_section) / σ_cross_section\n```\n\n其中 μ 和 σ 為同期跨國截面統計量。\n\n這使得：\n- z > 1.5 → 顯著高於平均（警戒）\n- z > 2.0 → 極端值（紅燈）\n- z < -1.0 → 顯著優於平均\n</principle>\n\n<principle name=\"quadrant_classification\">\n**象限分類系統**\n\n根據 Aging Pressure 和 Debt Dynamics 兩主軸，將經濟體分為四象限：\n\n| 象限         | 老化壓力 | 債務動態 | 典型國家           | 政策空間         |\n|--------------|----------|----------|--------------------|------------------|\n| Q1: 雙高危機 | 高 (>1)  | 高 (>1)  | 日本、義大利、希臘 | 極窄             |\n| Q2: 老化主導 | 高 (>1)  | 低 (<1)  | 德國、南韓         | 中等（債務可用） |\n| Q3: 債務主導 | 低 (<1)  | 高 (>1)  | 美國、巴西         | 中等（人口紅利） |\n| Q4: 相對健康 | 低 (<1)  | 低 (<1)  | 印度、印尼         | 寬廣             |\n\nQ1 象限國家最可能進入「財政陷阱」並選擇通膨稀釋路徑。\n</principle>\n\n</essential_principles>\n\n<objective>\n本技能的目標是：\n\n1. **量化財政脆弱度**：計算各國/地區的 `fiscal_trap_score` 與 `inflation_incentive_score`\n2. **識別結構風險**：透過四支柱分解，診斷哪個維度貢獻最大風險\n3. **象限定位**：將經濟體歸類至四象限，判斷其政策空間\n4. **趨勢預警**：利用撫養比預測至 2050 年，前瞻性評估陷阱演化\n5. **跨國比較**：支援多國並排比較，識別相對風險排序\n</objective>\n\n<quick_start>\n## 快速開始\n\n**單一國家分析**\n```\n請分析日本的人口財政陷阱風險，使用 2010-2023 年資料，預測至 2050 年\n```\n\n**多國比較**\n```\n比較 G7 國家的財政陷阱分數，並按通膨激勵指數排序\n```\n\n**自訂權重**\n```\n分析台灣的財政陷阱，使用自訂權重：老化 40%、債務 40%、膨脹 10%、成長 10%\n```\n</quick_start>\n\n<parameters>\n## 參數說明\n\n| 參數                  | 型別         | 必填 | 預設值                                                        | 說明                                          |\n|-----------------------|--------------|------|---------------------------------------------------------------|-----------------------------------------------|\n| entities              | list[string] | 是   | -                                                             | 國家/地區代碼 (ISO3 或區域如 OECD, EU, WORLD) |\n| start_year            | int          | 是   | -                                                             | 歷史資料起始年                                |\n| end_year              | int          | 是   | -                                                             | 歷史資料結束年（通常=最近一年）               |\n| forecast_end_year     | int          | 否   | 2050                                                          | 撫養比預測結束年                              |\n| dependency_components | list[string] | 否   | [\"old_age\",\"youth\",\"total\"]                                   | 撫養比分解項目                                |\n| fiscal_modules        | list[string] | 否   | [\"debt\",\"spending\",\"health\"]                                  | 啟用的財政模組                                |\n| bureaucracy_proxies   | list[string] | 否   | [\"gov_wage_bill\",\"public_employment_share\",\"gov_consumption\"] | 官僚膨脹代理指標                              |\n| inflation_channel     | string       | 否   | \"real_rates\"                                                  | 通膨路徑分析方式                              |\n| weights               | dict         | 否   | {\"aging\":0.35,\"debt\":0.35,\"bloat\":0.15,\"growth_drag\":0.15}    | 各支柱權重                                    |\n</parameters>\n\n<workflows_overview>\n## 可用工作流\n\n1. **full-analysis.md** - 完整分析：執行所有模組並產出綜合報告\n2. **debt-dynamics.md** - 債務動態專題：深入分析 r-g 缺口與債務軌跡\n3. **aging-projection.md** - 老化投影：撫養比預測與財政壓力前瞻\n4. **cross-country.md** - 跨國比較：多國並排評分與排名\n5. **inflation-path.md** - 通膨路徑：分析負實質利率持續性與貨幣稀釋動機\n</workflows_overview>\n\n<interpretation_guide>\n## 結果解讀指南\n\n### Fiscal Trap Score 解讀\n| 分數區間 | 風險等級 | 建議關注                           |\n|----------|----------|------------------------------------|\n| < 0      | 低風險   | 財政健全，政策空間充裕             |\n| 0 - 1    | 中等風險 | 需監控特定支柱惡化                 |\n| 1 - 2    | 高風險   | 結構性問題顯著，改革窗口收窄       |\n| > 2      | 極高風險 | 財政陷阱風險極高，通膨稀釋概率上升 |\n\n### Inflation Incentive Score 解讀\n| 分數區間  | 政策傾向     | 對資產配置意涵     |\n|-----------|--------------|--------------------|\n| < 0.5     | 正統財政     | 名義債券相對安全   |\n| 0.5 - 1.5 | 溫和金融抑制 | 實質報酬承壓       |\n| > 1.5     | 強烈稀釋動機 | 應考慮通膨保值資產 |\n</interpretation_guide>\n\n<execution_examples>\n## 執行案例：日本人口-財政陷阱分析 (2010-2023)\n\n**分析指令**\n```\n請分析日本的人口財政陷阱風險，使用 2010-2023 年資料，預測至 2050 年\n```\n\n### 核心發現\n\n**綜合評分結果**\n- **Fiscal Trap Score**: 2.03 (CRITICAL > 2.0 閾值)\n- **Inflation Incentive Score**: 2.38 (極高 > 1.5 閾值)\n- **象限分類**: Q1 - 雙高危機 (HighAging & HighDebt)\n- **OECD排名**: #1 (風險最高國家)\n\n**四支柱詳細評分**\n\n| 支柱     | Z-Score | 權重 | 貢獻 | 全球排名 | 風險等級 |\n|----------|---------|------|------|----------|----------|\n| 老化壓力 | 2.40    | 35%  | 0.84 | #1       | ★★★★★    |\n| 債務動態 | 2.45    | 35%  | 0.86 | #1       | ★★★★★    |\n| 官僚膨脹 | 1.09    | 15%  | 0.16 | #15      | ★★☆☆☆    |\n| 成長拖累 | 1.10    | 15%  | 0.17 | #33      | ★★☆☆☆    |\n\n### 關鍵指標概覽 (2010→2023)\n\n```\n老年撫養比:      35.5% → 48.5%      (全球最高，加速中)\n政府債務/GDP:   215.8% → 262.5%     (全球最高，超可持續邊界)\n實質利率:        -2.5% (2023)        (金融抑制制度化)\n名義GDP成長:     1.5%平均           (全球最低)\n利息支出:        3.2% GDP (2023)    (2050年預測達8%+)\n```\n\n### 陷阱自我強化機制\n\n```\n老化 → 社保支出↑ → 赤字↑ → 債務↑ → 利息↑ → 赤字更↑\n              ↓(無法切斷)↓\n         整個迴圈傳統財政改革無法化解\n```\n\n### 未來場景預測\n\n| 場景     | 概率 | 特徵                          | 影響               |\n|----------|------|-------------------------------|--------------------|\n| 通膨加速 | 70%  | 名義GDP成長4-5%，央行允許通膨 | 日圓貶值15-25%     |\n| 利率衝擊 | 20%  | YCC崩潰，實質利率正常化       | 債務比率爆炸性增長 |\n| 改革突破 | 10%  | 社保根本性改革，移民開放      | 極低政治可能性     |\n\n### 資產配置建議 (日本投資者)\n\n**推薦**\n- 30% 美國股票 (美元走強+實質利率正值)\n- 20% 美國債券 (3-4% yield vs JGB -2.5%)\n- 15% 新興市場 (成長性，日圓對沖)\n- 10% 黃金 (通膨對沖)\n- 10% 日本不動產 (東京/一線，通膨受益)\n- 15% 現金/替代資產\n\n**應避免**\n- ✗ 純JGB持有 (年實質報酬 -2.5%)\n- ✗ 地方房地產 (人口衰退中)\n- ✗ 日圓堆積 (購買力侵蝕)\n\n### 生成成果物\n\n分析完成後自動生成以下文檔：\n\n1. **結構化JSON** - 完整數據與計算過程\n2. **技術報告** - 49KB 詳細分析文檔\n3. **執行摘要** - 5-10分鐘快速掌握\n4. **可視化圖表** (5張)\n   - 01_four_pillars_20260119.png - 四支柱評分分解\n   - 02_time_series_20260119.png - 2010-2023年時間序列\n   - 03_projections_20260119.png - 2024-2050年投影\n   - 04_asset_allocation_20260119.png - 資產配置建議\n   - 05_risk_scorecard_20260119.png - 風險評分卡\n\n### 監測指標 (投資決策參考)\n\n| 指標        | 當前值 | 警戒線     | 含義         |\n|-------------|--------|------------|--------------|\n| CPI通膨     | 3.3%   | >4%持續3年 | 通膨稀釋確認 |\n| 10y殖利率   | 0.8%   | >1.5%      | YCC漸進解除  |\n| JPY/USD     | 160    | >180       | 日圓貶值信號 |\n| BoJ債券持有 | 52%    | <45%       | 正常化信號   |\n\n</execution_examples>\n",
        "skills/demographic-fiscal-trap-analyzer/references/data-sources.md": "# 資料來源 (Data Sources)\n\n## 概述\n本技能使用的所有資料均來自公開、免費、可重現的來源，確保分析的透明度與可複製性。\n\n---\n\n## 一、人口與撫養比資料\n\n### 1.1 World Bank World Development Indicators (WDI)\n- **官方網站**: https://data.worldbank.org/\n- **API 端點**: https://api.worldbank.org/v2/\n- **Python 套件**: `wbdata`\n\n| 指標代碼 | 名稱 | 定義 |\n|----------|------|------|\n| SP.POP.DPND.OL | Age dependency ratio, old | 65+ / 15-64 × 100 |\n| SP.POP.DPND.YG | Age dependency ratio, young | 0-14 / 15-64 × 100 |\n| SP.POP.DPND | Age dependency ratio | (0-14 + 65+) / 15-64 × 100 |\n| SP.POP.65UP.TO.ZS | Population ages 65+ (% of total) | |\n| SP.POP.TOTL | Total population | |\n\n**使用範例**:\n```python\nimport wbdata\n\n# 設定日期範圍\ndate_range = (datetime.datetime(2010, 1, 1), datetime.datetime(2023, 12, 31))\n\n# 擷取老年撫養比\ndata = wbdata.get_dataframe(\n    {\"SP.POP.DPND.OL\": \"old_age_dependency\"},\n    country=[\"JPN\", \"USA\", \"DEU\"],\n    date=date_range\n)\n```\n\n### 1.2 UN World Population Prospects (WPP)\n- **官方網站**: https://population.un.org/wpp/\n- **下載頁面**: https://population.un.org/wpp/Download/Standard/CSV/\n- **更新頻率**: 每 2 年（最新 2024 年版）\n\n**檔案類型**:\n- Historical estimates (1950-2023)\n- Medium variant projections (2024-2100)\n- High/Low variant projections\n\n**適用情境**: 用於撫養比預測至 2050 年或更遠\n\n---\n\n## 二、政府債務資料\n\n### 2.1 IMF World Economic Outlook (WEO)\n- **官方網站**: https://www.imf.org/en/Publications/WEO\n- **資料庫**: https://www.imf.org/en/Publications/WEO/weo-database/\n- **下載格式**: Excel, CSV\n\n| 指標代碼 | 名稱 | 定義 |\n|----------|------|------|\n| GGXWDG_NGDP | General government gross debt | % of GDP |\n| GGXCNL_NGDP | General government net lending/borrowing | % of GDP |\n| NGDP_RPCH | Real GDP growth | Annual % change |\n| PCPIPCH | Inflation (CPI) | Annual % change |\n\n**使用範例**:\n```python\n# IMF WEO 通常以 Excel 提供，需手動下載或使用 imfpy\nimport pandas as pd\n\nweo_data = pd.read_csv(\"WEOApr2024.csv\", encoding=\"latin-1\")\ndebt_data = weo_data[weo_data[\"WEO Subject Code\"] == \"GGXWDG_NGDP\"]\n```\n\n### 2.2 World Bank WDI 債務指標\n| 指標代碼 | 名稱 |\n|----------|------|\n| GC.DOD.TOTL.GD.ZS | Central government debt, total (% of GDP) |\n| GC.DOD.TOTL.CN | Central government debt, total (current LCU) |\n\n**注意**: World Bank 債務資料覆蓋率較 IMF 低，部分國家可能缺失\n\n---\n\n## 三、政府支出資料\n\n### 3.1 World Bank WDI\n| 指標代碼 | 名稱 | 定義 |\n|----------|------|------|\n| NE.CON.GOVT.ZS | General government final consumption expenditure | % of GDP |\n| GC.XPN.TOTL.GD.ZS | Expense | % of GDP |\n| GC.REV.XGRT.GD.ZS | Revenue, excluding grants | % of GDP |\n\n### 3.2 IMF Government Finance Statistics (GFS)\n- **官方網站**: https://data.imf.org/GFS\n- **涵蓋範圍**: 更細緻的政府財政分類\n\n| 指標 | 說明 |\n|------|------|\n| Compensation of employees | 公部門薪資 |\n| Goods and services | 政府採購 |\n| Social benefits | 社會福利支出 |\n| Interest | 利息支出 |\n\n---\n\n## 四、健康支出資料\n\n### 4.1 WHO Global Health Expenditure Database (GHED)\n- **官方網站**: https://apps.who.int/nha/database\n- **下載格式**: Excel, CSV\n- **更新頻率**: 年度\n\n| 指標 | 說明 |\n|------|------|\n| CHE_GDP | Current health expenditure as % of GDP |\n| GGHE_CHE | Government health expenditure as % of CHE |\n| OOPS_CHE | Out-of-pocket as % of CHE |\n\n### 4.2 World Bank WDI\n| 指標代碼 | 名稱 |\n|----------|------|\n| SH.XPD.CHEX.GD.ZS | Current health expenditure (% of GDP) |\n| SH.XPD.GHED.GD.ZS | Domestic general government health expenditure (% of GDP) |\n\n---\n\n## 五、經濟成長與通膨資料\n\n### 5.1 World Bank WDI\n| 指標代碼 | 名稱 |\n|----------|------|\n| NY.GDP.MKTP.KD.ZG | GDP growth (annual %) | 實質 |\n| NY.GDP.MKTP.CD | GDP (current US$) |\n| FP.CPI.TOTL.ZG | Inflation, consumer prices (annual %) |\n\n### 5.2 名義 GDP 成長計算\n```python\n# 名義 GDP 成長 ≈ 實質 GDP 成長 + CPI 通膨\nnominal_gdp_growth = real_gdp_growth + cpi_inflation\n\n# 或直接從名義 GDP 計算\nnominal_gdp = wbdata.get_dataframe({\"NY.GDP.MKTP.CD\": \"gdp_nominal\"})\nnominal_growth = nominal_gdp.pct_change() * 100\n```\n\n---\n\n## 六、利率資料\n\n### 6.1 OECD Statistics\n- **官方網站**: https://stats.oecd.org/\n- **API**: https://stats.oecd.org/SDMX-JSON/\n\n| 指標代碼 | 名稱 |\n|----------|------|\n| IRLT | Long-term interest rates (10-year government bonds) |\n| IRSTCI | Short-term interest rates |\n\n**覆蓋範圍**: 主要為 OECD 成員國\n\n### 6.2 各國央行資料\n對於非 OECD 國家或缺失資料，需直接從央行網站取得：\n\n| 國家 | 來源 |\n|------|------|\n| 美國 | FRED (Federal Reserve Economic Data) |\n| 日本 | Bank of Japan Statistics |\n| 中國 | PBOC / Wind |\n| 印度 | RBI Database |\n\n### 6.3 回退策略\n當 10 年公債殖利率不可用時：\n1. 使用 5 年公債殖利率\n2. 使用政策利率（央行基準利率）\n3. 使用銀行貸款利率\n\n```python\ndef get_interest_rate(entity, year):\n    # 嘗試順序：10Y yield → 5Y yield → policy rate → lending rate\n    for indicator in [\"IRLT\", \"IRS5Y\", \"IRSTCI\", \"FR.INR.LEND\"]:\n        rate = fetch_indicator(entity, indicator, year)\n        if rate is not None:\n            return rate\n    return None\n```\n\n---\n\n## 七、資本管制與金融抑制指標\n\n### 7.1 Chinn-Ito Index\n- **官方網站**: http://web.pdx.edu/~ito/Chinn-Ito_website.htm\n- **說明**: 衡量資本帳戶開放程度\n- **範圍**: -1.89 (最封閉) 至 2.39 (最開放)\n\n### 7.2 IMF AREAER\n- **官方網站**: https://www.elibrary-areaer.imf.org/\n- **說明**: Annual Report on Exchange Arrangements and Exchange Restrictions\n\n---\n\n## 八、資料取得 Python 程式碼範例\n\n```python\nimport wbdata\nimport pandas as pd\nimport datetime\n\ndef fetch_worldbank_data(entities, indicators, start_year, end_year):\n    \"\"\"\n    從 World Bank API 擷取資料\n\n    Parameters:\n    - entities: list of ISO3 country codes\n    - indicators: dict of {indicator_code: column_name}\n    - start_year, end_year: int\n    \"\"\"\n    date_range = (\n        datetime.datetime(start_year, 1, 1),\n        datetime.datetime(end_year, 12, 31)\n    )\n\n    data = wbdata.get_dataframe(\n        indicators,\n        country=entities,\n        date=date_range\n    )\n\n    return data.reset_index()\n\n\n# 使用範例\nindicators = {\n    \"SP.POP.DPND.OL\": \"old_age_dependency\",\n    \"GC.DOD.TOTL.GD.ZS\": \"debt_to_gdp\",\n    \"NE.CON.GOVT.ZS\": \"gov_consumption\",\n    \"NY.GDP.MKTP.KD.ZG\": \"real_gdp_growth\",\n    \"FP.CPI.TOTL.ZG\": \"cpi_inflation\"\n}\n\nentities = [\"JPN\", \"USA\", \"DEU\", \"GBR\", \"FRA\", \"ITA\", \"CAN\"]\n\ndf = fetch_worldbank_data(entities, indicators, 2010, 2023)\n```\n\n---\n\n## 九、資料品質與限制\n\n### 9.1 常見問題\n| 問題 | 影響 | 因應方式 |\n|------|------|----------|\n| 資料延遲 | 最新年份可能缺失 | 使用 T-1 或 T-2 年份 |\n| 跨國定義差異 | 指標不完全可比 | 註記資料來源，謹慎解讀 |\n| 部分國家缺失 | 截面不完整 | 從截面統計中排除 |\n| 殖利率不可用 | 無法計算 r-g | 使用政策利率替代 |\n\n### 9.2 資料更新時程\n| 來源 | 更新頻率 | 延遲 |\n|------|----------|------|\n| World Bank WDI | 持續 | 1-2 年 |\n| IMF WEO | 每年 4 月、10 月 | 數月 |\n| UN WPP | 每 2 年 | - |\n| WHO GHED | 年度 | 1-2 年 |\n| OECD | 月度/季度/年度 | 數週至數月 |\n",
        "skills/demographic-fiscal-trap-analyzer/references/indicator-codes.md": "# 指標代碼對照表 (Indicator Codes Reference)\n\n## World Bank WDI 指標\n\n### 人口與撫養比\n| 代碼 | 名稱 | 單位 | 說明 |\n|------|------|------|------|\n| SP.POP.DPND.OL | Age dependency ratio, old | % | 65+人口 / 15-64人口 × 100 |\n| SP.POP.DPND.YG | Age dependency ratio, young | % | 0-14人口 / 15-64人口 × 100 |\n| SP.POP.DPND | Age dependency ratio | % | (0-14 + 65+) / 15-64 × 100 |\n| SP.POP.65UP.TO.ZS | Population ages 65+ | % of total | 老年人口佔比 |\n| SP.POP.1564.TO.ZS | Population ages 15-64 | % of total | 工作年齡人口佔比 |\n| SP.POP.0014.TO.ZS | Population ages 0-14 | % of total | 青年人口佔比 |\n| SP.POP.TOTL | Total population | 人 | 總人口 |\n\n### 政府財政\n| 代碼 | 名稱 | 單位 | 說明 |\n|------|------|------|------|\n| GC.DOD.TOTL.GD.ZS | Central government debt | % of GDP | 中央政府債務 |\n| GC.XPN.TOTL.GD.ZS | Expense | % of GDP | 政府支出 |\n| GC.REV.XGRT.GD.ZS | Revenue, excluding grants | % of GDP | 政府收入（不含捐贈）|\n| GC.NFN.TOTL.GD.ZS | Net lending (+) / borrowing (-) | % of GDP | 財政餘額 |\n| GC.TAX.TOTL.GD.ZS | Tax revenue | % of GDP | 稅收 |\n\n### 政府消費\n| 代碼 | 名稱 | 單位 | 說明 |\n|------|------|------|------|\n| NE.CON.GOVT.ZS | Government consumption expenditure | % of GDP | 政府最終消費支出 |\n| NE.CON.GOVT.KD.ZG | Government consumption growth | % annual | 政府消費成長率 |\n\n### 經濟成長\n| 代碼 | 名稱 | 單位 | 說明 |\n|------|------|------|------|\n| NY.GDP.MKTP.KD.ZG | GDP growth | % annual | 實質GDP成長率 |\n| NY.GDP.MKTP.CD | GDP | current US$ | 名義GDP（美元）|\n| NY.GDP.PCAP.KD.ZG | GDP per capita growth | % annual | 人均實質GDP成長率 |\n\n### 通膨\n| 代碼 | 名稱 | 單位 | 說明 |\n|------|------|------|------|\n| FP.CPI.TOTL.ZG | Inflation, consumer prices | % annual | CPI 通膨率 |\n| FP.CPI.TOTL | Consumer price index | 2010=100 | CPI 指數 |\n| NY.GDP.DEFL.KD.ZG | GDP deflator growth | % annual | GDP 平減指數成長率 |\n\n### 健康\n| 代碼 | 名稱 | 單位 | 說明 |\n|------|------|------|------|\n| SH.XPD.CHEX.GD.ZS | Current health expenditure | % of GDP | 當期健康支出 |\n| SH.XPD.GHED.GD.ZS | Domestic government health expenditure | % of GDP | 政府健康支出 |\n| SH.XPD.CHEX.PC.CD | Current health expenditure per capita | US$ | 人均健康支出 |\n\n### 利率\n| 代碼 | 名稱 | 單位 | 說明 |\n|------|------|------|------|\n| FR.INR.LEND | Lending interest rate | % | 貸款利率 |\n| FR.INR.DPST | Deposit interest rate | % | 存款利率 |\n| FR.INR.RINR | Real interest rate | % | 實質利率 |\n\n---\n\n## IMF World Economic Outlook 指標\n\n### 主要指標\n| 代碼 | 名稱 | 單位 | 說明 |\n|------|------|------|------|\n| NGDP_RPCH | Real GDP growth | % | 實質GDP成長率 |\n| NGDPD | GDP, current prices | USD billions | 名義GDP（美元）|\n| NGDP_D | GDP deflator | Index | GDP平減指數 |\n| PCPIPCH | Inflation, CPI | % | CPI 通膨率 |\n| PCPIEPCH | Inflation, end of period | % | 期末通膨率 |\n\n### 財政指標\n| 代碼 | 名稱 | 單位 | 說明 |\n|------|------|------|------|\n| GGXWDG_NGDP | General government gross debt | % of GDP | 一般政府總債務 |\n| GGXWDN_NGDP | General government net debt | % of GDP | 一般政府淨債務 |\n| GGXCNL_NGDP | General government net lending/borrowing | % of GDP | 財政餘額 |\n| GGR_NGDP | General government revenue | % of GDP | 政府收入 |\n| GGX_NGDP | General government total expenditure | % of GDP | 政府支出 |\n\n### 外部指標\n| 代碼 | 名稱 | 單位 | 說明 |\n|------|------|------|------|\n| BCA_NGDPD | Current account balance | % of GDP | 經常帳餘額 |\n| TM_RPCH | Import volume growth | % | 進口量成長 |\n| TX_RPCH | Export volume growth | % | 出口量成長 |\n\n---\n\n## OECD 指標\n\n### 利率\n| 代碼 | 名稱 | 單位 | 說明 |\n|------|------|------|------|\n| IRLT | Long-term interest rates | % | 10年公債殖利率 |\n| IRSTCI | Short-term interest rates | % | 短期利率 |\n| IR3TIB | 3-month interbank rate | % | 3個月銀行同業拆借利率 |\n\n### 財政\n| 代碼 | 名稱 | 單位 | 說明 |\n|------|------|------|------|\n| GGFL | General government financial liabilities | % of GDP | 政府金融負債 |\n| GGNFL | General government net financial liabilities | % of GDP | 政府淨金融負債 |\n\n### 勞動\n| 代碼 | 名稱 | 單位 | 說明 |\n|------|------|------|------|\n| GGWAG | Government wage bill | % of GDP | 政府薪資支出 |\n\n---\n\n## ISO 3166-1 Alpha-3 國家代碼（常用）\n\n### G7\n| 代碼 | 國家 |\n|------|------|\n| USA | 美國 |\n| JPN | 日本 |\n| DEU | 德國 |\n| GBR | 英國 |\n| FRA | 法國 |\n| ITA | 義大利 |\n| CAN | 加拿大 |\n\n### G20 其他成員\n| 代碼 | 國家 |\n|------|------|\n| CHN | 中國 |\n| IND | 印度 |\n| BRA | 巴西 |\n| RUS | 俄羅斯 |\n| AUS | 澳洲 |\n| KOR | 南韓 |\n| MEX | 墨西哥 |\n| IDN | 印尼 |\n| TUR | 土耳其 |\n| SAU | 沙烏地阿拉伯 |\n| ARG | 阿根廷 |\n| ZAF | 南非 |\n\n### 亞洲\n| 代碼 | 國家 |\n|------|------|\n| TWN | 台灣 |\n| SGP | 新加坡 |\n| HKG | 香港 |\n| THA | 泰國 |\n| MYS | 馬來西亞 |\n| PHL | 菲律賓 |\n| VNM | 越南 |\n\n### 歐洲\n| 代碼 | 國家 |\n|------|------|\n| ESP | 西班牙 |\n| NLD | 荷蘭 |\n| BEL | 比利時 |\n| AUT | 奧地利 |\n| CHE | 瑞士 |\n| SWE | 瑞典 |\n| NOR | 挪威 |\n| DNK | 丹麥 |\n| FIN | 芬蘭 |\n| PRT | 葡萄牙 |\n| GRC | 希臘 |\n| IRL | 愛爾蘭 |\n| POL | 波蘭 |\n| CZE | 捷克 |\n| HUN | 匈牙利 |\n\n### 區域/組織代碼\n| 代碼 | 組織/區域 |\n|------|----------|\n| WLD | 世界 |\n| EUU | 歐盟 |\n| EMU | 歐元區 |\n| OED | OECD |\n| EAS | 東亞與太平洋 |\n| ECS | 歐洲與中亞 |\n| LCN | 拉丁美洲與加勒比海 |\n| MEA | 中東與北非 |\n| SAS | 南亞 |\n| SSF | 撒哈拉以南非洲 |\n",
        "skills/demographic-fiscal-trap-analyzer/references/input-schema.md": "# 輸入參數結構 (Input Schema)\n\n## 主要參數\n\n### entities (必填)\n- **型別**: `list[string]`\n- **說明**: 要分析的國家/地區代碼列表\n- **格式**: ISO 3166-1 alpha-3 或預設群組名稱\n\n**單一國家範例**:\n```json\n[\"JPN\"]\n```\n\n**多國範例**:\n```json\n[\"JPN\", \"USA\", \"DEU\", \"GBR\", \"FRA\", \"ITA\", \"CAN\"]\n```\n\n**預設群組**:\n| 群組名稱 | 包含國家 |\n|----------|----------|\n| G7 | USA, JPN, DEU, GBR, FRA, ITA, CAN |\n| G20 | G7 + CHN, IND, BRA, RUS, AUS, KOR, MEX, IDN, TUR, SAU, ARG, ZAF, EU |\n| OECD | 38 個 OECD 成員國 |\n| EU27 | 27 個歐盟成員國 |\n| ASEAN | SGP, MYS, THA, IDN, PHL, VNM, MMR, KHM, LAO, BRN |\n| EM_ASIA | CHN, IND, KOR, TWN, THA, MYS, IDN, PHL, VNM |\n\n**使用群組**:\n```json\n[\"G7\"]  // 展開為 7 個國家\n```\n\n---\n\n### start_year (必填)\n- **型別**: `int`\n- **說明**: 歷史資料起始年份\n- **建議**: 2010 或更早，以獲得足夠的趨勢資料\n- **範圍**: 1960 - 當前年份\n\n**範例**:\n```json\n2010\n```\n\n---\n\n### end_year (必填)\n- **型別**: `int`\n- **說明**: 歷史資料結束年份（通常為最近可用年份）\n- **建議**: 2022 或 2023（視資料可用性）\n- **範圍**: start_year - 當前年份\n\n**範例**:\n```json\n2023\n```\n\n---\n\n### forecast_end_year (選填)\n- **型別**: `int`\n- **預設值**: `2050`\n- **說明**: 撫養比預測結束年份\n- **範圍**: end_year - 2100\n\n**範例**:\n```json\n2050\n```\n\n---\n\n### dependency_components (選填)\n- **型別**: `list[string]`\n- **預設值**: `[\"old_age\", \"youth\", \"total\"]`\n- **說明**: 要分析的撫養比組成\n\n**可選項**:\n| 組成 | 定義 |\n|------|------|\n| old_age | 老年撫養比 (65+ / 15-64) |\n| youth | 青年撫養比 (0-14 / 15-64) |\n| total | 總撫養比 ((0-14 + 65+) / 15-64) |\n\n**範例**:\n```json\n[\"old_age\"]  // 僅分析老年撫養比\n```\n\n---\n\n### fiscal_modules (選填)\n- **型別**: `list[string]`\n- **預設值**: `[\"debt\", \"spending\", \"health\"]`\n- **說明**: 要啟用的財政分析模組\n\n**可選項**:\n| 模組 | 說明 |\n|------|------|\n| debt | 政府債務/GDP 分析 |\n| spending | 政府支出/GDP 分析 |\n| health | 健康支出/GDP 分析 |\n| pension | 養老金支出分析（若資料可用）|\n| revenue | 政府收入分析 |\n| primary_balance | 基本財政餘額分析 |\n\n**範例**:\n```json\n[\"debt\", \"spending\", \"health\", \"primary_balance\"]\n```\n\n---\n\n### bureaucracy_proxies (選填)\n- **型別**: `list[string]`\n- **預設值**: `[\"gov_wage_bill\", \"public_employment_share\", \"gov_consumption\"]`\n- **說明**: 官僚膨脹代理指標\n\n**可選項**:\n| 指標 | 說明 | 資料可用性 |\n|------|------|-----------|\n| gov_wage_bill | 公部門薪資/GDP | 中等 |\n| public_employment_share | 公務員/總就業人口 | 低 |\n| gov_consumption | 政府消費/GDP | 高 |\n| consulting_proxy | 政府諮詢支出代理 | 低 |\n\n**範例**:\n```json\n[\"gov_consumption\"]  // 僅使用高可用性指標\n```\n\n---\n\n### inflation_channel (選填)\n- **型別**: `string`\n- **預設值**: `\"real_rates\"`\n- **說明**: 通膨/稀釋路徑分析方式\n\n**可選項**:\n| 選項 | 說明 |\n|------|------|\n| expected_inflation | 使用通膨預期（需調查資料）|\n| real_rates | 使用事後實質利率 |\n| money_growth | 使用貨幣供給成長率 |\n| financial_repression | 綜合金融抑制指數 |\n\n**範例**:\n```json\n\"real_rates\"\n```\n\n---\n\n### weights (選填)\n- **型別**: `dict[string, float]`\n- **預設值**:\n```json\n{\n  \"aging\": 0.35,\n  \"debt\": 0.35,\n  \"bloat\": 0.15,\n  \"growth_drag\": 0.15\n}\n```\n- **說明**: 四支柱的權重配置\n- **限制**: 所有權重加總應為 1.0\n\n**自訂範例**:\n```json\n{\n  \"aging\": 0.40,\n  \"debt\": 0.30,\n  \"bloat\": 0.15,\n  \"growth_drag\": 0.15\n}\n```\n\n---\n\n## 完整輸入範例\n\n### 範例 1: 單一國家完整分析\n```json\n{\n  \"entities\": [\"JPN\"],\n  \"start_year\": 2010,\n  \"end_year\": 2023,\n  \"forecast_end_year\": 2050,\n  \"dependency_components\": [\"old_age\", \"youth\", \"total\"],\n  \"fiscal_modules\": [\"debt\", \"spending\", \"health\"],\n  \"bureaucracy_proxies\": [\"gov_consumption\"],\n  \"inflation_channel\": \"real_rates\",\n  \"weights\": {\n    \"aging\": 0.35,\n    \"debt\": 0.35,\n    \"bloat\": 0.15,\n    \"growth_drag\": 0.15\n  }\n}\n```\n\n### 範例 2: G7 跨國比較（簡化）\n```json\n{\n  \"entities\": [\"G7\"],\n  \"start_year\": 2015,\n  \"end_year\": 2023\n}\n```\n\n### 範例 3: 亞洲新興市場自訂權重\n```json\n{\n  \"entities\": [\"CHN\", \"IND\", \"IDN\", \"THA\", \"VNM\"],\n  \"start_year\": 2010,\n  \"end_year\": 2023,\n  \"forecast_end_year\": 2050,\n  \"weights\": {\n    \"aging\": 0.40,\n    \"debt\": 0.25,\n    \"bloat\": 0.20,\n    \"growth_drag\": 0.15\n  }\n}\n```\n\n---\n\n## 參數驗證規則\n\n```python\ndef validate_input(params):\n    errors = []\n\n    # 必填檢查\n    if \"entities\" not in params or not params[\"entities\"]:\n        errors.append(\"entities is required and cannot be empty\")\n\n    if \"start_year\" not in params:\n        errors.append(\"start_year is required\")\n\n    if \"end_year\" not in params:\n        errors.append(\"end_year is required\")\n\n    # 範圍檢查\n    if params.get(\"start_year\", 0) > params.get(\"end_year\", 9999):\n        errors.append(\"start_year must be <= end_year\")\n\n    if params.get(\"forecast_end_year\", 2050) < params.get(\"end_year\", 0):\n        errors.append(\"forecast_end_year must be >= end_year\")\n\n    # 權重加總檢查\n    weights = params.get(\"weights\", {})\n    if weights:\n        total = sum(weights.values())\n        if abs(total - 1.0) > 0.01:\n            errors.append(f\"weights must sum to 1.0, got {total}\")\n\n    return errors\n```\n",
        "skills/demographic-fiscal-trap-analyzer/references/methodology.md": "### 1. 財政陷阱理論\n「人口-財政陷阱」建立在以下經濟學原理之上：\n\n#### 1.1 債務動態方程式\n標準政府債務動態：\n\n```\nd(t) = d(t-1) × (1 + r) / (1 + g) + pb(t)\n```\n\n簡化為：\n```\nΔd ≈ (r - g) × d + pb\n```\n\n其中：\n- d = 債務/GDP 比率\n- r = 名義利率（債務成本）\n- g = 名義 GDP 成長率\n- pb = 基本財政餘額/GDP（= 支出 - 收入 - 利息）\n\n**核心洞察**：當 r > g 且 pb ≥ 0 時，債務比率將自動膨脹，形成「雪球效應」。\n\n#### 1.2 老化的財政影響\n人口老化透過兩個管道影響財政：\n\n**支出端**：\n- 養老金支出：與老年人口規模正相關\n- 健康支出：老年人均醫療支出為年輕人的 3-5 倍\n- 長照支出：隨 80+ 人口增加而急升\n\n**收入端**：\n- 勞動人口縮減 → 所得稅基萎縮\n- 消費結構改變 → 消費稅稅基變化\n- 企業投資下降 → 企業稅收減少\n\n#### 1.3 金融抑制理論\nReinhart & Sbrancia (2015) 定義金融抑制為：\n> 政府透過人為壓低利率、強制銀行持有國債、資本管制等手段，將債務成本轉嫁給儲蓄者。\n\n當財政改革政治成本過高，金融抑制成為「最小阻力路徑」：\n- 負實質利率侵蝕債務實質價值\n- 對儲蓄者的隱性課稅\n- 避免名義違約的政治代價\n\n---\n\n## 分析框架\n\n### 2. 四支柱評分系統\n\n本技能採用四維度評分架構，各支柱設計如下：\n\n#### 2.1 老化壓力 (Aging Pressure)\n\n**定義**：衡量人口老化對財政的壓力程度\n\n**計算公式**：\n```python\naging_level = old_age_dependency_ratio[end_year]  # 65+/15-64\naging_slope = linear_regression_slope(old_age_dependency[end_year-10:end_year])\n\naging_pressure = 0.5 × zscore(aging_level) + 0.5 × zscore(aging_slope)\n```\n\n**權重配置邏輯**：\n- 水準 (50%)：當前老化程度決定即期財政壓力\n- 斜率 (50%)：趨勢決定未來壓力演化速度\n\n**資料來源**：\n- 首選：World Bank WDI (SP.POP.DPND.OL)\n- 次選：UN World Population Prospects\n\n#### 2.2 債務動態 (Debt Dynamics)\n\n**定義**：衡量政府債務的可持續性與演化趨勢\n\n**計算公式**：\n```python\ndebt_level = debt_to_gdp[end_year]\ndebt_slope = linear_regression_slope(debt_to_gdp[end_year-5:end_year])\nr_minus_g = nominal_yield_10y[end_year] - nominal_gdp_growth[end_year]\n\ndebt_dynamics = (\n    0.50 × zscore(debt_level) +\n    0.30 × zscore(debt_slope) +\n    0.20 × zscore(r_minus_g)\n)\n```\n\n**權重配置邏輯**：\n- 水準 (50%)：高債務水準本身即為風險\n- 斜率 (30%)：上升趨勢顯示問題惡化中\n- r-g (20%)：決定債務自動演化方向\n\n**資料來源**：\n- 債務：IMF WEO (GGXWDG_NGDP) 或 World Bank (GC.DOD.TOTL.GD.ZS)\n- 利率：OECD (IRLT) 或各國央行\n- 成長：World Bank (NY.GDP.MKTP.KD.ZG) + CPI 推算名義成長\n\n#### 2.3 官僚膨脹 (Bloat Index)\n\n**定義**：衡量政府支出的規模與效率\n\n**計算公式**：\n```python\ngov_consumption = government_consumption_to_gdp[end_year]\ngov_expenditure = government_expenditure_to_gdp[end_year]\n\nbloat_index = 0.6 × zscore(gov_consumption) + 0.4 × zscore(gov_expenditure)\n```\n\n**權重配置邏輯**：\n- 政府消費 (60%)：直接反映官僚體系規模\n- 總支出 (40%)：包含移轉性支出的整體規模\n\n**延伸指標**（若資料可用）：\n- 公部門薪資佔 GDP 比例\n- 公務員人數佔就業人口比例\n- 政府採購效率指數\n\n**資料來源**：\n- World Bank WDI (NE.CON.GOVT.ZS, GC.XPN.TOTL.GD.ZS)\n- IMF Government Finance Statistics\n\n#### 2.4 成長拖累 (Growth Drag)\n\n**定義**：低成長對財政可持續性的負面影響\n\n**計算公式**：\n```python\nnominal_growth = nominal_gdp_growth[end_year]\ngrowth_drag = zscore(-nominal_growth)  # 負向：低成長 = 高拖累\n```\n\n**邏輯**：\n- 低成長 → r-g 缺口擴大 → 債務自動膨脹\n- 低成長 → 稅基萎縮 → 財政收入下降\n- 低成長 → 政治壓力 → 更難削減支出\n\n---\n\n### 3. Z-Score 標準化\n\n#### 3.1 標準化公式\n```python\nzscore(x) = (x - μ) / σ\n```\n\n其中 μ 和 σ 為**跨國截面**統計量（非時間序列）。\n\n#### 3.2 截面選擇\n根據分析目的選擇截面群組：\n- 全球比較：使用全部可用國家\n- OECD 比較：僅使用 OECD 成員國\n- 區域比較：使用特定區域國家\n\n#### 3.3 解讀標準\n| Z-Score    | 解讀         | 風險等級 |\n|------------|--------------|----------|\n| > 2.0      | 極端高於平均 | 紅燈     |\n| 1.5 - 2.0  | 顯著高於平均 | 橙燈     |\n| 0.5 - 1.5  | 略高於平均   | 黃燈     |\n| -0.5 - 0.5 | 接近平均     | 綠燈     |\n| < -0.5     | 低於平均     | 優良     |\n\n---\n\n### 4. 象限分類\n\n#### 4.1 雙軸定義\n- **X 軸**：Aging Pressure (z-score)\n- **Y 軸**：Debt Dynamics (z-score)\n- **閾值**：z = 1.0 作為高/低分界\n\n#### 4.2 四象限意涵\n\n| 象限 | 老化 | 債務 | 特徵                   | 典型國家      |\n|------|------|------|------------------------|---------------|\n| Q1   | 高   | 高   | 雙重壓力，政策空間極窄 | JPN, ITA, GRC |\n| Q2   | 高   | 低   | 老化主導，債務尚有空間 | DEU, KOR      |\n| Q3   | 低   | 高   | 債務主導，人口紅利尚存 | USA, BRA      |\n| Q4   | 低   | 低   | 相對健康，政策空間寬廣 | IND, IDN      |\n\n---\n\n### 5. 通膨激勵指數\n\n#### 5.1 理論基礎\n當以下條件成立，政府有強烈動機選擇「通膨稀釋」路徑：\n1. 債務水準高 → 稀釋效益大\n2. r > g → 難以透過成長去槓桿\n3. 支出剛性高 → 難以削減開支\n4. 已有負實質利率歷史 → 路徑依賴\n\n#### 5.2 計算公式\n```python\ninflation_incentive = (\n    0.40 × zscore(debt_level) +\n    0.20 × zscore(r_minus_g) +\n    0.20 × zscore(neg_real_rate_share_5y) +\n    0.20 × zscore(bloat_index)\n)\n```\n\n#### 5.3 解讀\n| 分數      | 政策傾向     | 投資意涵           |\n|-----------|--------------|--------------------|\n| < 0.5     | 正統財政     | 名義債券相對安全   |\n| 0.5 - 1.5 | 溫和金融抑制 | 實質報酬承壓       |\n| > 1.5     | 強烈稀釋動機 | 應持有通膨保值資產 |\n\n---\n\n## 參考文獻\n\n1. Reinhart, C. M., & Sbrancia, M. B. (2015). \"The Liquidation of Government Debt.\" *Economic Policy*, 30(82), 291-333.\n\n2. Blanchard, O. (2019). \"Public Debt and Low Interest Rates.\" *American Economic Review*, 109(4), 1197-1229.\n\n3. IMF (2023). *Fiscal Monitor: Climate Crossroads*. International Monetary Fund.\n\n4. OECD (2021). *Pensions at a Glance 2021*. OECD Publishing.\n\n5. UN DESA (2022). *World Population Prospects 2022*. United Nations.\n",
        "skills/demographic-fiscal-trap-analyzer/scripts/README.md": "# Demographic-Fiscal Trap Analyzer - Visualization Scripts\n\n人口財政陷阱分析器 - 可視化腳本\n\n---\n\n## 📊 可用腳本\n\n### visualize_combined.py\n綜合可視化圖表生成器，整合所有關鍵分析指標於單一高清圖表中。\n\n**功能：**\n- 生成 20×14 英吋高清圖表（300 DPI）\n- 支持中英文雙語\n- 包含 10 個關鍵信息視圖\n- 自動生成 PNG 和 PDF 兩種格式\n- 跨平台中文字體支持\n\n---\n\n## 🚀 使用方法\n\n### 基本用法\n\n```bash\n# 生成中文版本\npython visualize_combined.py --language zh\n\n# 生成英文版本\npython visualize_combined.py --language en\n\n# 指定數據文件和輸出目錄\npython visualize_combined.py \\\n    --data path/to/data.json \\\n    --output path/to/output \\\n    --language zh\n```\n\n### 參數說明\n\n| 參數 | 類型 | 預設值 | 說明 |\n|------|------|--------|------|\n| `--data` | string | `output/japan_demographic_fiscal_trap_2010-2023_structured.json` | 結構化數據文件路徑 |\n| `--output` | string | `output` | 輸出目錄 |\n| `--language` | string | `zh` | 語言選擇：`zh`（中文）或 `en`（英文）|\n\n---\n\n## 📈 生成內容\n\n### 10 個關鍵視圖\n\n1. **綜合風險評分** - Fiscal Trap Score & Inflation Incentive Score\n2. **四支柱評分** - Aging, Debt, Bloat, Growth\n3. **老年撫養比時序** - 2010-2023 歷史數據\n4. **政府債務/GDP** - 2010-2023 歷史數據\n5. **實質利率分析** - 2019-2023 金融抑制\n6. **名義GDP成長** - 2010-2023 經濟表現\n7. **撫養比投影** - 2024-2050 長期預測\n8. **債務投影** - 2024-2050 債務軌跡\n9. **利息支出投影** - 財政壓力預測\n10. **資產配置建議** - 投資組合優化\n\n---\n\n## 🎨 中文字體支持\n\n腳本使用以下字體備用鏈（按優先順序）：\n\n1. **Microsoft JhengHei** - 微軟正黑體（Windows 繁體中文）\n2. **SimHei** - 黑體（Windows 簡體中文）\n3. **STHeiti** - 華文黑體（macOS）\n4. **WenQuanYi Zen Hei** - 文泉驛正黑（Linux）\n5. **DejaVu Sans** - 備用英文字體\n\n### 字體安裝建議\n\n**Windows:**\n- 預裝了 Microsoft JhengHei 和 SimHei，無需額外安裝\n\n**macOS:**\n- 預裝了 STHeiti，無需額外安裝\n- 可選安裝 Microsoft JhengHei 以獲得更好的繁體中文支持\n\n**Linux:**\n```bash\n# Ubuntu/Debian\nsudo apt-get install fonts-wqy-zenhei\n\n# Fedora/RHEL\nsudo dnf install wqy-zenhei-fonts\n\n# Arch Linux\nsudo pacman -S wqy-zenhei\n```\n\n---\n\n## 📦 依賴套件\n\n```bash\npip install matplotlib numpy\n```\n\n或使用 requirements.txt：\n```bash\npip install -r requirements.txt\n```\n\n---\n\n## 🖼️ 輸出範例\n\n### 檔案命名格式\n\n```\nJapan_Demographic_Fiscal_Trap_Combined_{LANGUAGE}_{DATE}.{EXT}\n```\n\n例如：\n- `Japan_Demographic_Fiscal_Trap_Combined_ZH_20260119.png` (中文版 PNG)\n- `Japan_Demographic_Fiscal_Trap_Combined_ZH_20260119.pdf` (中文版 PDF)\n- `Japan_Demographic_Fiscal_Trap_Combined_EN_20260119.png` (英文版 PNG)\n- `Japan_Demographic_Fiscal_Trap_Combined_EN_20260119.pdf` (英文版 PDF)\n\n### 規格\n\n- **尺寸**: 20 × 14 英吋\n- **解析度**: 300 DPI\n- **格式**: PNG (高清) + PDF (列印優化)\n- **檔案大小**: 約 700-800 KB (PNG), 60-100 KB (PDF)\n\n---\n\n## ⚡ 快速開始\n\n### 從專案根目錄執行\n\n```bash\n# 切換到專案根目錄\ncd /path/to/macro-skills\n\n# 生成中英文雙語圖表\npython .claude/skills/demographic-fiscal-trap-analyzer/scripts/visualize_combined.py --language zh\npython .claude/skills/demographic-fiscal-trap-analyzer/scripts/visualize_combined.py --language en\n```\n\n### 從 scripts 目錄執行\n\n```bash\ncd .claude/skills/demographic-fiscal-trap-analyzer/scripts\n\n# 需要指定相對於專案根目錄的路徑\npython visualize_combined.py \\\n    --data ../../../output/japan_demographic_fiscal_trap_2010-2023_structured.json \\\n    --output ../../../output \\\n    --language zh\n```\n\n---\n\n## 🔧 故障排除\n\n### 問題：中文顯示為方塊\n\n**解決方案：**\n1. 確認已安裝中文字體（見上方「字體安裝建議」）\n2. 嘗試使用英文版本（`--language en`）\n3. 清除 matplotlib 字體緩存：\n```bash\nrm -rf ~/.cache/matplotlib\n```\n\n### 問題：找不到數據文件\n\n**解決方案：**\n確保數據文件存在且路徑正確：\n```bash\nls -l output/japan_demographic_fiscal_trap_2010-2023_structured.json\n```\n\n### 問題：權限錯誤\n\n**解決方案：**\n```bash\nchmod +x .claude/skills/demographic-fiscal-trap-analyzer/scripts/visualize_combined.py\n```\n\n---\n\n## 📊 與其他腳本的集成\n\n### 完整分析流程\n\n```bash\n# 步驟 1: 執行分析（生成數據）\n# （由主 skill 執行）\n\n# 步驟 2: 生成可視化圖表\npython .claude/skills/demographic-fiscal-trap-analyzer/scripts/visualize_combined.py --language zh\npython .claude/skills/demographic-fiscal-trap-analyzer/scripts/visualize_combined.py --language en\n\n# 步驟 3: 查看結果\nls -lh output/Japan_Demographic_Fiscal_Trap_Combined_*\n```\n\n---\n\n## 📖 技術細節\n\n### 圖表布局\n\n使用 matplotlib GridSpec 創建 4×4 網格：\n```\n┌─────────────────────────────────────────┐\n│  Row 1: 風險評分卡 | 四支柱評分          │\n├─────────────────────────────────────────┤\n│  Row 2: 撫養比時序 | 債務時序            │\n├─────────────────────────────────────────┤\n│  Row 3: 實質利率   | 名義成長            │\n├─────────────────────────────────────────┤\n│  Row 4: 撫養比投影 | 債務投影 | 利息 | 配置 │\n└─────────────────────────────────────────┘\n```\n\n### 顏色編碼\n\n- **紅色** (#d62728): 高風險/危險\n- **橙色** (#ff7f0e): 中度風險/警告\n- **綠色** (#2ca02c): 低風險/正常\n- **藍色** (#1f77b4): 資訊性數據\n\n---\n\n## 📝 許可證\n\n本腳本為 demographic-fiscal-trap-analyzer skill 的一部分。\n\n---\n\n## 🤝 貢獻\n\n如需改進或新增功能，請參考專案主 README。\n\n---\n\n**最後更新**: 2026-01-19\n**版本**: 1.0.0\n**維護者**: macro-skills-team\n",
        "skills/demographic-fiscal-trap-analyzer/templates/output-json.md": "# JSON 輸出模板 (JSON Output Template)\n\n## 單一實體完整分析輸出\n\n```json\n{\n  \"metadata\": {\n    \"skill\": \"demographic-fiscal-trap-analyzer\",\n    \"version\": \"0.1.0\",\n    \"generated_at\": \"2024-01-15T10:30:00Z\",\n    \"workflow\": \"full-analysis\"\n  },\n  \"parameters\": {\n    \"entities\": [\"JPN\"],\n    \"start_year\": 2010,\n    \"end_year\": 2023,\n    \"forecast_end_year\": 2050,\n    \"weights\": {\n      \"aging\": 0.35,\n      \"debt\": 0.35,\n      \"bloat\": 0.15,\n      \"growth_drag\": 0.15\n    }\n  },\n  \"results\": {\n    \"entity\": \"JPN\",\n    \"entity_name\": \"Japan\",\n    \"scores\": {\n      \"fiscal_trap_score\": 2.35,\n      \"inflation_incentive_score\": 1.95,\n      \"aging_pressure\": 2.80,\n      \"debt_dynamics\": 2.50,\n      \"bloat_index\": 0.85,\n      \"growth_drag\": 1.20\n    },\n    \"risk_level\": \"CRITICAL\",\n    \"quadrant\": {\n      \"code\": \"Q1\",\n      \"name\": \"HighAging_HighDebt\",\n      \"description\": \"雙高危機：老化壓力與債務動態均處於高風險區\"\n    },\n    \"key_metrics\": {\n      \"demographics\": {\n        \"old_age_dependency_ratio\": {\n          \"value\": 0.485,\n          \"year\": 2023,\n          \"unit\": \"ratio\",\n          \"zscore\": 2.8,\n          \"interpretation\": \"65歲以上人口為工作年齡人口的48.5%\"\n        },\n        \"old_age_dependency_slope_10y\": {\n          \"value\": 0.018,\n          \"unit\": \"per_year\",\n          \"zscore\": 1.5,\n          \"interpretation\": \"每年增加1.8個百分點\"\n        },\n        \"old_age_dependency_forecast_2050\": {\n          \"value\": 0.78,\n          \"source\": \"UN WPP Medium Variant\"\n        }\n      },\n      \"debt\": {\n        \"debt_to_gdp\": {\n          \"value\": 262.5,\n          \"year\": 2023,\n          \"unit\": \"percent\",\n          \"zscore\": 2.9,\n          \"interpretation\": \"政府債務為GDP的262.5%\"\n        },\n        \"debt_to_gdp_slope_5y\": {\n          \"value\": 2.3,\n          \"unit\": \"pct_per_year\",\n          \"zscore\": 1.2,\n          \"interpretation\": \"每年增加約2.3個百分點\"\n        },\n        \"r_minus_g\": {\n          \"nominal_yield_10y\": 0.8,\n          \"nominal_gdp_growth\": 2.1,\n          \"r_minus_g\": -1.3,\n          \"zscore\": -0.5,\n          \"interpretation\": \"名義利率低於名義成長，債務有自動穩定效果\"\n        }\n      },\n      \"expenditure\": {\n        \"gov_consumption_to_gdp\": {\n          \"value\": 20.5,\n          \"year\": 2023,\n          \"unit\": \"percent\",\n          \"zscore\": 0.9\n        },\n        \"gov_expenditure_to_gdp\": {\n          \"value\": 44.5,\n          \"year\": 2023,\n          \"unit\": \"percent\",\n          \"zscore\": 1.2\n        }\n      },\n      \"growth\": {\n        \"nominal_gdp_growth\": {\n          \"value\": 2.1,\n          \"year\": 2023,\n          \"unit\": \"percent\",\n          \"zscore\": -0.8\n        },\n        \"real_gdp_growth\": {\n          \"value\": 1.2,\n          \"year\": 2023,\n          \"unit\": \"percent\"\n        }\n      },\n      \"inflation_path\": {\n        \"real_rate_current\": {\n          \"value\": -1.2,\n          \"year\": 2023,\n          \"unit\": \"percent\"\n        },\n        \"negative_real_rate_share_5y\": {\n          \"value\": 0.80,\n          \"interpretation\": \"過去5年有80%時間處於負實質利率\"\n        },\n        \"financial_repression_index\": {\n          \"value\": 1.45,\n          \"interpretation\": \"顯示金融抑制特徵明顯\"\n        }\n      }\n    },\n    \"time_series\": {\n      \"old_age_dependency\": {\n        \"2010\": 0.355,\n        \"2015\": 0.425,\n        \"2020\": 0.480,\n        \"2023\": 0.485\n      },\n      \"debt_to_gdp\": {\n        \"2010\": 215.8,\n        \"2015\": 231.3,\n        \"2020\": 259.4,\n        \"2023\": 262.5\n      }\n    },\n    \"projection\": {\n      \"old_age_dependency\": {\n        \"2030\": 0.55,\n        \"2040\": 0.68,\n        \"2050\": 0.78\n      },\n      \"fiscal_pressure_increase_pct_gdp\": 12.5\n    }\n  },\n  \"interpretation\": {\n    \"summary\": \"日本呈現典型的人口-財政陷阱特徵：超高老化撫養比、超高政府債務、長期負實質利率。儘管r-g為負暫時穩定債務比率，但老化壓力持續攀升將推高養老金與健康支出，財政空間極度緊縮。\",\n    \"key_findings\": [\n      \"老年撫養比全球最高，且仍在加速上升\",\n      \"政府債務佔GDP超過260%，為已開發國家中最高\",\n      \"負實質利率持續8年以上，顯示金融抑制政策已制度化\",\n      \"預計2050年老年撫養比將達78%，老年相關支出將再增GDP的12%以上\"\n    ],\n    \"policy_implications\": [\n      \"財政改革空間極窄，削減福利政治代價高\",\n      \"持續依賴央行購債維持低利率環境\",\n      \"通膨稀釋是緩解實質債務負擔的主要出口\",\n      \"需關注日圓長期購買力風險\"\n    ],\n    \"asset_allocation_implications\": {\n      \"japanese_government_bonds\": \"UNDERWEIGHT - 實質報酬長期為負\",\n      \"inflation_linked_bonds\": \"OVERWEIGHT - 若可用，提供通膨保護\",\n      \"japanese_equities\": \"NEUTRAL - 名義資產受益於通膨，但經濟成長有限\",\n      \"japanese_yen\": \"CAUTION - 長期購買力可能持續流失\",\n      \"real_assets_japan\": \"OVERWEIGHT - 不動產、基礎設施等實質資產\"\n    }\n  },\n  \"data_notes\": {\n    \"sources\": {\n      \"dependency_ratio\": \"World Bank WDI (SP.POP.DPND.OL)\",\n      \"debt_to_gdp\": \"IMF WEO (GGXWDG_NGDP)\",\n      \"gov_consumption\": \"World Bank WDI (NE.CON.GOVT.ZS)\",\n      \"yield_10y\": \"OECD (IRLT)\",\n      \"gdp_growth\": \"World Bank WDI (NY.GDP.MKTP.KD.ZG)\",\n      \"cpi\": \"World Bank WDI (FP.CPI.TOTL.ZG)\",\n      \"projection\": \"UN World Population Prospects 2024\"\n    },\n    \"missing_data\": [],\n    \"fallbacks_used\": [],\n    \"cross_section_stats\": {\n      \"entities_in_sample\": 38,\n      \"reference_group\": \"OECD\"\n    }\n  }\n}\n```\n\n---\n\n## 多國比較輸出\n\n```json\n{\n  \"metadata\": {\n    \"skill\": \"demographic-fiscal-trap-analyzer\",\n    \"version\": \"0.1.0\",\n    \"generated_at\": \"2024-01-15T10:30:00Z\",\n    \"workflow\": \"cross-country\"\n  },\n  \"parameters\": {\n    \"entities\": [\"G7\"],\n    \"start_year\": 2015,\n    \"end_year\": 2023\n  },\n  \"results\": {\n    \"comparison_group\": \"G7\",\n    \"entities_analyzed\": [\"USA\", \"JPN\", \"DEU\", \"GBR\", \"FRA\", \"ITA\", \"CAN\"],\n    \"ranking\": [\n      {\n        \"rank\": 1,\n        \"entity\": \"JPN\",\n        \"entity_name\": \"Japan\",\n        \"fiscal_trap_score\": 2.35,\n        \"inflation_incentive_score\": 1.95,\n        \"quadrant\": \"Q1\",\n        \"risk_level\": \"CRITICAL\"\n      },\n      {\n        \"rank\": 2,\n        \"entity\": \"ITA\",\n        \"entity_name\": \"Italy\",\n        \"fiscal_trap_score\": 1.82,\n        \"inflation_incentive_score\": 1.45,\n        \"quadrant\": \"Q1\",\n        \"risk_level\": \"HIGH\"\n      },\n      {\n        \"rank\": 3,\n        \"entity\": \"FRA\",\n        \"entity_name\": \"France\",\n        \"fiscal_trap_score\": 1.15,\n        \"inflation_incentive_score\": 0.95,\n        \"quadrant\": \"Q2\",\n        \"risk_level\": \"ELEVATED\"\n      },\n      {\n        \"rank\": 4,\n        \"entity\": \"GBR\",\n        \"entity_name\": \"United Kingdom\",\n        \"fiscal_trap_score\": 0.85,\n        \"inflation_incentive_score\": 0.72,\n        \"quadrant\": \"Q3\",\n        \"risk_level\": \"MODERATE\"\n      },\n      {\n        \"rank\": 5,\n        \"entity\": \"USA\",\n        \"entity_name\": \"United States\",\n        \"fiscal_trap_score\": 0.72,\n        \"inflation_incentive_score\": 0.88,\n        \"quadrant\": \"Q3\",\n        \"risk_level\": \"MODERATE\"\n      },\n      {\n        \"rank\": 6,\n        \"entity\": \"DEU\",\n        \"entity_name\": \"Germany\",\n        \"fiscal_trap_score\": 0.45,\n        \"inflation_incentive_score\": 0.35,\n        \"quadrant\": \"Q2\",\n        \"risk_level\": \"LOW\"\n      },\n      {\n        \"rank\": 7,\n        \"entity\": \"CAN\",\n        \"entity_name\": \"Canada\",\n        \"fiscal_trap_score\": 0.12,\n        \"inflation_incentive_score\": 0.25,\n        \"quadrant\": \"Q4\",\n        \"risk_level\": \"LOW\"\n      }\n    ],\n    \"risk_groups\": {\n      \"critical\": [\"JPN\"],\n      \"high\": [\"ITA\"],\n      \"elevated\": [\"FRA\"],\n      \"moderate\": [\"GBR\", \"USA\"],\n      \"low\": [\"DEU\", \"CAN\"]\n    },\n    \"quadrant_distribution\": {\n      \"Q1_HighAging_HighDebt\": [\"JPN\", \"ITA\"],\n      \"Q2_HighAging_LowDebt\": [\"DEU\", \"FRA\"],\n      \"Q3_LowAging_HighDebt\": [\"USA\", \"GBR\"],\n      \"Q4_LowAging_LowDebt\": [\"CAN\"]\n    },\n    \"pillar_comparison\": {\n      \"aging_pressure\": {\n        \"JPN\": 2.80,\n        \"ITA\": 1.95,\n        \"DEU\": 1.45,\n        \"FRA\": 1.20,\n        \"GBR\": 0.65,\n        \"USA\": 0.45,\n        \"CAN\": 0.30\n      },\n      \"debt_dynamics\": {\n        \"JPN\": 2.50,\n        \"ITA\": 1.75,\n        \"USA\": 1.15,\n        \"GBR\": 1.05,\n        \"FRA\": 0.95,\n        \"CAN\": 0.25,\n        \"DEU\": 0.15\n      },\n      \"bloat_index\": {\n        \"FRA\": 1.35,\n        \"ITA\": 1.10,\n        \"JPN\": 0.85,\n        \"DEU\": 0.75,\n        \"GBR\": 0.55,\n        \"USA\": 0.40,\n        \"CAN\": 0.30\n      },\n      \"growth_drag\": {\n        \"JPN\": 1.20,\n        \"ITA\": 1.55,\n        \"DEU\": 0.85,\n        \"FRA\": 0.65,\n        \"GBR\": 0.50,\n        \"USA\": -0.25,\n        \"CAN\": -0.45\n      }\n    },\n    \"cross_section_stats\": {\n      \"fiscal_trap_score\": {\n        \"mean\": 1.07,\n        \"std\": 0.78,\n        \"min\": 0.12,\n        \"max\": 2.35\n      }\n    }\n  },\n  \"interpretation\": {\n    \"summary\": \"G7國家中，日本與義大利位於最高風險區（Q1象限），兩國均面臨高老化與高債務的雙重壓力。加拿大是唯一位於Q4健康象限的國家，政策空間最為寬廣。\",\n    \"key_findings\": [\n      \"日本與義大利需關注財政陷阱風險與通膨稀釋動機\",\n      \"德國雖老化嚴重但財政紀律良好，債務水準可控\",\n      \"美國與英國債務較高但人口結構相對年輕\",\n      \"法國官僚膨脹指標為G7最高\"\n    ]\n  }\n}\n```\n\n---\n\n## 錯誤/警告輸出\n\n```json\n{\n  \"metadata\": {\n    \"skill\": \"demographic-fiscal-trap-analyzer\",\n    \"version\": \"0.1.0\",\n    \"generated_at\": \"2024-01-15T10:30:00Z\",\n    \"workflow\": \"full-analysis\"\n  },\n  \"parameters\": {\n    \"entities\": [\"XYZ\"],\n    \"start_year\": 2010,\n    \"end_year\": 2023\n  },\n  \"status\": \"partial_failure\",\n  \"errors\": [\n    {\n      \"code\": \"ENTITY_NOT_FOUND\",\n      \"message\": \"Entity 'XYZ' is not a valid ISO 3166-1 alpha-3 code\",\n      \"severity\": \"error\"\n    }\n  ],\n  \"warnings\": [\n    {\n      \"code\": \"DATA_MISSING\",\n      \"entity\": \"ABC\",\n      \"indicator\": \"IRLT\",\n      \"message\": \"10-year yield not available, using policy rate as fallback\",\n      \"severity\": \"warning\"\n    }\n  ],\n  \"results\": null\n}\n```\n",
        "skills/demographic-fiscal-trap-analyzer/templates/output-markdown.md": "# Markdown 輸出模板 (Markdown Output Template)\n\n## 單一實體完整分析報告\n\n```markdown\n# 人口-財政陷阱分析報告：日本 (JPN)\n\n> 分析期間：2010-2023 | 預測至：2050\n> 生成時間：2024-01-15 10:30 UTC\n\n---\n\n## 執行摘要\n\n| 指標 | 數值 | 風險等級 |\n|------|------|----------|\n| **財政陷阱分數** | 2.35 | 🔴 極高風險 |\n| **通膨激勵指數** | 1.95 | 🔴 強烈稀釋動機 |\n| **象限分類** | Q1 | 雙高危機 |\n\n**核心結論**：日本呈現典型的人口-財政陷阱特徵，老化壓力與債務水準均處於全球極端值。長期負實質利率顯示金融抑制已制度化，投資者應預期此環境將持續。\n\n---\n\n## 四支柱分析\n\n### 1. 老化壓力 (Aging Pressure)\n**Z-Score: 2.80** 🔴\n\n| 指標 | 數值 | 說明 |\n|------|------|------|\n| 老年撫養比 (2023) | 48.5% | 65+人口 / 15-64人口 |\n| 10年斜率 | +1.8%/年 | 每年增加1.8個百分點 |\n| 2050年預測 | 78% | UN WPP中位數預測 |\n\n**解讀**：日本老年撫養比為全球最高，且仍在加速上升。預計到2050年，每位工作年齡人口需支撐近0.8位老年人。\n\n### 2. 債務動態 (Debt Dynamics)\n**Z-Score: 2.50** 🔴\n\n| 指標 | 數值 | 說明 |\n|------|------|------|\n| 債務/GDP (2023) | 262.5% | 已開發國家最高 |\n| 5年斜率 | +2.3%/年 | 債務持續累積 |\n| r - g | -1.3% | 名義利率 < 名義成長 |\n\n**解讀**：雖然r-g為負暫時穩定債務比率，但這依賴央行持續維持超低利率。任何利率正常化都將引發債務雪球效應。\n\n### 3. 官僚膨脹 (Bloat Index)\n**Z-Score: 0.85** 🟡\n\n| 指標 | 數值 |\n|------|------|\n| 政府消費/GDP | 20.5% |\n| 政府支出/GDP | 44.5% |\n\n**解讀**：政府規模在已開發國家中屬於中高水準，支出剛性較強，削減空間有限。\n\n### 4. 成長拖累 (Growth Drag)\n**Z-Score: 1.20** 🟠\n\n| 指標 | 數值 |\n|------|------|\n| 名義GDP成長 (2023) | 2.1% |\n| 實質GDP成長 (2023) | 1.2% |\n\n**解讀**：長期低成長使得透過「成長去槓桿」的路徑難以實現，加劇財政壓力。\n\n---\n\n## 通膨路徑分析\n\n### 實質利率歷史\n| 年份 | 名義殖利率 | CPI通膨 | 實質利率 |\n|------|-----------|---------|----------|\n| 2019 | -0.1% | 0.5% | -0.6% |\n| 2020 | 0.0% | 0.0% | 0.0% |\n| 2021 | 0.1% | -0.3% | 0.4% |\n| 2022 | 0.2% | 2.5% | -2.3% |\n| 2023 | 0.8% | 3.2% | -2.4% |\n\n### 金融抑制指標\n- **負實質利率年份佔比 (5年)**: 80%\n- **金融抑制指數**: 1.45 🟠\n- **央行持有國債比例**: ~50%\n\n**解讀**：日本呈現典型的金融抑制格局。長期負實質利率侵蝕債務實質價值，對儲蓄者構成隱性課稅。\n\n---\n\n## 前瞻預測\n\n### 撫養比預測 (UN WPP 中位數)\n```\n2023: ████████████████████ 48.5%\n2030: ██████████████████████████ 55%\n2040: █████████████████████████████████ 68%\n2050: ███████████████████████████████████████ 78%\n```\n\n### 財政壓力增量\n- 養老金支出增加：約 +5% GDP\n- 健康支出增加：約 +4% GDP\n- 長照支出增加：約 +3% GDP\n- **合計**：約 +12% GDP\n\n---\n\n## 投資意涵\n\n| 資產類別 | 建議 | 理由 |\n|----------|------|------|\n| 日本國債 | ⬇️ 減持 | 實質報酬長期為負 |\n| 通膨連結債 | ⬆️ 增持 | 提供通膨保護 |\n| 日本股票 | ➡️ 中性 | 名義資產受益，但成長有限 |\n| 日圓 | ⚠️ 警戒 | 長期購買力風險 |\n| 實質資產 | ⬆️ 增持 | 不動產、基礎設施 |\n\n---\n\n## 資料來源\n- 撫養比：World Bank WDI (SP.POP.DPND.OL)\n- 債務：IMF WEO (GGXWDG_NGDP)\n- 殖利率：OECD (IRLT)\n- 預測：UN World Population Prospects 2024\n\n---\n\n*報告由 demographic-fiscal-trap-analyzer v0.1.0 生成*\n```\n\n---\n\n## 多國比較報告\n\n```markdown\n# G7 人口-財政陷阱比較分析\n\n> 分析期間：2015-2023\n> 生成時間：2024-01-15 10:30 UTC\n\n---\n\n## 財政陷阱分數排名\n\n| 排名 | 國家 | 分數 | 象限 | 風險等級 |\n|------|------|------|------|----------|\n| 1 | 🇯🇵 日本 | 2.35 | Q1 | 🔴 極高 |\n| 2 | 🇮🇹 義大利 | 1.82 | Q1 | 🔴 高 |\n| 3 | 🇫🇷 法國 | 1.15 | Q2 | 🟠 偏高 |\n| 4 | 🇬🇧 英國 | 0.85 | Q3 | 🟡 中等 |\n| 5 | 🇺🇸 美國 | 0.72 | Q3 | 🟡 中等 |\n| 6 | 🇩🇪 德國 | 0.45 | Q2 | 🟢 低 |\n| 7 | 🇨🇦 加拿大 | 0.12 | Q4 | 🟢 低 |\n\n---\n\n## 象限分布圖\n\n```\n                    高債務動態\n                        ▲\n                        │\n       Q3              │              Q1\n    低老化+高債務      │           高老化+高債務\n    🇺🇸 USA           │           🇯🇵 JPN\n    🇬🇧 GBR           │           🇮🇹 ITA\n                        │\n ◄──────────────────────┼──────────────────────►\n                        │                    高老化壓力\n       Q4              │              Q2\n    低老化+低債務      │           高老化+低債務\n    🇨🇦 CAN           │           🇩🇪 DEU\n                        │           🇫🇷 FRA\n                        │\n                        ▼\n                    低債務動態\n```\n\n---\n\n## 四支柱比較熱力圖\n\n| 國家 | 老化壓力 | 債務動態 | 官僚膨脹 | 成長拖累 |\n|------|:--------:|:--------:|:--------:|:--------:|\n| JPN | 🔴 2.80 | 🔴 2.50 | 🟡 0.85 | 🟠 1.20 |\n| ITA | 🟠 1.95 | 🟠 1.75 | 🟠 1.10 | 🟠 1.55 |\n| FRA | 🟠 1.20 | 🟡 0.95 | 🟠 1.35 | 🟡 0.65 |\n| DEU | 🟠 1.45 | 🟢 0.15 | 🟡 0.75 | 🟡 0.85 |\n| GBR | 🟡 0.65 | 🟠 1.05 | 🟡 0.55 | 🟡 0.50 |\n| USA | 🟢 0.45 | 🟠 1.15 | 🟢 0.40 | 🟢 -0.25 |\n| CAN | 🟢 0.30 | 🟢 0.25 | 🟢 0.30 | 🟢 -0.45 |\n\n圖例：🔴 >2.0 | 🟠 1.0-2.0 | 🟡 0.5-1.0 | 🟢 <0.5\n\n---\n\n## 通膨激勵指數比較\n\n| 國家 | 通膨激勵指數 | 政策傾向 |\n|------|:------------:|----------|\n| 🇯🇵 日本 | 1.95 | 主動金融抑制 |\n| 🇮🇹 義大利 | 1.45 | 溫和金融抑制 |\n| 🇫🇷 法國 | 0.95 | 溫和金融抑制 |\n| 🇺🇸 美國 | 0.88 | 溫和金融抑制 |\n| 🇬🇧 英國 | 0.72 | 正統財政傾向 |\n| 🇩🇪 德國 | 0.35 | 正統財政 |\n| 🇨🇦 加拿大 | 0.25 | 正統財政 |\n\n---\n\n## 關鍵發現\n\n1. **雙高危機國家**：日本與義大利同處Q1象限，面臨老化與債務的雙重壓力，財政空間極為有限。\n\n2. **老化主導型**：德國與法國老化嚴重但債務相對可控，仍有財政空間因應。\n\n3. **債務主導型**：美國與英國債務較高但人口結構相對年輕，有較長的調整時間窗口。\n\n4. **相對健康**：加拿大是G7中唯一位於Q4象限的國家，政策靈活度最高。\n\n5. **通膨稀釋傾向**：日本通膨激勵指數最高，顯示強烈的貨幣稀釋動機。\n\n---\n\n## 投資配置建議\n\n### 主權債券配置\n| 國家 | 建議權重 | 理由 |\n|------|----------|------|\n| 🇨🇦 加拿大 | 超配 | 財政健全，實質報酬可期 |\n| 🇩🇪 德國 | 中性偏多 | 財政紀律強，但受歐元區影響 |\n| 🇺🇸 美國 | 中性 | 債務高但美元地位提供緩衝 |\n| 🇬🇧 英國 | 中性 | |\n| 🇫🇷 法國 | 中性偏少 | |\n| 🇮🇹 義大利 | 減持 | 高債務+高老化+歐元區約束 |\n| 🇯🇵 日本 | 減持 | 長期負實質報酬 |\n\n---\n\n*報告由 demographic-fiscal-trap-analyzer v0.1.0 生成*\n```\n",
        "skills/demographic-fiscal-trap-analyzer/workflows/aging-projection.md": "# 老化投影工作流 (Aging Projection Workflow)\n\n## 概述\n利用 UN World Population Prospects 撫養比預測數據，前瞻性評估各國的老化壓力演化與長期財政影響。\n\n## 前置條件\n- 已確認分析實體\n- 可存取 UN WPP 預測資料\n- 已設定預測結束年（forecast_end_year）\n\n## 執行步驟\n\n### Step 1: 歷史資料擷取\n```\n從 World Bank WDI 擷取歷史撫養比：\n- SP.POP.DPND.OL (老年撫養比: 65+/15-64)\n- SP.POP.DPND.YG (青年撫養比: 0-14/15-64)\n- SP.POP.DPND (總撫養比)\n\n時間範圍: start_year 至 end_year\n```\n\n### Step 2: 預測資料擷取\n```\n從 UN WPP 擷取預測數據：\n- 中位數預測 (Medium variant)\n- 可選：高/低預測區間\n\n時間範圍: end_year 至 forecast_end_year (如 2050)\n```\n\n### Step 3: 趨勢分析\n```python\n# 歷史趨勢\nhistorical_slope = linear_slope(old_age_dep[start_year:end_year])\nhistorical_level = old_age_dep[end_year]\n\n# 預測趨勢\nforecast_slope = linear_slope(old_age_dep[end_year:forecast_end_year])\nforecast_level = old_age_dep[forecast_end_year]\n\n# 加速度（斜率變化）\nacceleration = forecast_slope - historical_slope\n\n# 關鍵轉折點\npeak_year = old_age_dep.idxmax()  # 撫養比峰值年份（若有）\n```\n\n### Step 4: 跨國相對位置\n```python\n# 計算 end_year 的跨國 z-score\naging_zscore_current = zscore(historical_level)\n\n# 計算 forecast_end_year 的跨國 z-score\naging_zscore_future = zscore(forecast_level)\n\n# 相對排名\nrank_current = rank_among_entities(historical_level)\nrank_future = rank_among_entities(forecast_level)\n```\n\n### Step 5: 財政壓力推估\n```python\n# 老年相關支出佔 GDP 比例（粗估）\n# 基於 OECD 經驗：每增加 1% 老年撫養比 → 約增加 0.3% GDP 的養老金+健保支出\n\nbaseline_elderly_spending = elderly_spending_to_gdp[end_year]\nprojected_spending_increase = (forecast_level - historical_level) * 0.3\n\nprojected_elderly_spending = baseline_elderly_spending + projected_spending_increase\n\n# 財政壓力指數\nfiscal_pressure_index = projected_spending_increase / nominal_gdp_growth_avg\n```\n\n### Step 6: 情境分析\n```\n模擬不同人口情境：\n\n1. 中位數預測 (Medium variant)\n   - UN 基準假設\n\n2. 高生育情境 (High fertility)\n   - 青年撫養比上升，老年撫養比壓力略減\n\n3. 低生育情境 (Low fertility)\n   - 老化壓力加速\n\n4. 移民情境 (Migration adjustment)\n   - 淨移入對工作年齡人口的支撐效果\n```\n\n### Step 7: 老化階段分類\n```python\n# 基於老年撫養比水準與趨勢分類\n\nif historical_level > 0.40:\n    if forecast_slope > 0.005:\n        stage = \"SUPER_AGED_ACCELERATING\"  # 超高齡且加速（如韓國）\n    else:\n        stage = \"SUPER_AGED_PLATEAU\"  # 超高齡但趨緩（如日本）\nelif historical_level > 0.25:\n    if forecast_slope > 0.008:\n        stage = \"AGING_RAPID\"  # 快速老化中（如中國、台灣）\n    else:\n        stage = \"AGING_MODERATE\"  # 溫和老化（如美國）\nelse:\n    if forecast_slope > 0.005:\n        stage = \"YOUNG_BUT_TURNING\"  # 年輕但轉向（如印度）\n    else:\n        stage = \"DEMOGRAPHIC_DIVIDEND\"  # 人口紅利期\n```\n\n## 輸出格式\n```json\n{\n  \"entity\": \"KOR\",\n  \"aging_projection\": {\n    \"current_year\": 2023,\n    \"forecast_year\": 2050,\n    \"old_age_dependency\": {\n      \"current\": 0.24,\n      \"forecast\": 0.78,\n      \"change\": 0.54,\n      \"zscore_current\": 0.8,\n      \"zscore_forecast\": 2.5\n    },\n    \"total_dependency\": {\n      \"current\": 0.40,\n      \"forecast\": 0.95\n    },\n    \"trend\": {\n      \"historical_slope_10y\": 0.012,\n      \"forecast_slope\": 0.020,\n      \"acceleration\": 0.008,\n      \"peak_year\": 2065\n    },\n    \"fiscal_pressure\": {\n      \"baseline_elderly_spending_pct_gdp\": 8.5,\n      \"projected_increase_pct_gdp\": 16.2,\n      \"projected_total_pct_gdp\": 24.7\n    },\n    \"stage\": \"AGING_RAPID\",\n    \"rank_among_oecd\": {\n      \"current\": 15,\n      \"forecast\": 1\n    }\n  },\n  \"interpretation\": \"南韓正經歷全球最快速的老化，預計2050年老年撫養比將達0.78，躍升OECD第一，老年相關支出將佔GDP近25%\"\n}\n```\n\n## 注意事項\n- UN WPP 每 2 年更新一次，確認使用最新版本\n- 長期預測不確定性高，應呈現區間而非單一點估計\n- 移民政策變化可能顯著影響預測\n- 退休年齡改革可降低有效撫養比\n",
        "skills/demographic-fiscal-trap-analyzer/workflows/cross-country.md": "# 跨國比較工作流 (Cross-Country Comparison Workflow)\n\n## 概述\n對多個國家/地區進行並排比較，產出財政陷阱分數排名、四支柱雷達圖、以及象限分布圖。\n\n## 前置條件\n- 至少 2 個以上的分析實體\n- 統一的時間區間\n- 所有實體的資料可用性確認\n\n## 執行步驟\n\n### Step 1: 定義比較群組\n```\n支援的預設群組：\n- G7: USA, JPN, DEU, GBR, FRA, ITA, CAN\n- G20: G7 + CHN, IND, BRA, RUS, AUS, KOR, MEX, IDN, TUR, SAU, ARG, ZAF, EU\n- OECD: 38 個成員國\n- EU27: 歐盟成員國\n- ASEAN: SGP, MYS, THA, IDN, PHL, VNM, MMR, KHM, LAO, BRN\n- EM_ASIA: CHN, IND, KOR, TWN, THA, MYS, IDN, PHL, VNM\n- CUSTOM: 使用者自定義列表\n```\n\n### Step 2: 批量資料擷取\n```python\n# 對所有實體批量擷取資料\ndata = {}\nfor entity in entities:\n    data[entity] = {\n        \"old_age_dep\": fetch_old_age_dependency(entity, start_year, end_year),\n        \"debt_gdp\": fetch_debt_to_gdp(entity, start_year, end_year),\n        \"gov_consumption\": fetch_gov_consumption(entity, start_year, end_year),\n        \"gdp_growth\": fetch_nominal_gdp_growth(entity, start_year, end_year),\n        \"cpi\": fetch_cpi(entity, start_year, end_year),\n        \"yield_10y\": fetch_10y_yield(entity, start_year, end_year)\n    }\n\n# 記錄資料可用性\navailability_matrix = check_data_availability(data)\n```\n\n### Step 3: 跨國截面統計\n```python\n# 計算 end_year 的截面統計量\ncross_section_stats = {\n    \"old_age_dep\": {\n        \"mean\": np.mean([d[\"old_age_dep\"][end_year] for d in data.values()]),\n        \"std\": np.std([d[\"old_age_dep\"][end_year] for d in data.values()])\n    },\n    \"debt_gdp\": {...},\n    \"gov_consumption\": {...},\n    \"gdp_growth\": {...}\n}\n```\n\n### Step 4: 計算各國分數\n```python\nresults = {}\nfor entity in entities:\n    # 計算四支柱 z-scores（使用截面統計量）\n    aging_pressure = compute_aging_pressure(data[entity], cross_section_stats)\n    debt_dynamics = compute_debt_dynamics(data[entity], cross_section_stats)\n    bloat_index = compute_bloat_index(data[entity], cross_section_stats)\n    growth_drag = compute_growth_drag(data[entity], cross_section_stats)\n\n    # 加權總分\n    fiscal_trap_score = weighted_sum(aging_pressure, debt_dynamics, bloat_index, growth_drag, weights)\n    inflation_incentive = compute_inflation_incentive(data[entity], cross_section_stats)\n\n    # 象限分類\n    quadrant = classify_quadrant(aging_pressure, debt_dynamics)\n\n    results[entity] = {\n        \"fiscal_trap_score\": fiscal_trap_score,\n        \"inflation_incentive\": inflation_incentive,\n        \"aging_pressure\": aging_pressure,\n        \"debt_dynamics\": debt_dynamics,\n        \"bloat_index\": bloat_index,\n        \"growth_drag\": growth_drag,\n        \"quadrant\": quadrant\n    }\n```\n\n### Step 5: 排名與分組\n```python\n# 按 fiscal_trap_score 排名\nranking = sorted(results.items(), key=lambda x: x[1][\"fiscal_trap_score\"], reverse=True)\n\n# 風險分組\nhigh_risk = [e for e, r in ranking if r[\"fiscal_trap_score\"] > 1.5]\nelevated = [e for e, r in ranking if 0.5 < r[\"fiscal_trap_score\"] <= 1.5]\nmoderate = [e for e, r in ranking if -0.5 < r[\"fiscal_trap_score\"] <= 0.5]\nlow_risk = [e for e, r in ranking if r[\"fiscal_trap_score\"] <= -0.5]\n\n# 象限分布\nquadrant_distribution = Counter([r[\"quadrant\"] for r in results.values()])\n```\n\n### Step 6: 視覺化建議\n```\n建議產出的圖表：\n\n1. 排名條形圖 (Bar Chart)\n   - X軸: 國家\n   - Y軸: fiscal_trap_score\n   - 顏色: 風險等級\n\n2. 四支柱雷達圖 (Radar Chart)\n   - 每個國家一張\n   - 四軸: aging, debt, bloat, growth_drag\n\n3. 象限散點圖 (Scatter Plot)\n   - X軸: Aging Pressure\n   - Y軸: Debt Dynamics\n   - 點大小: fiscal_trap_score\n   - 顏色: 通膨激勵指數\n\n4. 熱力圖 (Heatmap)\n   - 行: 國家\n   - 列: 四支柱 + 總分\n   - 顏色: z-score 強度\n```\n\n## 輸出格式\n```json\n{\n  \"comparison_group\": \"G7\",\n  \"time_period\": \"2015-2023\",\n  \"ranking\": [\n    {\"rank\": 1, \"entity\": \"JPN\", \"fiscal_trap_score\": 2.35, \"quadrant\": \"Q1\"},\n    {\"rank\": 2, \"entity\": \"ITA\", \"fiscal_trap_score\": 1.82, \"quadrant\": \"Q1\"},\n    {\"rank\": 3, \"entity\": \"FRA\", \"fiscal_trap_score\": 1.15, \"quadrant\": \"Q2\"},\n    {\"rank\": 4, \"entity\": \"GBR\", \"fiscal_trap_score\": 0.85, \"quadrant\": \"Q3\"},\n    {\"rank\": 5, \"entity\": \"USA\", \"fiscal_trap_score\": 0.72, \"quadrant\": \"Q3\"},\n    {\"rank\": 6, \"entity\": \"DEU\", \"fiscal_trap_score\": 0.45, \"quadrant\": \"Q2\"},\n    {\"rank\": 7, \"entity\": \"CAN\", \"fiscal_trap_score\": 0.12, \"quadrant\": \"Q4\"}\n  ],\n  \"risk_groups\": {\n    \"high_risk\": [\"JPN\", \"ITA\"],\n    \"elevated\": [\"FRA\", \"GBR\", \"USA\"],\n    \"moderate\": [\"DEU\"],\n    \"low_risk\": [\"CAN\"]\n  },\n  \"quadrant_distribution\": {\n    \"Q1_HighAging_HighDebt\": 2,\n    \"Q2_HighAging_LowDebt\": 2,\n    \"Q3_LowAging_HighDebt\": 2,\n    \"Q4_LowAging_LowDebt\": 1\n  },\n  \"detailed_scores\": {\n    \"JPN\": {\n      \"fiscal_trap_score\": 2.35,\n      \"inflation_incentive\": 1.95,\n      \"aging_pressure\": 2.8,\n      \"debt_dynamics\": 2.5,\n      \"bloat_index\": 0.8,\n      \"growth_drag\": 1.2\n    }\n    // ... 其他國家\n  },\n  \"cross_section_stats\": {\n    \"fiscal_trap_score\": {\"mean\": 1.07, \"std\": 0.78, \"min\": 0.12, \"max\": 2.35}\n  },\n  \"interpretation\": \"G7中日本與義大利位於高風險區，兩國均處於Q1象限（高老化+高債務）；加拿大相對最健康\"\n}\n```\n\n## 注意事項\n- 確保所有國家使用相同年份資料，避免時間不一致\n- 資料缺失國家應標記並從截面統計中排除或做適當處理\n- 新興市場與已開發國家的比較需謹慎解讀\n",
        "skills/demographic-fiscal-trap-analyzer/workflows/debt-dynamics.md": "# 債務動態分析工作流 (Debt Dynamics Workflow)\n\n## 概述\n專注於政府債務可持續性分析，深入探討 r-g 缺口、債務軌跡演化、以及財政空間評估。\n\n## 前置條件\n- 已確認分析實體\n- 已確認時間區間\n- 債務與利率資料可用\n\n## 執行步驟\n\n### Step 1: 債務存量分析\n```\n擷取並分析：\n- 政府債務/GDP 水準\n- 債務結構（若可用）：內債 vs 外債、短期 vs 長期\n- 5年債務軌跡斜率\n```\n\n### Step 2: 利息負擔分析\n```\n計算：\n- 隱含利率 = 利息支出 / 債務存量（若資料可用）\n- 或使用 10年公債殖利率作為邊際成本代理\n- 利息支出/GDP 比率\n```\n\n### Step 3: r-g 缺口分析\n```python\n# 名義 r-g\nr_nominal = yield_10y[end_year]\ng_nominal = nominal_gdp_growth[end_year]\nrg_nominal = r_nominal - g_nominal\n\n# 實質 r-g（若通膨資料可用）\nr_real = yield_10y - cpi\ng_real = real_gdp_growth\nrg_real = r_real - g_real\n\n# r-g 持續性（5年平均）\nrg_avg_5y = (yield_10y - nominal_gdp_growth)[end_year-5:end_year].mean()\n```\n\n### Step 4: 債務動態方程式\n```\n標準債務動態：\nΔd = (r - g) × d_{t-1} + pb\n\n其中：\n- d = 債務/GDP\n- r = 名義利率\n- g = 名義成長率\n- pb = 基本財政餘額/GDP（支出 - 收入，不含利息）\n\n若 r > g 且 pb >= 0（赤字），債務比率將自動膨脹。\n```\n\n### Step 5: 債務穩定條件\n```python\n# 計算穩定債務所需的基本盈餘\nrequired_pb = (r - g) * debt_level\n\n# 實際基本餘額（估算）\nactual_pb = (gov_expenditure - interest_payments) - gov_revenue\n\n# 財政調整缺口\nfiscal_gap = required_pb - actual_pb\n```\n\n### Step 6: 情境分析\n```\n模擬三種情境：\n\n1. 基準情境：r-g 維持當前水準\n   - 5年後債務/GDP 預測\n\n2. 利率上升情境：r 上升 100bps\n   - 評估債務軌跡惡化程度\n\n3. 成長下滑情境：g 下降 100bps\n   - 評估成長衝擊影響\n```\n\n### Step 7: 評分與分類\n```python\ndebt_dynamics_score = (\n    zscore(debt_level) * 0.40 +\n    zscore(debt_slope_5y) * 0.25 +\n    zscore(rg_nominal) * 0.20 +\n    zscore(fiscal_gap) * 0.15\n)\n\n# 分類\nif debt_dynamics_score > 2.0:\n    debt_status = \"CRITICAL\"  # 債務危機風險\nelif debt_dynamics_score > 1.0:\n    debt_status = \"ELEVATED\"  # 需關注\nelif debt_dynamics_score > 0:\n    debt_status = \"MODERATE\"  # 中等壓力\nelse:\n    debt_status = \"SUSTAINABLE\"  # 可持續\n```\n\n## 輸出格式\n```json\n{\n  \"entity\": \"JPN\",\n  \"debt_dynamics\": {\n    \"debt_to_gdp_level\": 262.5,\n    \"debt_to_gdp_slope_5y\": 2.3,\n    \"r_nominal\": 0.8,\n    \"g_nominal\": 2.1,\n    \"r_minus_g\": -1.3,\n    \"r_minus_g_5y_avg\": -0.8,\n    \"required_primary_balance\": -3.4,\n    \"fiscal_gap_estimate\": 1.2\n  },\n  \"score\": 1.85,\n  \"status\": \"ELEVATED\",\n  \"scenarios\": {\n    \"baseline_5y\": 275.0,\n    \"rate_shock_5y\": 290.0,\n    \"growth_shock_5y\": 285.0\n  },\n  \"interpretation\": \"日本債務水準極高但 r-g 為負，短期自動穩定；然而超低利率環境不可持續，利率正常化將造成顯著壓力\"\n}\n```\n\n## 注意事項\n- 日本等特殊案例：雖債務極高，但央行持有大量國債，有效利率極低\n- 新興市場：需考慮外幣計價債務的匯率風險\n- 資料頻率：年度資料可能遺漏季度波動\n",
        "skills/demographic-fiscal-trap-analyzer/workflows/full-analysis.md": "# 完整分析工作流 (Full Analysis Workflow)\n\n## 概述\n執行完整的人口-財政陷阱分析，包含所有四支柱評分、象限分類、通膨激勵指數、以及趨勢預測。\n\n## 前置條件\n- 已確認分析實體（國家/地區代碼）\n- 已確認時間區間（start_year, end_year）\n- 可選：自訂權重\n\n## 執行步驟\n\n### Step 1: 參數確認\n```\n確認以下參數：\n- entities: [國家代碼列表，如 JPN, USA, DEU]\n- start_year: 歷史起始年（建議 2010）\n- end_year: 歷史結束年（最近可用年份）\n- forecast_end_year: 預測結束年（預設 2050）\n- weights: 四支柱權重（預設 aging:0.35, debt:0.35, bloat:0.15, growth_drag:0.15）\n```\n\n### Step 2: 資料擷取\n執行以下資料擷取模組：\n\n1. **撫養比資料** (World Bank / UN WPP)\n   - SP.POP.DPND.OL (老年撫養比)\n   - SP.POP.DPND.YG (青年撫養比)\n   - SP.POP.DPND (總撫養比)\n\n2. **債務資料** (IMF WEO / World Bank)\n   - GC.DOD.TOTL.GD.ZS (政府債務/GDP)\n   - 或 IMF GGXWDG_NGDP\n\n3. **支出資料** (World Bank / IMF)\n   - NE.CON.GOVT.ZS (政府消費/GDP)\n   - GC.XPN.TOTL.GD.ZS (政府支出/GDP)\n\n4. **成長與通膨** (World Bank / IMF)\n   - NY.GDP.MKTP.KD.ZG (實質GDP成長)\n   - FP.CPI.TOTL.ZG (CPI通膨)\n\n5. **利率資料** (OECD / 各國央行)\n   - 10年公債殖利率\n   - 或政策利率（回退）\n\n### Step 3: 指標計算\n\n#### 3.1 老化壓力 (Aging Pressure)\n```python\naging_level = old_age_dependency[end_year]\naging_slope_10y = linear_slope(old_age_dependency[end_year-10:end_year])\naging_pressure = zscore(aging_level) * 0.5 + zscore(aging_slope_10y) * 0.5\n```\n\n#### 3.2 債務動態 (Debt Dynamics)\n```python\ndebt_level = debt_to_gdp[end_year]\ndebt_slope_5y = linear_slope(debt_to_gdp[end_year-5:end_year])\nr = nominal_yield[end_year]\ng = nominal_gdp_growth[end_year]\nr_minus_g = r - g\ndebt_dynamics = zscore(debt_level)*0.5 + zscore(debt_slope_5y)*0.3 + zscore(r_minus_g)*0.2\n```\n\n#### 3.3 官僚膨脹 (Bloat Index)\n```python\nbloat_index = zscore(gov_consumption[end_year])*0.6 + zscore(gov_expenditure[end_year])*0.4\n```\n\n#### 3.4 成長拖累 (Growth Drag)\n```python\ngrowth_drag = zscore(-nominal_gdp_growth[end_year])  # 負向：低成長 = 高拖累\n```\n\n### Step 4: 綜合評分\n\n#### 4.1 財政陷阱分數\n```python\nfiscal_trap_score = (\n    weights[\"aging\"] * aging_pressure +\n    weights[\"debt\"] * debt_dynamics +\n    weights[\"bloat\"] * bloat_index +\n    weights[\"growth_drag\"] * growth_drag\n)\n```\n\n#### 4.2 通膨激勵指數\n```python\nreal_rate = nominal_yield - cpi\nneg_real_share_5y = (real_rate[end_year-5:end_year] < 0).mean()\n\ninflation_incentive = (\n    0.40 * zscore(debt_level) +\n    0.20 * zscore(r_minus_g) +\n    0.20 * zscore(neg_real_share_5y) +\n    0.20 * zscore(bloat_index)\n)\n```\n\n### Step 5: 象限分類\n```python\nif aging_pressure > 1 and debt_dynamics > 1:\n    quadrant = \"Q1_HighAging_HighDebt\"  # 雙高危機\nelif aging_pressure > 1 and debt_dynamics <= 1:\n    quadrant = \"Q2_HighAging_LowDebt\"   # 老化主導\nelif aging_pressure <= 1 and debt_dynamics > 1:\n    quadrant = \"Q3_LowAging_HighDebt\"   # 債務主導\nelse:\n    quadrant = \"Q4_LowAging_LowDebt\"    # 相對健康\n```\n\n### Step 6: 趨勢預測（可選）\n若啟用 `forecast_end_year`，使用 UN WPP 撫養比預測數據，計算未來老化壓力趨勢。\n\n### Step 7: 輸出報告\n按照 `templates/output-json.md` 或 `templates/output-markdown.md` 格式輸出結果。\n\n## 錯誤處理\n- 資料缺失：記錄缺失指標，使用可用資料計算部分結果\n- 殖利率不可用：回退至政策利率\n- 跨國截面不足：警告 z-score 計算可能不穩定\n\n## 輸出範例\n參見 `examples/japan-full-analysis.json`\n",
        "skills/demographic-fiscal-trap-analyzer/workflows/inflation-path.md": "# 通膨路徑分析工作流 (Inflation Path Workflow)\n\n## 概述\n專注於分析政府選擇「通膨稀釋」(inflation erosion) 或「金融抑制」(financial repression) 路徑的動機與歷史軌跡，評估實質利率環境與貨幣稀釋風險。\n\n## 前置條件\n- 已確認分析實體\n- 通膨 (CPI) 與利率資料可用\n- 債務與財政資料可用\n\n## 執行步驟\n\n### Step 1: 實質利率計算\n```python\n# 基本實質利率（費雪方程式）\nreal_rate = nominal_yield_10y - cpi_yoy\n\n# 事前 vs 事後實質利率\n# 事後 (ex-post): 使用已實現通膨\nreal_rate_ex_post = nominal_yield - realized_cpi\n\n# 事前 (ex-ante): 使用通膨預期（若可用）\nreal_rate_ex_ante = nominal_yield - inflation_expectations\n```\n\n### Step 2: 負實質利率歷史分析\n```python\n# 計算負實質利率持續性\nreal_rate_series = real_rate[start_year:end_year]\n\n# 負實質利率年份佔比\nneg_real_years = (real_rate_series < 0).sum()\nneg_real_share = neg_real_years / len(real_rate_series)\n\n# 負實質利率深度（平均負值）\nneg_real_depth = real_rate_series[real_rate_series < 0].mean()\n\n# 當前狀態\ncurrent_real_rate = real_rate_series[end_year]\nis_currently_negative = current_real_rate < 0\n\n# 連續負實質利率年數\nconsecutive_neg_years = count_consecutive_negative(real_rate_series, end_year)\n```\n\n### Step 3: 金融抑制指數\n```python\n# 金融抑制指數 (Financial Repression Index)\n# 結合多個金融抑制信號\n\nfinancial_repression_index = (\n    0.30 * zscore(-current_real_rate) +           # 負實質利率深度\n    0.25 * zscore(neg_real_share) +               # 負實質利率持續性\n    0.20 * zscore(central_bank_holdings_pct) +    # 央行持有國債比例（若可用）\n    0.15 * zscore(bank_regulation_intensity) +    # 銀行監管強度（代理）\n    0.10 * zscore(capital_control_index)          # 資本管制程度（若可用）\n)\n```\n\n### Step 4: 通膨激勵指數計算\n```python\n# 通膨激勵指數 (Inflation Incentive Score)\n# 衡量政府選擇通膨路徑的動機\n\ndebt_level = debt_to_gdp[end_year]\nr_minus_g = nominal_yield[end_year] - nominal_gdp_growth[end_year]\n\ninflation_incentive = (\n    0.40 * zscore(debt_level) +           # 高債務 → 強動機\n    0.20 * zscore(r_minus_g) +            # r > g → 難自然去槓桿\n    0.20 * zscore(neg_real_share) +       # 已有負實質利率歷史\n    0.20 * zscore(bloat_index)            # 高支出剛性 → 難削減\n)\n```\n\n### Step 5: 債務稀釋效果評估\n```python\n# 通膨對實質債務的稀釋效果\n\n# 歷史稀釋量估算\n# 若實質利率為負，債務的實質負擔被侵蝕\ncumulative_erosion = 0\nfor year in range(start_year, end_year+1):\n    if real_rate[year] < 0:\n        erosion = debt_to_gdp[year] * abs(real_rate[year])\n        cumulative_erosion += erosion\n\n# 相對於名義債務的稀釋比例\nerosion_pct = cumulative_erosion / debt_to_gdp[end_year]\n\n# 前瞻情境：若維持負 2% 實質利率 5 年\nprojected_erosion_5y = debt_to_gdp[end_year] * 0.02 * 5\n```\n\n### Step 6: 通膨突破風險評估\n```python\n# 評估通膨失控風險信號\n\n# 通膨波動性\ncpi_volatility_5y = cpi[end_year-5:end_year].std()\n\n# 通膨預期錨定程度（若有調查資料）\n# expectation_anchoring = long_term_expectations - target\n\n# 貨幣成長與通膨關係\n# m2_cpi_correlation = correlation(m2_growth, cpi, lag=12)\n\n# 財政主導指標\nfiscal_dominance_risk = (\n    zscore(debt_level) * 0.4 +\n    zscore(deficit_to_gdp) * 0.3 +\n    zscore(central_bank_holdings_pct) * 0.3\n)\n```\n\n### Step 7: 政策路徑分類\n```python\n# 基於指標組合分類政策路徑\n\nif inflation_incentive > 1.5 and financial_repression_index > 1.0:\n    policy_path = \"ACTIVE_REPRESSION\"  # 主動金融抑制\n    description = \"政府積極維持負實質利率環境，實質債務負擔持續被侵蝕\"\n\nelif inflation_incentive > 1.0 and current_real_rate < 0:\n    policy_path = \"PASSIVE_REPRESSION\"  # 被動金融抑制\n    description = \"負實質利率環境存在但非刻意維持，可能隨通膨下降而結束\"\n\nelif inflation_incentive > 1.0 and current_real_rate > 0:\n    policy_path = \"LATENT_PRESSURE\"  # 潛在壓力\n    description = \"有稀釋動機但尚未執行，需關注未來政策轉向\"\n\nelif fiscal_dominance_risk > 1.5:\n    policy_path = \"FISCAL_DOMINANCE_RISK\"  # 財政主導風險\n    description = \"央行獨立性可能受威脅，通膨錨定風險上升\"\n\nelse:\n    policy_path = \"ORTHODOX\"  # 正統路徑\n    description = \"財政政策正常，無明顯通膨稀釋傾向\"\n```\n\n## 輸出格式\n```json\n{\n  \"entity\": \"JPN\",\n  \"inflation_path_analysis\": {\n    \"real_rate\": {\n      \"current\": -1.2,\n      \"5y_average\": -0.8,\n      \"10y_average\": -0.5\n    },\n    \"negative_real_rate\": {\n      \"share_of_years\": 0.70,\n      \"current_consecutive_years\": 8,\n      \"average_depth_when_negative\": -0.9\n    },\n    \"scores\": {\n      \"inflation_incentive\": 1.85,\n      \"financial_repression_index\": 1.45\n    },\n    \"debt_erosion\": {\n      \"cumulative_erosion_pct_gdp\": 45.0,\n      \"erosion_relative_to_debt\": 0.17,\n      \"projected_5y_erosion_at_neg2pct\": 26.0\n    },\n    \"policy_path\": \"ACTIVE_REPRESSION\",\n    \"policy_description\": \"日本央行維持超寬鬆政策，實質利率長期為負，政府債務的實質負擔持續被侵蝕\",\n    \"fiscal_dominance_risk\": 1.65\n  },\n  \"asset_allocation_implications\": {\n    \"nominal_bonds\": \"UNDERWEIGHT - 實質報酬長期承壓\",\n    \"inflation_linked_bonds\": \"OVERWEIGHT - 提供通膨保護\",\n    \"real_assets\": \"OVERWEIGHT - 受益於名義價格上漲\",\n    \"currency\": \"CAUTION - 長期購買力可能持續流失\"\n  },\n  \"interpretation\": \"日本呈現典型的金融抑制格局：超高債務、長期負實質利率、央行大量持有國債。過去10年約17%的債務實質負擔被通膨侵蝕。投資者應預期此環境將持續。\"\n}\n```\n\n## 注意事項\n- 通膨預期資料（如調查或市場隱含）品質差異大\n- 央行持有國債比例在部分國家為敏感資訊\n- 資本管制指數需使用 IMF AREAER 或 Chinn-Ito 指數\n- 日本、歐元區等負利率國家需特別處理名義利率下限\n",
        "skills/detect-atr-squeeze-regime/SKILL.md": "---\nname: detect-atr-squeeze-regime\ndescription: 以 14 日指數平滑 ATR 偵測市場是否從秩序型趨勢轉為波動主導的擠壓（squeeze）行情，並輸出對技術位、停損、交易持有期的可行性評估。\n---\n\n<essential_principles>\n\n<principle name=\"atr_percent_normalization\">\n**ATR% 標準化核心**\n\n傳統 ATR 是絕對值（價格單位），不同價位資產無法比較。\n將 ATR 轉換為百分比（ATR / Close * 100）後：\n- 可跨資產比較波動強度\n- 能建立「常態基準」（3 年移動均值）\n- 用「倍率」判定是否進入異常波動區\n\n```\nATR% = (14-day EMA of True Range) / Close * 100\nRatio = Current ATR% / 3-year Rolling Mean ATR%\n```\n</principle>\n\n<principle name=\"three_regime_classification\">\n**三行情分類**\n\n| 行情                           | ATR% 條件   | Ratio 條件 | 市場特徵                           |\n|--------------------------------|-------------|------------|------------------------------------|\n| `orderly_market`               | 常態區間    | < 1.2      | 技術位有效、停損精準、趨勢追蹤可靠 |\n| `elevated_volatility_trend`    | 偏高        | 1.2 - 2.0  | 技術位減效、需放寬停損、仍有方向性 |\n| `volatility_dominated_squeeze` | >= 高波門檻 | >= 2.0     | 技術位失靈、停損頻被掃、反身性主導 |\n\n**擠壓行情**的判定需要**同時**滿足：\n1. ATR% >= `high_vol_threshold_pct`（預設 6%）\n2. Ratio >= `spike_threshold_x`（預設 2.0）\n</principle>\n\n<principle name=\"reflexivity_mechanics\">\n**反身性機制解讀**\n\n當進入 `volatility_dominated_squeeze` 行情：\n\n**價格運動被「被迫流」主導**：\n- 保證金調整 / 槓桿去化\n- 期權 Delta/Gamma 避險\n- 空頭回補\n- 被動風險平價再平衡\n\n**技術位可靠度下降**：\n- 突破/跌破更常是流動性與風控觸發的結果\n- 不代表基本面改變或趨勢確認\n\n**停損脆弱性**：\n- 同一口波動可掃過多層 stops\n- 低時間尺度的 conviction trading「結構性受損」\n- 宏觀看對也難撐：短期雜訊大到足以讓方向正確的部位先被洗掉\n</principle>\n\n<principle name=\"actionable_adjustments\">\n**可操作的調整建議**\n\n當偵測到擠壓行情時：\n\n| 調整項目   | 秩序市場    | 擠壓行情       |\n|------------|-------------|----------------|\n| 停損倍數   | 1.0-1.5 ATR | 2.0-3.0 ATR    |\n| 倉位縮放   | 正常        | 降至 1/ATR%    |\n| 時間框架   | 日內/短線   | 切換到較長週期 |\n| 工具選擇   | 裸倉位      | 期權/價差結構  |\n| 技術位信任 | 高          | 低（視為雜訊） |\n</principle>\n\n</essential_principles>\n\n<objective>\n偵測資產是否進入「波動主導的擠壓行情」：\n\n1. **計算 ATR%**：14 日 EMA 平滑的真實波幅百分比\n2. **建立基準**：3 年滾動均值作為「常態」參照\n3. **判定行情**：比較當前值與基準的倍率\n4. **輸出建議**：停損調整、倉位縮放、技術位信任度\n\n輸出：行情判定、ATR% 數值、倍率、可操作的風控建議。\n</objective>\n\n<quick_start>\n\n**最快的方式：偵測白銀（SI=F）**\n\n```bash\ncd skills/detect-atr-squeeze-regime\npip install pandas numpy yfinance pandas_ta  # 首次使用\npython scripts/atr_squeeze.py --symbol SI=F --quick\n```\n\n輸出範例：\n```json\n{\n  \"symbol\": \"SI=F\",\n  \"as_of\": \"2026-01-14\",\n  \"regime\": \"volatility_dominated_squeeze\",\n  \"atr_pct\": 7.23,\n  \"atr_ratio_to_baseline\": 2.41,\n  \"tech_level_reliability\": \"low\",\n  \"tech_level_reliability_score\": 28,\n  \"suggested_stop_atr_mult\": 2.5,\n  \"position_scale\": 0.41\n}\n```\n\n**完整分析**：\n```bash\npython scripts/atr_squeeze.py --symbol XAGUSD --start 2020-01-01 --end 2026-01-01 --output result.json\n```\n\n**生成視覺化儀表盤**：\n```bash\npip install matplotlib  # 首次使用\npython scripts/plot_atr_squeeze.py --symbol SI=F --output output/\n```\n\n儀表盤包含：\n- 價格走勢圖\n- ATR% 波動率時間序列\n- ATR 倍率儀表盤\n- 當前狀態與風控建議面板\n\n</quick_start>\n\n<intake>\n需要進行什麼操作？\n\n1. **快速偵測** - 檢查單一資產的當前行情狀態\n2. **多資產掃描** - 掃描多個資產尋找擠壓行情\n3. **歷史回測** - 回溯識別過去的擠壓期間\n4. **持續監控** - 設定警報當行情切換時通知\n5. **方法論學習** - 了解 ATR 擠壓行情的理論基礎\n\n**請選擇或直接提供資產代碼開始分析。**\n</intake>\n\n<routing>\n| Response                         | Action                                       |\n|----------------------------------|----------------------------------------------|\n| 1, \"快速\", \"quick\", \"check\"      | 執行 `python scripts/atr_squeeze.py --quick` |\n| 2, \"掃描\", \"scan\", \"multiple\"    | 閱讀 `workflows/monitor.md` 並執行           |\n| 3, \"回測\", \"backtest\", \"history\" | 閱讀 `workflows/backtest.md` 並執行          |\n| 4, \"監控\", \"monitor\", \"alert\"    | 閱讀 `workflows/monitor.md` 並執行           |\n| 5, \"學習\", \"方法論\", \"why\"       | 閱讀 `references/methodology.md`             |\n| 提供 symbol (如 SI=F, GC=F)      | 閱讀 `workflows/detect.md` 並使用參數執行    |\n\n**路由後，閱讀對應文件並執行。**\n</routing>\n\n<directory_structure>\n```\ndetect-atr-squeeze-regime/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元數據\n├── workflows/\n│   ├── detect.md                      # 單資產偵測工作流\n│   ├── monitor.md                     # 多資產監控工作流\n│   └── backtest.md                    # 歷史回測工作流\n├── references/\n│   ├── methodology.md                 # ATR 擠壓行情方法論\n│   ├── input-schema.md                # 完整輸入參數定義\n│   └── data-sources.md                # 資料來源說明\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n├── scripts/\n│   ├── atr_squeeze.py                 # 主偵測腳本\n│   └── plot_atr_squeeze.py            # 視覺化儀表盤腳本\n└── examples/\n    └── xagusd-squeeze-2024.json       # 範例輸出\n```\n</directory_structure>\n\n<reference_index>\n\n**方法論**: references/methodology.md\n- ATR% 標準化原理\n- 三行情分類邏輯\n- 反身性機制解讀\n- Ole Hansen 白銀擠壓案例\n\n**資料來源**: references/data-sources.md\n- Yahoo Finance 期貨代碼\n- Stooq 替代來源\n- 數據頻率與對齊\n\n**輸入參數**: references/input-schema.md\n- 完整參數定義\n- 預設值與建議範圍\n\n</reference_index>\n\n<workflows_index>\n| Workflow    | Purpose    | 使用時機         |\n|-------------|------------|------------------|\n| detect.md   | 單資產偵測 | 需要檢查特定資產 |\n| monitor.md  | 多資產監控 | 日常掃描或警報   |\n| backtest.md | 歷史回測   | 驗證識別準確性   |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構定義 |\n| output-markdown.md | Markdown 報告模板 |\n</templates_index>\n\n<scripts_index>\n| Script              | Command                          | Purpose          |\n|---------------------|----------------------------------|------------------|\n| atr_squeeze.py      | `--symbol SI=F --quick`          | 快速檢查當前狀態 |\n| atr_squeeze.py      | `--symbol SI=F --start DATE`     | 完整歷史分析     |\n| atr_squeeze.py      | `--scan SI=F,GC=F,CL=F`          | 多資產掃描       |\n| plot_atr_squeeze.py | `--symbol SI=F --output output/` | 生成視覺化儀表盤 |\n</scripts_index>\n\n<input_schema_summary>\n\n**核心參數**\n\n| 參數       | 類型   | 預設值     | 說明       |\n|------------|--------|------------|------------|\n| symbol     | string | (required) | 資產代碼   |\n| start_date | string | today-5y   | 取樣開始日 |\n| end_date   | string | today      | 取樣結束日 |\n| timeframe  | string | 1d         | 價格頻率   |\n\n**ATR 參數**\n\n| 參數            | 類型   | 預設值 | 說明                 |\n|-----------------|--------|--------|----------------------|\n| atr_period      | int    | 14     | ATR 週期             |\n| atr_smoothing   | string | ema    | 平滑法（ema/wilder） |\n| use_percent_atr | bool   | true   | 是否轉為百分比       |\n\n**行情判定參數**\n\n| 參數                   | 類型   | 預設值 | 說明                    |\n|------------------------|--------|--------|-------------------------|\n| baseline_window_days   | int    | 756    | 長期基準窗口（約 3 年） |\n| spike_threshold_x      | number | 2.0    | 倍率門檻                |\n| high_vol_threshold_pct | number | 6.0    | 絕對 ATR% 高波動門檻    |\n\n完整參數定義見 `references/input-schema.md`。\n\n</input_schema_summary>\n\n<output_schema_summary>\n```json\n{\n  \"skill\": \"detect-atr-squeeze-regime\",\n  \"symbol\": \"SI=F\",\n  \"as_of\": \"2026-01-14\",\n  \"regime\": \"volatility_dominated_squeeze\",\n  \"atr_pct\": 7.23,\n  \"atr_ratio_to_baseline\": 2.41,\n  \"baseline_atr_pct\": 3.0,\n  \"tech_level_reliability\": \"low\",\n  \"tech_level_reliability_score\": 28,\n  \"risk_adjustments\": {\n    \"suggested_stop_atr_mult\": 2.5,\n    \"position_scale\": 0.41,\n    \"recommended_timeframe\": \"weekly\",\n    \"instrument_suggestion\": \"options_or_spreads\"\n  },\n  \"interpretation\": {\n    \"regime_explanation\": \"...\",\n    \"tactics\": [\"...\", \"...\"]\n  }\n}\n```\n\n完整輸出結構見 `templates/output-json.md`。\n</output_schema_summary>\n\n<success_criteria>\n執行成功時應產出：\n\n- [ ] 當前行情判定（orderly / elevated / squeeze）\n- [ ] ATR% 數值與對基準的倍率\n- [ ] 技術位可靠度評分（0-100）\n- [ ] 建議停損倍數\n- [ ] 建議倉位縮放係數\n- [ ] 行情解釋與戰術建議\n- [ ] 時間序列資料（可選，用於視覺化）\n- [ ] 視覺化儀表盤 PNG（可選，使用 plot_atr_squeeze.py）\n</success_criteria>\n",
        "skills/detect-atr-squeeze-regime/references/data-sources.md": "# 資料來源說明\n\n## 主要資料來源\n\n### Yahoo Finance（推薦）\n\n**優點**：\n- 免費，無需 API key\n- 使用 `yfinance` 套件直接抓取\n- 覆蓋全球主要市場\n\n**支援的資產類型**：\n\n| 類型 | 格式 | 範例 |\n|------|------|------|\n| 期貨 | XXX=F | SI=F（白銀）, GC=F（黃金）, CL=F（原油） |\n| 股票 | TICKER | AAPL, TSLA, SPY |\n| 指數 | ^XXX | ^GSPC（S&P 500）, ^VIX |\n| ETF | TICKER | GLD, SLV, USO |\n\n**常用期貨代碼**：\n\n| 資產 | 代碼 | 說明 |\n|------|------|------|\n| 白銀 | SI=F | COMEX 白銀期貨 |\n| 黃金 | GC=F | COMEX 黃金期貨 |\n| 原油 | CL=F | WTI 原油期貨 |\n| 天然氣 | NG=F | Henry Hub 天然氣期貨 |\n| 銅 | HG=F | COMEX 銅期貨 |\n| 玉米 | ZC=F | CBOT 玉米期貨 |\n| 小麥 | ZW=F | CBOT 小麥期貨 |\n| 大豆 | ZS=F | CBOT 大豆期貨 |\n| E-mini S&P | ES=F | CME E-mini S&P 500 |\n| Nasdaq 100 | NQ=F | CME E-mini Nasdaq 100 |\n\n**使用方式**：\n\n```python\nimport yfinance as yf\n\n# 下載數據\nticker = yf.Ticker(\"SI=F\")\ndf = ticker.history(start=\"2020-01-01\", end=\"2026-01-01\")\n\n# 必要欄位\n# - High, Low, Close（用於 ATR 計算）\n# - Open（可選）\n# - Volume（可選）\n```\n\n**注意事項**：\n- 期貨數據為連續合約（自動換月）\n- 部分冷門期貨可能數據不完整\n- 小時線數據僅保留近期\n\n---\n\n## 替代資料來源\n\n### Stooq\n\n**網址**：https://stooq.com\n\n**優點**：\n- 免費\n- 長期歷史數據\n- 覆蓋外匯、貴金屬現貨\n\n**支援的資產類型**：\n\n| 類型 | 格式 | 範例 |\n|------|------|------|\n| 外匯 | XXXYYY | EURUSD, USDJPY |\n| 貴金屬現貨 | XAUXXX | XAUUSD（黃金）, XAGUSD（白銀） |\n| 指數 | ^XXX | ^SPX, ^DJI |\n\n**下載方式**：\n\n```python\nimport pandas as pd\n\n# 直接下載 CSV\nurl = \"https://stooq.com/q/d/l/?s=xagusd&d1=20200101&d2=20260101&i=d\"\ndf = pd.read_csv(url)\n\n# 欄位：Date, Open, High, Low, Close, Volume\n```\n\n**注意事項**：\n- 需要處理日期格式\n- 部分資產可能有缺失值\n- 下載頻率有限制（防爬蟲）\n\n---\n\n### Alpha Vantage\n\n**網址**：https://www.alphavantage.co\n\n**優點**：\n- 免費 tier 可用\n- API 穩定\n- 支援即時數據\n\n**限制**：\n- 免費版每分鐘 5 次請求\n- 每日 500 次請求上限\n- 需要 API key\n\n**使用方式**：\n\n```python\nimport requests\n\nAPI_KEY = \"YOUR_API_KEY\"\nsymbol = \"SILVER\"  # 不同於 yfinance 的符號\nurl = f\"https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol={symbol}&apikey={API_KEY}&outputsize=full\"\n\nresponse = requests.get(url)\ndata = response.json()\n```\n\n---\n\n### Twelve Data\n\n**網址**：https://twelvedata.com\n\n**優點**：\n- 覆蓋範圍廣\n- 支援技術指標 API\n- 免費版可用\n\n**限制**：\n- 免費版每分鐘 8 次請求\n- 歷史數據深度有限\n\n---\n\n## 數據需求\n\n### 必要欄位\n\n| 欄位 | 用途 |\n|------|------|\n| High | True Range 計算 |\n| Low | True Range 計算 |\n| Close | True Range 計算、ATR% 計算 |\n\n### 可選欄位\n\n| 欄位 | 用途 |\n|------|------|\n| Open | 視覺化、進階分析 |\n| Volume | 流動性分析（未來擴展） |\n\n### 數據頻率\n\n| 頻率 | 建議場景 |\n|------|----------|\n| 日線（1d） | 預設，適合大多數分析 |\n| 小時線（1h） | 更細粒度分析，但歷史深度有限 |\n\n### 數據長度\n\n| 長度 | 用途 |\n|------|------|\n| 3 年 | 建立有效基準（baseline_window_days = 756） |\n| 5 年 | 涵蓋更多週期，更穩定的基準 |\n| 10 年 | 長期回測 |\n\n**建議**：至少取 5 年數據，前 3 年用於建立基準，後 2 年用於有效分析。\n\n---\n\n## 資料來源選擇建議\n\n| 資產類型 | 建議來源 | 備註 |\n|----------|----------|------|\n| 期貨（美國） | Yahoo Finance | SI=F, GC=F, CL=F 等 |\n| 貴金屬現貨 | Stooq | XAUUSD, XAGUSD |\n| 外匯 | Stooq 或 Alpha Vantage | 視可用性 |\n| 美股/ETF | Yahoo Finance | SPY, GLD, SLV |\n| 國際指數 | Yahoo Finance | ^N225, ^FTSE |\n\n---\n\n## 錯誤處理\n\n### 常見問題\n\n1. **Symbol 無效**\n   - 檢查格式是否正確\n   - 嘗試替代符號（如 SI=F vs SILVER）\n\n2. **數據缺失**\n   - 檢查日期範圍\n   - 嘗試替代資料來源\n\n3. **下載失敗**\n   - 檢查網路連接\n   - 等待後重試（可能觸發限流）\n\n4. **數據不足**\n   - 減少 baseline_window_days\n   - 或取更長期的數據\n\n### 建議的錯誤處理流程\n\n```python\ndef fetch_data(symbol, start, end):\n    try:\n        # 嘗試 yfinance\n        df = yf.Ticker(symbol).history(start=start, end=end)\n        if len(df) > 0:\n            return df\n    except Exception as e:\n        print(f\"yfinance failed: {e}\")\n\n    try:\n        # 嘗試 Stooq\n        url = f\"https://stooq.com/q/d/l/?s={symbol.lower()}&d1={start.replace('-','')}&d2={end.replace('-','')}&i=d\"\n        df = pd.read_csv(url)\n        if len(df) > 0:\n            return df\n    except Exception as e:\n        print(f\"Stooq failed: {e}\")\n\n    raise ValueError(f\"Cannot fetch data for {symbol}\")\n```\n",
        "skills/detect-atr-squeeze-regime/references/input-schema.md": "# 輸入參數定義\n\n## 必要參數\n\n| 參數     | 類型   | 說明                               |\n|----------|--------|------------------------------------|\n| `symbol` | string | 資產代碼（例：SI=F, GC=F, XAGUSD） |\n\n## 時間範圍參數\n\n| 參數         | 類型                | 預設值          | 說明                                        |\n|--------------|---------------------|-----------------|---------------------------------------------|\n| `start_date` | string (YYYY-MM-DD) | today - 5 years | 取樣開始日。建議至少涵蓋 3 年以建立有效基準 |\n| `end_date`   | string (YYYY-MM-DD) | today           | 取樣結束日                                  |\n| `timeframe`  | string              | \"1d\"            | 價格頻率。支援：1d（日線）、1h（小時線）    |\n\n## ATR 計算參數\n\n| 參數              | 類型   | 預設值 | 說明                                                               |\n|-------------------|--------|--------|--------------------------------------------------------------------|\n| `atr_period`      | int    | 14     | ATR 計算週期。建議範圍：10-20                                      |\n| `atr_smoothing`   | string | \"ema\"  | ATR 平滑方法。支援：\"ema\"（指數移動平均）、\"wilder\"（Wilder 平滑） |\n| `use_percent_atr` | bool   | true   | 是否將 ATR 轉為百分比（ATR / Close * 100）                         |\n\n## 行情判定參數\n\n| 參數                     | 類型  | 預設值 | 說明                                                   |\n|--------------------------|-------|--------|--------------------------------------------------------|\n| `baseline_window_days`   | int   | 756    | 長期常態基準窗口。756 ≈ 3 年交易日                     |\n| `spike_threshold_x`      | float | 2.0    | ATR% 對基準的倍率門檻。超過此值視為擠壓風險            |\n| `high_vol_threshold_pct` | float | 6.0    | 絕對 ATR% 高波動門檻。需與倍率門檻同時滿足才判定為擠壓 |\n\n## 輔助指標參數\n\n| 參數                           | 類型 | 預設值 | 說明                                                  |\n|--------------------------------|------|--------|-------------------------------------------------------|\n| `rsi_period`                   | int  | 14     | RSI 週期。用於輔助判讀是否過熱                        |\n| `include_microstructure_notes` | bool | true   | 是否輸出「被迫流/保證金/期權避險/回補」的行情解釋模板 |\n\n## 輸出控制參數\n\n| 參數                 | 類型   | 預設值 | 說明                                   |\n|----------------------|--------|--------|----------------------------------------|\n| `output`             | string | null   | 輸出檔案路徑。若不指定則輸出到標準輸出 |\n| `format`             | string | \"json\" | 輸出格式。支援：\"json\"、\"markdown\"     |\n| `include_timeseries` | bool   | false  | 是否在輸出中包含完整時間序列           |\n\n## 批次模式參數\n\n| 參數       | 類型   | 預設值 | 說明                                                 |\n|------------|--------|--------|------------------------------------------------------|\n| `scan`     | string | null   | 批次掃描的資產清單（逗號分隔）。例：\"SI=F,GC=F,CL=F\" |\n| `monitor`  | bool   | false  | 是否進入持續監控模式                                 |\n| `interval` | int    | 3600   | 監控間隔（秒）。預設 1 小時                          |\n| `webhook`  | string | null   | 狀態變化時發送通知的 webhook URL                     |\n\n## 回測模式參數\n\n| 參數          | 類型   | 預設值      | 說明               |\n|---------------|--------|-------------|--------------------|\n| `backtest`    | bool   | false       | 是否執行回測模式   |\n| `plot`        | bool   | false       | 是否生成視覺化圖表 |\n| `plot_output` | string | \"chart.png\" | 圖表輸出路徑       |\n\n## 參數驗證規則\n\n### symbol\n- 必須是有效的資產代碼\n- Yahoo Finance 期貨格式：XXX=F（如 SI=F）\n- 外匯格式：XXXYYY（如 XAGUSD）\n\n### start_date / end_date\n- 格式：YYYY-MM-DD\n- start_date 必須早於 end_date\n- 建議 start_date 至少比所需分析期早 3 年\n\n### atr_period\n- 必須 > 0\n- 建議範圍：10-20\n- 小於 10 可能過於敏感\n- 大於 20 可能反應遲鈍\n\n### baseline_window_days\n- 必須 > atr_period\n- 建議至少 252（1 年）\n- 最佳值：756（3 年）\n\n### spike_threshold_x\n- 必須 > 1.0\n- 建議範圍：1.5-3.0\n- 較低值更敏感，較高值更保守\n\n### high_vol_threshold_pct\n- 必須 > 0\n- 需根據資產類型調整\n- 貴金屬建議：5-8%\n- 股指建議：3-5%\n- 外匯建議：2-4%\n\n## 命令行範例\n\n### 快速檢查\n\n```bash\npython atr_squeeze.py --symbol SI=F --quick\n```\n\n### 完整分析\n\n```bash\npython atr_squeeze.py \\\n  --symbol SI=F \\\n  --start 2020-01-01 \\\n  --end 2026-01-01 \\\n  --atr-period 14 \\\n  --atr-smoothing ema \\\n  --baseline-window 756 \\\n  --spike-threshold 2.0 \\\n  --high-vol-threshold 6.0 \\\n  --output result.json\n```\n\n### 批次掃描\n\n```bash\npython atr_squeeze.py \\\n  --scan SI=F,GC=F,CL=F,NG=F \\\n  --format markdown\n```\n\n### 回測模式\n\n```bash\npython atr_squeeze.py \\\n  --symbol SI=F \\\n  --start 2015-01-01 \\\n  --backtest \\\n  --plot \\\n  --output backtest.json \\\n  --plot-output chart.png\n```\n\n## 程式化呼叫\n\n```python\nfrom atr_squeeze import detect_atr_squeeze_regime\n\nresult = detect_atr_squeeze_regime(\n    symbol=\"SI=F\",\n    start_date=\"2020-01-01\",\n    end_date=\"2026-01-01\",\n    atr_period=14,\n    atr_smoothing=\"ema\",\n    use_percent_atr=True,\n    baseline_window_days=756,\n    spike_threshold_x=2.0,\n    high_vol_threshold_pct=6.0,\n    rsi_period=14,\n    include_microstructure_notes=True\n)\n\nprint(result[\"regime\"])\nprint(result[\"atr_pct\"])\nprint(result[\"atr_ratio_to_baseline\"])\n```\n",
        "skills/detect-atr-squeeze-regime/references/methodology.md": "# 波動擠壓行情偵測方法論\n\n## 概念來源\n\n本方法論基於 Saxo Bank 商品策略主管 Ole Hansen 對白銀市場的分析觀點。\n\n**核心洞察**：當資產的波動率（以 14 日 ATR% 衡量）顯著超過歷史常態時，市場進入「波動主導的擠壓行情」，此時：\n\n- 技術位（支撐/壓力）的可靠度下降\n- 停損容易被「噪音」掃掉\n- 價格運動更多反映「被迫流」而非基本面\n\n## ATR 百分比（ATR%）\n\n### 為何使用百分比？\n\n傳統 ATR 是絕對值（以價格單位計算），無法：\n- 跨資產比較（$30 的白銀 vs $2000 的黃金）\n- 建立「常態」基準\n- 判斷波動是否「異常」\n\n**解決方案**：將 ATR 轉換為收盤價的百分比\n\n```\nATR% = ATR / Close * 100\n```\n\n例如：\n- 白銀 ATR = $2.17，Close = $30.00 → ATR% = 7.23%\n- 黃金 ATR = $57.00，Close = $2000.00 → ATR% = 2.85%\n\n### ATR 計算方法\n\n**True Range（真實波幅）**：\n\n```\nTR = max(High - Low, |High - Prev_Close|, |Low - Prev_Close|)\n```\n\n**14 日 EMA 平滑**：\n\n```python\n# EMA 平滑（預設）\nATR = TR.ewm(span=14, adjust=False).mean()\n\n# Wilder 平滑（替代）\nATR = TR.ewm(alpha=1/14, adjust=False).mean()\n```\n\n## 基準期選擇\n\n### 為何選擇 3 年（756 交易日）？\n\n- **涵蓋週期**：3 年足以涵蓋多數資產的波動週期\n- **統計穩定**：樣本量足夠計算有意義的均值\n- **實用性**：不會因太長而對當前市場失去敏感度\n\n### 基準計算\n\n```python\nbaseline_atr_pct = atr_pct.rolling(756).mean()\nratio = current_atr_pct / baseline_atr_pct\n```\n\n## 三行情分類\n\n### 1. 秩序市場（Orderly Market）\n\n**條件**：ratio < 1.2\n\n**特徵**：\n- 波動在歷史常態範圍內\n- 技術分析有效\n- 停損可精準設置\n- 趨勢追蹤策略可靠\n\n**建議**：\n- 正常交易策略\n- 標準停損（1.0-1.5 ATR）\n- 任意時間框架\n\n### 2. 波動偏高趨勢（Elevated Volatility Trend）\n\n**條件**：1.2 <= ratio < 2.0\n\n**特徵**：\n- 波動高於常態但仍有結構\n- 技術位有效性下降\n- 方向性仍可辨識\n- 需要適應性調整\n\n**建議**：\n- 適度放寬停損（1.5-2.0 ATR）\n- 降低倉位規模\n- 偏向較長時間框架\n\n### 3. 波動主導的擠壓行情（Volatility-Dominated Squeeze）\n\n**條件**：ratio >= 2.0 AND atr_pct >= 6.0%\n\n**特徵**：\n- 波動遠超常態\n- 技術位失靈\n- 「被迫流」主導價格\n- 停損頻繁被掃\n\n**建議**：\n- 大幅放寬停損（2.0-3.0 ATR）\n- 顯著降低倉位\n- 切換到週線以上\n- 使用期權/價差結構\n\n## 反身性機制\n\n### 什麼是「被迫流」？\n\n在擠壓行情下，價格運動不再主要反映：\n- 基本面變化\n- 技術面突破\n- 市場共識改變\n\n而是被以下「被迫流」主導：\n\n1. **保證金調整**\n   - 波動上升 → 保證金要求提高\n   - 無法追加保證金的部位被強制平倉\n\n2. **槓桿去化**\n   - 高槓桿投機者被迫減倉\n   - 連鎖反應放大波動\n\n3. **期權避險**\n   - Delta/Gamma 避險需求\n   - 價格接近執行價時避險量激增\n   - 正反饋循環\n\n4. **空頭回補**\n   - 空頭停損觸發\n   - 「軋空」放大上漲\n\n5. **被動再平衡**\n   - 風險平價/目標波動率策略\n   - 波動上升時自動減倉\n   - 加劇賣壓\n\n### 為何技術位失靈？\n\n技術分析的前提是：\n> 支撐/壓力位反映市場參與者的共識\n\n但在擠壓行情下：\n> 價格突破更多是流動性事件的結果，而非共識改變\n\n例如：\n- 白銀跌破 $28 支撐\n- 不是因為市場轉空\n- 而是因為大量停損單在該位置被觸發\n- 價格可能在數小時內收回\n\n## 技術位可靠度評分\n\n### 計算公式\n\n```python\ndef calculate_reliability_score(regime: str, ratio: float) -> int:\n    if regime == \"volatility_dominated_squeeze\":\n        # 2.0x -> 50分, 4.5x -> 0分\n        score = max(0, int(50 - (ratio - 2.0) * 20))\n    elif regime == \"elevated_volatility_trend\":\n        # 1.2x -> 100分, 2.0x -> 50分\n        score = int(50 + (2.0 - ratio) * 50 / 0.8)\n    else:\n        # 0.8x -> 100分, 1.2x -> 90分\n        score = int(100 - (ratio - 0.8) * 25)\n\n    return max(0, min(100, score))\n```\n\n### 解讀\n\n| 分數   | 等級 | 意義                 |\n|--------|------|----------------------|\n| 80-100 | 高   | 技術分析高度可靠     |\n| 50-79  | 中   | 需謹慎使用，放寬容忍 |\n| 20-49  | 低   | 技術位參考價值有限   |\n| 0-19   | 極低 | 視技術位為噪音       |\n\n## 實際案例\n\n### 白銀 2020 年 3 月（COVID-19）\n\n- ATR% 峰值：12.45%\n- Ratio 峰值：4.15x\n- 持續：37 天\n- 特徵：恐慌性拋售 + 流動性枯竭\n\n### 白銀 2024 年 8 月（日圓套利平倉）\n\n- ATR% 峰值：8.92%\n- Ratio 峰值：2.97x\n- 持續：37 天\n- 特徵：跨資產去槓桿連鎖反應\n\n## 局限性\n\n1. **滯後性**：ATR 是滯後指標，擠壓開始時才會偵測到\n2. **閾值敏感**：2.0x 和 6.0% 的門檻是經驗值，非普適\n3. **基準污染**：若基準期本身包含異常期間，判定會失準\n4. **資產差異**：不同資產的「正常」波動水平不同\n\n## 參考資料\n\n- Ole Hansen, Saxo Bank Commodity Strategy\n- True Range: J. Welles Wilder, \"New Concepts in Technical Trading Systems\" (1978)\n- 反身性理論: George Soros, \"The Alchemy of Finance\" (1987)\n",
        "skills/detect-atr-squeeze-regime/templates/output-json.md": "# JSON 輸出結構定義\n\n## 單資產偵測輸出\n\n```json\n{\n  \"skill\": \"detect-atr-squeeze-regime\",\n  \"symbol\": \"SI=F\",\n  \"as_of\": \"2026-01-14\",\n  \"data_range\": {\n    \"start\": \"2021-01-14\",\n    \"end\": \"2026-01-14\",\n    \"trading_days\": 1260\n  },\n  \"regime\": \"volatility_dominated_squeeze\",\n  \"atr_pct\": 7.23,\n  \"atr_ratio_to_baseline\": 2.41,\n  \"baseline_atr_pct\": 3.0,\n  \"baseline_period_days\": 756,\n  \"tech_level_reliability\": \"low\",\n  \"tech_level_reliability_score\": 28,\n  \"risk_adjustments\": {\n    \"suggested_stop_atr_mult\": 2.5,\n    \"position_scale\": 0.41,\n    \"recommended_timeframe\": \"weekly\",\n    \"instrument_suggestion\": \"options_or_spreads\"\n  },\n  \"interpretation\": {\n    \"regime_explanation\": \"當前市場處於「波動主導的擠壓行情」。價格運動更多反映「被迫流」：保證金調整、期權避險、空頭回補。技術位可靠度下降，停損容易被噪音掃掉。\",\n    \"tactics\": [\n      \"偏向較長週期決策，降低被日內噪音主導的風險。\",\n      \"若要參與趨勢，優先考慮 defined-risk（期權/價差）結構。\",\n      \"避免緊停損的短線交易，結構性受損。\"\n    ]\n  },\n  \"auxiliary_indicators\": {\n    \"rsi_14\": 72.5,\n    \"atr_change_5d_pct\": 15.2,\n    \"regime_duration_days\": 12\n  },\n  \"metadata\": {\n    \"generated_at\": \"2026-01-14T10:30:00Z\",\n    \"parameters\": {\n      \"atr_period\": 14,\n      \"atr_smoothing\": \"ema\",\n      \"baseline_window_days\": 756,\n      \"spike_threshold_x\": 2.0,\n      \"high_vol_threshold_pct\": 6.0\n    }\n  }\n}\n```\n\n## 欄位說明\n\n### 核心欄位\n\n| 欄位                           | 類型    | 說明                                                                                      |\n|--------------------------------|---------|-------------------------------------------------------------------------------------------|\n| `skill`                        | string  | 技能名稱                                                                                  |\n| `symbol`                       | string  | 資產代碼                                                                                  |\n| `as_of`                        | string  | 分析截至日期                                                                              |\n| `regime`                       | string  | 行情判定：`orderly_market` / `elevated_volatility_trend` / `volatility_dominated_squeeze` |\n| `atr_pct`                      | number  | 當前 ATR%（百分比）                                                                       |\n| `atr_ratio_to_baseline`        | number  | ATR% 對基準的倍率                                                                         |\n| `baseline_atr_pct`             | number  | 3 年滾動基準 ATR%                                                                         |\n| `tech_level_reliability`       | string  | 技術位可靠度：`high` / `medium` / `low`                                                   |\n| `tech_level_reliability_score` | integer | 技術位可靠度評分（0-100）                                                                 |\n\n### risk_adjustments 物件\n\n| 欄位                      | 類型   | 說明                                              |\n|---------------------------|--------|---------------------------------------------------|\n| `suggested_stop_atr_mult` | number | 建議停損倍數（ATR 倍數）                          |\n| `position_scale`          | number | 建議倉位縮放係數（0-1）                           |\n| `recommended_timeframe`   | string | 建議時間框架：`any` / `daily` / `weekly`          |\n| `instrument_suggestion`   | string | 工具建議：`naked_position` / `options_or_spreads` |\n\n### interpretation 物件\n\n| 欄位                 | 類型          | 說明         |\n|----------------------|---------------|--------------|\n| `regime_explanation` | string        | 行情解釋文字 |\n| `tactics`            | array[string] | 戰術建議清單 |\n\n### auxiliary_indicators 物件（可選）\n\n| 欄位                   | 類型    | 說明               |\n|------------------------|---------|--------------------|\n| `rsi_14`               | number  | 14 日 RSI          |\n| `atr_change_5d_pct`    | number  | ATR% 5 日變化率    |\n| `regime_duration_days` | integer | 當前行情已持續天數 |\n\n---\n\n## 批次掃描輸出\n\n```json\n{\n  \"skill\": \"detect-atr-squeeze-regime\",\n  \"scan_mode\": true,\n  \"as_of\": \"2026-01-14\",\n  \"scan_results\": [\n    {\n      \"symbol\": \"SI=F\",\n      \"regime\": \"volatility_dominated_squeeze\",\n      \"atr_pct\": 7.23,\n      \"ratio\": 2.41,\n      \"reliability_score\": 28,\n      \"suggested_stop_mult\": 2.5\n    },\n    {\n      \"symbol\": \"GC=F\",\n      \"regime\": \"orderly_market\",\n      \"atr_pct\": 2.85,\n      \"ratio\": 1.15,\n      \"reliability_score\": 85,\n      \"suggested_stop_mult\": 1.2\n    },\n    {\n      \"symbol\": \"CL=F\",\n      \"regime\": \"elevated_volatility_trend\",\n      \"atr_pct\": 4.12,\n      \"ratio\": 1.48,\n      \"reliability_score\": 62,\n      \"suggested_stop_mult\": 1.8\n    }\n  ],\n  \"summary\": {\n    \"total_assets\": 3,\n    \"squeeze_count\": 1,\n    \"elevated_count\": 1,\n    \"orderly_count\": 1,\n    \"highest_ratio\": {\n      \"symbol\": \"SI=F\",\n      \"ratio\": 2.41\n    },\n    \"lowest_ratio\": {\n      \"symbol\": \"GC=F\",\n      \"ratio\": 1.15\n    }\n  },\n  \"alerts\": [\n    {\n      \"type\": \"squeeze_detected\",\n      \"symbol\": \"SI=F\",\n      \"message\": \"SI=F 處於擠壓行情，建議降槓桿\"\n    }\n  ]\n}\n```\n\n---\n\n## 回測輸出\n\n```json\n{\n  \"skill\": \"detect-atr-squeeze-regime\",\n  \"backtest_mode\": true,\n  \"symbol\": \"SI=F\",\n  \"backtest_period\": {\n    \"start\": \"2015-01-01\",\n    \"end\": \"2026-01-14\"\n  },\n  \"data_points\": 2778,\n  \"regime_distribution\": {\n    \"orderly_market\": {\n      \"days\": 1945,\n      \"pct\": 70.0\n    },\n    \"elevated_volatility_trend\": {\n      \"days\": 611,\n      \"pct\": 22.0\n    },\n    \"volatility_dominated_squeeze\": {\n      \"days\": 222,\n      \"pct\": 8.0\n    }\n  },\n  \"squeeze_periods\": [\n    {\n      \"start\": \"2020-03-09\",\n      \"end\": \"2020-04-15\",\n      \"duration_days\": 37,\n      \"peak_atr_pct\": 12.45,\n      \"peak_ratio\": 4.15,\n      \"peak_date\": \"2020-03-16\",\n      \"context\": \"COVID-19 市場恐慌\"\n    },\n    {\n      \"start\": \"2024-07-22\",\n      \"end\": \"2024-08-28\",\n      \"duration_days\": 37,\n      \"peak_atr_pct\": 8.92,\n      \"peak_ratio\": 2.97,\n      \"peak_date\": \"2024-08-05\",\n      \"context\": \"日圓套利平倉風暴\"\n    }\n  ],\n  \"statistics\": {\n    \"total_squeeze_periods\": 5,\n    \"avg_duration_days\": 44.4,\n    \"max_duration_days\": 67,\n    \"min_duration_days\": 18,\n    \"avg_peak_atr_pct\": 9.8,\n    \"avg_peak_ratio\": 3.27,\n    \"max_peak_ratio\": 4.15\n  },\n  \"event_matching\": {\n    \"known_events_matched\": 4,\n    \"known_events_total\": 5,\n    \"match_rate\": 0.80,\n    \"matched_events\": [\n      \"COVID-19 (2020-03)\",\n      \"俄烏戰爭 (2022-03)\",\n      \"銀行危機 (2023-03)\",\n      \"日圓平倉 (2024-08)\"\n    ],\n    \"missed_events\": [\n      \"2022-09 英國養老金危機（影響較小）\"\n    ]\n  },\n  \"timeseries\": {\n    \"included\": false,\n    \"note\": \"使用 --include-timeseries 以包含完整時間序列\"\n  }\n}\n```\n\n---\n\n## 時間序列輸出（可選）\n\n若使用 `--include-timeseries`：\n\n```json\n{\n  \"timeseries\": {\n    \"included\": true,\n    \"columns\": [\"date\", \"close\", \"atr\", \"atr_pct\", \"baseline\", \"ratio\", \"regime\"],\n    \"data\": [\n      [\"2026-01-10\", 30.15, 2.12, 7.03, 3.01, 2.34, \"volatility_dominated_squeeze\"],\n      [\"2026-01-11\", 29.82, 2.15, 7.21, 3.01, 2.40, \"volatility_dominated_squeeze\"],\n      [\"2026-01-14\", 30.00, 2.17, 7.23, 3.00, 2.41, \"volatility_dominated_squeeze\"]\n    ]\n  }\n}\n```\n",
        "skills/detect-atr-squeeze-regime/templates/output-markdown.md": "# Markdown 報告模板\n\n## 單資產偵測報告\n\n```markdown\n# {symbol} 波動擠壓行情偵測結果\n\n**分析日期**：{as_of}\n\n## 當前狀態\n\n| 指標            | 數值                | 狀態             |\n|-----------------|---------------------|------------------|\n| 當前 ATR%       | {atr_pct}%          | {atr_pct_status} |\n| ATR% 對基準倍率 | {ratio}x            | {ratio_status}   |\n| 3 年基準 ATR%   | {baseline_atr_pct}% | 常態參照值       |\n\n## 行情判定\n\n**{regime_display}**\n\n技術位可靠度評分：**{reliability_score}/100**（{reliability_level}）\n\n## 風控調整建議\n\n| 調整項目 | 當前建議          | 秩序市場參照 |\n|----------|-------------------|--------------|\n| 停損倍數 | {stop_mult}x ATR  | 1.0-1.5x ATR |\n| 倉位縮放 | {position_scale}x | 1.0x         |\n| 時間框架 | {timeframe}       | 任意         |\n| 工具選擇 | {instrument}      | 裸倉位       |\n\n## 行情解讀\n\n{regime_explanation}\n\n## 戰術建議\n\n{tactics_list}\n\n---\n\n*由 detect-atr-squeeze-regime 技能生成*\n```\n\n---\n\n## 批次掃描報告\n\n```markdown\n# 多資產 ATR 擠壓行情掃描報告\n\n**掃描日期**：{as_of}\n**掃描資產**：{total_assets} 個\n\n## 掃描結果\n\n| Symbol | ATR% | Ratio | 行情 | 信任度 | 建議停損 |\n|--------|------|-------|------|--------|----------|\n{scan_table_rows}\n\n## 摘要\n\n- **擠壓行情**：{squeeze_count} 個資產\n- **波動偏高**：{elevated_count} 個資產\n- **秩序市場**：{orderly_count} 個資產\n\n### 最需關注\n\n- 最高倍率：{highest_ratio_symbol}（{highest_ratio}x）\n- 最低倍率：{lowest_ratio_symbol}（{lowest_ratio}x）\n\n## 建議\n\n### 擠壓行情資產\n{squeeze_recommendations}\n\n### 波動偏高資產\n{elevated_recommendations}\n\n### 秩序市場資產\n{orderly_recommendations}\n\n---\n\n*由 detect-atr-squeeze-regime 技能生成*\n```\n\n---\n\n## 回測報告\n\n```markdown\n# {symbol} ATR 擠壓行情回測報告\n\n**回測期間**：{start_date} 至 {end_date}\n**資料點數**：{data_points}\n\n## 行情分布\n\n| 行情     | 天數            | 佔比            |\n|----------|-----------------|-----------------|\n| 秩序市場 | {orderly_days}  | {orderly_pct}%  |\n| 波動偏高 | {elevated_days} | {elevated_pct}% |\n| 擠壓行情 | {squeeze_days}  | {squeeze_pct}%  |\n\n## 擠壓期間清單\n\n| # | 起始 | 結束 | 天數 | 峰值 ATR% | 峰值倍率 | 事件 |\n|---|------|------|------|-----------|----------|------|\n{squeeze_periods_table}\n\n## 統計指標\n\n| 指標          | 數值                    |\n|---------------|-------------------------|\n| 擠壓期間總數  | {total_squeeze_periods} |\n| 平均持續天數  | {avg_duration}          |\n| 最長持續天數  | {max_duration}          |\n| 平均峰值 ATR% | {avg_peak_atr}%         |\n| 平均峰值倍率  | {avg_peak_ratio}x       |\n\n## 事件匹配\n\n- 已知事件匹配：{matched}/{total}（{match_rate}%）\n- 匹配事件：{matched_events}\n- 遺漏事件：{missed_events}\n\n## 關鍵觀察\n\n{observations}\n\n---\n\n*由 detect-atr-squeeze-regime 技能生成*\n```\n\n---\n\n## 填充範例\n\n### 行情顯示對照\n\n| regime                         | regime_display                                     |\n|--------------------------------|----------------------------------------------------|\n| `orderly_market`               | 秩序市場（Orderly Market）                         |\n| `elevated_volatility_trend`    | 波動偏高趨勢（Elevated Volatility Trend）          |\n| `volatility_dominated_squeeze` | 波動主導的擠壓行情（Volatility-Dominated Squeeze） |\n\n### ATR% 狀態判定\n\n```python\nif atr_pct >= high_vol_threshold_pct:\n    atr_pct_status = f\"高於高波動門檻（{high_vol_threshold_pct}%）\"\nelif atr_pct >= baseline * 1.5:\n    atr_pct_status = \"偏高\"\nelse:\n    atr_pct_status = \"正常範圍\"\n```\n\n### Ratio 狀態判定\n\n```python\nif ratio >= spike_threshold_x:\n    ratio_status = f\"高於擠壓門檻（{spike_threshold_x}x）\"\nelif ratio >= 1.2:\n    ratio_status = \"偏高\"\nelse:\n    ratio_status = \"正常範圍\"\n```\n\n### 可靠度等級\n\n| reliability_score | reliability_level |\n|-------------------|-------------------|\n| 80-100            | 高                |\n| 50-79             | 中                |\n| 20-49             | 低                |\n| 0-19              | 極低              |\n\n### 時間框架建議\n\n| regime                         | timeframe |\n|--------------------------------|-----------|\n| `orderly_market`               | 任意      |\n| `elevated_volatility_trend`    | 日線以上  |\n| `volatility_dominated_squeeze` | 週線以上  |\n\n### 工具建議\n\n| regime                         | instrument    |\n|--------------------------------|---------------|\n| `orderly_market`               | 裸倉位        |\n| `elevated_volatility_trend`    | 裸倉位或期權  |\n| `volatility_dominated_squeeze` | 期權/價差結構 |\n\n### 戰術清單格式\n\n```markdown\n1. 偏向較長週期決策，降低被日內噪音主導的風險。\n2. 若要參與趨勢，優先考慮 defined-risk（期權/價差）結構。\n3. 避免緊停損的短線交易，結構性受損。\n```\n",
        "skills/detect-atr-squeeze-regime/workflows/backtest.md": "# 歷史回測工作流\n\n回溯識別過去的擠壓行情期間，評估識別準確性與持續時間統計。\n\n## 前置條件\n\n- 使用者提供了資產代碼和回測期間\n- 建議至少 5 年數據以涵蓋多個週期\n\n## 步驟\n\n### Step 1: 確認參數\n\n| 參數        | 說明       | 預設值               |\n|-------------|------------|----------------------|\n| symbol      | 資產代碼   | SI=F                 |\n| start_date  | 回測起始日 | 2015-01-01           |\n| end_date    | 回測結束日 | today                |\n| output_file | 輸出檔案   | backtest_result.json |\n\n### Step 2: 執行回測\n\n```bash\ncd skills/detect-atr-squeeze-regime\npython scripts/atr_squeeze.py \\\n  --symbol SI=F \\\n  --start 2015-01-01 \\\n  --end 2026-01-01 \\\n  --backtest \\\n  --output backtest_result.json\n```\n\n### Step 3: 識別擠壓期間\n\n腳本會輸出所有識別到的擠壓期間：\n\n```json\n{\n  \"squeeze_periods\": [\n    {\n      \"start\": \"2020-03-09\",\n      \"end\": \"2020-04-15\",\n      \"duration_days\": 37,\n      \"peak_atr_pct\": 12.45,\n      \"peak_ratio\": 4.15,\n      \"peak_date\": \"2020-03-16\",\n      \"context\": \"COVID-19 市場恐慌\"\n    },\n    {\n      \"start\": \"2024-07-22\",\n      \"end\": \"2024-08-28\",\n      \"duration_days\": 37,\n      \"peak_atr_pct\": 8.92,\n      \"peak_ratio\": 2.97,\n      \"peak_date\": \"2024-08-05\",\n      \"context\": \"日圓套利平倉風暴\"\n    }\n  ]\n}\n```\n\n### Step 4: 計算統計指標\n\n**擠壓期間統計**：\n\n| 指標          | 數值   |\n|---------------|--------|\n| 擠壓期間總數  | N      |\n| 平均持續天數  | X days |\n| 最長持續天數  | Y days |\n| 平均峰值 ATR% | Z%     |\n| 平均峰值倍率  | W x    |\n\n**行情分布**：\n\n| 行情                         | 佔比 | 天數 |\n|------------------------------|------|------|\n| orderly_market               | 70%  | 2555 |\n| elevated_volatility_trend    | 22%  | 803  |\n| volatility_dominated_squeeze | 8%   | 292  |\n\n### Step 5: 與重大事件對照\n\n將識別的擠壓期間與已知市場事件對照：\n\n| 期間    | 事件          | 匹配 |\n|---------|---------------|------|\n| 2020-03 | COVID-19 崩盤 | YES  |\n| 2022-03 | 俄烏戰爭爆發  | YES  |\n| 2024-08 | 日圓套利平倉  | YES  |\n\n### Step 6: 生成回測報告\n\n報告結構：\n\n1. **回測摘要**\n   - 回測期間\n   - 資料點數量\n   - 行情分布統計\n\n2. **擠壓期間清單**\n   - 起止日期\n   - 持續天數\n   - 峰值數據\n   - 事件背景\n\n3. **視覺化圖表**（可選）\n   - ATR% 時間序列\n   - 行情標記條帶\n   - 峰值標註\n\n4. **準確性評估**\n   - 與已知事件的匹配率\n   - 假陽性/假陰性分析\n\n## 回測輸出範例\n\n```json\n{\n  \"skill\": \"detect-atr-squeeze-regime\",\n  \"symbol\": \"SI=F\",\n  \"backtest_period\": {\n    \"start\": \"2015-01-01\",\n    \"end\": \"2026-01-14\"\n  },\n  \"data_points\": 2778,\n  \"regime_distribution\": {\n    \"orderly_market\": {\"days\": 1945, \"pct\": 70.0},\n    \"elevated_volatility_trend\": {\"days\": 611, \"pct\": 22.0},\n    \"volatility_dominated_squeeze\": {\"days\": 222, \"pct\": 8.0}\n  },\n  \"squeeze_periods\": [...],\n  \"statistics\": {\n    \"total_squeeze_periods\": 5,\n    \"avg_duration_days\": 44.4,\n    \"max_duration_days\": 67,\n    \"avg_peak_atr_pct\": 9.8,\n    \"avg_peak_ratio\": 3.27\n  },\n  \"known_events_matched\": 4,\n  \"known_events_total\": 5,\n  \"match_rate\": 0.80\n}\n```\n\n## 視覺化輸出\n\n若安裝了 matplotlib：\n\n```bash\npython scripts/atr_squeeze.py --symbol SI=F --backtest --plot --output chart.png\n```\n\n圖表包含：\n- 上圖：價格走勢\n- 中圖：ATR% 與基準\n- 下圖：行情條帶（紅=squeeze, 黃=elevated, 綠=orderly）\n\n## 注意事項\n\n- 回測使用「預知」的 3 年基準，實際交易時基準是滾動計算的\n- 邊界效應：前 756 天（約 3 年）無法計算有效基準\n- 建議從 start_date 前額外取 3 年數據以避免邊界問題\n",
        "skills/detect-atr-squeeze-regime/workflows/detect.md": "# 單資產偵測工作流\n\n偵測單一資產是否處於 ATR 擠壓行情。\n\n## 前置條件\n\n- 使用者提供了資產代碼（symbol）\n- 或使用預設資產（SI=F 白銀期貨）\n\n## 步驟\n\n### Step 1: 確認參數\n\n從使用者輸入解析以下參數：\n\n| 參數       | 來源       | 預設值          |\n|------------|------------|-----------------|\n| symbol     | 使用者提供 | SI=F            |\n| start_date | 使用者提供 | today - 5 years |\n| end_date   | 使用者提供 | today           |\n| timeframe  | 使用者提供 | 1d              |\n\n若使用者未提供，使用預設值。\n\n### Step 2: 執行偵測腳本\n\n```bash\ncd skills/detect-atr-squeeze-regime\npython scripts/atr_squeeze.py \\\n  --symbol {symbol} \\\n  --start {start_date} \\\n  --end {end_date} \\\n  --timeframe {timeframe}\n```\n\n### Step 3: 解讀輸出\n\n腳本輸出 JSON 格式結果，包含：\n\n```json\n{\n  \"symbol\": \"SI=F\",\n  \"as_of\": \"2026-01-14\",\n  \"regime\": \"volatility_dominated_squeeze\",\n  \"atr_pct\": 7.23,\n  \"atr_ratio_to_baseline\": 2.41,\n  \"baseline_atr_pct\": 3.0,\n  \"tech_level_reliability\": \"low\",\n  \"tech_level_reliability_score\": 28,\n  \"risk_adjustments\": {\n    \"suggested_stop_atr_mult\": 2.5,\n    \"position_scale\": 0.41,\n    \"recommended_timeframe\": \"weekly\",\n    \"instrument_suggestion\": \"options_or_spreads\"\n  },\n  \"interpretation\": {\n    \"regime_explanation\": \"...\",\n    \"tactics\": [\"...\", \"...\"]\n  },\n  \"rsi\": 72.5\n}\n```\n\n### Step 4: 生成報告\n\n根據 `templates/output-markdown.md` 模板格式化報告。\n\n報告應包含：\n\n1. **當前狀態表格**\n   - ATR% 數值\n   - 對基準倍率\n   - 行情判定\n\n2. **技術位可靠度評分**\n   - 0-100 分\n   - 對應文字描述（高/中/低）\n\n3. **風控調整建議**\n   - 停損倍數\n   - 倉位縮放\n   - 時間框架建議\n   - 工具選擇建議\n\n4. **行情解讀**\n   - 當前市場特徵\n   - 被迫流解釋（如適用）\n\n5. **戰術建議清單**\n\n## 行情判定邏輯\n\n```python\nif atr_pct >= 6.0 and ratio >= 2.0:\n    regime = \"volatility_dominated_squeeze\"\n    reliability = \"low\"\nelif ratio >= 1.2:\n    regime = \"elevated_volatility_trend\"\n    reliability = \"medium\"\nelse:\n    regime = \"orderly_market\"\n    reliability = \"high\"\n```\n\n## 技術位可靠度評分\n\n```python\nif regime == \"volatility_dominated_squeeze\":\n    score = max(0, 50 - (ratio - 2.0) * 20)  # 2.0x -> 50, 4.5x -> 0\nelif regime == \"elevated_volatility_trend\":\n    score = 50 + (2.0 - ratio) * 50 / 0.8   # 1.2x -> 100, 2.0x -> 50\nelse:\n    score = 100 - (ratio - 0.8) * 25        # 0.8x -> 100, 1.2x -> 90\n```\n\n## 風控建議規則\n\n| Regime   | 停損倍數    | 倉位縮放 | 時間框架 | 工具         |\n|----------|-------------|----------|----------|--------------|\n| orderly  | 1.0-1.5 ATR | 1.0      | 任意     | 裸倉位       |\n| elevated | 1.5-2.0 ATR | 0.6-0.8  | 日線以上 | 裸倉位或期權 |\n| squeeze  | 2.0-3.0 ATR | 0.3-0.5  | 週線以上 | 期權/價差    |\n\n## 錯誤處理\n\n- 若無法取得資料，提示使用者檢查 symbol 是否正確\n- 若資料不足（< 756 天），警告基準期可能不準確\n- 若 yfinance 失敗，建議使用 Stooq 替代\n\n## 輸出範例\n\n見 `examples/xagusd-squeeze-2024.json`\n",
        "skills/detect-atr-squeeze-regime/workflows/monitor.md": "# 多資產監控工作流\n\n持續監控多個資產的 ATR 擠壓行情狀態，識別進入或退出擠壓行情的資產。\n\n## 前置條件\n\n- 使用者提供了資產清單\n- 或使用預設的貴金屬/能源清單\n\n## 預設監控清單\n\n### 貴金屬\n- SI=F（白銀期貨）\n- GC=F（黃金期貨）\n\n### 能源\n- CL=F（原油期貨）\n- NG=F（天然氣期貨）\n\n### 股指期貨\n- ES=F（S&P 500 期貨）\n- NQ=F（Nasdaq 100 期貨）\n\n## 步驟\n\n### Step 1: 確認監控清單\n\n從使用者輸入解析資產清單：\n\n```\n--scan SI=F,GC=F,CL=F\n```\n\n或使用預設清單。\n\n### Step 2: 批次執行偵測\n\n```bash\ncd skills/detect-atr-squeeze-regime\npython scripts/atr_squeeze.py --scan SI=F,GC=F,CL=F,NG=F\n```\n\n### Step 3: 彙整結果\n\n輸出格式：\n\n```json\n{\n  \"scan_results\": [\n    {\n      \"symbol\": \"SI=F\",\n      \"regime\": \"volatility_dominated_squeeze\",\n      \"atr_pct\": 7.23,\n      \"ratio\": 2.41,\n      \"reliability_score\": 28\n    },\n    {\n      \"symbol\": \"GC=F\",\n      \"regime\": \"orderly_market\",\n      \"atr_pct\": 2.85,\n      \"ratio\": 1.15,\n      \"reliability_score\": 85\n    }\n  ],\n  \"summary\": {\n    \"squeeze_count\": 1,\n    \"elevated_count\": 1,\n    \"orderly_count\": 2,\n    \"highest_ratio\": {\"symbol\": \"SI=F\", \"ratio\": 2.41},\n    \"lowest_ratio\": {\"symbol\": \"GC=F\", \"ratio\": 1.15}\n  }\n}\n```\n\n### Step 4: 生成摘要表格\n\n```\n┌────────┬────────┬────────┬─────────────────────────────┬──────────┐\n│ Symbol │ ATR%   │ Ratio  │ Regime                      │ 信任度   │\n├────────┼────────┼────────┼─────────────────────────────┼──────────┤\n│ SI=F   │ 7.23%  │ 2.41x  │ volatility_dominated_squeeze│ 28       │\n│ GC=F   │ 2.85%  │ 1.15x  │ orderly_market              │ 85       │\n│ CL=F   │ 4.12%  │ 1.48x  │ elevated_volatility_trend   │ 62       │\n│ NG=F   │ 5.80%  │ 1.95x  │ elevated_volatility_trend   │ 52       │\n└────────┴────────┴────────┴─────────────────────────────┴──────────┘\n```\n\n### Step 5: 識別警報條件\n\n標記以下情況：\n\n1. **新進入擠壓行情**\n   - 前一日為 elevated 或 orderly\n   - 今日為 squeeze\n\n2. **退出擠壓行情**\n   - 前一日為 squeeze\n   - 今日為 elevated 或 orderly\n\n3. **極端倍率**\n   - ratio > 3.0（極端警報）\n\n4. **倍率快速上升**\n   - 5 日內 ratio 上升 > 0.5\n\n### Step 6: 生成建議\n\n對每個行情狀態的資產給出對應建議：\n\n**擠壓行情資產**：\n- 降槓桿、放寬停損、改用期權\n- 避免短線交易\n\n**波動偏高資產**：\n- 適度放寬停損\n- 注意波動擴大風險\n\n**秩序市場資產**：\n- 正常交易策略可用\n- 技術分析有效\n\n## 持續監控模式\n\n若使用者要求持續監控：\n\n```bash\npython scripts/atr_squeeze.py --monitor --interval 3600 --webhook URL\n```\n\n- `--interval`：檢查間隔（秒）\n- `--webhook`：狀態變化時發送通知\n\n## 輸出報告結構\n\n1. **掃描摘要表格**\n2. **按行情分組的資產清單**\n3. **最需關注的資產**（ratio 最高）\n4. **整體建議**\n\n## 錯誤處理\n\n- 若某個 symbol 無法取得資料，跳過並記錄警告\n- 繼續處理其他資產\n- 在最終報告中標註失敗的資產\n",
        "skills/detect-fed-unamortized-discount-pattern/SKILL.md": "---\nname: detect-fed-unamortized-discount-pattern\ndescription: 檢查聯準會持有證券的未攤銷折價（Unamortized Discounts）是否出現與特定歷史危機期間相似的走勢模板，並用多指標交叉驗證是否真的屬於「金融壓力升高」而非單純會計/利率效果。\n---\n\n<essential_principles>\n\n<principle name=\"pattern_matching_not_prediction\">\n**形狀比對 ≠ 事件預測**\n\n核心認知：把「肉眼類比」轉成可量化的「形狀比對」，但「像」不等於「會發生」：\n- **相關係數 (corr)**：近期窗口 vs. 基準窗口的線性形狀相似\n- **動態時間校正 (DTW)**：允許「快一點/慢一點」但形狀相似\n- **形狀特徵 (shape_features)**：趨勢斜率、拐點結構、波動擴張\n\n輸出「pattern_similarity_score」只回答「像不像」，不回答「會不會發生」。\n</principle>\n\n<principle name=\"cross_validation_stress\">\n**壓力驗證才能升級風險判斷**\n\n把「形狀相似」與「壓力驗證」拆開：\n1. **pattern_similarity_score**：只測量形狀相似度\n2. **stress_confirmation_score**：測量交叉驗證指標是否同步惡化\n3. **composite_risk_score**：加權合成，但必須附上「哪些指標支持/反對」\n\n**反直覺檢查**：\n- 若相似度很高，但交叉驗證指標沒有壓力訊號 → 可能只是利率/持有結構/會計攤銷造成的圖形相似\n- 若相似度中等，但多數壓力指標同步惡化 → 反而要提高警覺\n</principle>\n\n<principle name=\"data_mechanism_understanding\">\n**理解指標背後機制**\n\n**WUDSHO（Unamortized Discounts）成因**：\n- 聯準會購買債券時，若買入價低於面值，差額計為「未攤銷折價」\n- 利率上升期：市價下跌 → 購入債券折價增加 → WUDSHO 上升\n- 利率下降期：市價上升 → 購入債券溢價增加 → WUDSHO 下降\n\n**重要**：WUDSHO 變動可能反映：\n1. 利率環境變化（最常見）\n2. 持有債券久期結構\n3. 會計攤銷時程\n4. **真正的金融壓力**（需交叉驗證才能確認）\n</principle>\n\n<principle name=\"falsification_mindset\">\n**反證優先的分析框架**\n\n社群常見的「圖形類比敘事」往往缺乏反證：\n- ❌「這條線複製 COVID，60 天內黑天鵝」→ 只有類比，沒有驗證\n- ✅ 本技能輸出：「形狀相似度 0.88，但信用利差中性、股市波動偏低 → 不支持系統性壓力假說」\n\n必須輸出的反證項目：\n1. 「形狀相似」的替代解釋（利率效果、會計效果）\n2. 「壓力指標」的現況（支持/反對風險假說）\n3. 「歷史後續」的條件分布（不是預測）\n</principle>\n\n<principle name=\"public_data_transparency\">\n**公開資料來源與限制**\n\n本技能使用 FRED 公開週資料：\n- **WUDSHO**: Fed 持有證券的未攤銷折價\n- **交叉驗證指標**：信用利差、波動率、短端利差等\n\n**必須揭露**：\n- FRED 週資料可能有 T+1 ~ T+3 延遲\n- 部分指標（如窗口工具用量）需要替代代理\n- 形狀比對結果受 resample 頻率影響\n</principle>\n\n</essential_principles>\n\n<objective>\n偵測聯準會未攤銷折價走勢是否與歷史危機期間相似：\n\n1. **取得目標序列**：從 FRED 取得 WUDSHO（或指定序列）的週資料\n2. **窗口比對**：將近期窗口與歷史基準窗口（如 COVID 2020）做形狀比對\n3. **相似度計算**：使用相關係數、DTW、形狀特徵等多種方法\n4. **交叉驗證**：檢查信用利差、波動率、流動性指標是否同步惡化\n5. **風險分數合成**：輸出可量化的風險分數與反證分析\n6. **情境敘事**：描述歷史類比後續發展（非預測）\n\n輸出：形狀相似度、壓力驗證分數、合成風險分數、反證分析、情境推演。\n</objective>\n\n<quick_start>\n\n**最快的方式：執行完整分析**\n\n```bash\ncd skills/detect-fed-unamortized-discount-pattern\npip install pandas numpy requests scipy matplotlib  # 首次使用\npython scripts/pattern_detector.py --quick\n```\n\n輸出：\n- `output/pattern_analysis_YYYY-MM-DD.json` - JSON 結果\n\n**完整分析（指定參數）**：\n```bash\npython scripts/pattern_detector.py \\\n  --target_series WUDSHO \\\n  --baseline_windows \"COVID_2020:2020-01-01:2020-06-30\" \\\n  --recent_window_days 120 \\\n  --output result.json\n```\n\n**Bloomberg 風格視覺化**（輸出至專案根目錄 output/）：\n```bash\npython scripts/visualize_pattern.py\n```\n\n使用現有分析結果生成圖表：\n```bash\npython scripts/visualize_pattern.py --json output/pattern_analysis_YYYY-MM-DD.json\n```\n\n輸出圖表：\n- `output/fed_unamortized_discount_pattern_YYYY-MM-DD.png` - 形狀比對與壓力儀表板\n- `output/fed_unamortized_discount_history_YYYY-MM-DD.png` - 歷史走勢總覽\n\n</quick_start>\n\n<intake>\n需要進行什麼操作？\n\n1. **快速檢查（推薦）** - 查看目前的形狀相似度與壓力分數\n2. **完整分析** - 執行完整的形狀比對與交叉驗證\n3. **視覺化分析** - 生成形狀比對圖表\n4. **歷史事件對照** - 深入了解歷史基準窗口的後續發展\n5. **方法論學習** - 了解形狀比對與交叉驗證的邏輯\n6. **自訂參數** - 指定序列、窗口、門檻等參數\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                      | Action                                               |\n|-------------------------------|------------------------------------------------------|\n| 1, \"快速\", \"quick\", \"check\"   | 執行 `python scripts/pattern_detector.py --quick`    |\n| 2, \"完整\", \"full\", \"analysis\" | 閱讀 `workflows/execute-analysis.md` 並執行          |\n| 3, \"視覺化\", \"chart\", \"圖表\"  | 執行 `python scripts/visualize_pattern.py -o output` |\n| 4, \"歷史\", \"事件\", \"episodes\" | 閱讀 `workflows/historical-episodes.md` 並執行       |\n| 5, \"學習\", \"方法論\", \"why\"    | 閱讀 `references/methodology.md`                     |\n| 6, \"自訂\", \"custom\", 提供參數 | 閱讀 `workflows/execute-analysis.md` 並使用參數執行  |\n\n**路由後，閱讀對應文件並執行。**\n</routing>\n\n<directory_structure>\n```\ndetect-fed-unamortized-discount-pattern/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元數據\n├── workflows/\n│   ├── execute-analysis.md            # 完整分析工作流\n│   ├── visualize-analysis.md          # 視覺化分析工作流\n│   └── historical-episodes.md         # 歷史事件對照工作流\n├── references/\n│   ├── methodology.md                 # 形狀比對與交叉驗證方法論\n│   ├── data-sources.md                # 資料來源與 FRED 系列代碼\n│   ├── wudsho-mechanism.md            # WUDSHO 指標機制說明\n│   └── input-schema.md                # 完整輸入參數定義\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n├── scripts/\n│   ├── pattern_detector.py            # 主分析腳本\n│   ├── visualize_pattern.py           # 視覺化腳本\n│   └── fetch_data.py                  # 資料抓取工具\n└── examples/\n    └── sample_output.json             # 範例輸出\n```\n</directory_structure>\n\n<reference_index>\n\n**方法論**: references/methodology.md\n- 形狀比對方法（相關係數、DTW、形狀特徵）\n- 正規化與窗口對齊\n- 相似度分數計算\n- 交叉驗證邏輯\n\n**資料來源**: references/data-sources.md\n- FRED 系列代碼清單\n- 資料頻率與延遲\n- 公開替代資料說明\n\n**指標機制**: references/wudsho-mechanism.md\n- WUDSHO 的成因與解讀\n- 利率效果 vs. 壓力效果\n- 常見誤讀與反證\n\n**輸入參數**: references/input-schema.md\n- 完整參數定義\n- 預設值與建議範圍\n\n</reference_index>\n\n<workflows_index>\n| Workflow               | Purpose          | 使用時機               |\n|------------------------|------------------|------------------------|\n| execute-analysis.md    | 完整形狀比對分析 | 需要完整報告時         |\n| visualize-analysis.md  | 視覺化分析       | 需要圖表時             |\n| historical-episodes.md | 歷史事件深度分析 | 理解歷史類比與後續發展 |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構定義 |\n| output-markdown.md | Markdown 報告模板 |\n</templates_index>\n\n<scripts_index>\n| Script               | Command              | Purpose                              |\n|----------------------|----------------------|--------------------------------------|\n| pattern_detector.py  | `--quick`            | 快速檢查當前狀態                     |\n| pattern_detector.py  | `--output FILE`      | 完整分析                             |\n| visualize_pattern.py | （無參數）           | Bloomberg 風格視覺化（輸出至專案根目錄 output/） |\n| visualize_pattern.py | `--json FILE`        | 使用現有 JSON 結果生成圖表           |\n| fetch_data.py        | `--series WUDSHO`    | 抓取 FRED 資料                       |\n</scripts_index>\n\n<input_schema_summary>\n\n**核心參數**\n\n| 參數               | 類型          | 預設值  | 說明               |\n|--------------------|---------------|---------|--------------------|\n| target_series      | string        | WUDSHO  | 目標 FRED 系列代碼 |\n| baseline_windows   | array[object] | [COVID] | 歷史參考事件窗口   |\n| recent_window_days | int           | 120     | 近期比對窗口長度   |\n| resample_freq      | string        | W       | 資料頻率           |\n| normalize_method   | string        | zscore  | 正規化方法         |\n\n**相似度參數**\n\n| 參數               | 類型          | 預設值                      | 說明         |\n|--------------------|---------------|-----------------------------|--------------|\n| similarity_metrics | array[string] | [corr, dtw, shape_features] | 相似度指標   |\n| alert_thresholds   | object        | {corr_min: 0.7, ...}        | 觸發警報門檻 |\n\n**交叉驗證參數**\n\n| 參數                    | 類型          | 預設值        | 說明               |\n|-------------------------|---------------|---------------|--------------------|\n| confirmatory_indicators | array[object] | [信用利差...] | 交叉驗證指標清單   |\n| lookahead_days          | int           | 60            | 前瞻期（情境敘事） |\n\n完整參數定義見 `references/input-schema.md`。\n\n</input_schema_summary>\n\n<output_schema_summary>\n```json\n{\n  \"skill\": \"detect-fed-unamortized-discount-pattern\",\n  \"as_of_date\": \"2026-01-26\",\n  \"target_series\": \"WUDSHO\",\n  \"best_match\": {\n    \"baseline\": \"COVID_2020\",\n    \"segment_start\": \"2020-01-08\",\n    \"segment_end\": \"2020-06-17\",\n    \"corr\": 0.91,\n    \"dtw\": 0.38,\n    \"feature_sim\": 0.82,\n    \"pattern_similarity_score\": 0.88\n  },\n  \"stress_confirmation\": {\n    \"score\": 0.22,\n    \"details\": [\n      {\"name\": \"credit_spread\", \"signal\": \"neutral\", \"z\": 0.4},\n      {\"name\": \"equity_vol\", \"signal\": \"mild_risk_on\", \"z\": -0.2},\n      {\"name\": \"funding_stress_proxy\", \"signal\": \"neutral\", \"z\": 0.1}\n    ]\n  },\n  \"composite_risk_score\": 0.49,\n  \"interpretation\": {\n    \"summary\": \"走勢形狀與 COVID 早期片段相似度高，但壓力驗證指標偏中性...\",\n    \"what_to_watch_next_60d\": [\"...\"],\n    \"rebuttal_to_claim\": [\"...\"]\n  },\n  \"caveats\": [\n    \"形狀相似不代表因果相同；該序列可能強烈受利率、持有期限結構與會計攤銷影響。\",\n    \"若缺乏壓力指標同步惡化，不應把圖形類比直接升級成『黑天鵝預言』。\"\n  ]\n}\n```\n\n完整輸出結構見 `templates/output-json.md`。\n</output_schema_summary>\n\n<success_criteria>\n執行成功時應產出：\n\n- [ ] 形狀相似度分數（pattern_similarity_score）\n- [ ] 最佳匹配的歷史片段（baseline、segment_start/end）\n- [ ] 多維度相似度（corr、dtw、feature_sim）\n- [ ] 壓力驗證分數（stress_confirmation_score）\n- [ ] 各驗證指標詳情（名稱、訊號、z-score）\n- [ ] 合成風險分數（composite_risk_score）\n- [ ] 解讀框架（summary、what_to_watch、rebuttal）\n- [ ] 資料品質說明與風險警語（caveats）\n\n**視覺化輸出**（使用 visualize_pattern.py，Bloomberg 風格）：\n\n- [ ] 形狀比對與壓力儀表板圖（`fed_unamortized_discount_pattern_YYYY-MM-DD.png`）\n  - 上左：近期 vs. 歷史基準窗口的正規化形狀比對\n  - 上右：相似度分數面板（corr、DTW、feature_sim、綜合風險）\n  - 下左：壓力驗證指標水平條圖（Z-Score）\n  - 下右：解讀說明（訊號統計、結論）\n- [ ] 歷史走勢總覽圖（`fed_unamortized_discount_history_YYYY-MM-DD.png`）\n  - 完整 WUDSHO 歷史走勢\n  - 歷史基準窗口標記（COVID_2020、GFC_2008、TAPER_2013、RATE_HIKE_2022）\n  - 近期窗口與最佳匹配片段高亮\n  - 最新值標註\n</success_criteria>\n",
        "skills/detect-fed-unamortized-discount-pattern/references/data-sources.md": "# 資料來源與 FRED 系列代碼\n\n## 主要資料來源\n\n### FRED (Federal Reserve Economic Data)\n\n**URL**: https://fred.stlouisfed.org\n\n**API**: CSV endpoint（無需 API key）\n\n**抓取方式**:\n```python\nFRED_CSV_URL = \"https://fred.stlouisfed.org/graph/fredgraph.csv\"\n\ndef fetch_fred_series(series_id: str, start_date: str, end_date: str) -> pd.Series:\n    params = {\n        \"id\": series_id,\n        \"cosd\": start_date,\n        \"coed\": end_date\n    }\n    response = requests.get(FRED_CSV_URL, params=params, timeout=30)\n    response.raise_for_status()\n\n    df = pd.read_csv(StringIO(response.text))\n    df.columns = [\"DATE\", series_id]\n    df[\"DATE\"] = pd.to_datetime(df[\"DATE\"])\n    df[series_id] = df[series_id].replace(\".\", pd.NA)\n    df[series_id] = pd.to_numeric(df[series_id], errors=\"coerce\")\n    df = df.dropna().set_index(\"DATE\")\n\n    return df[series_id]\n```\n\n---\n\n## 系列代碼清單\n\n### 目標序列\n\n| 系列代碼 | 名稱 | 頻率 | 說明 |\n|----------|------|------|------|\n| **WUDSHO** | Unamortized Discounts on Securities Held Outright | 週 | 聯準會持有證券的未攤銷折價 |\n\n### 交叉驗證指標\n\n#### 信用利差\n\n| 系列代碼 | 名稱 | 頻率 | 用途 |\n|----------|------|------|------|\n| **BAMLC0A0CM** | ICE BofA US Corporate Index OAS | 日 | IG 信用利差 |\n| **BAMLH0A0HYM2** | ICE BofA US High Yield Index OAS | 日 | 高收益債利差 |\n| **BAMLC0A4CBBB** | ICE BofA BBB US Corporate Index OAS | 日 | BBB 級利差 |\n\n#### 波動率\n\n| 系列代碼 | 名稱 | 頻率 | 用途 |\n|----------|------|------|------|\n| **VIXCLS** | CBOE Volatility Index: VIX | 日 | 股市隱含波動率 |\n\n#### 國債殖利率\n\n| 系列代碼 | 名稱 | 頻率 | 用途 |\n|----------|------|------|------|\n| **DGS10** | 10-Year Treasury Constant Maturity Rate | 日 | 10 年期國債殖利率 |\n| **DGS2** | 2-Year Treasury Constant Maturity Rate | 日 | 2 年期國債殖利率 |\n| **DGS3MO** | 3-Month Treasury Bill Secondary Market Rate | 日 | 3 個月國庫券利率 |\n\n殖利率曲線 = DGS10 - DGS2（正常為正，倒掛為負）\n\n#### 聯準會資產負債表\n\n| 系列代碼 | 名稱 | 頻率 | 用途 |\n|----------|------|------|------|\n| **WALCL** | Fed Total Assets | 週 | Fed 資產負債表總規模 |\n| **WTREGEN** | Treasury General Account | 週 | 財政部在 Fed 的帳戶餘額 |\n| **WSHOSHO** | Securities Held Outright | 週 | Fed 持有的證券總額 |\n\n#### 貨幣市場壓力\n\n| 系列代碼 | 名稱 | 頻率 | 用途 |\n|----------|------|------|------|\n| **SOFR** | Secured Overnight Financing Rate | 日 | 有擔保隔夜融資利率 |\n| **EFFR** | Effective Federal Funds Rate | 日 | 有效聯邦基金利率 |\n\n---\n\n## 資料頻率與延遲\n\n| 類型 | 頻率 | 延遲 | 說明 |\n|------|------|------|------|\n| Fed 資產負債表 | 週 | T+1~3 | 每週三發布上週數據 |\n| 信用利差 | 日 | T+0 | 當日可得 |\n| VIX | 日 | T+0 | 當日可得 |\n| 國債殖利率 | 日 | T+0 | 當日可得 |\n\n**處理方式**：\n- 對齊至週頻時，取週末值（或該週最後有效值）\n- 揭露「資料截止日」\n\n---\n\n## 資料品質注意事項\n\n### 缺失值處理\n\nFRED 使用 `.` 表示缺失值：\n\n```python\ndf[series_id] = df[series_id].replace(\".\", pd.NA)\ndf[series_id] = pd.to_numeric(df[series_id], errors=\"coerce\")\ndf = df.dropna()\n```\n\n### 歷史可得期間\n\n| 系列 | 可回溯至 | 說明 |\n|------|----------|------|\n| WUDSHO | 2003 年 | Fed 資產負債表現代格式 |\n| BAMLC0A0CM | 1996 年 | ICE BofA 指數 |\n| VIXCLS | 1990 年 | CBOE VIX |\n| DGS10 | 1962 年 | 國債殖利率 |\n\n### 結構性斷點\n\n- **2008 年**：QE 開始，Fed 資產負債表結構性變化\n- **2020 年**：無限 QE，規模再次劇增\n- **2022 年**：QT 開始，規模縮減\n\n比對時應注意這些結構性變化。\n\n---\n\n## Fallback 替代方案\n\n若主要來源不可用，可使用：\n\n| 主要來源 | Fallback | 說明 |\n|----------|----------|------|\n| FRED WUDSHO | Fed H.4.1 PDF | 需手動解析 |\n| BAMLC0A0CM | Yahoo Finance ^AMLC | 可能有差異 |\n| VIXCLS | Yahoo Finance ^VIX | 即時更新 |\n\n---\n\n## 快取機制\n\n建議使用本地快取避免重複請求：\n\n```python\nCACHE_DIR = Path(\"cache\")\n\ndef get_with_cache(series_id: str, start: str, end: str, max_age_hours: int = 24):\n    cache_file = CACHE_DIR / f\"{series_id}_{start}_{end}.json\"\n\n    if cache_file.exists():\n        mtime = datetime.fromtimestamp(cache_file.stat().st_mtime)\n        if datetime.now() - mtime < timedelta(hours=max_age_hours):\n            with open(cache_file) as f:\n                data = json.load(f)\n            return pd.Series(data[\"values\"], index=pd.to_datetime(data[\"dates\"]))\n\n    # Fetch fresh data\n    series = fetch_fred_series(series_id, start, end)\n\n    # Save to cache\n    CACHE_DIR.mkdir(exist_ok=True)\n    with open(cache_file, \"w\") as f:\n        json.dump({\n            \"dates\": series.index.strftime(\"%Y-%m-%d\").tolist(),\n            \"values\": series.tolist(),\n            \"fetched_at\": datetime.now().isoformat()\n        }, f)\n\n    return series\n```\n",
        "skills/detect-fed-unamortized-discount-pattern/references/input-schema.md": "# 完整輸入參數定義\n\n## 參數總覽\n\n| 參數分類 | 參數數量 | 說明 |\n|----------|----------|------|\n| 目標序列 | 1 | 要分析的 FRED 序列 |\n| 窗口設定 | 3 | 近期/基準窗口配置 |\n| 正規化 | 2 | 資料預處理方法 |\n| 相似度 | 2 | 形狀比對方法 |\n| 門檻 | 3 | 警報觸發條件 |\n| 交叉驗證 | 2 | 壓力指標配置 |\n| 輸出 | 2 | 輸出格式與路徑 |\n\n---\n\n## 詳細參數定義\n\n### 目標序列參數\n\n#### target_series\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 預設值 | \"WUDSHO\" |\n| 必要性 | Optional |\n| 說明 | 目標 FRED 時間序列代碼 |\n\n**可用值**:\n- `WUDSHO`: 未攤銷折價（預設）\n- `WSHOSHO`: 持有證券總額\n- 其他 FRED 週頻序列\n\n---\n\n### 窗口設定參數\n\n#### baseline_windows\n| 屬性 | 值 |\n|------|-----|\n| 類型 | array[object] |\n| 必要性 | Required |\n| 說明 | 歷史參考事件窗口清單 |\n\n**物件結構**:\n```json\n{\n  \"name\": \"COVID_2020\",\n  \"start\": \"2020-01-01\",\n  \"end\": \"2020-06-30\"\n}\n```\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| name | string | 事件名稱（唯一識別） |\n| start | date | 窗口起始日期（YYYY-MM-DD） |\n| end | date | 窗口結束日期（YYYY-MM-DD） |\n\n**預設值**:\n```json\n[\n  {\"name\": \"COVID_2020\", \"start\": \"2020-01-01\", \"end\": \"2020-06-30\"},\n  {\"name\": \"GFC_2008\", \"start\": \"2008-09-01\", \"end\": \"2009-03-31\"},\n  {\"name\": \"TAPER_2013\", \"start\": \"2013-05-01\", \"end\": \"2013-09-30\"},\n  {\"name\": \"RATE_HIKE_2022\", \"start\": \"2022-01-01\", \"end\": \"2022-12-31\"}\n]\n```\n\n#### recent_window_days\n| 屬性 | 值 |\n|------|-----|\n| 類型 | int |\n| 預設值 | 120 |\n| 範圍 | 30 ~ 365 |\n| 必要性 | Required |\n| 說明 | 近期比對窗口長度（天） |\n\n**建議**:\n- 60: 短期比對（約 8 週）\n- 120: 標準比對（約 17 週）\n- 180: 中期比對（約 26 週）\n\n#### history_start_date\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string (date) |\n| 預設值 | \"2015-01-01\" |\n| 必要性 | Optional |\n| 說明 | 歷史資料起始日期 |\n\n---\n\n### 正規化參數\n\n#### resample_freq\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 預設值 | \"W\" |\n| 可用值 | \"W\", \"D\" |\n| 必要性 | Optional |\n| 說明 | 資料重採樣頻率 |\n\n**說明**:\n- `W`: 週頻（推薦，WUDSHO 原生頻率）\n- `D`: 日頻（需要內插，可能引入噪音）\n\n#### normalize_method\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 預設值 | \"zscore\" |\n| 可用值 | \"zscore\", \"minmax\", \"pct_change\" |\n| 必要性 | Optional |\n| 說明 | 正規化方法 |\n\n**方法說明**:\n| 方法 | 公式 | 適用場景 |\n|------|------|----------|\n| zscore | (x - mean) / std | 形狀比對（推薦） |\n| minmax | (x - min) / (max - min) | 範圍統一 |\n| pct_change | (x[t] - x[t-1]) / x[t-1] | 動量分析 |\n\n---\n\n### 相似度參數\n\n#### similarity_metrics\n| 屬性 | 值 |\n|------|-----|\n| 類型 | array[string] |\n| 預設值 | [\"corr\", \"dtw\", \"shape_features\"] |\n| 必要性 | Optional |\n| 說明 | 要計算的相似度指標 |\n\n**可用值**:\n| 值 | 說明 | 計算成本 |\n|----|------|----------|\n| corr | 皮爾遜相關係數 | 低 |\n| dtw | 動態時間校正距離 | 中 |\n| shape_features | 形狀特徵相似度 | 低 |\n\n#### similarity_weights\n| 屬性 | 值 |\n|------|-----|\n| 類型 | object |\n| 預設值 | {\"corr\": 0.4, \"dtw\": 0.3, \"shape_features\": 0.3} |\n| 必要性 | Optional |\n| 說明 | 各相似度指標的權重 |\n\n---\n\n### 門檻參數\n\n#### alert_thresholds\n| 屬性 | 值 |\n|------|-----|\n| 類型 | object |\n| 必要性 | Optional |\n| 說明 | 觸發警報的門檻 |\n\n**預設值**:\n```json\n{\n  \"corr_min\": 0.7,\n  \"dtw_max\": 1.5,\n  \"risk_score_min\": 0.6\n}\n```\n\n| 欄位 | 類型 | 預設值 | 說明 |\n|------|------|--------|------|\n| corr_min | float | 0.7 | 相關係數最低門檻 |\n| dtw_max | float | 1.5 | DTW 距離最高門檻 |\n| risk_score_min | float | 0.6 | 風險分數最低門檻 |\n\n---\n\n### 交叉驗證參數\n\n#### confirmatory_indicators\n| 屬性 | 值 |\n|------|-----|\n| 類型 | array[object] |\n| 必要性 | Optional |\n| 說明 | 交叉驗證指標清單 |\n\n**物件結構**:\n```json\n{\n  \"name\": \"credit_spread\",\n  \"source\": \"FRED\",\n  \"series\": \"BAMLC0A0CM\",\n  \"weight\": 0.25,\n  \"stress_threshold\": 1.5\n}\n```\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| name | string | 指標名稱（唯一識別） |\n| source | string | 資料來源 |\n| series | string | 系列代碼 |\n| weight | float | 權重（0~1） |\n| stress_threshold | float | 壓力門檻（z-score） |\n\n**預設值**:\n```json\n[\n  {\"name\": \"credit_spread\", \"source\": \"FRED\", \"series\": \"BAMLC0A0CM\", \"weight\": 0.25, \"stress_threshold\": 1.5},\n  {\"name\": \"hy_spread\", \"source\": \"FRED\", \"series\": \"BAMLH0A0HYM2\", \"weight\": 0.20, \"stress_threshold\": 1.5},\n  {\"name\": \"equity_vol\", \"source\": \"FRED\", \"series\": \"VIXCLS\", \"weight\": 0.20, \"stress_threshold\": 1.5},\n  {\"name\": \"yield_curve\", \"source\": \"FRED\", \"series\": [\"DGS10\", \"DGS2\"], \"weight\": 0.15, \"stress_threshold\": -1.0},\n  {\"name\": \"fed_balance\", \"source\": \"FRED\", \"series\": \"WALCL\", \"weight\": 0.20, \"stress_threshold\": 1.0}\n]\n```\n\n#### lookahead_days\n| 屬性 | 值 |\n|------|-----|\n| 類型 | int |\n| 預設值 | 60 |\n| 範圍 | 30 ~ 365 |\n| 必要性 | Optional |\n| 說明 | 前瞻期（情境敘事用） |\n\n---\n\n### 輸出參數\n\n#### output_path\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 預設值 | \"output/pattern_analysis_{date}.json\" |\n| 必要性 | Optional |\n| 說明 | JSON 結果輸出路徑 |\n\n#### output_format\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 預設值 | \"json\" |\n| 可用值 | \"json\", \"markdown\", \"both\" |\n| 必要性 | Optional |\n| 說明 | 輸出格式 |\n\n---\n\n## 命令列參數對照\n\n```bash\npython scripts/pattern_detector.py \\\n  --target_series WUDSHO \\\n  --baseline_windows \"COVID_2020:2020-01-01:2020-06-30,GFC_2008:2008-09-01:2009-03-31\" \\\n  --recent_window_days 120 \\\n  --normalize_method zscore \\\n  --similarity_metrics \"corr,dtw,shape_features\" \\\n  --output result.json\n```\n\n| 命令列參數 | 對應配置參數 |\n|------------|--------------|\n| --target_series | target_series |\n| --baseline_windows | baseline_windows（格式: name:start:end,name:start:end） |\n| --recent_window_days | recent_window_days |\n| --normalize_method | normalize_method |\n| --similarity_metrics | similarity_metrics（逗號分隔） |\n| --output | output_path |\n| --quick | 使用預設參數快速執行 |\n| --markdown | output_format = \"markdown\" |\n\n---\n\n## 配置檔範例\n\n**config.json**:\n```json\n{\n  \"target_series\": \"WUDSHO\",\n  \"baseline_windows\": [\n    {\"name\": \"COVID_2020\", \"start\": \"2020-01-01\", \"end\": \"2020-06-30\"},\n    {\"name\": \"GFC_2008\", \"start\": \"2008-09-01\", \"end\": \"2009-03-31\"}\n  ],\n  \"recent_window_days\": 120,\n  \"resample_freq\": \"W\",\n  \"normalize_method\": \"zscore\",\n  \"similarity_metrics\": [\"corr\", \"dtw\", \"shape_features\"],\n  \"similarity_weights\": {\"corr\": 0.4, \"dtw\": 0.3, \"shape_features\": 0.3},\n  \"alert_thresholds\": {\n    \"corr_min\": 0.7,\n    \"dtw_max\": 1.5,\n    \"risk_score_min\": 0.6\n  },\n  \"confirmatory_indicators\": [\n    {\"name\": \"credit_spread\", \"source\": \"FRED\", \"series\": \"BAMLC0A0CM\", \"weight\": 0.25, \"stress_threshold\": 1.5}\n  ],\n  \"lookahead_days\": 60,\n  \"output_path\": \"output/result.json\",\n  \"output_format\": \"both\"\n}\n```\n\n使用：\n```bash\npython scripts/pattern_detector.py --config config.json\n```\n",
        "skills/detect-fed-unamortized-discount-pattern/references/methodology.md": "### 為什麼需要形狀比對？\n\n一般常見的「圖形類比」論述：\n- ❌「這條線複製 COVID，60 天內黑天鵝」\n- 問題：純粹肉眼判斷，無法量化，無法反駁\n\n**本技能的解決方案**：\n- 把「肉眼類比」轉成可量化的「形狀比對」\n- 使用多種方法交叉驗證，避免單一指標誤判\n- 輸出可被支持或反駁的數據\n\n### 形狀比對 ≠ 事件預測\n\n**重要認知**：\n- 「形狀相似」只說明「當前走勢與歷史片段形狀類似」\n- 不說明「歷史事件會再次發生」\n- 需要搭配壓力驗證才能升級風險判斷\n\n---\n\n## 資料預處理\n\n### 頻率對齊\n\nFRED 週資料為主，所有序列對齊至週頻：\n\n```python\ndef resample_align(series: pd.Series, freq: str = \"W\") -> pd.Series:\n    \"\"\"\n    將序列重採樣至指定頻率\n\n    Parameters\n    ----------\n    series : pd.Series\n        原始時間序列（日頻或週頻）\n    freq : str\n        目標頻率（\"W\" 週頻、\"D\" 日頻）\n\n    Returns\n    -------\n    pd.Series\n        重採樣後的序列\n    \"\"\"\n    if freq == \"W\":\n        # 取週末值（或該週最後一個有效值）\n        return series.resample(\"W-FRI\").last().dropna()\n    return series\n```\n\n### 正規化方法\n\n去除量級差異，只保留「形狀」：\n\n#### Z-Score 正規化\n```python\ndef zscore_normalize(series: pd.Series) -> pd.Series:\n    \"\"\"\n    Z-Score 正規化：均值=0，標準差=1\n\n    適用：形狀比較，對量級不敏感\n    \"\"\"\n    return (series - series.mean()) / series.std()\n```\n\n#### 百分比變化正規化\n```python\ndef pct_change_normalize(series: pd.Series) -> pd.Series:\n    \"\"\"\n    百分比變化正規化\n\n    適用：強調加速/減速，對趨勢敏感\n    \"\"\"\n    return series.pct_change().fillna(0)\n```\n\n#### Min-Max 正規化\n```python\ndef minmax_normalize(series: pd.Series) -> pd.Series:\n    \"\"\"\n    Min-Max 正規化：範圍縮放至 [0, 1]\n\n    適用：需要統一範圍時\n    \"\"\"\n    return (series - series.min()) / (series.max() - series.min())\n```\n\n**建議**：使用 Z-Score 作為主要方法，pct_change 作為輔助驗證。\n\n---\n\n## 形狀相似度計算\n\n### 方法 1: 皮爾遜相關係數 (Correlation)\n\n```python\ndef pearson_correlation(series_a: np.ndarray, series_b: np.ndarray) -> float:\n    \"\"\"\n    計算兩個序列的皮爾遜相關係數\n\n    Parameters\n    ----------\n    series_a, series_b : np.ndarray\n        正規化後的時間序列（長度需相同）\n\n    Returns\n    -------\n    float\n        相關係數，範圍 [-1, 1]\n    \"\"\"\n    return np.corrcoef(series_a, series_b)[0, 1]\n```\n\n**解讀**：\n| 相關係數  | 解讀                       |\n|-----------|----------------------------|\n| > 0.8     | 高度正相關（形狀非常相似） |\n| 0.5 ~ 0.8 | 中度正相關（形狀相似）     |\n| 0.3 ~ 0.5 | 弱正相關（部分相似）       |\n| < 0.3     | 無顯著相關（形狀不相似）   |\n\n**優點**：\n- 計算簡單快速\n- 直觀易懂\n\n**缺點**：\n- 假設線性關係\n- 對時間偏移敏感（快一點/慢一點會降低相關）\n\n### 方法 2: 動態時間校正 (DTW)\n\n```python\nfrom scipy.spatial.distance import euclidean\nfrom fastdtw import fastdtw\n\ndef dtw_distance(series_a: np.ndarray, series_b: np.ndarray) -> float:\n    \"\"\"\n    計算兩個序列的 DTW 距離\n\n    Parameters\n    ----------\n    series_a, series_b : np.ndarray\n        正規化後的時間序列（長度可不同）\n\n    Returns\n    -------\n    float\n        DTW 距離，範圍 [0, ∞)，越小越相似\n    \"\"\"\n    distance, path = fastdtw(series_a, series_b, dist=euclidean)\n    # 正規化：除以序列長度\n    return distance / max(len(series_a), len(series_b))\n```\n\n**解讀**：\n| DTW 距離（正規化後） | 解讀     |\n|----------------------|----------|\n| < 0.3                | 高度相似 |\n| 0.3 ~ 0.8            | 中度相似 |\n| 0.8 ~ 1.5            | 弱相似   |\n| > 1.5                | 不相似   |\n\n**優點**：\n- 允許時間軸「拉伸/壓縮」\n- 捕捉「快一點/慢一點但形狀相似」的情況\n\n**缺點**：\n- 計算量較大\n- 對參數敏感\n- 可能過度對齊（把不相似的強行對齊）\n\n### 方法 3: 形狀特徵相似度\n\n提取結構化特徵，計算特徵向量的相似度：\n\n```python\ndef extract_shape_features(series: np.ndarray) -> dict:\n    \"\"\"\n    提取形狀特徵\n\n    Returns\n    -------\n    dict\n        特徵字典\n    \"\"\"\n    n = len(series)\n    x = np.arange(n)\n\n    # 1. 趨勢斜率（線性回歸）\n    slope, intercept = np.polyfit(x, series, 1)\n\n    # 2. 波動度（標準差）\n    volatility = np.std(series)\n\n    # 3. 偏度（形狀不對稱性）\n    from scipy.stats import skew\n    skewness = skew(series)\n\n    # 4. 峰谷數量\n    from scipy.signal import find_peaks\n    peaks, _ = find_peaks(series)\n    troughs, _ = find_peaks(-series)\n    n_peaks = len(peaks)\n    n_troughs = len(troughs)\n\n    # 5. 首尾變化率\n    start_to_end = (series[-1] - series[0]) / (abs(series[0]) + 1e-8)\n\n    return {\n        \"slope\": slope,\n        \"volatility\": volatility,\n        \"skewness\": skewness,\n        \"n_peaks\": n_peaks,\n        \"n_troughs\": n_troughs,\n        \"start_to_end\": start_to_end\n    }\n\n\ndef feature_similarity(feat_a: dict, feat_b: dict) -> float:\n    \"\"\"\n    計算特徵向量的餘弦相似度\n    \"\"\"\n    keys = feat_a.keys()\n    vec_a = np.array([feat_a[k] for k in keys])\n    vec_b = np.array([feat_b[k] for k in keys])\n\n    # 正規化\n    vec_a = vec_a / (np.linalg.norm(vec_a) + 1e-8)\n    vec_b = vec_b / (np.linalg.norm(vec_b) + 1e-8)\n\n    # 餘弦相似度\n    return float(np.dot(vec_a, vec_b))\n```\n\n**優點**：\n- 捕捉結構性特徵（趨勢、拐點）\n- 對局部噪音較不敏感\n\n**缺點**：\n- 特徵選擇需要領域知識\n- 可能遺漏某些形狀特性\n\n### 綜合相似度分數\n\n```python\ndef combine_similarity(\n    corr: float,\n    dtw_dist: float,\n    feature_sim: float,\n    weights: tuple = (0.4, 0.3, 0.3)\n) -> float:\n    \"\"\"\n    合成綜合相似度分數\n\n    Parameters\n    ----------\n    corr : float\n        相關係數 [-1, 1]\n    dtw_dist : float\n        DTW 距離（正規化後）[0, ∞)\n    feature_sim : float\n        特徵相似度 [0, 1]\n    weights : tuple\n        權重 (corr, dtw, feature)\n\n    Returns\n    -------\n    float\n        綜合相似度分數 [0, 1]\n    \"\"\"\n    # 轉換至 [0, 1] 範圍\n    corr_score = (corr + 1) / 2  # [-1, 1] -> [0, 1]\n    dtw_score = max(0, 1 - dtw_dist / 2)  # 假設 dtw > 2 為不相似\n    feat_score = max(0, feature_sim)  # 已經在 [0, 1]\n\n    w_corr, w_dtw, w_feat = weights\n    return w_corr * corr_score + w_dtw * dtw_score + w_feat * feat_score\n```\n\n---\n\n## 交叉驗證邏輯\n\n### 為什麼需要交叉驗證？\n\n**WUDSHO 變動的可能成因**：\n1. **利率環境變化**（最常見）\n2. **持有債券久期結構調整**\n3. **會計攤銷時程**\n4. **真正的金融壓力**\n\n只有第 4 種需要提高警覺，但形狀比對無法區分。\n\n**解決方案**：用其他壓力指標交叉驗證。\n\n### 壓力驗證計算\n\n```python\ndef calculate_stress_score(\n    indicator_data: pd.Series,\n    indicator_config: dict,\n    lookback_days: int = 252\n) -> dict:\n    \"\"\"\n    計算單一指標的壓力分數\n\n    Parameters\n    ----------\n    indicator_data : pd.Series\n        指標資料\n    indicator_config : dict\n        指標配置（包含 stress_threshold）\n    lookback_days : int\n        歷史回望期（計算 z-score 用）\n\n    Returns\n    -------\n    dict\n        包含 z-score、signal、score\n    \"\"\"\n    recent = indicator_data.iloc[-1]\n    historical = indicator_data.iloc[-lookback_days:-1]\n\n    mean = historical.mean()\n    std = historical.std()\n    z = (recent - mean) / (std + 1e-8)\n\n    threshold = indicator_config.get(\"stress_threshold\", 1.5)\n\n    # 信用利差、波動率：上升為壓力\n    # 殖利率曲線：倒掛（負值）為壓力\n    if indicator_config.get(\"name\") == \"yield_curve\":\n        signal = \"stress\" if z < -threshold else \"neutral\"\n        score = max(0, -z / threshold) if z < 0 else 0\n    else:\n        signal = \"stress\" if z > threshold else \"neutral\"\n        score = max(0, z / threshold) if z > 0 else 0\n\n    return {\n        \"z\": float(z),\n        \"signal\": signal,\n        \"score\": min(1.0, score)\n    }\n```\n\n### 合成壓力分數\n\n```python\ndef aggregate_stress_scores(\n    indicator_results: list,\n    indicator_configs: list\n) -> dict:\n    \"\"\"\n    合成所有指標的壓力分數\n\n    Returns\n    -------\n    dict\n        包含 score（加權平均）和 details\n    \"\"\"\n    total_weight = 0\n    weighted_score = 0\n    details = []\n\n    for result, config in zip(indicator_results, indicator_configs):\n        weight = config.get(\"weight\", 1.0)\n        weighted_score += weight * result[\"score\"]\n        total_weight += weight\n        details.append({\n            \"name\": config[\"name\"],\n            \"signal\": result[\"signal\"],\n            \"z\": result[\"z\"]\n        })\n\n    return {\n        \"score\": weighted_score / total_weight if total_weight > 0 else 0,\n        \"details\": details\n    }\n```\n\n---\n\n## 合成風險分數\n\n```python\ndef calculate_composite_risk(\n    pattern_score: float,\n    stress_score: float,\n    pattern_weight: float = 0.6,\n    stress_weight: float = 0.4\n) -> float:\n    \"\"\"\n    合成最終風險分數\n\n    Parameters\n    ----------\n    pattern_score : float\n        形狀相似度分數 [0, 1]\n    stress_score : float\n        壓力驗證分數 [0, 1]\n    pattern_weight : float\n        形狀權重\n    stress_weight : float\n        壓力權重\n\n    Returns\n    -------\n    float\n        合成風險分數 [0, 1]\n    \"\"\"\n    return pattern_weight * pattern_score + stress_weight * stress_score\n```\n\n### 解讀框架\n\n| 合成風險分數 | 解讀                             | 建議行動               |\n|--------------|----------------------------------|------------------------|\n| > 0.7        | 高風險：形狀相似且壓力驗證支持   | 提高警覺，考慮防禦配置 |\n| 0.5 ~ 0.7    | 中高風險：形狀相似，壓力開始出現 | 持續觀察，準備應對方案 |\n| 0.3 ~ 0.5    | 中風險：形狀相似但壓力中性       | 可能是利率/會計效果    |\n| < 0.3        | 低風險：形狀不相似或壓力反對     | 圖形類比不成立         |\n\n---\n\n## 方法論限制\n\n1. **歷史不代表未來**：形狀相似不代表後續發展相同\n2. **樣本有限**：極端事件只有 3-4 次，統計推論受限\n3. **參數敏感**：DTW 和特徵提取對參數敏感\n4. **時效性**：FRED 週資料有 T+1 ~ T+3 延遲\n5. **因果謬誤**：相關不等於因果\n\n---\n\n## 參考文獻\n\n- Berndt, D.J., & Clifford, J. (1994). \"Using Dynamic Time Warping to Find Patterns in Time Series\"\n- Ratanamahatana, C.A., & Keogh, E. (2004). \"Making Time-series Classification More Accurate Using Learned Constraints\"\n- Fed H.4.1 Release Documentation\n",
        "skills/detect-fed-unamortized-discount-pattern/references/wudsho-mechanism.md": "# WUDSHO 指標機制說明\n\n## 什麼是 WUDSHO？\n\n**WUDSHO** = Unamortized Discounts on Securities Held Outright\n\n聯準會持有證券的「未攤銷折價」。\n\n---\n\n## 形成機制\n\n### 債券購買與折價\n\n當聯準會購買債券時：\n- **票面價值** (Face Value): 債券到期時償還的金額\n- **購入價格** (Purchase Price): 實際支付的價格\n- **折價** (Discount): 票面價值 - 購入價格（當購入價 < 票面價）\n- **溢價** (Premium): 購入價格 - 票面價值（當購入價 > 票面價）\n\n### 利率與債券價格的關係\n\n```\n市場利率 ↑ → 債券價格 ↓ → 購入時產生折價 → WUDSHO ↑\n市場利率 ↓ → 債券價格 ↑ → 購入時產生溢價 → WUDSHO ↓\n```\n\n### 會計處理\n\n- 折價/溢價在債券持有期間逐步「攤銷」\n- 攤銷將折價/溢價分配至各期利息收入\n- WUDSHO 反映「尚未攤銷完畢的折價總額」\n\n---\n\n## WUDSHO 變動的可能成因\n\n### 1. 利率環境變化（最常見）\n\n```\n利率上升期：\n- 新購債券以更大折價買入\n- WUDSHO 增加\n\n利率下降期：\n- 新購債券以溢價買入\n- WUDSHO 減少（或轉為未攤銷溢價）\n```\n\n**判斷方式**：看國債殖利率是否同步變動\n\n### 2. 持有債券久期結構\n\n- 長久期債券：對利率變動更敏感，折價/溢價更大\n- 短久期債券：對利率變動較不敏感\n\n**判斷方式**：看 Fed 持有債券的久期分布是否變化\n\n### 3. 會計攤銷時程\n\n- 既有持倉的折價逐漸攤銷 → WUDSHO 自然下降\n- 攤銷速度取決於持有債券的到期結構\n\n**判斷方式**：長期趨勢下降是正常的攤銷效果\n\n### 4. 真正的金融壓力（需交叉驗證）\n\n在金融壓力期間：\n- 流動性緊縮\n- 信用利差走寬\n- 波動率上升\n- Fed 可能介入購債（影響 WUDSHO）\n\n**判斷方式**：需要信用利差、VIX、融資壓力等交叉驗證\n\n---\n\n## 常見誤讀與反證\n\n### 誤讀 1: WUDSHO 上升 = 金融危機\n\n**反證**：\n- 2022 年 WUDSHO 大幅上升\n- 主因：Fed 激進升息導致持有債券市值下降\n- 這是利率效果，不是金融危機訊號\n- 實際危機（SVB）發生在 2023 年 3 月，與 WUDSHO 無直接因果\n\n### 誤讀 2: 形狀像 COVID = 會發生 COVID 級事件\n\n**反證**：\n- 形狀相似可能來自利率週期相似\n- COVID 的市場衝擊來自疫情本身，不是 WUDSHO\n- WUDSHO 只是「伴隨指標」，不是「預測指標」\n\n### 誤讀 3: 社群圖表 = 可信資訊\n\n**反證**：\n- 社群圖表可能選擇性裁切時間軸\n- 可能使用不同的正規化方法\n- 需要用本技能重新驗證相似度\n\n---\n\n## 正確的解讀框架\n\n### Step 1: 確認形狀是否真的相似\n\n使用本技能計算：\n- 相關係數\n- DTW 距離\n- 形狀特徵相似度\n\n### Step 2: 排除利率效果\n\n檢查：\n- 國債殖利率是否同步變動\n- 如果利率主導，則 WUDSHO 變動是「正常」的\n\n### Step 3: 交叉驗證壓力訊號\n\n檢查：\n- 信用利差是否走寬（z > 1.5）\n- VIX 是否上升（z > 1.5）\n- 融資市場是否緊張\n\n### Step 4: 綜合判斷\n\n| 形狀相似度 | 利率效果 | 壓力訊號 | 結論 |\n|------------|----------|----------|------|\n| 高 | 是 | 無 | 利率驅動，非壓力 |\n| 高 | 否 | 有 | 可能真正壓力 |\n| 高 | 否 | 無 | 需要觀察 |\n| 低 | - | - | 圖形類比不成立 |\n\n---\n\n## 歷史案例分析\n\n### 案例 1: 2020 年 COVID\n\n**WUDSHO 走勢**：\n- 2020-01 ~ 2020-03：劇烈波動\n- 2020-03 後：Fed 無限 QE，大量購債\n\n**成因分析**：\n- 初期：市場恐慌，流動性危機\n- 後期：Fed 介入，持有結構改變\n\n**壓力指標**：\n- VIX 飆至 80\n- 信用利差大幅走寬\n- 所有指標同步惡化\n\n**結論**：真正的系統性壓力\n\n### 案例 2: 2022 年升息\n\n**WUDSHO 走勢**：\n- 持續上升\n- 與利率變動高度相關\n\n**成因分析**：\n- 利率快速上升\n- 持有債券市值下降\n- 新購債券折價增加\n\n**壓力指標**：\n- VIX 偏高但未極端（35 左右）\n- 信用利差小幅走寬\n- 未見恐慌性惡化\n\n**結論**：利率驅動，非系統性壓力\n\n### 案例 3: 2013 年 Taper Tantrum\n\n**WUDSHO 走勢**：\n- 利率上升驅動\n\n**成因分析**：\n- Bernanke 暗示縮減 QE\n- 利率上升\n\n**壓力指標**：\n- VIX 小幅上升\n- 信用利差輕微走寬\n- 新興市場壓力較大\n\n**結論**：政策預期調整，非系統性壓力\n\n---\n\n## 監控建議\n\n### 日常監控\n\n- 追蹤 WUDSHO 週變動\n- 比較與國債殖利率的同步性\n\n### 警報觸發條件\n\n1. **形狀相似度高**（> 0.7）\n2. **加上**：信用利差 z > 1.5\n3. **加上**：VIX z > 1.5\n4. **加上**：利率效果無法完全解釋\n\n### 降低警報條件\n\n1. 利率變動可解釋 WUDSHO 變動\n2. 壓力指標保持中性\n3. Fed 未使用緊急流動性工具\n",
        "skills/detect-fed-unamortized-discount-pattern/templates/output-json.md": "# JSON 輸出結構定義\n\n## 完整輸出結構\n\n```json\n{\n  \"skill\": \"detect-fed-unamortized-discount-pattern\",\n  \"version\": \"0.1.0\",\n  \"as_of_date\": \"2026-01-26\",\n  \"target_series\": \"WUDSHO\",\n  \"parameters\": {\n    \"recent_window_days\": 120,\n    \"resample_freq\": \"W\",\n    \"normalize_method\": \"zscore\",\n    \"similarity_metrics\": [\"corr\", \"dtw\", \"shape_features\"]\n  },\n  \"best_match\": {\n    \"baseline\": \"COVID_2020\",\n    \"segment_start\": \"2020-01-08\",\n    \"segment_end\": \"2020-06-17\",\n    \"corr\": 0.91,\n    \"dtw\": 0.38,\n    \"feature_sim\": 0.82,\n    \"pattern_similarity_score\": 0.88\n  },\n  \"all_matches\": [\n    {\n      \"baseline\": \"COVID_2020\",\n      \"segment_start\": \"2020-01-08\",\n      \"segment_end\": \"2020-06-17\",\n      \"corr\": 0.91,\n      \"dtw\": 0.38,\n      \"feature_sim\": 0.82,\n      \"pattern_similarity_score\": 0.88\n    },\n    {\n      \"baseline\": \"RATE_HIKE_2022\",\n      \"segment_start\": \"2022-03-01\",\n      \"segment_end\": \"2022-07-15\",\n      \"corr\": 0.78,\n      \"dtw\": 0.55,\n      \"feature_sim\": 0.75,\n      \"pattern_similarity_score\": 0.75\n    }\n  ],\n  \"stress_confirmation\": {\n    \"score\": 0.22,\n    \"details\": [\n      {\n        \"name\": \"credit_spread\",\n        \"series\": \"BAMLC0A0CM\",\n        \"current_value\": 1.05,\n        \"historical_mean\": 0.95,\n        \"historical_std\": 0.25,\n        \"z\": 0.4,\n        \"signal\": \"neutral\",\n        \"weight\": 0.25\n      },\n      {\n        \"name\": \"equity_vol\",\n        \"series\": \"VIXCLS\",\n        \"current_value\": 14.5,\n        \"historical_mean\": 18.2,\n        \"historical_std\": 8.5,\n        \"z\": -0.44,\n        \"signal\": \"mild_risk_on\",\n        \"weight\": 0.20\n      },\n      {\n        \"name\": \"hy_spread\",\n        \"series\": \"BAMLH0A0HYM2\",\n        \"current_value\": 3.2,\n        \"historical_mean\": 3.0,\n        \"historical_std\": 1.2,\n        \"z\": 0.17,\n        \"signal\": \"neutral\",\n        \"weight\": 0.20\n      },\n      {\n        \"name\": \"yield_curve\",\n        \"series\": \"DGS10-DGS2\",\n        \"current_value\": 0.15,\n        \"historical_mean\": 0.8,\n        \"historical_std\": 0.6,\n        \"z\": -1.08,\n        \"signal\": \"mild_stress\",\n        \"weight\": 0.15\n      },\n      {\n        \"name\": \"fed_balance\",\n        \"series\": \"WALCL\",\n        \"current_value\": 7500000,\n        \"historical_mean\": 7200000,\n        \"historical_std\": 500000,\n        \"z\": 0.6,\n        \"signal\": \"neutral\",\n        \"weight\": 0.20\n      }\n    ]\n  },\n  \"composite_risk_score\": 0.49,\n  \"risk_level\": \"medium\",\n  \"interpretation\": {\n    \"summary\": \"走勢形狀與 COVID 早期片段相似度高（0.88），但壓力驗證指標偏中性（0.22），綜合風險分數 0.49（中等）。這更像是「利率/會計結構造成的圖形相似」，不足以支持「系統性壓力升高」的假說。\",\n    \"pattern_analysis\": {\n      \"finding\": \"近期 WUDSHO 走勢與 2020 年 1-6 月的形狀高度相關\",\n      \"possible_causes\": [\n        \"利率環境變化驅動（最可能）\",\n        \"持有債券久期結構調整\",\n        \"會計攤銷時程效果\"\n      ],\n      \"unlikely_cause\": \"系統性金融壓力（缺乏壓力指標共振）\"\n    },\n    \"stress_analysis\": {\n      \"finding\": \"壓力驗證指標大多處於中性區間\",\n      \"key_observations\": [\n        \"信用利差未顯著走寬（z=0.4）\",\n        \"VIX 偏低（z=-0.44），顯示股市風險偏好中性\",\n        \"殖利率曲線輕微倒掛，但非極端\"\n      ]\n    },\n    \"what_to_watch_next_60d\": [\n      \"若形狀相似度維持高檔，同時信用利差明顯走寬（z > 1.5），才應升級風險警報\",\n      \"若 VIX 持續上升並突破 25，顯示市場開始定價風險\",\n      \"觀察 Fed 是否啟用緊急流動性工具（如 BTFP 類似機制）\"\n    ],\n    \"rebuttal_to_claim\": [\n      \"「像」可以量化（相關係數 0.91），但「像 COVID」不等於「會發生 COVID 級事件」\",\n      \"WUDSHO 變動最常見的原因是利率效果，不是金融壓力\",\n      \"把「黑天鵝」定義成「精心策劃」屬於不可驗證敘事；本技能只輸出可被公開資料支持或反駁的部分\"\n    ]\n  },\n  \"data_quality\": {\n    \"target_series\": {\n      \"series_id\": \"WUDSHO\",\n      \"data_start\": \"2015-01-07\",\n      \"data_end\": \"2026-01-22\",\n      \"frequency\": \"W\",\n      \"delay_days\": 4,\n      \"missing_values\": 0\n    },\n    \"confirmatory_series\": [\n      {\"series_id\": \"BAMLC0A0CM\", \"data_end\": \"2026-01-24\", \"status\": \"ok\"},\n      {\"series_id\": \"VIXCLS\", \"data_end\": \"2026-01-24\", \"status\": \"ok\"},\n      {\"series_id\": \"BAMLH0A0HYM2\", \"data_end\": \"2026-01-24\", \"status\": \"ok\"},\n      {\"series_id\": \"DGS10\", \"data_end\": \"2026-01-24\", \"status\": \"ok\"},\n      {\"series_id\": \"DGS2\", \"data_end\": \"2026-01-24\", \"status\": \"ok\"},\n      {\"series_id\": \"WALCL\", \"data_end\": \"2026-01-22\", \"status\": \"ok\"}\n    ]\n  },\n  \"caveats\": [\n    \"形狀相似不代表因果相同；該序列可能強烈受利率、持有期限結構與會計攤銷影響。\",\n    \"若缺乏壓力指標同步惡化，不應把圖形類比直接升級成『黑天鵝預言』。\",\n    \"本工具提供的是『樣態比對 + 交叉驗證』，不是預測器。\",\n    \"任何單一序列都不應被用來做高確信度的危機斷言。\",\n    \"歷史事件樣本有限（4-6 次），統計推論受限。\"\n  ],\n  \"metadata\": {\n    \"executed_at\": \"2026-01-26T10:30:00+08:00\",\n    \"execution_time_ms\": 2350,\n    \"cache_used\": true,\n    \"skill_version\": \"0.1.0\"\n  }\n}\n```\n\n---\n\n## 欄位說明\n\n### 頂層欄位\n\n| 欄位                 | 類型          | 說明                   |\n|----------------------|---------------|------------------------|\n| skill                | string        | 技能名稱               |\n| version              | string        | 技能版本               |\n| as_of_date           | string (date) | 分析截止日期           |\n| target_series        | string        | 目標 FRED 系列代碼     |\n| parameters           | object        | 使用的參數             |\n| best_match           | object        | 最佳匹配的歷史片段     |\n| all_matches          | array         | 所有歷史窗口的匹配結果 |\n| stress_confirmation  | object        | 壓力驗證結果           |\n| composite_risk_score | float         | 合成風險分數 [0-1]     |\n| risk_level           | string        | 風險等級               |\n| interpretation       | object        | 解讀框架               |\n| data_quality         | object        | 資料品質資訊           |\n| caveats              | array[string] | 風險警語               |\n| metadata             | object        | 執行元資料             |\n\n### best_match 欄位\n\n| 欄位                     | 類型          | 說明                  |\n|--------------------------|---------------|-----------------------|\n| baseline                 | string        | 基準窗口名稱          |\n| segment_start            | string (date) | 匹配片段起始日        |\n| segment_end              | string (date) | 匹配片段結束日        |\n| corr                     | float         | 相關係數 [-1, 1]      |\n| dtw                      | float         | DTW 距離（正規化）    |\n| feature_sim              | float         | 形狀特徵相似度 [0, 1] |\n| pattern_similarity_score | float         | 綜合形狀相似度 [0, 1] |\n\n### stress_confirmation 欄位\n\n| 欄位    | 類型  | 說明                |\n|---------|-------|---------------------|\n| score   | float | 壓力驗證總分 [0, 1] |\n| details | array | 各指標詳情          |\n\n### details 物件\n\n| 欄位            | 類型   | 說明          |\n|-----------------|--------|---------------|\n| name            | string | 指標名稱      |\n| series          | string | FRED 系列代碼 |\n| current_value   | float  | 當前值        |\n| historical_mean | float  | 歷史均值      |\n| historical_std  | float  | 歷史標準差    |\n| z               | float  | z-score       |\n| signal          | string | 訊號判斷      |\n| weight          | float  | 權重          |\n\n### signal 可能值\n\n| 值             | 說明         |\n|----------------|--------------|\n| neutral        | 中性         |\n| mild_risk_on   | 輕微風險偏好 |\n| mild_stress    | 輕微壓力     |\n| stress         | 壓力         |\n| extreme_stress | 極端壓力     |\n\n### risk_level 可能值\n\n| 值          | composite_risk_score 範圍 | 說明     |\n|-------------|---------------------------|----------|\n| low         | < 0.3                     | 低風險   |\n| medium      | 0.3 ~ 0.5                 | 中風險   |\n| medium_high | 0.5 ~ 0.7                 | 中高風險 |\n| high        | > 0.7                     | 高風險   |\n\n---\n\n## 精簡輸出模式\n\n使用 `--quick` 時的精簡輸出：\n\n```json\n{\n  \"as_of_date\": \"2026-01-26\",\n  \"best_match\": {\n    \"baseline\": \"COVID_2020\",\n    \"pattern_similarity_score\": 0.88\n  },\n  \"stress_confirmation\": {\n    \"score\": 0.22\n  },\n  \"composite_risk_score\": 0.49,\n  \"risk_level\": \"medium\",\n  \"summary\": \"形狀相似度高但壓力驗證中性，可能是利率效果\"\n}\n```\n",
        "skills/detect-fed-unamortized-discount-pattern/templates/output-markdown.md": "# Markdown 報告模板\n\n## 報告結構\n\n```markdown\n# 聯準會未攤銷折價走勢模式分析報告\n\n**分析日期**: {as_of_date}\n**目標序列**: {target_series}\n**分析版本**: {version}\n\n---\n\n## TL;DR\n\n{interpretation.summary}\n\n---\n\n## 形狀比對結果\n\n### 最佳匹配\n\n| 項目           | 值                                                    |\n|----------------|-------------------------------------------------------|\n| 匹配基準       | {best_match.baseline}                                 |\n| 匹配區間       | {best_match.segment_start} ~ {best_match.segment_end} |\n| 相關係數       | {best_match.corr:.2f}                                 |\n| DTW 距離       | {best_match.dtw:.2f}                                  |\n| 形狀特徵       | {best_match.feature_sim:.2f}                          |\n| **綜合相似度** | **{best_match.pattern_similarity_score:.2f}**         |\n\n### 相似度解讀\n\n| 分數範圍  | 解讀                                                           |\n|-----------|----------------------------------------------------------------|\n| > 0.8     | 高度相似 ← **當前: {best_match.pattern_similarity_score:.2f}** |\n| 0.5 ~ 0.8 | 中度相似                                                       |\n| < 0.5     | 低度相似                                                       |\n\n---\n\n## 壓力驗證結果\n\n**壓力驗證分數**: {stress_confirmation.score:.2f}\n\n| 指標 | 當前值 | z-score | 訊號 |\n|------|--------|---------|------|\n{for indicator in stress_confirmation.details}\n| {indicator.name} | {indicator.current_value:.2f} | {indicator.z:.2f} | {indicator.signal} |\n{endfor}\n\n### 壓力訊號解讀\n\n- 🟢 **neutral**: 中性，無壓力訊號\n- 🟡 **mild_stress**: 輕微壓力，持續觀察\n- 🔴 **stress**: 壓力訊號，需要關注\n- ⚫ **extreme_stress**: 極端壓力，高度警戒\n\n---\n\n## 綜合風險評估\n\n| 項目         | 分數                                      | 權重 |\n|--------------|-------------------------------------------|------|\n| 形狀相似度   | {best_match.pattern_similarity_score:.2f} | 60%  |\n| 壓力驗證     | {stress_confirmation.score:.2f}           | 40%  |\n| **合成風險** | **{composite_risk_score:.2f}**            | -    |\n\n**風險等級**: {risk_level}\n\n| 等級     | 分數範圍  | 當前                                          |\n|----------|-----------|-----------------------------------------------|\n| 低風險   | < 0.3     | {if risk_level == \"low\"}← 當前{endif}         |\n| 中風險   | 0.3 ~ 0.5 | {if risk_level == \"medium\"}← 當前{endif}      |\n| 中高風險 | 0.5 ~ 0.7 | {if risk_level == \"medium_high\"}← 當前{endif} |\n| 高風險   | > 0.7     | {if risk_level == \"high\"}← 當前{endif}        |\n\n---\n\n## 分析解讀\n\n### 形狀分析\n\n**發現**: {interpretation.pattern_analysis.finding}\n\n**可能成因**:\n{for cause in interpretation.pattern_analysis.possible_causes}\n- {cause}\n{endfor}\n\n**不太可能的成因**: {interpretation.pattern_analysis.unlikely_cause}\n\n### 壓力分析\n\n**發現**: {interpretation.stress_analysis.finding}\n\n**關鍵觀察**:\n{for obs in interpretation.stress_analysis.key_observations}\n- {obs}\n{endfor}\n\n---\n\n## 未來 60 天觀察重點\n\n{for item in interpretation.what_to_watch_next_60d}\n- {item}\n{endfor}\n\n---\n\n## 對「黑天鵝」敘事的反證\n\n{for item in interpretation.rebuttal_to_claim}\n> {item}\n{endfor}\n\n---\n\n## 資料品質說明\n\n| 序列                                   | 資料截止                              | 狀態 |\n|----------------------------------------|---------------------------------------|------|\n| {data_quality.target_series.series_id} | {data_quality.target_series.data_end} | ✓    |\n{for series in data_quality.confirmatory_series}\n| {series.series_id} | {series.data_end} | {if series.status == \"ok\"}✓{else}⚠{endif} |\n{endfor}\n\n---\n\n## 風險警語\n\n{for caveat in caveats}\n⚠️ {caveat}\n{endfor}\n\n---\n\n## 執行資訊\n\n| 項目     | 值                                        |\n|----------|-------------------------------------------|\n| 執行時間 | {metadata.executed_at}                    |\n| 耗時     | {metadata.execution_time_ms} ms           |\n| 快取     | {if metadata.cache_used}是{else}否{endif} |\n| 版本     | {metadata.skill_version}                  |\n\n---\n\n*本報告由 detect-fed-unamortized-discount-pattern 技能自動生成*\n*形狀比對 ≠ 事件預測，請結合其他資訊綜合判斷*\n```\n\n---\n\n## 範例輸出\n\n```markdown\n# 聯準會未攤銷折價走勢模式分析報告\n\n**分析日期**: 2026-01-26\n**目標序列**: WUDSHO\n**分析版本**: 0.1.0\n\n---\n\n## TL;DR\n\n走勢形狀與 COVID 早期片段相似度高（0.88），但壓力驗證指標偏中性（0.22），綜合風險分數 0.49（中等）。這更像是「利率/會計結構造成的圖形相似」，不足以支持「系統性壓力升高」的假說。\n\n---\n\n## 形狀比對結果\n\n### 最佳匹配\n\n| 項目           | 值                      |\n|----------------|-------------------------|\n| 匹配基準       | COVID_2020              |\n| 匹配區間       | 2020-01-08 ~ 2020-06-17 |\n| 相關係數       | 0.91                    |\n| DTW 距離       | 0.38                    |\n| 形狀特徵       | 0.82                    |\n| **綜合相似度** | **0.88**                |\n\n### 相似度解讀\n\n| 分數範圍  | 解讀                      |\n|-----------|---------------------------|\n| > 0.8     | 高度相似 ← **當前: 0.88** |\n| 0.5 ~ 0.8 | 中度相似                  |\n| < 0.5     | 低度相似                  |\n\n---\n\n## 壓力驗證結果\n\n**壓力驗證分數**: 0.22\n\n| 指標          | 當前值  | z-score | 訊號         |\n|---------------|---------|---------|--------------|\n| credit_spread | 1.05    | 0.40    | neutral      |\n| equity_vol    | 14.50   | -0.44   | mild_risk_on |\n| hy_spread     | 3.20    | 0.17    | neutral      |\n| yield_curve   | 0.15    | -1.08   | mild_stress  |\n| fed_balance   | 7500000 | 0.60    | neutral      |\n\n### 壓力訊號解讀\n\n- 🟢 **neutral**: 中性，無壓力訊號（3 個指標）\n- 🟡 **mild_stress**: 輕微壓力（殖利率曲線）\n- 🔵 **mild_risk_on**: 偏風險偏好（VIX 偏低）\n\n---\n\n## 綜合風險評估\n\n| 項目         | 分數     | 權重 |\n|--------------|----------|------|\n| 形狀相似度   | 0.88     | 60%  |\n| 壓力驗證     | 0.22     | 40%  |\n| **合成風險** | **0.49** | -    |\n\n**風險等級**: 中風險\n\n---\n\n## 未來 60 天觀察重點\n\n- 若形狀相似度維持高檔，同時信用利差明顯走寬（z > 1.5），才應升級風險警報\n- 若 VIX 持續上升並突破 25，顯示市場開始定價風險\n- 觀察 Fed 是否啟用緊急流動性工具\n\n---\n\n## 對「黑天鵝」敘事的反證\n\n> 「像」可以量化（相關係數 0.91），但「像 COVID」不等於「會發生 COVID 級事件」\n\n> WUDSHO 變動最常見的原因是利率效果，不是金融壓力\n\n> 把「黑天鵝」定義成「精心策劃」屬於不可驗證敘事\n\n---\n\n## 風險警語\n\n⚠️ 形狀相似不代表因果相同；該序列可能強烈受利率、持有期限結構與會計攤銷影響。\n\n⚠️ 若缺乏壓力指標同步惡化，不應把圖形類比直接升級成『黑天鵝預言』。\n\n⚠️ 本工具提供的是『樣態比對 + 交叉驗證』，不是預測器。\n\n---\n\n*本報告由 detect-fed-unamortized-discount-pattern 技能自動生成*\n```\n",
        "skills/detect-fed-unamortized-discount-pattern/workflows/execute-analysis.md": "# Workflow: 完整形狀比對分析\n\n<required_reading>\n**執行前請閱讀：**\n1. references/methodology.md - 形狀比對方法論\n2. references/data-sources.md - 資料來源與 FRED 代碼\n3. references/input-schema.md - 完整參數定義\n</required_reading>\n\n<process>\n\n## Step 1: 資料抓取\n\n從 FRED 抓取目標序列與交叉驗證指標。\n\n```bash\ncd skills/detect-fed-unamortized-discount-pattern\npython scripts/fetch_data.py --series WUDSHO --start 2015-01-01\n```\n\n或直接執行主腳本（自動抓取）：\n\n```bash\npython scripts/pattern_detector.py --quick\n```\n\n**驗證點**：\n- [ ] WUDSHO 資料抓取成功\n- [ ] 交叉驗證指標（信用利差、VIX 等）抓取成功\n- [ ] 資料頻率對齊（週頻）\n\n## Step 2: 窗口切片與正規化\n\n切出近期窗口與歷史基準窗口，進行正規化。\n\n**預設參數**：\n- `recent_window_days`: 120（約 17 週）\n- `normalize_method`: zscore\n- `resample_freq`: W\n\n**正規化目的**：\n- 去除量級差異，只保留「形狀」\n- zscore：均值=0、標準差=1，適合形狀比較\n- pct_change：強調加速/減速，適合動量分析\n\n## Step 3: 形狀相似度計算\n\n使用多種方法計算相似度：\n\n### 3.1 相關係數 (Correlation)\n```\ncorr = pearson_corr(recent_normalized, baseline_normalized)\n```\n- 範圍：-1 ~ 1\n- > 0.7：高度相似\n- 0.4 ~ 0.7：中度相似\n- < 0.4：低度相似\n\n### 3.2 動態時間校正 (DTW)\n```\ndtw_dist = dtw_distance(recent_values, baseline_values)\n```\n- 範圍：0 ~ ∞（越小越相似）\n- < 0.5：高度相似\n- 0.5 ~ 1.5：中度相似\n- > 1.5：低度相似\n\n### 3.3 形狀特徵相似度\n提取特徵：\n- 趨勢斜率（線性回歸斜率）\n- 拐點結構（峰谷數量與位置）\n- 波動擴張（rolling std 變化）\n\n計算特徵向量的餘弦相似度。\n\n## Step 4: 最佳匹配選擇\n\n對每個基準窗口，找出最相似的片段：\n\n```python\nfor baseline_window in baseline_windows:\n    for segment in rolling_segments(baseline, length=recent_length):\n        score = weighted_avg(corr, 1-dtw_norm, feature_sim)\n        if score > best_score:\n            best_match = segment\n```\n\n輸出 `best_match`：\n- baseline 名稱\n- segment_start / segment_end\n- corr / dtw / feature_sim\n- pattern_similarity_score\n\n## Step 5: 壓力驗證\n\n計算交叉驗證指標的壓力分數：\n\n```python\nfor indicator in confirmatory_indicators:\n    data = fetch_series(indicator.series)\n    recent_data = data.last(recent_window_days)\n    z = (recent_data.mean() - historical_mean) / historical_std\n\n    if indicator.name == \"yield_curve\":\n        signal = \"stress\" if z < indicator.stress_threshold else \"neutral\"\n    else:\n        signal = \"stress\" if z > indicator.stress_threshold else \"neutral\"\n\n    stress_score += indicator.weight * (1 if signal == \"stress\" else 0)\n```\n\n輸出 `stress_confirmation`：\n- score（0-1）\n- details（各指標名稱、訊號、z-score）\n\n## Step 6: 合成風險分數\n\n```python\ncomposite = 0.6 * pattern_similarity_score + 0.4 * stress_confirmation_score\n```\n\n**解讀**：\n- > 0.7：高風險，形狀相似且壓力驗證支持\n- 0.4 ~ 0.7：中風險，形狀相似但壓力驗證中性\n- < 0.4：低風險，形狀不相似或壓力驗證反對\n\n## Step 7: 解讀生成\n\n生成結構化解讀：\n\n### summary\n一句話總結：形狀相似度 + 壓力驗證 → 風險判斷\n\n### what_to_watch_next_60d\n未來 60 天觀察重點：\n- 若形狀相似度維持高檔 + 壓力指標開始惡化 → 升級警報\n- 若形狀相似度下降或壓力指標改善 → 降級警報\n\n### rebuttal_to_claim\n對「黑天鵝」敘事的反證：\n- 形狀相似的替代解釋（利率效果、會計效果）\n- 當前缺乏哪些壓力共振訊號\n- 「像」≠「會發生」的認知提醒\n\n## Step 8: 輸出結果\n\n```bash\npython scripts/pattern_detector.py \\\n  --target_series WUDSHO \\\n  --baseline_windows \"COVID_2020:2020-01-01:2020-06-30\" \\\n  --recent_window_days 120 \\\n  --output result.json\n```\n\n輸出檔案：\n- `result.json`：完整 JSON 結果\n- `result.md`：Markdown 報告（若指定 --markdown）\n\n</process>\n\n<success_criteria>\n工作流完成時應產出：\n\n- [ ] 成功抓取 WUDSHO 資料\n- [ ] 成功抓取所有交叉驗證指標\n- [ ] 計算完成 pattern_similarity_score\n- [ ] 計算完成 stress_confirmation_score\n- [ ] 計算完成 composite_risk_score\n- [ ] 生成完整 interpretation\n- [ ] 輸出 JSON 結果檔\n- [ ] 包含 caveats 風險警語\n</success_criteria>\n",
        "skills/detect-fed-unamortized-discount-pattern/workflows/historical-episodes.md": "# Workflow: 歷史事件對照分析\n\n<required_reading>\n**執行前請閱讀：**\n1. references/methodology.md - 形狀比對方法論\n2. references/wudsho-mechanism.md - WUDSHO 指標機制\n</required_reading>\n\n<process>\n\n## Step 1: 理解歷史基準窗口\n\n本技能預設的歷史基準窗口：\n\n### COVID_2020 (2020-01-01 ~ 2020-06-30)\n**背景**：\n- 2020 年初 COVID-19 全球擴散\n- 市場恐慌，流動性危機\n- Fed 宣布無限 QE\n\n**WUDSHO 走勢**：\n- 初期：利率快速下降，未攤銷折價變動劇烈\n- 後期：QE 大量購債，持有結構改變\n\n**後續發展**：\n- 市場 V 型反轉\n- 股市創新高\n- 通膨最終爆發\n\n### GFC_2008 (2008-09-01 ~ 2009-03-31)\n**背景**：\n- 雷曼兄弟倒閉\n- 全球金融危機\n- 信用凍結\n\n**WUDSHO 走勢**：\n- 劇烈波動\n- QE1 開始後逐漸穩定\n\n**後續發展**：\n- 長期低利率環境\n- 量化寬鬆常態化\n- 緩慢復甦\n\n### TAPER_2013 (2013-05-01 ~ 2013-09-30)\n**背景**：\n- Bernanke 暗示縮減 QE\n- 「縮減恐慌」(Taper Tantrum)\n- 新興市場資金外流\n\n**WUDSHO 走勢**：\n- 利率上升驅動\n- 非系統性壓力\n\n**後續發展**：\n- 利率上升但經濟持續復甦\n- 股市續創新高\n- 2015 年開始升息\n\n### RATE_HIKE_2022 (2022-01-01 ~ 2022-12-31)\n**背景**：\n- Fed 激進升息\n- 通膨對抗\n- 債券大熊市\n\n**WUDSHO 走勢**：\n- 利率快速上升\n- 持有債券市值大幅下降\n- 未攤銷折價劇增\n\n**後續發展**：\n- SVB 銀行倒閉（2023-03）\n- 區域銀行危機\n- Fed 緊急流動性支持\n\n## Step 2: 事件後統計分析\n\n對每個歷史事件，計算後續的市場表現：\n\n### 計算指標\n\n```python\nforward_windows = [60, 180, 365]  # 天\n\nfor event in historical_events:\n    for window in forward_windows:\n        # 股市報酬\n        sp500_return = calculate_return(event.end_date, window)\n\n        # 信用利差變化\n        spread_change = calculate_spread_change(event.end_date, window)\n\n        # VIX 變化\n        vix_change = calculate_vix_change(event.end_date, window)\n\n        # 最大回撤\n        max_drawdown = calculate_max_drawdown(event.end_date, window)\n```\n\n### 歷史統計表\n\n| 事件 | 60d 報酬 | 180d 報酬 | 365d 報酬 | 最大回撤 |\n|------|----------|-----------|-----------|----------|\n| COVID_2020 | +15% | +35% | +50% | -34% (已發生) |\n| GFC_2008 | -15% | +20% | +30% | -57% (已發生) |\n| TAPER_2013 | +5% | +10% | +15% | -6% |\n| RATE_HIKE_2022 | -5% | +10% | +20% | -25% |\n\n**注意**：這是「條件分布」，不是預測。\n\n## Step 3: 當前 vs. 歷史比較\n\n### 形狀相似度比較\n\n```\n當前 vs. COVID_2020: corr=0.85, dtw=0.42, sim=0.82\n當前 vs. GFC_2008:   corr=0.45, dtw=1.20, sim=0.38\n當前 vs. TAPER_2013: corr=0.72, dtw=0.65, sim=0.68\n當前 vs. RATE_HIKE:  corr=0.78, dtw=0.55, sim=0.75\n```\n\n### 壓力指標比較\n\n| 指標 | 當前 | COVID 峰值 | GFC 峰值 | 2022 峰值 |\n|------|------|------------|----------|-----------|\n| IG 利差 | 1.0% | 4.0% | 6.0% | 1.5% |\n| VIX | 15 | 80 | 80 | 35 |\n| HY 利差 | 3.5% | 11% | 20% | 6% |\n\n## Step 4: 情境推演\n\n### 情境 A: 形狀相似 + 壓力驗證支持\n- 若未來 60 天內壓力指標開始惡化\n- 參考歷史：COVID 初期、GFC 初期\n- 可能發展：市場波動加劇，Fed 可能介入\n\n### 情境 B: 形狀相似 + 壓力驗證不支持\n- 當前狀態：壓力指標中性\n- 參考歷史：Taper Tantrum\n- 可能發展：利率效果為主，非系統性壓力\n\n### 情境 C: 形狀開始偏離\n- 若相關係數開始下降\n- 圖形類比失效\n- 回歸正常觀察\n\n## Step 5: 輸出歷史對照報告\n\n```bash\npython scripts/pattern_detector.py \\\n  --historical_analysis \\\n  --output historical_report.json\n```\n\n輸出內容：\n- 各基準窗口的形狀相似度\n- 歷史事件後續統計\n- 當前 vs. 歷史的壓力指標比較\n- 情境推演說明\n\n</process>\n\n<success_criteria>\n工作流完成時應產出：\n\n- [ ] 各基準窗口的詳細說明\n- [ ] 形狀相似度排名\n- [ ] 歷史事件後續統計\n- [ ] 壓力指標的歷史比較\n- [ ] 情境推演（至少 2-3 個情境）\n- [ ] 明確標註「條件分布 ≠ 預測」\n</success_criteria>\n",
        "skills/detect-fed-unamortized-discount-pattern/workflows/visualize-analysis.md": "# Workflow: 視覺化分析\n\n<required_reading>\n**執行前請閱讀：**\n1. references/methodology.md - 形狀比對方法論\n2. templates/output-markdown.md - 報告格式\n</required_reading>\n\n<process>\n\n## Step 1: 確認依賴\n\n```bash\npip install matplotlib pandas numpy requests scipy\n```\n\n## Step 2: 執行視覺化腳本\n\n```bash\ncd skills/detect-fed-unamortized-discount-pattern\npython scripts/visualize_pattern.py -o output\n```\n\n**參數選項**：\n- `-o, --output`: 輸出目錄（預設 output）\n- `--target_series`: 目標序列（預設 WUDSHO）\n- `--recent_days`: 近期窗口天數（預設 120）\n- `--baseline`: 基準窗口名稱（預設 COVID_2020）\n\n## Step 3: 輸出圖表說明\n\n### 圖表 1: 形狀比對圖 (`pattern_comparison_YYYY-MM-DD.png`)\n\n**內容**：\n- 上圖：近期窗口 vs. 歷史基準窗口的正規化走勢疊加\n- 下圖：原始數值走勢（雙 Y 軸）\n\n**標註**：\n- 相關係數、DTW 距離、形狀特徵相似度\n- 時間對齊說明\n\n### 圖表 2: 壓力指標儀表板 (`stress_dashboard_YYYY-MM-DD.png`)\n\n**內容**：\n- 各交叉驗證指標的當前 z-score\n- 歷史分布參考（分位數標示）\n- 壓力門檻線\n\n**色彩編碼**：\n- 綠色：中性（無壓力）\n- 黃色：警戒（z-score 接近門檻）\n- 紅色：壓力（z-score 超過門檻）\n\n### 圖表 3: 歷史走勢對照 (`historical_overlay_YYYY-MM-DD.png`)\n\n**內容**：\n- WUDSHO 完整歷史走勢\n- 標記所有基準窗口位置\n- 當前位置標註\n\n## Step 4: 輸出檔案清單\n\n執行後應產生：\n\n```\noutput/\n├── pattern_comparison_YYYY-MM-DD.png    # 形狀比對圖\n├── stress_dashboard_YYYY-MM-DD.png      # 壓力指標儀表板\n├── historical_overlay_YYYY-MM-DD.png    # 歷史走勢對照\n└── pattern_analysis_YYYY-MM-DD.json     # JSON 結果\n```\n\n## Step 5: 圖表解讀指引\n\n### 如何解讀形狀比對圖\n\n1. **看形狀趨勢**：兩條線是否「同漲同跌」\n2. **看時間對齊**：拐點是否在相似位置\n3. **看相關係數**：> 0.7 為高度相似\n4. **看 DTW 距離**：< 0.5 為高度相似\n\n### 如何解讀壓力儀表板\n\n1. **綠色居多**：壓力驗證不支持風險假說\n2. **黃色居多**：需要持續觀察\n3. **紅色居多**：壓力驗證支持風險假說\n\n### 綜合判讀\n\n| 形狀相似度 | 壓力儀表板 | 解讀                            |\n|------------|------------|---------------------------------|\n| 高         | 綠色       | 可能是利率/會計效果，非真正壓力 |\n| 高         | 黃/紅      | 需要提高警覺，持續觀察          |\n| 低         | 任何       | 形狀不相似，圖形類比不成立      |\n\n</process>\n\n<success_criteria>\n工作流完成時應產出：\n\n- [ ] `pattern_comparison_YYYY-MM-DD.png` - 形狀比對圖\n- [ ] `stress_dashboard_YYYY-MM-DD.png` - 壓力指標儀表板\n- [ ] `historical_overlay_YYYY-MM-DD.png` - 歷史走勢對照\n- [ ] `pattern_analysis_YYYY-MM-DD.json` - JSON 結果\n- [ ] 圖表清晰可讀，標註完整\n</success_criteria>\n",
        "skills/detect-freight-led-inflation-turn/SKILL.md": "---\nname: detect-freight-led-inflation-turn\ndescription: 透過美國卡斯貨運指數 (CASS Freight Index) 的週期轉折，偵測美國通膨壓力是否進入放緩或反轉階段。用於判斷「通膨是否正在降溫」，並驗證市場對降息、通膨回落的宏觀敘事是否有實體經濟數據支撐。\n---\n\n<essential_principles>\n\n<principle name=\"cass_freight_index\">\n**CASS Freight Index 是最權威的貨運指標**\n\nCASS Freight Index 由 Cass Information Systems 編制，追蹤北美地區的貨運出貨量與支出：\n\n| 指標                   | 說明         | 用途                         |\n|------------------------|--------------|------------------------------|\n| **Shipments Index**    | 出貨量指數   | 衡量實體經濟需求強度         |\n| **Expenditures Index** | 運費支出指數 | 衡量物流成本壓力             |\n| **Shipments YoY**      | 出貨量年增率 | 偵測週期轉折（主要分析指標） |\n| **Expenditures YoY**   | 支出年增率   | 驗證成本傳導                 |\n\n數據來源：MacroMicro (透過 Highcharts 爬取)\n</principle>\n\n<principle name=\"freight_leads_inflation\">\n**貨運量是通膨的領先指標**\n\n核心邏輯：\n- 貨運量 ≈ 實體經濟需求強度\n- 出貨量下降 → 終端需求減弱 → 定價能力下降\n- 歷史上 CASS 指標對 CPI 具有約 4-6 個月的領先性\n\n關鍵訊號不是單月變化，而是「週期轉折」：\n- 年增率轉負 (turned negative)\n- 創週期新低 (new cycle low)\n</principle>\n\n<principle name=\"signal_interpretation\">\n**訊號解讀：通膨緩解而非通縮**\n\n當偵測到 CASS 週期轉折：\n- 結論是「通膨壓力緩解」而非「通縮」\n- 屬於 inflation easing / disinflation regime\n- 支持市場對降息或政策轉向的預期\n\n這是跨週期關係辨識：「物流需求動能 → 通膨方向」\n</principle>\n\n<principle name=\"multi_indicator\">\n**多指標交叉驗證**\n\n建議同時觀察四個 CASS 指標：\n1. **Shipments YoY**（主要）：需求端訊號\n2. **Expenditures YoY**：成本端訊號\n3. **Shipments Index**：絕對水準\n4. **Expenditures Index**：運費壓力\n\n當 Shipments 和 Expenditures 同時轉負，訊號更為可靠。\n</principle>\n\n</essential_principles>\n\n<objective>\n偵測 CASS Freight Index 的週期轉折，判斷通膨是否正在放緩。\n\n輸出三層訊號：\n1. **Freight Status**: CASS 各指標狀態與週期位置\n2. **Lead Alignment**: 與 CPI YoY 的領先對齊分析\n3. **Signal Assessment**: 通膨緩解訊號判斷與信心水準\n</objective>\n\n<quick_start>\n\n**最快的方式：使用 Chrome CDP 抓取數據**\n\n**Step 1：安裝依賴**\n```bash\npip install requests websocket-client pandas numpy\n```\n\n**Step 2：啟動 Chrome 調試模式**\n```bash\n# Windows\n\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" ^\n  --remote-debugging-port=9222 ^\n  --remote-allow-origins=* ^\n  --user-data-dir=\"%USERPROFILE%\\.chrome-debug-profile\" ^\n  \"https://www.macromicro.me/charts/46877/cass-freight-index\"\n```\n\n**Step 3：等待頁面完全載入（圖表顯示），然後執行**\n```bash\ncd scripts\npython fetch_cass_freight.py --cdp\n```\n\n**Step 4：執行通膨訊號分析**\n```bash\npython freight_inflation_detector.py --quick\n```\n\n**Step 5：生成視覺化圖表**\n```bash\npython visualize_freight_cpi.py \\\n  --cache cache/cass_freight_cdp.json \\\n  --output ../../output/freight_cpi_$(date +%Y-%m-%d).png \\\n  --start 1995-01-01\n```\n\n**輸出範例**：\n- JSON 分析結果：\n```json\n{\n  \"signal\": \"inflation_easing\",\n  \"confidence\": \"high\",\n  \"freight_yoy\": -7.46,\n  \"cycle_status\": \"negative\",\n  \"indicator\": \"shipments_yoy\",\n  \"macro_implication\": \"通膨壓力正在放緩，未來 CPI 下行風險上升\"\n}\n```\n- 視覺化圖表：`output/freight_cpi_2026-01-23.png`\n\n**備選方法（Selenium）**：\n```bash\npip install selenium webdriver-manager\npython scripts/fetch_cass_freight.py --selenium --no-headless\n```\n\n</quick_start>\n\n<intake>\n需要進行什麼分析？\n\n1. **快速檢查** - 查看最新的 CASS 指標與通膨先行訊號\n2. **完整分析** - 執行完整的週期轉折偵測與領先性分析\n3. **方法論學習** - 了解 CASS 指標與通膨的領先關係\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                     | Action                                                      |\n|------------------------------|-------------------------------------------------------------|\n| 1, \"快速\", \"quick\", \"check\"  | 執行 `python scripts/freight_inflation_detector.py --quick` |\n| 2, \"完整\", \"full\", \"analyze\" | 閱讀 `workflows/analyze.md` 並執行                          |\n| 3, \"學習\", \"方法論\", \"why\"   | 閱讀 `references/methodology.md`                            |\n| 提供參數 (如日期範圍)        | 閱讀 `workflows/analyze.md` 並使用參數執行                  |\n\n**路由後，閱讀對應文件並執行。**\n</routing>\n\n<directory_structure>\n```\ndetect-freight-led-inflation-turn/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元資料\n├── workflows/\n│   ├── analyze.md                     # 完整分析工作流\n│   └── quick-check.md                 # 快速檢查工作流\n├── references/\n│   ├── data-sources.md                # CASS 數據來源與爬蟲說明\n│   ├── methodology.md                 # 領先性方法論解析\n│   └── historical-episodes.md         # 歷史案例對照\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n├── scripts/\n│   ├── fetch_cass_freight.py          # MacroMicro CASS 爬蟲\n│   ├── fetch_via_cdp.py               # Chrome CDP 爬蟲模組\n│   ├── freight_inflation_detector.py  # 主分析腳本\n│   └── visualize_freight_cpi.py       # CASS vs CPI 領先性視覺化\n└── examples/\n    └── sample_output.json             # 範例輸出\n```\n</directory_structure>\n\n<reference_index>\n\n**方法論**: references/methodology.md\n- CASS Freight Index 與 CPI 的領先性關係\n- 週期轉折偵測邏輯\n- 訊號強度評估標準\n\n**資料來源**: references/data-sources.md\n- MacroMicro Highcharts 爬蟲說明\n- CASS 四個指標定義\n- 快取策略與更新頻率\n\n**歷史案例**: references/historical-episodes.md\n- 2008 金融危機前後\n- 2020 疫情期間\n- 2022 通膨高峰期\n\n</reference_index>\n\n<workflows_index>\n| Workflow       | Purpose          | 使用時機           |\n|----------------|------------------|--------------------|\n| analyze.md     | 完整週期轉折分析 | 需要深度分析時     |\n| quick-check.md | 快速檢查訊號     | 日常監控或快速回答 |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構定義 |\n| output-markdown.md | Markdown 報告模板 |\n</templates_index>\n\n<scripts_index>\n| Script                        | Command                            | Purpose                    |\n|-------------------------------|------------------------------------|----------------------------|\n| fetch_cass_freight.py         | `--cdp`                            | 使用 CDP 爬取（推薦）      |\n| fetch_cass_freight.py         | `--selenium --no-headless`         | 使用 Selenium 爬取（備選） |\n| freight_inflation_detector.py | `--quick`                          | 快速檢查最新訊號           |\n| freight_inflation_detector.py | `--start DATE --indicator X`       | 完整分析                   |\n| visualize_freight_cpi.py      | `--lead-months 6 --start DATE`     | 繪製 CASS vs CPI 領先圖    |\n</scripts_index>\n\n<visualization>\n\n**視覺化輸出：CASS vs CPI 領先性對比圖**\n\n核心特徵（參考 Bloomberg/Refinitiv 風格）：\n1. **CASS 6M Forward**：將 CASS Freight Index 向前移動 6 個月，直觀展示領先關係\n2. **雙軸對比**：CPI YoY（左軸藍線）vs CASS Shipments YoY（右軸灰線）\n3. **衰退區間標記**：NBER 官方衰退期以淺色陰影標示\n4. **Bloomberg 深色風格**：深藍背景、高對比度配色\n\n**快速繪圖**：\n```bash\ncd scripts\npython visualize_freight_cpi.py \\\n  --cache cache/cass_freight_cdp.json \\\n  --output ../../output/freight_cpi_YYYY-MM-DD.png \\\n  --start 1995-01-01 \\\n  --lead-months 6\n```\n\n**輸出路徑**：`output/freight_cpi_YYYY-MM-DD.png`（根目錄）\n\n**圖表解讀**：\n- 當 CASS（灰線）先行轉負/創新低，而 CPI（藍線）仍在高位 → 通膨放緩訊號\n- 當 CASS 與 CPI 走勢同步 → 領先關係暫時失效，需謹慎解讀\n\n</visualization>\n\n<input_schema>\n\n<parameter name=\"start_date\" required=\"true\">\n**Type**: string (ISO YYYY-MM-DD)\n**Description**: 分析起始日期\n**Example**: \"2010-01-01\"\n</parameter>\n\n<parameter name=\"end_date\" required=\"false\" default=\"today\">\n**Type**: string (ISO YYYY-MM-DD)\n**Description**: 分析結束日期\n</parameter>\n\n<parameter name=\"indicator\" required=\"false\" default=\"shipments_yoy\">\n**Type**: string\n**Options**: `shipments_index` | `expenditures_index` | `shipments_yoy` | `expenditures_yoy`\n**Description**: CASS 指標選擇\n- `shipments_yoy`: 出貨量年增率（推薦，主要分析指標）\n- `expenditures_yoy`: 支出年增率\n- `shipments_index`: 出貨量指數\n- `expenditures_index`: 支出指數\n</parameter>\n\n<parameter name=\"lead_months\" required=\"false\" default=\"6\">\n**Type**: integer\n**Description**: 領先 CPI 的月份數\n**Range**: 3-12\n</parameter>\n\n<parameter name=\"yoy_threshold\" required=\"false\" default=\"0.0\">\n**Type**: float\n**Description**: 年增率警戒門檻（如 0 表示轉負）\n</parameter>\n\n</input_schema>\n\n<output_schema>\n參見 `templates/output-json.md` 的完整結構定義。\n\n**摘要**：\n```json\n{\n  \"signal\": \"inflation_easing | inflation_rising | neutral\",\n  \"confidence\": \"high | medium | low\",\n  \"freight_yoy\": -2.9,\n  \"cycle_status\": \"new_cycle_low | negative | positive\",\n  \"indicator\": \"shipments_yoy\",\n  \"macro_implication\": \"通膨壓力正在放緩，未來 CPI 下行風險上升\",\n  \"all_indicators\": {\n    \"shipments_index\": {...},\n    \"expenditures_index\": {...},\n    \"shipments_yoy\": {...},\n    \"expenditures_yoy\": {...}\n  }\n}\n```\n</output_schema>\n\n<success_criteria>\n分析成功時應產出：\n\n- [ ] CASS 四個指標的最新數值\n- [ ] 選定指標的 YoY 與週期狀態\n- [ ] 與 CPI 的領先對齊驗證\n- [ ] 通膨緩解訊號與信心水準\n- [ ] **CASS vs CPI 領先性對比圖**（output/freight_cpi_YYYY-MM-DD.png）\n- [ ] 可操作的宏觀解讀\n- [ ] 明確標註資料限制與假設\n</success_criteria>\n",
        "skills/detect-freight-led-inflation-turn/references/data-sources.md": "<overview>\n此參考文件列出貨運領先通膨分析所需的資料來源，包括 CASS Freight Index 的 MacroMicro 爬蟲說明。\n\n**資料來源**：\n- **CASS Freight Index**：MacroMicro Highcharts 圖表（主要）\n- **CPI**：FRED（輔助驗證用）\n\n**推薦方法**：Chrome CDP（繞過 Cloudflare）\n</overview>\n\n<data_access_methods>\n\n<method name=\"chrome_cdp\" recommended=\"true\">\n**Chrome CDP 方法（推薦）**\n\n透過 Chrome DevTools Protocol 連接到已開啟的 Chrome 瀏覽器，完全繞過 Cloudflare 和反爬蟲偵測。\n\n**原理**：\n```\n┌─────────────────┐     WebSocket      ┌─────────────────┐\n│  Python Script  │ ◄────────────────► │  Chrome Browser │\n│  (CDP Client)   │    Port 9222       │  (你的 Profile) │\n└─────────────────┘                    └─────────────────┘\n        │                                      │\n        │ Runtime.evaluate()                   │\n        ▼                                      ▼\n   執行 JavaScript ──────────────────► 提取 Highcharts 數據\n```\n\n**前置準備**：\n```bash\n# 安裝依賴\npip install requests websocket-client pandas\n```\n\n**操作流程**：\n\n**Step 1：關閉所有 Chrome 視窗**\n\n**Step 2：啟動 Chrome（帶調試端口）**\n\n```bash\n# Windows\n\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" ^\n  --remote-debugging-port=9222 ^\n  --remote-allow-origins=* ^\n  --user-data-dir=\"%USERPROFILE%\\.chrome-debug-profile\" ^\n  \"https://www.macromicro.me/charts/46877/cass-freight-index\"\n```\n\n```bash\n# macOS\n/Applications/Google\\ Chrome.app/Contents/MacOS/Google\\ Chrome \\\n  --remote-debugging-port=9222 \\\n  --remote-allow-origins=* \\\n  --user-data-dir=\"$HOME/.chrome-debug-profile\" \\\n  \"https://www.macromicro.me/charts/46877/cass-freight-index\"\n```\n\n**Step 3：等待頁面完全載入**（圖表顯示）\n\n**Step 4：執行爬蟲腳本**\n```bash\ncd scripts\npython fetch_cass_freight.py --cdp\n```\n\n**關鍵參數說明**：\n\n| 參數 | 說明 |\n|------|------|\n| `--remote-debugging-port=9222` | 開啟 CDP 調試端口 |\n| `--remote-allow-origins=*` | 允許所有來源連線（**必要**） |\n| `--user-data-dir=<path>` | 指定 profile 目錄（**必須非預設**） |\n\n**腳本位置**: `scripts/fetch_cass_freight.py`\n</method>\n\n<method name=\"selenium\" recommended=\"false\">\n**Selenium 方法（備選）**\n\n當 CDP 方法不可用時的備選方案。注意：**Cloudflare 經常會擋住 Selenium**。\n\n```bash\n# 安裝依賴\npip install selenium webdriver-manager pandas\n\n# 執行（顯示瀏覽器視窗以便手動通過驗證）\npython scripts/fetch_cass_freight.py --selenium --no-headless\n```\n\n**配置**：\n```python\nCASS_FREIGHT_URL = \"https://www.macromicro.me/charts/46877/cass-freight-index\"\nCHART_WAIT_SECONDS = 35  # 等待圖表渲染\nMAX_RETRIES = 3\n```\n\n**腳本位置**: `scripts/fetch_cass_freight.py`\n</method>\n\n<method name=\"fred_csv\">\n**FRED CSV Endpoint（CPI 資料）**\n\n```\nhttps://fred.stlouisfed.org/graph/fredgraph.csv?id=CPIAUCSL\n```\n\n**用途**：取得 CPI 數據進行領先性驗證\n\n**腳本位置**: `scripts/freight_inflation_detector.py` (內建)\n</method>\n\n</data_access_methods>\n\n<cass_freight_index>\n\n**CASS Freight Index 四個指標**\n\n| 指標 Key | 系列名稱 | 說明 | 用途 |\n|----------|----------|------|------|\n| `shipments_index` | Shipments Index | 出貨量指數 | 衡量實體經濟需求強度 |\n| `expenditures_index` | Expenditures Index | 運費支出指數 | 衡量物流成本壓力 |\n| `shipments_yoy` | Shipments YoY | 出貨量年增率 | **主要分析指標**（週期轉折偵測） |\n| `expenditures_yoy` | Expenditures YoY | 支出年增率 | 驗證成本傳導 |\n\n**資料特性**：\n- 由 Cass Information Systems 編制\n- 追蹤北美地區的貨運出貨量與支出\n- 月度更新，約滯後 1 個月\n- 涵蓋卡車和鐵路運輸\n\n**推薦指標優先順序**：\n1. `shipments_yoy` - 最適合週期轉折偵測\n2. `expenditures_yoy` - 交叉驗證用\n3. `shipments_index` / `expenditures_index` - 絕對水準參考\n\n</cass_freight_index>\n\n<cpi_series>\n\n**CPI 指標（FRED）**\n\n| 別名 | Series ID | 描述 | 頻率 | 更新延遲 |\n|------|-----------|------|------|----------|\n| `cpi_headline` | CPIAUCSL | CPI All Urban Consumers | 月 | ~15 天 |\n\n**CPIAUCSL**：\n- 來源：Bureau of Labor Statistics (BLS)\n- 涵蓋：所有城市消費者\n- 季節調整：是\n- 用途：計算通膨年增率，驗證貨運的領先性\n\n</cpi_series>\n\n<highcharts_extraction>\n\n**Highcharts 數據提取邏輯**\n\nMacroMicro 使用 Highcharts 渲染圖表，數據存儲在全域 `Highcharts.charts` 陣列中：\n\n```javascript\n// 瀏覽器控制台中執行\nHighcharts.charts                    // 所有圖表實例\nHighcharts.charts[0].series          // 第一個圖表的所有 series\nHighcharts.charts[0].series[0].data  // 第一個 series 的數據點\n```\n\n**數據提取 JavaScript**：\n```javascript\n(function() {\n    if (typeof Highcharts === 'undefined' || !Highcharts.charts) {\n        return JSON.stringify({error: 'Highcharts not found'});\n    }\n\n    var charts = Highcharts.charts.filter(c => c !== undefined && c !== null);\n    var result = [];\n\n    for (var i = 0; i < charts.length; i++) {\n        var chart = charts[i];\n        var chartInfo = {\n            title: chart.title ? chart.title.textStr : 'Chart ' + i,\n            series: []\n        };\n\n        for (var j = 0; j < chart.series.length; j++) {\n            var s = chart.series[j];\n            var seriesData = [];\n\n            // 優先使用 xData/yData\n            if (s.xData && s.xData.length > 0) {\n                for (var k = 0; k < s.xData.length; k++) {\n                    seriesData.push({\n                        x: s.xData[k],\n                        y: s.yData[k],\n                        date: new Date(s.xData[k]).toISOString().split('T')[0]\n                    });\n                }\n            } else if (s.data && s.data.length > 0) {\n                seriesData = s.data.map(function(point) {\n                    return {\n                        x: point.x,\n                        y: point.y,\n                        date: point.x ? new Date(point.x).toISOString().split('T')[0] : null\n                    };\n                });\n            }\n\n            chartInfo.series.push({\n                name: s.name,\n                dataLength: seriesData.length,\n                data: seriesData\n            });\n        }\n        result.push(chartInfo);\n    }\n    return JSON.stringify(result);\n})()\n```\n\n**Series 匹配關鍵字**：\n```python\nCASS_SERIES_KEYWORDS = {\n    \"shipments_index\": [\"Shipments Index\", \"shipments index\", \"Shipments\"],\n    \"expenditures_index\": [\"Expenditures Index\", \"expenditures index\", \"Expenditures\"],\n    \"shipments_yoy\": [\"Shipments YoY\", \"shipments yoy\", \"Shipments Year\"],\n    \"expenditures_yoy\": [\"Expenditures YoY\", \"expenditures yoy\", \"Expenditures Year\"]\n}\n```\n\n</highcharts_extraction>\n\n<cache_strategy>\n\n**快取策略**\n\n| 參數 | 值 | 說明 |\n|------|-----|------|\n| 快取目錄 | `./cache` | 預設 |\n| 最大有效期 | 12 小時 | CASS 為月度數據，無需頻繁更新 |\n| 快取檔案 | `cass_freight_cache.json` | 原始 Highcharts 數據 |\n| CSV 檔案 | `cass_{indicator}.csv` | 各指標獨立儲存 |\n\n**使用快取**：\n```bash\npython scripts/fetch_cass_freight.py --cdp --cache-dir ./cache\n```\n\n**強制更新**：\n```bash\npython scripts/fetch_cass_freight.py --cdp --cache-dir ./cache --force-refresh\n```\n\n</cache_strategy>\n\n<update_schedule>\n\n**資料更新時程**\n\n| 資料 | 來源 | 更新頻率 | 延遲 | 建議抓取時機 |\n|------|------|---------|------|-------------|\n| CASS Freight Index | MacroMicro | 月 | ~30 天 | 每月月底 |\n| CPI | FRED | 月 | ~15 天 | 每月中旬 |\n\n**監控建議**：\n- 每月月底檢查 CASS 更新\n- 設定快取有效期為 12 小時\n- 重大經濟事件後可手動更新\n\n</update_schedule>\n\n<fallback_sources>\n\n**備用數據源**\n\n若 MacroMicro 無法存取：\n\n1. **Cass Information Systems 官網**\n   - https://www.cassinfo.com/freight-audit-payment/cass-transportation-indexes\n   - 需手動下載 PDF/Excel\n\n2. **其他替代指標（FRED 免費）**\n   - TSI (Transportation Services Index): 涵蓋多種運輸方式\n   - TRUCKD11 (Truck Tonnage Index): 卡車運量\n\n**CASS vs 替代指標**：\n| 指標 | 優點 | 缺點 |\n|------|------|------|\n| CASS | 最權威、細分完整 | 需爬蟲取得 |\n| TSI | FRED 免費、涵蓋廣 | 平滑波動 |\n| TRUCKD11 | FRED 免費、敏感度高 | 僅卡車 |\n\n</fallback_sources>\n\n<troubleshooting>\n\n**常見問題排解**\n\n**Q1: WebSocket 連線被拒絕 (403 Forbidden)**\n\n確認啟動 Chrome 時有加上 `--remote-allow-origins=*` 參數。\n\n**Q2: 無法連接到 Chrome 調試端口**\n\n1. 確保所有 Chrome 視窗都已關閉\n2. 確認使用了非預設的 `--user-data-dir`\n3. 檢查端口 9222 是否被佔用：`curl -s http://127.0.0.1:9222/json`\n\n**Q3: Highcharts not found**\n\n1. 確認頁面已完全載入（圖表已顯示）\n2. 在瀏覽器 Console 中執行 `typeof Highcharts` 確認\n3. 可能需要登入 MacroMicro 帳號\n\n**Q4: 被 Cloudflare 擋住**\n\n1. 使用 CDP 方法而非 Selenium\n2. 在 Chrome 中手動完成 Cloudflare 驗證\n3. 登入 MacroMicro 帳號後再執行\n\n</troubleshooting>\n\n<scripts_reference>\n\n**資料抓取腳本**\n\n| 腳本 | 功能 | 資料來源 |\n|------|------|---------|\n| `scripts/fetch_cass_freight.py` | 抓取 CASS 四個指標 | MacroMicro |\n| `scripts/freight_inflation_detector.py` | 完整分析（含 CPI） | MacroMicro + FRED |\n\n**使用範例**：\n\n```bash\n# 方法一：Chrome CDP（推薦）\n# 先啟動 Chrome 調試模式，載入目標頁面，然後：\npython scripts/fetch_cass_freight.py --cdp\n\n# 方法二：Selenium（備選）\npython scripts/fetch_cass_freight.py --selenium --no-headless\n\n# 快速檢查\npython scripts/freight_inflation_detector.py --quick\n\n# 完整分析（使用 shipments_yoy）\npython scripts/freight_inflation_detector.py --start 2015-01-01 --indicator shipments_yoy\n```\n\n</scripts_reference>\n\n<related_guides>\n\n**相關指南**\n\n- [Chrome CDP 數據爬取 SOP](../../../thoughts/shared/guide/chrome-cdp-scraping-sop.md)\n- [MacroMicro Highcharts 爬蟲指南](../../../thoughts/shared/guide/macromicro-highcharts-crawler.md)\n\n</related_guides>\n",
        "skills/detect-freight-led-inflation-turn/references/historical-episodes.md": "<overview>\n此參考文件記錄歷史上 CASS Freight Index 與通膨轉折的重要案例，用於驗證方法論的有效性，並提供當前訊號的歷史對照。\n</overview>\n\n<historical_context>\n\n**為何需要歷史對照**\n\n1. **驗證領先性**：確認 CASS 指標確實領先 CPI 轉折\n2. **估計領先時間**：不同週期的領先時間可能不同\n3. **識別失真情況**：哪些情況下訊號會失效\n4. **建立心理錨點**：當前數據在歷史分布中的位置\n\n</historical_context>\n\n<episode name=\"2008_financial_crisis\">\n**2008 金融危機**\n\n```\n時間軸：\n2007-Q4：CASS Shipments YoY 開始下滑\n2008-Q1：CASS Shipments YoY 轉負，創 12 個月新低\n2008-Q3：CASS Shipments YoY 創週期低點 (-8%)\n2008-Q4：CPI YoY 開始快速下滑\n2009-Q1：CPI YoY 接近 0%\n```\n\n**數據摘要**：\n\n| 指標 | 轉折時間 | 低點時間 | 低點值 |\n|------|---------|---------|-------|\n| CASS Shipments YoY | 2008-02 | 2009-01 | -10.2% |\n| CPI YoY | 2008-09 | 2009-07 | -2.1% |\n| 領先月數 | - | - | 約 6 個月 |\n\n**關鍵觀察**：\n- CASS 在金融危機前 6-7 個月就開始發出警訊\n- 訊號強度：**高**（YoY 大幅轉負 + 創週期新低）\n- 領先時間：約 6 個月\n- Shipments 和 Expenditures 同時轉負\n\n**當時的宏觀背景**：\n- 次貸危機爆發\n- 信貸緊縮\n- 需求急劇萎縮\n\n</episode>\n\n<episode name=\"2015_manufacturing_slowdown\">\n**2015 製造業衰退**\n\n```\n時間軸：\n2014-Q4：CASS Shipments YoY 開始放緩\n2015-Q2：CASS Shipments YoY 轉負\n2015-Q4：CASS Shipments YoY 低點 (-3.5%)\n2016-Q1：CPI YoY 觸底 (0.7%)\n```\n\n**數據摘要**：\n\n| 指標 | 轉折時間 | 低點時間 | 低點值 |\n|------|---------|---------|-------|\n| CASS Shipments YoY | 2015-04 | 2015-12 | -3.1% |\n| CPI YoY | 2015-10 | 2016-02 | 0.7% |\n| 領先月數 | - | - | 約 4-6 個月 |\n\n**關鍵觀察**：\n- 製造業衰退但服務業支撐經濟\n- 訊號強度：**中**（YoY 轉負但幅度較小）\n- CPI 未跌至負值，因服務業通膨維持\n- 領先時間：約 4-6 個月\n\n**當時的宏觀背景**：\n- 油價崩跌\n- 美元走強\n- 全球製造業放緩\n- 中國經濟減速\n\n</episode>\n\n<episode name=\"2020_covid_pandemic\">\n**2020 新冠疫情**\n\n```\n時間軸：\n2020-03：CASS Shipments YoY 急劇下滑\n2020-04：CASS Shipments YoY 低點 (-12%)\n2020-05：CPI YoY 低點 (0.1%)\n2020-Q3：CASS 快速反彈\n2021-Q1：通膨開始上升\n```\n\n**數據摘要**：\n\n| 指標 | 轉折時間 | 低點時間 | 低點值 |\n|------|---------|---------|-------|\n| CASS Shipments YoY | 2020-03 | 2020-04 | -12.3% |\n| CPI YoY | 2020-04 | 2020-05 | 0.1% |\n| 領先月數 | - | - | 約 1 個月（異常） |\n\n**關鍵觀察**：\n- **異常案例**：供給側衝擊導致領先性失真\n- 訊號強度：難以判斷（供給 vs 需求混淆）\n- CASS 下降是封城導致，非需求自然減弱\n- 後續通膨反彈遠超預期\n\n**教訓**：\n- 供給側衝擊時，CASS 訊號需謹慎解讀\n- 政策干預（財政刺激）可能扭曲領先關係\n\n</episode>\n\n<episode name=\"2022_inflation_peak\">\n**2022 通膨高峰**\n\n```\n時間軸：\n2022-Q1：CASS Shipments YoY 仍高 (+5%)\n2022-Q2：CASS Shipments YoY 開始下滑\n2022-Q4：CASS Shipments YoY 轉負 (-2%)\n2023-Q1：CPI YoY 開始明顯回落\n2023-Q2：CPI YoY 持續下降\n```\n\n**數據摘要**：\n\n| 指標 | 峰值時間 | 轉折時間 | 領先關係 |\n|------|---------|---------|---------|\n| CASS Shipments YoY | 2022-01 | 2022-10 | 領先 CPI 約 4 個月 |\n| CPI YoY | 2022-06 | 2023-01 | - |\n\n**關鍵觀察**：\n- CASS 在 CPI 見頂前約 5 個月就開始發出放緩訊號\n- 訊號強度：**中高**（YoY 從高位回落並轉負）\n- 驗證了 CASS 對通膨的領先性\n- 領先時間：約 4-5 個月\n- Shipments 和 Expenditures 走勢一致\n\n**當時的宏觀背景**：\n- Fed 激進升息\n- 供應鏈逐漸正常化\n- 需求從商品轉向服務\n\n</episode>\n\n<summary_table>\n\n**歷史案例摘要**\n\n| 案例 | CASS 低點 | CPI 低點/轉折 | 領先月數 | 訊號品質 | 特殊因素 |\n|------|---------|--------------|---------|---------|---------|\n| 2008 金融危機 | 2009-01 | 2009-07 | 6 | 高 | 信貸危機 |\n| 2015 製造業衰退 | 2015-12 | 2016-02 | 4-6 | 中 | 油價崩跌 |\n| 2020 疫情 | 2020-04 | 2020-05 | 1 (異常) | 低 | 供給衝擊 |\n| 2022 通膨高峰 | 2022-10 | 2023-01 | 4-5 | 中高 | Fed 升息 |\n\n**平均領先時間**：約 4-6 個月（排除異常值）\n\n</summary_table>\n\n<current_positioning>\n\n**當前數據的歷史定位**\n\n使用以下框架評估當前訊號：\n\n```python\ndef historical_positioning(current_cass_yoy: float, historical_data: pd.Series) -> dict:\n    \"\"\"\n    計算當前 CASS YoY 在歷史分布中的位置\n\n    Parameters\n    ----------\n    current_cass_yoy : float\n        當前 CASS Shipments YoY\n    historical_data : pd.Series\n        歷史 YoY 序列\n\n    Returns\n    -------\n    dict\n        百分位數和歷史對照\n    \"\"\"\n    percentile = (historical_data < current_cass_yoy).mean() * 100\n\n    # 找類似歷史時期\n    similar_periods = historical_data[\n        (historical_data > current_cass_yoy - 1) &\n        (historical_data < current_cass_yoy + 1)\n    ]\n\n    return {\n        'current_value': current_cass_yoy,\n        'percentile': percentile,\n        'similar_count': len(similar_periods),\n        'historical_context': get_historical_context(percentile)\n    }\n\ndef get_historical_context(percentile: float) -> str:\n    \"\"\"根據百分位提供歷史對照\"\"\"\n    if percentile < 10:\n        return \"極低，歷史上僅出現在衰退或危機期間（2008、2020）\"\n    elif percentile < 25:\n        return \"偏低，通常對應經濟放緩期\"\n    elif percentile < 75:\n        return \"中性區間，需觀察趨勢方向\"\n    elif percentile < 90:\n        return \"偏高，經濟活動活躍\"\n    else:\n        return \"極高，歷史上對應擴張期或復甦期\"\n```\n\n**解讀建議**：\n- 百分位 < 20%：高度警戒，可能預示通膨放緩\n- 百分位 20-80%：中性，關注趨勢方向\n- 百分位 > 80%：經濟活躍，通膨壓力可能延續\n\n</current_positioning>\n\n<lessons_learned>\n\n**從歷史案例學到的教訓**\n\n1. **供給側衝擊需特別處理**\n   - 2020 疫情案例顯示，供給側導致的 CASS 下降不等於需求減弱\n   - 建議：結合 PMI 新訂單、ISM 等需求指標驗證\n\n2. **領先時間會變動**\n   - 正常週期約 4-6 個月\n   - 危機時期可能縮短（因傳導加速）\n   - 政策干預可能延長\n\n3. **多指標驗證更可靠**\n   - 單一指標可能受特定因素干擾\n   - CASS Shipments + Expenditures 一致性更重要\n\n4. **週期轉折比單月波動重要**\n   - 關注「創新低」而非「轉負」\n   - 持續時間比幅度更有預測力\n\n5. **結構性變化需考慮**\n   - 電商、服務業占比變化\n   - 傳統指標的代表性可能下降\n\n</lessons_learned>\n",
        "skills/detect-freight-led-inflation-turn/references/methodology.md": "1. **CASS Freight Index = 北美實體經濟活動的先行指標**\n   - 商品從生產端到消費端必須經過運輸\n   - CASS 追蹤北美地區卡車與鐵路貨運\n   - 出貨量反映「即將被消費」的商品數量\n\n2. **需求減弱 → 定價能力下降**\n   - 終端需求轉弱時，企業難以轉嫁成本\n   - 價格增速放緩，CPI 隨之下降\n\n3. **領先性來源**\n   - 貨運發生在最終銷售之前\n   - 庫存調整週期約 3–6 個月\n   - CPI 統計本身存在 2–4 週滯後\n\n---\n\n### 為何選擇 CASS Freight Index\n\n| 指標                   | 優勢                           | 劣勢                 |\n|------------------------|--------------------------------|----------------------|\n| **CASS Freight Index** | 最權威、涵蓋卡車＋鐵路、有 YoY | 封閉商業資料         |\n| TSI                    | FRED 免費、涵蓋廣              | 波動被平滑、反應較慢 |\n| TRUCKD11               | FRED 免費、敏感度高            | 僅涵蓋卡車           |\n\n#### CASS 四個指標的角色\n\n1. **Shipments YoY（主要分析指標）**\n   - 直接反映需求端變化\n   - 適合週期轉折偵測\n   - YoY 自動消除季節性\n\n2. **Expenditures YoY**\n   - 反映運費成本壓力\n   - 可交叉驗證 Shipments 訊號\n   - 成本傳導通常有額外滯後\n\n3. **Shipments Index / Expenditures Index**\n   - 絕對水準參考\n   - 適合長期趨勢觀察\n\n---\n\n### 學術與實證依據\n\n1. **Stock & Watson (1999), *Forecasting Inflation***\n   - 實質經濟活動指標對通膨具有預測能力\n   - 運輸指標屬有效先行指標\n\n2. **Cass Freight Index 長期報告**\n   - 驗證貨運量領先 GDP 與通膨\n   - 多次週期中表現穩定\n\n3. **聯準會相關研究**\n   - 供應鏈壓力對通膨存在顯著滯後\n   - 運輸成本傳導至 CPI 約需 4–6 個月\n\n### 方法限制\n\n1. 供給側干擾: 港口壅塞、運輸瓶頸可能扭曲訊號\n2. 結構性變化: 電商、服務業比重上升, 製造業貨運代表性下降\n3. 全球化因素: 匯率與進口通膨可能獨立於北美貨運\n4. 政策干預: 財政與貨幣政策可能改變通膨傳導路徑\n\n### 使用建議\n\n- 不單獨使用一個訊號\n- 搭配政策、供給與其他實體指標",
        "skills/detect-freight-led-inflation-turn/templates/output-json.md": "<template_description>\nCASS Freight Index 週期轉折分析的 JSON 輸出模板。\n此模板定義完整分析結果的結構。\n</template_description>\n\n<json_schema>\n```json\n{\n  \"metadata\": {\n    \"analysis_time\": \"ISO 8601 timestamp\",\n    \"start_date\": \"YYYY-MM-DD\",\n    \"end_date\": \"YYYY-MM-DD\",\n    \"indicator\": \"shipments_yoy | expenditures_yoy | shipments_index | expenditures_index\",\n    \"lead_months\": \"integer\",\n    \"as_of_date\": \"YYYY-MM-DD (資料最新日期)\"\n  },\n\n  \"freight_status\": {\n    \"indicator\": \"string (如 shipments_yoy)\",\n    \"series_name\": \"string (如 CASS Shipments YoY)\",\n    \"latest_value\": \"number (最新值)\",\n    \"yoy\": \"number (年增率 % - 若使用 YoY 指標則與 latest_value 相同)\",\n    \"yoy_3m_avg\": \"number (3 個月平均 %)\",\n    \"cycle_status\": \"new_cycle_low | negative | positive\",\n    \"is_new_cycle_low\": \"boolean\",\n    \"cycle_low_window\": \"integer (回看月數)\",\n    \"consecutive_negative_months\": \"integer (連續負值月數)\"\n  },\n\n  \"all_indicators\": {\n    \"shipments_index\": {\n      \"latest_value\": \"number\",\n      \"status\": \"string\"\n    },\n    \"expenditures_index\": {\n      \"latest_value\": \"number\",\n      \"status\": \"string\"\n    },\n    \"shipments_yoy\": {\n      \"latest_value\": \"number\",\n      \"status\": \"string\"\n    },\n    \"expenditures_yoy\": {\n      \"latest_value\": \"number\",\n      \"status\": \"string\"\n    }\n  },\n\n  \"cpi_status\": {\n    \"latest_yoy\": \"number (CPI YoY %)\",\n    \"yoy_3m_avg\": \"number (3 個月平均 CPI YoY %)\",\n    \"trend\": \"rising | falling | stable\"\n  },\n\n  \"lead_alignment\": {\n    \"correlation\": \"number (CASS 領先 vs CPI 相關係數)\",\n    \"lead_months\": \"integer (使用的領先月數)\",\n    \"optimal_lead\": \"integer (最佳領先月數)\",\n    \"alignment_quality\": \"high | medium | low\"\n  },\n\n  \"signal_assessment\": {\n    \"signal\": \"inflation_easing | inflation_rising | neutral\",\n    \"confidence\": \"high | medium | low\",\n    \"macro_implication\": \"string (宏觀含義)\"\n  },\n\n  \"historical_positioning\": {\n    \"current_percentile\": \"number (當前 YoY 在歷史中的百分位)\",\n    \"similar_periods\": [\"YYYY-MM (類似歷史時期)\"],\n    \"context\": \"string (歷史對照說明)\"\n  },\n\n  \"interpretation\": [\n    \"string (解讀文字 1)\",\n    \"string (解讀文字 2)\"\n  ],\n\n  \"caveats\": [\n    \"string (注意事項 1)\",\n    \"string (注意事項 2)\"\n  ]\n}\n```\n</json_schema>\n\n<example_output>\n```json\n{\n  \"metadata\": {\n    \"analysis_time\": \"2026-01-23T10:30:00.000Z\",\n    \"start_date\": \"2015-01-01\",\n    \"end_date\": \"2025-12-01\",\n    \"indicator\": \"shipments_yoy\",\n    \"lead_months\": 6,\n    \"as_of_date\": \"2025-12-01\"\n  },\n  \"freight_status\": {\n    \"indicator\": \"shipments_yoy\",\n    \"series_name\": \"CASS Shipments YoY\",\n    \"latest_value\": -2.9,\n    \"yoy\": -2.9,\n    \"yoy_3m_avg\": -2.1,\n    \"cycle_status\": \"new_cycle_low\",\n    \"is_new_cycle_low\": true,\n    \"cycle_low_window\": 18,\n    \"consecutive_negative_months\": 4\n  },\n  \"all_indicators\": {\n    \"shipments_index\": {\n      \"latest_value\": 1.15,\n      \"status\": \"stable\"\n    },\n    \"expenditures_index\": {\n      \"latest_value\": 4.25,\n      \"status\": \"declining\"\n    },\n    \"shipments_yoy\": {\n      \"latest_value\": -2.9,\n      \"status\": \"new_cycle_low\"\n    },\n    \"expenditures_yoy\": {\n      \"latest_value\": -1.5,\n      \"status\": \"negative\"\n    }\n  },\n  \"cpi_status\": {\n    \"latest_yoy\": 2.8,\n    \"yoy_3m_avg\": 2.9,\n    \"trend\": \"stable\"\n  },\n  \"lead_alignment\": {\n    \"correlation\": 0.62,\n    \"lead_months\": 6,\n    \"optimal_lead\": 5,\n    \"alignment_quality\": \"high\"\n  },\n  \"signal_assessment\": {\n    \"signal\": \"inflation_easing\",\n    \"confidence\": \"high\",\n    \"macro_implication\": \"通膨壓力正在放緩，未來 CPI 下行風險上升\"\n  },\n  \"historical_positioning\": {\n    \"current_percentile\": 15.2,\n    \"similar_periods\": [\"2015-11\", \"2019-08\"],\n    \"context\": \"偏低，通常對應經濟放緩期\"\n  },\n  \"interpretation\": [\n    \"CASS Shipments YoY 已轉為負值（-2.9%），並創下本輪週期新低。\",\n    \"歷史上此類訊號通常領先 CPI 約 5-6 個月。\",\n    \"當前 CPI 仍在 2.8%，但預期將在未來 4-6 個月內開始放緩。\",\n    \"訊號強度高：連續 4 個月負增長 + 創 18 個月新低。\",\n    \"Expenditures YoY 同樣轉負（-1.5%），交叉驗證支持此訊號。\"\n  ],\n  \"caveats\": [\n    \"CASS 數據來自 MacroMicro，透過 Highcharts 爬取\",\n    \"數據約滯後 1 個月，最新值為 2025-12\",\n    \"若有供給側衝擊（如罷工、天災），訊號可能失真\",\n    \"領先相關性基於歷史數據，未來關係可能改變\"\n  ]\n}\n```\n</example_output>\n\n<field_descriptions>\n\n<field name=\"metadata\">\n分析元資料，包含時間範圍、使用的指標和參數。\n</field>\n\n<field name=\"freight_status\">\nCASS Freight Index 狀態分析。\n- `indicator`: 選用的 CASS 指標\n- `yoy`: 最新年增率（若使用 Index 指標則需計算）\n- `cycle_status`: 週期狀態\n  - `new_cycle_low`: YoY 轉負且創 N 個月新低\n  - `negative`: YoY 為負但非新低\n  - `positive`: YoY 為正\n- `consecutive_negative_months`: 連續負增長月數，越長訊號越強\n</field>\n\n<field name=\"all_indicators\">\nCASS 四個指標的最新狀態概覽。\n- `shipments_index`: 出貨量指數\n- `expenditures_index`: 支出指數\n- `shipments_yoy`: 出貨量年增率（主要分析指標）\n- `expenditures_yoy`: 支出年增率（交叉驗證用）\n</field>\n\n<field name=\"cpi_status\">\nCPI 通膨狀態，用於對照驗證。\n- `trend`: 根據 3M 動量判斷趨勢方向\n</field>\n\n<field name=\"lead_alignment\">\nCASS 對 CPI 的領先性分析。\n- `correlation`: 相關係數，越高表示領先關係越穩定\n- `optimal_lead`: 歷史最佳領先月數（相關性最高時）\n- `alignment_quality`: 根據相關係數判斷對齊品質\n</field>\n\n<field name=\"signal_assessment\">\n訊號評估與宏觀解讀。\n- `signal`: 訊號類型\n- `confidence`: 信心水準\n- `macro_implication`: 一句話宏觀含義，可直接用於報告\n</field>\n\n<field name=\"historical_positioning\">\n當前數據在歷史分布中的位置。\n- `current_percentile`: 百分位數，越低表示越接近歷史低點\n- `similar_periods`: 歷史上類似的時期\n- `context`: 歷史對照說明\n</field>\n\n<field name=\"interpretation\">\n可操作的解讀文字，適合直接用於報告或交易筆記。\n</field>\n\n<field name=\"caveats\">\n分析的限制與注意事項，務必閱讀。\n</field>\n\n</field_descriptions>\n\n<signal_definitions>\n\n**訊號類型定義**\n\n| Signal | 條件 | 含義 |\n|--------|------|------|\n| `inflation_easing` | CASS YoY < 0 | 通膨壓力緩解中 |\n| `inflation_rising` | CASS YoY > 5 且上升 | 通膨壓力可能上升 |\n| `neutral` | 其他情況 | 方向不明，需持續觀察 |\n\n**信心水準定義**\n\n| Confidence | 條件 | 建議行動 |\n|------------|------|---------|\n| `high` | 新週期低點 + 連續負值 + 高對齊品質 + 多指標一致 | 可作為主要參考 |\n| `medium` | 部分條件滿足 | 結合其他指標驗證 |\n| `low` | 訊號模糊或對齊品質低 | 僅作參考，謹慎使用 |\n\n</signal_definitions>\n",
        "skills/detect-freight-led-inflation-turn/templates/output-markdown.md": "<template_description>\nCASS Freight Index 週期轉折分析的 Markdown 報告模板。\n適合用於研究報告、交易筆記或團隊分享。\n</template_description>\n\n<markdown_template>\n```markdown\n# CASS Freight Index 週期轉折分析報告\n\n**分析日期**: {{analysis_time}}\n**資料期間**: {{start_date}} 至 {{end_date}}\n**分析指標**: {{indicator_name}}\n**領先月數**: {{lead_months}} 個月\n**資料截至**: {{as_of_date}}\n\n---\n\n## 摘要\n\n{{signal_emoji}} **訊號**: {{signal_text}}\n**信心水準**: {{confidence_text}}\n\n> {{macro_implication}}\n\n---\n\n## CASS Freight Index 狀態\n\n| 指標 | 數值 | 說明 |\n|------|------|------|\n| Shipments YoY | {{shipments_yoy}}% | {{shipments_interpretation}} |\n| Expenditures YoY | {{expenditures_yoy}}% | {{expenditures_interpretation}} |\n| 週期狀態 | {{cycle_status_emoji}} {{cycle_status_text}} | {{cycle_interpretation}} |\n| 連續負值月數 | {{consecutive_months}} | {{consecutive_interpretation}} |\n\n### 四個指標概覽\n\n| 指標 | 最新值 | 狀態 |\n|------|-------|------|\n| Shipments Index | {{shipments_index}} | {{shipments_index_status}} |\n| Expenditures Index | {{expenditures_index}} | {{expenditures_index_status}} |\n| Shipments YoY | {{shipments_yoy}}% | {{shipments_yoy_status}} |\n| Expenditures YoY | {{expenditures_yoy}}% | {{expenditures_yoy_status}} |\n\n---\n\n## CPI 對照\n\n| 指標 | 數值 |\n|------|------|\n| CPI YoY | {{cpi_yoy}}% |\n| CPI 3M 平均 | {{cpi_yoy_3m}}% |\n| 趨勢 | {{cpi_trend_emoji}} {{cpi_trend}} |\n\n**領先對照**：\n- CASS YoY 於 {{cass_turn_date}} 轉折\n- 預期 CPI 於 {{expected_cpi_turn}} 開始反映\n\n---\n\n## 領先性驗證\n\n| 指標 | 數值 | 說明 |\n|------|------|------|\n| 相關係數 | {{correlation}} | {{correlation_interpretation}} |\n| 最佳領先月數 | {{optimal_lead}} 個月 | 歷史最佳 |\n| 對齊品質 | {{alignment_quality_emoji}} {{alignment_quality}} | |\n\n---\n\n## 歷史定位\n\n**當前百分位**: {{percentile}}%（越低越接近歷史低點）\n\n**類似歷史時期**：\n{{#similar_periods}}\n- {{period}}: {{context}}\n{{/similar_periods}}\n\n**歷史對照**：{{historical_context}}\n\n---\n\n## 解讀與建議\n\n{{#interpretation}}\n- {{.}}\n{{/interpretation}}\n\n### 監控重點\n\n1. **短期**：觀察 CASS Shipments YoY 是否持續負增長\n2. **中期**：CPI 是否在預期時間內開始放緩\n3. **驗證**：Shipments 和 Expenditures 是否一致\n\n### 可能的交易含義\n\n{{#signal_is_easing}}\n- 通膨放緩利好：長期國債、成長股\n- Fed 降息預期可能上升\n- 防禦性資產相對優勢\n{{/signal_is_easing}}\n\n{{#signal_is_rising}}\n- 通膨壓力延續：大宗商品、通膨連結債券\n- 升息預期可能維持\n- 價值股相對優勢\n{{/signal_is_rising}}\n\n{{#signal_is_neutral}}\n- 方向不明，建議觀望\n- 等待更明確訊號\n- 維持平衡配置\n{{/signal_is_neutral}}\n\n---\n\n## 注意事項\n\n{{#caveats}}\n- ⚠️ {{.}}\n{{/caveats}}\n\n---\n\n*此報告由 detect-freight-led-inflation-turn Skill 自動生成*\n*資料來源: MacroMicro (CASS), FRED (CPI)*\n```\n</markdown_template>\n\n<variable_definitions>\n\n| 變數 | 說明 | 範例 |\n|------|------|------|\n| `{{analysis_time}}` | 分析執行時間 | 2026-01-23 10:30 |\n| `{{start_date}}` | 分析起始日 | 2015-01-01 |\n| `{{end_date}}` | 分析結束日 | 2025-12-01 |\n| `{{indicator_name}}` | 分析指標名稱 | CASS Shipments YoY |\n| `{{lead_months}}` | 使用的領先月數 | 6 |\n| `{{as_of_date}}` | 資料最新日期 | 2025-12-01 |\n| `{{signal_emoji}}` | 訊號符號 | 📉 / 📈 / ⚪ |\n| `{{signal_text}}` | 訊號文字 | 通膨緩解 |\n| `{{confidence_text}}` | 信心水準 | 高 / 中 / 低 |\n| `{{macro_implication}}` | 宏觀含義 | 通膨壓力正在放緩... |\n| `{{shipments_yoy}}` | Shipments YoY | -2.9 |\n| `{{expenditures_yoy}}` | Expenditures YoY | -1.5 |\n| `{{cycle_status_emoji}}` | 週期狀態符號 | 🔻 / ⚪ / 🔺 |\n| `{{cycle_status_text}}` | 週期狀態文字 | 週期新低 |\n| `{{percentile}}` | 歷史百分位 | 15.2 |\n\n</variable_definitions>\n\n<signal_emoji_mapping>\n- `inflation_easing` → 📉 通膨緩解\n- `inflation_rising` → 📈 通膨上行\n- `neutral` → ⚪ 中性\n</signal_emoji_mapping>\n\n<cycle_status_emoji_mapping>\n- `new_cycle_low` → 🔻 週期新低\n- `negative` → ⬇️ 負增長\n- `positive` → ⬆️ 正增長\n</cycle_status_emoji_mapping>\n\n<alignment_quality_emoji_mapping>\n- `high` → 🟢 高\n- `medium` → 🟡 中\n- `low` → 🔴 低\n</alignment_quality_emoji_mapping>\n\n<example_filled_report>\n```markdown\n# CASS Freight Index 週期轉折分析報告\n\n**分析日期**: 2026-01-23 10:30\n**資料期間**: 2015-01-01 至 2025-12-01\n**分析指標**: CASS Shipments YoY\n**領先月數**: 6 個月\n**資料截至**: 2025-12-01\n\n---\n\n## 摘要\n\n📉 **訊號**: 通膨緩解\n**信心水準**: 高\n\n> 通膨壓力正在放緩，未來 CPI 下行風險上升\n\n---\n\n## CASS Freight Index 狀態\n\n| 指標 | 數值 | 說明 |\n|------|------|------|\n| Shipments YoY | -2.9% | 年增率轉負 |\n| Expenditures YoY | -1.5% | 同樣轉負，交叉驗證 |\n| 週期狀態 | 🔻 週期新低 | 創 18 個月新低 |\n| 連續負值月數 | 4 | 訊號強度高 |\n\n### 四個指標概覽\n\n| 指標 | 最新值 | 狀態 |\n|------|-------|------|\n| Shipments Index | 1.15 | 穩定 |\n| Expenditures Index | 4.25 | 下降 |\n| Shipments YoY | -2.9% | 週期新低 |\n| Expenditures YoY | -1.5% | 負增長 |\n\n---\n\n## CPI 對照\n\n| 指標 | 數值 |\n|------|------|\n| CPI YoY | 2.8% |\n| CPI 3M 平均 | 2.9% |\n| 趨勢 | ⬇️ 略降 |\n\n**領先對照**：\n- CASS YoY 於 2025-08 轉負\n- 預期 CPI 於 2026-02 開始明顯放緩\n\n---\n\n## 領先性驗證\n\n| 指標 | 數值 | 說明 |\n|------|------|------|\n| 相關係數 | 0.62 | 領先關係穩定 |\n| 最佳領先月數 | 5 個月 | 歷史最佳 |\n| 對齊品質 | 🟢 高 | |\n\n---\n\n## 歷史定位\n\n**當前百分位**: 15.2%（越低越接近歷史低點）\n\n**類似歷史時期**：\n- 2015-11: 製造業衰退期，後續 CPI 放緩\n- 2019-08: 經濟放緩期，Fed 降息\n\n**歷史對照**：偏低，通常對應經濟放緩期\n\n---\n\n## 解讀與建議\n\n- CASS Shipments YoY 已轉為負值（-2.9%），並創下本輪週期新低。\n- Expenditures YoY 同樣轉負（-1.5%），交叉驗證支持此訊號。\n- 歷史上此類訊號通常領先 CPI 約 5-6 個月。\n- 當前 CPI 仍在 2.8%，但預期將在未來 4-6 個月內開始放緩。\n- 訊號強度高：連續 4 個月負增長 + 創 18 個月新低。\n\n### 監控重點\n\n1. **短期**：觀察 CASS Shipments YoY 是否持續負增長\n2. **中期**：CPI 是否在預期時間內開始放緩\n3. **驗證**：Shipments 和 Expenditures 是否一致\n\n### 可能的交易含義\n\n- 通膨放緩利好：長期國債、成長股\n- Fed 降息預期可能上升\n- 防禦性資產相對優勢\n\n---\n\n## 注意事項\n\n- ⚠️ CASS 數據來自 MacroMicro，透過 Highcharts 爬取\n- ⚠️ 數據約滯後 1 個月，最新值為 2025-12\n- ⚠️ 若有供給側衝擊（如罷工、天災），訊號可能失真\n- ⚠️ 領先相關性基於歷史數據，未來關係可能改變\n\n---\n\n*此報告由 detect-freight-led-inflation-turn Skill 自動生成*\n*資料來源: MacroMicro (CASS), FRED (CPI)*\n```\n</example_filled_report>\n",
        "skills/detect-freight-led-inflation-turn/workflows/analyze.md": "<required_reading>\n**執行此 workflow 前，先閱讀：**\n1. references/data-sources.md - CASS Freight Index 資料來源與爬蟲說明（含 Chrome CDP 方法）\n2. references/methodology.md - CASS 與通膨領先性方法論\n</required_reading>\n\n<objective>\n執行完整的 CASS Freight Index 週期轉折分析，產出三層訊號：Freight Status、Lead Alignment、Signal Assessment。\n</objective>\n\n<process>\n\n<step number=\"1\" name=\"抓取 CASS 數據\">\n\n**方法一：Chrome CDP（推薦）**\n\nChrome CDP 可以繞過 Cloudflare 防護，是最可靠的抓取方法。\n\n```bash\n# 安裝依賴\npip install requests websocket-client pandas numpy\n```\n\n**啟動 Chrome 調試模式**（關閉所有 Chrome 視窗後執行）：\n\n**Windows**:\n```bash\n\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" ^\n  --remote-debugging-port=9222 ^\n  --remote-allow-origins=* ^\n  --user-data-dir=\"%USERPROFILE%\\.chrome-debug-profile\" ^\n  \"https://www.macromicro.me/charts/46877/cass-freight-index\"\n```\n\n**macOS**:\n```bash\n/Applications/Google\\ Chrome.app/Contents/MacOS/Google\\ Chrome \\\n  --remote-debugging-port=9222 \\\n  --remote-allow-origins=* \\\n  --user-data-dir=\"$HOME/.chrome-debug-profile\" \\\n  \"https://www.macromicro.me/charts/46877/cass-freight-index\"\n```\n\n等待頁面完全載入（圖表顯示），然後執行：\n```bash\ncd scripts\npython fetch_cass_freight.py --cdp --cache-dir ./cache\n```\n\n**方法二：Selenium（備選）**\n\n若 CDP 不可用：\n```bash\npip install selenium webdriver-manager pandas numpy\npython scripts/fetch_cass_freight.py --selenium --no-headless --cache-dir ./cache\n```\n\n</step>\n\n<step number=\"2\" name=\"執行分析腳本\">\n\n**使用 Python 腳本執行分析**\n\n```bash\n# 進入 scripts 目錄\ncd scripts\n\n# 執行完整分析\npython freight_inflation_detector.py \\\n  --start {START_DATE} \\\n  --end {END_DATE} \\\n  --indicator {INDICATOR} \\\n  --lead-months {LEAD_MONTHS} \\\n  --yoy-threshold {YOY_THRESHOLD} \\\n  --cache-dir ./cache \\\n  --output analysis_result.json\n```\n\n**參數說明**：\n- `--start`: 起始日期 (YYYY-MM-DD)，建議至少 10 年歷史\n- `--end`: 結束日期 (YYYY-MM-DD)\n- `--indicator`: CASS 指標選擇\n  - `shipments_yoy`（推薦，主要分析指標）\n  - `expenditures_yoy`\n  - `shipments_index`\n  - `expenditures_index`\n- `--lead-months`: 領先月數（預設 6）\n- `--yoy-threshold`: YoY 警戒門檻（預設 0.0）\n- `--cache-dir`: 快取目錄（使用步驟 1 抓取的數據）\n\n**範例**：\n```bash\n# 使用 Shipments YoY，分析 2015 年至今\npython freight_inflation_detector.py --start 2015-01-01 --indicator shipments_yoy --cache-dir ./cache\n\n# 使用 Expenditures YoY，領先 4 個月\npython freight_inflation_detector.py --start 2015-01-01 --indicator expenditures_yoy --lead-months 4 --cache-dir ./cache\n\n# 快速檢查（使用快取）\npython freight_inflation_detector.py --quick --cache-dir ./cache\n```\n\n**輸出範例**：\n```\nCASS Freight Index 數據摘要\n==================================================\n\n[shipments_index]\n  數據點: 300\n  範圍: 2000-01-01 ~ 2025-12-01\n  最新值: 1.15\n\n[expenditures_index]\n  數據點: 300\n  範圍: 2000-01-01 ~ 2025-12-01\n  最新值: 4.25\n\n[shipments_yoy]\n  數據點: 288\n  範圍: 2001-01-01 ~ 2025-12-01\n  最新值: -2.9\n\n[expenditures_yoy]\n  數據點: 288\n  範圍: 2001-01-01 ~ 2025-12-01\n  最新值: -1.5\n```\n\n</step>\n\n<step number=\"3\" name=\"計算週期狀態\">\n\n**核心計算邏輯（已內建於腳本）**\n\n```python\nimport pandas as pd\n\n# 1. 偵測週期低點\ndef detect_cycle_low(yoy: pd.Series, window: int = 18) -> pd.Series:\n    \"\"\"\n    偵測是否為 N 個月新低\n\n    Parameters\n    ----------\n    yoy : pd.Series\n        CASS YoY 序列\n    window : int\n        回看窗口（月）\n\n    Returns\n    -------\n    pd.Series\n        布林值，True 表示為週期新低\n    \"\"\"\n    rolling_min = yoy.rolling(window=window, min_periods=window).min()\n    return yoy == rolling_min\n\n# 2. 判斷週期狀態\ndef get_cycle_status(latest_yoy: float, is_new_low: bool) -> str:\n    \"\"\"\n    判斷週期狀態\n\n    Returns\n    -------\n    str\n        'new_cycle_low' | 'negative' | 'positive'\n    \"\"\"\n    if is_new_low and latest_yoy < 0:\n        return 'new_cycle_low'\n    elif latest_yoy < 0:\n        return 'negative'\n    else:\n        return 'positive'\n```\n\n**驗證要點**：\n- CASS YoY 數據直接使用（已是年增率）\n- 週期低點窗口設定合理（12-18 個月）\n- 處理缺失值（使用 ffill 或 interpolate）\n\n</step>\n\n<step number=\"4\" name=\"進行領先對齊分析\">\n\n**將 CASS YoY 與 CPI YoY 對齊**\n\n```python\ndef lead_alignment_analysis(\n    cass_yoy: pd.Series,\n    cpi_yoy: pd.Series,\n    lead_months: int = 6\n) -> dict:\n    \"\"\"\n    領先對齊分析\n\n    Parameters\n    ----------\n    cass_yoy : pd.Series\n        CASS Shipments 年增率\n    cpi_yoy : pd.Series\n        CPI 年增率\n    lead_months : int\n        領先月數\n\n    Returns\n    -------\n    dict\n        包含領先相關性和對齊驗證\n    \"\"\"\n    # 將 CASS YoY 向前平移\n    cass_lead = cass_yoy.shift(lead_months)\n\n    # 對齊並計算相關性\n    aligned = pd.DataFrame({\n        'cass_lead': cass_lead,\n        'cpi': cpi_yoy\n    }).dropna()\n\n    correlation = aligned['cass_lead'].corr(aligned['cpi'])\n\n    return {\n        'correlation': correlation,\n        'lead_months': lead_months,\n        'alignment_quality': 'high' if correlation > 0.5 else 'medium' if correlation > 0.3 else 'low'\n    }\n```\n\n</step>\n\n<step number=\"5\" name=\"產生訊號評估\">\n\n**訊號判斷邏輯**\n\n```python\ndef assess_signal(\n    cass_yoy: float,\n    cycle_status: str,\n    alignment_quality: str,\n    yoy_threshold: float = 0.0\n) -> dict:\n    \"\"\"\n    訊號評估\n\n    Returns\n    -------\n    dict\n        包含 signal, confidence, macro_implication\n    \"\"\"\n    # 訊號判斷\n    if cycle_status == 'new_cycle_low' and cass_yoy < yoy_threshold:\n        signal = 'inflation_easing'\n        confidence = 'high'\n        implication = '通膨壓力正在放緩，未來 CPI 下行風險上升'\n    elif cass_yoy < yoy_threshold:\n        signal = 'inflation_easing'\n        confidence = 'medium'\n        implication = 'CASS 指標轉負，通膨可能開始降溫'\n    elif cycle_status == 'positive' and cass_yoy > 5:\n        signal = 'inflation_rising'\n        confidence = 'medium'\n        implication = 'CASS 指標強勁，通膨上行壓力可能延續'\n    else:\n        signal = 'neutral'\n        confidence = 'low'\n        implication = 'CASS 指標處於中性區間，通膨方向待觀察'\n\n    # 根據對齊品質調整信心\n    if alignment_quality == 'low':\n        confidence = 'low'\n\n    return {\n        'signal': signal,\n        'confidence': confidence,\n        'macro_implication': implication\n    }\n```\n\n</step>\n\n<step number=\"6\" name=\"解讀分析結果\">\n\n**檢查輸出的 JSON 結構**\n\n```python\nimport json\nwith open('analysis_result.json', 'r') as f:\n    result = json.load(f)\n\n# 1. Freight Status\nprint(f\"CASS Shipments YoY: {result['freight_status']['yoy']}%\")\nprint(f\"週期狀態: {result['freight_status']['cycle_status']}\")\nprint(f\"是否為新低: {result['freight_status']['is_new_cycle_low']}\")\n\n# 2. Lead Alignment\nprint(f\"領先相關性: {result['lead_alignment']['correlation']:.2f}\")\nprint(f\"對齊品質: {result['lead_alignment']['alignment_quality']}\")\n\n# 3. Signal Assessment\nprint(f\"訊號: {result['signal_assessment']['signal']}\")\nprint(f\"信心: {result['signal_assessment']['confidence']}\")\nprint(f\"宏觀含義: {result['signal_assessment']['macro_implication']}\")\n\n# 4. All Indicators (所有四個 CASS 指標)\nfor key, data in result.get('all_indicators', {}).items():\n    print(f\"{key}: {data['latest_value']}\")\n```\n\n</step>\n\n<step number=\"7\" name=\"生成視覺化圖表\">\n\n**繪製 CASS vs CPI 領先性對比圖**\n\n核心特徵：\n1. CASS Freight Index 向前移動 6 個月（6M fwd）\n2. 雙軸對比：CPI YoY（左軸）vs CASS（右軸）\n3. NBER 衰退區間標記\n4. Bloomberg 深色風格\n\n```bash\npython visualize_freight_cpi.py \\\n  --cache cache/cass_freight_cdp.json \\\n  --output ../../output/freight_cpi_$(date +%Y-%m-%d).png \\\n  --start 1995-01-01 \\\n  --lead-months 6\n```\n\n**參數說明**：\n- `--cache`: CASS 數據快取路徑\n- `--output`: 輸出圖片路徑（包含日期）\n- `--start`: 圖表起始日期\n- `--lead-months`: CASS 領先月數（預設 6）\n- `--no-cpi`: 不抓取 CPI 數據（可選）\n\n**輸出範例**：`output/freight_cpi_2026-01-23.png`\n\n</step>\n\n<step number=\"8\" name=\"生成報告（可選）\">\n\n**使用模板生成 Markdown 報告**\n\n參考 `templates/output-markdown.md` 的模板結構，將 JSON 結果轉換為可讀報告。\n\n```python\nresult = json.load(open('analysis_result.json'))\n\nreport = f\"\"\"\n# CASS Freight Index 週期轉折分析報告\n\n## 摘要\n\n**訊號**: {result['signal_assessment']['signal']}\n**信心水準**: {result['signal_assessment']['confidence']}\n\n## CASS 狀態\n\n- 選用指標: {result['freight_status']['indicator']}\n- 最新 YoY: {result['freight_status']['yoy']}%\n- 週期狀態: {result['freight_status']['cycle_status']}\n\n## 四個指標概覽\n\n| 指標 | 最新值 | 狀態 |\n|------|-------|------|\n| Shipments YoY | {result['all_indicators']['shipments_yoy']['latest_value']}% | {result['all_indicators']['shipments_yoy']['status']} |\n| Expenditures YoY | {result['all_indicators']['expenditures_yoy']['latest_value']}% | {result['all_indicators']['expenditures_yoy']['status']} |\n\n## 宏觀含義\n\n{result['signal_assessment']['macro_implication']}\n\n## 注意事項\n\n{chr(10).join('- ' + c for c in result.get('caveats', []))}\n\"\"\"\nprint(report)\n```\n\n</step>\n\n</process>\n\n<alternative_approach>\n\n**若腳本無法執行，可手動分析**\n\n1. **手動抓取 CASS 資料**\n   - 訪問 https://en.macromicro.me/charts/46877/cass-freight-index\n   - 記錄最新的 Shipments YoY 和 Expenditures YoY\n\n2. **手動下載 CPI 資料**\n   ```\n   https://fred.stlouisfed.org/graph/fredgraph.csv?id=CPIAUCSL\n   ```\n\n3. **在 Excel/Google Sheets 中計算**\n   - 18M Rolling Min: `=MIN(OFFSET(cell,-17,0):cell)`\n   - 是否新低: `=IF(YoY=Rolling_Min, TRUE, FALSE)`\n\n4. **參考 references/methodology.md 中的判斷標準**\n\n</alternative_approach>\n\n<troubleshooting>\n\n**常見問題**\n\n<issue name=\"cdp_connection_failed\">\n**錯誤**: 無法連接到 Chrome 調試端口\n\n**解決**:\n1. 確保所有 Chrome 視窗都已關閉\n2. 確認啟動時使用了 `--remote-allow-origins=*`\n3. 確認使用了非預設的 `--user-data-dir`\n4. 檢查端口是否可用：`curl -s http://127.0.0.1:9222/json`\n</issue>\n\n<issue name=\"highcharts_not_found\">\n**錯誤**: `Highcharts not found`\n\n**解決**:\n1. 確認頁面已完全載入（圖表已顯示）\n2. 在 Chrome Console 執行 `typeof Highcharts` 確認\n3. 可能需要登入 MacroMicro 帳號\n4. 等待更久讓圖表完全渲染\n</issue>\n\n<issue name=\"module_not_found\">\n**錯誤**: `ModuleNotFoundError: No module named 'websocket'`\n\n**解決**:\n```bash\n# CDP 方法依賴\npip install requests websocket-client pandas numpy\n\n# Selenium 方法依賴（備選）\npip install selenium webdriver-manager pandas numpy\n```\n</issue>\n\n<issue name=\"macromicro_blocked\">\n**錯誤**: 被 Cloudflare 擋住\n\n**解決**:\n1. 優先使用 CDP 方法（最可靠）\n2. 在 Chrome 中手動完成 Cloudflare 驗證\n3. 登入 MacroMicro 帳號後再執行\n4. 使用 `--cache-dir` 啟用快取減少請求\n</issue>\n\n<issue name=\"insufficient_data\">\n**錯誤**: 資料點不足\n\n**解決**:\n- 確保網路正常，CASS 資料成功抓取\n- 檢查快取是否過期（有效期 12 小時）\n- 使用 `--force-refresh` 強制重新抓取\n</issue>\n\n<issue name=\"divergent_indicators\">\n**情況**: Shipments YoY 和 Expenditures YoY 走勢不一致\n\n**解決**:\n- 這是正常情況，可能反映不同的經濟動態\n- 報告中標註不一致性\n- 以 Shipments YoY 為主要參考\n</issue>\n\n</troubleshooting>\n\n<success_criteria>\n此 workflow 完成時應確認：\n\n- [ ] 成功抓取 CASS Freight Index 四個指標\n- [ ] 成功抓取 CPI 資料（FRED）\n- [ ] 計算選定指標的週期狀態（new_cycle_low / negative / positive）\n- [ ] 完成與 CPI 的領先對齊分析\n- [ ] 產生訊號評估（signal + confidence）\n- [ ] 輸出包含可操作的宏觀含義\n- [ ] **生成 CASS vs CPI 領先性對比圖**（output/freight_cpi_YYYY-MM-DD.png）\n- [ ] 明確標註資料限制與假設\n</success_criteria>\n",
        "skills/detect-freight-led-inflation-turn/workflows/quick-check.md": "<required_reading>\n執行快速檢查前，了解基本概念：\n- CASS Shipments YoY < 0 且創新低 → 通膨緩解訊號\n- 領先 CPI 約 4-6 個月\n- 推薦使用 Chrome CDP 方法抓取數據（繞過 Cloudflare）\n</required_reading>\n\n<objective>\n快速檢查最新的 CASS Freight Index 狀態與通膨先行訊號。\n</objective>\n\n<process>\n\n<step number=\"1\" name=\"抓取 CASS 數據\">\n\n**方法一：Chrome CDP（推薦）**\n\n首先安裝依賴：\n```bash\npip install requests websocket-client pandas numpy\n```\n\n啟動 Chrome 調試模式（關閉所有 Chrome 視窗後執行）：\n\n**Windows**：\n```bash\n\"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\" ^\n  --remote-debugging-port=9222 ^\n  --remote-allow-origins=* ^\n  --user-data-dir=\"%USERPROFILE%\\.chrome-debug-profile\" ^\n  \"https://www.macromicro.me/charts/46877/cass-freight-index\"\n```\n\n**macOS**：\n```bash\n/Applications/Google\\ Chrome.app/Contents/MacOS/Google\\ Chrome \\\n  --remote-debugging-port=9222 \\\n  --remote-allow-origins=* \\\n  --user-data-dir=\"$HOME/.chrome-debug-profile\" \\\n  \"https://www.macromicro.me/charts/46877/cass-freight-index\"\n```\n\n等待頁面完全載入（圖表顯示），然後執行：\n```bash\ncd scripts\npython fetch_cass_freight.py --cdp\n```\n\n**方法二：Selenium（備選）**\n\n若 CDP 不可用：\n```bash\npip install selenium webdriver-manager pandas numpy\npython scripts/fetch_cass_freight.py --selenium --no-headless\n```\n\n</step>\n\n<step number=\"2\" name=\"執行快速檢查\">\n\n```bash\npython scripts/freight_inflation_detector.py --quick\n```\n\n**輸出範例**：\n```json\n{\n  \"as_of_date\": \"2025-12-01\",\n  \"indicator\": \"shipments_yoy\",\n  \"indicator_name\": \"CASS Shipments YoY\",\n  \"freight_yoy\": -2.9,\n  \"cycle_status\": \"new_cycle_low\",\n  \"signal\": \"inflation_easing\",\n  \"confidence\": \"high\",\n  \"macro_implication\": \"通膨壓力正在放緩，未來 CPI 下行風險上升\",\n  \"all_indicators\": {\n    \"shipments_yoy\": -2.9,\n    \"expenditures_yoy\": -1.5,\n    \"shipments_index\": 1.15,\n    \"expenditures_index\": 4.25\n  }\n}\n```\n\n</step>\n\n<step number=\"3\" name=\"解讀結果\">\n\n**訊號對照表**：\n\n| signal | cycle_status | confidence | 含義 |\n|--------|--------------|------------|------|\n| `inflation_easing` | `new_cycle_low` | `high` | 強烈的通膨放緩訊號 |\n| `inflation_easing` | `negative` | `medium` | 通膨可能開始降溫 |\n| `neutral` | `positive` | `low` | 通膨方向待觀察 |\n| `inflation_rising` | `positive` | `medium` | 通膨上行壓力可能延續 |\n\n**快速判斷**：\n\n```\n如果 shipments_yoy < 0 且 cycle_status == new_cycle_low：\n  → 通膨緩解訊號成立，預期 CPI 在未來 4-6 個月內放緩\n\n如果 shipments_yoy > 0 且持續上升：\n  → 通膨壓力可能延續\n\n如果 shipments_yoy 在 0 附近震盪：\n  → 中性，需要更多數據確認\n```\n\n**多指標交叉驗證**：\n\n```\n如果 shipments_yoy 和 expenditures_yoy 同時轉負：\n  → 訊號更為可靠\n\n如果兩者分歧：\n  → 需要進一步分析原因\n```\n\n</step>\n\n<step number=\"4\" name=\"後續行動\">\n\n**若訊號為 `inflation_easing`**：\n1. 執行完整分析確認（`workflows/analyze.md`）\n2. 查看歷史案例對照（`references/historical-episodes.md`）\n3. 考慮對利率敏感資產的配置調整\n\n**若訊號為 `neutral` 或 `inflation_rising`**：\n1. 設定監控頻率（每月檢查）\n2. 關注其他通膨指標（CPI、PCE、PPI）\n3. 留意 Fed 政策聲明\n\n</step>\n\n</process>\n\n<troubleshooting>\n\n**常見問題**：\n\n**Q: 無法連接到 Chrome 調試端口**\nA: 確保：\n1. 所有 Chrome 視窗都已關閉\n2. 啟動時使用了 `--remote-allow-origins=*`\n3. 使用了非預設的 `--user-data-dir`\n\n**Q: Highcharts not found**\nA: 確認頁面已完全載入，圖表已顯示。可在 Chrome Console 執行 `typeof Highcharts` 確認。\n\n**Q: 被 Cloudflare 擋住**\nA: 使用 CDP 方法。在 Chrome 中手動完成驗證後再執行腳本。\n\n</troubleshooting>\n\n<quick_reference>\n\n**CASS 四個指標快速對照**\n\n| 指標 | 用途 | 解讀 |\n|------|------|------|\n| `shipments_yoy` | 主要分析指標 | < 0 → 需求減弱訊號 |\n| `expenditures_yoy` | 交叉驗證 | < 0 → 運費成本壓力下降 |\n| `shipments_index` | 絕對水準 | 長期趨勢參考 |\n| `expenditures_index` | 絕對水準 | 運費支出水準 |\n\n</quick_reference>\n\n<success_criteria>\n快速檢查完成時應得到：\n\n- [ ] 最新 CASS Shipments YoY 數值\n- [ ] 週期狀態判斷\n- [ ] 通膨訊號評估\n- [ ] 一句話宏觀含義\n- [ ] 四個指標概覽\n</success_criteria>\n",
        "skills/detect-palladium-lead-silver-turns/SKILL.md": "---\nname: detect-palladium-lead-silver-turns\ndescription: 以鈀金的先行轉向作為確認條件，檢驗白銀短期漲跌是否獲得工業景氣與風險情緒的同步支持，並標記缺乏鈀金參與度的失敗走勢。\n---\n\n<essential_principles>\n\n<principle name=\"cross_metal_confirmation\">\n**跨金屬確認核心**\n\n「鈀金領先白銀」的假說需要可量化驗證：\n- 以 cross-correlation 估計最佳領先滯後（lead-lag）\n- 當銀出現拐點時，檢查鈀金是否在確認窗口內先行或同步出現同向拐點\n- 未被確認的拐點視為「失敗推動」的候選\n\n```\nLead-Lag = argmax(cross_correlation(pd_ret[t-k:t], ag_ret[t:t+k]))\nConfirmed = pd_turn exists within [ag_turn.ts - window, ag_turn.ts + window]\n```\n</principle>\n\n<principle name=\"turning_point_detection\">\n**拐點偵測三法**\n\n| 方法           | 原理                          | 適用場景       |\n|----------------|-------------------------------|----------------|\n| `pivot`        | 左右 N 根K棒內的局部極值      | 結構明確的趨勢 |\n| `peaks`        | scipy find_peaks + prominence | 自動化密度控制 |\n| `slope_change` | 趨勢斜率由正轉負或反之        | 平滑趨勢追蹤   |\n\n建議從 `pivot` 開始，左右各 3-5 根K棒，再依需求調整。\n</principle>\n\n<principle name=\"participation_judgment\">\n**參與度判定**\n\n鈀金是否「參與」銀的走勢，有多種衡量方式：\n\n| 指標               | 定義               | 門檻建議          |\n|--------------------|--------------------|-------------------|\n| `returns_corr`     | 報酬率滾動相關係數 | > 0.5             |\n| `direction_agree`  | 同向漲跌的比例     | > 60%             |\n| `vol_expansion`    | 兩者波動同步擴張   | σ_pd / σ_ag > 0.8 |\n| `breakout_confirm` | 銀突破時鈀金也突破 | 同向突破          |\n\n未達門檻時，銀的動作可能是「流動性噪音」而非趨勢確認。\n</principle>\n\n<principle name=\"failure_move_detection\">\n**失敗走勢判定**\n\n將「無鈀金參與的銀動作」落地為可回測的規則：\n\n| 規則                         | 定義                            | 後果               |\n|------------------------------|---------------------------------|--------------------|\n| `no_confirm_then_revert`     | 無確認 + 銀在 N 根K內回撤過起點 | 標記為 failed_move |\n| `no_confirm_then_break_fail` | 無確認 + 銀突破後回落跌破突破點 | 假突破             |\n\n歷史統計：未確認事件的失敗率 vs 已確認事件的成功率。\n</principle>\n\n</essential_principles>\n\n<objective>\n偵測「鈀金領先、白銀跟隨」的跨金屬拐點：\n\n1. **數據取得**：白銀與鈀金的 OHLCV（yfinance: SI=F, PA=F）\n2. **拐點偵測**：識別兩者的局部高低點（pivot / peaks / slope_change）\n3. **領先滯後估計**：cross-correlation 找最佳 lag\n4. **跨金屬確認**：銀的拐點是否在窗口內被鈀金同向拐點確認\n5. **失敗走勢判定**：未確認的銀拐點是否符合失敗規則\n\n輸出：確認率、失敗率、每個事件的詳細判定、風控建議。\n</objective>\n\n<quick_start>\n\n**最快的方式：偵測白銀近期拐點是否被鈀金確認**\n\n```bash\ncd skills/detect-palladium-lead-silver-turns\npip install pandas numpy yfinance scipy statsmodels  # 首次使用\npython scripts/palladium_lead_silver.py --silver SI=F --palladium PA=F --quick\n```\n\n輸出範例：\n```json\n{\n  \"symbol_pair\": {\"silver\": \"SI=F\", \"palladium\": \"PA=F\"},\n  \"as_of\": \"2026-01-14\",\n  \"timeframe\": \"1h\",\n  \"estimated_pd_leads_by_bars\": 6,\n  \"lead_lag_corr\": 0.42,\n  \"confirmation_rate\": 0.71,\n  \"unconfirmed_failure_rate\": 0.64,\n  \"latest_event\": {\n    \"ts\": \"2026-01-15T14:00:00Z\",\n    \"turn\": \"top\",\n    \"confirmed\": false,\n    \"participation_ok\": false,\n    \"failed_move\": true\n  }\n}\n```\n\n**完整分析**：\n```bash\npython scripts/palladium_lead_silver.py --silver SI=F --palladium PA=F --timeframe 1h --lookback 1000 --output result.json\n```\n\n**生成 Bloomberg 風格視覺化圖表**（推薦）：\n```bash\npip install matplotlib yfinance  # 首次使用\npython scripts/plot_bloomberg_style.py --input result.json --output output/palladium_silver_2026-01-26.png\n```\n\n圖表特色：\n- **Bloomberg 專業配色**：深色背景、橙紅色白銀線、橙黃色鈀金線\n- **背景色帶標記**：綠色背景 = 已確認拐點區域，紅色背景 = 未確認拐點區域（不擋住走勢線）\n- **最新事件標註**：醒目標示最新拐點的確認狀態與價格\n- **Pd/Ag 價格比率圖**：顯示鈀金對白銀的相對價格變化，含 20 期均線\n- **滾動確認率**：動態顯示確認邏輯的有效性趨勢\n- **統計面板**：確認率、失敗率、總拐點數等關鍵指標\n- **行情解讀**：當前狀態評估與可操作建議\n\n**傳統三合一圖表**（技術分析向）：\n```bash\npython scripts/plot_palladium_silver.py --silver SI=F --palladium PA=F --output output/\n```\n\n包含：\n- 銀/鈀價格疊加與拐點標記\n- 確認/未確認事件分布\n- 滾動相關係數時間序列\n- 失敗走勢統計\n\n</quick_start>\n\n<intake>\n需要進行什麼操作？\n\n1. **快速偵測** - 檢查最近白銀拐點是否被鈀金確認\n2. **歷史回測** - 回溯分析跨金屬確認的有效性\n3. **持續監控** - 設定警報當出現新拐點時通知\n4. **參數調校** - 找出最佳的確認窗口與參與度門檻\n5. **方法論學習** - 了解跨金屬領先滯後的理論基礎\n\n**請選擇或直接提供分析參數開始。**\n</intake>\n\n<routing>\n| Response                           | Action                                                 |\n|------------------------------------|--------------------------------------------------------|\n| 1, \"快速\", \"quick\", \"check\"        | 執行 `python scripts/palladium_lead_silver.py --quick` |\n| 2, \"回測\", \"backtest\", \"history\"   | 閱讀 `workflows/backtest.md` 並執行                    |\n| 3, \"監控\", \"monitor\", \"alert\"      | 閱讀 `workflows/monitor.md` 並執行                     |\n| 4, \"調校\", \"optimize\", \"tune\"      | 閱讀 `workflows/detect.md` 的參數調校部分              |\n| 5, \"學習\", \"方法論\", \"why\"         | 閱讀 `references/methodology.md`                       |\n| 提供參數（如 timeframe, lookback） | 閱讀 `workflows/detect.md` 並使用參數執行              |\n\n**路由後，閱讀對應文件並執行。**\n</routing>\n\n<directory_structure>\n```\ndetect-palladium-lead-silver-turns/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元數據\n├── workflows/\n│   ├── detect.md                      # 單次偵測工作流\n│   ├── backtest.md                    # 歷史回測工作流\n│   └── monitor.md                     # 持續監控工作流\n├── references/\n│   ├── methodology.md                 # 跨金屬領先滯後方法論\n│   ├── input-schema.md                # 完整輸入參數定義\n│   └── data-sources.md                # 資料來源說明\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n├── scripts/\n│   ├── palladium_lead_silver.py       # 主偵測腳本\n│   ├── plot_bloomberg_style.py        # Bloomberg 風格視覺化（推薦）\n│   └── plot_palladium_silver.py       # 傳統三合一圖表\n└── examples/\n    └── silver-palladium-2024.json     # 範例輸出\n```\n</directory_structure>\n\n<reference_index>\n\n**方法論**: references/methodology.md\n- 跨金屬領先滯後原理\n- 拐點偵測三法詳解\n- 參與度與確認邏輯\n- 失敗走勢的市場含義\n\n**資料來源**: references/data-sources.md\n- Yahoo Finance 期貨代碼\n- 宏觀濾鏡數據來源\n- 數據頻率與對齊\n\n**輸入參數**: references/input-schema.md\n- 完整參數定義\n- 預設值與建議範圍\n\n</reference_index>\n\n<workflows_index>\n| Workflow    | Purpose  | 使用時機           |\n|-------------|----------|--------------------|\n| detect.md   | 單次偵測 | 檢查特定時間範圍   |\n| backtest.md | 歷史回測 | 驗證確認邏輯有效性 |\n| monitor.md  | 持續監控 | 日常追蹤或警報     |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構定義 |\n| output-markdown.md | Markdown 報告模板 |\n</templates_index>\n\n<scripts_index>\n| Script                   | Command                                          | Purpose          |\n|--------------------------|--------------------------------------------------|------------------|\n| palladium_lead_silver.py | `--silver SI=F --palladium PA=F --quick`         | 快速檢查當前狀態 |\n| palladium_lead_silver.py | `--silver SI=F --palladium PA=F --lookback 1000` | 完整歷史分析     |\n| plot_bloomberg_style.py  | `--input result.json --output output/chart.png`  | Bloomberg 風格圖表（推薦） |\n| plot_palladium_silver.py | `--silver SI=F --palladium PA=F --output dir/`   | 傳統三合一圖表   |\n</scripts_index>\n\n<input_schema_summary>\n\n**核心參數**\n\n| 參數             | 類型   | 預設值     | 說明         |\n|------------------|--------|------------|--------------|\n| silver_symbol    | string | (required) | 白銀標的代碼 |\n| palladium_symbol | string | (required) | 鈀金標的代碼 |\n| timeframe        | string | 1h         | 分析時間尺度 |\n| lookback_bars    | int    | 1000       | 回溯K棒數    |\n\n**拐點偵測參數**\n\n| 參數                | 類型   | 預設值 | 說明                |\n|---------------------|--------|--------|---------------------|\n| turn_method         | string | pivot  | 拐點偵測方法        |\n| pivot_left          | int    | 3      | pivot 左側確認K數   |\n| pivot_right         | int    | 3      | pivot 右側確認K數   |\n| confirm_window_bars | int    | 6      | 跨金屬確認窗口      |\n| lead_lag_max_bars   | int    | 24     | 領先滯後最大滯後K數 |\n\n**參與度參數**\n\n| 參數                    | 類型   | 預設值                 | 說明           |\n|-------------------------|--------|------------------------|----------------|\n| participation_metric    | string | direction_agree        | 參與度衡量方式 |\n| participation_threshold | float  | 0.6                    | 參與度門檻     |\n| failure_rule            | string | no_confirm_then_revert | 失敗走勢規則   |\n\n完整參數定義見 `references/input-schema.md`。\n\n</input_schema_summary>\n\n<output_schema_summary>\n```json\n{\n  \"skill\": \"detect-palladium-lead-silver-turns\",\n  \"symbol_pair\": {\"silver\": \"SI=F\", \"palladium\": \"PA=F\"},\n  \"as_of\": \"2026-01-14\",\n  \"timeframe\": \"1h\",\n  \"lookback_bars\": 1200,\n  \"summary\": {\n    \"estimated_pd_leads_by_bars\": 6,\n    \"lead_lag_corr\": 0.42,\n    \"confirmation_rate\": 0.71,\n    \"unconfirmed_failure_rate\": 0.64,\n    \"total_ag_turns\": 24,\n    \"confirmed_turns\": 17,\n    \"failed_moves\": 5\n  },\n  \"events\": [\n    {\n      \"ts\": \"2026-01-08T10:00:00Z\",\n      \"turn\": \"bottom\",\n      \"confirmed\": true,\n      \"confirmation_lag_bars\": -3,\n      \"participation_ok\": true,\n      \"failed_move\": false\n    }\n  ],\n  \"interpretation\": {\n    \"regime_assessment\": \"...\",\n    \"tactics\": [\"...\", \"...\"]\n  }\n}\n```\n\n完整輸出結構見 `templates/output-json.md`。\n</output_schema_summary>\n\n<success_criteria>\n執行成功時應產出：\n\n- [ ] 鈀金對白銀的最佳領先滯後估計（bars）\n- [ ] 領先滯後的相關係數\n- [ ] 白銀拐點被鈀金確認的確認率\n- [ ] 未確認事件的失敗走勢比例\n- [ ] 每個白銀拐點的詳細判定（confirmed, participation, failed）\n- [ ] 行情解讀與戰術建議\n- [ ] 時間序列資料（可選，用於視覺化）\n- [ ] 視覺化圖表 PNG（可選，使用 plot_palladium_silver.py）\n</success_criteria>\n",
        "skills/detect-palladium-lead-silver-turns/methodology.md": "### 為什麼要 **跨金屬確認** ？\n\n白銀同時具有：\n- **貴金屬屬性**：受美元、實質利率、避險情緒影響\n- **工業金屬屬性**：受製造業循環、景氣預期、風險偏好影響\n\n鈀金相對更偏向：\n- **純工業／景氣敏感金屬**（需求集中、波動更高、對風險切換更敏感）\n- **市場結構更薄**（同樣的資金流動對價格衝擊更大），因此常呈現**反應更快**的特性\n\n因此在短週期（例如一小時到數日）中，鈀金常像是**工業／風險因子**的**高波動溫度計**：  \n當市場正在交易景氣預期、風險情緒或宏觀流動性拐點時，鈀金往往先動或更明顯地轉向，而白銀後續才跟上。\n\n### 解讀範例\n\n1. **先看鈀金（藍線）是否出現轉折訊號**\n   - 若鈀金先轉弱（形成局部高點、或動能斜率下滑），代表**工業／風險因子**在降溫\n2. **再看白銀（價格走勢）是否出現對應的結構**\n   - 若白銀隨後也出現較明確的高點（例如高點抬不上去、或跌破短期支撐），則判為**跨金屬確認成立**\n3. **若白銀單獨上衝但鈀金未跟進**\n   - 將其歸類為**缺乏參與度**的行情\n   - 預期更容易出現：回到區間、快速回撤、假突破\n\n### 這種結構為何有可能特別一致？\n\n因為短週期的資金往往在交易同一件事：  \n**工業景氣預期（採購經理人指數／庫存循環／風險偏好）＋宏觀流動性（美元／利率）**。  \n鈀金更像高波動的第一反應，白銀因為還混有**貴金屬層**而稍滯後，所以你會在近期更常看到**鈀先轉、銀後跟**的視覺一致性。\n\n### 什麼時候會失效？\n\n這套方法很強，但不是物理定律。兩種常見失效情境：\n\n1. **白銀被貴金屬層主導**\n   - 例如避險情緒、金銀比修正、實質利率急變  \n   - 白銀可能走自己的節奏，鈀金未必同步確認\n\n2. **鈀金被自身供需／事件主導**\n   - 汽車鏈、替代效應、供給擾動等  \n   - 鈀金可能獨走，反而不該拿來確認白銀走勢",
        "skills/detect-palladium-lead-silver-turns/references/data-sources.md": "# 資料來源說明\n\n## 主要資料來源\n\n### Yahoo Finance (yfinance)\n\n**免費、無需 API key**\n\n```bash\npip install yfinance\n```\n\n#### 期貨代碼\n\n| 商品   | 代碼       | 交易所         | 說明                 |\n|--------|------------|----------------|----------------------|\n| 白銀   | SI=F       | COMEX          | Silver Futures       |\n| 鈀金   | PA=F       | NYMEX          | Palladium Futures    |\n| 黃金   | GC=F       | COMEX          | Gold Futures         |\n| 鉑金   | PL=F       | NYMEX          | Platinum Futures     |\n\n#### 現貨/外匯代碼\n\n| 商品   | 代碼       | 說明                 |\n|--------|------------|----------------------|\n| 白銀   | XAGUSD=X   | Silver Spot          |\n| 黃金   | XAUUSD=X   | Gold Spot            |\n\n#### 使用範例\n\n```python\nimport yfinance as yf\n\n# 取得白銀期貨數據\nsilver = yf.Ticker(\"SI=F\")\nsilver_data = silver.history(period=\"2y\", interval=\"1h\")\n\n# 取得鈀金期貨數據\npalladium = yf.Ticker(\"PA=F\")\npalladium_data = palladium.history(period=\"2y\", interval=\"1h\")\n```\n\n#### 數據可用性\n\n| 時間尺度 | 可用歷史 | 說明                 |\n|----------|----------|----------------------|\n| 1m       | 7 天     | 分鐘級數據限制       |\n| 5m       | 60 天    |                      |\n| 1h       | 730 天   | 約 2 年              |\n| 1d       | 無限制   | 完整歷史             |\n\n#### 注意事項\n\n- yfinance 是非官方 API，可能有延遲或中斷\n- 期貨數據為連續合約（front month roll）\n- 小時數據可能有空缺（非交易時段）\n\n---\n\n## 替代資料來源\n\n### Stooq\n\n**免費 CSV 下載**\n\n網址：https://stooq.com\n\n```python\nimport pandas as pd\n\n# 白銀\nsilver_url = \"https://stooq.com/q/d/l/?s=xagusd&i=h\"\nsilver_data = pd.read_csv(silver_url)\n```\n\n### Polygon.io\n\n**付費 API**\n\n```python\nfrom polygon import RESTClient\n\nclient = RESTClient(\"YOUR_API_KEY\")\naggs = client.get_aggs(\"C:XAGUSD\", 1, \"hour\", \"2024-01-01\", \"2024-12-31\")\n```\n\n### Twelve Data\n\n**免費額度 + 付費**\n\n```python\nfrom twelvedata import TDClient\n\ntd = TDClient(apikey=\"YOUR_API_KEY\")\nts = td.time_series(symbol=\"XAG/USD\", interval=\"1h\", outputsize=1000)\n```\n\n---\n\n## 宏觀濾鏡資料來源\n\n### FRED (Federal Reserve Economic Data)\n\n**免費，需 API key**\n\n```bash\npip install pandas-datareader\n```\n\n#### 常用序列\n\n| 序列 ID   | 說明                     | 更新頻率 |\n|-----------|--------------------------|----------|\n| DTWEXBGS  | 美元指數（廣義）         | 每日     |\n| DFII10    | 10 年期實質利率          | 每日     |\n| VIXCLS    | VIX 指數                 | 每日     |\n| BAMLH0A0HYM2 | 高收益債利差          | 每日     |\n\n```python\nimport pandas_datareader.data as web\n\n# 取得美元指數\ndxy = web.DataReader(\"DTWEXBGS\", \"fred\", start=\"2024-01-01\", end=\"2026-01-01\")\n\n# 取得實質利率\nreal_yield = web.DataReader(\"DFII10\", \"fred\", start=\"2024-01-01\", end=\"2026-01-01\")\n```\n\n---\n\n## 數據對齊\n\n### 時間戳對齊\n\n兩個標的的時間戳可能不完全一致，需要對齊：\n\n```python\ndef align_data(ag_df: pd.DataFrame, pd_df: pd.DataFrame) -> pd.DataFrame:\n    \"\"\"\n    對齊白銀和鈀金的時間序列。\n\n    使用交集時間戳，forward fill 處理缺失值。\n    \"\"\"\n    # 重新索引到共同時間\n    common_index = ag_df.index.intersection(pd_df.index)\n\n    ag_aligned = ag_df.reindex(common_index).ffill()\n    pd_aligned = pd_df.reindex(common_index).ffill()\n\n    # 合併\n    df = pd.DataFrame({\n        'ag_close': ag_aligned['Close'],\n        'pd_close': pd_aligned['Close'],\n        'ag_high': ag_aligned['High'],\n        'ag_low': ag_aligned['Low'],\n        'pd_high': pd_aligned['High'],\n        'pd_low': pd_aligned['Low'],\n    })\n\n    # 計算報酬\n    df['ag_ret'] = np.log(df['ag_close']).diff()\n    df['pd_ret'] = np.log(df['pd_close']).diff()\n\n    return df.dropna()\n```\n\n### 時區處理\n\n- Yahoo Finance 返回 UTC 或交易所當地時間\n- 建議統一轉換為 UTC\n\n```python\ndf.index = df.index.tz_convert('UTC')\n```\n\n---\n\n## 數據品質檢查\n\n### 缺失值\n\n```python\ndef check_data_quality(df: pd.DataFrame) -> dict:\n    \"\"\"檢查數據品質。\"\"\"\n    return {\n        'total_rows': len(df),\n        'missing_ag': df['ag_close'].isna().sum(),\n        'missing_pd': df['pd_close'].isna().sum(),\n        'date_range': (df.index.min(), df.index.max()),\n        'trading_days': df.index.nunique(),\n    }\n```\n\n### 異常值\n\n```python\ndef detect_outliers(df: pd.DataFrame, threshold: float = 5.0) -> pd.DataFrame:\n    \"\"\"偵測報酬率異常值（超過 N 個標準差）。\"\"\"\n    ag_zscore = (df['ag_ret'] - df['ag_ret'].mean()) / df['ag_ret'].std()\n    pd_zscore = (df['pd_ret'] - df['pd_ret'].mean()) / df['pd_ret'].std()\n\n    outliers = df[(ag_zscore.abs() > threshold) | (pd_zscore.abs() > threshold)]\n    return outliers\n```\n\n---\n\n## 建議配置\n\n### 快速原型\n\n```python\n# 使用 yfinance，免費快速\nconfig = {\n    'silver_symbol': 'SI=F',\n    'palladium_symbol': 'PA=F',\n    'source': 'yfinance',\n}\n```\n\n### 生產環境\n\n```python\n# 使用付費 API 確保穩定性\nconfig = {\n    'silver_symbol': 'SI=F',\n    'palladium_symbol': 'PA=F',\n    'source': 'polygon',\n    'api_key': 'YOUR_KEY',\n    'backup_source': 'yfinance',  # 備用\n}\n```\n\n---\n\n## 常見問題\n\n### Q: yfinance 數據中斷怎麼辦？\n\nA: 使用備用來源（Stooq）或緩存本地數據。\n\n### Q: 期貨換月會影響分析嗎？\n\nA: 連續合約已處理換月，但價格可能有跳空。建議使用報酬率而非絕對價格。\n\n### Q: 鈀金數據可用性差怎麼辦？\n\nA: 鈀金流動性較低，小時數據可能有空缺。可嘗試 4h 或 1d 數據。\n",
        "skills/detect-palladium-lead-silver-turns/references/input-schema.md": "# 輸入參數完整定義\n\n## 核心參數\n\n| 參數              | 類型   | 必要 | 預設值 | 說明                         |\n|-------------------|--------|------|--------|------------------------------|\n| silver_symbol     | string | ✅   | SI=F   | 白銀標的代碼                 |\n| palladium_symbol  | string | ✅   | PA=F   | 鈀金標的代碼                 |\n| timeframe         | string | ✅   | 1h     | 分析時間尺度                 |\n| lookback_bars     | int    | ✅   | 1000   | 回溯 K 棒數                  |\n\n### silver_symbol / palladium_symbol\n\n支援的標的代碼：\n\n| 來源          | 白銀              | 鈀金              |\n|---------------|-------------------|-------------------|\n| Yahoo Finance | SI=F, XAGUSD=X    | PA=F              |\n| 自定義        | 任何 OHLCV 資料源 | 任何 OHLCV 資料源 |\n\n### timeframe\n\n| 值   | 說明         | 適用場景             |\n|------|--------------|----------------------|\n| 1h   | 1 小時       | 短期交易確認         |\n| 4h   | 4 小時       | 日內波段             |\n| 1d   | 日線         | 中期趨勢             |\n\n### lookback_bars\n\n| 值        | 說明                 | 統計有效性           |\n|-----------|----------------------|----------------------|\n| 500       | 最小建議             | 基本分析             |\n| 1000      | 標準                 | 良好                 |\n| 2000-3000 | 深度回測             | 優秀                 |\n\n---\n\n## 拐點偵測參數\n\n| 參數        | 類型   | 必要 | 預設值 | 說明                   |\n|-------------|--------|------|--------|------------------------|\n| turn_method | string | ✅   | pivot  | 拐點偵測方法           |\n| pivot_left  | int    | ❌   | 3      | pivot 左側確認 K 數    |\n| pivot_right | int    | ❌   | 3      | pivot 右側確認 K 數    |\n\n### turn_method\n\n| 值           | 說明                           | 參數                    |\n|--------------|--------------------------------|-------------------------|\n| pivot        | 左右 N 根內局部極值            | pivot_left, pivot_right |\n| peaks        | scipy find_peaks + prominence  | prominence, distance    |\n| slope_change | 趨勢斜率符號變化               | slope_window            |\n\n### pivot 法參數\n\n| 參數        | 範圍  | 建議值           | 效果                   |\n|-------------|-------|------------------|------------------------|\n| pivot_left  | 2-10  | 3（1h）, 2（1d） | 越大越少拐點           |\n| pivot_right | 2-10  | 3（1h）, 2（1d） | 越大確認越晚           |\n\n### peaks 法參數\n\n| 參數       | 類型  | 預設值 | 說明                   |\n|------------|-------|--------|------------------------|\n| prominence | float | 0.5    | 突出度門檻（標準差倍數）|\n| distance   | int   | 5      | 最小間隔 K 數          |\n\n### slope_change 法參數\n\n| 參數          | 類型  | 預設值 | 說明                   |\n|---------------|-------|--------|------------------------|\n| slope_window  | int   | 10     | 斜率計算窗口           |\n| slope_threshold| float| 0.0    | 斜率變化門檻           |\n\n---\n\n## 確認參數\n\n| 參數                | 類型   | 必要 | 預設值 | 說明                      |\n|---------------------|--------|------|--------|---------------------------|\n| confirm_window_bars | int    | ✅   | 6      | 跨金屬確認窗口 K 數       |\n| lead_lag_max_bars   | int    | ❌   | 24     | 領先滯後估計最大滯後 K 數 |\n\n### confirm_window_bars\n\n建議配置：\n\n| timeframe | 建議值  | 說明                   |\n|-----------|---------|------------------------|\n| 1h        | 6-12    | 約半天到一天           |\n| 4h        | 3-6     | 約半天到一天           |\n| 1d        | 2-5     | 約一週                 |\n\n### lead_lag_max_bars\n\n建議配置：\n\n| timeframe | 建議值  | 說明                   |\n|-----------|---------|------------------------|\n| 1h        | 24-72   | 1-3 天                 |\n| 4h        | 12-24   | 2-4 天                 |\n| 1d        | 5-15    | 1-3 週                 |\n\n---\n\n## 參與度參數\n\n| 參數                   | 類型   | 必要 | 預設值          | 說明                 |\n|------------------------|--------|------|-----------------|----------------------|\n| participation_metric   | string | ✅   | direction_agree | 參與度衡量方式       |\n| participation_threshold| float  | ❌   | 0.6             | 參與度門檻           |\n\n### participation_metric\n\n| 值               | 說明                     | 適用場景             |\n|------------------|--------------------------|----------------------|\n| returns_corr     | 報酬率滾動相關係數       | 精確量化             |\n| direction_agree  | 同向漲跌的比例           | 簡單直觀             |\n| vol_expansion    | 兩者波動同步擴張         | 波動確認             |\n| breakout_confirm | 銀突破時鈀金也突破       | 突破交易             |\n\n### participation_threshold\n\n| 指標             | 建議範圍 | 說明                   |\n|------------------|----------|------------------------|\n| returns_corr     | 0.3-0.6  | 相關係數門檻           |\n| direction_agree  | 0.5-0.7  | 同向比例門檻           |\n| vol_expansion    | 0.7-1.0  | 波動比值門檻           |\n| breakout_confirm | N/A      | 二元判定               |\n\n---\n\n## 失敗走勢參數\n\n| 參數         | 類型   | 必要 | 預設值                  | 說明                 |\n|--------------|--------|------|-------------------------|----------------------|\n| failure_rule | string | ❌   | no_confirm_then_revert  | 失敗走勢判定規則     |\n| revert_bars  | int    | ❌   | 10                      | 回撤檢查 K 數        |\n\n### failure_rule\n\n| 值                        | 說明                               |\n|---------------------------|------------------------------------|\n| no_confirm_then_revert    | 無確認 + 回撤過起點                |\n| no_confirm_then_break_fail| 無確認 + 突破後回落跌破突破點      |\n\n---\n\n## 宏觀濾鏡參數（可選）\n\n| 參數          | 類型   | 預設值 | 說明                   |\n|---------------|--------|--------|------------------------|\n| macro_filters | object | null   | 宏觀濾鏡配置           |\n\n### macro_filters 結構\n\n```json\n{\n  \"use_dxy\": true,\n  \"dxy_threshold\": 0.5,\n  \"use_real_yield\": false,\n  \"real_yield_series\": \"DFII10\",\n  \"use_vix\": true,\n  \"vix_threshold\": 20\n}\n```\n\n| 濾鏡          | 說明                     | 作用                     |\n|---------------|--------------------------|--------------------------|\n| use_dxy       | 使用美元指數             | 過濾美元驅動的波動       |\n| use_real_yield| 使用實質利率             | 過濾利率變動期           |\n| use_vix       | 使用 VIX                 | 過濾風險事件期           |\n\n---\n\n## 輸出參數\n\n| 參數        | 類型   | 預設值 | 說明                   |\n|-------------|--------|--------|------------------------|\n| output      | string | null   | 輸出文件路徑           |\n| format      | string | json   | 輸出格式（json/markdown）|\n| include_timeseries | bool | false | 是否包含時間序列資料 |\n\n---\n\n## 命令行參數對照\n\n```bash\npython scripts/palladium_lead_silver.py \\\n  --silver SI=F \\                      # silver_symbol\n  --palladium PA=F \\                   # palladium_symbol\n  --timeframe 1h \\                     # timeframe\n  --lookback 1000 \\                    # lookback_bars\n  --turn-method pivot \\                # turn_method\n  --pivot-left 3 \\                     # pivot_left\n  --pivot-right 3 \\                    # pivot_right\n  --confirm-window 6 \\                 # confirm_window_bars\n  --lead-lag-max 24 \\                  # lead_lag_max_bars\n  --participation direction_agree \\    # participation_metric\n  --participation-threshold 0.6 \\      # participation_threshold\n  --failure-rule no_confirm_then_revert \\ # failure_rule\n  --output result.json                 # output\n```\n\n---\n\n## 完整配置範例\n\n```json\n{\n  \"silver_symbol\": \"SI=F\",\n  \"palladium_symbol\": \"PA=F\",\n  \"timeframe\": \"1h\",\n  \"lookback_bars\": 1000,\n  \"turn_method\": \"pivot\",\n  \"pivot_left\": 3,\n  \"pivot_right\": 3,\n  \"confirm_window_bars\": 6,\n  \"lead_lag_max_bars\": 24,\n  \"participation_metric\": \"direction_agree\",\n  \"participation_threshold\": 0.6,\n  \"failure_rule\": \"no_confirm_then_revert\",\n  \"revert_bars\": 10,\n  \"macro_filters\": null,\n  \"output\": \"result.json\",\n  \"format\": \"json\",\n  \"include_timeseries\": false\n}\n```\n",
        "skills/detect-palladium-lead-silver-turns/references/methods.md": "# 跨金屬領先滯後方法論\n\n## 核心假說\n\n**「鈀金領先、白銀跟隨」** 的短週期領先關係假說：\n\n1. **市場敏感度差異**：鈀金市場較小、流動性較低，對宏觀變化反應更敏感\n2. **工業屬性關聯**：兩者皆有工業需求成分，但週期敏感度不同\n3. **資金流動順序**：大資金進出貴金屬板塊時，先影響小市場\n\n將這個「觀察」轉化為**可回測、可監控、可自動告警**的規則。\n\n---\n\n## 領先滯後估計 (Lead-Lag Estimation)\n\n### 交叉相關分析\n\n使用 cross-correlation 找出兩個時間序列的最佳滯後：\n\n```python\nimport numpy as np\nfrom scipy import signal\n\ndef estimate_lead_lag(pd_ret: np.ndarray, ag_ret: np.ndarray, max_lag: int = 24):\n    \"\"\"\n    估計鈀金對白銀的領先滯後。\n\n    Args:\n        pd_ret: 鈀金報酬序列\n        ag_ret: 白銀報酬序列\n        max_lag: 最大滯後 K 數\n\n    Returns:\n        best_lag: 最佳滯後（正值表示鈀金領先）\n        best_corr: 對應的相關係數\n    \"\"\"\n    # 計算交叉相關\n    correlation = signal.correlate(ag_ret, pd_ret, mode='full')\n    lags = signal.correlation_lags(len(ag_ret), len(pd_ret), mode='full')\n\n    # 限制在 [-max_lag, max_lag] 範圍\n    mask = (lags >= -max_lag) & (lags <= max_lag)\n    correlation = correlation[mask]\n    lags = lags[mask]\n\n    # 找最大相關\n    best_idx = np.argmax(np.abs(correlation))\n    best_lag = lags[best_idx]\n    best_corr = correlation[best_idx] / len(ag_ret)  # 正規化\n\n    return best_lag, best_corr\n```\n\n### 解讀\n\n| 結果          | 含義                       |\n|---------------|----------------------------|\n| `lag > 0`     | 鈀金領先白銀 `lag` 根 K 棒 |\n| `lag < 0`     | 白銀領先鈀金               |\n| `lag ≈ 0`     | 同步移動                   |\n| `corr > 0.3`  | 有意義的領先關係           |\n| `corr < 0.3`  | 領先關係弱或不穩定         |\n\n---\n\n## 拐點偵測三法\n\n### 1. Pivot 法\n\n**原理**：左右 N 根 K 棒內的局部極值\n\n```python\ndef detect_pivots(prices: pd.Series, left: int = 3, right: int = 3):\n    \"\"\"\n    使用 pivot 法偵測局部高低點。\n\n    pivot_high[i] = max(prices[i-left:i+right+1]) == prices[i]\n    pivot_low[i] = min(prices[i-left:i+right+1]) == prices[i]\n    \"\"\"\n    turns = []\n    for i in range(left, len(prices) - right):\n        window = prices.iloc[i-left:i+right+1]\n        if prices.iloc[i] == window.max():\n            turns.append({'idx': i, 'type': 'top', 'price': prices.iloc[i]})\n        elif prices.iloc[i] == window.min():\n            turns.append({'idx': i, 'type': 'bottom', 'price': prices.iloc[i]})\n    return turns\n```\n\n**適用場景**：結構明確的趨勢市場\n\n**參數建議**：\n- 1h 圖：`left=right=3~5`\n- 4h 圖：`left=right=2~4`\n- 1d 圖：`left=right=2~3`\n\n### 2. Peaks 法\n\n**原理**：使用 scipy 的 `find_peaks` + prominence 控制\n\n```python\nfrom scipy.signal import find_peaks\n\ndef detect_peaks(prices: pd.Series, prominence: float = 0.5, distance: int = 5):\n    \"\"\"\n    使用 scipy find_peaks 偵測極值。\n\n    prominence: 突出度門檻（%）\n    distance: 最小間隔 K 數\n    \"\"\"\n    # 標準化價格變化\n    pct_change = prices.pct_change().fillna(0)\n\n    # 找頂部\n    tops, _ = find_peaks(prices.values, prominence=prominence * prices.std(), distance=distance)\n\n    # 找底部（反轉找）\n    bottoms, _ = find_peaks(-prices.values, prominence=prominence * prices.std(), distance=distance)\n\n    turns = []\n    for t in tops:\n        turns.append({'idx': t, 'type': 'top', 'price': prices.iloc[t]})\n    for b in bottoms:\n        turns.append({'idx': b, 'type': 'bottom', 'price': prices.iloc[b]})\n\n    return sorted(turns, key=lambda x: x['idx'])\n```\n\n**適用場景**：自動化密度控制，適合不同市場條件\n\n**參數建議**：\n- `prominence=0.3~0.7`：較小值產生更多拐點\n- `distance=5~15`：最小間隔 K 數\n\n### 3. Slope Change 法\n\n**原理**：趨勢斜率由正轉負或反之\n\n```python\ndef detect_slope_changes(prices: pd.Series, window: int = 10, threshold: float = 0.0):\n    \"\"\"\n    偵測趨勢斜率的方向變化。\n\n    使用滾動線性迴歸的斜率。\n    \"\"\"\n    from scipy import stats\n\n    def rolling_slope(s):\n        x = np.arange(len(s))\n        slope, _, _, _, _ = stats.linregress(x, s)\n        return slope\n\n    slopes = prices.rolling(window).apply(rolling_slope, raw=False)\n\n    # 找斜率符號變化點\n    sign_change = (slopes.shift(1) * slopes) < 0\n\n    turns = []\n    for i in np.where(sign_change)[0]:\n        if slopes.iloc[i] < 0 and slopes.iloc[i-1] > 0:\n            turns.append({'idx': i, 'type': 'top', 'price': prices.iloc[i]})\n        elif slopes.iloc[i] > 0 and slopes.iloc[i-1] < 0:\n            turns.append({'idx': i, 'type': 'bottom', 'price': prices.iloc[i]})\n\n    return turns\n```\n\n**適用場景**：平滑趨勢追蹤，減少噪音\n\n**參數建議**：\n- `window=10~20`：較長窗口更平滑\n- `threshold=0`：可設小正值過濾微弱變化\n\n---\n\n## 跨金屬確認邏輯\n\n### 確認定義\n\n銀的拐點 `ag_turn` 被「確認」當且僅當：\n\n1. 在確認窗口 `[ag_turn.ts - window, ag_turn.ts + window]` 內\n2. 存在鈀金同向拐點 `pd_turn`（同為 top 或同為 bottom）\n\n```python\ndef check_confirmation(ag_turn, pd_turns, window_bars: int = 6):\n    \"\"\"\n    檢查銀拐點是否被鈀金確認。\n\n    Args:\n        ag_turn: 銀的拐點 {'idx': int, 'type': str}\n        pd_turns: 鈀金拐點列表\n        window_bars: 確認窗口 K 數\n\n    Returns:\n        confirmed: bool\n        confirmation_lag: int or None（正值表示鈀金先動）\n    \"\"\"\n    ag_idx = ag_turn['idx']\n    ag_type = ag_turn['type']\n\n    for pd_turn in pd_turns:\n        if pd_turn['type'] != ag_type:\n            continue\n\n        lag = ag_idx - pd_turn['idx']  # 正值 = 鈀金先動\n        if abs(lag) <= window_bars:\n            return True, lag\n\n    return False, None\n```\n\n### 確認滯後的含義\n\n| confirmation_lag | 含義                   |\n|------------------|------------------------|\n| 正值（如 +3）    | 鈀金先於銀 3 根 K 出現拐點 |\n| 負值（如 -2）    | 銀先於鈀金 2 根 K 出現拐點 |\n| 0                | 同時出現               |\n\n---\n\n## 參與度判定\n\n除了拐點確認，還需判斷鈀金是否「積極參與」銀的走勢。\n\n### 1. 報酬相關 (returns_corr)\n\n```python\ndef check_participation_corr(df, ag_turn_idx, lookback: int = 10, threshold: float = 0.5):\n    \"\"\"\n    檢查拐點前後的報酬相關性。\n    \"\"\"\n    start_idx = max(0, ag_turn_idx - lookback)\n    end_idx = min(len(df), ag_turn_idx + lookback)\n\n    ag_ret = df['ag_ret'].iloc[start_idx:end_idx]\n    pd_ret = df['pd_ret'].iloc[start_idx:end_idx]\n\n    corr = ag_ret.corr(pd_ret)\n    return corr >= threshold, corr\n```\n\n### 2. 方向一致 (direction_agree)\n\n```python\ndef check_participation_direction(df, ag_turn_idx, lookback: int = 10, threshold: float = 0.6):\n    \"\"\"\n    檢查同向漲跌的比例。\n    \"\"\"\n    start_idx = max(0, ag_turn_idx - lookback)\n    end_idx = min(len(df), ag_turn_idx + lookback)\n\n    ag_ret = df['ag_ret'].iloc[start_idx:end_idx]\n    pd_ret = df['pd_ret'].iloc[start_idx:end_idx]\n\n    same_direction = ((ag_ret > 0) & (pd_ret > 0)) | ((ag_ret < 0) & (pd_ret < 0))\n    agree_rate = same_direction.sum() / len(ag_ret)\n\n    return agree_rate >= threshold, agree_rate\n```\n\n### 3. 波動擴張 (vol_expansion)\n\n```python\ndef check_participation_vol(df, ag_turn_idx, lookback: int = 10, threshold: float = 0.8):\n    \"\"\"\n    檢查兩者波動是否同步擴張。\n    \"\"\"\n    start_idx = max(0, ag_turn_idx - lookback)\n    end_idx = min(len(df), ag_turn_idx + lookback)\n\n    ag_vol = df['ag_ret'].iloc[start_idx:end_idx].std()\n    pd_vol = df['pd_ret'].iloc[start_idx:end_idx].std()\n\n    ratio = pd_vol / ag_vol if ag_vol > 0 else 0\n    return ratio >= threshold, ratio\n```\n\n---\n\n## 失敗走勢判定\n\n### 規則 1：無確認則回撤 (no_confirm_then_revert)\n\n```python\ndef check_failed_move_revert(df, ag_turn, confirmed: bool, revert_bars: int = 10):\n    \"\"\"\n    未確認 + 銀在 N 根 K 內回撤過拐點價格。\n    \"\"\"\n    if confirmed:\n        return False\n\n    turn_idx = ag_turn['idx']\n    turn_price = ag_turn['price']\n    turn_type = ag_turn['type']\n\n    # 檢查後續 N 根 K\n    for i in range(turn_idx + 1, min(len(df), turn_idx + revert_bars + 1)):\n        if turn_type == 'top' and df['ag_close'].iloc[i] > turn_price:\n            return True  # 頂部後創新高 = 失敗\n        if turn_type == 'bottom' and df['ag_close'].iloc[i] < turn_price:\n            return True  # 底部後創新低 = 失敗\n\n    return False\n```\n\n### 規則 2：突破失敗 (no_confirm_then_break_fail)\n\n```python\ndef check_failed_move_breakout(df, ag_turn, confirmed: bool, breakout_threshold: float = 0.02):\n    \"\"\"\n    銀突破後，未確認且回落跌破突破點。\n    \"\"\"\n    if confirmed:\n        return False\n\n    # 檢查是否有突破\n    # ... 實作突破偵測邏輯\n```\n\n---\n\n## 市場含義\n\n### 確認事件\n\n- **鈀金先行轉向**：宏觀/工業週期變化的早期信號\n- **銀隨後確認**：更廣泛的貴金屬板塊共識\n- **交易價值**：銀的動作有「後台支持」，可信度高\n\n### 未確認事件\n\n- **流動性噪音**：可能是大單進出、期權到期、保證金調整\n- **孤立事件**：缺乏板塊共識\n- **交易警示**：謹慎對待，不宜激進跟進\n\n### 失敗走勢\n\n- **假突破 / 假反轉**：價格運動缺乏持續性\n- **回測統計**：未確認事件的失敗率顯著高於已確認\n- **風控啟示**：可用於過濾交易訊號、調整倉位\n\n---\n\n## 參考資料\n\n- Cross-correlation analysis in financial time series\n- Lead-lag relationships in commodity markets\n- Technical analysis: pivot points and trend detection\n",
        "skills/detect-palladium-lead-silver-turns/templates/output-json.md": "# JSON 輸出模板\n\n## 完整輸出結構\n\n```json\n{\n  \"skill\": \"detect-palladium-lead-silver-turns\",\n  \"symbol_pair\": {\n    \"silver\": \"SI=F\",\n    \"palladium\": \"PA=F\"\n  },\n  \"as_of\": \"2026-01-14\",\n  \"timeframe\": \"1h\",\n  \"lookback_bars\": 1200,\n\n  \"data_range\": {\n    \"start\": \"2025-01-01\",\n    \"end\": \"2026-01-14\",\n    \"trading_bars\": 1180,\n    \"missing_bars\": 20\n  },\n\n  \"summary\": {\n    \"estimated_pd_leads_by_bars\": 6,\n    \"lead_lag_corr\": 0.42,\n    \"lead_lag_confidence_interval\": [3, 9],\n    \"confirmation_rate\": 0.71,\n    \"unconfirmed_failure_rate\": 0.64,\n    \"total_ag_turns\": 24,\n    \"confirmed_turns\": 17,\n    \"unconfirmed_turns\": 7,\n    \"failed_moves\": 5\n  },\n\n  \"lead_lag_analysis\": {\n    \"best_lag\": 6,\n    \"correlation\": 0.42,\n    \"p_value\": 0.002,\n    \"is_significant\": true,\n    \"stability\": {\n      \"rolling_windows\": [\n        {\"period\": \"2025-Q1\", \"lag\": 5, \"corr\": 0.38},\n        {\"period\": \"2025-Q2\", \"lag\": 7, \"corr\": 0.45},\n        {\"period\": \"2025-Q3\", \"lag\": 6, \"corr\": 0.41},\n        {\"period\": \"2025-Q4\", \"lag\": 6, \"corr\": 0.44}\n      ],\n      \"is_stable\": true,\n      \"lag_std\": 0.8,\n      \"corr_std\": 0.03\n    }\n  },\n\n  \"confirmation_analysis\": {\n    \"by_type\": {\n      \"top\": {\"total\": 12, \"confirmed\": 8, \"rate\": 0.67},\n      \"bottom\": {\"total\": 12, \"confirmed\": 9, \"rate\": 0.75}\n    },\n    \"confirmation_lag_distribution\": {\n      \"mean\": -2.3,\n      \"median\": -3,\n      \"std\": 1.8,\n      \"min\": -6,\n      \"max\": 4\n    }\n  },\n\n  \"failure_analysis\": {\n    \"rule_used\": \"no_confirm_then_revert\",\n    \"unconfirmed_events\": 7,\n    \"failed_moves\": 5,\n    \"unconfirmed_failure_rate\": 0.71,\n    \"confirmed_failure_rate\": 0.18,\n    \"failure_rate_ratio\": 3.94,\n    \"average_revert_bars\": {\n      \"unconfirmed\": 8.2,\n      \"confirmed\": 15.6\n    }\n  },\n\n  \"events\": [\n    {\n      \"ts\": \"2026-01-08T10:00:00Z\",\n      \"idx\": 1150,\n      \"turn\": \"bottom\",\n      \"ag_price\": 29.85,\n      \"confirmed\": true,\n      \"confirmation_lag_bars\": -3,\n      \"pd_turn_ts\": \"2026-01-08T07:00:00Z\",\n      \"pd_turn_price\": 1025.50,\n      \"participation_ok\": true,\n      \"participation_score\": 0.72,\n      \"failed_move\": false,\n      \"subsequent_move_pct\": 2.3\n    },\n    {\n      \"ts\": \"2026-01-15T14:00:00Z\",\n      \"idx\": 1195,\n      \"turn\": \"top\",\n      \"ag_price\": 30.50,\n      \"confirmed\": false,\n      \"confirmation_lag_bars\": null,\n      \"pd_turn_ts\": null,\n      \"pd_turn_price\": null,\n      \"participation_ok\": false,\n      \"participation_score\": 0.35,\n      \"failed_move\": true,\n      \"subsequent_move_pct\": -1.8\n    }\n  ],\n\n  \"latest_event\": {\n    \"ts\": \"2026-01-15T14:00:00Z\",\n    \"turn\": \"top\",\n    \"confirmed\": false,\n    \"participation_ok\": false,\n    \"failed_move\": true\n  },\n\n  \"interpretation\": {\n    \"regime_assessment\": \"鈀金在本回溯窗口內對白銀報酬的最佳領先滯後為 +6 bars（鈀金先動）。未被鈀金確認的白銀拐點事件，其後續回撤/回到區間的比例顯著較高。\",\n    \"current_status\": \"當前白銀頂部未被鈀金確認，視為流動性噪音的可能性較高。\",\n    \"tactics\": [\n      \"避免基於未確認拐點進行方向性交易\",\n      \"等待下一個被鈀金確認的拐點再決策\",\n      \"若已有部位，可暫時觀望而非立即調整\",\n      \"注意後續 10 根 K 內的價格走勢以驗證失敗判定\"\n    ]\n  },\n\n  \"risk_metrics\": {\n    \"confirmation_reliability\": \"high\",\n    \"lead_lag_stability\": \"stable\",\n    \"current_regime\": \"normal\"\n  },\n\n  \"metadata\": {\n    \"generated_at\": \"2026-01-15T15:00:00Z\",\n    \"parameters\": {\n      \"turn_method\": \"pivot\",\n      \"pivot_left\": 3,\n      \"pivot_right\": 3,\n      \"confirm_window_bars\": 6,\n      \"lead_lag_max_bars\": 24,\n      \"participation_metric\": \"direction_agree\",\n      \"participation_threshold\": 0.6,\n      \"failure_rule\": \"no_confirm_then_revert\"\n    },\n    \"data_source\": \"yfinance\",\n    \"version\": \"0.1.0\"\n  }\n}\n```\n\n---\n\n## 精簡輸出（--quick 模式）\n\n```json\n{\n  \"skill\": \"detect-palladium-lead-silver-turns\",\n  \"symbol_pair\": {\"silver\": \"SI=F\", \"palladium\": \"PA=F\"},\n  \"as_of\": \"2026-01-14\",\n  \"timeframe\": \"1h\",\n  \"summary\": {\n    \"estimated_pd_leads_by_bars\": 6,\n    \"lead_lag_corr\": 0.42,\n    \"confirmation_rate\": 0.71,\n    \"unconfirmed_failure_rate\": 0.64\n  },\n  \"latest_event\": {\n    \"ts\": \"2026-01-15T14:00:00Z\",\n    \"turn\": \"top\",\n    \"confirmed\": false,\n    \"participation_ok\": false,\n    \"failed_move\": true\n  }\n}\n```\n\n---\n\n## 回測輸出\n\n```json\n{\n  \"skill\": \"detect-palladium-lead-silver-turns\",\n  \"mode\": \"backtest\",\n  \"symbol_pair\": {\"silver\": \"SI=F\", \"palladium\": \"PA=F\"},\n  \"timeframe\": \"1h\",\n  \"backtest_period\": {\n    \"start\": \"2024-01-01\",\n    \"end\": \"2026-01-01\",\n    \"total_bars\": 4800\n  },\n\n  \"lead_lag_analysis\": {\n    \"best_lag\": 6,\n    \"correlation\": 0.42,\n    \"confidence_interval\": [3, 9],\n    \"stability\": {\n      \"is_stable\": true,\n      \"lag_std\": 0.8\n    }\n  },\n\n  \"confirmation_analysis\": {\n    \"total_ag_turns\": 96,\n    \"confirmed_turns\": 68,\n    \"confirmation_rate\": 0.71,\n    \"by_type\": {\n      \"top\": {\"total\": 48, \"confirmed\": 32, \"rate\": 0.67},\n      \"bottom\": {\"total\": 48, \"confirmed\": 36, \"rate\": 0.75}\n    }\n  },\n\n  \"failure_analysis\": {\n    \"unconfirmed_failure_rate\": 0.64,\n    \"confirmed_failure_rate\": 0.18,\n    \"failure_rate_ratio\": 3.56\n  },\n\n  \"conclusion\": {\n    \"is_effective\": true,\n    \"effectiveness_score\": 0.78,\n    \"recommendation\": \"跨金屬確認邏輯有效，可用於交易過濾\"\n  }\n}\n```\n\n---\n\n## 監控告警輸出\n\n```json\n{\n  \"alert_type\": \"unconfirmed\",\n  \"timestamp\": \"2026-01-15T14:00:00Z\",\n  \"priority\": \"high\",\n  \"message\": \"白銀出現頂部拐點，但鈀金在確認窗口內未出現同向拐點\",\n  \"details\": {\n    \"ag_turn\": {\n      \"ts\": \"2026-01-15T14:00:00Z\",\n      \"type\": \"top\",\n      \"price\": 30.50\n    },\n    \"pd_status\": \"no_matching_turn\",\n    \"window_checked\": [-6, 6],\n    \"participation_score\": 0.35\n  },\n  \"suggested_action\": \"視為流動性噪音，謹慎應對\",\n  \"next_check\": \"2026-01-15T15:00:00Z\"\n}\n```\n\n---\n\n## 欄位說明\n\n### summary\n\n| 欄位                       | 類型  | 說明                       |\n|----------------------------|-------|----------------------------|\n| estimated_pd_leads_by_bars | int   | 鈀金領先白銀的 K 棒數      |\n| lead_lag_corr              | float | 領先滯後的相關係數         |\n| confirmation_rate          | float | 白銀拐點被確認的比例       |\n| unconfirmed_failure_rate   | float | 未確認事件的失敗比例       |\n\n### events[]\n\n| 欄位                | 類型    | 說明                       |\n|---------------------|---------|----------------------------|\n| ts                  | string  | 拐點時間戳                 |\n| turn                | string  | 拐點類型（top/bottom）     |\n| confirmed           | bool    | 是否被鈀金確認             |\n| confirmation_lag_bars| int    | 確認滯後（正值=鈀金先）    |\n| participation_ok    | bool    | 參與度是否達標             |\n| failed_move         | bool    | 是否判定為失敗走勢         |\n\n### interpretation\n\n| 欄位             | 類型     | 說明                       |\n|------------------|----------|----------------------------|\n| regime_assessment| string   | 當前行情評估               |\n| current_status   | string   | 最新事件狀態               |\n| tactics          | string[] | 可操作建議                 |\n",
        "skills/detect-palladium-lead-silver-turns/templates/output-markdown.md": "# Markdown 報告模板\n\n## 單次偵測報告\n\n```markdown\n# 白銀（{silver_symbol}）與鈀金（{palladium_symbol}）跨金屬拐點偵測報告\n\n**數據截至**：{as_of}\n**時間尺度**：{timeframe}\n**回溯範圍**：{lookback_bars} 根 K 棒\n\n---\n\n## 摘要\n\n| 指標                       | 數值     | 狀態                       |\n|----------------------------|----------|----------------------------|\n| 鈀金領先白銀               | {lead} bars | {lead_description}      |\n| 領先滯後相關係數           | {corr}   | {corr_description}         |\n| 確認率                     | {conf_rate}% | 白銀拐點被鈀金確認的比例 |\n| 未確認失敗率               | {fail_rate}% | 未被確認的拐點失敗比例   |\n\n---\n\n## 最新事件\n\n**時間**：{latest_ts}\n**類型**：{latest_turn}（{turn_cn}拐點）\n\n| 判定項目     | 結果     |\n|--------------|----------|\n| 鈀金確認     | {confirmed} |\n| 參與度       | {participation} |\n| 失敗走勢     | {failed} |\n\n### 判定說明\n\n{event_explanation}\n\n---\n\n## 可操作建議\n\n{tactics_list}\n\n---\n\n## 行情解讀\n\n{interpretation}\n\n---\n\n## 技術細節\n\n### 領先滯後分析\n\n- 最佳滯後：{best_lag} bars（{lag_meaning}）\n- 相關係數：{corr}（{corr_level}）\n- 置信區間：[{ci_low}, {ci_high}] bars\n- 穩定性：{stability}\n\n### 確認統計\n\n| 類型   | 總數 | 已確認 | 確認率 |\n|--------|------|--------|--------|\n| 頂部   | {top_total} | {top_confirmed} | {top_rate}% |\n| 底部   | {bottom_total} | {bottom_confirmed} | {bottom_rate}% |\n| 合計   | {total} | {confirmed_total} | {total_rate}% |\n\n### 失敗走勢統計\n\n- 未確認事件失敗率：{unconf_fail}%\n- 已確認事件失敗率：{conf_fail}%\n- 失敗率比值：{ratio}x\n\n---\n\n**報告生成時間**：{generated_at}\n**技能版本**：{version}\n```\n\n---\n\n## 回測報告\n\n```markdown\n# 跨金屬確認歷史回測報告\n\n**標的**：{silver_symbol} vs {palladium_symbol}\n**時間尺度**：{timeframe}\n**回測期間**：{start_date} 至 {end_date}\n**總 K 棒數**：{total_bars}\n\n---\n\n## 執行摘要\n\n{executive_summary}\n\n---\n\n## 領先滯後分析\n\n### 整體估計\n\n| 指標           | 數值     | 說明               |\n|----------------|----------|--------------------|\n| 最佳滯後       | {lag} bars | {lag_meaning}    |\n| 相關係數       | {corr}   | {corr_level}       |\n| p-value        | {pval}   | {significance}     |\n| 置信區間       | [{ci_low}, {ci_high}] | 95% CI  |\n\n### 穩定性分析\n\n| 期間     | 滯後 (bars) | 相關係數 |\n|----------|-------------|----------|\n| {period1}| {lag1}      | {corr1}  |\n| {period2}| {lag2}      | {corr2}  |\n| {period3}| {lag3}      | {corr3}  |\n| {period4}| {lag4}      | {corr4}  |\n\n**穩定性評估**：{stability_assessment}\n\n---\n\n## 確認有效性分析\n\n### 整體統計\n\n| 指標           | 數值     |\n|----------------|----------|\n| 白銀拐點總數   | {total}  |\n| 被確認數       | {confirmed} |\n| 確認率         | {rate}%  |\n\n### 按拐點類型\n\n| 類型   | 總數 | 已確認 | 確認率 |\n|--------|------|--------|--------|\n| 頂部   | {top_total} | {top_confirmed} | {top_rate}% |\n| 底部   | {bottom_total} | {bottom_confirmed} | {bottom_rate}% |\n\n### 確認滯後分布\n\n- 平均值：{lag_mean} bars\n- 中位數：{lag_median} bars\n- 標準差：{lag_std} bars\n- 範圍：[{lag_min}, {lag_max}] bars\n\n---\n\n## 失敗走勢分析\n\n### 失敗率比較\n\n| 事件類型 | 事件數 | 失敗數 | 失敗率 |\n|----------|--------|--------|--------|\n| 未確認   | {unconf_n} | {unconf_fail_n} | {unconf_rate}% |\n| 已確認   | {conf_n} | {conf_fail_n} | {conf_rate}% |\n\n**失敗率比值**：{ratio}x\n\n### 回撤速度\n\n| 事件類型 | 平均回撤 K 數 |\n|----------|---------------|\n| 未確認   | {unconf_revert} bars |\n| 已確認   | {conf_revert} bars |\n\n---\n\n## 結論\n\n### 有效性評估\n\n{effectiveness_conclusion}\n\n### 建議\n\n{recommendations}\n\n---\n\n**報告生成時間**：{generated_at}\n**使用參數**：\n\n```json\n{parameters_json}\n```\n```\n\n---\n\n## 監控日報\n\n```markdown\n# 鈀金-白銀跨金屬監控日報\n\n**日期**：{date}\n**標的**：{silver_symbol} vs {palladium_symbol}\n**時間尺度**：{timeframe}\n\n---\n\n## 當日新拐點\n\n| 時間 | 類型 | 白銀價格 | 確認狀態 | 參與度 | 判定 |\n|------|------|----------|----------|--------|------|\n{events_table}\n\n---\n\n## 統計匯總\n\n- 新拐點數：{new_turns}\n- 已確認數：{confirmed}\n- 未確認數：{unconfirmed}\n- 失敗走勢：{failed}\n\n---\n\n## 告警事件\n\n{alerts_section}\n\n---\n\n## 領先滯後關係變化\n\n| 指標           | 昨日     | 今日     | 變化     |\n|----------------|----------|----------|----------|\n| 滾動 7 日確認率| {prev_rate}% | {curr_rate}% | {rate_change} |\n| 滾動相關係數   | {prev_corr} | {curr_corr} | {corr_change} |\n\n---\n\n## 明日關注點\n\n{watchlist}\n\n---\n\n**生成時間**：{generated_at}\n```\n\n---\n\n## 佔位符說明\n\n| 佔位符              | 說明                     | 範例                   |\n|---------------------|--------------------------|------------------------|\n| `{silver_symbol}`   | 白銀標的代碼             | SI=F                   |\n| `{palladium_symbol}`| 鈀金標的代碼             | PA=F                   |\n| `{as_of}`           | 數據截止日期             | 2026-01-14             |\n| `{timeframe}`       | 時間尺度                 | 1h                     |\n| `{lead}`            | 領先 K 棒數              | 6                      |\n| `{corr}`            | 相關係數                 | 0.42                   |\n| `{conf_rate}`       | 確認率百分比             | 71                     |\n| `{fail_rate}`       | 失敗率百分比             | 64                     |\n| `{latest_ts}`       | 最新事件時間             | 2026-01-15T14:00:00Z   |\n| `{latest_turn}`     | 最新事件類型             | top                    |\n| `{confirmed}`       | 確認狀態                 | 否 / 是                |\n| `{participation}`   | 參與度狀態               | 不足 / 足夠            |\n| `{failed}`          | 失敗走勢判定             | 是 / 否                |\n| `{tactics_list}`    | 建議列表（Markdown）     | - 建議1\\n- 建議2       |\n| `{interpretation}`  | 行情解讀                 | 文字段落               |\n| `{generated_at}`    | 報告生成時間             | 2026-01-15T15:00:00Z   |\n",
        "skills/detect-palladium-lead-silver-turns/workflows/backtest.md": "# Workflow: 歷史回測\n\n<required_reading>\n**執行前請閱讀：**\n1. references/methodology.md - 了解跨金屬確認邏輯\n2. references/input-schema.md - 完整參數定義\n3. references/data-sources.md - 數據來源與覆蓋範圍\n</required_reading>\n\n<process>\n\n## Step 1: 定義回測範圍\n\n確認以下參數：\n\n| 參數              | 範例值       | 說明                   |\n|-------------------|--------------|------------------------|\n| silver_symbol     | SI=F         | 白銀標的代碼           |\n| palladium_symbol  | PA=F         | 鈀金標的代碼           |\n| timeframe         | 1h           | 分析時間尺度           |\n| start_date        | 2024-01-01   | 回測開始日期           |\n| end_date          | 2026-01-01   | 回測結束日期           |\n\n建議回測至少 6 個月以上的數據以獲得統計有效性。\n\n## Step 2: 執行回測\n\n```bash\ncd skills/detect-palladium-lead-silver-turns\npython scripts/palladium_lead_silver.py \\\n  --silver SI=F \\\n  --palladium PA=F \\\n  --timeframe 1h \\\n  --start 2024-01-01 \\\n  --end 2026-01-01 \\\n  --backtest \\\n  --output backtest_result.json\n```\n\n## Step 3: 分析領先滯後穩定性\n\n檢查輸出中的 `lead_lag_analysis` 區塊：\n\n```json\n{\n  \"lead_lag_analysis\": {\n    \"best_lag\": 6,\n    \"correlation\": 0.42,\n    \"confidence_interval\": [3, 9],\n    \"stability\": {\n      \"rolling_windows\": [\n        {\"period\": \"2024-Q1\", \"lag\": 5, \"corr\": 0.38},\n        {\"period\": \"2024-Q2\", \"lag\": 7, \"corr\": 0.45},\n        {\"period\": \"2024-Q3\", \"lag\": 6, \"corr\": 0.41},\n        {\"period\": \"2024-Q4\", \"lag\": 6, \"corr\": 0.44}\n      ],\n      \"is_stable\": true,\n      \"std_deviation\": 0.8\n    }\n  }\n}\n```\n\n### 穩定性判斷標準\n\n| 指標           | 穩定閾值 | 說明                   |\n|----------------|----------|------------------------|\n| std_deviation  | < 2.0    | 各期 lag 標準差        |\n| corr_range     | < 0.2    | 相關係數變動範圍       |\n| direction_flip | 0        | lag 正負號翻轉次數     |\n\n## Step 4: 分析確認有效性\n\n檢查 `confirmation_analysis` 區塊：\n\n```json\n{\n  \"confirmation_analysis\": {\n    \"total_ag_turns\": 48,\n    \"confirmed_turns\": 34,\n    \"confirmation_rate\": 0.71,\n    \"by_type\": {\n      \"top\": {\"total\": 24, \"confirmed\": 16, \"rate\": 0.67},\n      \"bottom\": {\"total\": 24, \"confirmed\": 18, \"rate\": 0.75}\n    },\n    \"confirmation_lag_distribution\": {\n      \"mean\": -2.3,\n      \"median\": -3,\n      \"std\": 1.8\n    }\n  }\n}\n```\n\n### 有效性指標\n\n| 指標                | 良好閾值 | 說明                   |\n|---------------------|----------|------------------------|\n| confirmation_rate   | > 0.6    | 整體確認率             |\n| rate_diff_top_bottom| < 0.2    | 頂底確認率差異         |\n| lag_std             | < 3.0    | 確認滯後的穩定性       |\n\n## Step 5: 分析失敗走勢\n\n檢查 `failure_analysis` 區塊：\n\n```json\n{\n  \"failure_analysis\": {\n    \"unconfirmed_events\": 14,\n    \"failed_moves\": 9,\n    \"unconfirmed_failure_rate\": 0.64,\n    \"confirmed_events\": 34,\n    \"confirmed_failures\": 6,\n    \"confirmed_failure_rate\": 0.18,\n    \"failure_rate_ratio\": 3.6,\n    \"average_revert_bars\": {\n      \"unconfirmed\": 8.2,\n      \"confirmed\": 15.6\n    }\n  }\n}\n```\n\n### 關鍵發現\n\n1. **失敗率比值 (failure_rate_ratio)**\n   - > 2.0：跨金屬確認有顯著過濾價值\n   - 1.5 - 2.0：確認有一定幫助但不顯著\n   - < 1.5：確認邏輯在此數據集上無效\n\n2. **平均回撤速度 (average_revert_bars)**\n   - 未確認事件回撤更快 → 確認邏輯有效\n\n## Step 6: 生成回測報告\n\n```bash\n# 生成 Markdown 報告\npython scripts/palladium_lead_silver.py \\\n  --silver SI=F \\\n  --palladium PA=F \\\n  --backtest \\\n  --format markdown \\\n  --output backtest_report.md\n```\n\n報告內容：\n1. **數據概覽**：時間範圍、樣本數\n2. **領先滯後分析**：最佳 lag、穩定性\n3. **確認有效性**：確認率、分布\n4. **失敗走勢統計**：失敗率比較\n5. **結論與建議**\n\n## Step 7: 視覺化回測結果（可選）\n\n```bash\npython scripts/plot_palladium_silver.py \\\n  --silver SI=F \\\n  --palladium PA=F \\\n  --start 2024-01-01 \\\n  --end 2026-01-01 \\\n  --backtest \\\n  --output output/backtest/\n```\n\n輸出圖表：\n- 價格疊加與所有拐點標記\n- 確認 vs 未確認事件的後續表現\n- 滾動領先滯後時間序列\n- 失敗率按時間分布\n\n</process>\n\n<interpretation_guide>\n\n## 結果解讀指南\n\n### 領先滯後解讀\n\n| 結果                | 含義                       | 建議               |\n|---------------------|----------------------------|--------------------|\n| lag > 0, corr > 0.3 | 鈀金有效領先白銀           | 可用於確認         |\n| lag > 0, corr < 0.3 | 領先關係弱                 | 謹慎使用           |\n| lag ≈ 0             | 同步移動                   | 調整參數或時間尺度 |\n| lag < 0             | 白銀領先鈀金               | 反向使用確認邏輯   |\n\n### 確認有效性解讀\n\n| 確認率  | 失敗率比值 | 結論                     |\n|---------|------------|--------------------------|\n| > 70%   | > 3.0      | 確認邏輯非常有效         |\n| > 60%   | > 2.0      | 確認邏輯有效             |\n| > 50%   | > 1.5      | 確認邏輯有一定幫助       |\n| < 50%   | < 1.5      | 確認邏輯在此數據集無效   |\n\n### 穩定性解讀\n\n| 穩定性指標          | 良好     | 警告     | 差       |\n|---------------------|----------|----------|----------|\n| lag 標準差          | < 1.5    | 1.5-3.0  | > 3.0    |\n| corr 變動範圍       | < 0.15   | 0.15-0.3 | > 0.3    |\n| 方向翻轉次數        | 0        | 1        | > 1      |\n\n</interpretation_guide>\n\n<success_criteria>\n此工作流程完成時應有：\n\n- [ ] 領先滯後估計及其穩定性分析\n- [ ] 確認率統計（整體、按類型）\n- [ ] 失敗走勢分析（失敗率比值）\n- [ ] 回測報告（JSON 或 Markdown）\n- [ ] 結論：確認邏輯是否有效\n- [ ] （可選）回測視覺化圖表\n</success_criteria>\n",
        "skills/detect-palladium-lead-silver-turns/workflows/detect.md": "# Workflow: 單次偵測\n\n<required_reading>\n**執行前請閱讀：**\n1. references/input-schema.md - 完整參數定義\n2. references/data-sources.md - 數據來源與代碼\n</required_reading>\n\n<process>\n\n## Step 1: 確認輸入參數\n\n確認以下必要參數：\n\n| 參數              | 預設值 | 說明                   |\n|-------------------|--------|------------------------|\n| silver_symbol     | SI=F   | 白銀標的代碼           |\n| palladium_symbol  | PA=F   | 鈀金標的代碼           |\n| timeframe         | 1h     | 分析時間尺度           |\n| lookback_bars     | 1000   | 回溯 K 棒數            |\n\n如果用戶提供了特定參數，使用用戶的值。\n\n## Step 2: 執行偵測腳本\n\n```bash\ncd skills/detect-palladium-lead-silver-turns\npython scripts/palladium_lead_silver.py \\\n  --silver {silver_symbol} \\\n  --palladium {palladium_symbol} \\\n  --timeframe {timeframe} \\\n  --lookback {lookback_bars}\n```\n\n快速模式（使用預設參數）：\n```bash\npython scripts/palladium_lead_silver.py --quick\n```\n\n## Step 3: 解讀輸出結果\n\n輸出 JSON 包含以下關鍵資訊：\n\n### 3.1 領先滯後估計\n\n```json\n{\n  \"estimated_pd_leads_by_bars\": 6,\n  \"lead_lag_corr\": 0.42\n}\n```\n\n- `estimated_pd_leads_by_bars > 0`：鈀金領先白銀\n- `lead_lag_corr > 0.3`：有意義的領先關係\n\n### 3.2 確認統計\n\n```json\n{\n  \"confirmation_rate\": 0.71,\n  \"unconfirmed_failure_rate\": 0.64\n}\n```\n\n- `confirmation_rate > 0.6`：多數白銀拐點被確認\n- `unconfirmed_failure_rate > 0.5`：未確認事件多數失敗\n\n### 3.3 最新事件\n\n```json\n{\n  \"latest_event\": {\n    \"ts\": \"2026-01-15T14:00:00Z\",\n    \"turn\": \"top\",\n    \"confirmed\": false,\n    \"participation_ok\": false,\n    \"failed_move\": true\n  }\n}\n```\n\n重點關注 `confirmed` 和 `failed_move` 欄位。\n\n## Step 4: 生成視覺化（可選）\n\n### 4.1 Bloomberg 風格圖表（推薦）\n\n```bash\npip install matplotlib yfinance  # 首次使用\npython scripts/plot_bloomberg_style.py \\\n  --input result.json \\\n  --output output/palladium_silver_{date}.png\n```\n\n特色：\n- Bloomberg 專業配色（深色背景）\n- 雙軸價格疊加（白銀橙紅、鈀金橙黃）\n- 拐點標記（綠色=已確認、紅色=未確認）\n- 最新事件醒目標註\n- 滾動確認率趨勢圖\n- 統計面板與行情解讀\n\n### 4.2 傳統三合一圖表\n\n```bash\npython scripts/plot_palladium_silver.py \\\n  --silver {silver_symbol} \\\n  --palladium {palladium_symbol} \\\n  --output output/\n```\n\n包含：\n- 價格疊加與拐點標記\n- 確認/未確認分布\n- 滾動相關係數\n\n## Step 5: 輸出報告\n\n根據 `templates/output-markdown.md` 格式化結果，包含：\n\n1. **數據摘要表格**\n2. **最新事件判定**\n3. **可操作建議**\n4. **行情解讀**\n\n</process>\n\n<parameter_tuning>\n\n## 參數調校指南\n\n### 確認窗口 (confirm_window_bars)\n\n| 時間尺度 | 建議值 | 說明               |\n|----------|--------|--------------------|\n| 1h       | 6-12   | 約半天到一天       |\n| 4h       | 3-6    | 約半天到一天       |\n| 1d       | 2-5    | 約一週             |\n\n調校方法：\n```bash\n# 測試不同窗口\npython scripts/palladium_lead_silver.py --silver SI=F --palladium PA=F --confirm-window 4\npython scripts/palladium_lead_silver.py --silver SI=F --palladium PA=F --confirm-window 8\npython scripts/palladium_lead_silver.py --silver SI=F --palladium PA=F --confirm-window 12\n```\n\n選擇確認率與失敗率差異最大的窗口。\n\n### 拐點偵測方法 (turn_method)\n\n| 方法          | 適用場景                 | 參數             |\n|---------------|--------------------------|------------------|\n| pivot         | 結構明確的趨勢           | pivot_left, pivot_right |\n| peaks         | 自動化密度控制           | prominence, distance |\n| slope_change  | 平滑趨勢追蹤             | slope_window     |\n\n```bash\n# 使用 pivot 法\npython scripts/palladium_lead_silver.py --turn-method pivot --pivot-left 3 --pivot-right 3\n\n# 使用 peaks 法\npython scripts/palladium_lead_silver.py --turn-method peaks --prominence 0.5\n\n# 使用 slope_change 法\npython scripts/palladium_lead_silver.py --turn-method slope_change --slope-window 10\n```\n\n### 參與度門檻 (participation_threshold)\n\n建議範圍：0.5 - 0.7\n\n- 太低（< 0.5）：假陽性增加\n- 太高（> 0.7）：漏掉有效確認\n\n</parameter_tuning>\n\n<success_criteria>\n此工作流程完成時應有：\n\n- [ ] 鈀金對白銀的領先滯後估計\n- [ ] 白銀拐點的確認率統計\n- [ ] 最新事件的判定結果\n- [ ] 可操作的交易建議\n- [ ] （可選）視覺化圖表\n</success_criteria>\n",
        "skills/detect-palladium-lead-silver-turns/workflows/monitor.md": "# Workflow: 持續監控\n\n<required_reading>\n**執行前請閱讀：**\n1. references/input-schema.md - 完整參數定義\n2. references/data-sources.md - 數據更新頻率\n</required_reading>\n\n<process>\n\n## Step 1: 設定監控參數\n\n確認以下監控配置：\n\n| 參數                 | 預設值      | 說明                   |\n|----------------------|-------------|------------------------|\n| silver_symbol        | SI=F        | 白銀標的代碼           |\n| palladium_symbol     | PA=F        | 鈀金標的代碼           |\n| timeframe            | 1h          | 監控時間尺度           |\n| check_interval_min   | 60          | 檢查間隔（分鐘）       |\n| alert_on_unconfirmed | true        | 未確認事件是否告警     |\n| alert_on_new_turn    | true        | 新拐點是否告警         |\n\n## Step 2: 啟動監控服務\n\n### 方式 A：命令行監控\n\n```bash\ncd skills/detect-palladium-lead-silver-turns\npython scripts/palladium_lead_silver.py \\\n  --silver SI=F \\\n  --palladium PA=F \\\n  --timeframe 1h \\\n  --monitor \\\n  --interval 60\n```\n\n### 方式 B：定時任務（cron）\n\n```bash\n# 每小時執行一次\n0 * * * * cd /path/to/skills/detect-palladium-lead-silver-turns && python scripts/palladium_lead_silver.py --silver SI=F --palladium PA=F --quick --output /tmp/pd_ag_latest.json\n```\n\n### 方式 C：Python 腳本整合\n\n```python\nfrom apscheduler.schedulers.asyncio import AsyncIOScheduler\nfrom apscheduler.triggers.interval import IntervalTrigger\nimport subprocess\nimport json\n\nscheduler = AsyncIOScheduler()\n\ndef check_palladium_silver():\n    result = subprocess.run([\n        'python', 'scripts/palladium_lead_silver.py',\n        '--silver', 'SI=F',\n        '--palladium', 'PA=F',\n        '--quick',\n        '--output', '/tmp/pd_ag_latest.json'\n    ], capture_output=True, text=True)\n\n    with open('/tmp/pd_ag_latest.json') as f:\n        data = json.load(f)\n\n    # 檢查是否需要告警\n    if data.get('latest_event', {}).get('failed_move'):\n        send_alert(f\"白銀拐點未被鈀金確認，可能為失敗走勢\")\n\n    if data.get('latest_event', {}).get('turn') and not data.get('latest_event', {}).get('confirmed'):\n        send_alert(f\"白銀新拐點（{data['latest_event']['turn']}），等待鈀金確認\")\n\n# 每 60 分鐘執行，±5 分鐘隨機偏移\nscheduler.add_job(\n    check_palladium_silver,\n    trigger=IntervalTrigger(minutes=60, jitter=300),\n    id='pd_ag_monitor'\n)\n\nscheduler.start()\n```\n\n## Step 3: 設定告警條件\n\n### 告警類型\n\n| 告警類型           | 觸發條件                         | 優先級 |\n|--------------------|----------------------------------|--------|\n| `new_turn`         | 白銀出現新拐點                   | 中     |\n| `unconfirmed`      | 白銀拐點在窗口內未被確認         | 高     |\n| `failed_move`      | 未確認 + 符合失敗走勢規則        | 高     |\n| `participation_low`| 鈀金參與度低於門檻               | 中     |\n| `regime_change`    | 領先滯後關係發生結構性變化       | 高     |\n\n### 告警輸出格式\n\n```json\n{\n  \"alert_type\": \"unconfirmed\",\n  \"timestamp\": \"2026-01-15T14:00:00Z\",\n  \"message\": \"白銀出現頂部拐點，但鈀金在確認窗口內未出現同向拐點\",\n  \"details\": {\n    \"ag_turn\": {\"ts\": \"2026-01-15T14:00:00Z\", \"type\": \"top\", \"price\": 30.50},\n    \"pd_status\": \"no_matching_turn\",\n    \"window_checked\": [-6, 6],\n    \"suggested_action\": \"視為流動性噪音，謹慎應對\"\n  },\n  \"priority\": \"high\"\n}\n```\n\n## Step 4: 整合通知渠道\n\n### Telegram 通知\n\n```python\nimport requests\n\ndef send_telegram_alert(message: str, chat_id: str, bot_token: str):\n    url = f\"https://api.telegram.org/bot{bot_token}/sendMessage\"\n    data = {\"chat_id\": chat_id, \"text\": message, \"parse_mode\": \"Markdown\"}\n    requests.post(url, data=data)\n\n# 使用\nsend_telegram_alert(\n    f\"*白銀拐點告警*\\n\"\n    f\"類型: {alert['alert_type']}\\n\"\n    f\"時間: {alert['timestamp']}\\n\"\n    f\"訊息: {alert['message']}\",\n    chat_id=TELEGRAM_CHAT_ID,\n    bot_token=TELEGRAM_BOT_TOKEN\n)\n```\n\n### Discord Webhook\n\n```python\nimport requests\n\ndef send_discord_alert(message: str, webhook_url: str):\n    data = {\"content\": message}\n    requests.post(webhook_url, json=data)\n```\n\n### Email 通知\n\n```python\nimport smtplib\nfrom email.mime.text import MIMEText\n\ndef send_email_alert(subject: str, body: str, to_email: str):\n    msg = MIMEText(body)\n    msg['Subject'] = subject\n    msg['From'] = SMTP_FROM\n    msg['To'] = to_email\n\n    with smtplib.SMTP(SMTP_HOST, SMTP_PORT) as server:\n        server.starttls()\n        server.login(SMTP_USER, SMTP_PASSWORD)\n        server.send_message(msg)\n```\n\n## Step 5: 監控狀態追蹤\n\n### 狀態文件\n\n```json\n{\n  \"last_check\": \"2026-01-15T14:00:00Z\",\n  \"last_ag_turn\": {\n    \"ts\": \"2026-01-15T10:00:00Z\",\n    \"type\": \"bottom\",\n    \"confirmed\": true\n  },\n  \"current_regime\": {\n    \"pd_leads_by\": 6,\n    \"correlation\": 0.42,\n    \"confirmation_rate_7d\": 0.75\n  },\n  \"alerts_sent_today\": 3,\n  \"next_check\": \"2026-01-15T15:00:00Z\"\n}\n```\n\n### 健康檢查\n\n```bash\n# 檢查監控服務狀態\npython scripts/palladium_lead_silver.py --health-check\n\n# 輸出\n{\n  \"status\": \"healthy\",\n  \"last_successful_check\": \"2026-01-15T14:00:00Z\",\n  \"data_freshness\": \"1 hour ago\",\n  \"next_scheduled_check\": \"2026-01-15T15:00:00Z\"\n}\n```\n\n## Step 6: 日報生成\n\n每日結束時生成監控日報：\n\n```bash\npython scripts/palladium_lead_silver.py \\\n  --silver SI=F \\\n  --palladium PA=F \\\n  --daily-report \\\n  --date 2026-01-15 \\\n  --output daily_report_20260115.md\n```\n\n日報內容：\n1. 當日新拐點列表\n2. 確認狀態統計\n3. 告警事件匯總\n4. 領先滯後關係變化\n5. 明日關注點\n\n</process>\n\n<monitoring_best_practices>\n\n## 監控最佳實踐\n\n### 1. 避免告警疲勞\n\n- 設定告警冷卻時間（如同類告警 4 小時內不重複）\n- 區分優先級，只對高優先級即時通知\n- 低優先級告警批量匯總（如日報）\n\n### 2. 數據新鮮度\n\n| 時間尺度 | 建議檢查間隔 | 數據延遲容忍 |\n|----------|--------------|--------------|\n| 1h       | 30-60 分鐘   | 15 分鐘      |\n| 4h       | 2-4 小時     | 1 小時       |\n| 1d       | 每日一次     | 4 小時       |\n\n### 3. 結構性變化監控\n\n除了單次事件，還需監控長期關係變化：\n- 滾動 7 日確認率是否下降\n- 領先滯後是否發生方向翻轉\n- 相關係數是否顯著下降\n\n</monitoring_best_practices>\n\n<success_criteria>\n此工作流程完成時應有：\n\n- [ ] 監控服務配置完成\n- [ ] 告警條件設定\n- [ ] 通知渠道整合\n- [ ] 健康檢查機制\n- [ ] （可選）日報自動生成\n</success_criteria>\n",
        "skills/detect-shanghai-silver-stock-drain/SKILL.md": "---\nname: detect-shanghai-silver-stock-drain\ndescription: 以公開交易所庫存資料為核心，量化上海白銀庫存耗盡的方向、速度與加速度，並將其轉成可交易的供給緊縮訊號。\n---\n\n<essential_principles>\n\n<principle name=\"drain_metrics_core\">\n**庫存耗盡三維度量化**\n\n庫存分析的三維框架：\n- **方向（Direction）**：庫存是上升還是下降\n- **速度（Speed）**：每週流出量 `drain_rate(t) = -Δ1(t)`\n- **加速度（Acceleration）**：流出速度的變化 `Δ2(t) = drain_rate(t) - drain_rate(t-1)`\n\n當 `drain_rate > 0` 且 `Δ2 > 0` 時，表示「庫存正在流出，且流出速度在加快」——這是晚期供給訊號的核心特徵。\n</principle>\n\n<principle name=\"z_score_standardization\">\n**Z 分數標準化判斷**\n\n使用歷史視窗（建議 3~5 年）計算 Z 分數：\n- `z_drain(t) = (drain_rate(t) - mean) / std`\n- `z_accel(t) = (Δ2(t) - mean) / std`\n\n門檻判定：\n| 指標             | 門檻   | 意義                 |\n|------------------|--------|----------------------|\n| z_drain          | ≤ -1.5 | 流出速度顯著大於常態 |\n| z_accel          | ≥ +1.0 | 流出正在加速         |\n| level_percentile | ≤ 0.20 | 庫存處於歷史低檔     |\n</principle>\n\n<principle name=\"three_stage_signal\">\n**三段式晚期訊號判定**\n\n把推文敘事轉為可執行規則：\n\n| 條件            | 描述                    | 單獨成立 | 組合效果     |\n|-----------------|-------------------------|----------|--------------|\n| A. Level        | 庫存水位 < 20% 歷史分位 | WATCH    | -            |\n| B. Speed        | z_drain ≤ -1.5          | WATCH    | B+C → MEDIUM |\n| C. Acceleration | z_accel ≥ +1.0          | WATCH    | A+B+C → HIGH |\n\n**訊號分級**：\n- `HIGH_LATE_STAGE_SUPPLY_SIGNAL`：A+B+C 同時成立\n- `MEDIUM_SUPPLY_TIGHTENING`：(B+C) 或 (A+B) 成立\n- `WATCH`：任一條件成立\n- `NO_SIGNAL`：無異常\n</principle>\n\n<principle name=\"data_sources\">\n**資料來源與口徑**\n\n主要數據來源：\n- **CEIC Data**：上海期貨交易所白銀倉單數據\n  - URL: `https://www.ceicdata.com/zh-hans/china/shanghai-futures-exchange-commodity-futures-stock/cn-warehouse-stock-shanghai-future-exchange-silver`\n  - 數據範圍：2012-07-02 至今（約 3,300+ 觀測值）\n  - 更新頻率：每日\n  - 歷史最高：3,091 噸 (2021-01-12)\n\n**重要提醒**：\n- 這是「交易所可交割/倉單」口徑，不等於全中國社會庫存\n- 單週跳動可能反映倉儲規則變動或搬倉，需平滑處理\n- 使用 Selenium 模擬人類瀏覽器抓取 SVG 圖表，遵循反偵測策略\n</principle>\n\n</essential_principles>\n\n<objective>\n監控上海白銀庫存（SGE + SHFE）的耗盡狀態：\n\n1. **數據採集**：抓取 SGE/SHFE 週報庫存數據\n2. **三維量化**：計算方向、速度、加速度\n3. **標準化判斷**：使用 Z 分數判定異常\n4. **訊號生成**：輸出晚期供給訊號分級\n5. **市場交叉驗證**（選配）：COMEX、ETF、現貨溢價\n\n輸出：庫存水位、耗盡速度、加速度、Z 分數、訊號分級、敘事解讀。\n</objective>\n\n<quick_start>\n\n**最快的方式：檢查上海白銀庫存耗盡狀態**\n\n```bash\ncd skills/detect-shanghai-silver-stock-drain\n\n# 首次使用：安裝依賴\npip install pandas numpy selenium webdriver-manager matplotlib\n\n# 1. 抓取最新數據（5 年歷史，約 200+ 週）\npython scripts/fetch_shfe_stock.py --force-update\n\n# 2. 執行快速檢查\npython scripts/drain_detector.py --quick\n```\n\n輸出範例：\n```json\n{\n  \"as_of\": \"2026-01-16\",\n  \"signal\": \"MEDIUM_SUPPLY_TIGHTENING\",\n  \"latest_combined_stock_tonnes\": 1133.3,\n  \"level_percentile\": 0.12,\n  \"z_drain_rate\": -2.1,\n  \"z_acceleration\": 1.4\n}\n```\n\n**完整分析 + 視覺化報告**：\n```bash\n# 1. 執行完整分析\npython scripts/drain_detector.py \\\n  --start 2020-01-01 \\\n  --end 2026-01-16 \\\n  --output result.json\n\n# 2. 生成視覺化報告\npython scripts/visualize_drain.py \\\n  --result result.json \\\n  --output ../../../output/\n```\n\n</quick_start>\n\n<intake>\n需要進行什麼操作？\n\n1. **快速檢查** - 查看目前上海白銀庫存耗盡狀態與訊號\n2. **完整分析** - 執行完整的歷史庫存分析與趨勢計算\n3. **數據更新** - 抓取最新的 SGE/SHFE 庫存數據\n4. **交叉驗證** - 使用 COMEX、ETF 等指標交叉驗證\n5. **方法論學習** - 了解三維度量化與訊號判定邏輯\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                       | Action                                     |\n|--------------------------------|--------------------------------------------|\n| 1, \"快速\", \"quick\", \"check\"    | 執行 `scripts/drain_detector.py --quick`   |\n| 2, \"分析\", \"analyze\", \"full\"   | 閱讀 `workflows/analyze.md` 並執行         |\n| 3, \"更新\", \"fetch\", \"data\"     | 閱讀 `workflows/fetch-data.md` 並執行      |\n| 4, \"驗證\", \"validate\", \"cross\" | 閱讀 `workflows/cross-validate.md` 並執行  |\n| 5, \"學習\", \"方法論\", \"why\"     | 閱讀 `references/methodology.md`           |\n| 提供日期參數                   | 閱讀 `workflows/analyze.md` 並使用參數執行 |\n\n**路由後，閱讀對應文件並執行。**\n</routing>\n\n<directory_structure>\n```\ndetect-shanghai-silver-stock-drain/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元數據\n├── workflows/\n│   ├── analyze.md                     # 完整庫存分析工作流\n│   ├── fetch-data.md                  # 數據抓取工作流\n│   └── cross-validate.md              # 交叉驗證工作流\n├── references/\n│   ├── data-sources.md                # SGE/SHFE 資料來源說明\n│   ├── methodology.md                 # 三維度量化方法論\n│   └── input-schema.md                # 完整輸入參數定義\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n└── scripts/\n    ├── drain_detector.py              # 主偵測腳本\n    ├── fetch_sge_stock.py             # SGE 庫存抓取（PDF）\n    ├── fetch_shfe_stock.py            # SHFE 庫存抓取\n    └── visualize_drain.py             # 視覺化報告生成\n```\n</directory_structure>\n\n<reference_index>\n\n**方法論**: references/methodology.md\n- 三維度量化邏輯（方向、速度、加速度）\n- Z 分數標準化\n- 三段式訊號判定\n\n**資料來源**: references/data-sources.md\n- SGE 行情周報 PDF 抓取\n- SHFE 倉單/庫存周報抓取\n- Selenium 反偵測策略\n\n**輸入參數**: references/input-schema.md\n- 完整參數定義\n- 預設值與建議範圍\n\n</reference_index>\n\n<workflows_index>\n| Workflow          | Purpose      | 使用時機                 |\n|-------------------|--------------|--------------------------|\n| analyze.md        | 完整庫存分析 | 需要完整歷史分析時       |\n| fetch-data.md     | 數據抓取     | 更新 SGE/SHFE 庫存數據   |\n| cross-validate.md | 交叉驗證訊號 | 確認供給緊縮訊號真實性時 |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構定義 |\n| output-markdown.md | Markdown 報告模板 |\n</templates_index>\n\n<scripts_index>\n| Script              | Command                                 | Purpose          |\n|---------------------|-----------------------------------------|------------------|\n| drain_detector.py   | `--quick`                               | 快速檢查耗盡狀態 |\n| drain_detector.py   | `--start DATE --end DATE --output FILE` | 完整歷史分析     |\n| fetch_sge_stock.py  | `--output sge_stock.csv`                | 抓取 SGE 庫存    |\n| fetch_shfe_stock.py | `--output shfe_stock.csv`               | 抓取 SHFE 庫存   |\n| visualize_drain.py  | `--result result.json --output DIR`     | 生成視覺化報告   |\n</scripts_index>\n\n<input_schema_summary>\n\n**核心參數**\n\n| 參數            | 類型   | 預設值         | 說明                     |\n|-----------------|--------|----------------|--------------------------|\n| start_date      | string | 3Y 前          | 分析起始日 (YYYY-MM-DD)  |\n| end_date        | string | today          | 分析結束日 (YYYY-MM-DD)  |\n| frequency       | string | weekly         | 數據頻率 (weekly/daily)  |\n| include_sources | array  | [\"SGE\",\"SHFE\"] | 納入的庫存來源           |\n| unit            | string | tonnes         | 單位 (tonnes/kg/troy_oz) |\n\n**分析參數**\n\n| 參數                   | 類型  | 預設值 | 說明                 |\n|------------------------|-------|--------|----------------------|\n| smoothing_window_weeks | int   | 4      | 平滑視窗（週）       |\n| drain_threshold_z      | float | -1.5   | 異常耗盡 Z 分數門檻  |\n| accel_threshold_z      | float | +1.0   | 耗盡加速 Z 分數門檻  |\n| confirm_with_markets   | bool  | true   | 是否做市場側交叉驗證 |\n\n完整參數定義見 `references/input-schema.md`。\n\n</input_schema_summary>\n\n<output_schema_summary>\n```json\n{\n  \"skill\": \"detect_shanghai_silver_stock_drain\",\n  \"as_of\": \"2026-01-16\",\n  \"unit\": \"tonnes\",\n  \"sources\": [\"SGE\", \"SHFE\"],\n  \"latest_combined_stock\": 1133.3,\n  \"level_percentile\": 0.12,\n  \"recent_4w_avg_drawdown\": 58.4,\n  \"drawdown_acceleration\": 9.7,\n  \"z_scores\": {\n    \"z_drain_rate\": -2.1,\n    \"z_acceleration\": 1.4\n  },\n  \"signal\": \"HIGH_LATE_STAGE_SUPPLY_SIGNAL\",\n  \"narrative\": [...],\n  \"caveats\": [...]\n}\n```\n\n完整輸出結構見 `templates/output-json.md`。\n</output_schema_summary>\n\n<success_criteria>\n執行成功時應產出：\n\n- [ ] 上海合併庫存水位（SGE + SHFE）\n- [ ] 庫存水位歷史分位數\n- [ ] 近 N 週平均流出速度\n- [ ] 流出加速度\n- [ ] z_drain_rate 與 z_acceleration\n- [ ] 訊號分級（HIGH/MEDIUM/WATCH/NO_SIGNAL）\n- [ ] 敘事解讀（中文）\n- [ ] 數據口徑與限制說明\n</success_criteria>\n",
        "skills/detect-shanghai-silver-stock-drain/references/data-sources.md": "# 資料來源：SGE/SHFE 庫存數據抓取\n\n本文件說明上海白銀庫存數據的來源、抓取方法與反偵測策略。\n\n---\n\n## 主要資料來源\n\n### 1. SGE（上海黃金交易所）\n\n**官方網站**：https://www.sge.com.cn\n\n**數據位置**：行情周報 PDF → 指定倉庫庫存周報\n\n**數據內容**：\n| 欄位 | 說明 | 單位 |\n|------|------|------|\n| 日期 | 周報截止日 | YYYY-MM-DD |\n| 白銀庫存 | 指定倉庫白銀庫存量 | kg |\n\n**抓取方法**：\n1. 訪問 SGE 官網「市場數據」→「行情周報」\n2. 下載週報 PDF 檔案\n3. 使用 pdfplumber 解析 PDF 表格\n4. 定位「指定倉庫庫存周報」區塊\n5. 提取白銀（Ag）庫存數據\n\n**PDF 解析範例**：\n```python\nimport pdfplumber\n\ndef parse_sge_pdf(pdf_path):\n    \"\"\"解析 SGE 行情周報 PDF\"\"\"\n    with pdfplumber.open(pdf_path) as pdf:\n        # 通常在最後幾頁\n        for page in pdf.pages[-3:]:\n            text = page.extract_text()\n            if \"指定仓库库存周报\" in text:\n                tables = page.extract_tables()\n                for table in tables:\n                    # 尋找白銀（Ag）行\n                    for row in table:\n                        if row and \"Ag\" in str(row[0]):\n                            # 提取庫存數據\n                            stock_kg = float(row[1].replace(\",\", \"\"))\n                            return stock_kg\n    return None\n```\n\n### 2. SHFE（上海期貨交易所）\n\n**官方網站**：https://www.shfe.com.cn\n\n**數據位置**：倉單日報 / Weekly Inventory\n\n**數據內容**：\n| 欄位 | 說明 | 單位 |\n|------|------|------|\n| 日期 | 數據日期 | YYYY-MM-DD |\n| 白銀倉單 | 可交割倉單數量 | kg |\n\n**抓取方法**：\n1. 訪問 SHFE 官網「數據」→「倉單日報」\n2. 選擇品種「白銀」\n3. 等待 AJAX 載入完成\n4. 解析 HTML 表格\n\n**Selenium 抓取範例**：\n```python\nfrom selenium import webdriver\nfrom selenium.webdriver.common.by import By\nfrom selenium.webdriver.support.ui import WebDriverWait\nfrom selenium.webdriver.support import expected_conditions as EC\n\ndef fetch_shfe_inventory(driver, date):\n    \"\"\"抓取 SHFE 白銀倉單數據\"\"\"\n    url = f\"https://www.shfe.com.cn/data/dailydata/kx/kxXXXX.html\"\n    driver.get(url)\n\n    # 等待表格載入\n    wait = WebDriverWait(driver, 30)\n    wait.until(EC.presence_of_element_located(\n        (By.CSS_SELECTOR, \"table.data-table\")\n    ))\n\n    # 解析表格\n    table = driver.find_element(By.CSS_SELECTOR, \"table.data-table\")\n    rows = table.find_elements(By.TAG_NAME, \"tr\")\n\n    for row in rows:\n        cells = row.find_elements(By.TAG_NAME, \"td\")\n        if cells and \"白银\" in cells[0].text:\n            stock_kg = float(cells[2].text.replace(\",\", \"\"))\n            return stock_kg\n\n    return None\n```\n\n---\n\n## 反偵測策略\n\n### Chrome 配置\n\n```python\nfrom selenium import webdriver\nfrom selenium.webdriver.chrome.options import Options\n\ndef get_stealth_driver():\n    \"\"\"建立防偵測的 Chrome Driver\"\"\"\n    options = Options()\n\n    # 基本設定\n    options.add_argument('--headless=new')\n    options.add_argument('--no-sandbox')\n    options.add_argument('--disable-dev-shm-usage')\n    options.add_argument('--disable-gpu')\n    options.add_argument('--window-size=1920,1080')\n\n    # 防偵測設定\n    options.add_argument('--disable-blink-features=AutomationControlled')\n    options.add_experimental_option('excludeSwitches', ['enable-automation'])\n    options.add_experimental_option('useAutomationExtension', False)\n\n    # 隨機 User-Agent\n    user_agents = [\n        'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36...',\n        'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36...',\n        # ... 更多 UA\n    ]\n    import random\n    options.add_argument(f'user-agent={random.choice(user_agents)}')\n\n    return webdriver.Chrome(options=options)\n```\n\n### 隨機延遲\n\n```python\nimport asyncio\nimport random\n\nasync def random_delay(min_sec=1.0, max_sec=3.0):\n    \"\"\"隨機延遲，模擬人類行為\"\"\"\n    delay = random.uniform(min_sec, max_sec)\n    await asyncio.sleep(delay)\n```\n\n### 重試機制\n\n```python\nimport time\nfrom functools import wraps\n\ndef retry(max_attempts=3, delay=10):\n    \"\"\"重試裝飾器\"\"\"\n    def decorator(func):\n        @wraps(func)\n        def wrapper(*args, **kwargs):\n            for attempt in range(max_attempts):\n                try:\n                    return func(*args, **kwargs)\n                except Exception as e:\n                    if attempt < max_attempts - 1:\n                        print(f\"嘗試 {attempt + 1} 失敗，{delay}秒後重試...\")\n                        time.sleep(delay)\n                    else:\n                        raise\n        return wrapper\n    return decorator\n```\n\n---\n\n## 交叉驗證資料來源\n\n### Yahoo Finance（價格數據）\n\n```python\nimport yfinance as yf\n\n# 白銀期貨近月\nsilver_futures = yf.download(\"SI=F\", start=\"2020-01-01\")\n\n# 白銀現貨\nsilver_spot = yf.download(\"XAGUSD=X\", start=\"2020-01-01\")\n```\n\n### MacroMicro（ETF 持倉）\n\n參考 `monitor-etf-holdings-drawdown-risk` skill 的 Highcharts 抓取方法。\n\n**關鍵等待時間**：MacroMicro 圖表需要 35 秒以上才能完全渲染。\n\n### COMEX 庫存\n\n**來源**：CME Group 官網\n\n**數據**：\n- Registered（已登記）：可交割的庫存\n- Eligible（合格）：符合交割標準但未登記\n\n**注意**：COMEX 數據可能需要付費訂閱或有存取限制。\n\n---\n\n## 快取策略\n\n### 快取目錄結構\n\n```\ndata/\n├── sge_stock.csv           # SGE 庫存時間序列\n├── shfe_stock.csv          # SHFE 庫存時間序列\n├── combined_stock.csv      # 合併庫存\n├── cache_meta.json         # 快取元資料\n└── debug/                  # 除錯用原始檔案\n    ├── sge_report_20260116.pdf\n    └── shfe_page_20260116.html\n```\n\n### 快取元資料\n\n```json\n{\n  \"sge\": {\n    \"last_update\": \"2026-01-16T10:30:00Z\",\n    \"data_range\": [\"2020-01-01\", \"2026-01-16\"],\n    \"record_count\": 312\n  },\n  \"shfe\": {\n    \"last_update\": \"2026-01-16T10:35:00Z\",\n    \"data_range\": [\"2020-01-01\", \"2026-01-16\"],\n    \"record_count\": 1560\n  }\n}\n```\n\n### 快取有效期\n\n- **預設**：12 小時\n- **週末**：可延長至 48 小時（交易所不更新數據）\n\n```python\nfrom datetime import datetime, timedelta\n\ndef is_cache_valid(last_update, max_age_hours=12):\n    \"\"\"檢查快取是否有效\"\"\"\n    if last_update is None:\n        return False\n\n    cache_age = datetime.now() - last_update\n    return cache_age < timedelta(hours=max_age_hours)\n```\n\n---\n\n## 常見問題\n\n### Q: 中國網站存取受限怎麼辦？\n\nA: 建議方案：\n1. 使用 VPN 或代理\n2. 從中國境內伺服器執行\n3. 使用第三方數據提供商（如有）\n\n### Q: PDF 格式變更怎麼辦？\n\nA:\n1. 檢查 `data/debug/` 目錄的原始 PDF\n2. 分析新的表格結構\n3. 更新 `parse_sge_pdf()` 函數中的選擇器\n\n### Q: 被網站封鎖怎麼辦？\n\nA:\n1. 增加隨機延遲（3-5 秒）\n2. 降低抓取頻率（每天 1-2 次）\n3. 更換 User-Agent\n4. 考慮使用 undetected-chromedriver\n",
        "skills/detect-shanghai-silver-stock-drain/references/input-schema.md": "# 輸入參數定義\n\n本文件定義 `detect-shanghai-silver-stock-drain` skill 的完整輸入參數。\n\n---\n\n## 核心參數\n\n### start_date\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 格式 | YYYY-MM-DD |\n| 必填 | 否 |\n| 預設 | 3 年前 |\n\n分析起始日期。建議至少涵蓋 3 年以確保 Z 分數計算有足夠樣本。\n\n### end_date\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 格式 | YYYY-MM-DD |\n| 必填 | 否 |\n| 預設 | today |\n\n分析結束日期。\n\n### frequency\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 可選值 | `weekly`, `daily` |\n| 預設 | `weekly` |\n\n數據頻率。建議使用 `weekly` 與 SGE 周報對齊，減少噪音。\n\n### include_sources\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | array[string] |\n| 可選值 | `[\"SGE\"]`, `[\"SHFE\"]`, `[\"SGE\", \"SHFE\"]` |\n| 預設 | `[\"SGE\", \"SHFE\"]` |\n\n納入的庫存來源。建議使用兩者合併以獲得更完整的視角。\n\n### unit\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 可選值 | `tonnes`, `kg`, `troy_oz` |\n| 預設 | `tonnes` |\n\n輸出單位。\n\n轉換公式：\n- kg → tonnes: `/1000`\n- tonnes → troy_oz: `*32150.7466`\n\n---\n\n## 分析參數\n\n### smoothing_window_weeks\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | integer |\n| 範圍 | 1-12 |\n| 預設 | 4 |\n\n平滑視窗（週數）。用於減少單週數據噪音。\n\n**建議**：\n- 4 週（預設）：平衡敏感度與穩定性\n- 2 週：更敏感，可能有更多假訊號\n- 8 週：更穩定，可能延遲訊號\n\n### z_score_window_weeks\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | integer |\n| 範圍 | 52-260 |\n| 預設 | 156 |\n\nZ 分數計算的歷史視窗（週數）。\n\n**建議**：\n- 156 週（3 年，預設）：涵蓋多個市場週期\n- 104 週（2 年）：更敏感於近期變化\n- 260 週（5 年）：更穩定的基準\n\n### drain_threshold_z\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | float |\n| 範圍 | -3.0 至 -1.0 |\n| 預設 | -1.5 |\n\n判定「異常耗盡」的 Z 分數門檻。\n\n**解讀**：\n- -1.5（預設）：約有 6.7% 的觀測值會低於此門檻\n- -2.0：約有 2.3% 會低於此門檻（更嚴格）\n- -1.0：約有 15.9% 會低於此門檻（更寬鬆）\n\n### accel_threshold_z\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | float |\n| 範圍 | 0.5 至 2.0 |\n| 預設 | 1.0 |\n\n判定「耗盡加速」的 Z 分數門檻。\n\n**解讀**：\n- +1.0（預設）：約有 15.9% 的觀測值會高於此門檻\n- +1.5：約有 6.7% 會高於此門檻（更嚴格）\n- +0.5：約有 30.9% 會高於此門檻（更寬鬆）\n\n### level_percentile_threshold\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | float |\n| 範圍 | 0.05 至 0.50 |\n| 預設 | 0.20 |\n\n判定「庫存水位偏低」的歷史分位數門檻。\n\n**解讀**：\n- 0.20（預設）：庫存低於歷史 20% 分位\n- 0.10：更嚴格，僅最低 10%\n- 0.30：更寬鬆，最低 30%\n\n---\n\n## 交叉驗證參數\n\n### confirm_with_markets\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | boolean |\n| 預設 | true |\n\n是否使用市場側資料做交叉驗證。\n\n### cross_validation_indicators\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | array[string] |\n| 可選值 | `[\"comex\", \"slv\", \"futures_structure\", \"spot_premium\"]` |\n| 預設 | `[\"comex\", \"slv\", \"futures_structure\"]` |\n\n啟用的交叉驗證指標。\n\n| 指標 | 說明 | 數據來源 |\n|------|------|----------|\n| comex | COMEX 庫存變化 | CME Group |\n| slv | SLV ETF 持倉變化 | MacroMicro |\n| futures_structure | 期貨結構 | Yahoo Finance |\n| spot_premium | 現貨溢價 | 第三方 |\n\n---\n\n## 輸出參數\n\n### output_format\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 可選值 | `json`, `markdown`, `both` |\n| 預設 | `json` |\n\n輸出格式。\n\n### output_path\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 預設 | `result.json` |\n\n輸出檔案路徑。\n\n### include_narrative\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | boolean |\n| 預設 | true |\n\n是否包含中文敘事解讀。\n\n### include_caveats\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | boolean |\n| 預設 | true |\n\n是否包含數據口徑與限制說明。\n\n---\n\n## 完整範例\n\n### 最小配置（使用預設值）\n\n```bash\npython scripts/drain_detector.py --quick\n```\n\n### 完整配置\n\n```bash\npython scripts/drain_detector.py \\\n  --start 2020-01-01 \\\n  --end 2026-01-16 \\\n  --frequency weekly \\\n  --sources SGE SHFE \\\n  --unit tonnes \\\n  --smoothing-window 4 \\\n  --z-window 156 \\\n  --drain-threshold -1.5 \\\n  --accel-threshold 1.0 \\\n  --level-threshold 0.20 \\\n  --cross-validate \\\n  --output-format both \\\n  --output result.json\n```\n\n### Python API 呼叫\n\n```python\nfrom drain_detector import DrainDetector\n\ndetector = DrainDetector(\n    start_date=\"2020-01-01\",\n    end_date=\"2026-01-16\",\n    frequency=\"weekly\",\n    include_sources=[\"SGE\", \"SHFE\"],\n    unit=\"tonnes\",\n    smoothing_window_weeks=4,\n    z_score_window_weeks=156,\n    drain_threshold_z=-1.5,\n    accel_threshold_z=1.0,\n    level_percentile_threshold=0.20,\n    confirm_with_markets=True\n)\n\nresult = detector.analyze()\nprint(result.signal)\nprint(result.narrative)\n```\n",
        "skills/detect-shanghai-silver-stock-drain/references/methodology.md": "# 方法論：上海白銀庫存耗盡訊號偵測\n\n本文件說明「三維度量化」方法論，將社群推文中的敘事（「上海白銀庫存暴跌」）轉化為可執行、可驗證的量化訊號。\n\n---\n\n## 核心概念\n\n### 為什麼需要量化？\n\n社群經常出現類似推文：\n> 「上海白銀庫存又創新低了！供給緊縮訊號！」\n\n這類敘事存在問題：\n1. **模糊**：「新低」相對於什麼時間範圍？\n2. **單一維度**：只看水位，沒看變化速度\n3. **無法驗證**：缺乏可重現的判斷標準\n\n本方法論將敘事轉為三維度量化框架：**方向 × 速度 × 加速度**\n\n---\n\n## 三維度量化框架\n\n### 維度定義\n\n| 維度 | 符號 | 計算方式 | 意義 |\n|------|------|----------|------|\n| 方向 | Δ1(t) | `combined(t) - combined(t-1)` | 庫存是上升還是下降 |\n| 速度 | drain_rate(t) | `-Δ1(t)` | 每週流出量（正值=流出） |\n| 加速度 | Δ2(t) | `drain_rate(t) - drain_rate(t-1)` | 流出速度的變化 |\n\n### 直觀理解\n\n想像庫存是一個水庫：\n- **方向**：水位在上升還是下降？\n- **速度**：水流出的速度有多快？\n- **加速度**：水流出的速度是在加快還是減慢？\n\n**關鍵洞察**：\n- 水位下降（Δ1 < 0）很常見\n- 水位下降且速度很快（drain_rate 高）值得注意\n- 水位下降、速度快、且還在加速（Δ2 > 0）→ 這才是真正的「晚期供給訊號」\n\n---\n\n## Z 分數標準化\n\n### 為什麼需要標準化？\n\n原始數值難以跨時期比較：\n- 2020 年流出 100 噸/週 vs 2025 年流出 100 噸/週\n- 基數不同，意義不同\n\nZ 分數解決這個問題：\n```\nz = (x - mean) / std\n```\n\n- Z = 0：與歷史平均相同\n- Z = -2：比歷史平均低 2 個標準差（異常流出）\n- Z = +2：比歷史平均高 2 個標準差（異常流入）\n\n### 計算視窗\n\n建議使用 156 週（約 3 年）滾動視窗：\n\n```python\nz_window = 156  # 3 年\n\ndf[\"z_drain_rate\"] = (\n    (df[\"drain_rate_sm\"] - df[\"drain_rate_sm\"].rolling(z_window).mean()) /\n    df[\"drain_rate_sm\"].rolling(z_window).std()\n)\n\ndf[\"z_accel\"] = (\n    (df[\"accel_sm\"] - df[\"accel_sm\"].rolling(z_window).mean()) /\n    df[\"accel_sm\"].rolling(z_window).std()\n)\n```\n\n### 平滑處理\n\n單週數據可能有噪音（搬倉、規則變動），建議使用 4 週平滑：\n\n```python\nsmooth_window = 4\n\ndf[\"drain_rate_sm\"] = df[\"drain_rate\"].rolling(smooth_window, min_periods=1).mean()\ndf[\"accel_sm\"] = df[\"accel\"].rolling(smooth_window, min_periods=1).mean()\n```\n\n---\n\n## 三段式訊號判定\n\n### 條件定義\n\n| 條件 | 代號 | 判斷標準 | 說明 |\n|------|------|----------|------|\n| 庫存水位偏低 | A | level_percentile ≤ 0.20 | 低於歷史 20% 分位 |\n| 耗盡速度異常 | B | z_drain_rate ≤ -1.5 | 流出顯著高於常態 |\n| 耗盡加速 | C | z_accel ≥ +1.0 | 流出正在加速 |\n\n### 訊號分級\n\n```python\ndef classify_signal(A, B, C):\n    if A and B and C:\n        return \"HIGH_LATE_STAGE_SUPPLY_SIGNAL\"\n    if (B and C) or (A and B):\n        return \"MEDIUM_SUPPLY_TIGHTENING\"\n    if A or B or C:\n        return \"WATCH\"\n    return \"NO_SIGNAL\"\n```\n\n### 訊號含義\n\n| 訊號 | 條件組合 | 解讀 | 建議動作 |\n|------|----------|------|----------|\n| HIGH | A+B+C | 晚期供給訊號，所有條件成立 | 高度警戒，立即交叉驗證 |\n| MEDIUM | B+C 或 A+B | 供給趨緊，多數條件成立 | 持續關注，準備行動 |\n| WATCH | 任一成立 | 單一異常，可能是噪音 | 保持觀察 |\n| NO_SIGNAL | 無 | 正常狀態 | 無需動作 |\n\n---\n\n## 數據口徑說明\n\n### SGE vs SHFE\n\n| 交易所 | 全稱 | 庫存口徑 | 數據頻率 |\n|--------|------|----------|----------|\n| SGE | 上海黃金交易所 | 指定倉庫庫存 | 週報 |\n| SHFE | 上海期貨交易所 | 倉單（可交割） | 日報/週報 |\n\n### 重要限制\n\n**這不是全中國社會庫存！**\n\n交易所庫存只反映：\n- 可交割的白銀\n- 存放在交易所指定/認可倉庫\n- 登記為倉單的部分\n\n不包括：\n- 工業用戶庫存\n- 貿易商庫存\n- 零售/投資者實物持有\n\n**解讀時需謹慎**：交易所庫存下降可能是：\n1. 實物被提走（緊縮訊號）\n2. 搬倉到其他倉庫（中性）\n3. 倉儲規則調整（技術性）\n4. 數據統計口徑變化（誤導）\n\n---\n\n## 交叉驗證邏輯\n\n### 驗證指標\n\n| 指標 | 支持緊縮假設 | 反駁緊縮假設 |\n|------|--------------|--------------|\n| COMEX Registered | 同步下降 | 穩定或上升 |\n| SLV ETF 持倉 | 同步下降 | 穩定或上升 |\n| 期貨結構 | Backwardation | Contango |\n| 現貨溢價 | 擴大 | 穩定或收窄 |\n| 價格波動 | 上升 | 穩定 |\n\n### 信心度計算\n\n```python\nconfidence = support_count / total_checks\n\n# 信心度解讀\nif confidence >= 0.7:\n    interpretation = \"高度確認\"\nelif confidence >= 0.5:\n    interpretation = \"部分確認\"\nelse:\n    interpretation = \"未確認\"\n```\n\n---\n\n## 實例解讀\n\n### 情境 1：HIGH 訊號\n\n```\nlevel_percentile = 0.12  # A ✓ (< 0.20)\nz_drain_rate = -2.1      # B ✓ (≤ -1.5)\nz_accel = +1.4           # C ✓ (≥ +1.0)\n→ HIGH_LATE_STAGE_SUPPLY_SIGNAL\n```\n\n**解讀**：\n> 上海合併庫存處於歷史低檔（12% 分位），近期流出速度異常（Z=-2.1），且流出仍在加速（Z=+1.4）。三項條件同時成立，為晚期供給緊縮訊號。\n\n### 情境 2：WATCH 訊號\n\n```\nlevel_percentile = 0.35  # A ✗\nz_drain_rate = -1.8      # B ✓\nz_accel = +0.3           # C ✗\n→ WATCH\n```\n\n**解讀**：\n> 流出速度偏高（Z=-1.8），但庫存水位仍在中間區間（35% 分位），且流出並未加速。僅單一條件成立，建議持續觀察。\n\n---\n\n## 參考文獻\n\n- 原始推文敘事分析\n- CME Group COMEX 庫存報表\n- 上海黃金交易所官網\n- 上海期貨交易所官網\n",
        "skills/detect-shanghai-silver-stock-drain/templates/output-json.md": "# JSON 輸出模板\n\n本文件定義 `detect-shanghai-silver-stock-drain` skill 的 JSON 輸出結構。\n\n---\n\n## 完整輸出結構\n\n```json\n{\n  \"skill\": \"detect_shanghai_silver_stock_drain\",\n  \"as_of\": \"2026-01-16\",\n  \"unit\": \"tonnes\",\n  \"sources\": [\"SGE\", \"SHFE\"],\n  \"parameters\": {\n    \"start_date\": \"2023-01-01\",\n    \"end_date\": \"2026-01-16\",\n    \"frequency\": \"weekly\",\n    \"smoothing_window_weeks\": 4,\n    \"z_score_window_weeks\": 156,\n    \"drain_threshold_z\": -1.5,\n    \"accel_threshold_z\": 1.0,\n    \"level_percentile_threshold\": 0.20\n  },\n  \"result\": {\n    \"latest_combined_stock\": 1133.3,\n    \"level_percentile\": 0.12,\n    \"delta1_weekly\": -58.4,\n    \"drain_rate_4w_avg\": 58.4,\n    \"acceleration_4w_avg\": 9.7,\n    \"z_scores\": {\n      \"z_drain_rate\": -2.1,\n      \"z_acceleration\": 1.4\n    },\n    \"signal_conditions\": {\n      \"A_level_low\": true,\n      \"B_drain_abnormal\": true,\n      \"C_acceleration\": true\n    },\n    \"signal\": \"HIGH_LATE_STAGE_SUPPLY_SIGNAL\"\n  },\n  \"historical_context\": {\n    \"decade_high_stock\": 3500.2,\n    \"decade_low_stock\": 980.5,\n    \"current_percentile\": 0.12,\n    \"is_decade_low\": false,\n    \"distance_to_decade_low_pct\": 0.156\n  },\n  \"cross_validation\": {\n    \"enabled\": true,\n    \"confidence\": 0.67,\n    \"checks\": [\n      {\n        \"indicator\": \"COMEX Registered\",\n        \"status\": \"SUPPORT\",\n        \"value\": -0.082,\n        \"detail\": \"同期下降 8.2%\"\n      },\n      {\n        \"indicator\": \"SLV Holdings\",\n        \"status\": \"NEUTRAL\",\n        \"value\": 0.003,\n        \"detail\": \"持平 (+0.3%)\"\n      },\n      {\n        \"indicator\": \"Futures Structure\",\n        \"status\": \"SUPPORT\",\n        \"value\": \"backwardation\",\n        \"detail\": \"Mild Backwardation\"\n      }\n    ],\n    \"validated_signal\": \"HIGH_LATE_STAGE_SUPPLY_SIGNAL\"\n  },\n  \"narrative\": [\n    \"上海合併庫存處於歷史低分位（約 12% 分位）。\",\n    \"近 4 週平均庫存流出顯著高於常態（耗盡速度 Z=-2.1）。\",\n    \"流出在加速（加速度 Z=+1.4），符合「方向 + 速度」核心判準。\",\n    \"若同時觀察到其他市場庫存/溢價惡化，可進一步提高信心。\"\n  ],\n  \"caveats\": [\n    \"這是「交易所可交割/倉單/指定倉庫」口徑，不等於全中國社會庫存。\",\n    \"單週跳動可能反映倉儲/交割規則變動或搬倉，需用平滑與多來源交叉確認。\"\n  ],\n  \"metadata\": {\n    \"generated_at\": \"2026-01-16T10:30:00Z\",\n    \"skill_version\": \"0.1.0\",\n    \"data_freshness\": {\n      \"sge_last_update\": \"2026-01-15\",\n      \"shfe_last_update\": \"2026-01-16\"\n    }\n  }\n}\n```\n\n---\n\n## 欄位說明\n\n### 頂層欄位\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| skill | string | 技能名稱 |\n| as_of | string | 分析截止日期 |\n| unit | string | 輸出單位 |\n| sources | array | 使用的庫存來源 |\n| parameters | object | 分析參數 |\n| result | object | 分析結果 |\n| historical_context | object | 歷史脈絡 |\n| cross_validation | object | 交叉驗證結果 |\n| narrative | array | 中文敘事解讀 |\n| caveats | array | 數據口徑說明 |\n| metadata | object | 元資料 |\n\n### result 欄位\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| latest_combined_stock | float | 最新合併庫存（單位同 unit） |\n| level_percentile | float | 庫存水位歷史分位數 (0-1) |\n| delta1_weekly | float | 最新週變化量 |\n| drain_rate_4w_avg | float | 近 4 週平均流出速度 |\n| acceleration_4w_avg | float | 近 4 週平均加速度 |\n| z_scores | object | Z 分數 |\n| signal_conditions | object | 三段式條件判定 |\n| signal | string | 訊號分級 |\n\n### z_scores 欄位\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| z_drain_rate | float | 耗盡速度 Z 分數 |\n| z_acceleration | float | 加速度 Z 分數 |\n\n### signal_conditions 欄位\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| A_level_low | boolean | 條件 A：庫存水位偏低 |\n| B_drain_abnormal | boolean | 條件 B：耗盡速度異常 |\n| C_acceleration | boolean | 條件 C：耗盡加速 |\n\n### signal 可能值\n\n| 值 | 說明 |\n|-----|------|\n| HIGH_LATE_STAGE_SUPPLY_SIGNAL | A+B+C 同時成立 |\n| MEDIUM_SUPPLY_TIGHTENING | (B+C) 或 (A+B) 成立 |\n| WATCH | 任一條件成立 |\n| NO_SIGNAL | 無異常 |\n\n### cross_validation 欄位\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| enabled | boolean | 是否啟用交叉驗證 |\n| confidence | float | 綜合信心度 (0-1) |\n| checks | array | 各指標驗證結果 |\n| validated_signal | string | 驗證後訊號 |\n\n### checks 陣列元素\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| indicator | string | 指標名稱 |\n| status | string | SUPPORT / NEUTRAL / AGAINST |\n| value | any | 指標數值 |\n| detail | string | 詳細說明 |\n\n---\n\n## 精簡輸出（--quick 模式）\n\n```json\n{\n  \"skill\": \"detect_shanghai_silver_stock_drain\",\n  \"as_of\": \"2026-01-16\",\n  \"signal\": \"HIGH_LATE_STAGE_SUPPLY_SIGNAL\",\n  \"latest_combined_stock_tonnes\": 1133.3,\n  \"level_percentile\": 0.12,\n  \"z_drain_rate\": -2.1,\n  \"z_acceleration\": 1.4\n}\n```\n\n---\n\n## 程式碼範例\n\n### Python 讀取\n\n```python\nimport json\n\nwith open(\"result.json\", \"r\", encoding=\"utf-8\") as f:\n    result = json.load(f)\n\n# 檢查訊號\nif result[\"result\"][\"signal\"] == \"HIGH_LATE_STAGE_SUPPLY_SIGNAL\":\n    print(\"⚠️ 高度警戒：晚期供給訊號！\")\n\n# 讀取 Z 分數\nz_drain = result[\"result\"][\"z_scores\"][\"z_drain_rate\"]\nprint(f\"耗盡速度 Z 分數：{z_drain}\")\n\n# 讀取敘事\nfor line in result[\"narrative\"]:\n    print(f\"• {line}\")\n```\n\n### jq 查詢\n\n```bash\n# 取得訊號\njq '.result.signal' result.json\n\n# 取得 Z 分數\njq '.result.z_scores' result.json\n\n# 取得敘事\njq '.narrative[]' result.json\n```\n",
        "skills/detect-shanghai-silver-stock-drain/templates/output-markdown.md": "# Markdown 報告模板\n\n本文件定義 `detect-shanghai-silver-stock-drain` skill 的 Markdown 報告輸出格式。\n\n---\n\n## 完整報告模板\n\n```markdown\n# 上海白銀庫存耗盡分析報告\n\n**截至日期**：{as_of}\n**數據來源**：{sources}\n**分析單位**：{unit}\n\n---\n\n## 核心結論\n\n| 指標 | 數值 | 判定 |\n|------|------|------|\n| **訊號等級** | {signal} | {signal_emoji} {signal_description} |\n| **合併庫存** | {latest_combined_stock} {unit} | {level_description} |\n| **庫存分位數** | {level_percentile_pct}% | {level_assessment} |\n\n---\n\n## 三維度量化結果\n\n### 方向、速度、加速度\n\n| 維度 | 數值 | Z 分數 | 解讀 |\n|------|------|--------|------|\n| **方向 (Δ1)** | {delta1_weekly} | - | {direction_description} |\n| **速度** | {drain_rate_4w_avg} | {z_drain_rate} | {speed_description} |\n| **加速度** | {acceleration_4w_avg} | {z_acceleration} | {accel_description} |\n\n### 訊號判定邏輯\n\n{condition_A_check} A. 庫存水位偏低（{level_percentile_pct}% {condition_A_operator} 20% 門檻）\n{condition_B_check} B. 耗盡速度異常（z_drain = {z_drain_rate} {condition_B_operator} -1.5）\n{condition_C_check} C. 耗盡加速（z_accel = {z_acceleration} {condition_C_operator} +1.0）\n\n→ {signal_logic} → **{signal}**\n\n---\n\n## 歷史脈絡\n\n| 指標 | 數值 |\n|------|------|\n| 歷史最高庫存 | {decade_high_stock} {unit} |\n| 歷史最低庫存 | {decade_low_stock} {unit} |\n| 當前分位數 | {level_percentile_pct}% |\n| 距離歷史低點 | {distance_to_decade_low_pct}% |\n\n---\n\n## 交叉驗證（如啟用）\n\n**綜合信心度**：{confidence_pct}%\n\n| 指標 | 狀態 | 詳情 |\n|------|------|------|\n{cross_validation_rows}\n\n**驗證後訊號**：{validated_signal}\n\n---\n\n## 敘事解讀\n\n{narrative_list}\n\n---\n\n## 數據口徑說明\n\n{caveats_list}\n\n---\n\n## 下一步建議\n\n{next_steps_list}\n\n---\n\n*報告生成時間：{generated_at}*\n*技能版本：{skill_version}*\n```\n\n---\n\n## 變數說明\n\n### 訊號相關\n\n| 變數 | 說明 | 範例值 |\n|------|------|--------|\n| {signal} | 訊號等級 | HIGH_LATE_STAGE_SUPPLY_SIGNAL |\n| {signal_emoji} | 訊號表情符號 | 🔴 / 🟡 / 🟢 |\n| {signal_description} | 訊號描述 | 晚期供給訊號 |\n\n### 數據相關\n\n| 變數 | 說明 | 範例值 |\n|------|------|--------|\n| {latest_combined_stock} | 最新合併庫存 | 1133.3 |\n| {level_percentile_pct} | 分位數百分比 | 12 |\n| {z_drain_rate} | 耗盡速度 Z 分數 | -2.1 |\n| {z_acceleration} | 加速度 Z 分數 | +1.4 |\n\n### 條件判定\n\n| 變數 | 說明 | 範例值 |\n|------|------|--------|\n| {condition_A_check} | 條件 A 狀態 | ✅ / ❌ |\n| {condition_B_check} | 條件 B 狀態 | ✅ / ❌ |\n| {condition_C_check} | 條件 C 狀態 | ✅ / ❌ |\n\n---\n\n## 範例輸出\n\n### HIGH 訊號報告\n\n```markdown\n# 上海白銀庫存耗盡分析報告\n\n**截至日期**：2026-01-16\n**數據來源**：SGE, SHFE\n**分析單位**：tonnes\n\n---\n\n## 核心結論\n\n| 指標 | 數值 | 判定 |\n|------|------|------|\n| **訊號等級** | HIGH_LATE_STAGE_SUPPLY_SIGNAL | 🔴 晚期供給訊號 |\n| **合併庫存** | 1,133.3 噸 | 歷史低檔 |\n| **庫存分位數** | 12% | 低於 20% 門檻 |\n\n---\n\n## 三維度量化結果\n\n### 方向、速度、加速度\n\n| 維度 | 數值 | Z 分數 | 解讀 |\n|------|------|--------|------|\n| **方向 (Δ1)** | -58.4 | - | 庫存下降中 |\n| **速度** | 58.4 噸/週 | -2.1 | ⚠️ 流出顯著高於常態 |\n| **加速度** | +9.7 | +1.4 | ⚠️ 流出正在加速 |\n\n### 訊號判定邏輯\n\n✅ A. 庫存水位偏低（12% < 20% 門檻）\n✅ B. 耗盡速度異常（z_drain = -2.1 ≤ -1.5）\n✅ C. 耗盡加速（z_accel = +1.4 ≥ +1.0）\n\n→ A+B+C 同時成立 → **HIGH_LATE_STAGE_SUPPLY_SIGNAL**\n\n---\n\n## 敘事解讀\n\n1. 上海合併庫存處於歷史低分位（約 12% 分位）。\n2. 近 4 週平均庫存流出顯著高於常態（耗盡速度 Z=-2.1）。\n3. 流出在加速（加速度 Z=+1.4），符合「方向 + 速度」核心判準。\n4. 若同時觀察到其他市場庫存/溢價惡化，可進一步提高信心。\n\n---\n\n## 數據口徑說明\n\n⚠️ 這是「交易所可交割/倉單/指定倉庫」口徑，不等於全中國社會庫存。\n⚠️ 單週跳動可能反映倉儲/交割規則變動或搬倉，需用平滑與多來源交叉確認。\n\n---\n\n*報告生成時間：2026-01-16T10:30:00Z*\n*技能版本：0.1.0*\n```\n\n---\n\n## 程式碼範例\n\n### Python 生成報告\n\n```python\nfrom string import Template\n\ndef generate_markdown_report(result):\n    \"\"\"從分析結果生成 Markdown 報告\"\"\"\n    template = Template(open(\"templates/output-markdown.md\").read())\n\n    # 計算派生變數\n    signal_emoji = {\n        \"HIGH_LATE_STAGE_SUPPLY_SIGNAL\": \"🔴\",\n        \"MEDIUM_SUPPLY_TIGHTENING\": \"🟡\",\n        \"WATCH\": \"🟠\",\n        \"NO_SIGNAL\": \"🟢\"\n    }.get(result[\"result\"][\"signal\"], \"⚪\")\n\n    # 填入變數\n    report = template.substitute(\n        as_of=result[\"as_of\"],\n        sources=\", \".join(result[\"sources\"]),\n        unit=result[\"unit\"],\n        signal=result[\"result\"][\"signal\"],\n        signal_emoji=signal_emoji,\n        latest_combined_stock=f\"{result['result']['latest_combined_stock']:,.1f}\",\n        level_percentile_pct=f\"{result['result']['level_percentile']*100:.0f}\",\n        z_drain_rate=f\"{result['result']['z_scores']['z_drain_rate']:.1f}\",\n        z_acceleration=f\"+{result['result']['z_scores']['z_acceleration']:.1f}\",\n        # ... 更多變數\n    )\n\n    return report\n```\n",
        "skills/detect-shanghai-silver-stock-drain/workflows/analyze.md": "# Workflow: 完整庫存分析\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/methodology.md - 三維度量化方法論\n2. references/data-sources.md - SGE/SHFE 資料來源\n3. references/input-schema.md - 完整輸入參數定義\n</required_reading>\n\n<process>\n\n## Step 1: 確認分析參數\n\n確認用戶提供的參數，或使用預設值：\n\n| 參數 | 預設值 | 說明 |\n|------|--------|------|\n| start_date | 3 年前 | 分析起始日 |\n| end_date | 今天 | 分析結束日 |\n| frequency | weekly | 數據頻率 |\n| include_sources | [\"SGE\", \"SHFE\"] | 庫存來源 |\n| unit | tonnes | 輸出單位 |\n| smoothing_window_weeks | 4 | 平滑視窗 |\n| drain_threshold_z | -1.5 | 耗盡速度 Z 門檻 |\n| accel_threshold_z | +1.0 | 加速度 Z 門檻 |\n\n## Step 2: 數據採集\n\n執行數據抓取腳本：\n\n```bash\ncd skills/detect-shanghai-silver-stock-drain\n\n# 抓取 SGE 庫存（PDF 解析）\npython scripts/fetch_sge_stock.py \\\n  --start {start_date} \\\n  --end {end_date} \\\n  --output data/sge_stock.csv\n\n# 抓取 SHFE 庫存\npython scripts/fetch_shfe_stock.py \\\n  --start {start_date} \\\n  --end {end_date} \\\n  --output data/shfe_stock.csv\n```\n\n如果數據已存在且在快取有效期內（12 小時），可跳過此步驟。\n\n## Step 3: 數據處理與合併\n\n執行主分析腳本的數據處理階段：\n\n```python\n# drain_detector.py 內部邏輯\ndef build_combined_stock(df_sge, df_shfe, unit=\"tonnes\"):\n    \"\"\"合併 SGE + SHFE 庫存\"\"\"\n    df = merge_weekly(df_sge, df_shfe)  # 按週對齊\n    df[\"combined_kg\"] = df[\"sge_kg\"].fillna(0) + df[\"shfe_kg\"].fillna(0)\n\n    if unit == \"tonnes\":\n        df[\"combined\"] = df[\"combined_kg\"] / 1000.0\n    elif unit == \"troy_oz\":\n        df[\"combined\"] = (df[\"combined_kg\"] / 1000.0) * 32150.7466\n\n    return df.sort_values(\"date\")\n```\n\n## Step 4: 三維度量化計算\n\n計算方向、速度、加速度：\n\n```python\ndef compute_drain_metrics(df, smooth=4, z_window=156):\n    \"\"\"計算耗盡三維度指標\"\"\"\n    # 方向（每週變化）\n    df[\"delta1\"] = df[\"combined\"].diff(1)\n\n    # 速度（流出量，正值 = 流出）\n    df[\"drain_rate\"] = -df[\"delta1\"]\n\n    # 加速度（速度變化）\n    df[\"accel\"] = df[\"drain_rate\"].diff(1)\n\n    # 平滑處理\n    for c in [\"combined\", \"drain_rate\", \"accel\"]:\n        df[f\"{c}_sm\"] = df[c].rolling(smooth, min_periods=1).mean()\n\n    # Z 分數標準化\n    for c in [\"drain_rate_sm\", \"accel_sm\"]:\n        m = df[c].rolling(z_window, min_periods=20).mean()\n        s = df[c].rolling(z_window, min_periods=20).std()\n        df[f\"z_{c}\"] = (df[c] - m) / s\n\n    # 水位百分位\n    df[\"level_pct_rank\"] = df[\"combined_sm\"].rolling(z_window, min_periods=20)\\\n        .apply(lambda x: x.rank(pct=True).iloc[-1], raw=False)\n\n    return df\n```\n\n## Step 5: 訊號分級判定\n\n執行三段式訊號判定：\n\n```python\ndef classify_signal(df, drain_z=-1.5, accel_z=1.0, level_pctl=0.2):\n    \"\"\"判定供給訊號等級\"\"\"\n    latest = df.iloc[-1]\n\n    A = latest[\"level_pct_rank\"] <= level_pctl      # 庫存水位偏低\n    B = latest[\"z_drain_rate_sm\"] <= drain_z        # 耗盡速度異常\n    C = latest[\"z_accel_sm\"] >= accel_z             # 耗盡加速\n\n    if A and B and C:\n        return \"HIGH_LATE_STAGE_SUPPLY_SIGNAL\"\n    if (B and C) or (A and B):\n        return \"MEDIUM_SUPPLY_TIGHTENING\"\n    if B or A or C:\n        return \"WATCH\"\n    return \"NO_SIGNAL\"\n```\n\n## Step 6: 生成敘事解讀\n\n根據分析結果生成中文敘事：\n\n```python\ndef generate_narrative(result):\n    \"\"\"生成敘事解讀\"\"\"\n    narrative = []\n\n    # 水位描述\n    pct = result[\"level_percentile\"]\n    narrative.append(f\"上海合併庫存處於歷史低分位（約 {pct*100:.0f}% 分位）。\")\n\n    # 速度描述\n    z_drain = result[\"z_scores\"][\"z_drain_rate\"]\n    if z_drain <= -1.5:\n        narrative.append(f\"近 4 週平均庫存流出顯著高於常態（耗盡速度 Z={z_drain:.1f}）。\")\n\n    # 加速度描述\n    z_accel = result[\"z_scores\"][\"z_acceleration\"]\n    if z_accel >= 1.0:\n        narrative.append(f\"流出在加速（加速度 Z=+{z_accel:.1f}），符合「方向 + 速度」核心判準。\")\n\n    # 建議\n    narrative.append(\"若同時觀察到其他市場庫存/溢價惡化，可進一步提高信心。\")\n\n    return narrative\n```\n\n## Step 7: 輸出結果\n\n執行完整分析並輸出：\n\n```bash\npython scripts/drain_detector.py \\\n  --start {start_date} \\\n  --end {end_date} \\\n  --sources SGE SHFE \\\n  --unit tonnes \\\n  --output result.json\n```\n\n結果將包含：\n- JSON 分析結果（符合 `templates/output-json.md` 格式）\n- 數據快取（供後續分析使用）\n\n## Step 8: 視覺化報告（選配）\n\n如需視覺化報告：\n\n```bash\npython scripts/visualize_drain.py \\\n  --result result.json \\\n  --output ../../../output/\n```\n\n輸出：\n- PNG 圖表：`output/shanghai_silver_drain_report_{date}.png`\n- PDF 報告：`output/shanghai_silver_drain_report_{date}.pdf`\n\n</process>\n\n<success_criteria>\n此工作流程完成時應產出：\n\n- [ ] SGE + SHFE 合併庫存時間序列\n- [ ] 三維度量化結果（方向、速度、加速度）\n- [ ] Z 分數標準化數值\n- [ ] 庫存水位歷史分位數\n- [ ] 訊號分級（HIGH/MEDIUM/WATCH/NO_SIGNAL）\n- [ ] 中文敘事解讀\n- [ ] JSON 格式結果檔案\n- [ ] （選配）視覺化報告\n</success_criteria>\n",
        "skills/detect-shanghai-silver-stock-drain/workflows/cross-validate.md": "# Workflow: 交叉驗證\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/methodology.md - 交叉驗證邏輯\n2. references/data-sources.md - 交叉驗證數據源\n</required_reading>\n\n<process>\n\n## Step 1: 確認交叉驗證指標\n\n交叉驗證使用以下指標確認上海庫存訊號的真實性：\n\n| 指標 | 來源 | 支持緊縮假設 | 反駁緊縮假設 |\n|------|------|--------------|--------------|\n| COMEX Registered | CME Group | 同步下降 | 穩定或上升 |\n| COMEX Eligible | CME Group | 同步下降 | 穩定或上升 |\n| ETF 持倉（SLV） | MacroMicro | 同步下降 | 穩定或上升 |\n| 期貨結構 | Yahoo Finance | Backwardation | Contango |\n| 白銀價格波動 | Yahoo Finance | 上升 | 穩定 |\n\n## Step 2: 抓取 COMEX 庫存數據\n\n```bash\ncd skills/detect-shanghai-silver-stock-drain\n\npython scripts/fetch_comex_inventory.py \\\n  --commodity silver \\\n  --output data/comex_silver.csv\n```\n\n**注意**：COMEX 數據可能需要從 CME Group 網站抓取，有存取限制。如無法取得，此指標可跳過。\n\n## Step 3: 抓取 ETF 持倉數據\n\n使用 MacroMicro 爬蟲（參考 `monitor-etf-holdings-drawdown-risk` skill）：\n\n```bash\n# 如果已有 ETF 持倉 skill，可直接引用\npython ../monitor-etf-holdings-drawdown-risk/scripts/fetch_etf_holdings.py \\\n  --etf SLV \\\n  --output data/slv_holdings.csv\n```\n\n## Step 4: 抓取價格與期貨數據\n\n```python\nimport yfinance as yf\n\n# 白銀期貨近月\nsi_near = yf.download(\"SI=F\", start=\"2020-01-01\", end=\"2026-01-16\")\n\n# 白銀期貨遠月（如有）\nsi_far = yf.download(\"SIK26.CMX\", start=\"2020-01-01\", end=\"2026-01-16\")\n\n# 計算期貨結構\n# Contango: 遠月 > 近月 (正常)\n# Backwardation: 近月 > 遠月 (緊縮訊號)\n```\n\n## Step 5: 綜合評估\n\n執行交叉驗證評估：\n\n```bash\npython scripts/drain_detector.py \\\n  --result result.json \\\n  --cross-validate \\\n  --output result_validated.json\n```\n\n**評估邏輯：**\n\n```python\ndef cross_validate(shanghai_signal, comex, etf, futures_structure):\n    \"\"\"交叉驗證上海庫存訊號\"\"\"\n    support_count = 0\n    total_checks = 0\n\n    # COMEX 庫存\n    if comex is not None:\n        total_checks += 1\n        if comex[\"registered_change\"] < -0.05:  # 下降 > 5%\n            support_count += 1\n\n    # ETF 持倉\n    if etf is not None:\n        total_checks += 1\n        if etf[\"slv_change\"] < -0.05:  # 下降 > 5%\n            support_count += 1\n\n    # 期貨結構\n    if futures_structure is not None:\n        total_checks += 1\n        if futures_structure == \"backwardation\":\n            support_count += 1\n\n    # 信心分數\n    if total_checks > 0:\n        confidence = support_count / total_checks\n    else:\n        confidence = 0.5  # 無法驗證，中性\n\n    return {\n        \"confidence\": confidence,\n        \"support_count\": support_count,\n        \"total_checks\": total_checks,\n        \"validated_signal\": shanghai_signal if confidence >= 0.5 else \"UNCONFIRMED\"\n    }\n```\n\n## Step 6: 輸出驗證報告\n\n驗證報告包含：\n\n```json\n{\n  \"original_signal\": \"HIGH_LATE_STAGE_SUPPLY_SIGNAL\",\n  \"cross_validation\": {\n    \"confidence\": 0.67,\n    \"checks\": [\n      {\n        \"indicator\": \"COMEX Registered\",\n        \"result\": \"SUPPORT\",\n        \"detail\": \"同期下降 8.2%\"\n      },\n      {\n        \"indicator\": \"SLV Holdings\",\n        \"result\": \"NEUTRAL\",\n        \"detail\": \"持平 (+0.3%)\"\n      },\n      {\n        \"indicator\": \"Futures Structure\",\n        \"result\": \"SUPPORT\",\n        \"detail\": \"Mild Backwardation\"\n      }\n    ]\n  },\n  \"validated_signal\": \"HIGH_LATE_STAGE_SUPPLY_SIGNAL\",\n  \"interpretation\": \"上海庫存耗盡訊號獲得 2/3 跨市場指標支持，信心度中高。\"\n}\n```\n\n## Step 7: 解讀與建議\n\n根據驗證結果提供解讀：\n\n| 信心度 | 解讀 | 建議 |\n|--------|------|------|\n| ≥ 0.7 | 高度確認 | 訊號可信，可作為決策依據 |\n| 0.5-0.7 | 部分確認 | 訊號可參考，需持續觀察 |\n| < 0.5 | 未確認 | 訊號可能為假訊號，謹慎解讀 |\n\n</process>\n\n<success_criteria>\n此工作流程完成時應產出：\n\n- [ ] COMEX 庫存變化評估（如可取得）\n- [ ] ETF 持倉變化評估（如可取得）\n- [ ] 期貨結構評估\n- [ ] 綜合信心分數\n- [ ] 驗證後訊號等級\n- [ ] 交叉驗證報告（JSON 格式）\n- [ ] 中文解讀與建議\n</success_criteria>\n",
        "skills/detect-shanghai-silver-stock-drain/workflows/fetch-data.md": "# Workflow: 數據抓取\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/data-sources.md - SGE/SHFE 資料來源與抓取方法\n</required_reading>\n\n<process>\n\n## Step 1: 環境準備\n\n確認依賴套件已安裝：\n\n```bash\npip install selenium webdriver-manager beautifulsoup4 pdfplumber pandas numpy\n```\n\n確認 Chrome 瀏覽器已安裝（Selenium 需要）。\n\n## Step 2: 抓取 SGE 庫存數據\n\nSGE（上海黃金交易所）庫存數據來自「行情周報」PDF：\n\n```bash\ncd skills/detect-shanghai-silver-stock-drain\n\npython scripts/fetch_sge_stock.py \\\n  --start 2020-01-01 \\\n  --end 2026-01-16 \\\n  --output data/sge_stock.csv\n```\n\n**抓取流程：**\n1. 訪問 SGE 官網行情周報頁面\n2. 下載週報 PDF 檔案\n3. 使用 pdfplumber 解析 PDF 表格\n4. 提取「指定倉庫庫存周報」中的白銀庫存數據\n5. 轉換為 CSV 格式儲存\n\n**反偵測策略：**\n- 隨機延遲 1-3 秒\n- 隨機 User-Agent\n- 模擬人類瀏覽器行為\n\n## Step 3: 抓取 SHFE 庫存數據\n\nSHFE（上海期貨交易所）庫存數據來自「倉單日報」或「Weekly Inventory」：\n\n```bash\npython scripts/fetch_shfe_stock.py \\\n  --start 2020-01-01 \\\n  --end 2026-01-16 \\\n  --output data/shfe_stock.csv\n```\n\n**抓取流程：**\n1. 訪問 SHFE 官網倉單查詢頁面\n2. 選擇白銀品種\n3. 等待頁面完全載入（使用 WebDriverWait）\n4. 解析 HTML 表格提取庫存數據\n5. 轉換為 CSV 格式儲存\n\n## Step 4: 數據驗證\n\n檢查抓取的數據是否完整：\n\n```python\nimport pandas as pd\n\n# 讀取數據\nsge = pd.read_csv(\"data/sge_stock.csv\", parse_dates=[\"date\"])\nshfe = pd.read_csv(\"data/shfe_stock.csv\", parse_dates=[\"date\"])\n\n# 檢查數據範圍\nprint(f\"SGE: {sge['date'].min()} ~ {sge['date'].max()}, {len(sge)} 筆\")\nprint(f\"SHFE: {shfe['date'].min()} ~ {shfe['date'].max()}, {len(shfe)} 筆\")\n\n# 檢查缺失值\nprint(f\"SGE 缺失: {sge['stock_kg'].isna().sum()}\")\nprint(f\"SHFE 缺失: {shfe['stock_kg'].isna().sum()}\")\n```\n\n## Step 5: 快取管理\n\n數據會快取在 `data/` 目錄：\n\n```\ndata/\n├── sge_stock.csv         # SGE 庫存時間序列\n├── shfe_stock.csv        # SHFE 庫存時間序列\n├── combined_stock.csv    # 合併庫存（自動生成）\n└── cache_meta.json       # 快取元資料\n```\n\n快取有效期預設為 12 小時。超過有效期後會自動重新抓取。\n\n強制更新快取：\n\n```bash\npython scripts/fetch_sge_stock.py --force-update\npython scripts/fetch_shfe_stock.py --force-update\n```\n\n## Step 6: 錯誤處理\n\n**常見錯誤與解決方案：**\n\n| 錯誤 | 原因 | 解決方案 |\n|------|------|----------|\n| `TimeoutException` | 頁面載入超時 | 增加等待時間或重試 |\n| `NoSuchElementException` | 選擇器失效 | 更新選擇器（網站改版） |\n| PDF 解析失敗 | PDF 格式變更 | 更新解析規則 |\n| 403 Forbidden | 被網站封鎖 | 增加延遲、降低頻率 |\n\n**Debug 模式：**\n\n```bash\npython scripts/fetch_sge_stock.py --debug\n```\n\nDebug 模式會：\n- 保存原始 HTML/PDF 到 `data/debug/`\n- 輸出詳細日誌\n- 不使用 headless 模式（可視化瀏覽器）\n\n</process>\n\n<success_criteria>\n此工作流程完成時應產出：\n\n- [ ] `data/sge_stock.csv` - SGE 庫存時間序列\n- [ ] `data/shfe_stock.csv` - SHFE 庫存時間序列\n- [ ] 數據欄位：date, stock_kg\n- [ ] 數據範圍覆蓋指定時間區間\n- [ ] 缺失值比例 < 5%\n- [ ] 快取元資料已更新\n</success_criteria>\n",
        "skills/detect-us-equity-valuation-percentile-extreme/SKILL.md": "---\nname: detect-us-equity-valuation-percentile-extreme\ndescription: 把多個股票估值指標統一轉成在過去百年歷史中的分位數，再合成一個總分，判斷目前是否處於歷史極端高估區間，並用歷史類比（如 1929、1965、1999）給出風險解讀。\n---\n\n<essential_principles>\n\n<principle name=\"percentile_normalization\">\n**分位數標準化核心**\n\n將不同單位的估值指標（PE、PB、CAPE 等）統一成「0-100 的歷史分位數」：\n- **分位數 = 100 × (歷史中 ≤ 當前值的樣本數 / 總樣本數)**\n- 例：CAPE 位於歷史第 98 分位 → 過去 130 年只有 2% 的時間比現在更貴\n- 統一單位後，可跨指標合成「綜合估值分位數」\n</principle>\n\n<principle name=\"composite_aggregation\">\n**多指標合成邏輯**\n\n合成公式：`composite_percentile = 加權平均(各指標分位數)`\n\n支援三種合成方式：\n| 方式 | 公式 | 適用場景 |\n|------|------|----------|\n| mean | 算術平均 | 各指標同等重要 |\n| median | 中位數 | 抵抗單一指標異常拉升 |\n| trimmed_mean | 去極端平均 | 穩健估計 |\n\n**重要**：各指標可能有不同歷史長度，預設使用「各自歷史」計算分位數再合成。\n</principle>\n\n<principle name=\"extreme_detection\">\n**極端高估偵測邏輯**\n\n```\nif composite_percentile >= extreme_threshold (預設 95):\n    → 判定「歷史極端高估」\n    → 觸發風險解讀流程\n```\n\n歷史類比事件識別：\n1. 找出合成分位數超過門檻的峰值\n2. 用 `episode_min_gap_days` 去重（預設 10 年內只保留最高點）\n3. 輸出：1929、1965、1999、2021、當前...\n</principle>\n\n<principle name=\"risk_interpretation\">\n**風險解讀框架**\n\n「估值極端高」≠「明天崩盤」，但歷史特徵是：\n- **風險分布不對稱**：下跌尾巴變厚\n- **未來中期報酬壓縮**：估值均值回歸壓低長期報酬上限\n- **波動先升後跌**：事件後 6-12 月波動率通常上升\n\n輸出事後統計：\n- 未來 180/365/1095 天報酬分布\n- 最大回撤中位數與尾部風險\n- 波動率變化機率\n</principle>\n\n<principle name=\"data_transparency\">\n**資料來源與限制揭露**\n\n本 skill 使用**公開替代資料**，非彭博原始數據：\n- **Shiller CAPE**: Robert Shiller 公開資料集（可回溯至 1871 年）\n- **市值/GDP**: FRED 公開數據（可回溯至 1950 年代）\n- **PE/PB/PS**: 公開金融資料（歷史較短，約 30-50 年）\n\n**必須揭露**：\n- 各指標可得期間不同\n- 合成分位數為「近似重建」，非精確複製\n</principle>\n\n</essential_principles>\n\n<objective>\n偵測美股估值是否處於歷史極端區間：\n\n1. **收集估值指標**：從公開數據源取得 PE、CAPE、PB、PS、市值/GDP 等\n2. **計算分位數**：將各指標轉換為歷史分位數（0-100）\n3. **合成總分**：加權平均（或中位數）得到綜合估值分位數\n4. **判定極端**：若總分 ≥ 門檻（預設 95），觸發極端高估警報\n5. **歷史類比**：找出歷史上的類似事件（1929、1965、1999 等）\n6. **事後統計**：計算這些事件後的報酬、回撤、波動變化\n\n輸出：當前狀態、各指標分位數、歷史類比事件、風險解讀。\n</objective>\n\n<quick_start>\n\n**最快的方式：執行視覺化分析**\n\n```bash\ncd skills/detect-us-equity-valuation-percentile-extreme\npip install pandas numpy yfinance requests matplotlib openpyxl xlrd  # 首次使用\npython scripts/visualize_valuation.py -o output\n```\n\n輸出：\n- `output/us_valuation_percentile_YYYY-MM-DD.png` - 歷史走勢圖（類似 @ekwufinance 風格）\n- `output/us_valuation_breakdown_YYYY-MM-DD.png` - 各指標分位數分解圖\n- `output/us_valuation_analysis_YYYY-MM-DD.json` - JSON 結果\n\n**圖表特色**：\n- 多指標合成分位數的**歷史走勢**（非單一時間點）\n- **歷史峰值標記**：1929、1965、1999、2021\n- S&P 500 指數疊加（對數刻度）\n- 當前「新高」標註\n\n**快速檢查（純 JSON）**：\n```bash\npython scripts/valuation_percentile.py --quick\n```\n\n**完整分析**：\n```bash\npython scripts/valuation_percentile.py \\\n  --as_of_date 2026-01-21 \\\n  --universe \"^GSPC\" \\\n  --metrics \"cape,mktcap_to_gdp,trailing_pe,pb\" \\\n  --output result.json\n```\n\n</quick_start>\n\n<intake>\n需要進行什麼操作？\n\n1. **視覺化分析（推薦）** - 生成歷史走勢圖表，標記歷史峰值\n2. **快速檢查** - 查看目前的估值分位數與極端狀態\n3. **完整分析** - 執行完整的歷史分位數分析與風險解讀\n4. **歷史類比** - 深入分析歷史極端高估事件與事後表現\n5. **方法論學習** - 了解估值分位數模型的邏輯\n6. **自訂參數** - 指定估值指標、門檻、合成方式等\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                         | Action                                       |\n|----------------------------------|----------------------------------------------|\n| 1, \"視覺化\", \"圖表\", \"chart\"     | 執行 `python scripts/visualize_valuation.py -o output` |\n| 2, \"快速\", \"quick\", \"check\"      | 執行 `python scripts/valuation_percentile.py --quick` |\n| 3, \"完整\", \"full\", \"analysis\"    | 閱讀 `workflows/execute-analysis.md` 並執行 |\n| 4, \"歷史\", \"類比\", \"episodes\"    | 閱讀 `workflows/historical-episodes.md` 並執行 |\n| 5, \"學習\", \"方法論\", \"why\"       | 閱讀 `references/methodology.md`             |\n| 6, \"自訂\", \"custom\", 提供參數    | 閱讀 `workflows/execute-analysis.md` 並使用參數執行 |\n\n**路由後，閱讀對應文件並執行。**\n</routing>\n\n<directory_structure>\n```\ndetect-us-equity-valuation-percentile-extreme/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元數據\n├── workflows/\n│   ├── execute-analysis.md            # 完整分析工作流\n│   ├── visualize-analysis.md          # 視覺化分析工作流\n│   └── historical-episodes.md         # 歷史類比分析工作流\n├── references/\n│   ├── methodology.md                 # 估值分位數方法論\n│   ├── data-sources.md                # 資料來源與代碼\n│   ├── valuation-metrics.md           # 估值指標定義\n│   └── input-schema.md                # 完整輸入參數定義\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n├── scripts/\n│   ├── valuation_percentile.py        # 主分析腳本\n│   ├── visualize_valuation.py         # 視覺化腳本（歷史走勢圖）\n│   └── fetch_valuation_data.py        # 資料抓取工具\n└── examples/\n    └── sample_output.json             # 範例輸出\n```\n</directory_structure>\n\n<reference_index>\n\n**方法論**: references/methodology.md\n- 分位數標準化原理\n- 多指標合成邏輯\n- 極端偵測與歷史類比\n\n**資料來源**: references/data-sources.md\n- Shiller CAPE 資料集\n- FRED 系列代碼\n- 公開替代資料說明\n\n**估值指標**: references/valuation-metrics.md\n- PE、Forward PE、CAPE 定義\n- PB、PS、EV/EBITDA 定義\n- Q Ratio、市值/GDP 定義\n\n**輸入參數**: references/input-schema.md\n- 完整參數定義\n- 預設值與建議範圍\n\n</reference_index>\n\n<workflows_index>\n| Workflow                | Purpose          | 使用時機               |\n|-------------------------|------------------|------------------------|\n| execute-analysis.md     | 完整估值分析     | 需要完整報告時         |\n| historical-episodes.md  | 歷史事件深度分析 | 理解歷史類比與事後統計 |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose              |\n|--------------------|----------------------|\n| output-json.md     | JSON 輸出結構定義    |\n| output-markdown.md | Markdown 報告模板    |\n</templates_index>\n\n<scripts_index>\n| Script                    | Command                           | Purpose              |\n|---------------------------|-----------------------------------|----------------------|\n| visualize_valuation.py    | `-o output`                       | **視覺化分析（推薦）** |\n| valuation_percentile.py   | `--quick`                         | 快速檢查當前狀態     |\n| valuation_percentile.py   | `--as_of_date DATE --output FILE` | 完整分析             |\n| fetch_valuation_data.py   | `--metrics cape,pe`               | 抓取估值資料         |\n</scripts_index>\n\n<input_schema_summary>\n\n**核心參數**\n\n| 參數           | 類型   | 預設值       | 說明             |\n|----------------|--------|--------------|------------------|\n| as_of_date     | string | today        | 評估日期         |\n| universe       | string | ^GSPC        | 市場代碼         |\n| history_start  | string | 1900-01-01   | 歷史起算日       |\n| metrics        | array  | [cape, ...]  | 估值指標清單     |\n| aggregation    | string | mean         | 合成方法         |\n\n**門檻參數**\n\n| 參數                  | 類型   | 預設值 | 說明                   |\n|-----------------------|--------|--------|------------------------|\n| extreme_threshold     | number | 95     | 極端高估門檻（分位數） |\n| episode_min_gap_days  | int    | 3650   | 歷史事件去重間隔       |\n| forward_windows_days  | array  | [180, 365, 1095] | 事後統計視窗     |\n\n完整參數定義見 `references/input-schema.md`。\n\n</input_schema_summary>\n\n<output_schema_summary>\n```json\n{\n  \"skill\": \"detect-us-equity-valuation-percentile-extreme\",\n  \"as_of_date\": \"2026-01-21\",\n  \"universe\": \"^GSPC\",\n  \"composite_percentile\": 97.3,\n  \"extreme_threshold\": 95,\n  \"is_extreme\": true,\n  \"metric_percentiles\": {\n    \"cape\": 98.2,\n    \"mktcap_to_gdp\": 96.5,\n    \"trailing_pe\": 94.1\n  },\n  \"historical_episodes\": [\n    {\"date\": \"1929-09-01\", \"composite_percentile\": 97.8},\n    {\"date\": \"1999-12-01\", \"composite_percentile\": 98.5}\n  ],\n  \"forward_stats\": {\n    \"365d_forward_return\": {\"median\": -8.2, \"p25\": -22.1, \"p10\": -38.5},\n    \"1095d_max_drawdown\": {\"median\": -28.4, \"p75\": -42.1}\n  },\n  \"data_quality_notes\": [\n    \"CAPE 資料可回溯至 1871 年\",\n    \"市值/GDP 資料可回溯至 1950 年代\",\n    \"合成分位數使用各指標自身歷史分布\"\n  ]\n}\n```\n\n完整輸出結構見 `templates/output-json.md`。\n</output_schema_summary>\n\n<success_criteria>\n執行成功時應產出：\n\n- [ ] 當前綜合估值分位數（0-100）\n- [ ] 各指標個別分位數\n- [ ] 極端高估判定（是/否）\n- [ ] 歷史類比事件清單（日期、分位數）\n- [ ] 事後統計（報酬、回撤、波動）\n- [ ] 資料品質說明（各指標可得期間）\n- [ ] 風險解讀框架（可選，輸出至 Markdown）\n\n**視覺化輸出**（使用 visualize_valuation.py）：\n\n- [ ] 歷史走勢圖（`us_valuation_percentile_YYYY-MM-DD.png`）\n  - 多指標合成分位數時間序列\n  - 歷史峰值標記（1929、1965、1999、2021）\n  - S&P 500 指數疊加（對數刻度）\n  - 當前位置標註\n- [ ] 指標分解圖（`us_valuation_breakdown_YYYY-MM-DD.png`）\n  - 各指標分位數橫向條形圖\n  - 極端門檻參考線\n- [ ] JSON 結果檔（`us_valuation_analysis_YYYY-MM-DD.json`）\n</success_criteria>\n",
        "skills/detect-us-equity-valuation-percentile-extreme/references/data-sources.md": "# 資料來源與代碼\n\n## 資料來源總覽\n\n| 指標 | 主要來源 | 備用來源 | 歷史起始 | 頻率 |\n|------|----------|----------|----------|------|\n| CAPE | Shiller Online Data | Multpl.com | 1871 | 月 |\n| 市值/GDP | FRED (WILL5000PRFC / GDP) | 手動計算 | 1950s | 季 |\n| Trailing PE | Yahoo Finance / Multpl | FRED (SP500_PE) | 1980s | 月/日 |\n| Forward PE | Yahoo Finance | FactSet | 2000s | 日 |\n| PB | Yahoo Finance | Bloomberg | 1980s | 月 |\n| PS | Yahoo Finance | - | 1990s | 月 |\n| EV/EBITDA | Bloomberg | - | 1990s | 季 |\n| Q Ratio | FRED (NCBEILQ027S) | - | 1950s | 季 |\n\n---\n\n## Shiller CAPE 資料\n\n### 來源\n\nRobert Shiller 教授維護的公開資料集，可追溯至 1871 年。\n\n**URL**: http://www.econ.yale.edu/~shiller/data.htm\n\n**檔案**: `ie_data.xls`\n\n### 欄位說明\n\n| 欄位 | 說明 |\n|------|------|\n| Date | 日期（YYYY.MM 格式） |\n| S&P Comp. P | S&P 綜合指數價格 |\n| Dividend D | 股息 |\n| Earnings E | 盈餘 |\n| CPI | 消費者物價指數 |\n| Long Interest Rate GS10 | 10 年期公債利率 |\n| Real Price | 實質價格（CPI 調整） |\n| Real Dividend | 實質股息 |\n| Real Earnings | 實質盈餘 |\n| **CAPE** | 景氣循環調整本益比 |\n\n### 抓取方法\n\n```python\nimport pandas as pd\n\ndef fetch_shiller_cape():\n    \"\"\"\n    從 Shiller 資料集抓取 CAPE\n    \"\"\"\n    url = \"http://www.econ.yale.edu/~shiller/data/ie_data.xls\"\n\n    # 讀取 Excel（跳過標題行）\n    df = pd.read_excel(url, sheet_name=\"Data\", skiprows=7)\n\n    # 清理欄位名稱\n    df.columns = ['Date', 'SP_Price', 'Dividend', 'Earnings', 'CPI',\n                  'Date_Fraction', 'Long_Rate', 'Real_Price', 'Real_Dividend',\n                  'Real_TR_Price', 'Real_Earnings', 'Real_TR_Scaled_Earnings',\n                  'CAPE', 'TR_CAPE', 'Excess_CAPE_Yield', 'Monthly_TR',\n                  'Monthly_TR_Reinvested', 'Monthly_Real_TR', 'Monthly_Real_TR_Reinvested']\n\n    # 轉換日期\n    df['Date'] = pd.to_datetime(df['Date'].astype(str).str[:7], format='%Y.%m', errors='coerce')\n    df = df.dropna(subset=['Date', 'CAPE'])\n    df = df.set_index('Date')\n\n    return df['CAPE']\n```\n\n---\n\n## FRED 資料\n\n### 系列代碼\n\n| 系列代碼 | 名稱 | 用途 |\n|----------|------|------|\n| WILL5000PRFC | Wilshire 5000 Total Market Full Cap | 市值（計算市值/GDP） |\n| GDP | Gross Domestic Product | GDP |\n| NCBEILQ027S | Nonfinancial Corporate Business; Corporate Equities | Q Ratio 分子 |\n| TNWMVBSNNCB | Nonfinancial Corporate Business; Net Worth | Q Ratio 分母 |\n| SP500 | S&P 500 | 價格指數 |\n\n### 抓取方法（無需 API Key）\n\n```python\nimport pandas as pd\nfrom datetime import datetime\n\ndef fetch_fred_series(series_id: str, start: str = \"1900-01-01\") -> pd.Series:\n    \"\"\"\n    從 FRED 抓取時間序列（使用 CSV endpoint，無需 API key）\n\n    Parameters\n    ----------\n    series_id : str\n        FRED 系列代碼，如 'WILL5000PRFC'\n    start : str\n        起始日期\n\n    Returns\n    -------\n    pd.Series\n        時間序列資料\n    \"\"\"\n    url = f\"https://fred.stlouisfed.org/graph/fredgraph.csv?id={series_id}\"\n\n    try:\n        df = pd.read_csv(url, parse_dates=['DATE'], index_col='DATE')\n        df = df.rename(columns={series_id: 'value'})\n        df = df[df.index >= start]\n        return df['value']\n    except Exception as e:\n        print(f\"FRED 資料抓取失敗 ({series_id}): {e}\")\n        return None\n```\n\n### 市值/GDP 計算\n\n```python\ndef calculate_mktcap_to_gdp():\n    \"\"\"\n    計算市值/GDP（巴菲特指標）\n    \"\"\"\n    # 抓取資料\n    mktcap = fetch_fred_series('WILL5000PRFC')  # 十億美元\n    gdp = fetch_fred_series('GDP')              # 十億美元\n\n    # GDP 是季度資料，需要 forward fill 到月度\n    gdp_monthly = gdp.resample('M').ffill()\n    mktcap_monthly = mktcap.resample('M').last()\n\n    # 對齊並計算\n    df = pd.DataFrame({\n        'mktcap': mktcap_monthly,\n        'gdp': gdp_monthly\n    }).dropna()\n\n    df['mktcap_to_gdp'] = (df['mktcap'] / df['gdp']) * 100  # 百分比\n\n    return df['mktcap_to_gdp']\n```\n\n---\n\n## Yahoo Finance 資料\n\n### 使用 yfinance 套件\n\n```bash\npip install yfinance\n```\n\n### 抓取 PE/PB 等估值指標\n\n```python\nimport yfinance as yf\n\ndef fetch_yahoo_valuation(ticker: str = \"^GSPC\"):\n    \"\"\"\n    從 Yahoo Finance 抓取估值指標\n\n    注意：Yahoo Finance 的估值指標歷史較短，主要提供近期數據\n    \"\"\"\n    stock = yf.Ticker(ticker)\n\n    # 取得基本資料\n    info = stock.info\n\n    return {\n        'trailing_pe': info.get('trailingPE'),\n        'forward_pe': info.get('forwardPE'),\n        'pb': info.get('priceToBook'),\n        'ps': info.get('priceToSalesTrailing12Months'),\n        'ev_to_ebitda': info.get('enterpriseToEbitda')\n    }\n```\n\n### 抓取價格歷史\n\n```python\ndef fetch_price_history(ticker: str = \"^GSPC\", start: str = \"1950-01-01\"):\n    \"\"\"\n    抓取價格歷史\n    \"\"\"\n    stock = yf.Ticker(ticker)\n    df = stock.history(start=start, auto_adjust=True)\n    return df['Close']\n```\n\n---\n\n## Multpl.com 資料（備用）\n\nMultpl.com 提供長期估值指標的視覺化和下載。\n\n### 可用資料\n\n| 頁面 | 資料 | URL |\n|------|------|-----|\n| S&P 500 PE Ratio | Trailing PE | https://www.multpl.com/s-p-500-pe-ratio/table/by-month |\n| Shiller PE Ratio | CAPE | https://www.multpl.com/shiller-pe/table/by-month |\n| S&P 500 Price to Book | PB | https://www.multpl.com/s-p-500-price-to-book/table/by-month |\n| S&P 500 Price to Sales | PS | https://www.multpl.com/s-p-500-price-to-sales/table/by-month |\n\n### 爬蟲方法（需 Selenium）\n\n參照 `design-human-like-crawler.md` 的方法，使用 Selenium 模擬瀏覽器抓取。\n\n```python\n# 基本架構（需搭配完整爬蟲設定）\nfrom selenium import webdriver\nfrom bs4 import BeautifulSoup\n\ndef fetch_multpl_data(url: str):\n    \"\"\"\n    從 Multpl.com 抓取估值資料\n    \"\"\"\n    # 設定瀏覽器（參照爬蟲指南）\n    driver = get_selenium_driver()\n\n    try:\n        driver.get(url)\n        time.sleep(3)\n\n        soup = BeautifulSoup(driver.page_source, 'lxml')\n        table = soup.select_one('#datatable')\n\n        # 解析表格...\n        # (略)\n\n    finally:\n        driver.quit()\n```\n\n---\n\n## MacroMicro 資料（可選）\n\n財經 M 平方提供 Highcharts 圖表，可抓取完整時間序列。\n\n### 可用圖表\n\n| 指標 | 圖表 URL |\n|------|----------|\n| 美股 PE | /charts/xxx/us-pe-ratio |\n| 美股 CAPE | /charts/xxx/us-shiller-pe |\n\n### 抓取方法\n\n參照 `macromicro-highcharts-crawler.md`，使用 Selenium 等待 Highcharts 渲染完成後提取資料。\n\n---\n\n## 資料品質說明\n\n### 各來源比較\n\n| 來源 | 優點 | 缺點 |\n|------|------|------|\n| Shiller | 歷史最長（150年）、學術標準 | 更新頻率低（月度） |\n| FRED | 官方資料、免費無限制 | 部分系列歷史較短 |\n| Yahoo Finance | 即時、方便 | 歷史短、估值數據不完整 |\n| Multpl | 長期視覺化、免費 | 需爬蟲、更新可能延遲 |\n| MacroMicro | 完整 Highcharts 資料 | 需爬蟲、可能被封鎖 |\n\n### 資料對齊注意事項\n\n1. **頻率不同**：CAPE 是月度，GDP 是季度，PE 可能是日度\n2. **時區問題**：美股收盤後才有當日數據\n3. **修正問題**：GDP 等經濟數據會修正，需使用「首次公布值」或「最終值」\n4. **缺值處理**：使用前向填充（ffill）或線性插值\n\n```python\ndef align_data(series_dict, freq='M'):\n    \"\"\"\n    將多個時間序列對齊到相同頻率\n    \"\"\"\n    aligned = {}\n    for name, series in series_dict.items():\n        # 重採樣到月末\n        if freq == 'M':\n            aligned[name] = series.resample('M').last()\n        elif freq == 'Q':\n            aligned[name] = series.resample('Q').last()\n\n    # 合併並 dropna\n    df = pd.DataFrame(aligned)\n    df = df.ffill()  # 前向填充\n\n    return df\n```\n",
        "skills/detect-us-equity-valuation-percentile-extreme/references/input-schema.md": "# 輸入參數定義\n\n## 參數總覽\n\n```json\n{\n  \"as_of_date\": \"2026-01-21\",\n  \"universe\": \"^GSPC\",\n  \"history_start\": \"1900-01-01\",\n  \"metrics\": [\"cape\", \"mktcap_to_gdp\", \"trailing_pe\", \"pb\"],\n  \"aggregation\": \"mean\",\n  \"weights\": null,\n  \"percentile_method\": \"rank\",\n  \"extreme_threshold\": 95,\n  \"episode_min_gap_days\": 3650,\n  \"forward_windows_days\": [180, 365, 1095],\n  \"risk_readouts\": [\"max_drawdown\", \"forward_return\", \"volatility_change\"]\n}\n```\n\n---\n\n## 必要參數\n\n### as_of_date\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string (YYYY-MM-DD) |\n| 必要 | 是 |\n| 預設 | 今日 |\n| 說明 | 要評估的日期 |\n\n**範例**：\n```json\n\"as_of_date\": \"2026-01-21\"\n```\n\n---\n\n### universe\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 必要 | 是 |\n| 預設 | \"^GSPC\" |\n| 說明 | 市場或指數代碼 |\n\n**支援的代碼**：\n\n| 代碼 | 名稱 | 說明 |\n|------|------|------|\n| ^GSPC | S&P 500 | 美股大盤（預設） |\n| ^NDX | NASDAQ 100 | 科技股重 |\n| ^DJI | Dow Jones | 藍籌股 |\n| ACWI | MSCI ACWI | 全球股票 |\n\n**範例**：\n```json\n\"universe\": \"^GSPC\"\n```\n\n---\n\n### history_start\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string (YYYY-MM-DD) |\n| 必要 | 是 |\n| 預設 | \"1900-01-01\" |\n| 說明 | 歷史起算日，用於計算分位數基準 |\n\n**注意**：實際起算日受資料可得性限制。例如 CAPE 資料從 1871 年開始，但 Yahoo Finance 估值資料可能只到 1980 年代。\n\n**範例**：\n```json\n\"history_start\": \"1900-01-01\"\n```\n\n---\n\n### metrics\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | array[string] |\n| 必要 | 是 |\n| 預設 | [\"cape\", \"mktcap_to_gdp\", \"trailing_pe\"] |\n| 說明 | 要納入的估值指標清單 |\n\n**支援的指標**：\n\n| 代碼 | 名稱 | 歷史起始 |\n|------|------|----------|\n| trailing_pe | 本益比（過去 12 個月） | 1980s |\n| forward_pe | 預估本益比 | 2000s |\n| cape | CAPE / Shiller PE | 1871 |\n| pb | 股價淨值比 | 1980s |\n| ps | 股價營收比 | 1990s |\n| ev_ebitda | 企業價值倍數 | 1990s |\n| q_ratio | 托賓 Q 比率 | 1950s |\n| mktcap_to_gdp | 市值 / GDP | 1950s |\n\n**範例**：\n```json\n\"metrics\": [\"cape\", \"mktcap_to_gdp\", \"trailing_pe\", \"pb\", \"ps\"]\n```\n\n---\n\n### aggregation\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 必要 | 是 |\n| 預設 | \"mean\" |\n| 說明 | 多指標合成方法 |\n\n**支援的方法**：\n\n| 方法 | 公式 | 特性 |\n|------|------|------|\n| mean | 算術平均 | 各指標同等權重 |\n| median | 中位數 | 抵抗單一指標異常 |\n| trimmed_mean | 去極端平均 | 去掉最高最低後平均 |\n\n**範例**：\n```json\n\"aggregation\": \"mean\"\n```\n\n---\n\n## 選用參數\n\n### weights\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | object |\n| 必要 | 否 |\n| 預設 | null（等權） |\n| 說明 | 指標權重，未給則等權 |\n\n**範例**：\n```json\n\"weights\": {\n  \"cape\": 0.30,\n  \"mktcap_to_gdp\": 0.25,\n  \"trailing_pe\": 0.20,\n  \"pb\": 0.15,\n  \"ps\": 0.10\n}\n```\n\n**注意**：權重總和不需要等於 1，會自動正規化。\n\n---\n\n### percentile_method\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 必要 | 否 |\n| 預設 | \"rank\" |\n| 說明 | 分位數計算方式 |\n\n**支援的方法**：\n\n| 方法 | 說明 |\n|------|------|\n| rank | 排序百分等級（推薦） |\n| ecdf | 經驗分布函數 |\n| z_to_percentile | 先做 Z 分數再轉分位 |\n\n**範例**：\n```json\n\"percentile_method\": \"rank\"\n```\n\n---\n\n### extreme_threshold\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | number |\n| 必要 | 否 |\n| 預設 | 95 |\n| 範圍 | 0-100 |\n| 說明 | 判定「極端高估」的分位數門檻 |\n\n**建議值**：\n\n| 門檻 | 敏感度 | 歷史事件數 |\n|------|--------|------------|\n| 90 | 高（更多警報） | ~6-8 次 |\n| 95 | 中（預設） | ~4-5 次 |\n| 97 | 低（嚴格） | ~2-3 次 |\n| 99 | 極低 | ~1-2 次 |\n\n**範例**：\n```json\n\"extreme_threshold\": 95\n```\n\n---\n\n### episode_min_gap_days\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | integer |\n| 必要 | 否 |\n| 預設 | 3650（約 10 年） |\n| 說明 | 歷史極端事件去重的最小間隔（天） |\n\n**目的**：避免同一輪牛市頂點被識別為多個事件。\n\n**範例**：\n```json\n\"episode_min_gap_days\": 3650\n```\n\n---\n\n### forward_windows_days\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | array[integer] |\n| 必要 | 否 |\n| 預設 | [180, 365, 1095] |\n| 說明 | 事後統計的未來視窗（天） |\n\n**建議視窗**：\n\n| 視窗 | 期間 | 用途 |\n|------|------|------|\n| 180 | 6 個月 | 短期 |\n| 365 | 1 年 | 中期 |\n| 1095 | 3 年 | 長期 |\n| 1825 | 5 年 | 超長期 |\n\n**範例**：\n```json\n\"forward_windows_days\": [180, 365, 1095, 1825]\n```\n\n---\n\n### risk_readouts\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | array[string] |\n| 必要 | 否 |\n| 預設 | [\"max_drawdown\", \"forward_return\", \"volatility_change\"] |\n| 說明 | 要輸出的風險解讀項目 |\n\n**支援的項目**：\n\n| 項目 | 說明 |\n|------|------|\n| max_drawdown | 最大回撤 |\n| forward_return | 未來報酬 |\n| volatility_change | 波動變化 |\n| valuation_reversion_speed | 估值均值回歸速度 |\n\n**範例**：\n```json\n\"risk_readouts\": [\"max_drawdown\", \"forward_return\", \"volatility_change\"]\n```\n\n---\n\n## 完整參數範例\n\n### 最小配置\n\n```json\n{\n  \"as_of_date\": \"2026-01-21\"\n}\n```\n\n使用所有預設值。\n\n### 標準配置\n\n```json\n{\n  \"as_of_date\": \"2026-01-21\",\n  \"universe\": \"^GSPC\",\n  \"metrics\": [\"cape\", \"mktcap_to_gdp\", \"trailing_pe\", \"pb\"],\n  \"aggregation\": \"mean\",\n  \"extreme_threshold\": 95\n}\n```\n\n### 完整配置\n\n```json\n{\n  \"as_of_date\": \"2026-01-21\",\n  \"universe\": \"^GSPC\",\n  \"history_start\": \"1900-01-01\",\n  \"metrics\": [\"cape\", \"mktcap_to_gdp\", \"trailing_pe\", \"forward_pe\", \"pb\", \"ps\"],\n  \"aggregation\": \"mean\",\n  \"weights\": {\n    \"cape\": 0.30,\n    \"mktcap_to_gdp\": 0.25,\n    \"trailing_pe\": 0.15,\n    \"forward_pe\": 0.10,\n    \"pb\": 0.10,\n    \"ps\": 0.10\n  },\n  \"percentile_method\": \"rank\",\n  \"extreme_threshold\": 95,\n  \"episode_min_gap_days\": 3650,\n  \"forward_windows_days\": [180, 365, 1095],\n  \"risk_readouts\": [\"max_drawdown\", \"forward_return\", \"volatility_change\", \"valuation_reversion_speed\"]\n}\n```\n\n---\n\n## 命令列參數對應\n\n| JSON 參數 | CLI 參數 | 縮寫 |\n|-----------|----------|------|\n| as_of_date | --as_of_date | -d |\n| universe | --universe | -u |\n| history_start | --history_start | -h |\n| metrics | --metrics | -m |\n| aggregation | --aggregation | -a |\n| extreme_threshold | --extreme_threshold | -t |\n| output | --output | -o |\n\n**範例**：\n\n```bash\npython scripts/valuation_percentile.py \\\n  -d \"2026-01-21\" \\\n  -u \"^GSPC\" \\\n  -m \"cape,mktcap_to_gdp,trailing_pe\" \\\n  -a \"mean\" \\\n  -t 95 \\\n  -o \"output/result.json\"\n```\n",
        "skills/detect-us-equity-valuation-percentile-extreme/references/methodology.md": "# 估值分位數極端偵測方法論\n\n## 核心概念\n\n### 為什麼用分位數？\n\n傳統估值指標（PE、PB、CAPE 等）有不同單位和量綱：\n- PE 可能在 10-40 之間\n- PB 可能在 1-5 之間\n- 市值/GDP 可能在 50%-200% 之間\n\n**問題**：如何比較「PE = 25」和「PB = 3」哪個更極端？\n\n**解決方案**：轉換為「歷史分位數」\n- PE = 25 若位於歷史第 85 分位 → 表示過去只有 15% 的時間比現在更貴\n- PB = 3 若位於歷史第 92 分位 → 表示過去只有 8% 的時間比現在更貴\n- 現在可以直接比較：PB 相對更極端\n\n### 分位數計算公式\n\n```python\ndef percentile_rank(series, value):\n    \"\"\"\n    計算 value 在 series 中的分位數排名\n\n    Parameters\n    ----------\n    series : pd.Series\n        歷史樣本（去除缺值）\n    value : float\n        當期值\n\n    Returns\n    -------\n    float\n        0-100 的分位數\n    \"\"\"\n    s = series.dropna().values\n    return 100.0 * (s <= value).sum() / len(s)\n```\n\n**重要**：這是「經驗分布函數」(ECDF) 方法，假設歷史分布是當前估值的良好參考。\n\n## 多指標合成邏輯\n\n### 為什麼要合成多個指標？\n\n單一估值指標可能受特定因素影響：\n- **PE** 受短期盈餘波動影響（景氣低點時分母很小，PE 飆高但不代表高估）\n- **PB** 對資產密集型行業更敏感\n- **CAPE** 用 10 年平均盈餘，更穩定但反應較慢\n\n**合成多指標**可以：\n1. 降低單一指標的噪音\n2. 捕捉「全面性高估」vs「單一指標異常」\n3. 提供更穩健的估值信號\n\n### 合成方法\n\n```python\ndef aggregate_percentiles(pct_dict, weights=None, method=\"mean\"):\n    \"\"\"\n    合成多個指標的分位數\n\n    Parameters\n    ----------\n    pct_dict : dict\n        {指標名稱: 分位數}，如 {\"cape\": 98, \"pe\": 95, \"pb\": 92}\n    weights : dict, optional\n        指標權重，未給則等權\n    method : str\n        合成方法：mean（算術平均）、median（中位數）、trimmed_mean（去極端平均）\n\n    Returns\n    -------\n    float\n        合成分位數 (0-100)\n    \"\"\"\n    if not pct_dict:\n        return None\n\n    items = list(pct_dict.items())\n    vals = np.array([v for _, v in items], dtype=float)\n\n    if weights:\n        w = np.array([weights.get(k, 0.0) for k, _ in items], dtype=float)\n        w = w / w.sum()\n        return float(np.sum(vals * w))\n\n    if method == \"median\":\n        return float(np.median(vals))\n    elif method == \"trimmed_mean\":\n        # 去掉最高和最低後平均\n        return float(np.mean(np.sort(vals)[1:-1])) if len(vals) > 2 else float(np.mean(vals))\n\n    return float(np.mean(vals))\n```\n\n### 建議權重配置\n\n| 指標 | 建議權重 | 理由 |\n|------|----------|------|\n| CAPE | 30% | 最穩定的長期估值指標 |\n| 市值/GDP | 25% | 巴菲特指標，總量視角 |\n| Trailing PE | 15% | 最即時但波動大 |\n| Forward PE | 15% | 含預期但依賴分析師 |\n| PB | 10% | 資產視角 |\n| PS | 5% | 營收視角 |\n\n## 極端偵測邏輯\n\n### 門檻設定\n\n```\n極端高估判定：composite_percentile >= 95\n```\n\n**為什麼是 95？**\n- 95 分位意味著「歷史上只有 5% 的時間比現在更貴」\n- 對於 100 年歷史，這約等於 5 年\n- 經驗上，這些時期通常對應重大市場頂點\n\n**可調整門檻**：\n- 90：更敏感，可能有更多假警報\n- 97：更嚴格，只捕捉極端情況\n- 99：非常罕見，可能錯過警示\n\n### 歷史事件識別演算法\n\n```python\ndef find_extreme_episodes(composite_series, threshold=95, min_gap_days=3650):\n    \"\"\"\n    找出歷史上的極端高估事件\n\n    Parameters\n    ----------\n    composite_series : pd.Series\n        合成分位數的時間序列\n    threshold : float\n        極端門檻（分位數）\n    min_gap_days : int\n        事件去重的最小間隔（天）\n\n    Returns\n    -------\n    list\n        極端事件的日期列表\n    \"\"\"\n    peaks = []\n    last_peak_date = None\n\n    for date, val in composite_series.items():\n        if val >= threshold:\n            if last_peak_date is None or (date - last_peak_date).days >= min_gap_days:\n                # 新事件\n                peaks.append(date)\n                last_peak_date = date\n            else:\n                # 同一段期間內，保留更高者\n                if composite_series[date] > composite_series[last_peak_date]:\n                    peaks[-1] = date\n                    last_peak_date = date\n\n    return peaks\n```\n\n**去重邏輯的重要性**：\n- 極端高估可能持續數月甚至數年\n- 不去重會產生大量「重複事件」\n- 預設 10 年間隔確保每個「世代」只保留最極端的一次\n\n## 事後統計方法論\n\n### 條件分布分析\n\n當偵測到極端高估時，我們想回答：\n> 「歷史上類似情況發生後，市場表現如何？」\n\n這是一個「條件分布」問題：\n```\nP(未來報酬 | 當前估值 >= 95 分位)\n```\n\n### 計算方法\n\n```python\ndef calculate_conditional_stats(price_series, event_dates, forward_windows):\n    \"\"\"\n    計算條件分布統計\n\n    對每個歷史事件，計算其後的報酬、回撤、波動\n    \"\"\"\n    stats = {}\n\n    for window in forward_windows:\n        returns = []\n        drawdowns = []\n\n        for event_date in event_dates:\n            # 未來報酬\n            future_date = event_date + timedelta(days=window)\n            if future_date in price_series.index:\n                ret = (price_series[future_date] / price_series[event_date]) - 1\n                returns.append(ret)\n\n            # 最大回撤\n            period_prices = price_series[event_date:future_date]\n            if len(period_prices) > 0:\n                rolling_max = period_prices.cummax()\n                dd = (period_prices - rolling_max) / rolling_max\n                drawdowns.append(dd.min())\n\n        stats[f'{window}d'] = {\n            'forward_return': {\n                'median': np.median(returns),\n                'p25': np.percentile(returns, 25),\n                'p10': np.percentile(returns, 10),\n                'positive_prob': (np.array(returns) > 0).mean()\n            },\n            'max_drawdown': {\n                'median': np.median(drawdowns),\n                'p75': np.percentile(drawdowns, 75),\n                'worst': np.min(drawdowns)\n            }\n        }\n\n    return stats\n```\n\n### 解讀框架\n\n**重要認知**：\n1. **不是預測**：這是「條件分布」，不是「一定會發生」\n2. **樣本有限**：100 年可能只有 4-6 次極端事件\n3. **時代差異**：1929 和 2021 的市場環境天差地別\n4. **擇時風險**：估值可以「錯更久」，不適合做空\n\n**建議用法**：\n- 作為「風險雷達」：極端時提高警覺\n- 調整配置：降低槓桿、增加防禦資產\n- 不要據此「逃頂」：錯過最後一段上漲的代價很高\n\n## 資料品質考量\n\n### 不同指標的歷史長度\n\n| 指標 | 可回溯至 | 來源 |\n|------|----------|------|\n| CAPE | 1871 年 | Shiller 資料集 |\n| 市值/GDP | 1950 年代 | FRED |\n| PE/PB | 1980 年代 | 公開金融資料 |\n| Forward PE | 2000 年代 | 分析師預估 |\n\n**處理方式**：\n1. **方案 A**：只用共同可得期間（最短的那個）\n2. **方案 B**：各指標用各自歷史算分位數，再在同日合成（本 skill 預設）\n\n**必須揭露**：\n- 使用方案 B 時，不同指標的「歷史基準」不同\n- CAPE 的 95 分位可能是 130 年中的前 5%\n- PE 的 95 分位可能只是 40 年中的前 5%\n\n### 資料延遲\n\n| 指標類型 | 延遲 | 說明 |\n|----------|------|------|\n| 價格類 | 實時 | 每日可得 |\n| PE/PB | 季度 | 等待財報 |\n| GDP | 季度+修正 | 初值 → 修正值 |\n\n**處理方式**：\n- 使用最新可得數據\n- 揭露「資料截止日」\n- 不要假裝是「即時」\n\n## 方法論限制\n\n1. **過去不代表未來**：歷史分布可能不再適用於當前環境\n2. **結構性變化**：利率環境、央行政策、全球化改變了估值中樞\n3. **倖存者偏差**：我們只研究「贏家」（美股），失敗的市場沒有 130 年數據\n4. **均值回歸假設**：假設估值終會回歸，但「何時」是未知數\n5. **交易成本**：據此操作可能產生大量交易成本\n\n## 參考文獻\n\n- Shiller, R.J. (2000). *Irrational Exuberance*\n- Hussman, J. (2021). \"Valuations and Prospective Returns\"\n- AQR (2017). \"Expected Returns on Major Asset Classes\"\n",
        "skills/detect-us-equity-valuation-percentile-extreme/references/valuation-metrics.md": "# 估值指標定義與解讀\n\n## 指標總覽\n\n| 指標 | 英文名 | 公式 | 適用性 |\n|------|--------|------|--------|\n| 本益比 | Trailing PE | 價格 / 過去 12 個月盈餘 | 最常用，但受短期盈餘波動影響 |\n| 預估本益比 | Forward PE | 價格 / 未來 12 個月預估盈餘 | 含未來預期，依賴分析師 |\n| CAPE | Shiller PE / CAPE | 價格 / 10 年平均實質盈餘 | 最穩定的長期估值指標 |\n| 股價淨值比 | Price-to-Book | 價格 / 每股淨值 | 資產視角，對資本密集型行業敏感 |\n| 股價營收比 | Price-to-Sales | 價格 / 每股營收 | 營收視角，較不受盈餘操縱影響 |\n| 企業價值倍數 | EV/EBITDA | 企業價值 / 稅息折舊攤銷前盈餘 | 併購視角，考慮負債 |\n| 托賓 Q 比率 | Q Ratio | 市值 / 重置成本 | 學術指標，資產重置視角 |\n| 巴菲特指標 | Market Cap / GDP | 總市值 / GDP | 總量視角，巴菲特愛用 |\n\n---\n\n## 本益比 (Trailing PE)\n\n### 定義\n\n```\nTrailing PE = 當前股價 / 過去 12 個月每股盈餘 (EPS TTM)\n```\n\n### 特性\n\n| 面向 | 說明 |\n|------|------|\n| 優點 | 最直觀、資料取得容易、即時反應 |\n| 缺點 | 受短期盈餘波動影響大（景氣低點時分母很小，PE 反而很高） |\n| 歷史中位數 | ~15-17（美股長期） |\n| 極端高值 | >25 通常被認為偏高 |\n\n### 使用注意\n\n- **周期性行業**：盈餘波動大，PE 可能誤導\n- **成長股**：盈餘低但成長快，PE 高不一定高估\n- **一次性損益**：重大減值或處分會扭曲 EPS\n\n---\n\n## 預估本益比 (Forward PE)\n\n### 定義\n\n```\nForward PE = 當前股價 / 未來 12 個月預估每股盈餘\n```\n\n### 特性\n\n| 面向 | 說明 |\n|------|------|\n| 優點 | 納入未來預期，對成長股更公平 |\n| 缺點 | 依賴分析師預估，預估常過於樂觀 |\n| 歷史中位數 | ~14-16（通常比 Trailing PE 低） |\n\n### 使用注意\n\n- **分析師偏誤**：預估通常過於樂觀，尤其在景氣高峰\n- **資料來源**：不同來源的預估可能差異很大\n- **適用期間**：歷史較短，約 2000 年後才有完整資料\n\n---\n\n## CAPE (Shiller PE / 景氣循環調整本益比)\n\n### 定義\n\n```\nCAPE = 實質股價 / 過去 10 年平均實質每股盈餘\n```\n\n其中「實質」表示經 CPI 調整。\n\n### 特性\n\n| 面向 | 說明 |\n|------|------|\n| 優點 | 平滑盈餘周期，長期估值最穩定 |\n| 缺點 | 反應較慢、可能錯過短期轉折 |\n| 歷史中位數 | ~16-17（1871-2020） |\n| 極端高值 | >30 歷史上對應重大頂點 |\n\n### 歷史極端事件\n\n| 時期 | CAPE | 後續 |\n|------|------|------|\n| 1929-09 | ~33 | 大蕭條，跌 89% |\n| 1999-12 | ~44 | 科技泡沫，跌 50%+ |\n| 2021-12 | ~40 | 待觀察 |\n\n### 使用注意\n\n- **會計準則變化**：GAAP 變化影響盈餘定義\n- **產業結構變化**：科技股佔比上升改變盈餘特性\n- **利率環境**：低利率可能支持更高估值\n\n---\n\n## 股價淨值比 (Price-to-Book, PB)\n\n### 定義\n\n```\nPB = 當前股價 / 每股淨值 (Book Value per Share)\n```\n\n其中淨值 = 總資產 - 總負債\n\n### 特性\n\n| 面向 | 說明 |\n|------|------|\n| 優點 | 資產視角，不受盈餘操縱影響 |\n| 缺點 | 對輕資產行業（科技）意義有限 |\n| 歷史中位數 | ~2.0-2.5（美股） |\n| 極端高值 | >4.0 通常偏高 |\n\n### 使用注意\n\n- **產業差異**：銀行 PB ~1，科技 PB 可能 >10\n- **無形資產**：品牌、專利等不在帳面上\n- **會計差異**：不同會計準則下淨值定義不同\n\n---\n\n## 股價營收比 (Price-to-Sales, PS)\n\n### 定義\n\n```\nPS = 當前市值 / 過去 12 個月總營收\n```\n\n### 特性\n\n| 面向 | 說明 |\n|------|------|\n| 優點 | 營收較難操縱、對虧損公司有意義 |\n| 缺點 | 不考慮獲利能力，高毛利與低毛利公司不可比 |\n| 歷史中位數 | ~1.5-2.0（美股） |\n| 極端高值 | >3.0 通常偏高 |\n\n### 使用注意\n\n- **毛利差異**：軟體公司 PS 5 可能合理，零售 PS 5 很高\n- **營收品質**：一次性營收會扭曲\n- **成長預期**：高成長公司 PS 高有其合理性\n\n---\n\n## 企業價值倍數 (EV/EBITDA)\n\n### 定義\n\n```\nEV = 市值 + 總負債 - 現金\nEBITDA = 稅息折舊攤銷前盈餘\n\nEV/EBITDA = 企業價值 / EBITDA\n```\n\n### 特性\n\n| 面向 | 說明 |\n|------|------|\n| 優點 | 考慮負債、併購視角、跨槓桿可比 |\n| 缺點 | EBITDA 可能美化獲利、忽略資本支出 |\n| 歷史中位數 | ~10-12（美股） |\n| 極端高值 | >15 通常偏高 |\n\n### 使用注意\n\n- **槓桿公司**：高負債公司 EV 很高\n- **資本密集**：折舊攤銷大的行業 EBITDA 失真\n- **資料取得**：需要更多財務細節\n\n---\n\n## 托賓 Q 比率 (Q Ratio)\n\n### 定義\n\n```\nQ Ratio = 公司市值 / 資產重置成本\n```\n\n### 特性\n\n| 面向 | 說明 |\n|------|------|\n| 優點 | 學術基礎紮實、考慮重置成本 |\n| 缺點 | 重置成本難以精確計算、資料來源有限 |\n| 理論值 | Q=1 為均衡（市值=重置成本） |\n| 歷史中位數 | ~0.7-0.8 |\n| 極端高值 | >1.5 歷史上對應重大頂點 |\n\n### FRED 資料\n\n```\nQ Ratio ≈ NCBEILQ027S / TNWMVBSNNCB\n```\n\n- NCBEILQ027S: 非金融企業股權市值\n- TNWMVBSNNCB: 非金融企業淨值\n\n---\n\n## 巴菲特指標 (Market Cap / GDP)\n\n### 定義\n\n```\nBuffett Indicator = 股票總市值 / GDP × 100%\n```\n\n### 特性\n\n| 面向 | 說明 |\n|------|------|\n| 優點 | 總量視角、直觀易懂、巴菲特背書 |\n| 缺點 | 忽略海外營收、產業結構變化影響大 |\n| 歷史中位數 | ~80-100%（美股） |\n| 極端高值 | >150% 歷史上對應重大頂點 |\n\n### 歷史極端事件\n\n| 時期 | 市值/GDP | 後續 |\n|------|----------|------|\n| 1999-12 | ~150% | 科技泡沫 |\n| 2021-12 | ~200%+ | 待觀察 |\n\n### 使用注意\n\n- **全球化**：美國企業海外營收占比越來越高\n- **上市佔比**：非上市公司沒有納入市值\n- **GDP 口徑**：名義 vs 實質、年化 vs 季度\n\n---\n\n## 指標比較總結\n\n### 穩定性排序（高→低）\n\n1. **CAPE** - 10 年平均最穩定\n2. **市值/GDP** - 總量視角較穩定\n3. **Q Ratio** - 重置成本視角\n4. **PB** - 資產視角\n5. **PS** - 營收視角\n6. **Trailing PE** - 受短期盈餘影響\n7. **Forward PE** - 依賴預估\n\n### 歷史長度排序（長→短）\n\n1. **CAPE** - 1871 年起\n2. **Q Ratio** - 1950s 起\n3. **市值/GDP** - 1950s 起\n4. **Trailing PE** - 1980s 起\n5. **PB** - 1980s 起\n6. **PS** - 1990s 起\n7. **Forward PE** - 2000s 起\n8. **EV/EBITDA** - 1990s 起\n\n### 建議組合\n\n**基本組合**（最少資料需求）：\n- CAPE + 市值/GDP\n\n**標準組合**（平衡覆蓋面與資料品質）：\n- CAPE + 市值/GDP + Trailing PE + PB\n\n**完整組合**（最大覆蓋面）：\n- CAPE + 市值/GDP + Trailing PE + Forward PE + PB + PS\n",
        "skills/detect-us-equity-valuation-percentile-extreme/templates/output-json.md": "# JSON 輸出模板\n\n## 完整輸出結構\n\n```json\n{\n  \"skill\": \"detect-us-equity-valuation-percentile-extreme\",\n  \"version\": \"0.1.0\",\n  \"as_of_date\": \"2026-01-21\",\n  \"universe\": \"^GSPC\",\n  \"generated_at\": \"2026-01-21T15:30:00Z\",\n\n  \"summary\": {\n    \"composite_percentile\": 97.3,\n    \"extreme_threshold\": 95,\n    \"is_extreme\": true,\n    \"status\": \"EXTREME_OVERVALUED\",\n    \"status_description\": \"綜合估值分位數超過 95，處於歷史極端高估區間\"\n  },\n\n  \"metric_percentiles\": {\n    \"cape\": {\n      \"current_value\": 38.5,\n      \"percentile\": 98.2,\n      \"history_start\": \"1871-01-01\",\n      \"data_points\": 1860,\n      \"historical_median\": 16.8,\n      \"historical_mean\": 17.2\n    },\n    \"mktcap_to_gdp\": {\n      \"current_value\": 195.3,\n      \"percentile\": 96.5,\n      \"history_start\": \"1950-01-01\",\n      \"data_points\": 912,\n      \"historical_median\": 82.5,\n      \"historical_mean\": 88.7\n    },\n    \"trailing_pe\": {\n      \"current_value\": 28.7,\n      \"percentile\": 94.1,\n      \"history_start\": \"1980-01-01\",\n      \"data_points\": 552,\n      \"historical_median\": 17.5,\n      \"historical_mean\": 18.9\n    },\n    \"pb\": {\n      \"current_value\": 4.8,\n      \"percentile\": 92.3,\n      \"history_start\": \"1985-01-01\",\n      \"data_points\": 492,\n      \"historical_median\": 2.6,\n      \"historical_mean\": 2.9\n    }\n  },\n\n  \"aggregation_info\": {\n    \"method\": \"mean\",\n    \"weights\": {\n      \"cape\": 0.25,\n      \"mktcap_to_gdp\": 0.25,\n      \"trailing_pe\": 0.25,\n      \"pb\": 0.25\n    },\n    \"metrics_included\": [\"cape\", \"mktcap_to_gdp\", \"trailing_pe\", \"pb\"],\n    \"metrics_excluded\": []\n  },\n\n  \"historical_episodes\": [\n    {\n      \"date\": \"1929-09-01\",\n      \"composite_percentile\": 97.8,\n      \"metric_values\": {\n        \"cape\": 33.0\n      },\n      \"context\": \"大蕭條前夕\"\n    },\n    {\n      \"date\": \"1965-01-01\",\n      \"composite_percentile\": 95.2,\n      \"metric_values\": {\n        \"cape\": 24.0\n      },\n      \"context\": \"Nifty Fifty 時期\"\n    },\n    {\n      \"date\": \"1999-12-01\",\n      \"composite_percentile\": 98.5,\n      \"metric_values\": {\n        \"cape\": 44.0,\n        \"mktcap_to_gdp\": 150.0\n      },\n      \"context\": \"科技泡沫頂點\"\n    },\n    {\n      \"date\": \"2021-12-01\",\n      \"composite_percentile\": 97.1,\n      \"metric_values\": {\n        \"cape\": 40.0,\n        \"mktcap_to_gdp\": 200.0\n      },\n      \"context\": \"疫情後牛市頂點\"\n    }\n  ],\n\n  \"forward_stats\": {\n    \"180d\": {\n      \"forward_return\": {\n        \"median\": -2.5,\n        \"p25\": -12.3,\n        \"p10\": -25.8,\n        \"positive_prob\": 0.45,\n        \"sample_size\": 5\n      },\n      \"max_drawdown\": {\n        \"median\": -8.5,\n        \"p75\": -18.2,\n        \"worst\": -35.0\n      }\n    },\n    \"365d\": {\n      \"forward_return\": {\n        \"median\": -5.8,\n        \"p25\": -18.5,\n        \"p10\": -32.1,\n        \"positive_prob\": 0.40,\n        \"sample_size\": 5\n      },\n      \"max_drawdown\": {\n        \"median\": -15.2,\n        \"p75\": -28.5,\n        \"worst\": -50.8\n      }\n    },\n    \"1095d\": {\n      \"forward_return\": {\n        \"median\": 8.5,\n        \"p25\": -12.8,\n        \"p10\": -25.5,\n        \"positive_prob\": 0.55,\n        \"sample_size\": 4\n      },\n      \"max_drawdown\": {\n        \"median\": -28.5,\n        \"p75\": -42.1,\n        \"worst\": -89.0\n      }\n    }\n  },\n\n  \"volatility_analysis\": {\n    \"current_vix\": 18.5,\n    \"vix_percentile\": 45.2,\n    \"historical_pattern\": {\n      \"vol_increase_prob_6m\": 0.72,\n      \"vol_increase_prob_12m\": 0.65,\n      \"median_vol_change\": 5.2\n    }\n  },\n\n  \"risk_interpretation\": {\n    \"headline\": \"當前估值處於歷史極端高估區間，風險分布不對稱\",\n    \"key_points\": [\n      \"綜合估值分位數 97.3，歷史上僅 2.7% 的時間比現在更貴\",\n      \"CAPE (98.2) 和 市值/GDP (96.5) 是主要推升因素\",\n      \"歷史上類似時期，未來 1-3 年最大回撤中位數約 -15% 至 -30%\",\n      \"正報酬機率下降，但不代表「必然崩盤」\"\n    ],\n    \"caveats\": [\n      \"歷史極端事件樣本數有限（約 4-5 次）\",\n      \"當前低利率環境可能支持更高估值\",\n      \"時代背景不同，直接類比有風險\"\n    ],\n    \"suggested_actions\": [\n      \"降低整體槓桿\",\n      \"增加防禦性資產配置\",\n      \"不建議據此完全離場或做空\"\n    ]\n  },\n\n  \"data_quality_notes\": [\n    \"CAPE 資料來源: Shiller Online Data，可回溯至 1871 年\",\n    \"市值/GDP 資料來源: FRED (WILL5000PRFC / GDP)，可回溯至 1950 年代\",\n    \"Trailing PE 資料來源: Yahoo Finance，歷史約 40 年\",\n    \"合成分位數使用各指標自身歷史分布，再在同日做等權合成\"\n  ],\n\n  \"metadata\": {\n    \"execution_time_ms\": 2500,\n    \"data_freshness\": {\n      \"cape\": \"2026-01-20\",\n      \"mktcap_to_gdp\": \"2026-01-15\",\n      \"trailing_pe\": \"2026-01-21\",\n      \"pb\": \"2026-01-21\"\n    },\n    \"cache_used\": false\n  }\n}\n```\n\n---\n\n## 欄位說明\n\n### 頂層欄位\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| skill | string | 技能識別碼 |\n| version | string | 技能版本 |\n| as_of_date | string | 評估日期 |\n| universe | string | 市場代碼 |\n| generated_at | string | 報告產生時間（ISO 8601） |\n\n### summary\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| composite_percentile | number | 綜合估值分位數 (0-100) |\n| extreme_threshold | number | 極端門檻 |\n| is_extreme | boolean | 是否極端高估 |\n| status | string | 狀態碼（EXTREME_OVERVALUED / ELEVATED / NORMAL / UNDERVALUED） |\n| status_description | string | 狀態描述（人類可讀） |\n\n### metric_percentiles\n\n每個指標的詳細資訊：\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| current_value | number | 當前值 |\n| percentile | number | 分位數 (0-100) |\n| history_start | string | 歷史起始日期 |\n| data_points | integer | 歷史資料點數 |\n| historical_median | number | 歷史中位數 |\n| historical_mean | number | 歷史平均 |\n\n### historical_episodes\n\n每個歷史極端事件：\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| date | string | 事件日期 |\n| composite_percentile | number | 當時的綜合分位數 |\n| metric_values | object | 當時各指標的值 |\n| context | string | 事件背景說明 |\n\n### forward_stats\n\n每個視窗的事後統計：\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| forward_return | object | 未來報酬統計 |\n| max_drawdown | object | 最大回撤統計 |\n\nforward_return 子欄位：\n- median: 中位數報酬\n- p25: 25 分位報酬\n- p10: 10 分位報酬\n- positive_prob: 正報酬機率\n- sample_size: 樣本數\n\n---\n\n## 精簡輸出（--quick 模式）\n\n```json\n{\n  \"skill\": \"detect-us-equity-valuation-percentile-extreme\",\n  \"as_of_date\": \"2026-01-21\",\n  \"composite_percentile\": 97.3,\n  \"is_extreme\": true,\n  \"metric_percentiles\": {\n    \"cape\": 98.2,\n    \"mktcap_to_gdp\": 96.5,\n    \"trailing_pe\": 94.1\n  },\n  \"status\": \"EXTREME_OVERVALUED\"\n}\n```\n\n---\n\n## 狀態碼定義\n\n| 狀態碼 | 分位數範圍 | 說明 |\n|--------|------------|------|\n| EXTREME_OVERVALUED | ≥95 | 歷史極端高估 |\n| OVERVALUED | 80-94 | 高估 |\n| ELEVATED | 65-79 | 偏高 |\n| NORMAL | 35-64 | 正常範圍 |\n| CHEAP | 20-34 | 偏低 |\n| UNDERVALUED | 5-19 | 低估 |\n| EXTREME_UNDERVALUED | <5 | 歷史極端低估 |\n",
        "skills/detect-us-equity-valuation-percentile-extreme/templates/output-markdown.md": "# Markdown 報告模板\n\n## 報告結構\n\n```markdown\n# 美國股市估值分位數極端監測\n\n**評估日期**: {as_of_date}\n**市場**: {universe}\n**產生時間**: {generated_at}\n\n---\n\n## 1) 當前結論\n\n| 項目 | 數值 | 狀態 |\n|------|------|------|\n| 綜合估值分位數 | **{composite_percentile}** / 100 | {status_emoji} {status_description} |\n| 極端門檻 | {extreme_threshold} | - |\n| 判定結果 | {is_extreme ? \"是\" : \"否\"} | - |\n\n### 結論摘要\n\n{risk_interpretation.headline}\n\n---\n\n## 2) 各指標分位數明細\n\n| 指標 | 當前值 | 分位數 | 歷史起始 | 歷史中位數 |\n|------|--------|--------|----------|------------|\n| CAPE | {cape.current_value} | {cape.percentile} | {cape.history_start} | {cape.historical_median} |\n| 市值/GDP | {mktcap_to_gdp.current_value}% | {mktcap_to_gdp.percentile} | {mktcap_to_gdp.history_start} | {mktcap_to_gdp.historical_median}% |\n| 本益比 | {trailing_pe.current_value} | {trailing_pe.percentile} | {trailing_pe.history_start} | {trailing_pe.historical_median} |\n| 股價淨值比 | {pb.current_value} | {pb.percentile} | {pb.history_start} | {pb.historical_median} |\n\n### 主要推升因素\n\n- **{top_1_metric}** ({top_1_percentile}) - 最高\n- **{top_2_metric}** ({top_2_percentile})\n- **{top_3_metric}** ({top_3_percentile})\n\n---\n\n## 3) 歷史類比事件\n\n當估值分位數達到或超過 {extreme_threshold} 的歷史峰值：\n\n| 時期 | 綜合分位數 | 背景 | 後續發展 |\n|------|-----------|------|----------|\n| 1929-09 | 97.8 | 大蕭條前夕 | 崩跌 89% |\n| 1965-01 | 95.2 | Nifty Fifty 時期 | 16 年實質報酬歸零 |\n| 1999-12 | 98.5 | 科技泡沫頂點 | 崩跌 50%+ |\n| 2021-12 | 97.1 | 疫情後牛市 | 待觀察 |\n| **當前** | **{composite_percentile}** | - | 待觀察 |\n\n---\n\n## 4) 事後統計\n\n基於歷史極端事件的條件分布分析：\n\n### 未來報酬分布\n\n| 視窗 | 中位數 | 下四分位 | 下十分位 | 正報酬機率 |\n|------|--------|----------|----------|------------|\n| 6 個月 | {180d.forward_return.median}% | {180d.forward_return.p25}% | {180d.forward_return.p10}% | {180d.forward_return.positive_prob * 100}% |\n| 1 年 | {365d.forward_return.median}% | {365d.forward_return.p25}% | {365d.forward_return.p10}% | {365d.forward_return.positive_prob * 100}% |\n| 3 年 | {1095d.forward_return.median}% | {1095d.forward_return.p25}% | {1095d.forward_return.p10}% | {1095d.forward_return.positive_prob * 100}% |\n\n### 最大回撤風險\n\n| 視窗 | 中位數 | 75 分位 | 最差情境 |\n|------|--------|---------|----------|\n| 6 個月 | {180d.max_drawdown.median}% | {180d.max_drawdown.p75}% | {180d.max_drawdown.worst}% |\n| 1 年 | {365d.max_drawdown.median}% | {365d.max_drawdown.p75}% | {365d.max_drawdown.worst}% |\n| 3 年 | {1095d.max_drawdown.median}% | {1095d.max_drawdown.p75}% | {1095d.max_drawdown.worst}% |\n\n### 波動變化\n\n- 事件後 6 個月波動上升機率：**{volatility_analysis.vol_increase_prob_6m * 100}%**\n- 事件後 12 個月波動上升機率：**{volatility_analysis.vol_increase_prob_12m * 100}%**\n- 波動中位數變化：+{volatility_analysis.median_vol_change} 個百分點\n\n---\n\n## 5) 風險解讀框架\n\n### 關鍵要點\n\n{foreach risk_interpretation.key_points as point}\n- {point}\n{/foreach}\n\n### 重要警語\n\n{foreach risk_interpretation.caveats as caveat}\n- ⚠️ {caveat}\n{/foreach}\n\n### 建議行動\n\n{foreach risk_interpretation.suggested_actions as action}\n- ✅ {action}\n{/foreach}\n\n---\n\n## 6) 資料品質說明\n\n{foreach data_quality_notes as note}\n- {note}\n{/foreach}\n\n---\n\n## 附錄：方法論摘要\n\n### 分位數計算\n\n- **公式**: `percentile = 100 × (歷史中 ≤ 當前值的樣本數 / 總樣本數)`\n- **合成方法**: {aggregation_info.method}\n- **指標權重**: {aggregation_info.weights}\n\n### 極端事件識別\n\n- **門檻**: 綜合分位數 ≥ {extreme_threshold}\n- **去重間隔**: {episode_min_gap_days} 天（避免同一輪牛市被計為多個事件）\n\n### 資料來源\n\n- CAPE: Shiller Online Data\n- 市值/GDP: FRED\n- PE/PB: Yahoo Finance\n\n---\n\n*報告產生時間: {generated_at}*\n*技能版本: {version}*\n```\n\n---\n\n## 範例輸出\n\n```markdown\n# 美國股市估值分位數極端監測\n\n**評估日期**: 2026-01-21\n**市場**: S&P 500 (^GSPC)\n**產生時間**: 2026-01-21T15:30:00Z\n\n---\n\n## 1) 當前結論\n\n| 項目 | 數值 | 狀態 |\n|------|------|------|\n| 綜合估值分位數 | **97.3** / 100 | 🔴 歷史極端高估 |\n| 極端門檻 | 95 | - |\n| 判定結果 | 是 | - |\n\n### 結論摘要\n\n當前估值處於歷史極端高估區間，風險分布不對稱。歷史上僅有 2.7% 的時間比現在更貴。\n\n---\n\n## 2) 各指標分位數明細\n\n| 指標 | 當前值 | 分位數 | 歷史起始 | 歷史中位數 |\n|------|--------|--------|----------|------------|\n| CAPE | 38.5 | **98.2** | 1871-01 | 16.8 |\n| 市值/GDP | 195.3% | **96.5** | 1950-01 | 82.5% |\n| 本益比 | 28.7 | **94.1** | 1980-01 | 17.5 |\n| 股價淨值比 | 4.8 | **92.3** | 1985-01 | 2.6 |\n\n### 主要推升因素\n\n- **CAPE** (98.2) - 最高\n- **市值/GDP** (96.5)\n- **本益比** (94.1)\n\n---\n\n## 3) 歷史類比事件\n\n當估值分位數達到或超過 95 的歷史峰值：\n\n| 時期 | 綜合分位數 | 背景 | 後續發展 |\n|------|-----------|------|----------|\n| 1929-09 | 97.8 | 大蕭條前夕 | 崩跌 89% |\n| 1965-01 | 95.2 | Nifty Fifty 時期 | 16 年實質報酬歸零 |\n| 1999-12 | 98.5 | 科技泡沫頂點 | 崩跌 50%+ |\n| 2021-12 | 97.1 | 疫情後牛市 | 下跌約 25% |\n| **當前** | **97.3** | - | 待觀察 |\n\n---\n\n## 4) 事後統計\n\n基於歷史極端事件的條件分布分析：\n\n### 未來報酬分布\n\n| 視窗 | 中位數 | 下四分位 | 下十分位 | 正報酬機率 |\n|------|--------|----------|----------|------------|\n| 6 個月 | -2.5% | -12.3% | -25.8% | 45% |\n| 1 年 | -5.8% | -18.5% | -32.1% | 40% |\n| 3 年 | +8.5% | -12.8% | -25.5% | 55% |\n\n### 最大回撤風險\n\n| 視窗 | 中位數 | 75 分位 | 最差情境 |\n|------|--------|---------|----------|\n| 6 個月 | -8.5% | -18.2% | -35.0% |\n| 1 年 | -15.2% | -28.5% | -50.8% |\n| 3 年 | -28.5% | -42.1% | -89.0% |\n\n### 波動變化\n\n- 事件後 6 個月波動上升機率：**72%**\n- 事件後 12 個月波動上升機率：**65%**\n- 波動中位數變化：+5.2 個百分點\n\n---\n\n## 5) 風險解讀框架\n\n### 關鍵要點\n\n- 綜合估值分位數 97.3，歷史上僅 2.7% 的時間比現在更貴\n- CAPE (98.2) 和 市值/GDP (96.5) 是主要推升因素\n- 歷史上類似時期，未來 1-3 年最大回撤中位數約 -15% 至 -30%\n- 正報酬機率下降，但不代表「必然崩盤」\n\n### 重要警語\n\n- ⚠️ 歷史極端事件樣本數有限（約 4-5 次）\n- ⚠️ 當前低利率環境可能支持更高估值\n- ⚠️ 時代背景不同，直接類比有風險\n\n### 建議行動\n\n- ✅ 降低整體槓桿\n- ✅ 增加防禦性資產配置\n- ✅ 不建議據此完全離場或做空\n\n---\n\n## 6) 資料品質說明\n\n- CAPE 資料來源: Shiller Online Data，可回溯至 1871 年\n- 市值/GDP 資料來源: FRED (WILL5000PRFC / GDP)，可回溯至 1950 年代\n- Trailing PE 資料來源: Yahoo Finance，歷史約 40 年\n- 合成分位數使用各指標自身歷史分布，再在同日做等權合成\n\n---\n\n*報告產生時間: 2026-01-21T15:30:00Z*\n*技能版本: 0.1.0*\n```\n",
        "skills/detect-us-equity-valuation-percentile-extreme/workflows/execute-analysis.md": "# Workflow: Execute Valuation Analysis\n\n<required_reading>\n**執行前閱讀：**\n1. references/data-sources.md - 了解資料來源\n2. references/valuation-metrics.md - 估值指標定義\n3. references/input-schema.md - 完整參數說明\n</required_reading>\n\n<process>\n\n## Step 1: 確認分析參數\n\n**必要參數**：\n- `as_of_date`: 評估日期（預設今日）\n- `universe`: 市場代碼（預設 ^GSPC，標普500）\n\n**可選參數**：\n- `metrics`: 要納入的估值指標（預設 cape, mktcap_to_gdp, trailing_pe）\n- `aggregation`: 合成方法（mean/median/trimmed_mean）\n- `extreme_threshold`: 極端門檻（預設 95）\n\n若用戶未指定，使用預設參數執行。\n\n## Step 2: 抓取估值資料\n\n執行資料抓取腳本：\n\n```bash\ncd skills/detect-us-equity-valuation-percentile-extreme\npython scripts/fetch_valuation_data.py --metrics \"cape,mktcap_to_gdp,trailing_pe,pb\"\n```\n\n資料來源：\n- **CAPE**: Shiller Online Data（http://www.econ.yale.edu/~shiller/data.htm）\n- **市值/GDP**: FRED WILL5000PRFC / GDP\n- **PE/PB**: Yahoo Finance 或公開 API\n\n## Step 3: 執行分位數計算\n\n執行主分析腳本：\n\n```bash\npython scripts/valuation_percentile.py \\\n  --as_of_date \"2026-01-21\" \\\n  --universe \"^GSPC\" \\\n  --metrics \"cape,mktcap_to_gdp,trailing_pe\" \\\n  --aggregation \"mean\" \\\n  --extreme_threshold 95 \\\n  --output \"output/analysis_result.json\"\n```\n\n**核心計算流程**：\n\n1. **對齊頻率**：將所有指標對齊至月末資料\n2. **計算分位數**：\n   ```python\n   percentile = 100.0 * (history <= current_value).sum() / len(history)\n   ```\n3. **合成總分**：\n   ```python\n   composite = np.mean([cape_pct, mktcap_gdp_pct, pe_pct])\n   ```\n4. **判定極端**：\n   ```python\n   is_extreme = composite >= extreme_threshold\n   ```\n\n## Step 4: 識別歷史類比事件\n\n若 `is_extreme == True`，自動執行歷史事件識別：\n\n```python\n# 找出歷史上合成分位數超過門檻的峰值\npeaks = find_extreme_episodes(\n    composite_series,\n    threshold=95,\n    min_gap_days=3650  # 10 年內只保留最高點\n)\n```\n\n預期輸出的歷史事件：\n- 1929-09: 大蕭條前夕\n- 1965-01: 60 年代牛市頂點\n- 1999-12: 科技泡沫頂點\n- 2021-12: 疫情後牛市頂點\n\n## Step 5: 計算事後統計\n\n對每個歷史極端事件，計算事後表現：\n\n```python\nforward_windows = [180, 365, 1095]  # 6個月、1年、3年\n\nfor event_date in historical_episodes:\n    for window in forward_windows:\n        # 計算未來 X 天報酬\n        future_return = price[event_date + window] / price[event_date] - 1\n        # 計算區間最大回撤\n        max_drawdown = calculate_max_drawdown(price[event_date:event_date+window])\n```\n\n輸出統計：\n- 未來報酬：中位數、25 分位、10 分位\n- 最大回撤：中位數、75 分位、最差情境\n- 波動變化：事件後 6-12 月波動上升機率\n\n## Step 6: 產生報告\n\n**JSON 輸出**（參照 templates/output-json.md）：\n```bash\ncat output/analysis_result.json\n```\n\n**Markdown 報告**（可選）：\n```bash\npython scripts/valuation_percentile.py --output_format markdown > output/report.md\n```\n\n報告應包含：\n1. 當前結論（是否極端、綜合分位數）\n2. 各指標分位數明細\n3. 歷史類比事件\n4. 事後統計\n5. 風險解讀框架\n6. 資料品質說明\n\n## Step 7: 驗證輸出\n\n檢查輸出完整性：\n- [ ] 綜合分位數在 0-100 範圍\n- [ ] 各指標分位數均已計算\n- [ ] 歷史事件日期合理\n- [ ] 事後統計有數據\n- [ ] 資料品質說明已揭露\n\n</process>\n\n<success_criteria>\n工作流程完成時：\n\n- [ ] 成功抓取所有指定的估值指標資料\n- [ ] 計算出綜合估值分位數\n- [ ] 判定是否處於極端高估區間\n- [ ] 識別歷史類比事件（若為極端）\n- [ ] 計算事後統計\n- [ ] 產生完整的 JSON 或 Markdown 報告\n- [ ] 揭露資料品質與限制說明\n</success_criteria>\n\n<error_handling>\n\n**常見錯誤與處理**：\n\n| 錯誤 | 原因 | 解決方案 |\n|------|------|----------|\n| 資料抓取失敗 | 網路問題或資料源變更 | 使用備用資料源或本地快取 |\n| 指標歷史過短 | 某些指標只有 30 年歷史 | 揭露限制，或使用可得期間最長的指標 |\n| 分位數計算異常 | 資料有空值 | 先執行 dropna()，並記錄缺失比例 |\n| 歷史事件為空 | 門檻設太高或資料期間太短 | 降低門檻或擴展資料期間 |\n\n</error_handling>\n",
        "skills/detect-us-equity-valuation-percentile-extreme/workflows/historical-episodes.md": "# Workflow: Historical Episodes Analysis\n\n<required_reading>\n**執行前閱讀：**\n1. references/methodology.md - 歷史類比邏輯\n2. references/valuation-metrics.md - 理解各指標的歷史背景\n</required_reading>\n\n<process>\n\n## Step 1: 確認分析範圍\n\n**必要參數**：\n- `history_start`: 歷史起算日（預設 1900-01-01，實際依資料可得性）\n- `episode_min_gap_days`: 事件去重間隔（預設 3650 天 = 10 年）\n- `forward_windows_days`: 事後分析視窗（預設 [180, 365, 1095]）\n\n**可選參數**：\n- `risk_readouts`: 要輸出的風險解讀項目\n  - `max_drawdown`: 最大回撤\n  - `forward_return`: 未來報酬\n  - `volatility_change`: 波動變化\n  - `valuation_reversion_speed`: 估值均值回歸速度\n\n## Step 2: 建立完整歷史合成分位數序列\n\n使用所有可得的歷史資料，計算「滾動分位數」：\n\n```python\n# 對每個時間點 t，計算「截至 t 的歷史分位數」\nrolling_percentile = []\nfor t in date_range:\n    history_up_to_t = data[:t]\n    current_value = data[t]\n    pct = percentile_rank(history_up_to_t, current_value)\n    rolling_percentile.append(pct)\n```\n\n這樣可以得到一條「歷史上每個時點的估值分位數」序列。\n\n## Step 3: 識別極端高估事件\n\n使用峰值偵測演算法：\n\n```python\ndef find_extreme_episodes(composite_series, threshold=95, min_gap_days=3650):\n    peaks = []\n    last_peak_date = None\n\n    for date, val in composite_series.items():\n        if val >= threshold:\n            if last_peak_date is None or (date - last_peak_date).days >= min_gap_days:\n                peaks.append(date)\n                last_peak_date = date\n            else:\n                # 同一段期間內只保留更高者\n                if composite_series[date] > composite_series[last_peak_date]:\n                    peaks[-1] = date\n                    last_peak_date = date\n\n    return peaks\n```\n\n**歷史上的主要極端事件**（以 CAPE 為例）：\n\n| 事件期間 | 背景 | CAPE 水準 | 後續發展 |\n|----------|------|-----------|----------|\n| 1929-09 | 大蕭條前夕 | ~33 | 崩跌 89% |\n| 1965-01 | Nifty Fifty | ~24 | 16 年實質報酬歸零 |\n| 1999-12 | 科技泡沫 | ~44 | 崩跌 50%+ |\n| 2021-12 | 疫情後牛市 | ~40 | 待觀察 |\n\n## Step 4: 計算每個事件的事後統計\n\n對識別出的每個極端事件，計算以下統計：\n\n### 4.1 未來報酬分布\n\n```python\ndef calculate_forward_returns(price_series, event_dates, windows=[180, 365, 1095]):\n    results = {}\n    for window in windows:\n        returns = []\n        for event_date in event_dates:\n            future_date = event_date + timedelta(days=window)\n            if future_date in price_series.index:\n                ret = price_series[future_date] / price_series[event_date] - 1\n                returns.append(ret)\n\n        results[f'{window}d'] = {\n            'median': np.median(returns),\n            'p25': np.percentile(returns, 25),\n            'p10': np.percentile(returns, 10),\n            'count': len(returns)\n        }\n    return results\n```\n\n### 4.2 最大回撤\n\n```python\ndef calculate_max_drawdown(price_series, event_dates, windows):\n    results = {}\n    for window in windows:\n        drawdowns = []\n        for event_date in event_dates:\n            end_date = event_date + timedelta(days=window)\n            period_prices = price_series[event_date:end_date]\n\n            rolling_max = period_prices.cummax()\n            drawdown = (period_prices - rolling_max) / rolling_max\n            max_dd = drawdown.min()\n            drawdowns.append(max_dd)\n\n        results[f'{window}d_max_drawdown'] = {\n            'median': np.median(drawdowns),\n            'p75': np.percentile(drawdowns, 75),\n            'worst': np.min(drawdowns)\n        }\n    return results\n```\n\n### 4.3 波動變化\n\n```python\ndef calculate_volatility_change(returns_series, event_dates, before_window=252, after_window=252):\n    vol_changes = []\n    for event_date in event_dates:\n        before_vol = returns_series[event_date - timedelta(days=before_window):event_date].std() * np.sqrt(252)\n        after_vol = returns_series[event_date:event_date + timedelta(days=after_window)].std() * np.sqrt(252)\n        vol_changes.append(after_vol - before_vol)\n\n    return {\n        'median_change': np.median(vol_changes),\n        'pct_increased': (np.array(vol_changes) > 0).mean()\n    }\n```\n\n## Step 5: 彙整風險解讀\n\n將統計結果轉化為可理解的風險解讀：\n\n**解讀框架**：\n\n```markdown\n## 歷史極端高估事件的後續表現\n\n當估值分位數接近 95-100 時，歷史上的特徵：\n\n### 未來報酬\n- **1 年後**: 中位數報酬 X%，下四分位 Y%\n- **3 年後**: 中位數報酬 A%，下四分位 B%\n- 正報酬機率：Z%\n\n### 回撤風險\n- **1 年最大回撤**: 中位數 -M%，最差情境 -N%\n- **3 年最大回撤**: 中位數 -P%，最差情境 -Q%\n\n### 波動特徵\n- 事件後 12 個月波動上升機率：R%\n- 波動中位數變化：+S 個百分點\n\n### 關鍵結論\n「估值極端高」不代表「立即崩盤」，但：\n1. 風險分布變得不對稱（下跌尾巴變厚）\n2. 未來中期報酬的不確定性大增\n3. 估值均值回歸會壓低長期報酬上限\n```\n\n## Step 6: 輸出報告\n\n產生歷史類比分析報告：\n\n```bash\npython scripts/valuation_percentile.py \\\n  --mode historical_episodes \\\n  --forward_windows \"180,365,1095\" \\\n  --risk_readouts \"max_drawdown,forward_return,volatility_change\" \\\n  --output \"output/historical_episodes.json\"\n```\n\n</process>\n\n<success_criteria>\n工作流程完成時：\n\n- [ ] 成功建立歷史合成分位數序列\n- [ ] 識別出所有極端高估事件（符合門檻）\n- [ ] 每個事件都計算了事後統計\n- [ ] 報酬、回撤、波動統計完整\n- [ ] 產生可理解的風險解讀框架\n- [ ] 輸出 JSON 或 Markdown 報告\n</success_criteria>\n\n<interpretation_notes>\n\n**解讀注意事項**：\n\n1. **樣本數有限**：百年歷史中極端高估事件可能只有 4-6 次，統計意義有限\n2. **時代背景不同**：1929 與 2021 的市場結構、央行政策、全球化程度差異巨大\n3. **倖存者偏差**：我們只看到美股這個「贏家」，其他市場的極端高估可能更慘\n4. **估值可以維持更久**：「估值高」可能持續數年，擇時風險巨大\n\n**建議用法**：\n- 作為「風險雷達」而非「擇時工具」\n- 極端高估 → 降低槓桿、增加防禦配置\n- 不要據此做空或完全離場\n</interpretation_notes>\n",
        "skills/detect-us-equity-valuation-percentile-extreme/workflows/visualize-analysis.md": "# Workflow: Visualize Valuation Analysis\n\n<required_reading>\n**執行前閱讀：**\n1. references/methodology.md - 了解分位數計算邏輯\n2. references/valuation-metrics.md - 估值指標定義\n</required_reading>\n\n<process>\n\n## Step 1: 確認環境\n\n確保已安裝所需套件：\n\n```bash\npip install pandas numpy matplotlib yfinance openpyxl xlrd\n```\n\n## Step 2: 執行視覺化分析\n\n```bash\ncd skills/detect-us-equity-valuation-percentile-extreme\npython scripts/visualize_valuation.py -o output\n```\n\n**參數說明**：\n- `-o, --output_dir`: 輸出目錄（預設 `output`）\n- `-d, --as_of_date`: 評估日期（預設今日）\n- `--show`: 顯示圖表視窗\n\n## Step 3: 輸出檔案\n\n執行成功後，輸出目錄會包含：\n\n```\noutput/\n├── us_valuation_percentile_YYYY-MM-DD.png   # 主要走勢圖\n├── us_valuation_breakdown_YYYY-MM-DD.png    # 指標分解圖\n└── us_valuation_analysis_YYYY-MM-DD.json    # JSON 結果\n```\n\n### 主要走勢圖說明\n\n圖表參考 @ekwufinance 風格，包含：\n\n1. **主軸（橙色）**：合成分位數時間序列\n   - 使用擴展視窗（expanding window）計算滾動分位數\n   - 每個時間點用該點之前所有歷史計算\n\n2. **次軸（藍色）**：S&P 500 指數（對數刻度）\n   - 顯示價格走勢與估值的對應關係\n\n3. **歷史峰值標記**：\n   - 1929：大蕭條前夕\n   - 1965：Nifty Fifty 時期\n   - 1999：科技泡沫頂點\n   - 2021：疫情後牛市頂點\n\n4. **當前位置標註**：\n   - 若處於極端高估，標註「New high as of [日期]」\n\n### 指標分解圖說明\n\n橫向條形圖，顯示各指標當前的歷史分位數：\n\n- **紅色**：>= 95%（極端高估）\n- **橙色**：>= 80%（高估）\n- **藍色**：< 80%（正常或偏低）\n\n包含的指標：\n- CAPE\n- Trailing P/E\n- Forward P/E\n- P/B\n- P/S\n- EV/EBITDA\n- Q Ratio\n- Mkt Cap to GDP\n\n## Step 4: 解讀結果\n\n檢查 JSON 結果中的關鍵欄位：\n\n```json\n{\n  \"summary\": {\n    \"composite_percentile\": 98.4,\n    \"is_extreme\": true,\n    \"status\": \"EXTREME_OVERVALUED\"\n  },\n  \"interpretation\": {\n    \"headline\": \"美股估值處於歷史極端高估區間（第 98 分位）\",\n    \"key_points\": [...]\n  }\n}\n```\n\n</process>\n\n<success_criteria>\n- [ ] 主要走勢圖已生成，包含歷史峰值標記\n- [ ] 指標分解圖已生成，顏色正確反映分位數水平\n- [ ] JSON 結果包含完整的分析數據\n- [ ] 當前位置已正確標註（若為極端）\n</success_criteria>\n\n<error_handling>\n\n| 錯誤 | 原因 | 解決方案 |\n|------|------|----------|\n| Shiller 資料抓取失敗 | 網路問題或 Excel 格式變更 | 安裝 `xlrd` 和 `openpyxl` |\n| 圖表字體問題 | 系統缺少中文字體 | 使用英文標題或安裝字體 |\n| 資料日期不匹配 | Shiller 資料有延遲 | 腳本會自動補充最新估計值 |\n\n</error_handling>\n",
        "skills/evaluate-exponential-trend-deviation-regimes/SKILL.md": "---\nname: evaluate-exponential-trend-deviation-regimes\ndescription: 計算資產價格相對長期指數成長趨勢線的偏離度，衡量當前是否處於歷史極端區間，並可選擇性地進行宏觀因子分析以判斷行情體質。\n---\n\n<essential_principles>\n**資產趨勢偏離度分析 核心原則**\n\n<principle name=\"exponential_trend_fitting\">\n**指數趨勢線擬合**\n多數資產在長期（數十年）尺度上遵循指數成長路徑。透過對數價格線性回歸（y = a + b*t where y = log(price)）擬合趨勢線，trend = exp(a + b*t)。偏離度 = (price / trend - 1) × 100%。\n</principle>\n\n<principle name=\"historical_context\">\n**歷史極端對照**\n透過計算當前偏離度在歷史分布中的分位數，以及與歷史峰值/谷值的比較，提供市場位置的脈絡。使用者可指定特定日期作為參考點，或由系統自動識別歷史極端值。\n</principle>\n\n<principle name=\"regime_classification\">\n**行情體質判定（選用）**\n針對特定資產（如黃金、股指），可結合宏觀因子進行行情體質分析。不同資產有不同的體質分類框架，使用者可自定義判定規則與因子權重。\n</principle>\n\n<principle name=\"universal_applicability\">\n**通用適用性**\n本技能適用於任何具有長期指數成長特性的資產：商品（黃金、原油）、股票指數、加密貨幣、房地產等。核心邏輯不預設特定資產或歷史峰值。\n</principle>\n</essential_principles>\n\n<intake>\n**您想要執行什麼操作？**\n\n1. **單資產偵測** - 計算單一資產的趨勢偏離度與歷史分位數\n2. **歷史對照分析** - 將當前偏離度與使用者指定的歷史日期或自動識別的極端值進行比較\n3. **宏觀因子分解** - 詳細拆解各宏觀代理指標對行情體質判定的貢獻（適用於支援的資產類別）\n\n**等待回應後再繼續。**\n</intake>\n\n<routing>\n| Response                           | Workflow              | Description |\n|------------------------------------|-----------------------|-------------|\n| 1, \"detect\", \"single\", \"偵測\"      | workflows/detect.md   | 單資產趨勢偏離度偵測與體質判定 |\n| 2, \"compare\", \"historical\", \"對照\" | workflows/compare.md  | 歷史峰值詳細對照分析 |\n| 3, \"macro\", \"breakdown\", \"因子\"    | workflows/macro.md    | 宏觀因子分解與貢獻度分析 |\n\n**讀取工作流程後，請完全遵循其步驟。**\n</routing>\n\n<quick_start>\n**快速開始**\n\n```bash\n# 安裝依賴\npip install pandas numpy yfinance pandas-datareader statsmodels\n\n# 快速偵測（範例：黃金期貨）\ncd skills/evaluate-exponential-trend-deviation-regimes\npython scripts/trend_deviation.py --symbol GC=F --quick\n\n# 分析其他資產（範例：S&P 500）\npython scripts/trend_deviation.py --symbol ^GSPC --start 1950-01-01\n\n# 完整分析（含宏觀因子，目前支援黃金）\npython scripts/trend_deviation.py --symbol GC=F --start 1970-01-01 --include-macro\n\n# 指定歷史參考日期\npython scripts/trend_deviation.py --symbol GC=F --compare-peaks \"2011-09-06,2020-08-07\"\n\n# 生成視覺化圖表（輸出 PNG + JSON）\npython scripts/generate_chart.py --output ./output/\n```\n</quick_start>\n\n<reference_index>\n**參考文件** (`references/`)\n\n| 文件 | 內容 |\n|------|------|\n| input-schema.md | 輸入參數詳細定義與驗證規則 |\n| methodology.md | 指數趨勢擬合與偏離度計算方法論 |\n| regime-rules.md | 1970s-like vs 2000s-like 體質判定規則 |\n| data-sources.md | 數據來源與替代方案說明 |\n</reference_index>\n\n<workflows_index>\n| Workflow | Purpose |\n|----------|---------|\n| detect.md | 單資產趨勢偏離度偵測與體質判定 |\n| compare.md | 歷史峰值詳細對照分析 |\n| macro.md | 宏觀因子分解與貢獻度分析 |\n</workflows_index>\n\n<templates_index>\n| Template | Purpose |\n|----------|---------|\n| output-json.md | JSON 輸出結構定義 |\n| output-markdown.md | Markdown 報告輸出模板 |\n</templates_index>\n\n<scripts_index>\n| Script | Purpose |\n|--------|---------|\n| trend_deviation.py | 主要分析腳本：趨勢擬合、偏離度計算、體質判定 |\n| generate_chart.py | 視覺化圖表生成：偏離度歷史圖表與峰值標註 |\n</scripts_index>\n\n<examples_index>\n**範例輸出** (`examples/`)\n\n| 文件 | 內容 |\n|------|------|\n| gold-deviation-2026.json | 2026 年黃金趨勢偏離度分析範例 |\n</examples_index>\n\n<success_criteria>\nSkill 成功執行時：\n- [ ] 成功擬合黃金價格的指數趨勢線\n- [ ] 計算出當前偏離度百分比與歷史分位數\n- [ ] 與 2011/1980 峰值進行有效比較\n- [ ] 綜合宏觀代理指標得出 regime 判定（1970s-like / 2000s-like）\n- [ ] 輸出完整的 JSON 或 Markdown 報告\n- [ ] （選用）生成視覺化圖表（PNG）標註歷史峰值與當前位置\n</success_criteria>\n",
        "skills/evaluate-exponential-trend-deviation-regimes/examples/gold-trend-deviation.md": "# 黃金趨勢偏離度分析範例\n\n本文件說明如何使用此工具分析黃金價格的趨勢偏離度與行情體質。\n\n## 黃金專屬特性\n\n### 歷史峰值參考點\n\n黃金有兩個重要的歷史峰值：\n\n| 日期 | 峰值偏離度 | 歷史脈絡 |\n|------|-----------|----------|\n| 1980-01-31 | ~288% | 1970s 高通膨終局 |\n| 2011-08-31 | ~83% | 後金融危機 QE 擔憂 |\n| 2025-12-31 | ~100% | 當前（已超越 2011 峰值） |\n\n### 行情體質分類（1970s-like vs 2000s-like）\n\n#### 1970s-like（去信任法幣/通膨風險主導）\n\n**特徵**：\n- 實質利率長期為負\n- 通膨或通膨預期持續走升\n- 地緣政治緊張\n- 美元走弱\n\n**黃金行為**：\n- 可以維持極端偏離很長時間\n- 波動性增加\n- 作為「去信任法幣」的避險工具\n\n#### 2000s-like（成長/資產配置驅動）\n\n**特徵**：\n- 通膨相對溫和\n- 需求和資產配置驅動較強\n- 實質利率不一定長期為負\n\n**黃金行為**：\n- 偏離度更容易回歸均值\n- 作為「資產配置」的一環\n\n## 使用範例\n\n### 基本分析（不含宏觀因子）\n\n```bash\npython scripts/trend_deviation.py \\\n  --symbol GC=F \\\n  --start 1970-01-01 \\\n  --compare-peaks \"2011-09-06,1980-01-21\"\n```\n\n### 完整分析（含宏觀因子與行情體質判定）\n\n```bash\npython scripts/trend_deviation.py \\\n  --symbol GC=F \\\n  --start 1970-01-01 \\\n  --include-macro \\\n  --compare-peaks \"2011-09-06,1980-01-21\"\n```\n\n### 快速模式\n\n```bash\npython scripts/trend_deviation.py --symbol GC=F --quick\n```\n\n## 範例輸出\n\n見 `gold-deviation-2026.json`\n\n## 宏觀因子說明\n\n### 實質利率（Real Rate）\n\n- **數據來源**：FRED DFII10（10 年 TIPS 收益率）\n- **權重**：0.30\n- **判定規則**：負值 → 支持 1970s-like\n\n### 通膨預期（Inflation Expectation）\n\n- **數據來源**：FRED T5YIE（5 年 Breakeven 通膨率）\n- **權重**：0.25\n- **判定規則**：上升趨勢 → 支持 1970s-like\n\n### 美元指數（USD Index）\n\n- **數據來源**：FRED DTWEXBGS（貿易加權美元指數）\n- **權重**：0.20\n- **判定規則**：下降趨勢 → 支持 1970s-like\n\n### 地緣政治風險（Geopolitical Risk）\n\n- **數據來源**：GPR 指數（或新聞關鍵詞計數替代）\n- **權重**：0.25\n- **判定規則**：上升趨勢 → 支持 1970s-like\n\n## 歷史案例\n\n### 1970s（典型 1970s-like）\n\n| 因子 | 狀態 | 分數 |\n|------|------|------|\n| 實質利率 | 深度負利率（-4% to -6%） | 1.0 |\n| 通膨 | 高且上升（8%-14%） | 1.0 |\n| 地緣風險 | 高（石油危機、越戰） | 1.0 |\n| 美元 | 大幅走弱 | 1.0 |\n| **總分** | | **1.0** |\n\n**結果**：黃金從 $35 漲到 $850，偏離度達 288%。\n\n### 2000s-2011（混合特徵）\n\n| 因子 | 狀態 | 分數 |\n|------|------|------|\n| 實質利率 | 低但不一定負 | 0.5 |\n| 通膨 | 溫和（2%-3%） | 0.3 |\n| 地緣風險 | 中等偏高（911後、伊拉克戰爭） | 0.6 |\n| 美元 | 先弱後穩 | 0.5 |\n| **總分** | | **0.45** |\n\n**結果**：黃金從 $250 漲到 $1900，偏離度約 85%，之後回調。\n\n## 使用建議\n\n### 體質判定的用途\n\n1. **風險評估**：1970s-like 體質下，高偏離度可能持續更久\n2. **策略調整**：不同體質下，停損和倉位策略應有所不同\n3. **情境規劃**：考慮體質轉變的可能性和觸發條件\n\n### 不應用於\n\n1. **短期交易訊號**：體質是中長期概念\n2. **精確擇時**：體質判定是模糊的，不適合精確擇時\n3. **單獨決策依據**：應結合其他分析工具使用\n\n### 體質轉變的觸發條件\n\n**從 1970s-like → 2000s-like**：\n- 央行大幅升息，實質利率轉正\n- 通膨預期被錨定\n- 地緣風險緩和\n\n**從 2000s-like → 1970s-like**：\n- 通膨失控\n- 央行政策失去公信力\n- 重大地緣衝突\n",
        "skills/evaluate-exponential-trend-deviation-regimes/methodology.md": "# 用「指數成長趨勢線偏離度」解讀黃金：原理與應用（以本案例為例）\n\n## 這個方法在做什麼？\n這套分析方式的核心是：**先替資產價格建立一條「長期的指數成長基準線（Exponential Growth Trendline）」**，再觀察目前價格**偏離這條基準線的百分比**，用來判斷市場是否處在「相對歷史基準的過熱／低估／正常」區間。\n\n可以把它想像成一個「長期重力場」：\n- 趨勢線 = 資產長期複利式成長的“正常軌道”\n- 偏離度 = 當前價格離正常軌道有多遠（市場情緒、通膨、地緣風險等因素常會把價格推離軌道）\n\n---\n\n## 原理：為什麼用「指數成長」而不是直線？\n很多長期資產價格（尤其具有貨幣屬性或供給限制特性的資產）在超長期尺度上更接近「複利式」增長，而不是固定斜率的線性增長。\n\n### 典型做法（可工程化）\n1) 取價格序列 `P(t)`  \n2) 對價格取對數：`log(P(t))`  \n3) 對時間做線性擬合：`log(P(t)) ≈ a + b·t`  \n4) 還原成指數趨勢線：`Trend(t) = exp(a + b·t)`\n\n這等價於假設價格的「長期平均成長率」相對穩定，但允許短中期圍繞趨勢大幅波動。\n\n---\n\n## 核心指標：偏離度（Distance %）\n偏離度用一個非常直觀的量衡量：\n\n> **偏離度（%） = ( 當前價格 / 趨勢線價格 - 1 ) × 100%**\n\n- 偏離度為正：價格在趨勢線上方（偏熱、情緒/風險溢價較高）\n- 偏離度為負：價格在趨勢線下方（偏冷、可能被低估或景氣/流動性壓抑）\n\n---\n\n## 這個方法能回答什麼問題？\n### 1) 「現在貴不貴？」（相對長期基準）\n不是用主觀感覺，而是用「相對長期複利軌道的距離」回答。\n\n### 2) 「跟歷史高點比，現在是不是更極端？」\n把現在的偏離度拿去跟 2011、1980 等歷史階段比，比較的是**同一口徑的“相對過熱程度”**，而不只是名目價格。\n\n### 3) 「敘事更像哪個年代？」（1970s vs 2000s）\n偏離度提供「市場溫度」，但要判斷像不像 1970s，還需要搭配宏觀代理指標：\n- **1970s-like**：高通膨壓力、地緣衝突升溫、實質利率偏低/為負、法幣信心侵蝕  \n- **2000s-like**：通膨較溫和、成長/金融循環更主導、實質利率不一定長期深負值  \n\n換句話說：  \n**偏離度 = 現象**  \n**宏觀因子 = 原因與體質**\n\n---\n\n## 應用方式：可以怎麼用它？\n### A. 風險管理（避免只看“漲很多”或“新高”）\n- 偏離度進入歷史極端區 → **提高波動/回撤風險意識**（不等於立刻反轉，但風險溢酬變得不對稱）\n- 偏離度回到中性區 → 可能是「情緒退潮」或「宏觀條件變化」後的再平衡\n\n### B. 歷史情境比對（同口徑比較）\n- 用偏離度比對不同年代的高點，避免被名目價格尺度誤導  \n  （例如 1980 與 2011 的名目價格不可直接相比，但偏離度可以比）\n\n### C. 敘事驗證（把推文變成可檢驗的框架）\n- 推文說「法幣信心下滑、地緣/通膨風險升高 → 更像 1970s」\n- 可以用偏離度 + 宏觀代理來驗證：  \n  1) 偏離度是否處在極端上方？  \n  2) 實質利率是否走低/為負？  \n  3) 通膨預期是否走升？  \n  4) 地緣風險 proxy 是否上升？\n\n---\n\n## 本案例怎麼解讀（以貼文內容為例）\n貼文重點是兩句話：\n\n1) **「雖然黃金用這個指標已超過 2011 的市場高點」**  \n   - 這句話指的不是“金價名目價格超過 2011”，而是：  \n     **「相對指數成長趨勢線的偏離度」已經比 2011 當時更高**  \n   - 代表市場目前對黃金的定價，**相對長期基準更偏熱**，反映更強的風險溢價/避險需求/貨幣信心因素。\n\n2) **「法幣信心持續侵蝕；地緣緊張與通膨風險上升 → 走勢可能更像 1970s 而不是 2000s」**  \n   - 這是在把「偏離度變高」的現象，歸因到「宏觀體質」：  \n     - 地緣風險升溫（避險需求）\n     - 通膨風險（貨幣購買力焦慮）\n     - 法幣信心下降（黃金的貨幣替代性上升）\n   - 因此作者推論：若上述條件延續，黃金可能出現更像 1970s 那種「更長、更猛、更情緒化」的上行階段，而不是 2000s 相對溫和的通道式上漲。\n\n---\n\n## 一句話總結\n**「指數成長趨勢線偏離度」用來量化資產相對長期複利基準的“溫度”；再用實質利率、通膨與地緣風險等宏觀代理，判斷這種過熱是否更像 1970s 式的法幣信任危機行情。**",
        "skills/evaluate-exponential-trend-deviation-regimes/references/data-sources.md": "# 數據來源說明\n\n本文件說明 evaluate-exponential-trend-deviation-regimes 技能使用的數據來源。\n\n## 資產價格\n\n### 首選：Yahoo Finance（yfinance）\n\n適用於幾乎所有資產類型：股票、期貨、ETF、指數、加密貨幣等。\n\n| 項目 | 說明 |\n|------|------|\n| API | `yfinance.Ticker(symbol).history()` |\n| 費用 | 免費，無需 API key |\n| 頻率 | 日頻（可轉換為月頻） |\n\n```python\nimport yfinance as yf\nimport pandas as pd\n\ndef fetch_asset_yahoo(symbol: str, start: str, end: str) -> pd.DataFrame:\n    \"\"\"從 Yahoo Finance 下載資產價格\"\"\"\n    ticker = yf.Ticker(symbol)\n    df = ticker.history(start=start, end=end)\n    return df[[\"Close\"]].rename(columns={\"Close\": \"price\"})\n```\n\n**支援的資產範例**：\n\n| 資產類型 | 代碼範例 | 歷史數據長度 |\n|----------|----------|--------------|\n| 黃金期貨 | GC=F | ~2000 年起 |\n| 白銀期貨 | SI=F | ~2000 年起 |\n| 原油期貨 | CL=F | ~1983 年起 |\n| S&P 500 | ^GSPC | ~1950 年起 |\n| 納斯達克 | ^IXIC | ~1971 年起 |\n| 比特幣 | BTC-USD | ~2014 年起 |\n| 以太坊 | ETH-USD | ~2017 年起 |\n| 黃金 ETF | GLD | ~2004 年起 |\n\n### 替代：Stooq（黃金長期分析推薦）\n\n適用於需要更長歷史數據的情況。**黃金完整歷史分析（1970+）建議使用 Stooq**。\n\n| 項目 | 說明 |\n|------|------|\n| API | CSV 下載 |\n| 費用 | 免費 |\n| 歷史 | 部分資產可達 1970 年代 |\n\n**黃金專用**：使用 `xauusd` 符號可取得 1970 年起的月頻數據：\n\n```python\nurl = 'https://stooq.com/q/d/l/?s=xauusd&d1=19700101&d2=20260115&i=m'\ngold = pd.read_csv(url)\n```\n\n```python\nimport pandas as pd\n\ndef fetch_asset_stooq(symbol: str, start: str, end: str) -> pd.DataFrame:\n    \"\"\"從 Stooq 下載資產價格\"\"\"\n    # Stooq 使用不同的符號格式，需要轉換\n    stooq_symbol = symbol.replace(\"^\", \"\").lower()\n    url = f\"https://stooq.com/q/d/l/?s={stooq_symbol}&d1={start.replace('-','')}&d2={end.replace('-','')}&i=d\"\n    df = pd.read_csv(url)\n    df[\"Date\"] = pd.to_datetime(df[\"Date\"])\n    df = df.set_index(\"Date\").sort_index()\n    return df[[\"Close\"]].rename(columns={\"Close\": \"price\"})\n```\n\n### 特殊數據來源\n\n**黃金長期歷史數據**（1970 年前）：\n\n| 來源 | 說明 |\n|------|------|\n| FRED | GOLDAMGBD228NLBM（倫敦黃金定盤價） |\n| World Gold Council | 歷史黃金價格 |\n\n**股票指數長期數據**：\n\n| 來源 | 說明 |\n|------|------|\n| Robert Shiller's Data | S&P 500 自 1871 年起 |\n| Kenneth French Data Library | 各類因子與指數 |\n\n## 宏觀代理指標\n\n### FRED（Federal Reserve Economic Data）\n\n使用 `pandas-datareader` 套件存取。\n\n#### 實質利率\n\n| 代碼 | 名稱 | 說明 |\n|------|------|------|\n| DFII10 | 10-Year TIPS | 10 年期 TIPS 收益率（實質利率代理） |\n| REAINTRATREARAT10Y | 10-Year Real Interest Rate | 替代指標 |\n\n```python\nimport pandas_datareader as pdr\n\ndef fetch_real_rate(start: str, end: str) -> pd.Series:\n    \"\"\"從 FRED 下載實質利率\"\"\"\n    df = pdr.DataReader(\"DFII10\", \"fred\", start, end)\n    return df[\"DFII10\"]\n```\n\n#### 通膨預期\n\n| 代碼 | 名稱 | 說明 |\n|------|------|------|\n| T5YIE | 5-Year Breakeven | 5 年期損益平衡通膨率 |\n| T10YIE | 10-Year Breakeven | 10 年期損益平衡通膨率 |\n| T5YIFR | 5-Year, 5-Year Forward | 5y5y 遠期通膨預期 |\n\n```python\ndef fetch_inflation_expectation(start: str, end: str) -> pd.Series:\n    \"\"\"從 FRED 下載通膨預期\"\"\"\n    df = pdr.DataReader(\"T5YIE\", \"fred\", start, end)\n    return df[\"T5YIE\"]\n```\n\n#### 美元指數\n\n| 代碼 | 名稱 | 說明 |\n|------|------|------|\n| DTWEXBGS | Trade Weighted USD | 貿易加權美元指數（廣義） |\n| DTWEXAFEGS | Trade Weighted USD (AFE) | 貿易加權美元（先進經濟體） |\n\n```python\ndef fetch_usd_index(start: str, end: str) -> pd.Series:\n    \"\"\"從 FRED 下載美元指數\"\"\"\n    df = pdr.DataReader(\"DTWEXBGS\", \"fred\", start, end)\n    return df[\"DTWEXBGS\"]\n```\n\n### 地緣政治風險\n\n#### GPR Index（首選但不公開）\n\nCaldara-Iacoviello Geopolitical Risk Index\n\n- 官網：https://www.matteoiacoviello.com/gpr.htm\n- 需手動下載或申請 API\n\n#### 新聞關鍵詞計數（替代）\n\n使用 GDELT 或其他新聞 API 計算關鍵詞出現次數。\n\n```python\ndef estimate_geopolitical_risk(lookback_days: int = 30) -> float:\n    \"\"\"\n    估算地緣政治風險（使用新聞關鍵詞）\n\n    Returns:\n        0-100 的風險分數\n    \"\"\"\n    keywords = [\"war\", \"conflict\", \"sanction\", \"military\", \"tension\", \"crisis\"]\n    # 實作：使用新聞 API 計算關鍵詞頻率\n    # 此處為示意，實際需接入新聞 API\n    return 50.0  # placeholder\n```\n\n## 數據頻率轉換\n\n### 日頻轉月頻\n\n```python\ndef to_monthly(daily_data: pd.Series) -> pd.Series:\n    \"\"\"將日頻數據轉為月頻\"\"\"\n    return daily_data.resample(\"M\").last()\n```\n\n### 處理缺失值\n\n```python\ndef handle_missing(data: pd.Series, method: str = \"ffill\") -> pd.Series:\n    \"\"\"處理缺失值\"\"\"\n    if method == \"ffill\":\n        return data.ffill()\n    elif method == \"interpolate\":\n        return data.interpolate()\n    else:\n        return data.dropna()\n```\n\n## 數據品質檢查\n\n### 異常值檢測\n\n```python\ndef detect_outliers(data: pd.Series, n_std: float = 3.0) -> pd.Series:\n    \"\"\"檢測異常值\"\"\"\n    mean = data.mean()\n    std = data.std()\n    is_outlier = (data - mean).abs() > n_std * std\n    return is_outlier\n```\n\n### 數據連續性檢查\n\n```python\ndef check_continuity(data: pd.Series, max_gap_days: int = 5) -> list:\n    \"\"\"檢查數據連續性\"\"\"\n    gaps = []\n    dates = data.index.to_series()\n    diff = dates.diff().dt.days\n    large_gaps = diff[diff > max_gap_days]\n    for idx, gap in large_gaps.items():\n        gaps.append({\"date\": idx, \"gap_days\": gap})\n    return gaps\n```\n\n## 錯誤處理\n\n### 數據不可用時的備援\n\n```python\ndef fetch_with_fallback(primary_func, fallback_func, *args, **kwargs):\n    \"\"\"帶備援的數據抓取\"\"\"\n    try:\n        return primary_func(*args, **kwargs)\n    except Exception as e:\n        logger.warning(f\"Primary source failed: {e}, trying fallback\")\n        return fallback_func(*args, **kwargs)\n\n# 使用範例\ngold_prices = fetch_with_fallback(\n    fetch_gold_yahoo,\n    fetch_gold_stooq,\n    start=\"1970-01-01\",\n    end=\"2026-01-15\"\n)\n```\n\n### 部分數據可用時的處理\n\n```python\ndef analyze_with_partial_data(gold_prices, macro_data: dict) -> dict:\n    \"\"\"\n    使用部分可用數據進行分析\n\n    如果某些宏觀數據不可用，仍可輸出偏離度分析，\n    但 regime 判定的信心度會降低。\n    \"\"\"\n    result = {\n        \"deviation_analysis\": calculate_deviation(gold_prices),\n        \"regime\": None,\n        \"warnings\": []\n    }\n\n    available_factors = sum(1 for v in macro_data.values() if v is not None)\n    total_factors = len(macro_data)\n\n    if available_factors == 0:\n        result[\"warnings\"].append(\"No macro data available, regime analysis skipped\")\n    elif available_factors < total_factors:\n        result[\"warnings\"].append(\n            f\"Only {available_factors}/{total_factors} macro factors available, \"\n            \"regime confidence reduced\"\n        )\n        result[\"regime\"] = calculate_regime_partial(macro_data)\n    else:\n        result[\"regime\"] = calculate_regime(macro_data)\n\n    return result\n```\n\n## API 使用限制\n\n| 來源 | 限制 | 建議 |\n|------|------|------|\n| Yahoo Finance | 無官方限制，但過於頻繁可能被封鎖 | 加入隨機延遲 |\n| FRED | 無限制（公共數據） | 正常使用即可 |\n| Stooq | 無官方限制 | 加入隨機延遲 |\n\n## 數據更新頻率\n\n| 數據 | 更新頻率 | 建議抓取頻率 |\n|------|----------|--------------|\n| 黃金價格 | 每個交易日 | 每日或每週 |\n| TIPS 收益率 | 每個交易日 | 每週 |\n| 通膨預期 | 每個交易日 | 每週 |\n| 美元指數 | 每個交易日 | 每週 |\n| GPR | 每月 | 每月 |\n",
        "skills/evaluate-exponential-trend-deviation-regimes/references/input-schema.md": "# 輸入參數定義\n\n本文件定義 evaluate-exponential-trend-deviation-regimes 技能的所有輸入參數。\n\n## 必要參數\n\n### symbol (string)\n\n資產標的代碼。\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 必要 | 是 |\n| 預設值 | 無（必須提供） |\n\n**範例值**：\n- `GC=F` - COMEX 黃金期貨（Yahoo Finance）\n- `SI=F` - COMEX 白銀期貨\n- `CL=F` - NYMEX 原油期貨\n- `^GSPC` - S&P 500 指數\n- `BTC-USD` - 比特幣\n- `GLD` - SPDR Gold Shares ETF\n\n### start_date (string)\n\n計算用歷史起點，格式為 YYYY-MM-DD。\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 必要 | 建議提供 |\n| 預設值 | \"2000-01-01\"（保守預設） |\n| 格式 | YYYY-MM-DD |\n\n**建議**：根據資產特性提供適當的起始日期，以捕捉完整的歷史週期。\n- 黃金：1970-01-01（布雷頓森林體系瓦解後）\n- S&P 500：1950-01-01\n- 比特幣：2013-01-01\n- 原油：1980-01-01\n\n## 選用參數\n\n### end_date (string)\n\n結束日期，格式為 YYYY-MM-DD。\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 必要 | 否 |\n| 預設值 | today |\n| 格式 | YYYY-MM-DD |\n\n### trend_fit_window (string)\n\n趨勢線擬合區間策略。\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 必要 | 否 |\n| 預設值 | \"full\" |\n\n**可接受的值**：\n- `full` - 全樣本擬合（推薦）\n- `rolling` - 滾動窗口擬合（用於觀察趨勢斜率變化）\n\n### trend_model (string)\n\n趨勢模型類型。\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 必要 | 否 |\n| 預設值 | \"exponential_log_linear\" |\n\n**可接受的值**：\n- `exponential_log_linear` - 對數價格線性回歸（推薦）\n\n### compare_peak_dates (list[string])\n\n需要比較的歷史峰值日期（選用）。\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | list[string] |\n| 必要 | 否 |\n| 預設值 | null（自動偵測歷史極值） |\n| 格式 | YYYY-MM-DD |\n\n**說明**：\n- 若不提供，系統會自動識別歷史最大/最小偏離度\n- 若提供，將與指定日期的偏離度進行比較\n\n**範例**（黃金）：\n- `2011-09-06` - 後金融危機黃金峰值\n- `1980-01-21` - 1970s 高通膨黃金峰值\n\n**範例**（股市）：\n- `2000-03-24` - 科技泡沫峰值\n- `2007-10-09` - 金融危機前峰值\n- `2020-02-19` - 疫情前峰值\n\n### macro_proxies (object)\n\n宏觀代理指標設定。\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | object |\n| 必要 | 否 |\n\n**子欄位**：\n\n| 欄位 | 類型 | 預設值 | 說明 |\n|------|------|--------|------|\n| real_rate_series | string | \"DFII10\" | 實質利率序列（FRED） |\n| inflation_series | string | \"T5YIE\" | 通膨預期序列（FRED） |\n| usd_series | string | \"DTWEXBGS\" | 美元指數序列（FRED） |\n| geopolitical_risk_series | string | null | 地緣風險序列 |\n\n### regime_rules (object)\n\n1970s-like vs 2000s-like 的判定閾值。\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | object |\n| 必要 | 否 |\n\n**子欄位**：\n\n| 欄位 | 類型 | 預設值 | 說明 |\n|------|------|--------|------|\n| real_rate_weight | float | 0.30 | 實質利率因子權重 |\n| inflation_weight | float | 0.25 | 通膨因子權重 |\n| geopolitical_weight | float | 0.25 | 地緣風險因子權重 |\n| usd_weight | float | 0.20 | 美元因子權重 |\n| threshold_1970s | float | 0.50 | 判定為 1970s-like 的分數門檻 |\n\n### output_format (string)\n\n輸出格式。\n\n| 屬性 | 值 |\n|------|-----|\n| 類型 | string |\n| 必要 | 否 |\n| 預設值 | \"json\" |\n\n**可接受的值**：\n- `json` - JSON 格式輸出\n- `markdown` - Markdown 格式報告\n\n## 參數驗證規則\n\n### 日期驗證\n\n```python\ndef validate_date(date_str: str) -> bool:\n    \"\"\"驗證日期格式\"\"\"\n    try:\n        datetime.strptime(date_str, \"%Y-%m-%d\")\n        return True\n    except ValueError:\n        return False\n\ndef validate_date_range(start: str, end: str) -> bool:\n    \"\"\"驗證日期範圍\"\"\"\n    start_dt = datetime.strptime(start, \"%Y-%m-%d\")\n    end_dt = datetime.strptime(end, \"%Y-%m-%d\")\n    return start_dt < end_dt\n```\n\n### Symbol 驗證\n\n```python\ndef validate_symbol(symbol: str) -> bool:\n    \"\"\"\n    驗證資產代碼\n\n    接受所有 Yahoo Finance 支援的代碼格式\n    \"\"\"\n    # 期貨合約 (以 =F 結尾)\n    if symbol.endswith(\"=F\"):\n        return True\n    # 指數 (以 ^ 開頭)\n    if symbol.startswith(\"^\"):\n        return True\n    # 加密貨幣 (包含 -USD, -EUR 等)\n    if \"-\" in symbol and symbol.split(\"-\")[1] in [\"USD\", \"EUR\", \"BTC\"]:\n        return True\n    # 一般股票/ETF (大寫字母和數字)\n    if symbol.isalnum() and symbol.isupper():\n        return True\n    return False\n```\n\n### 權重驗證\n\n```python\ndef validate_weights(weights: dict) -> bool:\n    \"\"\"驗證權重總和為 1\"\"\"\n    total = sum([\n        weights.get(\"real_rate_weight\", 0.3),\n        weights.get(\"inflation_weight\", 0.25),\n        weights.get(\"geopolitical_weight\", 0.25),\n        weights.get(\"usd_weight\", 0.2),\n    ])\n    return abs(total - 1.0) < 0.01\n```\n\n## 範例輸入\n\n### 基本使用（黃金）\n\n```json\n{\n  \"symbol\": \"GC=F\",\n  \"start_date\": \"1970-01-01\"\n}\n```\n\n### 基本使用（S&P 500）\n\n```json\n{\n  \"symbol\": \"^GSPC\",\n  \"start_date\": \"1950-01-01\"\n}\n```\n\n### 完整參數（黃金含宏觀分析）\n\n```json\n{\n  \"symbol\": \"GC=F\",\n  \"start_date\": \"1970-01-01\",\n  \"end_date\": \"2026-01-15\",\n  \"trend_fit_window\": \"full\",\n  \"trend_model\": \"exponential_log_linear\",\n  \"compare_peak_dates\": [\"2011-09-06\", \"1980-01-21\"],\n  \"macro_proxies\": {\n    \"real_rate_series\": \"DFII10\",\n    \"inflation_series\": \"T5YIE\",\n    \"usd_series\": \"DTWEXBGS\",\n    \"geopolitical_risk_series\": null\n  },\n  \"regime_rules\": {\n    \"real_rate_weight\": 0.30,\n    \"inflation_weight\": 0.25,\n    \"geopolitical_weight\": 0.25,\n    \"usd_weight\": 0.20,\n    \"threshold_1970s\": 0.50\n  },\n  \"output_format\": \"json\"\n}\n```\n\n### 完整參數（比特幣）\n\n```json\n{\n  \"symbol\": \"BTC-USD\",\n  \"start_date\": \"2013-01-01\",\n  \"end_date\": \"2026-01-15\",\n  \"trend_fit_window\": \"full\",\n  \"trend_model\": \"exponential_log_linear\",\n  \"compare_peak_dates\": [\"2021-11-10\", \"2017-12-17\"],\n  \"output_format\": \"json\"\n}\n```\n",
        "skills/evaluate-exponential-trend-deviation-regimes/references/methodology.md": "### 資產長期遵循指數成長\n\n許多資產在長期（數十年）尺度上遵循指數成長路徑，主要原因：\n\n1. **經濟成長**：全球經濟、貨幣供應量長期以指數方式增長\n2. **複利效應**：任何穩定的成長率在長期都會表現為指數形式\n3. **通膨因素**：名目價格會隨著通膨而增長\n\n**適用資產範例**：\n- **商品**：黃金、白銀、原油（受貨幣供應與購買力影響）\n- **股票指數**：S&P 500、NASDAQ（受經濟成長與盈利成長驅動）\n- **加密貨幣**：比特幣、以太坊（受採用率與網絡效應驅動）\n- **房地產**：房價指數（受收入成長與都市化影響）\n\n### 偏離度的意義\n\n偏離度衡量當前價格與「公允長期趨勢」的距離：\n\n- **正偏離**：價格高於趨勢，可能反映過度樂觀或極端事件\n- **負偏離**：價格低於趨勢，可能反映過度悲觀或錯誤定價\n",
        "skills/evaluate-exponential-trend-deviation-regimes/references/regime-rules.md": "# 行情體質判定規則\n\n本文件定義資產行情體質的判定規則。\n\n**重要說明**：\n- 本文件主要描述**黃金專屬**的 1970s-like vs 2000s-like 體質判定\n- 其他資產需要定義不同的體質分類和驅動因子\n- 若對非黃金資產啟用宏觀分析，需自行設計適當的因子\n\n## 概念基礎\n\n### 什麼是「行情體質」？\n\n行情體質描述當前市場的宏觀驅動因素組合，決定了：\n\n1. 資產上漲的持續性\n2. 偏離度回歸的可能性\n3. 適合的交易/配置策略\n\n### 黃金的特殊性\n\n黃金作為貨幣替代品和通膨對沖工具，其行情體質主要由貨幣政策、通膨環境、地緣風險決定，因此有獨特的體質分類方法。\n\n### 黃金的兩種典型體質\n\n| 體質 | 主要驅動 | 黃金角色 | 偏離度特性 |\n|------|----------|----------|------------|\n| **1970s-like** | 高通膨、法幣信心下滑、地緣風險 | 避險/對沖通膨 | 可維持極端偏離較長時間 |\n| **2000s-like** | 成長、資產配置、適度通膨 | 多元化資產 | 偏離度較容易回歸均值 |\n\n### 其他資產的體質定義（範例）\n\n**股票指數**：\n- **Risk-On**：經濟成長、盈利擴張、低波動\n- **Risk-Off**：衰退擔憂、盈利下修、避險情緒\n\n**比特幣**：\n- **機構採用期**：主流接受度提升、法規友善、機構配置增加\n- **投機主導期**：零售情緒驅動、槓桿過度、監管不確定性\n\n## 判定因子\n\n### 1. 實質利率（Real Rate）\n\n**定義**：名目利率 - 通膨預期\n\n**數據代理**：\n- 首選：10Y TIPS 收益率（FRED: DFII10）\n- 替代：FFR - Core CPI YoY\n\n**判定規則**：\n\n```python\ndef score_real_rate(real_rate: float, trend: str) -> float:\n    \"\"\"\n    評分實質利率因子\n\n    Args:\n        real_rate: 當前實質利率（%）\n        trend: \"up\" / \"down\" / \"flat\"\n\n    Returns:\n        0-1 的分數，1 = 完全支持 1970s-like\n    \"\"\"\n    score = 0.0\n\n    # 負實質利率強烈支持 1970s-like\n    if real_rate < 0:\n        score = 1.0\n    elif real_rate < 1.0:\n        score = 0.5\n    else:\n        score = 0.0\n\n    # 下降趨勢額外加分\n    if trend == \"down\" and score < 1.0:\n        score += 0.2\n\n    return min(score, 1.0)\n```\n\n**權重**：0.30\n\n### 2. 通膨/通膨預期（Inflation）\n\n**定義**：市場對未來通膨的預期\n\n**數據代理**：\n- 首選：5Y Breakeven（FRED: T5YIE）\n- 替代：5y5y Forward Inflation Expectation（FRED: T5YIFR）\n- 替代：CPI YoY\n\n**判定規則**：\n\n```python\ndef score_inflation(inflation: float, trend: str) -> float:\n    \"\"\"\n    評分通膨因子\n\n    Args:\n        inflation: 當前通膨預期（%）\n        trend: \"up\" / \"down\" / \"flat\"\n\n    Returns:\n        0-1 的分數\n    \"\"\"\n    score = 0.0\n\n    # 高通膨預期支持 1970s-like\n    if inflation > 3.0:\n        score = 1.0\n    elif inflation > 2.5:\n        score = 0.7\n    elif inflation > 2.0:\n        score = 0.3\n    else:\n        score = 0.0\n\n    # 上升趨勢額外加分\n    if trend == \"up\" and score < 1.0:\n        score += 0.3\n\n    return min(score, 1.0)\n```\n\n**權重**：0.25\n\n### 3. 地緣政治風險（Geopolitical Risk）\n\n**定義**：全球地緣政治緊張程度\n\n**數據代理**：\n- 首選：GPR Index（Caldara-Iacoviello）\n- 替代：新聞關鍵詞計數（war, conflict, sanction, tension）\n\n**判定規則**：\n\n```python\ndef score_geopolitical(gpr_percentile: float, trend: str) -> float:\n    \"\"\"\n    評分地緣風險因子\n\n    Args:\n        gpr_percentile: GPR 指數在歷史中的分位數（0-100）\n        trend: \"up\" / \"down\" / \"flat\"\n\n    Returns:\n        0-1 的分數\n    \"\"\"\n    score = 0.0\n\n    # 高分位數支持 1970s-like\n    if gpr_percentile > 80:\n        score = 1.0\n    elif gpr_percentile > 60:\n        score = 0.6\n    elif gpr_percentile > 40:\n        score = 0.3\n    else:\n        score = 0.0\n\n    # 上升趨勢額外加分\n    if trend == \"up\" and score < 1.0:\n        score += 0.2\n\n    return min(score, 1.0)\n```\n\n**權重**：0.25\n\n### 4. 美元強弱（USD）\n\n**定義**：美元對其他主要貨幣的相對強弱\n\n**數據代理**：\n- 首選：Trade-Weighted USD Index（FRED: DTWEXBGS）\n- 替代：DXY（Yahoo Finance）\n\n**判定規則**：\n\n```python\ndef score_usd(usd_trend: str, months_from_high: int) -> float:\n    \"\"\"\n    評分美元因子\n\n    Args:\n        usd_trend: \"up\" / \"down\" / \"flat\"\n        months_from_high: 距離 12 個月高點的月數\n\n    Returns:\n        0-1 的分數\n    \"\"\"\n    score = 0.0\n\n    # 美元走弱支持 1970s-like\n    if usd_trend == \"down\":\n        score = 0.7\n    elif usd_trend == \"flat\":\n        score = 0.3\n    else:  # \"up\"\n        score = 0.0\n\n    # 遠離高點額外加分\n    if months_from_high >= 6:\n        score += 0.3\n\n    return min(score, 1.0)\n```\n\n**權重**：0.20\n\n## 綜合判定\n\n### 計算總分\n\n```python\ndef calculate_regime_score(factors: dict) -> tuple[str, float, list]:\n    \"\"\"\n    計算行情體質總分\n\n    Args:\n        factors: {\n            \"real_rate\": {\"value\": float, \"trend\": str},\n            \"inflation\": {\"value\": float, \"trend\": str},\n            \"geopolitical\": {\"percentile\": float, \"trend\": str},\n            \"usd\": {\"trend\": str, \"months_from_high\": int}\n        }\n\n    Returns:\n        (regime_label, confidence, drivers)\n    \"\"\"\n    weights = {\n        \"real_rate\": 0.30,\n        \"inflation\": 0.25,\n        \"geopolitical\": 0.25,\n        \"usd\": 0.20\n    }\n\n    scores = {}\n    drivers = []\n\n    # 計算各因子分數\n    scores[\"real_rate\"] = score_real_rate(\n        factors[\"real_rate\"][\"value\"],\n        factors[\"real_rate\"][\"trend\"]\n    )\n    if scores[\"real_rate\"] > 0.5:\n        drivers.append(\"Real rates negative / falling\")\n\n    scores[\"inflation\"] = score_inflation(\n        factors[\"inflation\"][\"value\"],\n        factors[\"inflation\"][\"trend\"]\n    )\n    if scores[\"inflation\"] > 0.5:\n        drivers.append(\"Inflation risk rising\")\n\n    scores[\"geopolitical\"] = score_geopolitical(\n        factors[\"geopolitical\"][\"percentile\"],\n        factors[\"geopolitical\"][\"trend\"]\n    )\n    if scores[\"geopolitical\"] > 0.5:\n        drivers.append(\"Geopolitical tension proxy rising\")\n\n    scores[\"usd\"] = score_usd(\n        factors[\"usd\"][\"trend\"],\n        factors[\"usd\"][\"months_from_high\"]\n    )\n    if scores[\"usd\"] > 0.5:\n        drivers.append(\"USD weakening\")\n\n    # 加權總分\n    total_score = sum(\n        scores[k] * weights[k] for k in scores\n    )\n\n    # 判定\n    if total_score >= 0.5:\n        return \"1970s_like\", total_score, drivers\n    else:\n        return \"2000s_like\", 1 - total_score, drivers\n```\n\n### 判定門檻\n\n| 總分 | 判定 | 含義 |\n|------|------|------|\n| ≥ 0.7 | 強 1970s-like | 多個因子強烈支持 |\n| 0.5-0.7 | 弱 1970s-like | 部分因子支持 |\n| 0.3-0.5 | 弱 2000s-like | 部分因子支持 |\n| < 0.3 | 強 2000s-like | 多個因子強烈支持 |\n\n## 歷史案例\n\n### 1970s（典型 1970s-like）\n\n| 因子 | 狀態 | 分數 |\n|------|------|------|\n| 實質利率 | 深度負利率（-4% to -6%） | 1.0 |\n| 通膨 | 高且上升（8%-14%） | 1.0 |\n| 地緣風險 | 高（石油危機、越戰） | 1.0 |\n| 美元 | 大幅走弱 | 1.0 |\n| **總分** | | **1.0** |\n\n**結果**：黃金從 $35 漲到 $850，偏離度達 320%。\n\n### 2000s-2011（混合特徵）\n\n| 因子 | 狀態 | 分數 |\n|------|------|------|\n| 實質利率 | 低但不一定負 | 0.5 |\n| 通膨 | 溫和（2%-3%） | 0.3 |\n| 地緣風險 | 中等偏高（911後、伊拉克戰爭） | 0.6 |\n| 美元 | 先弱後穩 | 0.5 |\n| **總分** | | **0.45** |\n\n**結果**：黃金從 $250 漲到 $1900，偏離度約 85%，之後回調。\n\n### 2019-2024（偏 1970s-like）\n\n| 因子 | 狀態 | 分數 |\n|------|------|------|\n| 實質利率 | 負利率時期較長 | 0.8 |\n| 通膨 | 上升後居高不下 | 0.7 |\n| 地緣風險 | 高（俄烏、中東） | 0.8 |\n| 美元 | 波動但未持續走強 | 0.5 |\n| **總分** | | **0.72** |\n\n## 使用建議\n\n### 體質判定的用途\n\n1. **風險評估**：1970s-like 體質下，高偏離度可能持續更久\n2. **策略調整**：不同體質下，停損和倉位策略應有所不同\n3. **情境規劃**：考慮體質轉變的可能性和觸發條件\n\n### 不應用於\n\n1. **短期交易訊號**：體質是中長期概念\n2. **精確擇時**：體質判定是模糊的，不適合精確擇時\n3. **單獨決策依據**：應結合其他分析工具使用\n\n### 體質轉變的觸發條件\n\n從 1970s-like → 2000s-like：\n- 央行大幅升息，實質利率轉正\n- 通膨預期被錨定\n- 地緣風險緩和\n\n從 2000s-like → 1970s-like：\n- 通膨失控\n- 央行政策失去公信力\n- 重大地緣衝突\n",
        "skills/evaluate-exponential-trend-deviation-regimes/templates/output-json.md": "# JSON 輸出結構定義\n\n本文件定義 evaluate-exponential-trend-deviation-regimes 技能的 JSON 輸出格式。\n\n## 完整輸出結構\n\n```json\n{\n  \"skill\": \"evaluate-exponential-trend-deviation-regimes\",\n  \"asset\": \"GC=F\",\n  \"trend_model\": \"exponential_log_linear\",\n  \"date_range\": {\n    \"start\": \"1970-01-01\",\n    \"end\": \"2026-01-14\"\n  },\n  \"metrics\": {\n    \"current_distance_pct\": 92.4,\n    \"current_percentile\": 97.8,\n    \"reference\": {\n      \"2011_max_distance_pct\": 85.1,\n      \"1980_peak_distance_pct\": 320.7\n    },\n    \"verdict\": {\n      \"surpassed_2011_by_this_metric\": true,\n      \"distance_to_1980_peak_pct_points\": 228.3\n    }\n  },\n  \"regime\": {\n    \"regime_label\": \"1970s_like\",\n    \"drivers\": [\n      \"Real rates negative / falling\",\n      \"Inflation risk rising\",\n      \"Geopolitical tension proxy rising\"\n    ],\n    \"confidence\": 0.72,\n    \"factor_breakdown\": {\n      \"real_rate\": {\n        \"value\": -0.5,\n        \"trend\": \"falling\",\n        \"score\": 1.0,\n        \"contribution\": 0.30\n      },\n      \"inflation\": {\n        \"value\": 2.8,\n        \"trend\": \"rising\",\n        \"score\": 0.7,\n        \"contribution\": 0.175\n      },\n      \"geopolitical\": {\n        \"percentile\": 75,\n        \"trend\": \"rising\",\n        \"score\": 0.8,\n        \"contribution\": 0.20\n      },\n      \"usd\": {\n        \"trend\": \"weakening\",\n        \"months_from_high\": 4,\n        \"score\": 0.7,\n        \"contribution\": 0.14\n      }\n    }\n  },\n  \"insights\": [\n    \"Gold is trading at an extreme positive deviation from its long-run exponential trendline, above the 2011 deviation peak.\",\n    \"Compared with 1980-style blow-off, deviation is still materially lower, leaving room for extension if 1970s-like conditions persist.\",\n    \"If real rates re-anchor higher and inflation expectations cool, mean-reversion risk increases even if the long-term trend remains up.\"\n  ],\n  \"trend_parameters\": {\n    \"a\": 3.555,\n    \"b\": 0.00456,\n    \"annualized_growth_rate_pct\": 5.5\n  },\n  \"auxiliary\": {\n    \"latest_price\": 2650.5,\n    \"trend_price\": 1379.2,\n    \"data_points\": 660\n  },\n  \"metadata\": {\n    \"generated_at\": \"2026-01-15T10:30:00Z\",\n    \"data_sources\": {\n      \"gold\": \"Yahoo Finance (GC=F)\",\n      \"real_rate\": \"FRED (DFII10)\",\n      \"inflation\": \"FRED (T5YIE)\",\n      \"usd\": \"FRED (DTWEXBGS)\"\n    },\n    \"warnings\": []\n  }\n}\n```\n\n## 欄位說明\n\n### 頂層欄位\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| skill | string | 技能名稱 |\n| asset | string | 資產代碼 |\n| trend_model | string | 趨勢模型類型 |\n| date_range | object | 數據範圍 |\n| metrics | object | 核心指標 |\n| regime | object | 行情體質判定 |\n| insights | array | 洞察文字 |\n| trend_parameters | object | 趨勢線參數 |\n| auxiliary | object | 輔助信息 |\n| metadata | object | 元數據 |\n\n### metrics 子欄位\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| current_distance_pct | float | 當前偏離度（%） |\n| current_percentile | float | 歷史分位數（0-100） |\n| reference | object | 參考峰值偏離度 |\n| verdict | object | 與參考點的比較結論 |\n\n### regime 子欄位\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| regime_label | string | \"1970s_like\" 或 \"2000s_like\" |\n| drivers | array | 驅動因子列表 |\n| confidence | float | 信心度（0-1） |\n| factor_breakdown | object | 各因子詳細分解 |\n\n### trend_parameters 子欄位\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| a | float | 截距（log scale） |\n| b | float | 斜率（log scale，每交易日） |\n| annualized_growth_rate_pct | float | 年化成長率（%） |\n\n## 簡化輸出（--quick 模式）\n\n```json\n{\n  \"skill\": \"evaluate-exponential-trend-deviation-regimes\",\n  \"asset\": \"GC=F\",\n  \"as_of\": \"2026-01-14\",\n  \"current_distance_pct\": 92.4,\n  \"current_percentile\": 97.8,\n  \"surpassed_2011\": true,\n  \"regime_label\": \"1970s_like\",\n  \"regime_confidence\": 0.72\n}\n```\n\n## 多資產掃描輸出\n\n```json\n{\n  \"skill\": \"evaluate-exponential-trend-deviation-regimes\",\n  \"scan_mode\": true,\n  \"as_of\": \"2026-01-14\",\n  \"scan_results\": [\n    {\n      \"asset\": \"GC=F\",\n      \"distance_pct\": 92.4,\n      \"percentile\": 97.8,\n      \"regime\": \"1970s_like\",\n      \"regime_confidence\": 0.72\n    }\n  ],\n  \"summary\": {\n    \"total_assets\": 1,\n    \"extreme_deviation_count\": 1,\n    \"regime_1970s_count\": 1,\n    \"regime_2000s_count\": 0\n  }\n}\n```\n\n## 錯誤輸出\n\n```json\n{\n  \"skill\": \"evaluate-exponential-trend-deviation-regimes\",\n  \"error\": true,\n  \"error_type\": \"data_fetch_failed\",\n  \"error_message\": \"Failed to fetch gold prices from Yahoo Finance\",\n  \"suggestions\": [\n    \"Check internet connection\",\n    \"Try alternative data source (Stooq)\",\n    \"Verify symbol is correct\"\n  ]\n}\n```\n\n## 部分數據輸出\n\n當部分宏觀數據不可用時：\n\n```json\n{\n  \"skill\": \"evaluate-exponential-trend-deviation-regimes\",\n  \"asset\": \"GC=F\",\n  \"metrics\": {\n    \"current_distance_pct\": 92.4,\n    \"current_percentile\": 97.8\n  },\n  \"regime\": {\n    \"regime_label\": \"1970s_like\",\n    \"confidence\": 0.55,\n    \"factor_breakdown\": {\n      \"real_rate\": { \"value\": -0.5, \"score\": 1.0 },\n      \"inflation\": { \"value\": null, \"score\": null },\n      \"geopolitical\": { \"percentile\": null, \"score\": null },\n      \"usd\": { \"trend\": \"weakening\", \"score\": 0.7 }\n    }\n  },\n  \"metadata\": {\n    \"warnings\": [\n      \"Inflation data unavailable, using reduced factor set\",\n      \"Geopolitical risk data unavailable\"\n    ],\n    \"available_factors\": 2,\n    \"total_factors\": 4\n  }\n}\n```\n",
        "skills/evaluate-exponential-trend-deviation-regimes/templates/output-markdown.md": "# Markdown 報告輸出模板\n\n本文件定義 evaluate-exponential-trend-deviation-regimes 技能的 Markdown 報告格式。\n\n## 標準報告模板\n\n```markdown\n# 黃金趨勢偏離度與行情體質分析報告\n\n**資產**: {asset}\n**數據截至**: {as_of}\n**數據範圍**: {start_date} - {end_date}\n\n---\n\n## 核心指標\n\n┌─────────────────────────────┬────────┬─────────────────────────────┐\n│            指標             │  數值  │            狀態             │\n├─────────────────────────────┼────────┼─────────────────────────────┤\n│ 當前偏離度                  │ {distance_pct}%  │ {distance_status}     │\n├─────────────────────────────┼────────┼─────────────────────────────┤\n│ 歷史分位數                  │ {percentile}%  │ {percentile_status}     │\n├─────────────────────────────┼────────┼─────────────────────────────┤\n│ 與 2011 峰值比較            │ {vs_2011}  │ {vs_2011_status}          │\n├─────────────────────────────┼────────┼─────────────────────────────┤\n│ 與 1980 峰值差距            │ {vs_1980} 點 │ {vs_1980_status}        │\n└─────────────────────────────┴────────┴─────────────────────────────┘\n\n---\n\n## 行情體質判定\n\n**判定結果**: {regime_label}\n**信心度**: {regime_confidence}\n\n### 驅動因子\n\n{drivers_list}\n\n### 因子分解\n\n┌──────────────────┬────────┬────────┬────────┬─────────────────────────┐\n│ 因子             │ 當前值 │ 趨勢   │ 分數   │ 貢獻                    │\n├──────────────────┼────────┼────────┼────────┼─────────────────────────┤\n│ 實質利率         │ {real_rate_value}%  │ {real_rate_trend} │ {real_rate_score} │ {real_rate_contrib} │\n├──────────────────┼────────┼────────┼────────┼─────────────────────────┤\n│ 通膨預期         │ {inflation_value}%  │ {inflation_trend} │ {inflation_score} │ {inflation_contrib} │\n├──────────────────┼────────┼────────┼────────┼─────────────────────────┤\n│ 地緣風險         │ {geo_value}  │ {geo_trend} │ {geo_score} │ {geo_contrib} │\n├──────────────────┼────────┼────────┼────────┼─────────────────────────┤\n│ 美元             │ {usd_value}  │ {usd_trend} │ {usd_score} │ {usd_contrib} │\n├──────────────────┼────────┼────────┼────────┼─────────────────────────┤\n│ **合計**         │        │        │        │ **{total_score}**       │\n└──────────────────┴────────┴────────┴────────┴─────────────────────────┘\n\n---\n\n## 洞察\n\n{insights}\n\n---\n\n## 風險提示\n\n{risk_warnings}\n\n---\n\n## 技術細節\n\n- **趨勢模型**: {trend_model}\n- **截距 (a)**: {param_a}\n- **斜率 (b)**: {param_b}\n- **年化成長率**: {annualized_growth}%\n- **當前價格**: ${latest_price}\n- **趨勢價格**: ${trend_price}\n- **數據點數**: {data_points}\n\n---\n\n*報告生成時間: {generated_at}*\n```\n\n## 使用範例\n\n### 填充後的報告\n\n```markdown\n# 黃金趨勢偏離度與行情體質分析報告\n\n**資產**: GC=F (COMEX 黃金期貨)\n**數據截至**: 2026-01-14\n**數據範圍**: 1970-01-01 - 2026-01-14\n\n---\n\n## 核心指標\n\n┌─────────────────────────────┬────────┬─────────────────────────────┐\n│            指標             │  數值  │            狀態             │\n├─────────────────────────────┼────────┼─────────────────────────────┤\n│ 當前偏離度                  │ 92.4%  │ 極端正偏離                  │\n├─────────────────────────────┼────────┼─────────────────────────────┤\n│ 歷史分位數                  │ 97.8%  │ 歷史極端區間                │\n├─────────────────────────────┼────────┼─────────────────────────────┤\n│ 與 2011 峰值比較            │ +7.3   │ 已超過 2011 峰值            │\n├─────────────────────────────┼────────┼─────────────────────────────┤\n│ 與 1980 峰值差距            │ 228.3 點 │ 距離 1980 仍有空間        │\n└─────────────────────────────┴────────┴─────────────────────────────┘\n\n---\n\n## 行情體質判定\n\n**判定結果**: 1970s-like (去信任法幣/通膨風險主導)\n**信心度**: 0.72 (72%)\n\n### 驅動因子\n\n- Real rates negative / falling\n- Inflation risk rising\n- Geopolitical tension proxy rising\n\n### 因子分解\n\n┌──────────────────┬────────┬────────┬────────┬─────────────────────────┐\n│ 因子             │ 當前值 │ 趨勢   │ 分數   │ 貢獻                    │\n├──────────────────┼────────┼────────┼────────┼─────────────────────────┤\n│ 實質利率         │ -0.5%  │ ↓ 下降 │ 1.00   │ +0.30                   │\n├──────────────────┼────────┼────────┼────────┼─────────────────────────┤\n│ 通膨預期         │ 2.8%   │ ↑ 上升 │ 0.70   │ +0.175                  │\n├──────────────────┼────────┼────────┼────────┼─────────────────────────┤\n│ 地緣風險         │ P75    │ ↑ 上升 │ 0.80   │ +0.20                   │\n├──────────────────┼────────┼────────┼────────┼─────────────────────────┤\n│ 美元             │ 102.5  │ ↓ 走弱 │ 0.70   │ +0.14                   │\n├──────────────────┼────────┼────────┼────────┼─────────────────────────┤\n│ **合計**         │        │        │        │ **0.72**                │\n└──────────────────┴────────┴────────┴────────┴─────────────────────────┘\n\n---\n\n## 洞察\n\n1. **市場位置**: 黃金正在以極端正偏離交易，偏離度已超過 2011 年的峰值（85.1%），當前處於歷史 97.8 分位數。\n\n2. **歷史對照**: 與 1980 年的 blow-off（320.7%）相比，當前偏離度仍明顯較低。若 1970s-like 條件持續，價格有延伸空間。\n\n3. **體質判定**: 當前宏觀環境偏向 1970s-like 體質，主要驅動因素包括：\n   - 實質利率為負且下降\n   - 通膨預期上升\n   - 地緣政治風險偏高\n\n4. **均值回歸風險**: 若實質利率重新錨定走高且通膨預期冷卻，均值回歸風險將增加，即使長期趨勢仍然向上。\n\n---\n\n## 風險提示\n\n- **高偏離度風險**: 當前偏離度處於歷史極端區間，即使在 1970s-like 體質下，短期回調幅度可能較大\n- **體質轉變風險**: 若央行大幅升息成功錨定通膨預期，體質可能從 1970s-like 轉向 2000s-like\n- **流動性風險**: 極端行情下，流動性可能快速惡化\n\n---\n\n## 技術細節\n\n- **趨勢模型**: exponential_log_linear\n- **截距 (a)**: 3.555\n- **斜率 (b)**: 0.00456\n- **年化成長率**: 5.5%\n- **當前價格**: $2,650.50\n- **趨勢價格**: $1,379.20\n- **數據點數**: 660 (月頻)\n\n---\n\n*報告生成時間: 2026-01-15T10:30:00Z*\n```\n\n## 簡化報告模板\n\n用於快速輸出：\n\n```markdown\n## 黃金趨勢偏離度快報\n\n**{asset}** | 截至 {as_of}\n\n| 指標 | 數值 | 狀態 |\n|------|------|------|\n| 偏離度 | {distance_pct}% | {distance_status} |\n| 分位數 | {percentile}% | {percentile_status} |\n| vs 2011 | {vs_2011} | {vs_2011_status} |\n| 體質 | {regime_label} | 信心度 {regime_confidence} |\n\n**關鍵驅動**: {key_drivers}\n```\n\n## 歷史對照報告模板\n\n```markdown\n## 黃金趨勢偏離度歷史對照\n\n**{asset}** | 截至 {as_of}\n\n### 偏離度時間軸\n\n| 時點 | 偏離度 | 歷史脈絡 |\n|------|--------|----------|\n| 當前 ({current_date}) | {current_distance}% | -- |\n| 2011-09 峰值 | {peak_2011}% | 後金融危機 QE 擔憂 |\n| 1980-01 峰值 | {peak_1980}% | 1970s 高通膨終局 |\n\n### 結論\n\n{comparison_verdict}\n```\n",
        "skills/evaluate-exponential-trend-deviation-regimes/workflows/compare.md": "# 歷史對照分析工作流\n\n將當前偏離度與歷史峰值（2011/1980）進行詳細比較。\n\n## 前置條件\n\n- 使用者已執行基本偵測，或直接請求歷史對照\n- 有足夠的歷史數據（建議從 1970 年開始）\n\n## 步驟\n\n### Step 1: 確認參數\n\n| 參數 | 來源 | 預設值 |\n|------|------|--------|\n| symbol | 使用者提供 | GC=F |\n| compare_peak_dates | 使用者提供 | [\"2011-09-06\", \"1980-01-21\"] |\n| output_format | 使用者提供 | markdown |\n\n### Step 2: 執行對照腳本\n\n```bash\ncd skills/evaluate-exponential-trend-deviation-regimes\npython scripts/trend_deviation.py \\\n  --symbol {symbol} \\\n  --start 1970-01-01 \\\n  --compare-peaks \"2011-09-06,1980-01-21\" \\\n  --detailed\n```\n\n### Step 3: 解讀歷史對照結果\n\n腳本輸出包含詳細的歷史比較：\n\n```json\n{\n  \"historical_comparison\": {\n    \"current\": {\n      \"date\": \"2026-01-14\",\n      \"distance_pct\": 92.4,\n      \"percentile\": 97.8\n    },\n    \"reference_peaks\": {\n      \"2011-09-06\": {\n        \"distance_pct\": 85.1,\n        \"context\": \"Post-GFC QE fears, safe haven demand\",\n        \"aftermath\": \"Multi-year bear market followed\"\n      },\n      \"1980-01-21\": {\n        \"distance_pct\": 320.7,\n        \"context\": \"1970s high inflation finale\",\n        \"aftermath\": \"20-year bear market followed\"\n      }\n    },\n    \"verdicts\": {\n      \"surpassed_2011\": true,\n      \"distance_to_1980_pct_points\": 228.3,\n      \"percentile_vs_2011\": \"higher\",\n      \"percentile_vs_1980\": \"lower\"\n    }\n  }\n}\n```\n\n### Step 4: 生成對照報告\n\n報告應包含：\n\n1. **對照表格**\n\n```\n┌──────────────────┬────────┬────────────────────────────────┐\n│ 時點             │ 偏離度 │ 歷史脈絡                       │\n├──────────────────┼────────┼────────────────────────────────┤\n│ 當前 (2026-01)   │ 92.4%  │ --                             │\n├──────────────────┼────────┼────────────────────────────────┤\n│ 2011-09 峰值     │ 85.1%  │ 後金融危機 QE 擔憂             │\n├──────────────────┼────────┼────────────────────────────────┤\n│ 1980-01 峰值     │ 320.7% │ 1970s 高通膨終局               │\n└──────────────────┴────────┴────────────────────────────────┘\n```\n\n2. **視覺化描述**\n   - 當前位置在歷史分布中的位置\n   - 與兩個峰值的距離\n\n3. **脈絡解讀**\n   - 2011 之後發生了什麼\n   - 1980 之後發生了什麼\n   - 當前情況的相似與差異\n\n## 歷史峰值判定邏輯\n\n```python\ndef find_historical_peaks(distance_series: pd.Series, years: list[int]) -> dict:\n    \"\"\"找出指定年份的偏離度峰值\"\"\"\n    peaks = {}\n    for year in years:\n        year_data = distance_series[distance_series.index.year == year]\n        if not year_data.empty:\n            peak_idx = year_data.idxmax()\n            peaks[str(year)] = {\n                \"date\": peak_idx.strftime(\"%Y-%m-%d\"),\n                \"distance_pct\": float(year_data.loc[peak_idx]),\n            }\n    return peaks\n```\n\n## 脈絡資訊\n\n### 2011 峰值脈絡\n\n- **驅動因素**：\n  - 2008 金融危機後的避險需求\n  - 美聯儲量化寬鬆（QE1, QE2）\n  - 歐債危機\n  - 美國債務上限危機\n\n- **後續發展**：\n  - 2011-2015：黃金熊市，跌幅約 45%\n  - 2015-2018：底部盤整\n  - 2019 起：新一輪牛市\n\n### 1980 峰值脈絡\n\n- **驅動因素**：\n  - 1970s 高通膨（CPI 曾達 14%）\n  - 石油危機\n  - 美元脫鉤黃金（1971 布雷頓森林體系瓦解）\n  - Volcker 尚未大幅升息\n\n- **後續發展**：\n  - Volcker 大幅升息（聯邦基金利率達 20%）\n  - 通膨被壓制\n  - 黃金進入長達 20 年的熊市\n\n## 風險提示\n\n當前偏離度若已超過 2011：\n- 不代表必然下跌，需看行情體質\n- 1970s-like 體質下，可以延續更久\n- 2000s-like 體質下，回歸風險較高\n\n## 輸出範例\n\n見 `templates/output-markdown.md` 中的歷史對照報告模板\n",
        "skills/evaluate-exponential-trend-deviation-regimes/workflows/detect.md": "# 單資產偵測工作流\n\n偵測單一資產的趨勢偏離度與歷史分位數。\n\n## 前置條件\n\n- 使用者提供了資產代碼（symbol）\n- 資產有足夠的歷史數據（建議 ≥ 10 年）\n\n## 步驟\n\n### Step 1: 確認參數\n\n從使用者輸入解析以下參數：\n\n| 參數 | 來源 | 預設值 | 說明 |\n|------|------|--------|------|\n| symbol | 使用者提供 | 必填 | 資產代碼（例如：GC=F, ^GSPC, BTC-USD） |\n| start_date | 使用者提供 | 建議提供 | 起始日期，不同資產應有不同起點 |\n| end_date | 使用者提供 | today | 結束日期 |\n| trend_fit_window | 使用者提供 | full | 趨勢擬合策略 |\n| include_macro | 使用者提供 | false | 僅黃金支援宏觀分析 |\n| compare_peaks | 使用者提供 | null | 手動指定歷史參考日期 |\n\n**資產專屬起始日期建議**：\n- 黃金：1970-01-01（捕捉布雷頓森林體系瓦解後的歷史）\n- S&P 500：1950-01-01\n- 比特幣：2013-01-01（歷史較短）\n- 原油：1980-01-01\n\n若使用者未提供起始日期，腳本將使用較保守的預設值（2000-01-01）。\n\n### Step 2: 執行偵測腳本\n\n**基本偵測**（適用所有資產）：\n```bash\ncd skills/evaluate-exponential-trend-deviation-regimes\npython scripts/trend_deviation.py \\\n  --symbol {symbol} \\\n  --start {start_date} \\\n  --end {end_date}\n```\n\n**含宏觀分析**（僅黃金）：\n```bash\npython scripts/trend_deviation.py \\\n  --symbol GC=F \\\n  --start 1970-01-01 \\\n  --include-macro\n```\n\n**指定歷史參考點**：\n```bash\npython scripts/trend_deviation.py \\\n  --symbol {symbol} \\\n  --compare-peaks \"2011-09-06,2020-08-07\"\n```\n\n### Step 3: 解讀輸出\n\n腳本輸出 JSON 格式結果，核心欄位：\n\n```json\n{\n  \"skill\": \"evaluate-exponential-trend-deviation-regimes\",\n  \"asset\": \"{symbol}\",\n  \"as_of\": \"2026-01-14\",\n  \"metrics\": {\n    \"current_distance_pct\": 53.6,\n    \"current_percentile\": 89.5,\n    \"reference\": {\n      \"2011_max\": 104.3  // 若有指定參考日期\n    },\n    \"verdict\": {\n      \"surpassed_2011_by_this_metric\": false  // 若有參考點\n    }\n  },\n  \"regime\": {  // 僅當 --include-macro 時存在\n    \"regime_label\": \"2000s_like\",\n    \"drivers\": [...],\n    \"confidence\": 0.72\n  }\n}\n```\n\n**關鍵欄位說明**：\n- `current_distance_pct`：當前偏離度（%）\n- `current_percentile`：歷史分位數（0-100）\n- `reference`：與指定參考日期的比較（若有提供）\n- `regime`：行情體質判定（僅黃金且使用 --include-macro）\n\n### Step 4: 生成報告\n\n根據 `templates/output-markdown.md` 模板格式化報告。\n\n報告應包含：\n\n1. **當前狀態表格**\n   - 偏離度數值\n   - 歷史分位數\n   - 與歷史峰值比較\n\n2. **行情體質判定**\n   - 1970s-like / 2000s-like\n   - 驅動因子清單\n   - 信心度\n\n3. **洞察與建議**\n   - 當前市場位置解讀\n   - 風險提示\n   - 後續關注點\n\n## 偏離度計算邏輯\n\n```python\ndef fit_exponential_trend(prices: pd.Series):\n    \"\"\"擬合指數趨勢線\"\"\"\n    t = np.arange(len(prices))\n    y = np.log(prices.values)\n\n    # OLS: y = a + b*t\n    X = np.vstack([np.ones_like(t), t]).T\n    a, b = np.linalg.lstsq(X, y, rcond=None)[0]\n\n    trend = np.exp(a + b * t)\n    return pd.Series(trend, index=prices.index), (a, b)\n\ndef distance_from_trend_pct(prices: pd.Series, trend: pd.Series):\n    \"\"\"計算偏離度百分比\"\"\"\n    return (prices / trend - 1.0) * 100.0\n```\n\n## 行情體質判定邏輯\n\n```python\ndef calculate_regime_score(macro_data: dict) -> tuple[str, float, list]:\n    \"\"\"\n    計算行情體質分數\n\n    Returns:\n        (regime_label, confidence, drivers)\n    \"\"\"\n    score = 0.0\n    drivers = []\n\n    # 實質利率（權重 0.3）\n    if macro_data.get('real_rate', 0) < 0:\n        score += 0.3\n        drivers.append(\"Real rates negative / falling\")\n\n    # 通膨趨勢（權重 0.25）\n    if macro_data.get('inflation_trend', 'flat') == 'up':\n        score += 0.25\n        drivers.append(\"Inflation risk rising\")\n\n    # 地緣風險（權重 0.25）\n    if macro_data.get('geopolitical_risk_trend', 'flat') == 'up':\n        score += 0.25\n        drivers.append(\"Geopolitical tension proxy rising\")\n\n    # 美元趨勢（權重 0.2）\n    if macro_data.get('usd_trend', 'flat') == 'down':\n        score += 0.2\n        drivers.append(\"USD weakening\")\n\n    # 判定\n    if score >= 0.5:\n        return \"1970s_like\", score, drivers\n    else:\n        return \"2000s_like\", 1 - score, drivers\n```\n\n## 錯誤處理\n\n- 若無法取得資料，提示使用者檢查 symbol 是否正確\n- 若資料不足（< 10 年），警告趨勢擬合可能不準確\n- 若 yfinance 失敗，建議使用 Stooq 替代\n- 若 FRED 數據不可用，跳過宏觀因子分析，僅輸出偏離度\n\n## 輸出範例\n\n見 `examples/gold-deviation-2026.json`\n",
        "skills/evaluate-exponential-trend-deviation-regimes/workflows/macro.md": "# 宏觀因子分解工作流\n\n詳細拆解各宏觀代理指標對行情體質判定的貢獻。\n\n## 前置條件\n\n- 使用者想了解體質判定背後的宏觀因子\n- FRED 數據可用\n\n## 步驟\n\n### Step 1: 確認參數\n\n| 參數 | 來源 | 預設值 |\n|------|------|--------|\n| symbol | 使用者提供 | GC=F |\n| macro_proxies | 使用者提供 | 預設代理指標 |\n| lookback_months | 使用者提供 | 12 |\n\n預設宏觀代理指標：\n\n```json\n{\n  \"real_rate_series\": \"DFII10\",\n  \"inflation_series\": \"T5YIE\",\n  \"usd_series\": \"DTWEXBGS\",\n  \"geopolitical_risk_series\": null\n}\n```\n\n### Step 2: 執行宏觀因子分析\n\n```bash\ncd skills/evaluate-exponential-trend-deviation-regimes\npython scripts/trend_deviation.py \\\n  --symbol {symbol} \\\n  --macro-breakdown \\\n  --lookback-months {lookback_months}\n```\n\n### Step 3: 解讀宏觀因子結果\n\n腳本輸出包含各因子的詳細分析：\n\n```json\n{\n  \"macro_breakdown\": {\n    \"real_rate\": {\n      \"series\": \"DFII10\",\n      \"current_value\": -0.5,\n      \"trend\": \"falling\",\n      \"contribution_to_1970s_score\": 0.3,\n      \"interpretation\": \"Negative real rates support gold\"\n    },\n    \"inflation_expectation\": {\n      \"series\": \"T5YIE\",\n      \"current_value\": 2.8,\n      \"trend\": \"rising\",\n      \"contribution_to_1970s_score\": 0.25,\n      \"interpretation\": \"Rising inflation expectations support gold\"\n    },\n    \"usd_index\": {\n      \"series\": \"DTWEXBGS\",\n      \"current_value\": 102.5,\n      \"trend\": \"weakening\",\n      \"contribution_to_1970s_score\": 0.2,\n      \"interpretation\": \"Weakening USD supports gold\"\n    },\n    \"geopolitical_risk\": {\n      \"series\": \"proxy_news_count\",\n      \"current_value\": \"elevated\",\n      \"trend\": \"rising\",\n      \"contribution_to_1970s_score\": 0.25,\n      \"interpretation\": \"Elevated geopolitical risk supports gold\"\n    }\n  },\n  \"total_1970s_score\": 0.72,\n  \"regime_verdict\": \"1970s_like\"\n}\n```\n\n### Step 4: 生成因子分解報告\n\n報告應包含：\n\n1. **因子貢獻表格**\n\n```\n┌──────────────────┬────────┬────────┬────────┬─────────────────────────┐\n│ 因子             │ 當前值 │ 趨勢   │ 權重   │ 對 1970s 分數貢獻       │\n├──────────────────┼────────┼────────┼────────┼─────────────────────────┤\n│ 實質利率         │ -0.5%  │ ↓ 下降 │ 0.30   │ +0.30 (滿分)            │\n├──────────────────┼────────┼────────┼────────┼─────────────────────────┤\n│ 通膨預期         │ 2.8%   │ ↑ 上升 │ 0.25   │ +0.25 (滿分)            │\n├──────────────────┼────────┼────────┼────────┼─────────────────────────┤\n│ 美元指數         │ 102.5  │ ↓ 走弱 │ 0.20   │ +0.20 (滿分)            │\n├──────────────────┼────────┼────────┼────────┼─────────────────────────┤\n│ 地緣風險         │ 偏高   │ ↑ 上升 │ 0.25   │ +0.25 (滿分)            │\n├──────────────────┼────────┼────────┼────────┼─────────────────────────┤\n│ **合計**         │        │        │ 1.00   │ **0.72**                │\n└──────────────────┴────────┴────────┴────────┴─────────────────────────┘\n```\n\n2. **各因子詳細解讀**\n   - 數據來源\n   - 當前狀態\n   - 與歷史比較\n   - 對黃金的影響\n\n3. **體質判定結論**\n   - 綜合分數\n   - 判定結果\n   - 關鍵驅動因子\n\n## 宏觀因子定義\n\n### 1. 實質利率（Real Rate）\n\n**數據來源**：FRED DFII10（10 年 TIPS 收益率）\n\n**判定規則**：\n- 負值 → 支持 1970s-like（權重 0.3）\n- 趨勢下降 → 額外支持\n\n**解讀**：\n實質利率為負時，持有黃金的機會成本降低甚至為負，支持黃金需求。\n\n### 2. 通膨預期（Inflation Expectation）\n\n**數據來源**：FRED T5YIE（5 年 Breakeven 通膨率）\n\n**判定規則**：\n- 上升趨勢 → 支持 1970s-like（權重 0.25）\n- 高於 2.5% → 額外支持\n\n**解讀**：\n通膨預期上升時，黃金作為通膨對沖工具的需求增加。\n\n### 3. 美元指數（USD Index）\n\n**數據來源**：FRED DTWEXBGS（貿易加權美元指數）\n\n**判定規則**：\n- 下降趨勢 → 支持 1970s-like（權重 0.2）\n- 12 個月低點 → 額外支持\n\n**解讀**：\n美元走弱時，以美元計價的黃金對其他貨幣持有者更有吸引力。\n\n### 4. 地緣政治風險（Geopolitical Risk）\n\n**數據來源**：GPR 指數（若不可用則用新聞關鍵詞計數）\n\n**判定規則**：\n- 上升趨勢 → 支持 1970s-like（權重 0.25）\n- 高於歷史中位數 → 額外支持\n\n**解讀**：\n地緣緊張時，黃金作為避險資產的需求增加。\n\n## 趨勢判定邏輯\n\n```python\ndef determine_trend(series: pd.Series, lookback: int = 60) -> str:\n    \"\"\"\n    判定時間序列的趨勢\n\n    Args:\n        series: 數據序列\n        lookback: 回看天數\n\n    Returns:\n        \"up\" / \"down\" / \"flat\"\n    \"\"\"\n    recent = series.tail(lookback)\n    if len(recent) < lookback // 2:\n        return \"flat\"\n\n    # 簡單線性回歸判定趨勢\n    t = np.arange(len(recent))\n    slope, _ = np.polyfit(t, recent.values, 1)\n\n    # 標準化斜率\n    normalized_slope = slope / recent.std()\n\n    if normalized_slope > 0.1:\n        return \"up\"\n    elif normalized_slope < -0.1:\n        return \"down\"\n    else:\n        return \"flat\"\n```\n\n## 錯誤處理\n\n- 若 FRED 數據不可用，跳過該因子，調整權重\n- 若地緣風險指數不可用，使用新聞關鍵詞計數替代\n- 若多個因子不可用，警告使用者結果可能不完整\n\n## 輸出範例\n\n見 `templates/output-markdown.md` 中的宏觀因子分解報告模板\n",
        "skills/forecast-sector-relative-return-from-yield-spread/SKILL.md": "---\nname: forecast-sector-relative-return-from-yield-spread\ndescription: 用美債殖利率曲線利差（如 2Y-10Y）建立「領先關係」，推估未來一段時間內成長股（Nasdaq 100）相對防禦股（Healthcare/XLV）的相對績效方向與幅度。\n---\n\n<essential_principles>\n\n<principle name=\"lead_lag_definition\">\n**領先落後關係定義**\n\n美國公債利差（Yield Spread）作為領先指標：\n\n```\nspread_t = short_yield_t - long_yield_t\n         = US02Y_t - US10Y_t\n```\n\n**spread 越高**：短端相對更高（曲線更倒掛/更緊）\n**spread 越低**（或從負回到 0、轉正）：曲線「回正/變陡」\n\n此 spread 被認為領先反映：\n- 經濟週期預期（倒掛 → 衰退預期）\n- 風險偏好轉換（曲線變陡 → 風險偏好回升）\n</principle>\n\n<principle name=\"relative_return_definition\">\n**相對報酬定義**\n\n相對強弱比率（Ratio）：\n\n```\nratio_t = risk_asset_t / defensive_asset_t\n        = QQQ_t / XLV_t\n```\n\n**ratio 上升**：成長股（Nasdaq）相對更強\n**ratio 下降**：防禦股（Healthcare）相對更強（XLV 跑贏）\n\n預測目標為「未來 H 個月的對數相對報酬」：\n\n```\nfuture_rel_return = log(ratio(t+H) / ratio(t))\n```\n\n正值 → Nasdaq 跑贏，負值 → XLV 跑贏\n</principle>\n\n<principle name=\"advance_alignment\">\n**「2 Years in Advance」的真正含義**\n\n圖表的時間對齊邏輯：\n- 把 spread 往前平移 lead_months 個月\n- 目標是檢查：**spread(t) 是否能解釋 ratio(t + H)**\n\n工程化寫法：\n```\nX = spread(t)\nY = future_rel_return(t, H) = log(ratio(t+H) / ratio(t))\n```\n\n然後做相關性/迴歸/交叉相關掃描來找「最佳領先期」。\n\n**避免直接用 ratio 水平做迴歸**（有趨勢/非平穩問題），改用對數報酬。\n</principle>\n\n<principle name=\"validation_framework\">\n**領先關係驗證框架**\n\n需回答三件事：\n\n1. **是否真的存在穩定領先關係？**\n   - 掃描多個 lead（6, 12, 18, 24, 30 個月）\n   - 看哪個 lead 下 corr(spread, future_rel_return) 最穩、顯著\n   - 跨子樣本驗證（前半段 vs 後半段）\n\n2. **目前情境對應的預測方向**\n   - 最近 spread 水準、變化率\n   - 模型預測 E[future_rel_return]\n   - 分位數區間（如 80% 信心區間）\n\n3. **把預測翻譯成直覺語句**\n   - 由 future_rel_return 轉回百分比：`exp(future_rel_return) - 1`\n   - 「未來 24 個月 XLV 相對 QQQ 勝率 X%、中位數報酬 Y%」\n</principle>\n\n<principle name=\"data_alignment\">\n**數據對齊原則**\n\n- **頻率選擇**：週頻（weekly）降低雜訊，建議 1wk\n- **平滑視窗**：可選 13 週或 26 週移動平均\n- **回測長度**：至少涵蓋 1-2 次完整景氣循環（如 2007-present）\n\n殖利率來源：FRED（DGS2, DGS10）\n資產價格來源：Yahoo Finance（QQQ, XLV）\n</principle>\n\n</essential_principles>\n\n<objective>\n實作「美國公債利差 → 板塊相對報酬」領先關係分析：\n\n1. **數據整合**：取得殖利率（FRED）與資產價格（yfinance）\n2. **利差計算**：計算 spread = short_yield - long_yield\n3. **相對報酬計算**：計算 future_rel_return = log(ratio(t+H) / ratio(t))\n4. **領先關係驗證**：掃描多個 lead 找最佳相關性與穩定性\n5. **情境預測**：基於當前 spread 產出未來相對報酬預測區間\n6. **輸出報告**：驗證結論、預測方向、風險提示\n\n輸出：領先關係驗證、當前預測、區間估計、歷史類比、風險提示。\n</objective>\n\n<quick_start>\n\n**最快的方式：執行預設情境分析**\n\n```bash\ncd skills/forecast-sector-relative-return-from-yield-spread\npip install pandas numpy yfinance matplotlib statsmodels requests  # 首次使用\npython scripts/spread_forecaster.py --quick\n```\n\n**完整分析（含領先掃描與穩定性驗證）**\n\n```bash\npython scripts/spread_forecaster.py \\\n  --risk-ticker QQQ \\\n  --defensive-ticker XLV \\\n  --lead-months 24 \\\n  --lookback-years 12 \\\n  --output result.json\n```\n\n**生成 Bloomberg 風格視覺化圖表**\n\n```bash\npython scripts/plot_bloomberg_style.py --quick --output output/yield_spread_forecast_$(date +%Y-%m-%d).png\n```\n\n**完整版圖表（自訂參數）**\n\n```bash\npython scripts/plot_bloomberg_style.py \\\n  --lookback-years 18 \\\n  --lead-months 24 \\\n  --risk-ticker QQQ \\\n  --defensive-ticker XLV \\\n  --output output/yield_spread_analysis.png\n```\n\n輸出範例：\n```json\n{\n  \"skill\": \"forecast_sector_relative_return_from_yield_spread\",\n  \"signal_name\": \"US02Y_minus_US10Y_leads_QQQ_over_XLV\",\n  \"lead_months\": 24,\n  \"current_spread\": -0.35,\n  \"model\": {\n    \"type\": \"lagged_regression\",\n    \"alpha\": 0.02,\n    \"beta\": -0.45,\n    \"corr_x_y\": -0.32\n  },\n  \"forecast\": {\n    \"future_24m_relative_return_pct\": -0.077,\n    \"interval_pct_80\": [-0.22, 0.04],\n    \"interpretation\": \"若此關係維持，未來24個月QQQ相對XLV期望報酬為-7.7%，XLV較可能跑贏。\"\n  }\n}\n```\n\n</quick_start>\n\n<intake>\n需要進行什麼操作？\n\n1. **快速分析** - 使用預設參數（QQQ/XLV, 24 個月領先）計算當前預測\n2. **完整分析** - 自訂參數進行領先關係驗證與情境預測\n3. **領先掃描** - 掃描多個領先期（6-30 個月）找最佳相關性\n4. **視覺化圖表** - 生成利差與相對報酬對齊圖\n5. **穩定性驗證** - 檢查領先關係在不同子樣本的一致性\n6. **方法論學習** - 了解領先關係邏輯與計算方式\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                       | Action                                                                 |\n|--------------------------------|------------------------------------------------------------------------|\n| 1, \"快速\", \"quick\", \"分析\"     | 執行 `python scripts/spread_forecaster.py --quick`                     |\n| 2, \"完整\", \"full\", \"自訂\"      | 閱讀 `workflows/analyze.md` 並執行                                     |\n| 3, \"掃描\", \"scan\", \"領先\"      | 閱讀 `workflows/analyze.md` 並聚焦 lead_scan                           |\n| 4, \"圖表\", \"chart\", \"視覺化\"   | 執行 `python scripts/plot_bloomberg_style.py --quick --output output/` |\n| 5, \"驗證\", \"穩定\", \"stability\" | 閱讀 `workflows/analyze.md` 並聚焦穩定性驗證                           |\n| 6, \"學習\", \"方法論\", \"why\"     | 閱讀 `references/methodology.md`                                       |\n| 提供參數 (如 ticker, lead)     | 閱讀 `workflows/analyze.md` 並使用參數執行                             |\n\n**路由後，閱讀對應文件並執行。**\n</routing>\n\n<directory_structure>\n```\nforecast-sector-relative-return-from-yield-spread/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元數據\n├── workflows/\n│   ├── analyze.md                     # 完整分析工作流\n│   └── data-research.md               # 數據源研究與替代方案\n├── references/\n│   ├── methodology.md                 # 方法論與計算邏輯\n│   ├── input-schema.md                # 完整輸入參數定義\n│   └── data-sources.md                # 數據來源與獲取方式\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n├── scripts/\n│   ├── spread_forecaster.py           # 主計算腳本\n│   ├── plot_bloomberg_style.py        # Bloomberg 風格視覺化（推薦）\n│   └── spread_plotter.py              # 基本版圖表腳本（備用）\n└── examples/\n    └── sample-output.json             # 範例輸出\n```\n</directory_structure>\n\n<reference_index>\n\n**方法論**: references/methodology.md\n- 領先落後關係定義\n- 相對報酬計算\n- 迴歸模型設定\n- 區間估計方法\n- 穩定性驗證\n\n**資料來源**: references/data-sources.md\n- 殖利率代理（FRED DGS2/DGS10）\n- 資產價格代理（QQQ/XLV）\n- 數據對齊原則\n\n**輸入參數**: references/input-schema.md\n- 完整參數定義\n- 預設值與建議範圍\n\n</reference_index>\n\n<workflows_index>\n| Workflow         | Purpose      | 使用時機                          |\n|------------------|--------------|-----------------------------------|\n| analyze.md       | 完整情境分析 | 需要自訂參數驗證領先關係與預測    |\n| data-research.md | 數據源研究   | 了解如何獲取或替代殖利率/資產數據 |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構定義 |\n| output-markdown.md | Markdown 報告模板 |\n</templates_index>\n\n<scripts_index>\n| Script                  | Command                                     | Purpose                         |\n|-------------------------|---------------------------------------------|---------------------------------|\n| spread_forecaster.py    | `--quick`                                   | 快速分析 QQQ/XLV, 24m lead      |\n| spread_forecaster.py    | `--lead-months 12 --lookback-years 15`      | 自訂領先期與回測長度            |\n| spread_forecaster.py    | `--lead-scan --scan-range 6,12,18,24,30,36` | 領先期掃描                      |\n| plot_bloomberg_style.py | `--quick --output output/chart.png`         | Bloomberg 風格快速圖表          |\n| plot_bloomberg_style.py | `--lookback-years 18 --lead-months 24`      | 完整版圖表（含領先掃描+穩定性） |\n| spread_plotter.py       | `--quick --output-dir output/`              | 基本版圖表（備用）              |\n</scripts_index>\n\n<input_schema_summary>\n\n**核心參數**\n\n| 參數             | 類型   | 預設值 | 說明              |\n|------------------|--------|--------|-------------------|\n| risk_ticker      | string | QQQ    | 代表成長股的標的  |\n| defensive_ticker | string | XLV    | 代表防禦股的標的  |\n| short_tenor      | string | 2Y     | 短端殖利率期限    |\n| long_tenor       | string | 10Y    | 長端殖利率期限    |\n| lead_months      | int    | 24     | 領先期（月）      |\n| lookback_years   | int    | 12     | 回測/估計歷史年數 |\n\n**進階參數**\n\n| 參數                  | 類型   | 預設值            | 說明                             |\n|-----------------------|--------|-------------------|----------------------------------|\n| freq                  | string | weekly            | 資料頻率（daily/weekly/monthly） |\n| smoothing_window      | int    | 13                | 平滑視窗（週數）                 |\n| return_horizon_months | int    | 24                | 預測的相對報酬視窗               |\n| model_type            | string | lagged_regression | 模型類型                         |\n| confidence_level      | float  | 0.80              | 區間估計信心水準                 |\n\n完整參數定義見 `references/input-schema.md`。\n\n</input_schema_summary>\n\n<output_schema_summary>\n```json\n{\n  \"skill\": \"forecast_sector_relative_return_from_yield_spread\",\n  \"inputs\": {\n    \"risk_ticker\": \"QQQ\",\n    \"defensive_ticker\": \"XLV\",\n    \"lead_months\": 24,\n    \"lookback_years\": 18\n  },\n  \"signal_name\": \"DGS2_minus_DGS10_leads_QQQ_over_XLV\",\n  \"current_state\": {\n    \"spread\": -0.61,\n    \"spread_percentile\": 61.1,\n    \"spread_trend\": \"steepening\"\n  },\n  \"model\": {\n    \"type\": \"lagged_regression\",\n    \"coefficients\": { \"alpha\": 0.19, \"beta\": 0.087 },\n    \"fit_quality\": {\n      \"corr_x_y\": 0.484,\n      \"r_squared\": 0.234,\n      \"notes\": \"正 beta 意味 spread 越低（曲線正常）→ 未來 QQQ 相對 XLV 越強\"\n    }\n  },\n  \"forecast\": {\n    \"horizon_months\": 24,\n    \"future_relative_return_pct\": 0.148,\n    \"interval_pct_80\": [-0.05, 0.36],\n    \"expected_winner\": \"QQQ\"\n  },\n  \"diagnostics\": {\n    \"lead_scan\": {\n      \"best_lead_months\": 36,\n      \"correlation_by_lead\": {\"6\": 0.233, \"12\": 0.360, \"18\": 0.405, \"24\": 0.484, \"30\": 0.502, \"36\": 0.509}\n    },\n    \"stability_checks\": {\n      \"first_half_corr\": -0.087,\n      \"second_half_corr\": 0.663,\n      \"consistency\": \"low\"\n    }\n  },\n  \"notes\": [\n    \"領先關係反映的是『歷史統計規律』，不保證未來成立。\",\n    \"子樣本一致性低：前半段（2007-2015）為負相關，後半段（2015-2024）為正相關。\",\n    \"這意味著此領先關係可能只是 2015 後 QE 時代的特有現象。\",\n    \"建議搭配：景氣指標、估值分位、資金流向做交叉驗證。\"\n  ]\n}\n```\n\n完整輸出結構見 `templates/output-json.md`。\n\n**重要發現（2026-01-27 驗證結果）**：\n- 領先關係存在，但 **子樣本一致性低**（前半段負相關 vs 後半段正相關）\n- 最佳領先期為 30-36 個月（非 24 個月），但 24 個月也有 0.484 的相關性\n- R² = 23.4%，spread 僅解釋約四分之一的相對報酬變異\n</output_schema_summary>\n\n<success_criteria>\n執行成功時應產出：\n\n- [ ] 當前美國公債利差水準\n- [ ] 領先關係相關性與迴歸係數\n- [ ] 未來相對報酬預測（點估計與區間）\n- [ ] 領先期掃描結果（若執行）\n- [ ] 穩定性驗證（子樣本一致性）\n- [ ] 結果輸出為指定格式（JSON 或 Markdown）\n- [ ] 視覺化圖表輸出（若需要）\n- [ ] 風險提示與後續研究建議\n</success_criteria>\n",
        "skills/forecast-sector-relative-return-from-yield-spread/methodology.md": "這個技能的核心做法，是把一個 **利率結構的訊號** 當成**領先指標**，去解釋或推估未來一段時間內兩個資產（或兩個產業）之間的**相對表現**。\n\n以一個簡單的案例來說：\n- 指標是：**兩年期與十年期美國公債殖利率的差**（短天期 − 長天期）\n- 目標是：**納斯達克 100 相對醫療保健（XLV）的比值**（可以理解成 **成長股相對防禦股的強弱** ）\n\n## 為什麼美國公債利差可能會領先股市風格輪動？\n\n從經濟直覺來看，短天期利率比較靠近央行政策與金融條件，長天期利率則反映市場對長期成長、通膨與風險溢酬的綜合預期。\n\n因此，當 **短端相對高、長端相對低** 時（利差偏高或出現倒掛），常見的含意是：\n1. **資金成本偏高、融資條件變緊**（對依賴遠期成長想像、估值較敏感的資產較不利）\n2. 市場開始提高對未來景氣放緩的權重，偏好**現金流較穩定、波動較小**的領域\n3. 風險偏好下降時，防禦型產業（例如醫療保健）相對容易受到青睞\n\n換句話說，殖利率曲線的變化，可能會先反映金融條件與景氣風險的轉向，而股市內部的 **成長股 vs 防禦股** 相對表現，可能在一段時間後才更明顯地跟上。\n\n---\n\n## 這個方法的標準做法\n\n要把這種技能做得嚴謹，通常會做三件事：\n\n### 1) 把 **相對績效** 變成可比較的量\n不要只看各自漲跌，而是看**比值**：\n-  **成長股** 用納斯達克 100（或其代表標的）\n-  **防禦股** 用醫療保健（XLV）\n- 形成比值：  \n  **比值上升** → 成長股相對更強  \n  **比值下降** → 防禦股相對更強（也就是 XLV 相對跑贏）\n\n### 2) 設定 **提前多久** 去檢驗領先關係\n所謂 **提前兩年** ，就是在問：\n> 目前的利差，是否能對應到 **兩年後** 成長股相對防禦股的表現？\n\n比較嚴謹的做法，是把問題改成：\n> 目前利差能否解釋 **未來兩年** 成長股相對防禦股的報酬？\n\n這樣可以避免只是在看兩條線 **看起來很像** 的視覺錯覺。\n\n### 3) 同時看 **方向** 與 **幅度** \n不只回答 **會不會輪動** ，還要回答 **大概會輪動多少** 。\n例如用歷史上類似利差狀態出現後的結果，估計：\n- 未來兩年 XLV 相對跑贏的機率\n- 相對跑贏的常見區間（例如多數情況落在 +5% 到 +20% 之類）\n\n---\n\n## 使用這個方法時要注意的三個陷阱\n\n### 1)  **兩年** 不一定永遠是最佳領先期\n不同時期的領先期可能不同，有時是一年、有時是兩年、有時更短。最好做一個 **領先期掃描** ，看哪個領先期最穩定。\n\n### 2) 美國公債利差只是其中一個訊號\n\n即使歷史上常出現關聯，也可能受其他因素干擾，例如：\n- 科技股盈餘循環\n- 醫療產業政策與藥價風險\n- 市場風險偏好與信用利差變化\n所以它更適合做 **風格輪動的條件訊號** ，而不是單一決策依據。",
        "skills/forecast-sector-relative-return-from-yield-spread/references/data-sources.md": "# 數據來源與獲取方式\n\n本文件說明技能所需數據的來源、獲取方式、注意事項與替代方案。\n\n---\n\n## 1. 殖利率數據\n\n### 主要來源：FRED（Federal Reserve Economic Data）\n\n| 項目       | 說明                                                 |\n|------------|------------------------------------------------------|\n| 提供者     | Federal Reserve Bank of St. Louis                    |\n| 網址       | https://fred.stlouisfed.org                          |\n| 費用       | 免費                                                 |\n| API        | 免費 CSV API，無需 API Key                           |\n| 更新頻率   | 每日（T+1，美東時間下午更新）                        |\n| 歷史深度   | 大部分系列自 1962 年起                               |\n\n**常用系列代碼：**\n\n| 代碼    | 名稱                                    | 期限 | 起始日期   |\n|---------|-----------------------------------------|------|------------|\n| DGS3MO  | 3-Month Treasury Bill Secondary Market  | 3M   | 1982-01-04 |\n| DGS1    | 1-Year Treasury Constant Maturity Rate  | 1Y   | 1962-01-02 |\n| DGS2    | 2-Year Treasury Constant Maturity Rate  | 2Y   | 1976-06-01 |\n| DGS5    | 5-Year Treasury Constant Maturity Rate  | 5Y   | 1962-01-02 |\n| DGS7    | 7-Year Treasury Constant Maturity Rate  | 7Y   | 1969-07-01 |\n| DGS10   | 10-Year Treasury Constant Maturity Rate | 10Y  | 1962-01-02 |\n| DGS30   | 30-Year Treasury Constant Maturity Rate | 30Y  | 1977-02-15 |\n\n**獲取方式：**\n\n```python\nimport pandas as pd\nimport requests\nfrom io import StringIO\n\nFRED_CSV_URL = \"https://fred.stlouisfed.org/graph/fredgraph.csv\"\n\ndef fetch_fred_series(series_id: str, start_date: str, end_date: str) -> pd.Series:\n    \"\"\"\n    從 FRED 抓取時間序列（無需 API key）\n\n    Parameters:\n    -----------\n    series_id : str\n        FRED 系列代碼 (e.g., \"DGS10\", \"DGS2\")\n    start_date : str\n        起始日期 (YYYY-MM-DD)\n    end_date : str\n        結束日期 (YYYY-MM-DD)\n\n    Returns:\n    --------\n    pd.Series\n        時間序列數據，index 為 DatetimeIndex\n    \"\"\"\n    params = {\n        \"id\": series_id,\n        \"cosd\": start_date,\n        \"coed\": end_date\n    }\n\n    try:\n        response = requests.get(FRED_CSV_URL, params=params, timeout=30)\n        response.raise_for_status()\n\n        # 健壯的 CSV 解析方式\n        df = pd.read_csv(StringIO(response.text))\n\n        # FRED CSV 格式：第一列是日期，第二列是數值\n        df.columns = [\"DATE\", series_id]\n        df[\"DATE\"] = pd.to_datetime(df[\"DATE\"])\n\n        # 處理缺失值（FRED 使用 '.' 表示缺失）\n        df[series_id] = df[series_id].replace(\".\", pd.NA)\n        df[series_id] = pd.to_numeric(df[series_id], errors=\"coerce\")\n\n        df = df.dropna()\n        df = df.set_index(\"DATE\")\n\n        return df[series_id]\n\n    except Exception as e:\n        print(f\"Error fetching {series_id} from FRED: {e}\")\n        return pd.Series(dtype=float)\n```\n\n**注意事項：**\n- FRED 使用 `.` 表示缺失值，需特別處理\n- 假日（非交易日）無數據，需考慮對齊\n- 時區為美東時間\n\n### 替代來源\n\n| 來源           | 優點             | 缺點                 | 適用場景       |\n|----------------|------------------|----------------------|----------------|\n| Yahoo Finance  | 即時更新         | 僅提供 ^TNX (10Y)    | 快速驗證       |\n| Treasury.gov   | 官方原始數據     | 需手動下載 CSV       | 高精度需求     |\n| Quandl/Nasdaq  | API 友善         | 部分需付費           | 自動化系統     |\n\n---\n\n## 2. 資產價格數據\n\n### 主要來源：Yahoo Finance (via yfinance)\n\n| 項目       | 說明                                    |\n|------------|-----------------------------------------|\n| 提供者     | Yahoo Finance                           |\n| 網址       | https://finance.yahoo.com               |\n| 費用       | 免費                                    |\n| Python 套件| yfinance                                |\n| 更新頻率   | 盤中即時（有延遲）                      |\n| 歷史深度   | 視標的而定，ETF 通常自成立日起          |\n\n**預設標的：**\n\n| 代碼 | 名稱                           | 類型     | 成立日期   |\n|------|--------------------------------|----------|------------|\n| QQQ  | Invesco QQQ Trust              | 成長股   | 1999-03-10 |\n| XLV  | Health Care Select Sector SPDR | 防禦股   | 1998-12-16 |\n\n**替代標的：**\n\n| 類型   | 代碼 | 名稱                          | 說明                    |\n|--------|------|-------------------------------|-------------------------|\n| 成長股 | ^NDX | Nasdaq 100 Index              | 指數本身（非 ETF）      |\n| 成長股 | IWF  | iShares Russell 1000 Growth   | 更廣義成長股            |\n| 成長股 | VUG  | Vanguard Growth ETF           | 低成本成長股 ETF        |\n| 防禦股 | VHT  | Vanguard Health Care ETF      | 更廣泛 Healthcare       |\n| 防禦股 | IYH  | iShares U.S. Healthcare ETF   | 另一 Healthcare ETF     |\n| 防禦股 | XLP  | Consumer Staples Select Sector| 消費必需品（另一防禦）  |\n\n**獲取方式：**\n\n```python\nimport yfinance as yf\nimport pandas as pd\n\ndef fetch_price_series(\n    ticker: str,\n    start_date: str,\n    end_date: str,\n    freq: str = \"1wk\"\n) -> pd.Series:\n    \"\"\"\n    從 Yahoo Finance 抓取調整後收盤價\n\n    Parameters:\n    -----------\n    ticker : str\n        股票/ETF 代碼 (e.g., \"QQQ\", \"XLV\")\n    start_date : str\n        起始日期 (YYYY-MM-DD)\n    end_date : str\n        結束日期 (YYYY-MM-DD)\n    freq : str\n        頻率 (\"1d\", \"1wk\", \"1mo\")\n\n    Returns:\n    --------\n    pd.Series\n        調整後收盤價序列\n    \"\"\"\n    try:\n        data = yf.download(\n            ticker,\n            start=start_date,\n            end=end_date,\n            interval=freq,\n            progress=False\n        )\n\n        if data.empty:\n            print(f\"No data returned for {ticker}\")\n            return pd.Series(dtype=float)\n\n        # 使用調整後收盤價（含股息、拆分）\n        return data[\"Adj Close\"]\n\n    except Exception as e:\n        print(f\"Error fetching {ticker}: {e}\")\n        return pd.Series(dtype=float)\n```\n\n**注意事項：**\n- 使用 `Adj Close`（調整後收盤價）而非 `Close`\n- yfinance 偶爾會有 API 問題，建議加入重試機制\n- 不同 ETF 的交易時間可能略有差異\n\n### 替代來源\n\n| 來源          | 優點               | 缺點               | 適用場景       |\n|---------------|--------------------|--------------------|----------------|\n| Alpha Vantage | 免費 API           | 速率限制嚴格       | 低頻需求       |\n| Tiingo        | 歷史數據完整       | 需註冊取得 API Key | 研究需求       |\n| Polygon.io    | 專業級數據品質     | 付費               | 生產系統       |\n\n---\n\n## 3. 數據對齊\n\n### 頻率對齊\n\n殖利率（日頻）與價格（日/週/月頻）需對齊：\n\n```python\ndef align_to_weekly(df: pd.DataFrame) -> pd.DataFrame:\n    \"\"\"將數據對齊到週五收盤\"\"\"\n    return df.resample(\"W-FRI\").last().dropna()\n```\n\n### 日期對齊\n\n```python\ndef align_data(yield_df: pd.DataFrame, price_df: pd.DataFrame) -> pd.DataFrame:\n    \"\"\"對齊殖利率與價格數據\"\"\"\n    # Inner join 確保兩邊都有值\n    aligned = yield_df.join(price_df, how=\"inner\")\n    return aligned.dropna()\n```\n\n### 處理缺失值\n\n| 策略           | 說明                   | 適用場景           |\n|----------------|------------------------|--------------------|\n| dropna         | 刪除缺失               | 預設，最保守       |\n| ffill          | 向前填充               | 假日數據延續       |\n| interpolate    | 線性插值               | 短期缺失           |\n\n---\n\n## 4. 快取策略\n\n建議對 FRED 與 yfinance 數據實作快取：\n\n```python\nimport json\nfrom pathlib import Path\nfrom datetime import datetime, timedelta\n\nCACHE_DIR = Path(\"cache\")\n\ndef save_cache(key: str, df: pd.DataFrame, ttl_hours: int = 24):\n    \"\"\"儲存快取\"\"\"\n    CACHE_DIR.mkdir(exist_ok=True)\n\n    df_to_save = df.copy()\n    if df_to_save.index.name is None:\n        df_to_save.index.name = \"DATE\"\n\n    data = df_to_save.reset_index().to_dict(orient=\"records\")\n\n    cache_file = CACHE_DIR / f\"{key}.json\"\n    with open(cache_file, \"w\", encoding=\"utf-8\") as f:\n        json.dump({\n            \"cached_at\": datetime.now().isoformat(),\n            \"ttl_hours\": ttl_hours,\n            \"data\": data\n        }, f, default=str)\n\n\ndef load_cache(key: str) -> pd.DataFrame | None:\n    \"\"\"載入快取（若有效）\"\"\"\n    cache_file = CACHE_DIR / f\"{key}.json\"\n\n    if not cache_file.exists():\n        return None\n\n    with open(cache_file, \"r\", encoding=\"utf-8\") as f:\n        cached = json.load(f)\n\n    cached_at = datetime.fromisoformat(cached[\"cached_at\"])\n    ttl_hours = cached.get(\"ttl_hours\", 24)\n\n    if datetime.now() - cached_at > timedelta(hours=ttl_hours):\n        return None  # 快取過期\n\n    df = pd.DataFrame(cached[\"data\"])\n    first_col = df.columns[0]\n    df[first_col] = pd.to_datetime(df[first_col])\n    df = df.set_index(first_col)\n\n    return df\n```\n\n---\n\n## 5. 錯誤處理與 Fallback\n\n```python\ndef fetch_with_fallback(\n    primary_source: callable,\n    fallback_source: callable,\n    *args, **kwargs\n) -> pd.Series:\n    \"\"\"帶 fallback 的數據抓取\"\"\"\n    try:\n        data = primary_source(*args, **kwargs)\n        if not data.empty:\n            return data\n    except Exception as e:\n        print(f\"Primary source failed: {e}\")\n\n    try:\n        data = fallback_source(*args, **kwargs)\n        if not data.empty:\n            print(\"Using fallback source\")\n            return data\n    except Exception as e:\n        print(f\"Fallback source failed: {e}\")\n\n    raise ValueError(\"All data sources failed\")\n```\n\n---\n\n## 6. 數據品質檢查清單\n\n執行分析前應確認：\n\n- [ ] 殖利率數據無異常值（如 > 20%）\n- [ ] 價格數據無負值\n- [ ] 兩邊日期範圍足夠（> lookback_years）\n- [ ] 缺失值比例 < 5%\n- [ ] 對齊後數據點數量足夠（> 100 週）\n",
        "skills/forecast-sector-relative-return-from-yield-spread/references/input-schema.md": "# 輸入參數定義\n\n本文件定義 `forecast-sector-relative-return-from-yield-spread` 技能的所有輸入參數。\n\n---\n\n## 必要參數 (Required)\n\n| 參數             | 類型   | 說明                                | 範例          |\n|------------------|--------|-------------------------------------|---------------|\n| risk_ticker      | string | 代表成長股/風險資產的標的           | \"QQQ\", \"^NDX\" |\n| defensive_ticker | string | 代表防禦股/安全資產的標的           | \"XLV\", \"VHT\"  |\n| lead_months      | int    | 領先期（月），即 spread 領先多少月   | 24            |\n| lookback_years   | int    | 回測/估計領先關係的歷史年數         | 12, 15        |\n\n---\n\n## 選用參數 (Optional)\n\n### 殖利率相關\n\n| 參數        | 類型   | 預設值 | 說明                   | 有效值                    |\n|-------------|--------|--------|------------------------|---------------------------|\n| short_tenor | string | \"2Y\"   | 短端殖利率期限         | \"3M\", \"1Y\", \"2Y\", \"3Y\"    |\n| long_tenor  | string | \"10Y\"  | 長端殖利率期限         | \"5Y\", \"7Y\", \"10Y\", \"30Y\"  |\n\n**殖利率期限對應 FRED 代碼：**\n| 期限 | FRED 代碼 |\n|------|-----------|\n| 3M   | DGS3MO    |\n| 1Y   | DGS1      |\n| 2Y   | DGS2      |\n| 3Y   | DGS3      |\n| 5Y   | DGS5      |\n| 7Y   | DGS7      |\n| 10Y  | DGS10     |\n| 30Y  | DGS30     |\n\n### 數據處理相關\n\n| 參數             | 類型   | 預設值   | 說明                       | 有效值                   |\n|------------------|--------|----------|----------------------------|--------------------------|\n| freq             | string | \"weekly\" | 資料頻率                   | \"daily\", \"weekly\", \"monthly\" |\n| smoothing_window | int    | 13       | spread 平滑視窗（單位同 freq）| 0（不平滑）, 4, 13, 26   |\n\n**頻率說明：**\n- **daily**：最細緻，但雜訊大，適合短期分析\n- **weekly**：建議預設，平衡細緻度與穩定性\n- **monthly**：最穩定，但數據點較少\n\n### 預測相關\n\n| 參數                  | 類型   | 預設值            | 說明                       | 有效值                              |\n|-----------------------|--------|-------------------|----------------------------|-------------------------------------|\n| return_horizon_months | int    | 24                | 預測的相對報酬視窗（月）   | 6, 12, 18, 24, 30, 36               |\n| model_type            | string | \"lagged_regression\"| 預測模型類型               | \"corr_scan\", \"lagged_regression\", \"ridge\" |\n| confidence_level      | float  | 0.80              | 區間估計信心水準           | 0.80, 0.90, 0.95                    |\n\n**模型類型說明：**\n- **corr_scan**：僅計算相關性，不做預測\n- **lagged_regression**：簡單 OLS 迴歸（預設）\n- **ridge**：Ridge 迴歸（加入 L2 正則化，防止過擬合）\n\n### 領先掃描相關\n\n| 參數       | 類型      | 預設值           | 說明                   |\n|------------|-----------|------------------|------------------------|\n| lead_scan  | bool      | false            | 是否執行領先期掃描     |\n| scan_range | list[int] | [6,12,18,24,30]  | 掃描的領先期列表（月） |\n\n---\n\n## 參數組合範例\n\n### 範例 1：快速預設分析\n\n```python\nparams = {\n    \"risk_ticker\": \"QQQ\",\n    \"defensive_ticker\": \"XLV\",\n    \"lead_months\": 24,\n    \"lookback_years\": 12\n}\n```\n\n### 範例 2：自訂利差組合\n\n```python\nparams = {\n    \"risk_ticker\": \"QQQ\",\n    \"defensive_ticker\": \"XLV\",\n    \"short_tenor\": \"3M\",\n    \"long_tenor\": \"10Y\",\n    \"lead_months\": 18,\n    \"lookback_years\": 15\n}\n```\n\n### 範例 3：完整領先掃描\n\n```python\nparams = {\n    \"risk_ticker\": \"QQQ\",\n    \"defensive_ticker\": \"XLV\",\n    \"lookback_years\": 15,\n    \"lead_scan\": True,\n    \"scan_range\": [6, 12, 18, 24, 30, 36],\n    \"freq\": \"monthly\",\n    \"smoothing_window\": 3\n}\n```\n\n### 範例 4：保守區間估計\n\n```python\nparams = {\n    \"risk_ticker\": \"QQQ\",\n    \"defensive_ticker\": \"XLV\",\n    \"lead_months\": 24,\n    \"lookback_years\": 12,\n    \"confidence_level\": 0.90,\n    \"model_type\": \"ridge\"\n}\n```\n\n---\n\n## 參數驗證規則\n\n### 必要條件\n\n1. `risk_ticker` 和 `defensive_ticker` 必須是有效的 Yahoo Finance 代碼\n2. `lead_months` 必須 > 0 且 < lookback_years * 12 / 2\n3. `lookback_years` 必須 >= 5（至少半個景氣週期）\n\n### 建議範圍\n\n| 參數             | 建議最小值 | 建議最大值 | 理由                     |\n|------------------|------------|------------|--------------------------|\n| lead_months      | 6          | 36         | 超過 3 年的領先較不可靠 |\n| lookback_years   | 10         | 20         | 涵蓋 1-2 個景氣週期     |\n| smoothing_window | 4          | 26         | 過長會失去時效性         |\n| confidence_level | 0.80       | 0.95       | 過高區間太寬無意義       |\n\n### 警告條件\n\n- `lookback_years` < 10：警告樣本量可能不足\n- `lead_months` > lookback_years * 6：警告可用數據點過少\n- `smoothing_window` > lead_months / 2：警告可能過度平滑\n\n---\n\n## CLI 參數對應\n\n```bash\npython scripts/spread_forecaster.py \\\n  --risk-ticker QQQ \\\n  --defensive-ticker XLV \\\n  --short-tenor 2Y \\\n  --long-tenor 10Y \\\n  --lead-months 24 \\\n  --lookback-years 12 \\\n  --freq weekly \\\n  --smoothing-window 13 \\\n  --model-type lagged_regression \\\n  --confidence-level 0.80 \\\n  --lead-scan \\\n  --scan-range 6,12,18,24,30 \\\n  --output result.json\n```\n\n**快速執行：**\n```bash\npython scripts/spread_forecaster.py --quick\n# 等同於使用所有預設值\n```\n",
        "skills/forecast-sector-relative-return-from-yield-spread/references/method.md": "# 方法論與計算邏輯\n\n本文件說明「美國公債利差 → 板塊相對報酬」領先關係的完整方法論。\n\n---\n\n## 1. 核心概念\n\n### 1.1 美國公債利差（Yield Spread）\n\n殖利率曲線利差反映市場對未來經濟的預期：\n\n```\nspread_t = short_yield_t - long_yield_t\n         = US02Y_t - US10Y_t\n```\n\n**解讀：**\n- **spread > 0**：曲線倒掛（短端高於長端）→ 市場預期降息/衰退\n- **spread < 0**：曲線正常（短端低於長端）→ 市場預期正常增長\n- **spread 趨勢**：\n  - 變陡（spread 下降）→ 經濟復甦預期\n  - 變平/倒掛（spread 上升）→ 經濟放緩預期\n\n### 1.2 相對報酬（Relative Return）\n\n比較兩類資產的相對績效：\n\n```\nratio_t = risk_asset_t / defensive_asset_t\n        = QQQ_t / XLV_t\n```\n\n**預測目標**：未來 H 個月的對數相對報酬\n\n```\nfuture_rel_return_t,H = log(ratio_{t+H} / ratio_t)\n                      = log(QQQ_{t+H}/XLV_{t+H}) - log(QQQ_t/XLV_t)\n```\n\n**為何用對數報酬而非水平值？**\n- 避免非平穩性（ratio 有趨勢）\n- 對數報酬近似對稱\n- 統計性質更好（近似常態）\n\n### 1.3 領先關係（Lead-Lag Relationship）\n\n假設 spread 領先 relative return H 個月：\n\n```\nX_t = spread_t\nY_t = future_rel_return_{t,H}\n```\n\n若存在領先關係：\n```\nCorr(X_t, Y_t) ≠ 0\n```\n\n---\n\n## 2. 計算步驟\n\n### Step 1: 數據取得與對齊\n\n1. **殖利率**：從 FRED 取得 DGS2、DGS10\n2. **資產價格**：從 yfinance 取得 QQQ、XLV（調整後收盤價）\n3. **頻率對齊**：統一為週頻或月頻\n\n```python\ndef to_weekly(df):\n    return df.resample(\"W-FRI\").last().dropna()\n```\n\n### Step 2: 計算利差與比率\n\n```python\n# 美國公債利差\nspread = dgs2 - dgs10  # 注意：2Y - 10Y\n\n# 相對比率\nratio = qqq / xlv\n```\n\n### Step 3: 計算未來相對報酬\n\n```python\ndef compute_future_rel_return(ratio: pd.Series, horizon_weeks: int) -> pd.Series:\n    \"\"\"計算未來 H 週的對數相對報酬\"\"\"\n    return np.log(ratio.shift(-horizon_weeks) / ratio)\n```\n\n**注意**：`shift(-H)` 表示取未來值，最後 H 筆會是 NaN。\n\n### Step 4: 可選平滑\n\n```python\nif smoothing_window > 1:\n    spread_smoothed = spread.rolling(smoothing_window).mean()\nelse:\n    spread_smoothed = spread\n```\n\n**平滑的作用**：\n- 減少短期雜訊\n- 捕捉趨勢而非日常波動\n- 建議視窗：13 週（約 1 季）或 26 週（約半年）\n\n---\n\n## 3. 模型估計\n\n### 3.1 相關性分析\n\n```python\ncorr = np.corrcoef(spread_smoothed, future_rel_return)[0, 1]\n```\n\n**解讀**：\n- |corr| > 0.3：中等關係\n- |corr| > 0.5：較強關係\n- 負相關意味：spread 越高 → 未來相對報酬越低\n\n### 3.2 簡單迴歸\n\n```python\n# OLS 迴歸: Y = alpha + beta * X\nbeta = np.cov(x, y)[0, 1] / np.var(x)\nalpha = np.mean(y) - beta * np.mean(x)\n```\n\n**係數解讀**：\n- **beta < 0**：spread 每上升 1%，未來相對報酬預期下降 |beta|%\n- **alpha**：當 spread = 0 時的基準相對報酬\n\n### 3.3 預測與區間\n\n**點估計**：\n```python\nx_now = spread_smoothed.iloc[-1]\ny_hat = alpha + beta * x_now\n```\n\n**區間估計**（基於殘差分佈）：\n```python\nresiduals = y - (alpha + beta * x)\nlo, hi = np.quantile(residuals, [0.10, 0.90])  # 80% 區間\ny_interval = (y_hat + lo, y_hat + hi)\n```\n\n**轉換為百分比**：\n```python\npct_return = np.exp(y_hat) - 1\npct_interval = (np.exp(y_hat + lo) - 1, np.exp(y_hat + hi) - 1)\n```\n\n---\n\n## 4. 領先期掃描\n\n### 4.1 掃描邏輯\n\n測試多個領先期（如 6, 12, 18, 24, 30 個月），找最佳相關性：\n\n```python\ndef lead_scan(spread, ratio, leads=[6, 12, 18, 24, 30]):\n    results = {}\n    for lead in leads:\n        horizon_weeks = int(lead * 4.345)  # 月轉週\n        y = compute_future_rel_return(ratio, horizon_weeks)\n        valid = spread.notna() & y.notna()\n        corr = np.corrcoef(spread[valid], y[valid])[0, 1]\n        results[lead] = corr\n    return results\n```\n\n### 4.2 最佳領先期選擇\n\n```python\nbest_lead = max(results, key=lambda k: abs(results[k]))\n```\n\n**注意**：\n- 選擇相關性絕對值最大的領先期\n- 但要驗證穩定性（見下節）\n\n---\n\n## 5. 穩定性驗證\n\n### 5.1 子樣本分割\n\n將數據分成前半與後半，分別計算相關性：\n\n```python\nn = len(data)\nfirst_half = data.iloc[:n//2]\nsecond_half = data.iloc[n//2:]\n\ncorr_first = compute_correlation(first_half)\ncorr_second = compute_correlation(second_half)\n```\n\n### 5.2 一致性判斷\n\n| 條件                 | 一致性等級 |\n|----------------------|------------|\n| 兩段相關性符號相同且 | 差         |\n| 兩段相關性符號相同且 | 差         |\n| 兩段相關性符號相同但 | 差         |\n| 兩段相關性符號不同   | 低         |\n\n### 5.3 滾動相關（進階）\n\n```python\ndef rolling_correlation(x, y, window=52):\n    \"\"\"滾動 1 年相關性\"\"\"\n    return pd.Series(x).rolling(window).corr(pd.Series(y))\n```\n\n觀察滾動相關是否穩定在某個區間。\n\n---\n\n## 6. 經濟解讀\n\n### 6.1 為何 spread 領先相對報酬？\n\n1. **貨幣政策傳導**\n   - 曲線形態反映 Fed 政策預期\n   - 政策影響實體經濟需 12-24 個月\n\n2. **風險偏好週期**\n   - 倒掛 → 避險情緒 → 防禦股相對強\n   - 變陡 → 風險偏好 → 成長股相對強\n\n3. **企業獲利週期**\n   - 曲線領先經濟 → 經濟領先獲利 → 獲利領先股價\n   - 總計約 18-30 個月\n\n### 6.2 負相關的直覺\n\n**spread 高（曲線倒掛）**：\n- 市場預期經濟放緩/衰退\n- 成長股（高 beta、利率敏感）受壓\n- 防禦股（Healthcare）相對抗跌\n- → 未來 QQQ 相對 XLV 弱\n\n**spread 低（曲線正常/變陡）**：\n- 市場預期經濟復甦\n- 成長股彈性大，受益風險偏好\n- 防禦股相對落後\n- → 未來 QQQ 相對 XLV 強\n\n---\n\n## 7. 限制與風險\n\n### 7.1 統計限制\n\n- **R² 偏低**：spread 僅解釋 ~10% 變異，其他因子更重要\n- **樣本量**：過去 15-20 年僅約 2-3 次完整週期\n- **數據挖掘**：掃描多個 lead 可能過度擬合\n\n### 7.2 結構性風險\n\n- **Fed 政策框架變化**：QE、YCC 可能改變曲線訊號意義\n- **零利率下界**：曲線在零附近的訊號可能失效\n- **財政主導**：大規模財政政策可能蓋過貨幣訊號\n\n### 7.3 使用建議\n\n1. **作為參考而非決定因子**：搭配其他指標\n2. **關注區間而非點估計**：不確定性高\n3. **定期驗證**：確認關係仍成立\n4. **情境分析**：考慮關係失效的可能\n\n---\n\n## 8. 公式彙總\n\n| 計算項目     | 公式                           |\n|--------------|--------------------------------|\n| 美國公債利差 | spread = DGS2 - DGS10          |\n| 相對比率     | ratio = QQQ / XLV              |\n| 未來相對報酬 | y = log(ratio_{t+H} / ratio_t) |\n| 迴歸預測     | ŷ = α + β × spread             |\n| 區間估計     | [ŷ + q_10(ε), ŷ + q_90(ε)]     |\n| 轉換為百分比 | pct = exp(y) - 1               |\n",
        "skills/forecast-sector-relative-return-from-yield-spread/templates/output-json.md": "# JSON 輸出模板\n\n本文件定義技能的 JSON 輸出結構，供程式解析使用。\n\n---\n\n## 完整結構\n\n```json\n{\n  \"skill\": \"forecast_sector_relative_return_from_yield_spread\",\n  \"version\": \"0.1.0\",\n  \"generated_at\": \"2026-01-27T10:30:00\",\n\n  \"inputs\": {\n    \"risk_ticker\": \"QQQ\",\n    \"defensive_ticker\": \"XLV\",\n    \"short_tenor\": \"2Y\",\n    \"long_tenor\": \"10Y\",\n    \"lead_months\": 24,\n    \"lookback_years\": 12,\n    \"freq\": \"weekly\",\n    \"smoothing_window\": 13,\n    \"return_horizon_months\": 24,\n    \"model_type\": \"lagged_regression\",\n    \"confidence_level\": 0.80\n  },\n\n  \"signal_name\": \"US02Y_minus_US10Y_leads_QQQ_over_XLV\",\n\n  \"current_state\": {\n    \"spread\": -0.35,\n    \"spread_percentile\": 35,\n    \"spread_3m_change\": 0.25,\n    \"spread_6m_change\": 0.40,\n    \"spread_trend\": \"steepening\",\n    \"as_of_date\": \"2026-01-24\"\n  },\n\n  \"model\": {\n    \"type\": \"lagged_regression\",\n    \"coefficients\": {\n      \"alpha\": 0.02,\n      \"beta\": -0.45\n    },\n    \"fit_quality\": {\n      \"corr_x_y\": -0.32,\n      \"r_squared\": 0.10,\n      \"p_value\": 0.001,\n      \"n_observations\": 520,\n      \"notes\": \"負 beta 意味歷史上倒掛/緊縮的 spread 對應未來 QQQ 相對走弱\"\n    }\n  },\n\n  \"forecast\": {\n    \"horizon_months\": 24,\n    \"future_relative_return\": {\n      \"log\": -0.08,\n      \"pct\": -0.077\n    },\n    \"interval\": {\n      \"confidence_level\": 0.80,\n      \"log\": [-0.25, 0.04],\n      \"pct\": [-0.22, 0.04]\n    },\n    \"direction\": {\n      \"defensive_outperform_prob\": 0.70,\n      \"expected_winner\": \"XLV\"\n    },\n    \"interpretation\": \"若此關係維持，未來24個月QQQ相對XLV期望報酬為-7.7%，XLV較可能跑贏；但區間仍含正值，需搭配其他條件確認。\"\n  },\n\n  \"diagnostics\": {\n    \"lead_scan\": {\n      \"performed\": true,\n      \"scan_range\": [6, 12, 18, 24, 30],\n      \"best_lead_months\": 24,\n      \"correlation_by_lead\": {\n        \"6\": -0.15,\n        \"12\": -0.22,\n        \"18\": -0.28,\n        \"24\": -0.32,\n        \"30\": -0.30\n      }\n    },\n    \"stability_checks\": {\n      \"first_half_period\": \"2014-01-01 to 2020-01-01\",\n      \"second_half_period\": \"2020-01-01 to 2026-01-01\",\n      \"first_half_corr\": -0.30,\n      \"second_half_corr\": -0.34,\n      \"consistency\": \"medium-high\",\n      \"notes\": \"兩段相關性符號一致且差異 < 0.1，關係跨時期穩定\"\n    },\n    \"data_quality\": {\n      \"yield_data_points\": 3120,\n      \"price_data_points\": 520,\n      \"missing_pct\": 0.02,\n      \"date_range\": \"2014-01-03 to 2026-01-24\"\n    }\n  },\n\n  \"summary\": \"美國公債利差（2Y-10Y）對 QQQ/XLV 相對報酬存在約 24 個月的領先關係。當前 spread 為 -0.35%（曲線輕微倒掛），對應未來 24 個月 XLV 相對跑贏的預期。\",\n\n  \"notes\": [\n    \"領先關係反映的是『歷史統計規律』，不保證未來成立。\",\n    \"R² 僅 0.10，spread 只解釋約 10% 的相對報酬變異。\",\n    \"當前 spread 趨勢為變陡（從倒掛回正），需持續觀察。\",\n    \"建議搭配：景氣指標、估值分位、資金流向做交叉驗證。\"\n  ],\n\n  \"next_steps\": [\n    \"監控 spread 是否持續變陡\",\n    \"檢查經濟領先指標（ISM、消費者信心）\",\n    \"比較 Healthcare 基本面（防禦需求）\",\n    \"3 個月後重新驗證預測\"\n  ],\n\n  \"artifacts\": [\n    {\n      \"type\": \"chart\",\n      \"path\": \"output/spread_forecast_2026-01-27.png\",\n      \"description\": \"利差與相對報酬對齊圖\"\n    }\n  ]\n}\n```\n\n---\n\n## 欄位說明\n\n### 頂層欄位\n\n| 欄位         | 類型   | 必要 | 說明                     |\n|--------------|--------|------|--------------------------|\n| skill        | string | ✓    | 技能識別碼               |\n| version      | string | ✓    | 技能版本                 |\n| generated_at | string | ✓    | 報告生成時間（ISO 8601） |\n\n### inputs\n\n記錄使用的輸入參數，供重現與除錯。\n\n### current_state\n\n| 欄位              | 類型   | 說明                        |\n|-------------------|--------|-----------------------------|\n| spread            | float  | 當前美國公債利差（%）       |\n| spread_percentile | float  | 利差在歷史的分位數（0-100） |\n| spread_3m_change  | float  | 利差過去 3 個月變化         |\n| spread_trend      | string | 趨勢：steepening/flattening |\n| as_of_date        | string | 數據截止日期                |\n\n### model\n\n| 欄位         | 類型   | 說明                    |\n|--------------|--------|-------------------------|\n| type         | string | 模型類型                |\n| coefficients | object | 迴歸係數（alpha, beta） |\n| fit_quality  | object | 擬合品質指標            |\n\n### forecast\n\n| 欄位                   | 類型   | 說明                     |\n|------------------------|--------|--------------------------|\n| horizon_months         | int    | 預測視野（月）           |\n| future_relative_return | object | 預測報酬（log 與 pct）   |\n| interval               | object | 信心區間                 |\n| direction              | object | 方向預測（哪邊跑贏機率） |\n| interpretation         | string | 自然語言解讀             |\n\n### diagnostics\n\n| 欄位             | 類型   | 說明           |\n|------------------|--------|----------------|\n| lead_scan        | object | 領先掃描結果   |\n| stability_checks | object | 穩定性驗證結果 |\n| data_quality     | object | 數據品質指標   |\n\n---\n\n## 狀態碼\n\n若執行失敗，輸出以下結構：\n\n```json\n{\n  \"skill\": \"forecast_sector_relative_return_from_yield_spread\",\n  \"status\": \"error\",\n  \"error\": {\n    \"code\": \"DATA_FETCH_FAILED\",\n    \"message\": \"Failed to fetch DGS10 from FRED\",\n    \"details\": \"Connection timeout after 30s\"\n  },\n  \"partial_results\": null\n}\n```\n\n**錯誤碼：**\n| 代碼                 | 說明             |\n|----------------------|------------------|\n| DATA_FETCH_FAILED    | 數據抓取失敗     |\n| INSUFFICIENT_DATA    | 數據點不足       |\n| INVALID_PARAMS       | 參數無效         |\n| MODEL_FIT_FAILED     | 模型估計失敗     |\n| STABILITY_CHECK_FAIL | 穩定性驗證不通過 |\n",
        "skills/forecast-sector-relative-return-from-yield-spread/templates/output-markdown.md": "# Markdown 報告模板\n\n本文件定義技能的 Markdown 輸出格式，供人類閱讀。\n\n---\n\n## 報告結構\n\n```markdown\n# 美國公債利差 → 板塊相對報酬 預測報告\n\n**生成時間**：{generated_at}\n**數據截止**：{as_of_date}\n\n---\n\n## TL;DR（一句話結論）\n\n{summary}\n\n---\n\n## 當前利差狀態\n\n| 指標                | 數值                 | 解讀                        |\n|---------------------|----------------------|-----------------------------|\n| 2Y-10Y 美國公債利差 | {spread}%            | {spread_interpretation}     |\n| 歷史分位數          | {spread_percentile}% | {percentile_interpretation} |\n| 近 3 個月變化       | {spread_3m_change}%  | {trend_interpretation}      |\n\n**趨勢判斷**：{spread_trend}\n\n---\n\n## 領先關係驗證\n\n### 模型設定\n\n- **模型類型**：{model_type}\n- **領先期**：{lead_months} 個月\n- **回測期間**：{lookback_years} 年（{date_range}）\n\n### 模型結果\n\n| 指標      | 數值    | 解讀                           |\n|-----------|---------|--------------------------------|\n| 相關係數  | {corr}  | {corr_interpretation}          |\n| R²        | {r_sq}  | spread 解釋約 {r_sq_pct}% 變異 |\n| Beta 係數 | {beta}  | {beta_interpretation}          |\n| p-value   | {p_val} | {significance_interpretation}  |\n\n### 穩定性驗證\n\n| 子樣本 | 期間                 | 相關係數           |\n|--------|----------------------|--------------------|\n| 前半段 | {first_half_period}  | {first_half_corr}  |\n| 後半段 | {second_half_period} | {second_half_corr} |\n\n**一致性判斷**：{consistency}\n\n---\n\n## 預測結果\n\n### 未來 {horizon_months} 個月相對報酬預測\n\n| 指標                     | 數值                             |\n|--------------------------|----------------------------------|\n| 點估計（QQQ 相對 XLV）   | {future_rel_return_pct}%         |\n| {confidence_level}% 區間 | [{interval_lo}%, {interval_hi}%] |\n| XLV 跑贏機率             | {defensive_outperform_prob}%     |\n\n### 解讀\n\n{interpretation}\n\n---\n\n## 領先掃描結果\n\n（若執行）\n\n| 領先期（月） | 相關係數  | 備註   |\n|--------------|-----------|--------|\n| 6            | {corr_6}  |        |\n| 12           | {corr_12} |        |\n| 18           | {corr_18} |        |\n| 24           | {corr_24} | ← 最佳 |\n| 30           | {corr_30} |        |\n\n**最佳領先期**：{best_lead_months} 個月\n\n---\n\n## 風險提示\n\n1. **統計限制**：R² 僅 {r_sq}，spread 不是主導因子\n2. **歷史不保證未來**：領先關係可能因政策框架變化而失效\n3. **區間寬度**：{interval_lo}% 到 {interval_hi}% 跨度大，方向有不確定性\n4. **數據挖掘風險**：最佳領先期可能是過度擬合結果\n\n---\n\n## 後續研究建議\n\n### 若預測 XLV 跑贏\n\n- [ ] 檢查經濟領先指標（ISM、消費者信心）\n- [ ] 觀察 Healthcare 防禦需求\n- [ ] 評估成長股估值分位\n\n### 若預測 QQQ 跑贏\n\n- [ ] 檢查經濟復甦訊號\n- [ ] 觀察科技股資金流入\n- [ ] 評估利率對估值影響\n\n### 通用驗證\n\n- [ ] 比較其他利差組合（3M-10Y, 2Y-30Y）\n- [ ] 檢查 COT 持倉（利率期貨）\n- [ ] 3 個月後重新驗證\n\n---\n\n## 圖表\n\n（若生成）\n\n![利差與相對報酬對齊圖]({chart_path})\n\n---\n\n## 數據來源\n\n| 數據       | 來源          | 代碼               |\n|------------|---------------|--------------------|\n| 短端殖利率 | FRED          | {short_code}       |\n| 長端殖利率 | FRED          | {long_code}        |\n| 成長股價格 | Yahoo Finance | {risk_ticker}      |\n| 防禦股價格 | Yahoo Finance | {defensive_ticker} |\n\n---\n\n## 免責聲明\n\n本報告僅供參考，不構成投資建議。歷史統計規律不保證未來表現。投資決策應結合多種因素並諮詢專業顧問。\n```\n\n---\n\n## 欄位填充說明\n\n| 佔位符                      | 來源                                         | 範例              |\n|-----------------------------|----------------------------------------------|-------------------|\n| {generated_at}              | 報告生成時間                                 | 2026-01-27 10:30  |\n| {as_of_date}                | current_state.as_of_date                     | 2026-01-24        |\n| {summary}                   | summary 欄位                                 | 見範例            |\n| {spread}                    | current_state.spread                         | -0.35             |\n| {spread_percentile}         | current_state.spread_percentile              | 35                |\n| {spread_3m_change}          | current_state.spread_3m_change               | +0.25             |\n| {spread_trend}              | current_state.spread_trend                   | steepening        |\n| {model_type}                | model.type                                   | lagged_regression |\n| {lead_months}               | inputs.lead_months                           | 24                |\n| {lookback_years}            | inputs.lookback_years                        | 12                |\n| {corr}                      | model.fit_quality.corr_x_y                   | -0.32             |\n| {r_sq}                      | model.fit_quality.r_squared                  | 0.10              |\n| {beta}                      | model.coefficients.beta                      | -0.45             |\n| {future_rel_return_pct}     | forecast.future_relative_return.pct          | -7.7              |\n| {interval_lo}               | forecast.interval.pct[0]                     | -22               |\n| {interval_hi}               | forecast.interval.pct[1]                     | +4                |\n| {defensive_outperform_prob} | forecast.direction.defensive_outperform_prob | 70                |\n| {chart_path}                | artifacts[0].path                            | output/xxx.png    |\n\n---\n\n## 解讀文字生成規則\n\n### spread_interpretation\n\n```python\nif spread > 0:\n    return \"曲線倒掛（短端高於長端）\"\nelif spread > -0.5:\n    return \"曲線輕微倒掛\"\nelse:\n    return \"曲線正常（短端低於長端）\"\n```\n\n### percentile_interpretation\n\n```python\nif percentile < 20:\n    return \"處於歷史低位\"\nelif percentile < 40:\n    return \"處於歷史中等偏低\"\nelif percentile < 60:\n    return \"處於歷史中位\"\nelif percentile < 80:\n    return \"處於歷史中等偏高\"\nelse:\n    return \"處於歷史高位\"\n```\n\n### corr_interpretation\n\n```python\ncorr_abs = abs(corr)\ndirection = \"負\" if corr < 0 else \"正\"\nif corr_abs > 0.5:\n    strength = \"較強\"\nelif corr_abs > 0.3:\n    strength = \"中等\"\nelse:\n    strength = \"較弱\"\nreturn f\"{strength}{direction}相關\"\n```\n\n### beta_interpretation\n\n```python\nif beta < 0:\n    return f\"spread 每上升 1%，未來相對報酬預期下降 {abs(beta):.2f}%\"\nelse:\n    return f\"spread 每上升 1%，未來相對報酬預期上升 {beta:.2f}%\"\n```\n",
        "skills/forecast-sector-relative-return-from-yield-spread/workflows/analyze.md": "# Workflow: 完整情境分析\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/input-schema.md - 完整參數定義\n2. references/methodology.md - 方法論與計算邏輯\n3. references/data-sources.md - 數據來源說明\n</required_reading>\n\n<process>\n\n## Step 1: 確認分析參數\n\n確認用戶提供或使用預設的分析參數：\n\n| 參數                  | 預設值            | 用戶指定值 |\n|-----------------------|-------------------|------------|\n| risk_ticker           | QQQ               |            |\n| defensive_ticker      | XLV               |            |\n| short_tenor           | 2Y                |            |\n| long_tenor            | 10Y               |            |\n| lead_months           | 24                |            |\n| lookback_years        | 12                |            |\n| freq                  | weekly            |            |\n| smoothing_window      | 13                |            |\n| return_horizon_months | 24                |            |\n| model_type            | lagged_regression |            |\n| confidence_level      | 0.80              |            |\n\n若用戶未指定，使用預設值執行。\n\n## Step 2: 執行分析腳本\n\n使用確認的參數執行腳本：\n\n```bash\ncd skills/forecast-sector-relative-return-from-yield-spread\npython scripts/spread_forecaster.py \\\n  --risk-ticker {risk_ticker} \\\n  --defensive-ticker {defensive_ticker} \\\n  --short-tenor {short_tenor} \\\n  --long-tenor {long_tenor} \\\n  --lead-months {lead_months} \\\n  --lookback-years {lookback_years} \\\n  --freq {freq} \\\n  --smoothing-window {smoothing_window} \\\n  --model-type {model_type} \\\n  --confidence-level {confidence_level} \\\n  --output result.json\n```\n\n**快速執行（使用所有預設值）：**\n```bash\npython scripts/spread_forecaster.py --quick\n```\n\n**執行領先掃描：**\n```bash\npython scripts/spread_forecaster.py --lead-scan --scan-range 6,12,18,24,30\n```\n\n## Step 3: 解讀分析結果\n\n### 3.1 當前利差狀態\n\n檢查 `current_spread` 區塊：\n\n```json\n{\n  \"current_spread\": -0.35,\n  \"spread_percentile\": 35,\n  \"spread_3m_change\": 0.25,\n  \"spread_trend\": \"steepening\"\n}\n```\n\n**解讀邏輯：**\n- `current_spread` < 0 → 曲線倒掛（短端高於長端）\n- `spread_percentile` 35% → 處於歷史中等偏低位置\n- `spread_3m_change` > 0 → 曲線正在變陡（從倒掛回正）\n\n### 3.2 領先關係驗證\n\n檢查 `model` 區塊：\n\n```json\n\"model\": {\n  \"type\": \"lagged_regression\",\n  \"alpha\": 0.02,\n  \"beta\": -0.45,\n  \"fit_quality\": {\n    \"corr_x_y\": -0.32,\n    \"r_squared\": 0.10,\n    \"p_value\": 0.001\n  }\n}\n```\n\n**解讀邏輯：**\n- `beta` 負值 → spread 越高，未來相對報酬越低（符合經濟直覺）\n- `corr_x_y` = -0.32 → 中等負相關\n- `r_squared` = 0.10 → spread 解釋約 10% 的相對報酬變異（其他 90% 由其他因子解釋）\n- `p_value` < 0.05 → 統計顯著\n\n**風險提示：** R² 僅 10% 意味 spread 不是主導因子。\n\n### 3.3 預測結果\n\n檢查 `forecast` 區塊：\n\n```json\n\"forecast\": {\n  \"future_24m_relative_return_log\": -0.08,\n  \"future_24m_relative_return_pct\": -0.077,\n  \"interval_pct_80\": [-0.22, 0.04],\n  \"interpretation\": \"若此關係維持，未來24個月QQQ相對XLV期望報酬為-7.7%，XLV較可能跑贏。\"\n}\n```\n\n**解讀邏輯：**\n- `future_24m_relative_return_pct` = -7.7% → 預期 QQQ 跑輸 XLV 約 7.7%\n- `interval_pct_80` = [-22%, +4%] → 80% 機率落在此區間\n- 區間含正值 → 不能排除 QQQ 仍跑贏的可能性\n\n### 3.4 領先掃描結果（若執行）\n\n檢查 `diagnostics.lead_scan` 區塊：\n\n```json\n\"lead_scan\": {\n  \"best_lead_months\": 24,\n  \"correlation_by_lead\": {\n    \"6\": -0.15,\n    \"12\": -0.22,\n    \"18\": -0.28,\n    \"24\": -0.32,\n    \"30\": -0.30\n  }\n}\n```\n\n**解讀邏輯：**\n- 相關性在 24 個月達到最高（-0.32）\n- 18-30 個月區間相關性都較高，確認領先關係穩定\n\n### 3.5 穩定性驗證\n\n檢查 `diagnostics.stability_checks` 區塊：\n\n```json\n\"stability_checks\": {\n  \"first_half_corr\": -0.30,\n  \"second_half_corr\": -0.34,\n  \"consistency\": \"medium-high\"\n}\n```\n\n**解讀邏輯：**\n- 前半段與後半段相關性接近 → 關係跨時期穩定\n- `consistency` = \"medium-high\" → 領先關係可信度中高\n\n## Step 4: 生成視覺化圖表（可選）\n\n若需要視覺化，執行畫圖腳本：\n\n**基本版（利差 vs 相對報酬對齊圖）：**\n```bash\npython scripts/spread_plotter.py --quick --output-dir ../../output\n```\n\n**完整版（含領先掃描熱圖、預測區間）：**\n```bash\npython scripts/spread_plotter.py --comprehensive --start-date 2007-01-01 --output-dir ../../output\n```\n\n**完整版圖表包含：**\n1. 上圖：美國公債利差走勢（平移 lead_months 後）\n2. 中圖：QQQ/XLV 相對報酬走勢\n3. 下左：領先掃描相關性條形圖\n4. 下右：預測區間分佈\n\n圖表輸出路徑：\n- 基本版：`output/spread_forecast_YYYY-MM-DD.png`\n- 完整版：`output/spread_forecast_comprehensive_YYYY-MM-DD.png`\n\n## Step 5: 生成報告\n\n根據分析結果生成報告，使用 `templates/output-markdown.md` 或 `templates/output-json.md` 格式。\n\n**報告應包含：**\n1. 一句話結論（領先關係是否成立、預測方向）\n2. 當前利差狀態與歷史分位數\n3. 迴歸模型係數與解釋力\n4. 未來相對報酬預測（點估計與區間）\n5. 領先掃描結果（最佳領先期）\n6. 穩定性驗證結果\n7. 視覺化圖表（若生成）\n8. 風險提示（模型限制）\n9. 後續研究建議\n\n## Step 6: 後續研究建議\n\n根據分析結果提供交叉驗證建議：\n\n**若預測 XLV 跑贏（spread 高/倒掛）：**\n- 檢查經濟領先指標（如 ISM、消費者信心）\n- 檢查企業獲利預測修正方向\n- 觀察 Healthcare 防禦需求\n- 評估成長股估值分位\n\n**若預測 QQQ 跑贏（spread 低/變陡）：**\n- 檢查經濟復甦訊號\n- 觀察科技股資金流入\n- 評估利率對成長股估值影響\n\n**通用驗證：**\n- 比較其他利差組合（3M-10Y, 2Y-30Y）\n- 檢查 COT 持倉（利率期貨）\n- 觀察信用利差變化\n\n</process>\n\n<success_criteria>\n完成情境分析時應確認：\n\n- [ ] 參數確認（使用預設或用戶指定）\n- [ ] 腳本執行成功\n- [ ] 當前利差狀態解讀\n- [ ] 迴歸模型係數與顯著性\n- [ ] 未來相對報酬預測（點估計與區間）\n- [ ] 領先掃描結果（若執行）\n- [ ] 穩定性驗證結果\n- [ ] 視覺化圖表輸出（若需要）\n- [ ] 報告生成（含風險提示）\n- [ ] 後續研究建議\n</success_criteria>\n",
        "skills/forecast-sector-relative-return-from-yield-spread/workflows/data-research.md": "# Workflow: 數據源研究與替代方案\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/data-sources.md - 數據來源完整說明\n</required_reading>\n\n<process>\n\n## Step 1: 殖利率數據來源\n\n### 主要來源：FRED\n\nFRED 提供免費的美國國債殖利率數據：\n\n| 系列代碼 | 名稱                                    | 頻率 | 用途               |\n|----------|-----------------------------------------|------|--------------------|\n| DGS2     | 2-Year Treasury Constant Maturity Rate  | 日   | 短端殖利率（預設） |\n| DGS10    | 10-Year Treasury Constant Maturity Rate | 日   | 長端殖利率（預設） |\n| DGS3MO   | 3-Month Treasury Bill Secondary Market  | 日   | 極短端替代         |\n| DGS30    | 30-Year Treasury Constant Maturity Rate | 日   | 超長端替代         |\n\n**抓取方式：**\n```python\nimport pandas as pd\nimport requests\nfrom io import StringIO\n\nFRED_CSV_URL = \"https://fred.stlouisfed.org/graph/fredgraph.csv\"\n\ndef fetch_fred_series(series_id: str, start_date: str, end_date: str) -> pd.Series:\n    params = {\"id\": series_id, \"cosd\": start_date, \"coed\": end_date}\n    response = requests.get(FRED_CSV_URL, params=params, timeout=30)\n    response.raise_for_status()\n\n    df = pd.read_csv(StringIO(response.text))\n    df.columns = [\"DATE\", series_id]\n    df[\"DATE\"] = pd.to_datetime(df[\"DATE\"])\n    df[series_id] = df[series_id].replace(\".\", pd.NA)\n    df[series_id] = pd.to_numeric(df[series_id], errors=\"coerce\")\n    df = df.dropna().set_index(\"DATE\")\n    return df[series_id]\n```\n\n### 替代來源\n\n| 來源               | 優點           | 缺點                 |\n|--------------------|----------------|----------------------|\n| Yahoo Finance ^TNX | 即時更新       | 僅 10Y，需自行計算利差 |\n| Treasury.gov       | 官方原始       | 需手動下載 CSV       |\n| Quandl             | 多種期限       | 部分需付費           |\n\n## Step 2: 資產價格數據來源\n\n### 主要來源：Yahoo Finance (yfinance)\n\nyfinance 提供免費的 ETF/股票價格數據：\n\n**成長股代理：**\n| 代號 | 名稱                  | 說明                    |\n|------|-----------------------|-------------------------|\n| QQQ  | Invesco QQQ Trust     | Nasdaq 100 ETF（預設）  |\n| ^NDX | Nasdaq 100 Index      | 指數本身（數據可能不穩）|\n| TQQQ | ProShares UltraPro QQQ| 3x 槓桿（僅供參考）     |\n| IWF  | iShares Russell 1000 Growth | 更廣義成長股      |\n\n**防禦股代理：**\n| 代號 | 名稱                          | 說明                    |\n|------|-------------------------------|-------------------------|\n| XLV  | Health Care Select Sector SPDR| Healthcare ETF（預設）  |\n| VHT  | Vanguard Health Care ETF      | 更廣泛 Healthcare       |\n| IYH  | iShares U.S. Healthcare ETF   | 替代方案                |\n| XLP  | Consumer Staples Select Sector| 消費必需品（另一防禦）  |\n\n**抓取方式：**\n```python\nimport yfinance as yf\n\ndef fetch_price_series(ticker: str, start_date: str, end_date: str, freq: str = \"1wk\") -> pd.Series:\n    data = yf.download(ticker, start=start_date, end=end_date, interval=freq, progress=False)\n    return data[\"Adj Close\"]\n```\n\n### 替代來源\n\n| 來源           | 優點             | 缺點               |\n|----------------|------------------|--------------------|\n| Alpha Vantage  | 免費 API         | 有速率限制         |\n| Tiingo         | 歷史數據完整     | 需註冊             |\n| Polygon.io     | 專業級數據       | 付費                |\n\n## Step 3: 其他利差組合\n\n除了預設的 2Y-10Y，可考慮其他組合：\n\n| 組合      | 計算               | 特點                       |\n|-----------|--------------------|----------------------------|\n| 3M-10Y    | DGS10 - DGS3MO     | 最常見衰退指標             |\n| 2Y-10Y    | DGS10 - DGS2       | 中期預期（本 skill 預設）  |\n| 2Y-30Y    | DGS30 - DGS2       | 長期結構性預期             |\n| 5Y-30Y    | DGS30 - DGS5       | 超長端斜率                 |\n\n**注意**：不同利差組合可能有不同的最佳領先期。\n\n## Step 4: 數據品質檢查\n\n### 常見問題與處理\n\n1. **缺失值**\n   - FRED 使用 `.` 表示缺失\n   - 處理：`df[col].replace(\".\", pd.NA)` + `dropna()`\n\n2. **時區對齊**\n   - FRED 為美東時間，yfinance 可能不一致\n   - 處理：統一使用日期（無時間），以收盤價為準\n\n3. **非交易日**\n   - 債券市場與股票市場假日不同\n   - 處理：resample 到週頻後 inner join\n\n4. **股息調整**\n   - 使用 `Adj Close` 而非 `Close`\n   - 確保含股息再投資效果\n\n### 驗證腳本\n\n```python\ndef validate_data(yield_df, price_df):\n    \"\"\"驗證數據品質\"\"\"\n    issues = []\n\n    # 檢查缺失值\n    if yield_df.isna().sum() > len(yield_df) * 0.05:\n        issues.append(\"殖利率數據缺失超過 5%\")\n\n    if price_df.isna().sum() > len(price_df) * 0.05:\n        issues.append(\"價格數據缺失超過 5%\")\n\n    # 檢查日期範圍\n    if yield_df.index.min() > price_df.index.min():\n        issues.append(f\"殖利率數據起始較晚: {yield_df.index.min()}\")\n\n    # 檢查異常值\n    if (yield_df > 20).any():\n        issues.append(\"殖利率超過 20%，可能有異常值\")\n\n    if (price_df < 0).any():\n        issues.append(\"價格為負，數據有誤\")\n\n    return issues\n```\n\n## Step 5: Fallback 策略\n\n當主要數據源不可用時：\n\n1. **FRED 不可用**\n   - 使用 Yahoo Finance ^TNX（10Y）\n   - 使用 cached 數據（若有）\n\n2. **yfinance 不可用**\n   - 使用 Alpha Vantage\n   - 使用本地 CSV 備份\n\n3. **特定 ETF 不存在**\n   - QQQ 替代：^NDX 或 IWF\n   - XLV 替代：VHT 或 IYH\n\n**實作範例：**\n```python\ndef fetch_with_fallback(primary_ticker, fallback_tickers, start_date, end_date):\n    for ticker in [primary_ticker] + fallback_tickers:\n        try:\n            data = yf.download(ticker, start=start_date, end=end_date, progress=False)\n            if not data.empty:\n                return data[\"Adj Close\"], ticker\n        except Exception as e:\n            print(f\"Failed to fetch {ticker}: {e}\")\n\n    raise ValueError(\"All data sources failed\")\n```\n\n</process>\n\n<success_criteria>\n數據研究完成時應確認：\n\n- [ ] 了解殖利率主要與替代來源\n- [ ] 了解資產價格主要與替代來源\n- [ ] 了解不同利差組合選項\n- [ ] 了解數據品質檢查方法\n- [ ] 了解 Fallback 策略\n</success_criteria>\n",
        "skills/google-trends-ath-detector/SKILL.md": "---\nname: google-trends-ath-detector\ndescription: 專注於 Google Trends 數據擷取與分析，使用 Selenium 模擬真人瀏覽器行為抓取數據，自動判定搜尋趨勢是否創下歷史新高（ATH）或出現異常飆升，並提供訊號分型（季節性/事件驅動/結構性轉變）。\n---\n\n<essential_principles>\n**Google Trends ATH Detector 核心原則**\n\n**1. 模擬真人瀏覽器行為抓取 Google Trends**\n\n本技能使用 Selenium 模擬真人瀏覽器：\n- 移除 `navigator.webdriver` 自動化標記\n- 隨機輪換 User-Agent（Chrome/Firefox/Safari）\n- 請求間隨機延遲（0.5-2 秒）\n- 先訪問首頁建立 session，再抓取數據\n\n**2. 訊號分型（Signal Typing）**\n\n搜尋趨勢飆升分為三種類型：\n\n| 類型               | 特徵                 | 解讀                         |\n|--------------------|----------------------|------------------------------|\n| Seasonal spike     | 每年固定月份重複     | 制度性週期（投保季、報稅季） |\n| Event-driven shock | 短期尖峰、z-score 高 | 新聞/政策/突發事件           |\n| Regime shift       | 趨勢線上移、持續高位 | 結構性關注上升               |\n\n**3. 分析公式**\n\n```\nATH 判定：latest_value >= max(history) * 0.98\n異常判定：zscore >= threshold (default: 2.5)\n訊號分型：based on (is_ath, is_anomaly, trend_direction)\n```\n\n**4. 描述性分析優先**\n\n本技能提供**客觀的數學分析結果**：\n- 輸出訊號類型、異常分數等量化指標\n- 提取 related queries 作為驅動因素參考\n- 由用戶根據專業知識自行解讀\n</essential_principles>\n\n<intake>\n**您想要執行什麼操作？**\n\n1. **Detect** - 快速偵測是否創下 ATH 或出現異常\n2. **Analyze** - 深度分析訊號類型與驅動因素\n3. **Compare** - 比較多個主題的趨勢共振\n\n**等待回應後再繼續。**\n</intake>\n\n<routing>\n| Response                                  | Workflow             | Description         |\n|-------------------------------------------|----------------------|---------------------|\n| 1, \"detect\", \"ath\", \"check\", \"是否創新高\" | workflows/detect.md  | 快速偵測 ATH 與異常 |\n| 2, \"analyze\", \"deep\", \"分析\", \"訊號\"      | workflows/analyze.md | 深度分析與訊號分型  |\n| 3, \"compare\", \"對照\", \"共振\"              | workflows/compare.md | 多主題趨勢比較      |\n\n**讀取工作流程後，請完全遵循其步驟。**\n</routing>\n\n<reference_index>\n**參考文件** (`references/`)\n\n| 文件                 | 內容                                       |\n|----------------------|--------------------------------------------|\n| input-schema.md      | 完整輸入參數定義與預設值                   |\n| data-sources.md      | Google Trends 數據來源與 Selenium 爬取指南 |\n| signal-types.md      | 訊號分型定義與判定邏輯                     |\n| seasonality-guide.md | 季節性分解方法與解讀                       |\n</reference_index>\n\n<workflows_index>\n| Workflow   | Purpose                      |\n|------------|------------------------------|\n| detect.md  | 快速偵測 ATH 與異常分數      |\n| analyze.md | 深度分析、訊號分型、驅動詞彙 |\n| compare.md | 多主題趨勢共振分析           |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose              |\n|--------------------|----------------------|\n| output-schema.yaml | 標準輸出 JSON schema |\n</templates_index>\n\n<scripts_index>\n| Script           | Purpose                           |\n|------------------|-----------------------------------|\n| trend_fetcher.py | 核心爬蟲與分析邏輯（Selenium 版） |\n</scripts_index>\n\n<examples_index>\n**範例輸出** (`examples/`)\n\n| 文件                        | 內容                          |\n|-----------------------------|-------------------------------|\n| health_insurance_ath.json   | Health Insurance ATH 偵測範例 |\n| seasonal_vs_anomaly.json    | 季節性 vs 異常判定範例        |\n| multi_topic_comparison.json | 多主題比較範例                |\n</examples_index>\n\n<quick_start>\n**快速開始：安裝依賴**\n\n```bash\npip install selenium webdriver-manager beautifulsoup4 lxml loguru\n```\n\n**Python API：**\n\n```python\nfrom scripts.trend_fetcher import fetch_trends, analyze_ath\n\n# 抓取數據（使用 Selenium 模擬瀏覽器）\ndata = fetch_trends(\n    topic=\"Health Insurance\",\n    geo=\"US\",\n    timeframe=\"2004-01-01 2025-12-31\"\n)\n\n# ATH 分析\nresult = analyze_ath(data, threshold=2.5)\n\nprint(f\"Is ATH: {result['analysis']['is_all_time_high']}\")\nprint(f\"Signal Type: {result['analysis']['signal_type']}\")\nprint(f\"Z-Score: {result['analysis']['zscore']}\")\n```\n\n**CLI 快速開始：**\n\n```bash\n# 基本分析\npython scripts/trend_fetcher.py \\\n  --topic \"Health Insurance\" \\\n  --geo US \\\n  --output ./output/health_insurance.json\n\n# 比較多個主題\npython scripts/trend_fetcher.py \\\n  --topic \"Health Insurance\" \\\n  --compare \"Unemployment,Inflation\" \\\n  --geo US \\\n  --output ./output/comparison.json\n\n# 跳過 related queries（更快、更少請求）\npython scripts/trend_fetcher.py \\\n  --topic \"Health Insurance\" \\\n  --no-related \\\n  --output ./output/health_insurance.json\n\n# Debug 模式（顯示瀏覽器、保存 HTML）\npython scripts/trend_fetcher.py \\\n  --topic \"Health Insurance\" \\\n  --debug \\\n  --no-headless\n\n# 登入模式（預設等待 120 秒供 2FA 驗證）\npython scripts/trend_fetcher.py \\\n  --topic \"Health Insurance\" \\\n  --output ./output/health_insurance.json\n\n# 跳過登入等待（不需要登入時）\npython scripts/trend_fetcher.py \\\n  --topic \"Health Insurance\" \\\n  --login-wait 0 \\\n  --output ./output/health_insurance.json\n\n# 從已下載的 CSV 檔案分析（跳過瀏覽器抓取）\npython scripts/trend_fetcher.py \\\n  --topic \"Health Insurance\" \\\n  --csv ./downloads/multiTimeline.csv \\\n  --output ./output/health_insurance.json\n\n# 自動從 Downloads 目錄找最新 CSV\npython scripts/trend_fetcher.py \\\n  --topic \"Health Insurance\" \\\n  --csv auto \\\n  --output ./output/health_insurance.json\n```\n\n**CLI 參數說明：**\n\n| 參數            | 說明                           | 預設值                |\n|-----------------|--------------------------------|-----------------------|\n| `--topic`       | 搜尋主題（必要）               | -                     |\n| `--geo`         | 地區代碼                       | US                    |\n| `--timeframe`   | 時間範圍                       | 2004-01-01 2025-12-31 |\n| `--threshold`   | 異常 z-score 門檻              | 2.5                   |\n| `--compare`     | 比較主題（逗號分隔）           | -                     |\n| `--no-related`  | 跳過 related queries           | false                 |\n| `--no-headless` | 顯示瀏覽器視窗                 | false                 |\n| `--login`       | 強制啟用登入模式               | false                 |\n| `--login-wait`  | 登入等待秒數（0=互動式 Enter） | 120                   |\n| `--csv`         | CSV 檔案路徑或 'auto' 自動尋找 | -                     |\n| `--debug`       | 啟用調試模式                   | false                 |\n| `--output`      | 輸出 JSON 檔案路徑             | -                     |\n</quick_start>\n\n<success_criteria>\nSkill 成功執行時：\n- [ ] Selenium 成功啟動並模擬瀏覽器\n- [ ] 正確抓取 Google Trends 時間序列\n- [ ] 判定 ATH 狀態與異常分數\n- [ ] 識別訊號類型（seasonal/event/regime）\n- [ ] 提取 related queries 驅動詞彙（若啟用）\n- [ ] 輸出結構化 JSON 結果\n</success_criteria>\n\n<anti_detection_strategy>\n**防偵測策略摘要**\n\n本技能實現以下防偵測措施（基於 design-human-like-crawler.md）：\n\n| 策略                       | 效果               | 優先級  |\n|----------------------------|--------------------|---------|\n| 移除 `navigator.webdriver` | 核心，防止 JS 偵測 | 🔴 必要 |\n| 隨機 User-Agent            | 避免固定 UA 被識別 | 🔴 必要 |\n| 請求前隨機延遲             | 模擬人類行為       | 🔴 必要 |\n| 禁用自動化擴展             | 移除 Chrome 痕跡   | 🟡 建議 |\n| 先訪問首頁再 API           | 建立正常 session   | 🟡 建議 |\n\n**Chrome 選項配置：**\n\n```python\nchrome_options.add_argument('--disable-blink-features=AutomationControlled')\nchrome_options.add_experimental_option('excludeSwitches', ['enable-automation'])\nchrome_options.add_experimental_option('useAutomationExtension', False)\n```\n</anti_detection_strategy>\n",
        "skills/google-trends-ath-detector/references/data-sources.md": "<overview>\nGoogle Trends ATH Detector 專用數據來源指南。本技能使用 Selenium 模擬真人瀏覽器行為抓取 Google Trends 數據。\n</overview>\n\n<google_trends>\n**Google Trends 數據**\n\n| 項目     | 說明                       |\n|----------|----------------------------|\n| 官網     | https://trends.google.com  |\n| 擷取方式 | Selenium + Chrome headless |\n| 數據類型 | 相對搜尋指數（0-100）      |\n| 更新頻率 | 接近即時（2-3 天延遲）     |\n| 歷史數據 | 2004 年至今                |\n</google_trends>\n\n<data_types>\n**可取得的數據類型**\n\n| 數據類型           | API 端點        | 說明                        |\n|--------------------|-----------------|-----------------------------|\n| Interest over time | multiline       | 搜尋趨勢時間序列            |\n| Related queries    | relatedsearches | 相關搜尋詞（Top 與 Rising） |\n| Related topics     | relatedsearches | 相關主題                    |\n| Interest by region | comparedgeo     | 地區分布                    |\n</data_types>\n\n<selenium_approach>\n**Selenium 爬取方式（本技能使用）**\n\n本技能的 `scripts/trend_fetcher.py` 使用 Selenium 模擬真人瀏覽器行為：\n\n**安裝依賴：**\n\n```bash\npip install selenium webdriver-manager beautifulsoup4 lxml loguru\n```\n\n**基本使用：**\n\n```python\nfrom scripts.trend_fetcher import fetch_trends, analyze_ath\n\n# 抓取數據（Selenium 自動處理 session 和 tokens）\ndata = fetch_trends(\n    topic=\"Health Insurance\",\n    geo=\"US\",\n    timeframe=\"2004-01-01 2025-12-31\"\n)\n\n# ATH 分析\nresult = analyze_ath(data, threshold=2.5)\n```\n\n**優點：**\n- 模擬真人瀏覽器，避免被偵測\n- 自動處理 JavaScript 渲染\n- 內建防偵測策略\n- 自動管理 ChromeDriver 版本\n</selenium_approach>\n\n<anti_detection_strategy>\n**防偵測策略**\n\n本技能實現以下防偵測措施（基於 design-human-like-crawler.md）：\n\n| 策略                | 實作                                            | 效果               |\n|---------------------|-------------------------------------------------|--------------------|\n| 移除 webdriver 標記 | `--disable-blink-features=AutomationControlled` | 防止 JS 偵測       |\n| 隨機 User-Agent     | 5 種瀏覽器 UA 輪換                              | 避免固定 UA 被識別 |\n| 隨機延遲            | 0.5-2 秒 + 3-5 秒頁面等待                       | 模擬人類行為       |\n| 禁用自動化擴展      | `excludeSwitches: ['enable-automation']`        | 移除 Chrome 痕跡   |\n| 先訪問首頁          | 建立正常 session                                | 避免直接 API 請求  |\n\n**User-Agent 池：**\n\n```python\nUSER_AGENTS = [\n    # Windows Chrome\n    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36...',\n    # macOS Chrome\n    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36...',\n    # Windows Firefox\n    'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101...',\n    # macOS Safari\n    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15...',\n    # Linux Chrome\n    'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36...'\n]\n```\n\n**Chrome 配置：**\n\n```python\nchrome_options = Options()\nchrome_options.add_argument('--headless')\nchrome_options.add_argument('--no-sandbox')\nchrome_options.add_argument('--disable-dev-shm-usage')\nchrome_options.add_argument('--disable-gpu')\n\n# 核心防偵測設定\nchrome_options.add_argument('--disable-blink-features=AutomationControlled')\nchrome_options.add_experimental_option('excludeSwitches', ['enable-automation'])\nchrome_options.add_experimental_option('useAutomationExtension', False)\n```\n</anti_detection_strategy>\n\n<crawl_flow>\n**爬取流程**\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                     爬蟲流程總覽                              │\n├─────────────────────────────────────────────────────────────┤\n│                                                              │\n│  1. 請求前準備                                               │\n│     ├─ 隨機延遲 (0.5-2 秒)                                  │\n│     ├─ 隨機選擇 User-Agent                                  │\n│     └─ 配置瀏覽器選項 (移除自動化標記)                       │\n│                                                              │\n│  2. Session 建立                                             │\n│     ├─ 先訪問 trends.google.com 首頁                        │\n│     ├─ 等待 cookies 建立 (2-3 秒)                           │\n│     └─ 瀏覽器保持同一 session                               │\n│                                                              │\n│  3. API 請求                                                 │\n│     ├─ 訪問 /api/explore 取得 widget tokens                 │\n│     ├─ 訪問 /api/widgetdata/multiline 取得時間序列          │\n│     └─ （可選）訪問 /api/widgetdata/relatedsearches         │\n│                                                              │\n│  4. 數據解析                                                 │\n│     ├─ 移除 XSS 保護前綴 \")]}'\\\\n\"                          │\n│     ├─ JSON 解析                                             │\n│     └─ 提取 timelineData                                    │\n│                                                              │\n│  5. 清理                                                     │\n│     └─ driver.quit() 關閉瀏覽器                             │\n│                                                              │\n└─────────────────────────────────────────────────────────────┘\n```\n</crawl_flow>\n\n<topic_vs_keyword>\n**Topic Entity vs Search Term**\n\nGoogle Trends 支援兩種查詢方式：\n\n| 類型         | 說明                 | 優點                   | 缺點               |\n|--------------|----------------------|------------------------|--------------------|\n| Topic Entity | Knowledge Graph 實體 | 避免歧義、涵蓋語言變體 | 部分主題無對應實體 |\n| Search Term  | 純文字關鍵字         | 精確匹配               | 可能錯過變體       |\n\n**範例：**\n- \"Apple\" 作為 Search Term → 包含水果和公司\n- \"Apple\" 作為 Topic (Tech company) → 僅限蘋果公司\n\n**如何找 Topic Entity：**\n1. 在 trends.google.com 搜尋關鍵字\n2. 點選自動完成建議中帶有分類描述的項目\n3. URL 中的 mid 參數即為 Topic Entity ID\n</topic_vs_keyword>\n\n<timeframe_formats>\n**時間範圍格式**\n\n```python\n# 絕對時間範圍\n\"2004-01-01 2025-12-31\"  # YYYY-MM-DD YYYY-MM-DD\n\n# 相對時間範圍\n\"today 5-y\"              # 過去 5 年\n\"today 12-m\"             # 過去 12 個月\n\"today 3-m\"              # 過去 3 個月\n\"now 7-d\"                # 過去 7 天\n\"now 1-H\"                # 過去 1 小時\n```\n\n**粒度自動選擇：**\n\n| 時間範圍      | 自動粒度 |\n|---------------|----------|\n| < 7 天        | 小時     |\n| 7 天 - 9 個月 | 日       |\n| 9 個月 - 5 年 | 週       |\n| > 5 年        | 月       |\n</timeframe_formats>\n\n<geo_codes>\n**常用地區代碼**\n\n| 代碼  | 地區     |\n|-------|----------|\n| (空)  | 全球     |\n| US    | 美國     |\n| US-CA | 美國加州 |\n| GB    | 英國     |\n| DE    | 德國     |\n| JP    | 日本     |\n| TW    | 台灣     |\n| CN    | 中國     |\n| HK    | 香港     |\n| SG    | 新加坡   |\n\n完整列表見 Google Trends 網站的地區選擇器。\n</geo_codes>\n\n<rate_limits>\n**速率限制與建議**\n\n| 情況           | 限制        | 建議                    |\n|----------------|-------------|-------------------------|\n| 正常使用       | ~10 req/min | 每次請求間隔 1-3 秒     |\n| 被偵測為機器人 | 429 錯誤    | 使用 VPN/代理、增加延遲 |\n| 長時間大量抓取 | 可能被封鎖  | 分散請求時間、使用多 IP |\n\n**最佳實踐：**\n1. 模擬瀏覽器行為（Selenium + 防偵測配置）\n2. 請求間加入隨機延遲（1-3 秒）\n3. 先訪問首頁再進行 API 請求\n4. 若被封鎖，等待 24 小時或更換 IP\n5. 使用 `--no-related` 減少請求數量\n</rate_limits>\n\n<related_queries_guide>\n**Related Queries 解讀指南**\n\n| 類型     | 說明                 | 用途                   |\n|----------|----------------------|------------------------|\n| Top      | 最常被搜尋的相關詞   | 了解主要關聯概念       |\n| Rising   | 上升幅度最大的相關詞 | 識別新興趨勢與驅動因素 |\n| Breakout | 上升超過 5000%       | 全新出現的高熱度關鍵詞 |\n\n**範例解讀：**\n- Rising: \"ACA enrollment deadline +450%\" → 投保截止日驅動搜尋\n- Breakout: \"new health law\" → 新政策引發關注\n- Top: \"health insurance plans\" → 常態性搜尋需求\n</related_queries_guide>\n\n<troubleshooting>\n**常見問題處理**\n\n**問題 1：抓取失敗 / 被封鎖**\n\n```bash\n# 使用 debug 模式查看問題\npython scripts/trend_fetcher.py --topic \"test\" --debug --no-headless\n```\n\n**問題 2：ChromeDriver 版本不匹配**\n\n```bash\n# webdriver-manager 會自動下載匹配版本\n# 若仍有問題，嘗試更新：\npip install --upgrade webdriver-manager\n```\n\n**問題 3：Linux/Docker 環境**\n\n```bash\n# 確保安裝必要依賴\napt-get update && apt-get install -y \\\n    chromium-browser \\\n    chromium-chromedriver\n```\n\n**問題 4：記憶體洩漏**\n\n```python\n# 確保 driver 正確關閉\nfinally:\n    if driver:\n        driver.quit()  # 使用 quit() 而非 close()\n```\n</troubleshooting>\n\n<alternative_attention_proxies>\n**輔助參考資料（可選）**\n\n若需進一步驗證 Google Trends 訊號，可參考以下公開資料：\n\n| 來源                | 網址                          | 用途             |\n|---------------------|-------------------------------|------------------|\n| Wikipedia Pageviews | https://pageviews.wmcloud.org | 驗證特定主題熱度 |\n| Google News         | https://news.google.com       | 搜尋相關新聞事件 |\n| Reddit              | https://www.reddit.com        | 社群討論熱度     |\n\n**注意：** 這些資料僅供手動參考驗證，本技能不自動抓取。\n</alternative_attention_proxies>\n",
        "skills/google-trends-ath-detector/references/input-schema.md": "<overview>\n完整的 Google Trends ATH Detector 輸入參數定義與預設值。\n</overview>\n\n<required_parameters>\n**必要參數**\n\n| 參數      | 類型   | 說明                       | 範例                    |\n|-----------|--------|----------------------------|-------------------------|\n| topic     | string | Google Trends 主題或關鍵字 | \"Health Insurance\"      |\n| geo       | string | 地區代碼                   | \"US\", \"TW\", \"JP\", \"GB\"  |\n| timeframe | string | 時間範圍                   | \"2004-01-01 2025-12-31\" |\n</required_parameters>\n\n<optional_parameters>\n**可選參數**\n\n| 參數                | 類型    | 預設值         | 說明                                       |\n|---------------------|---------|----------------|--------------------------------------------|\n| granularity         | string  | \"weekly\"       | 數據粒度：daily, weekly, monthly           |\n| use_topic_entity    | boolean | true           | 使用 Topic Entity 而非純關鍵字             |\n| smoothing_window    | int     | 4              | 平滑視窗（週數）                           |\n| seasonality_method  | string  | \"stl\"          | 季節性分解：none, stl, month_fixed_effects |\n| ath_lookback_policy | string  | \"full_history\" | ATH 定義範圍：full_history, last_n_years   |\n| anomaly_method      | string  | \"zscore\"       | 異常偵測：zscore, mad, changepoint         |\n| anomaly_threshold   | number  | 2.5            | 異常門檻                                   |\n| compare_terms       | array   | []             | 對照主題                                   |\n| related_queries     | boolean | true           | 是否抓取 related queries                   |\n| event_calendars     | array   | []             | 事件日曆來源                               |\n| chart_image_path    | string  | null           | 圖表截圖路徑（驗證用）                     |\n| output_mode         | string  | \"json\"         | 輸出格式：json, markdown                   |\n</optional_parameters>\n\n<parameter_details>\n**granularity 詳解**\n\n| 值      | 說明     | 適用場景                          |\n|---------|----------|-----------------------------------|\n| daily   | 每日數據 | 短期分析（< 90 天），但可能有噪音 |\n| weekly  | 每週數據 | 最常用，平衡精度與穩定性          |\n| monthly | 每月數據 | 長期趨勢分析，較平滑              |\n\n**注意：** Google Trends 對長時間範圍（> 5 年）只提供週或月數據。\n\n---\n\n**use_topic_entity 詳解**\n\nGoogle Trends 支援兩種查詢方式：\n\n1. **Topic Entity（推薦）**\n   - 使用 Google Knowledge Graph 的實體\n   - 範例：\"Health Insurance\" 作為 Topic 會涵蓋所有語言變體\n   - 避免同名歧義（如 \"Apple\" 公司 vs 水果）\n\n2. **Search Term**\n   - 純文字關鍵字匹配\n   - 更精確但可能錯過變體\n\n```python\n# pytrends 中的使用方式\nif use_topic_entity:\n    # 先搜尋 Topic ID\n    suggestions = pytrends.suggestions(keyword='Health Insurance')\n    topic_mid = suggestions[0]['mid']  # 如 '/m/01b9s0'\n    kw_list = [topic_mid]\nelse:\n    kw_list = ['Health Insurance']\n```\n\n---\n\n**seasonality_method 詳解**\n\n| 方法                | 說明         | 適用場景                 |\n|---------------------|--------------|--------------------------|\n| none                | 不做分解     | 快速分析或季節性不重要時 |\n| stl                 | STL 分解     | 標準方法，適合大多數情況 |\n| month_fixed_effects | 月份固定效果 | 當季節性規律且穩定時     |\n\n---\n\n**anomaly_method 詳解**\n\n| 方法        | 說明                      | 優點                | 缺點         |\n|-------------|---------------------------|---------------------|--------------|\n| zscore      | 標準分數                  | 簡單直觀            | 受極端值影響 |\n| mad         | Median Absolute Deviation | 抗極端值            | 計算較複雜   |\n| changepoint | 變點偵測                  | 能識別 regime shift | 需要更多數據 |\n\n---\n\n**ath_lookback_policy 詳解**\n\n| 值           | 說明          | 適用場景                         |\n|--------------|---------------|----------------------------------|\n| full_history | 比較全歷史    | 嚴格的「歷史新高」定義           |\n| last_n_years | 只比較近 N 年 | 避免久遠數據干擾（結構可能已變） |\n</parameter_details>\n\n<timeframe_format>\n**timeframe 格式說明**\n\npytrends 支援多種時間範圍格式：\n\n```python\n# 絕對時間範圍\n\"2004-01-01 2025-12-31\"  # YYYY-MM-DD YYYY-MM-DD\n\n# 相對時間範圍\n\"today 5-y\"              # 過去 5 年\n\"today 12-m\"             # 過去 12 個月\n\"today 3-m\"              # 過去 3 個月\n\"now 7-d\"                # 過去 7 天\n\"now 1-H\"                # 過去 1 小時\n```\n\n**建議：**\n- ATH 分析使用最長歷史（\"2004-01-01 today\"）\n- 近期異常分析使用 \"today 5-y\"\n- 事件分析使用特定時間窗口\n</timeframe_format>\n\n<geo_codes>\n**常用地區代碼**\n\n| 代碼  | 地區     |\n|-------|----------|\n| (空)  | 全球     |\n| US    | 美國     |\n| US-CA | 美國加州 |\n| GB    | 英國     |\n| DE    | 德國     |\n| JP    | 日本     |\n| TW    | 台灣     |\n| CN    | 中國     |\n| HK    | 香港     |\n| SG    | 新加坡   |\n\n完整列表見：Google Trends 網站的地區選擇器\n</geo_codes>\n\n<validation_rules>\n**參數驗證規則**\n\n```python\ndef validate_params(params):\n    errors = []\n\n    # topic 必填且非空\n    if not params.get('topic'):\n        errors.append(\"topic 是必要參數\")\n\n    # geo 必填\n    if not params.get('geo'):\n        errors.append(\"geo 是必要參數\")\n\n    # timeframe 格式驗證\n    timeframe = params.get('timeframe', '')\n    if not is_valid_timeframe(timeframe):\n        errors.append(f\"無效的 timeframe 格式: {timeframe}\")\n\n    # anomaly_threshold 範圍\n    threshold = params.get('anomaly_threshold', 2.5)\n    if threshold < 1.0 or threshold > 5.0:\n        errors.append(\"anomaly_threshold 建議在 1.0-5.0 之間\")\n\n    # smoothing_window 範圍\n    window = params.get('smoothing_window', 4)\n    if window < 1 or window > 12:\n        errors.append(\"smoothing_window 建議在 1-12 之間\")\n\n    return errors\n```\n</validation_rules>\n",
        "skills/google-trends-ath-detector/references/seasonality-guide.md": "<overview>\n季節性分解方法詳解。用於區分「真正的異常」與「預期的季節性波動」。\n</overview>\n\n<why_seasonality_matters>\n**為什麼季節性分析重要**\n\n很多搜尋趨勢有固定的年度週期：\n- **Health Insurance**：每年 11-12 月 Open Enrollment 期間上升\n- **Tax**：每年 1-4 月報稅季上升\n- **Flu**：每年秋冬季上升\n- **Travel**：每年暑假和節日期間上升\n\n如果不做季節性分解，可能把**正常的季節性高點**誤判為**異常飆升**。\n\n**核心問題：**\n> 「這個高點是『每年這時候都會這樣』還是『今年特別不尋常』？」\n</why_seasonality_matters>\n\n<stl_decomposition>\n**STL 分解（推薦方法）**\n\nSTL = Seasonal and Trend decomposition using Loess\n\n**原理：**\n將時間序列分解為三個組成部分：\n```\nY(t) = Trend(t) + Seasonal(t) + Residual(t)\n```\n\n| 組成 | 說明 | 用途 |\n|------|------|------|\n| Trend | 長期趨勢 | 識別結構性變化 |\n| Seasonal | 季節性模式 | 識別週期性波動 |\n| Residual | 殘差 | 識別真正的異常 |\n\n**Python 實作：**\n\n```python\nfrom statsmodels.tsa.seasonal import STL\nimport pandas as pd\n\ndef stl_decompose(ts, granularity='weekly'):\n    \"\"\"\n    執行 STL 季節性分解\n\n    Args:\n        ts: pandas Series with DatetimeIndex\n        granularity: 'weekly' or 'monthly'\n\n    Returns:\n        dict with trend, seasonal, resid, seasonal_strength\n    \"\"\"\n    # 確定週期\n    period = 52 if granularity == 'weekly' else 12\n\n    # 移除 NaN\n    ts_clean = ts.dropna()\n\n    # 需要至少 2 個週期的數據\n    if len(ts_clean) < period * 2:\n        raise ValueError(f\"需要至少 {period * 2} 個數據點\")\n\n    # STL 分解\n    stl = STL(ts_clean, period=period, robust=True)\n    result = stl.fit()\n\n    # 計算季節性強度\n    # 公式: 1 - Var(Residual) / Var(Seasonal + Residual)\n    seasonal_plus_resid = result.seasonal + result.resid\n    seasonal_strength = 1 - result.resid.var() / seasonal_plus_resid.var()\n\n    return {\n        'trend': result.trend,\n        'seasonal': result.seasonal,\n        'resid': result.resid,\n        'seasonal_strength': round(seasonal_strength, 3)\n    }\n```\n\n**季節性強度解讀：**\n\n| 範圍 | 解讀 |\n|------|------|\n| > 0.7 | 強季節性（模式主導） |\n| 0.4 - 0.7 | 中等季節性 |\n| 0.2 - 0.4 | 弱季節性 |\n| < 0.2 | 幾乎無季節性 |\n</stl_decomposition>\n\n<deseasonalized_analysis>\n**去季節化分析**\n\n去季節化後的序列 = 原序列 - 季節性成分\n\n```python\ndef get_deseasonalized(ts, decomposition):\n    \"\"\"取得去季節化序列\"\"\"\n    return ts - decomposition['seasonal']\n\ndef analyze_deseasonalized_anomaly(deseasonalized, method='zscore', threshold=2.5):\n    \"\"\"\n    在去季節化序列上進行異常偵測\n\n    這才是「真正的異常」，因為已經排除了季節性因素\n    \"\"\"\n    if method == 'zscore':\n        mean = deseasonalized.mean()\n        std = deseasonalized.std()\n        zscore = (deseasonalized.iloc[-1] - mean) / std\n        is_anomaly = abs(zscore) >= threshold\n        return {\n            'method': 'zscore',\n            'score': round(zscore, 2),\n            'is_anomaly': is_anomaly,\n            'interpretation': '去季節化後仍顯著異常' if is_anomaly else '季節性可解釋大部分波動'\n        }\n```\n</deseasonalized_analysis>\n\n<month_fixed_effects>\n**月份固定效果（替代方法）**\n\n當季節性模式非常規律且穩定時，可以用更簡單的月份固定效果：\n\n```python\ndef month_fixed_effects_adjustment(ts):\n    \"\"\"\n    用月份固定效果調整季節性\n\n    適用於：季節性非常穩定、變化不大的主題\n    \"\"\"\n    # 計算每個月的平均值\n    monthly_mean = ts.groupby(ts.index.month).transform('mean')\n\n    # 計算整體平均值\n    overall_mean = ts.mean()\n\n    # 月份效果 = 月平均 - 整體平均\n    month_effect = monthly_mean - overall_mean\n\n    # 去季節化 = 原值 - 月份效果\n    deseasonalized = ts - month_effect\n\n    return deseasonalized, month_effect\n```\n\n**與 STL 的比較：**\n\n| 特性 | STL | 月份固定效果 |\n|------|-----|--------------|\n| 靈活性 | 高（季節性可隨時間變化） | 低（假設季節性恆定） |\n| 計算複雜度 | 較高 | 很低 |\n| 數據需求 | 至少 2 個週期 | 至少 1 個週期 |\n| 適用場景 | 通用 | 穩定季節性 |\n</month_fixed_effects>\n\n<seasonal_comparison>\n**同期比較分析**\n\n另一種處理季節性的方法是直接比較「今年 vs 歷史同期」：\n\n```python\ndef compare_to_same_period(ts, lookback_years=5):\n    \"\"\"\n    比較當前值與歷史同期\n\n    Args:\n        ts: pandas Series with DatetimeIndex\n        lookback_years: 回看年數\n\n    Returns:\n        dict with percentile, comparison stats\n    \"\"\"\n    current_month = ts.index[-1].month\n    current_week = ts.index[-1].isocalendar().week\n    current_value = ts.iloc[-1]\n\n    # 收集歷史同期數據\n    historical_same_period = []\n    for year in range(ts.index[-1].year - lookback_years, ts.index[-1].year):\n        mask = (ts.index.year == year) & (ts.index.month == current_month)\n        if mask.any():\n            historical_same_period.extend(ts[mask].values)\n\n    if not historical_same_period:\n        return {'error': '歷史同期數據不足'}\n\n    # 計算百分位數\n    percentile = (sum(v < current_value for v in historical_same_period)\n                  / len(historical_same_period) * 100)\n\n    return {\n        'current_value': float(current_value),\n        'historical_same_period_mean': round(sum(historical_same_period) / len(historical_same_period), 1),\n        'historical_same_period_max': max(historical_same_period),\n        'historical_same_period_min': min(historical_same_period),\n        'percentile_vs_same_period': round(percentile, 1),\n        'interpretation': interpret_percentile(percentile)\n    }\n\ndef interpret_percentile(percentile):\n    if percentile >= 95:\n        return \"顯著高於歷史同期（異常）\"\n    elif percentile >= 75:\n        return \"高於歷史同期平均\"\n    elif percentile >= 25:\n        return \"接近歷史同期平均\"\n    else:\n        return \"低於歷史同期平均\"\n```\n</seasonal_comparison>\n\n<common_seasonal_patterns>\n**常見搜尋主題的季節性模式**\n\n| 主題 | 高峰月份 | 原因 |\n|------|----------|------|\n| Health Insurance | 11-12 月 | Open Enrollment |\n| Tax / IRS | 1-4 月 | 報稅季 |\n| Flu / Cold | 10-2 月 | 流感季 |\n| Travel / Vacation | 6-8 月 | 暑假 |\n| Christmas / Gift | 11-12 月 | 聖誕購物 |\n| Back to School | 8-9 月 | 開學季 |\n| Allergy | 3-5 月 | 春季花粉 |\n| Diet / Weight Loss | 1 月 | 新年決心 |\n| Sunscreen | 5-8 月 | 夏季 |\n| Heating | 10-2 月 | 冬季 |\n</common_seasonal_patterns>\n\n<decision_tree>\n**季節性分析決策樹**\n\n```\n                    ┌──────────────────┐\n                    │ 抓取 Google Trends │\n                    └────────┬─────────┘\n                             │\n                    ┌────────▼─────────┐\n                    │ 數據足夠 (>104週)? │\n                    └────────┬─────────┘\n                      Yes    │    No\n                    ┌────────┴────────┐\n                    │                 │\n           ┌────────▼────────┐  ┌─────▼─────┐\n           │   STL 分解      │  │ 簡化分析  │\n           └────────┬────────┘  └───────────┘\n                    │\n           ┌────────▼────────┐\n           │ 季節強度 > 0.5? │\n           └────────┬────────┘\n              Yes   │   No\n           ┌────────┴────────┐\n           │                 │\n   ┌───────▼───────┐ ┌───────▼───────┐\n   │ 去季節化後    │ │ 直接在原序列  │\n   │ 做異常偵測    │ │ 做異常偵測    │\n   └───────┬───────┘ └───────┬───────┘\n           │                 │\n           └────────┬────────┘\n                    │\n           ┌────────▼────────┐\n           │   輸出結果      │\n           └─────────────────┘\n```\n</decision_tree>\n",
        "skills/google-trends-ath-detector/references/signal-types.md": "<overview>\nGoogle Trends 訊號分型定義。將搜尋趨勢飆升分類為三種結構性類型，並提供判定邏輯。\n</overview>\n\n<signal_types>\n**三種訊號類型**\n\n| 類型 | 英文 | 特徵 | 解讀 |\n|------|------|------|------|\n| 季節性尖峰 | Seasonal Spike | 每年固定月份重複、殘差不高 | 制度性週期 |\n| 事件驅動衝擊 | Event-Driven Shock | 短期尖峰、z-score 高、事件詞上升 | 新聞/政策/系統故障 |\n| 結構性轉變 | Regime Shift | 變點成立、趨勢線上移 | 長期關注度結構性上升 |\n</signal_types>\n\n<seasonal_spike>\n**季節性尖峰 (Seasonal Spike)**\n\n**定義：**\n週期性重複的搜尋量上升，由制度性因素驅動。\n\n**判定條件：**\n```python\ndef is_seasonal_spike(ts, seasonal_strength, zscore):\n    conditions = [\n        seasonal_strength > 0.5,      # 強季節性\n        abs(zscore) < 2.0,            # 殘差不異常\n        has_recurring_pattern(ts)     # 歷史重複\n    ]\n    return all(conditions)\n\ndef has_recurring_pattern(ts, tolerance=0.15):\n    \"\"\"檢查是否每年同期間都有上升\"\"\"\n    # 計算每年同月份的平均值\n    monthly_avg = ts.groupby(ts.index.month).mean()\n    peak_months = monthly_avg.nlargest(2).index.tolist()\n\n    # 檢查過去幾年是否在相同月份出現高點\n    for year in ts.index.year.unique()[-5:]:\n        year_data = ts[ts.index.year == year]\n        year_peak_month = year_data.idxmax().month\n        if year_peak_month not in peak_months:\n            return False\n    return True\n```\n\n**常見例子：**\n- Health Insurance：11-12 月（Open Enrollment）\n- Tax：1-4 月（報稅季）\n- Christmas：11-12 月（購物季）\n- Flu：10-2 月（流感季）\n\n**下一步：**\n- 比較今年與歷史同期的分位數\n- 若顯著高於歷史同期 95 分位數，可能疊加事件因素\n</seasonal_spike>\n\n<event_driven_shock>\n**事件驅動衝擊 (Event-Driven Shock)**\n\n**定義：**\n由特定事件引發的短期搜尋量飆升。\n\n**判定條件：**\n```python\ndef is_event_shock(zscore, resid, drivers):\n    conditions = [\n        abs(zscore) >= 2.5,                    # 顯著異常\n        is_spike_shape(resid),                 # 尖峰形狀\n        has_event_terms(drivers)               # 驅動詞彙含事件詞\n    ]\n    return sum(conditions) >= 2\n\ndef is_spike_shape(resid, window=4):\n    \"\"\"檢查是否為尖峰形狀（快速上升、可能快速下降）\"\"\"\n    recent = resid.iloc[-window:]\n    previous = resid.iloc[-window*2:-window]\n\n    # 近期顯著高於前期\n    return recent.mean() > previous.mean() + 2 * previous.std()\n\ndef has_event_terms(drivers):\n    \"\"\"檢查驅動詞彙是否含事件相關詞\"\"\"\n    event_keywords = [\n        'announcement', 'breaking', 'news', 'crisis',\n        'deadline', 'lawsuit', 'scandal', 'shutdown'\n    ]\n    for driver in drivers:\n        term_lower = driver['term'].lower()\n        if any(kw in term_lower for kw in event_keywords):\n            return True\n    return False\n```\n\n**常見例子：**\n- 政策公告（Fed 升息、新法案）\n- 企業醜聞（資料外洩、財務造假）\n- 自然災害（颶風、地震）\n- 系統故障（網站當機、服務中斷）\n\n**下一步：**\n- 識別具體事件（related queries + 新聞搜尋）\n- 評估事件的持續性影響\n</event_driven_shock>\n\n<regime_shift>\n**結構性轉變 (Regime Shift)**\n\n**定義：**\n搜尋量的長期結構性上升，表示關注度發生根本性變化。\n\n**判定條件：**\n```python\ndef is_regime_shift(ts, trend, zscore):\n    conditions = [\n        abs(zscore) >= 2.0,                    # 異常\n        is_trend_elevated(trend),              # 趨勢線上移\n        is_sustained(ts)                       # 持續性\n    ]\n    return all(conditions)\n\ndef is_trend_elevated(trend, lookback=52):\n    \"\"\"檢查趨勢線是否上移\"\"\"\n    recent_trend = trend.iloc[-lookback:].mean()\n    historical_trend = trend.iloc[:-lookback].mean()\n\n    # 近期趨勢比歷史高 20% 以上\n    return recent_trend > historical_trend * 1.2\n\ndef is_sustained(ts, weeks=8):\n    \"\"\"檢查是否持續在高位\"\"\"\n    recent = ts.iloc[-weeks:]\n    historical_75 = ts.iloc[:-weeks].quantile(0.75)\n\n    # 近期大多數時間在歷史 75 分位以上\n    return (recent > historical_75).mean() > 0.7\n```\n\n**常見例子：**\n- 生活成本長期上升（通膨壓力）\n- 行業結構性變化（遠端工作、電動車）\n- 人口結構變化（老齡化相關搜尋）\n\n**下一步：**\n- 識別結構性驅動因素\n- 預期這是新常態而非暫時現象\n</regime_shift>\n\n<classification_flowchart>\n**分類流程圖**\n\n```\n              ┌─────────────────┐\n              │  原始訊號分析   │\n              └────────┬────────┘\n                       │\n              ┌────────▼────────┐\n              │ 季節性分解 (STL) │\n              └────────┬────────┘\n                       │\n         ┌─────────────┼─────────────┐\n         │             │             │\n    seasonal      trend         residual\n         │             │             │\n         ▼             ▼             ▼\n  ┌──────────┐  ┌──────────┐  ┌──────────┐\n  │季節強度>0.5│  │趨勢上移?  │  │殘差異常?  │\n  └─────┬────┘  └─────┬────┘  └─────┬────┘\n        │             │             │\n        ▼             ▼             ▼\n   ┌────────────────────────────────────┐\n   │          訊號分類決策              │\n   └────────────────────────────────────┘\n        │             │             │\n        ▼             ▼             ▼\n   Seasonal      Regime        Event\n    Spike         Shift        Shock\n```\n</classification_flowchart>\n\n<classification_logic>\n**分類邏輯代碼**\n\n```python\ndef classify_signal(\n    is_ath: bool,\n    is_anomaly: bool,\n    seasonal_strength: float,\n    trend: pd.Series,\n    resid: pd.Series,\n    drivers: list\n) -> str:\n    \"\"\"\n    分類訊號類型\n\n    Returns:\n        \"seasonal_spike\" | \"event_driven_shock\" | \"regime_shift\" | \"normal\"\n    \"\"\"\n\n    # 1. 檢查季節性尖峰\n    if seasonal_strength > 0.5 and not is_anomaly:\n        return \"seasonal_spike\"\n\n    # 2. 檢查結構性轉變\n    if is_ath and is_anomaly:\n        recent_trend = trend.iloc[-52:].mean()\n        historical_trend = trend.iloc[:-52].mean()\n\n        if recent_trend > historical_trend * 1.2:\n            # 趨勢線上移且持續\n            recent_above_p75 = (resid.iloc[-8:] > resid.quantile(0.75)).mean()\n            if recent_above_p75 > 0.7:\n                return \"regime_shift\"\n\n    # 3. 檢查事件驅動衝擊\n    if is_anomaly:\n        # 尖峰形狀或事件詞彙\n        if is_spike_shape(resid) or has_event_terms(drivers):\n            return \"event_driven_shock\"\n\n    # 4. 其他異常但未分類\n    if is_anomaly:\n        return \"event_driven_shock\"  # 預設為事件驅動\n\n    return \"normal\"\n```\n</classification_logic>\n\n<signal_implications>\n**訊號類型的含義**\n\n| 類型 | 投資/交易含義 | 宏觀含義 | 行動建議 |\n|------|--------------|----------|----------|\n| Seasonal | 預期內波動，可交易季節性 | 制度運作正常 | 等待季節結束 |\n| Event | 短期機會/風險 | 需評估事件持續性 | 識別事件、評估影響 |\n| Regime | 長期趨勢變化 | 結構性轉變 | 調整長期觀點 |\n</signal_implications>\n",
        "skills/google-trends-ath-detector/workflows/analyze.md": "<required_reading>\n**執行此工作流程前，請先閱讀：**\n1. references/input-schema.md - 完整參數定義\n2. references/seasonality-guide.md - 季節性分解方法\n3. references/signal-types.md - 訊號分型定義\n4. references/data-sources.md - Selenium 爬取方式與防偵測策略\n</required_reading>\n\n<objective>\n深度分析 Google Trends 訊號，進行訊號分型，並提取 related queries 作為驅動詞彙參考。\n使用 Selenium 模擬真人瀏覽器行為，避免被 Google 偵測。\n</objective>\n\n<prerequisites>\n**環境準備：**\n\n```bash\n# 安裝依賴\npip install selenium webdriver-manager beautifulsoup4 lxml loguru\n```\n\n確保系統已安裝 Chrome 瀏覽器。\n\n**注意：** 深度分析包含 related queries 抓取，會發送較多請求。\n建議在非高峰時段執行，避免觸發速率限制。\n</prerequisites>\n\n<process>\n**Step 1: 確認完整參數**\n\n```yaml\nparameters:\n  # 必要\n  topic: \"Health Insurance\"\n  geo: \"US\"\n  timeframe: \"2004-01-01 2025-12-31\"\n\n  # 建議\n  granularity: \"weekly\"\n  use_topic_entity: true\n  smoothing_window: 4\n  anomaly_method: \"zscore\"   # zscore|mad\n  anomaly_threshold: 2.5\n  related_queries: true      # 深度分析建議啟用\n\n  # 可選\n  compare_terms: [\"Unemployment\", \"Inflation\", \"Medicare\"]\n  headless: true             # 隱藏瀏覽器\n  debug: false               # 調試模式\n```\n\n**Step 2: 使用 trend_fetcher.py 抓取數據**\n\n```python\nfrom scripts.trend_fetcher import fetch_trends, analyze_ath\n\n# 抓取主題趨勢（Selenium 模擬瀏覽器）\ndata = fetch_trends(\n    topic=\"Health Insurance\",\n    geo=\"US\",\n    timeframe=\"2004-01-01 2025-12-31\",\n    headless=True\n)\n\n# 執行完整分析（含 related queries）\n# 注意：這會額外發送一個請求抓取 related queries\nresult = analyze_ath(data, threshold=2.5, include_related=True)\n```\n\n或使用 CLI：\n\n```bash\npython scripts/trend_fetcher.py \\\n  --topic \"Health Insurance\" \\\n  --geo US \\\n  --timeframe \"2004-01-01 2025-12-31\" \\\n  --threshold 2.5 \\\n  --output ./output/health_insurance.json\n```\n\n**Step 3: 解讀分析結果**\n\n分析結果包含以下關鍵欄位：\n\n```json\n{\n  \"topic\": \"Health Insurance\",\n  \"geo\": \"US\",\n  \"timeframe\": \"2004-01-01 2025-12-31\",\n  \"analysis\": {\n    \"latest_value\": 100,\n    \"latest_date\": \"Dec 2025\",\n    \"historical_max\": 100,\n    \"historical_max_date\": \"Dec 2025\",\n    \"historical_min\": 12,\n    \"mean\": 45.23,\n    \"std\": 15.67,\n    \"zscore\": 3.1,\n    \"is_all_time_high\": true,\n    \"is_anomaly\": true,\n    \"signal_type\": \"regime_shift\",\n    \"trend_direction\": \"rising\",\n    \"data_points\": 252\n  },\n  \"drivers_from_related_queries\": [\n    {\"term\": \"obamacare\", \"type\": \"rising\", \"value\": \"+450%\"},\n    {\"term\": \"aca enrollment\", \"type\": \"rising\", \"value\": \"+320%\"},\n    {\"term\": \"health insurance marketplace\", \"type\": \"top\", \"value\": 100}\n  ],\n  \"recommendation\": \"搜尋趨勢創下歷史新高且異常飆升，建議進一步分析驅動因素\",\n  \"analyzed_at\": \"2025-12-15T10:30:00\"\n}\n```\n\n**Step 4: 訊號分型判讀**\n\n根據 `signal_type` 判讀：\n\n| signal_type | 特徵 | 解讀建議 |\n|-------------|------|----------|\n| seasonal_spike | ATH 但低異常分數 | 檢查是否為固定月份（投保季、報稅季） |\n| event_driven_shock | 高 z-score、短期尖峰 | 檢查 related queries 尋找事件詞 |\n| regime_shift | ATH + 異常 + 上升趨勢 | 結構性變化，關注長期趨勢 |\n| normal | 低異常分數 | 正常波動範圍 |\n\n**Step 5: Related Queries 驅動分析**\n\n從 `drivers_from_related_queries` 識別驅動因素：\n\n- **Rising queries**：上升中的搜尋詞，揭示「為什麼」\n  - `+N%`：上升百分比\n  - `Breakout`：上升超過 5000%（新興熱點）\n\n- **Top queries**：最常搜尋的相關詞\n  - 反映主題的常態關聯\n\n**Step 6: 組裝深度分析報告**\n\n```python\ndef interpret_signal_type(signal_type):\n    interpretations = {\n        \"regime_shift\": \"結構性上升，搜尋關注度持續攀升，可能反映長期趨勢變化\",\n        \"event_driven_shock\": \"短期事件衝擊，可能由新聞/政策/突發事件驅動\",\n        \"seasonal_spike\": \"季節性尖峰，可能為固定週期（如投保季、報稅季）\",\n        \"normal\": \"正常波動，無異常訊號\"\n    }\n    return interpretations.get(signal_type, \"未知訊號類型\")\n\ndef extract_key_drivers(drivers):\n    rising = [d for d in drivers if d.get(\"type\") == \"rising\"]\n    top = [d for d in drivers if d.get(\"type\") == \"top\"]\n    return {\n        \"rising_drivers\": [d[\"term\"] for d in rising[:5]],\n        \"top_related\": [d[\"term\"] for d in top[:3]]\n    }\n\nreport = {\n    \"summary\": {\n        \"topic\": result[\"topic\"],\n        \"is_ath\": result[\"analysis\"][\"is_all_time_high\"],\n        \"signal_type\": result[\"analysis\"][\"signal_type\"],\n        \"anomaly_score\": result[\"analysis\"][\"zscore\"]\n    },\n    \"interpretation\": interpret_signal_type(result[\"analysis\"][\"signal_type\"]),\n    \"key_drivers\": extract_key_drivers(result.get(\"drivers_from_related_queries\", [])),\n    \"recommendation\": result.get(\"recommendation\", \"\")\n}\n```\n</process>\n\n<interpretation_guide>\n**訊號解讀指南**\n\n| 情境 | 訊號組合 | 解讀 |\n|------|----------|------|\n| 投保季高點 | seasonal_spike + 11-12月 | 正常季節性，無需過度關注 |\n| 政策公告 | event_driven_shock + 政策相關 queries | 短期政策影響，觀察持續性 |\n| 長期焦慮上升 | regime_shift + 經濟相關 queries | 結構性變化，可能反映宏觀環境 |\n</interpretation_guide>\n\n<success_criteria>\n此工作流程成功完成時：\n- [ ] Selenium 成功啟動並抓取數據\n- [ ] 成功抓取 Google Trends 時間序列\n- [ ] 判定訊號類型\n- [ ] 提取驅動詞彙（related queries）\n- [ ] 輸出符合 templates/output-schema.yaml\n- [ ] 提供清晰的解讀建議\n</success_criteria>\n\n<output_example>\n見 examples/health_insurance_ath.json\n</output_example>\n\n<anti_detection_notes>\n**防偵測注意事項**\n\n深度分析會發送多個請求（時間序列 + related queries），請注意：\n\n1. **請求間隔**：腳本已內建隨機延遲（1-3 秒）\n2. **避免頻繁執行**：建議間隔 5 分鐘以上\n3. **若被封鎖**：等待 24 小時或更換 IP\n4. **減少請求**：使用 `--no-related` 跳過 related queries\n\n```bash\n# 僅抓取時間序列（較快、較少請求）\npython scripts/trend_fetcher.py --topic \"Health Insurance\" --no-related\n```\n</anti_detection_notes>\n",
        "skills/google-trends-ath-detector/workflows/compare.md": "<required_reading>\n**執行此工作流程前，請先閱讀：**\n1. references/input-schema.md - 了解輸入參數\n2. references/signal-types.md - 了解訊號分型\n3. references/data-sources.md - Selenium 爬取方式與速率限制\n</required_reading>\n\n<objective>\n比較多個 Google Trends 主題的趨勢，識別共振模式，區分「單點焦慮」與「系統性焦慮」。\n使用 Selenium 模擬真人瀏覽器行為抓取數據。\n</objective>\n\n<prerequisites>\n**環境準備：**\n\n```bash\n# 安裝依賴\npip install selenium webdriver-manager beautifulsoup4 lxml loguru\n```\n\n確保系統已安裝 Chrome 瀏覽器。\n\n**重要警告：**\n比較分析會為每個主題分別抓取數據，請求數量較多。\n建議：\n- 限制比較主題數量（≤3 個）\n- 在非高峰時段執行\n- 若被封鎖，等待 24 小時後重試\n</prerequisites>\n\n<use_cases>\n**適用場景：**\n\n1. 「Health Insurance 上升是因為整體經濟焦慮，還是醫療特定問題？」\n2. 「多個經濟相關搜尋是否同時上升？」\n3. 「這個訊號是孤立現象還是更廣泛趨勢的一部分？」\n</use_cases>\n\n<process>\n**Step 1: 確認比較參數**\n\n```yaml\nparameters:\n  primary_topic: \"主要分析主題\"\n  compare_topics: [\"對照主題1\", \"對照主題2\", \"對照主題3\"]  # 建議 ≤3 個\n  geo: \"US\"\n  timeframe: \"2019-01-01 2025-12-31\"\n```\n\n**Step 2: 使用 trend_fetcher.py 進行比較**\n\n```python\nfrom scripts.trend_fetcher import compare_trends\n\n# 比較多個主題（每個主題會分別抓取）\n# 注意：會為每個主題啟動一次瀏覽器，並有隨機延遲\nresult = compare_trends(\n    topic=\"Health Insurance\",\n    compare_terms=[\"Unemployment\", \"Inflation\", \"Medicare\"],\n    geo=\"US\",\n    timeframe=\"2019-01-01 2025-12-31\"\n)\n```\n\n或使用 CLI：\n\n```bash\npython scripts/trend_fetcher.py \\\n  --topic \"Health Insurance\" \\\n  --compare \"Unemployment,Inflation,Medicare\" \\\n  --geo US \\\n  --timeframe \"2019-01-01 2025-12-31\" \\\n  --output ./output/comparison.json\n```\n\n**Step 3: 解讀相關性結果**\n\n輸出包含各主題間的 Pearson 相關係數：\n\n```json\n{\n  \"topic\": \"Health Insurance\",\n  \"geo\": \"US\",\n  \"timeframe\": \"2019-01-01 2025-12-31\",\n  \"compare_correlations\": {\n    \"Unemployment\": 0.45,\n    \"Inflation\": 0.38,\n    \"Medicare\": 0.72\n  },\n  \"interpretation\": \"與 Medicare 高度相關（>0.7），可能為系統性焦慮而非單點焦慮\",\n  \"analyzed_at\": \"2025-12-15T10:30:00\"\n}\n```\n\n**相關性解讀：**\n\n| 相關係數 | 解讀 |\n|----------|------|\n| > 0.7 | 高度相關，同步移動 |\n| 0.4 - 0.7 | 中度相關，部分同步 |\n| 0.2 - 0.4 | 弱相關 |\n| < 0.2 | 幾乎無關 |\n\n**Step 4: 判定共振模式**\n\n根據相關性組合判定：\n\n| 模式 | 特徵 | 解讀 |\n|------|------|------|\n| systemic_anxiety | 多個主題同步高相關 | 整體經濟/社會焦慮 |\n| isolated_signal | 主題獨立移動 | 特定事件或政策影響 |\n| mixed_signal | 部分同步、部分獨立 | 需細分時間段分析 |\n\n**Step 5: 組裝比較報告**\n\n```python\ndef identify_pattern(correlations):\n    high_corr_count = sum(1 for v in correlations.values() if v and v > 0.7)\n    if high_corr_count >= 2:\n        return \"systemic_anxiety\"\n    elif high_corr_count == 0:\n        return \"isolated_signal\"\n    else:\n        return \"mixed_signal\"\n\ndef generate_next_steps(result):\n    pattern = identify_pattern(result.get(\"compare_correlations\", {}))\n    if pattern == \"systemic_anxiety\":\n        return \"建議關注宏觀經濟環境變化，多個相關主題同步上升\"\n    elif pattern == \"isolated_signal\":\n        return \"建議深入分析該主題的 related queries，識別特定驅動因素\"\n    else:\n        return \"建議分段分析不同時間段的相關性變化\"\n\nreport = {\n    \"primary_topic\": \"Health Insurance\",\n    \"compare_topics\": [\"Unemployment\", \"Inflation\", \"Medicare\"],\n    \"geo\": \"US\",\n    \"correlations\": result[\"compare_correlations\"],\n    \"interpretation\": {\n        \"pattern\": identify_pattern(result[\"compare_correlations\"]),\n        \"explanation\": result.get(\"interpretation\", \"\")\n    },\n    \"next_steps\": generate_next_steps(result)\n}\n```\n</process>\n\n<pattern_interpretation>\n**共振模式解讀**\n\n| 模式 | 特徵 | 解讀 | 建議行動 |\n|------|------|------|----------|\n| systemic_anxiety | 多個主題同步上升 | 整體經濟焦慮，非單一問題 | 關注宏觀環境變化 |\n| isolated_signal | 單一主題獨立移動 | 特定事件或政策影響 | 深入分析該主題的 related queries |\n| mixed_signal | 部分同步、部分獨立 | 複合因素影響 | 分段分析不同時期 |\n\n**範例解讀：**\n\n- **Health Insurance + Unemployment 高相關**\n  → 經濟焦慮驅動（工作不穩定 → 擔心保險）\n\n- **Health Insurance + Medicare 高相關**\n  → 醫療系統焦慮（整體醫療關注度上升）\n\n- **Health Insurance 獨立上升**\n  → 可能為政策事件（Open Enrollment、法案變動）\n</pattern_interpretation>\n\n<success_criteria>\n此工作流程成功完成時：\n- [ ] Selenium 成功啟動並抓取所有主題數據\n- [ ] 抓取所有主題的 Google Trends 時間序列\n- [ ] 計算相關係數\n- [ ] 識別共振模式\n- [ ] 給出解讀與下一步建議\n</success_criteria>\n\n<example_output>\n```json\n{\n  \"primary_topic\": \"Health Insurance\",\n  \"compare_topics\": [\"Unemployment\", \"Inflation\", \"Medicare\"],\n  \"geo\": \"US\",\n  \"timeframe\": \"2019-01-01 2025-12-31\",\n\n  \"compare_correlations\": {\n    \"Unemployment\": 0.45,\n    \"Inflation\": 0.38,\n    \"Medicare\": 0.72\n  },\n\n  \"interpretation\": \"與 Medicare 高度相關（>0.7），可能為系統性焦慮而非單點焦慮\",\n\n  \"pattern\": \"mixed_signal\",\n  \"explanation\": \"Health Insurance 搜尋同時受醫療特定因素（Medicare 高相關）和經濟因素（Unemployment/Inflation 中度相關）影響\"\n}\n```\n</example_output>\n\n<rate_limit_warning>\n**速率限制警告**\n\n比較分析會為每個主題發送獨立請求：\n- 主要主題：1 次請求\n- 每個比較主題：1 次請求\n- 總計：1 + N 次請求（N = 比較主題數量）\n\n**建議：**\n1. 限制比較主題數量（≤3 個）\n2. 腳本已內建請求間 3-6 秒隨機延遲\n3. 若被封鎖，等待 24 小時後重試\n4. 考慮分批執行（每次比較 1-2 個主題）\n\n```bash\n# 分批執行範例\npython scripts/trend_fetcher.py --topic \"Health Insurance\" --compare \"Unemployment\" --output ./output/compare1.json\n# 等待幾分鐘\npython scripts/trend_fetcher.py --topic \"Health Insurance\" --compare \"Medicare\" --output ./output/compare2.json\n```\n</rate_limit_warning>\n",
        "skills/google-trends-ath-detector/workflows/detect.md": "<required_reading>\n**執行此工作流程前，請先閱讀：**\n1. references/input-schema.md - 了解輸入參數\n2. references/signal-types.md - 了解訊號分型\n3. references/data-sources.md - 了解 Selenium 爬取方式\n</required_reading>\n\n<objective>\n快速偵測指定主題是否創下 ATH（歷史新高）或出現異常飆升。\n使用 Selenium 模擬真人瀏覽器行為抓取 Google Trends 數據。\n</objective>\n\n<prerequisites>\n**環境準備：**\n\n```bash\n# 安裝依賴\npip install selenium webdriver-manager beautifulsoup4 lxml loguru\n```\n\n確保系統已安裝 Chrome 瀏覽器。\n</prerequisites>\n\n<process>\n**Step 1: 確認參數**\n\n詢問或確認以下必要參數：\n\n```yaml\nrequired:\n  topic: \"要分析的 Google Trends 主題\"\n  geo: \"地區代碼（如 US, TW, JP）\"\n  timeframe: \"時間範圍（如 2004-01-01 2025-12-31）\"\n\noptional:\n  anomaly_threshold: 2.5  # z-score 門檻\n  headless: true          # 是否隱藏瀏覽器\n  debug: false            # 調試模式\n```\n\n**Step 2: 使用 trend_fetcher.py 抓取數據並分析**\n\n```python\nfrom scripts.trend_fetcher import fetch_trends, analyze_ath\n\n# 抓取 Google Trends 數據（Selenium 自動處理 session）\ndata = fetch_trends(\n    topic=\"Health Insurance\",\n    geo=\"US\",\n    timeframe=\"2004-01-01 2025-12-31\",\n    headless=True,   # 隱藏瀏覽器\n    debug=False      # 調試模式\n)\n\n# ATH 分析（跳過 related queries 以加速）\nresult = analyze_ath(data, threshold=2.5, include_related=False)\n```\n\n或使用 CLI：\n\n```bash\npython scripts/trend_fetcher.py \\\n  --topic \"Health Insurance\" \\\n  --geo US \\\n  --no-related \\\n  --output ./output/quick_detect.json\n```\n\n**Step 3: 解讀結果**\n\n```json\n{\n  \"topic\": \"Health Insurance\",\n  \"geo\": \"US\",\n  \"analysis\": {\n    \"latest_value\": 100,\n    \"historical_max\": 100,\n    \"zscore\": 3.1,\n    \"is_all_time_high\": true,\n    \"is_anomaly\": true,\n    \"signal_type\": \"regime_shift\"\n  },\n  \"recommendation\": \"搜尋趨勢創下歷史新高且異常飆升，建議進一步分析驅動因素\"\n}\n```\n</process>\n\n<decision_tree>\n**根據結果決定下一步：**\n\n| is_ath | is_anomaly | 建議 |\n|--------|------------|------|\n| true | true | 確認異常高點，建議 analyze workflow 深度分析 |\n| true | false | 可能是季節性高點，建議檢查季節性 |\n| false | true | 異常但非 ATH，可能是局部飆升 |\n| false | false | 正常波動，無需進一步分析 |\n</decision_tree>\n\n<success_criteria>\n此工作流程成功完成時：\n- [ ] Selenium 成功啟動 Chrome 瀏覽器\n- [ ] 成功抓取 Google Trends 時間序列\n- [ ] 判定 ATH 狀態\n- [ ] 計算異常分數\n- [ ] 給出下一步建議\n</success_criteria>\n\n<error_handling>\n**錯誤處理：**\n\n1. **ChromeDriver 版本問題**\n   ```bash\n   pip install --upgrade webdriver-manager\n   ```\n\n2. **429 Too Many Requests / 被封鎖**\n   - 等待後重試（建議 24 小時）\n   - 使用 VPN 或代理\n   - 增加請求間隔\n\n3. **數據不足**\n   - 縮短時間範圍\n   - 確認主題名稱正確\n\n4. **請求失敗**\n   - 使用 `--debug --no-headless` 查看問題\n   ```bash\n   python scripts/trend_fetcher.py --topic \"test\" --debug --no-headless\n   ```\n\n5. **記憶體問題（Linux/Docker）**\n   - 確保安裝 chromium-browser\n   - 使用 `--no-sandbox` 選項（已內建）\n</error_handling>\n\n<debug_tips>\n**調試技巧：**\n\n```bash\n# 顯示瀏覽器視窗觀察行為\npython scripts/trend_fetcher.py --topic \"test\" --no-headless\n\n# 啟用調試模式（保存 HTML、輸出日誌）\npython scripts/trend_fetcher.py --topic \"test\" --debug\n\n# 結合兩者\npython scripts/trend_fetcher.py --topic \"test\" --debug --no-headless\n```\n\n調試模式會：\n- 保存 `debug_page.html` 供檢查\n- 輸出詳細日誌到 `trend_fetcher.log`\n</debug_tips>\n",
        "skills/list-china-today-macro-news/SKILL.md": "---\nname: list-china-today-macro-news\ndescription: 彙整今日中國宏觀經濟新聞消息，從華爾街日報、36氪等來源抓取並篩選宏觀相關新聞，輸出雜誌風格的新聞摘要。適用於交易/研究開盤前快速掌握中國宏觀動態。\nbased_on: news-aggregator-skill\n---\n\n# 今日中國宏觀新聞 Skill\n\n> 🔗 Based on [news-aggregator-skill](../../../vendor/news-aggregator-skill) | 專注於中國宏觀經濟新聞的垂直擴展\n\n從多個中文財經新聞源抓取並篩選中國宏觀經濟相關新聞，提供 AI 深度解讀。\n\n## Tools\n\n### fetch_china_macro_news.py\n\n**Usage:**\n\n```bash\n### 基本用法：抓取華爾街日報的中國宏觀新聞\npython scripts/fetch_china_macro_news.py --source wallstreetcn --limit 15\n\n### 多源掃描：華爾街日報 + 36氪\npython scripts/fetch_china_macro_news.py --source wallstreetcn,36kr --limit 10\n\n### 深度抓取（下載文章內容）\npython scripts/fetch_china_macro_news.py --source wallstreetcn --limit 10 --deep\n```\n\n### 智慧關鍵字擴展 (Smart Keyword Expansion)\n**CRITICAL**: 當用戶給出簡單關鍵字時，自動擴展覆蓋相關領域：\n*   用戶: \"利率\" -> Agent 使用: `--keyword \"利率,LPR,MLF,降息,加息,PBOC,央行\"`\n*   用戶: \"通膨\" -> Agent 使用: `--keyword \"通膨,CPI,PPI,物價,通縮\"`\n*   用戶: \"貿易\" -> Agent 使用: `--keyword \"貿易,進出口,順差,關稅,海關\"`\n\n```bash\n# Example: User asked for \"央行新聞\" (Note the expanded keywords)\npython scripts/fetch_china_macro_news.py --source wallstreetcn --limit 20 --keyword \"央行,PBOC,利率,LPR,MLF,降息,降準\" --deep\n```\n\n**Arguments:**\n\n- `--source`: One of `wallstreetcn`, `36kr`, `all` (default: wallstreetcn).\n- `--limit`: Max items per source (default 15).\n- `--keyword`: Comma-separated filters (default: 宏觀相關關鍵字).\n- `--deep`: **[NEW]** Enable deep fetching. Downloads and extracts the main text content of the articles.\n\n**Output:**\nJSON array. If `--deep` is used, items will contain a `content` field associated with the article text.\n\n## 預設宏觀關鍵字\n\n腳本預設使用以下關鍵字篩選中國宏觀新聞：\n\n```\n央行,PBOC,利率,LPR,MLF,降息,降準,\nGDP,PMI,CPI,PPI,通膨,通縮,\n經濟,宏觀,財政,貨幣政策,\n貿易,進出口,順差,逆差,\n就業,失業,消費,零售,\n房地產,樓市,投資,基建,\n人民幣,匯率,外匯,\n債券,國債,信貸,社融,M2\n```\n\n## Interactive Menu\n\nWhen the user says **\"今日中國宏觀新聞\"** (or similar \"menu/help\" triggers):\n1.  **READ** the content of `templates.md` in the skill directory.\n2.  **DISPLAY** the list of available commands to the user exactly as they appear in the file.\n3.  **GUIDE** the user to select a number or copy the command to execute.\n\n## Smart Time Filtering & Reporting (CRITICAL)\n\nIf the user requests a specific time window (e.g., \"過去 X 小時\") and the results are sparse (< 5 items):\n1.  **Prioritize User Window**: First, list all items that strictly fall within the user's requested time (Time < X).\n2.  **Smart Fill**: If the list is short, you MUST include high-value/high-heat items from a wider range (e.g. past 24h) to ensure the report provides at least 5 meaningful insights.\n3.  **Annotation**: Clearly mark these older items (e.g., \"⚠️ 18h 前\", \"🔥 24h 熱點\") so the user knows they are supplementary.\n4.  **High Value**: Always prioritize \"重大政策\", \"央行動態\", or \"關鍵數據\" items even if they slightly exceed the time window.\n\n## Response Guidelines (CRITICAL)\n\n**Format & Style:**\n- **Language**: 繁體中文 (zh-TW).\n- **Style**: Magazine/Newsletter style (e.g., \"財訊\" or \"華爾街日報\" vibe). Professional, concise, yet engaging.\n- **Structure**:\n    - **🔥 頭條焦點**: Top 3-5 most critical macro stories.\n    - **💰 央行與貨幣政策**: 利率、流動性相關.\n    - **📊 經濟數據**: GDP、PMI、CPI 等數據解讀.\n    - **💱 匯率與市場**: 人民幣、債券、股市相關.\n- **Item Format**:\n    - **Title**: **MUST be a Markdown Link** to the original URL.\n        - ✅ Correct: `### 1. [央行宣布降準 0.5 個百分點](https://...)`\n        - ❌ Incorrect: `### 1. 央行宣布降準 0.5 個百分點`\n    - **Metadata Line**: Must include Source, **Time/Date**, and Heat/Score.\n    - **1-Liner Summary**: A punchy, \"so what?\" summary.\n    - **Deep Interpretation (Bulleted)**: 2-3 bullet points explaining *why* this matters, technical details, or context. (Required for \"Deep Scan\").\n\n**Output Artifact:**\n- Always save the full report to `reports/` directory with a timestamped filename (e.g., `reports/china_macro_YYYYMMDD_HHMM.md`).\n- Present the full report content to the user in the chat.\n- **CRITICAL**: Report footer MUST include attribution line.\n\n## 數據源說明\n\n| 來源           | 說明                                    | 適用場景                     |\n|----------------|-----------------------------------------|------------------------------|\n| **華爾街日報** | 中國頂級財經媒體，宏觀/市場新聞即時性強 | 央行政策、市場動態、數據解讀 |\n| **36氪**       | 科技財經媒體，涵蓋宏觀經濟快訊          | 經濟政策、產業動態           |\n\n## 範例輸出\n\n```markdown\n# 今日中國宏觀新聞摘要（2026-01-20）\n\n> 掃描時間：11:30 | 來源：華爾街日報、36氪 | 共 12 條相關新聞\n\n---\n\n## 🔥 頭條焦點\n\n### 1. [央行今日開展 5000 億 MLF 操作，利率持平](https://wallstreetcn.com/...)\n📍 華爾街日報 | 🕐 09:45 | 🔥 高關注\n\n央行維持 MLF 利率不變，符合市場預期。\n\n- **核心要點**：本月 MLF 到期量 4500 億，淨投放 500 億\n- **市場影響**：短期流動性維持寬鬆，LPR 大概率持平\n- **後續觀察**：關注月末資金面與下月降準窗口\n\n### 2. [12 月 PMI 回升至 50.1，製造業重返擴張區間](https://wallstreetcn.com/...)\n📍 華爾街日報 | 🕐 10:00 | 🔥 重要數據\n\n官方製造業 PMI 小幅回升，結束連續兩個月收縮。\n\n- **數據亮點**：新訂單指數回升 0.3 個百分點\n- **結構分化**：大型企業穩健，中小企業仍承壓\n- **政策含義**：穩增長政策效果初顯，但基礎尚不穩固\n\n---\n\n## 💰 央行與貨幣政策\n\n### 3. [1 月 LPR 報價出爐：1 年期 3.10%、5 年期 3.60% 均持平](https://...)\n...\n\n---\n\n*報告由 list-china-today-macro-news skill 自動生成*\n*🔗 Powered by [news-aggregator-skill](https://github.com/anthropics/news-aggregator-skill)*\n```\n\n## Attribution\n\nThis skill is built upon and extends the architecture of **news-aggregator-skill**.\n- Core fetching patterns derived from `news-aggregator-skill/scripts/fetch_news.py`\n- Report formatting follows the news-aggregator-skill Response Guidelines\n- Smart Time Filtering logic adapted from news-aggregator-skill\n\n---\n*🔗 Based on [news-aggregator-skill](../../../vendor/news-aggregator-skill) by Anthropic*\n",
        "skills/list-china-today-macro-news/references/data-sources.md": "# 數據來源參考\n\n本文件說明 Skill 使用的新聞來源及其技術細節。\n\n## 華爾街日報（主要來源）\n\n| 項目 | 說明                                   |\n|------|----------------------------------------|\n| 網站 | https://wallstreetcn.com/              |\n| 類型 | 中國頂級財經媒體                       |\n| 特色 | 宏觀/市場新聞即時性強，24 小時滾動更新 |\n| 適用 | 央行政策、市場動態、數據解讀           |\n\n### API 端點\n\n```\nGET https://api-one.wallstcn.com/apiv1/content/information-flow\n```\n\n**參數：**\n- `channel=global-channel` - 全球頻道\n- `accept=article` - 只要文章\n- `limit=30` - 數量限制\n\n**回傳欄位：**\n```json\n{\n  \"data\": {\n    \"items\": [\n      {\n        \"resource\": {\n          \"title\": \"新聞標題\",\n          \"content_short\": \"摘要\",\n          \"uri\": \"https://wallstreetcn.com/articles/...\",\n          \"display_time\": 1705737600\n        }\n      }\n    ]\n  }\n}\n```\n\n### 時間處理\n\n- `display_time` 是 Unix 時間戳\n- 轉換為 HH:MM 格式顯示\n\n---\n\n## 36氪（輔助來源）\n\n| 項目 | 說明                         |\n|------|------------------------------|\n| 網站 | https://36kr.com/            |\n| 類型 | 科技財經媒體                 |\n| 特色 | 涵蓋科技、創投、經濟政策快訊 |\n| 適用 | 經濟政策、產業動態           |\n\n### 抓取頁面\n\n```\nGET https://36kr.com/newsflashes\n```\n\n### 選擇器\n\n```python\nSELECTORS = {\n    \"items\": \".newsflash-item\",\n    \"title\": \".item-title\",\n    \"time\": \".time\"\n}\n```\n\n---\n\n## 關鍵字篩選規則\n\n### 預設宏觀關鍵字\n\n```python\nDEFAULT_MACRO_KEYWORDS = [\n    # 央行與貨幣政策\n    \"央行\", \"PBOC\", \"利率\", \"LPR\", \"MLF\", \"降息\", \"降準\",\n    # 經濟數據\n    \"GDP\", \"PMI\", \"CPI\", \"PPI\", \"通膨\", \"通縮\",\n    # 財政與政策\n    \"經濟\", \"宏觀\", \"財政\", \"貨幣政策\",\n    # 貿易\n    \"貿易\", \"進出口\", \"順差\", \"逆差\",\n    # 就業與消費\n    \"就業\", \"失業\", \"消費\", \"零售\",\n    # 房地產與投資\n    \"房地產\", \"樓市\", \"投資\", \"基建\",\n    # 外匯\n    \"人民幣\", \"匯率\", \"外匯\",\n    # 債券與信貸\n    \"債券\", \"國債\", \"信貸\", \"社融\", \"M2\"\n]\n```\n\n### 智慧擴展規則\n\n| 用戶輸入 | 自動擴展                         |\n|----------|----------------------------------|\n| 利率     | 利率,LPR,MLF,降息,加息,PBOC,央行 |\n| 通膨     | 通膨,CPI,PPI,物價,通縮           |\n| 貿易     | 貿易,進出口,順差,關稅,海關       |\n| PMI      | PMI,製造業,服務業,採購經理人     |\n| 房地產   | 房地產,樓市,房價,房貸,限購       |\n\n---\n\n## 深度抓取\n\n使用 `--deep` 參數時，腳本會：\n\n1. 訪問每篇文章的原始 URL\n2. 下載 HTML 並提取正文\n3. 移除 script、style、nav、footer 等元素\n4. 截取前 3000 字元\n\n### 內容提取函數\n\n```python\ndef fetch_url_content(url):\n    response = requests.get(url, headers=HEADERS, timeout=5)\n    soup = BeautifulSoup(response.content, 'html.parser')\n\n    # 移除不需要的元素\n    for element in soup([\"script\", \"style\", \"nav\", \"footer\", \"header\"]):\n        element.extract()\n\n    # 提取文字\n    text = soup.get_text(separator=' ', strip=True)\n    return text[:3000]\n```\n\n---\n\n## 請求標頭\n\n```python\nHEADERS = {\n    \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36\"\n}\n```\n\n---\n\n## 錯誤處理\n\n| 情況         | 處理方式                   |\n|--------------|----------------------------|\n| API 請求失敗 | 返回空陣列，繼續下一個來源 |\n| 解析失敗     | 跳過該項目，繼續處理       |\n| 深度抓取超時 | content 設為空字串         |\n",
        "skills/list-china-today-macro-news/templates.md": "# 🇨🇳 今日中國宏觀新聞 指令菜單\n\n> 🔗 Based on [news-aggregator-skill](../../../vendor/news-aggregator-skill) templates\n\n請回復序號（如 \"1\"）或直接複製指令來執行任務。\n\n## 📈 單點直擊 (Single Source)\n\n**1. 📍 華爾街日報宏觀快訊**\n> 使用 list-china-today-macro-news skill 掃描華爾街日報，看看今天有哪些中國宏觀經濟新聞？\n\n**2. 🚀 36氪財經快訊**\n> 使用 list-china-today-macro-news skill 看看 36氪 的最新宏觀經濟相關報導。\n\n---\n\n## 💰 主題聚焦 (Topic Focus)\n\n**3. 🏦 央行與貨幣政策**\n> 使用 list-china-today-macro-news skill 深度掃描央行、利率、LPR、MLF 相關新聞，分析貨幣政策動向。\n\n**4. 📊 關鍵經濟數據**\n> 使用 list-china-today-macro-news skill 聚焦 GDP、PMI、CPI、PPI 等經濟數據發布與解讀。\n\n**5. 💱 人民幣與外匯**\n> 使用 list-china-today-macro-news skill 掃描人民幣匯率、外匯儲備、跨境資本流動相關新聞。\n\n**6. 🏠 房地產與基建**\n> 使用 list-china-today-macro-news skill 看看房地產、樓市政策、基建投資的最新動態。\n\n**7. 🌐 貿易與進出口**\n> 使用 list-china-today-macro-news skill 掃描中國進出口、貿易順逆差、關稅政策相關新聞。\n\n---\n\n## 🔥 全面掃描 (Full Scan)\n\n**8. ☕️ 早安·中國宏觀速遞 (Morning Briefing)**\n> 使用 list-china-today-macro-news skill 幫我全面掃描華爾街日報和 36氪，整理今日中國宏觀經濟的重要新聞，給我一份晨報摘要。\n\n**9. 🔍 深度解讀模式 (Deep Analysis)**\n> 使用 list-china-today-macro-news skill 深度抓取並分析今日最重要的 5 條中國宏觀新聞，每條都要有詳細的政策解讀和市場影響分析。\n\n---\n\n## ⏰ 時間窗口 (Time Window)\n\n**10. 🕐 過去 3 小時熱點**\n> 使用 list-china-today-macro-news skill 看看過去 3 小時有哪些中國宏觀新聞？\n\n**11. 📅 今日盤前快報**\n> 使用 list-china-today-macro-news skill 掃描今日開盤前（9:30 之前）發布的中國宏觀相關新聞。\n\n---\n\n*🔗 Powered by [news-aggregator-skill](../../../vendor/news-aggregator-skill)*\n",
        "skills/list-china-today-macro-news/templates/news-report.md": "# 新聞報告模板\n\n本模板定義中國宏觀新聞報告的輸出格式。\n\n## 報告結構\n\n```markdown\n# 列出今日中國宏觀新聞消息摘要（{date}）\n\n> 掃描時間：{time} | 來源：{sources} | 共 {count} 條相關新聞\n\n---\n\n## 🔥 頭條焦點\n\n### 1. [{title}]({url})\n📍 {source} | 🕐 {time}\n\n{summary}\n\n- **核心要點**：...\n- **市場影響**：...\n- **後續觀察**：...\n\n---\n\n## 💰 央行與貨幣政策\n\n### N. [{title}]({url})\n...\n\n---\n\n## 📊 經濟數據\n\n### N. [{title}]({url})\n...\n\n---\n\n## 📈 市場動態\n\n### N. [{title}]({url})\n...\n\n---\n\n*報告由 list-china-today-macro-news skill 自動生成*\n```\n\n## 分類規則\n\n| 類別           | 關鍵字                           |\n|----------------|----------------------------------|\n| 頭條焦點       | 最重要的 3-5 條，由 AI 判斷      |\n| 央行與貨幣政策 | 央行、利率、LPR、MLF、降息、降準 |\n| 經濟數據       | GDP、PMI、CPI、PPI、工業、零售   |\n| 市場動態       | 人民幣、匯率、債券、股市         |\n\n## 單條新聞格式要求\n\n1. **標題**：必須是 Markdown 連結 `[{title}]({url})`\n2. **Metadata**：來源 + 時間\n3. **摘要**：一句話說明新聞重點\n4. **深度解讀**：2-3 個 bullet points\n   - 核心要點：新聞說了什麼\n   - 市場影響：對市場的潛在影響\n   - 後續觀察：需要關注的後續發展\n",
        "skills/list-china-today-macro-news/workflows/fetch-releases.md": "# Workflow: 抓取列出今日中國宏觀新聞消息\n\n本工作流程說明如何使用腳本抓取並篩選中國宏觀經濟新聞。\n\n## Step 1: 執行抓取腳本\n\n**基本用法：**\n\n```bash\n# 從華爾街日報抓取宏觀新聞（預設使用宏觀關鍵字）\npython scripts/fetch_china_macro_news.py --source wallstreetcn --limit 15\n\n# 多源掃描\npython scripts/fetch_china_macro_news.py --source all --limit 10\n\n# 深度抓取（下載文章正文）\npython scripts/fetch_china_macro_news.py --source wallstreetcn --limit 10 --deep\n```\n\n**自訂關鍵字：**\n\n```bash\n# 只看央行相關\npython scripts/fetch_china_macro_news.py --keyword \"央行,PBOC,利率,LPR,MLF\"\n\n# 只看數據相關\npython scripts/fetch_china_macro_news.py --keyword \"PMI,CPI,PPI,GDP\"\n```\n\n## Step 2: 解析輸出\n\n腳本輸出 JSON 陣列，每個項目包含：\n\n```json\n{\n  \"source\": \"Wall Street CN\",\n  \"title\": \"央行今日開展 5000 億 MLF 操作\",\n  \"url\": \"https://wallstreetcn.com/articles/...\",\n  \"time\": \"09:45\",\n  \"content\": \"（深度抓取時才有）文章正文內容...\"\n}\n```\n\n## Step 3: AI 解讀與報告生成\n\n根據抓取結果，生成財經雜誌風格的報告：\n\n1. **分類整理**：\n   - 頭條焦點（最重要的 3-5 條）\n   - 央行與貨幣政策\n   - 經濟數據解讀\n   - 市場動態\n\n2. **單條新聞格式**：\n   - 標題（Markdown 連結）\n   - Metadata（來源、時間）\n   - 一句話摘要\n   - 深度解讀（2-3 bullet points）\n\n3. **儲存報告**：\n   - 存到 `reports/china_macro_YYYYMMDD_HHMM.md`\n\n## 預設宏觀關鍵字\n\n腳本預設使用以下關鍵字：\n\n```\n央行,PBOC,利率,LPR,MLF,降息,降準,\nGDP,PMI,CPI,PPI,通膨,通縮,\n經濟,宏觀,財政,貨幣政策,\n貿易,進出口,順差,逆差,\n就業,失業,消費,零售,\n房地產,樓市,投資,基建,\n人民幣,匯率,外匯,\n債券,國債,信貸,社融,M2\n```\n\n## 成功標準\n\n- [ ] 成功從至少一個來源抓取新聞\n- [ ] 篩選出宏觀相關新聞（至少 5 條）\n- [ ] 輸出格式正確（JSON 陣列）\n- [ ] 報告以財經雜誌風格呈現\n- [ ] 每條新聞都有原文連結\n",
        "skills/lithium-supply-demand-gap-radar/SKILL.md": "---\nname: lithium-supply-demand-gap-radar\ndescription: 將鋰產業鏈（礦端 → 精煉化學品 → 電池與終端需求），整合為一套可運算的替代指標；再把這些指標映射到鋰主題 ETF（如 LIT）的成分暴露與長期價格走勢，形成可供決策的依據。 \n---\n\n<essential_principles>\n**鋰產業鏈供需雷達 核心原則**\n\n<principle name=\"supply_chain_layers\">\n**供應鏈分層（Supply Chain Layers）**\n\n鋰產業鏈必須分層分析，不可混為一談：\n\n```\nMining → Processing → Battery\n(礦端)   (化學品)    (終端需求)\n```\n\n| 層級                 | 代表數據                 | 典型延遲  |\n|----------------------|--------------------------|-----------|\n| Upstream (礦端)      | 鋰礦產量、出口量         | 年度/季度 |\n| Midstream (化學品)   | 碳酸鋰/氫氧化鋰價格      | 週度/日度 |\n| Downstream (電池/EV) | EV 銷量、電池裝機量(GWh) | 月度      |\n\n**強制規則**：\n- 供給分析需指定層級（礦端 vs 精煉端）\n- 需求 proxy 需明確轉換假設（kWh → kg Li）\n- 價格分析需區分碳酸鋰 vs 氫氧化鋰\n</principle>\n\n<principle name=\"data_level_fallback\">\n**數據等級與備援策略（Data Level Fallback）**\n\n根據 `data_level` 參數自動選擇數據源：\n\n| data_level     | 價格數據             | 供需數據           | 可靠度 |\n|----------------|----------------------|--------------------|--------|\n| `free_nolimit` | CME 期貨/Proxy 指數  | USGS/IEA/澳洲政府  | 中     |\n| `free_limit`   | SMM/Fastmarkets 頁面 | + 公司財報         | 中高   |\n| `paid_low`     | SMM 完整序列         | + Benchmark 基本   | 高     |\n| `paid_high`    | Fastmarkets API      | + S&P/BNEF/WoodMac | 最高   |\n\n**強制規則**：\n- 價格數據不足時，使用 CME 合約或相關股籃子作為 proxy\n- 需在輸出中標註實際使用的數據等級\n</principle>\n\n<principle name=\"li_content_conversion\">\n**鋰含量轉換（Li Content Conversion）**\n\n電池需求到鋰需求的轉換必須明確假設：\n\n| 假設場景 | kg Li / kWh | 備註                |\n|----------|-------------|---------------------|\n| 保守估計 | 0.12        | 含 LFP 佔比上升假設 |\n| 中性估計 | 0.15        | 混合 NMC/LFP        |\n| 積極估計 | 0.18        | 高鎳 NMC 主導       |\n\n```python\nli_demand_kt = battery_gwh * kg_per_kwh * 1000  # 單位: kt LCE\n```\n\n**強制規則**：\n- 需求估計必須輸出三個情境（保守/中性/積極）\n- 輸出需包含 `kg_per_kwh_assumption` 欄位\n</principle>\n\n<principle name=\"regime_classification\">\n**價格型態分類（Price Regime Classification）**\n\n鋰價週期分為四個階段：\n\n| Regime      | 特徵                         | 交易含義           |\n|-------------|------------------------------|--------------------|\n| `downtrend` | 12-26 週動能 < 0, 斜率 < 0   | 空頭主導，避免做多 |\n| `bottoming` | 動能收斂，波動下降，均值回歸 | 觀望，等待確認     |\n| `uptrend`   | 動能 > 0, 斜率 > 0           | 做多視窗開啟       |\n| `overheat`  | 動能極端正值，波動放大       | 獲利了結風險       |\n\n**指標組合**：\n- 12 週 / 26 週動能（ROC）\n- 趨勢斜率（線性回歸）\n- 波動率（ATR / 標準差）\n- 均值回歸強度（距 MA 偏離度）\n</principle>\n\n<principle name=\"etf_transmission\">\n**ETF 傳導敏感度（ETF Transmission）**\n\nETF 對鋰價的敏感度受持股結構影響：\n\n| 持股類型          | 對鋰價 Beta | 波動特性            |\n|-------------------|-------------|---------------------|\n| Upstream (礦業)   | 1.5 - 2.5   | 高槓桿、高波動      |\n| Midstream (精煉)  | 0.8 - 1.2   | 跟隨但有加工費緩衝  |\n| Downstream (電池) | 0.3 - 0.8   | 受競爭/技術路線影響 |\n\n**計算公式**：\n```python\nETF_beta_li = Σ(weight_i * beta_i_to_lithium)\n```\n\n**強制規則**：\n- 需計算 rolling beta（建議 52 週滾動）\n- 傳導斷裂判斷：beta < 0.3 且持續 > 8 週\n</principle>\n</essential_principles>\n\n<intake>\n**您想要執行什麼操作？**\n\n1. **Full Analysis** - 完整供需×價格×傳導整合分析（生成完整報告）\n2. **Balance Nowcast** - 僅計算供需平衡即時估計（缺口擴大/縮小）\n3. **Price Regime** - 僅分析價格型態與週期位置\n4. **ETF Exposure** - 僅分析 ETF 持股結構與鋰價敏感度\n5. **Ingest Data** - 從各數據源擷取並標準化數據\n\n**等待回應後再繼續。**\n</intake>\n\n<routing>\n| Response                                          | Workflow                     | Description                |\n|---------------------------------------------------|------------------------------|----------------------------|\n| 1, \"full\", \"analyze\", \"完整\", \"報告\", \"LIT\"       | workflows/full-analysis.md   | 完整供需×價格×傳導整合分析 |\n| 2, \"balance\", \"nowcast\", \"供需\", \"缺口\", \"gap\"    | workflows/balance-nowcast.md | 供需平衡即時估計           |\n| 3, \"price\", \"regime\", \"價格\", \"週期\", \"型態\"      | workflows/price-regime.md    | 價格型態與週期分析         |\n| 4, \"etf\", \"exposure\", \"holding\", \"傳導\", \"敏感度\" | workflows/etf-exposure.md    | ETF 暴露與傳導分析         |\n| 5, \"ingest\", \"data\", \"fetch\", \"抓取\", \"擷取\"      | workflows/ingest.md          | 數據擷取與標準化           |\n\n**讀取工作流程後，請完全遵循其步驟。**\n</routing>\n\n<reference_index>\n**參考文件** (`references/`)\n\n| 文件                      | 內容                               |\n|---------------------------|------------------------------------|\n| data-sources.md           | 所有數據來源詳細說明與 URL         |\n| unit-conversion.md        | 單位轉換規則（LCE/Li/GWh）         |\n| price-methodology.md      | 價格數據方法學（Fastmarkets/SMM）  |\n| etf-holdings-structure.md | LIT 持股結構與產業鏈分段           |\n| supply-chain-mapping.md   | 鋰供應鏈完整映射（礦→化學品→電池） |\n| failure-modes.md          | 失敗模式與緩解策略                 |\n</reference_index>\n\n<workflows_index>\n| Workflow           | Purpose                    |\n|--------------------|----------------------------|\n| full-analysis.md   | 完整供需×價格×傳導整合分析 |\n| balance-nowcast.md | 供需平衡即時估計           |\n| price-regime.md    | 價格型態與週期分析         |\n| etf-exposure.md    | ETF 持股暴露與傳導分析     |\n| ingest.md          | 數據擷取與標準化           |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構模板 |\n| output-markdown.md | Markdown 報告模板 |\n| config.yaml        | 分析參數配置模板  |\n| data-schema.yaml   | 數據 Schema 定義  |\n</templates_index>\n\n<scripts_index>\n| Script                    | Purpose                  |\n|---------------------------|--------------------------|\n| lithium_pipeline.py       | 核心數據管線             |\n| ingest_sources.py         | 數據來源擷取             |\n| compute_balance.py        | 供需平衡計算             |\n| classify_regime.py        | 價格型態分類             |\n| compute_etf_beta.py       | ETF 傳導敏感度計算       |\n| visualize_analysis.py     | 分析結果綜合視覺化       |\n| inflection_point_chart.py | **拐點分析專用視覺化** ⭐ |\n</scripts_index>\n\n<quick_start>\n**CLI 快速開始：**\n\n```bash\n# 完整分析 LIT ETF（預設 10 年回看、週度頻率）\npython scripts/lithium_pipeline.py analyze --ticker=LIT --lookback=10 --freq=weekly\n\n# 僅計算供需平衡 Nowcast\npython scripts/lithium_pipeline.py balance --asof=2026-01-16\n\n# 分析價格型態（碳酸鋰 + 氫氧化鋰）\npython scripts/lithium_pipeline.py regime --chem=both\n\n# 計算 ETF 對鋰價的傳導敏感度\npython scripts/lithium_pipeline.py etf-beta --ticker=LIT --window=52\n\n# ✨ 生成視覺化圖表（完整儀表板）\npython scripts/visualize_analysis.py\n# 輸出：output/lithium_analysis_YYYY-MM-DD.png\n```\n\n**視覺化輸出**：\n- 📊 6合1 專業儀表板（18\" × 12\"，300 DPI）\n- 📁 自動保存至 `output/` 目錄\n- 📅 檔名包含當天日期\n- 🎨 完整中文支持\n\n**Library 快速開始：**\n\n```python\nfrom lithium_pipeline import LithiumSupplyDemandRadar\n\nradar = LithiumSupplyDemandRadar(\n    etf_ticker=\"LIT\",\n    lookback_years=10,\n    price_freq=\"weekly\",\n    chem_focus=\"both\",\n    data_level=\"free_nolimit\"\n)\n\n# 完整分析\nresult = radar.full_analysis()\nprint(f\"Balance Index: {result['balance_index']:.2f}\")\nprint(f\"Price Regime: {result['price_regime']}\")\nprint(f\"ETF Beta to Li: {result['etf_beta_li']:.2f}\")\nprint(f\"Thesis: {result['thesis']}\")\n```\n</quick_start>\n\n<success_criteria>\nSkill 成功執行時：\n- [ ] 正確識別數據等級並使用對應來源\n- [ ] 供需平衡指數計算正確（含三情境）\n- [ ] 價格型態分類明確（downtrend/bottoming/uptrend/overheat）\n- [ ] ETF 傳導敏感度計算正確（rolling beta）\n- [ ] 輸出包含完整的失效條件（invalidation）\n- [ ] 數據來源可追溯（source_id, data_level）\n- [ ] 單位轉換假設明確標註\n- [ ] **視覺化圖表已生成且符合規格**（300 DPI, PNG, 檔名含日期）\n- [ ] **報告與圖表在 output/ 目錄下一起輸出**\n</success_criteria>\n\n<input_schema>\n**輸入參數定義**\n\n```yaml\n# 必要參數\netf_ticker: string      # 目標 ETF（預設 LIT）\nlookback_years: int     # 回看年限（建議 10-15）\nprice_freq: string      # weekly | daily（建議 weekly）\n\n# 範圍參數\nregion_focus:           # 供應/需求重點區（選填）\n  - China\n  - Australia\n  - Chile\n  - Argentina\n  - US\n  - EU\n\nchem_focus: string      # carbonate | hydroxide | both（預設 both）\n\n# 數據等級\ndata_level: string      # free_nolimit | free_limit | paid_low | paid_high\n\n# 數據源開關\nsources:\n  usgs: boolean\n  iea_ev_outlook: boolean\n  australia_req: boolean\n  abs_exports: boolean\n  fastmarkets: boolean\n  smm: boolean\n  etf_holdings: boolean\n\n# 輸出格式\noutput_format: string   # markdown | json（預設 markdown）\n```\n</input_schema>\n\n<data_pipeline_architecture>\n**數據流水線架構**\n\n```\n[Data Sources]\n     |\n     v\n+--------------------+\n|   ingest_sources   |  --> USGS, IEA, Australia REQ/ABS\n+--------------------+      Fastmarkets/SMM (方法學/價格)\n     |                      Global X LIT factsheet\n     v\n+--------------------+\n|   normalize        |  --> 統一 schema + 單位標註\n+--------------------+\n     |\n     +-------------------+-------------------+\n     |                   |                   |\n     v                   v                   v\n+-----------+    +-----------+    +-----------+\n| supply_   |    | price_    |    | etf_      |\n| demand    |    | series    |    | holdings  |\n+-----------+    +-----------+    +-----------+\n     |                   |                   |\n     v                   v                   v\n+-----------+    +-----------+    +-----------+\n| balance_  |    | classify_ |    | compute_  |\n| nowcast   |    | regime    |    | etf_beta  |\n+-----------+    +-----------+    +-----------+\n     |                   |                   |\n     +-------------------+-------------------+\n                         |\n                         v\n              +--------------------+\n              |   generate_insight |  --> Thesis + Targets + Invalidation\n              +--------------------+\n                         |\n                         v\n              +--------------------+\n              |   format_output    |  --> JSON + Markdown\n              +--------------------+\n```\n\n**標準化欄位 Schema：**\n\n| 欄位        | 類型   | 說明                         |\n|-------------|--------|------------------------------|\n| date        | date   | 數據日期                     |\n| metric_type | string | supply/demand/price/etf      |\n| metric_name | string | 具體指標名稱                 |\n| value       | float  | 數值                         |\n| unit        | string | kt_LCE/USD_per_kg/GWh/pct    |\n| region      | string | 國家/區域                    |\n| source_id   | string | USGS/IEA/SMM/Fastmarkets/etc |\n| data_level  | string | 數據等級                     |\n| confidence  | float  | 來源品質評分 (0-1)           |\n</data_pipeline_architecture>\n",
        "skills/lithium-supply-demand-gap-radar/methodology.md": "這個技能原理分成四層，每一層都對應可取得的資料與可運算的指標：\n\n### 1. 供給需求：建立 **缺口指標** \n**原理**：鋰的價格中期走勢，往往由 **供需邊際變化** 主導。即使無法拿到完整、精準的全市場平衡表，也能用公開資料做出穩定的替代指標。\n\n- **供給替代指標（供給端）**：國別產量、出口、產能展望（例如：美國地質調查機構的年度基準資料 + 澳洲季度展望／出口資料）\n- **需求替代指標（需求端）**：電動車銷量／電池裝機（例如：國際能源總署的電動車展望報告中，電池需求的趨勢）\n\n把兩者標準化後做差，得到 **缺口指標** ：\n- **缺口指標 ≈ 標準化(需求替代指標 − 供給替代指標)**  \n  - 缺口指標上行：缺口擴大（市場更偏向供應偏緊）\n  - 缺口指標下行：寬鬆／過剩（市場更偏向供應偏鬆）\n\n> 重點：你不需要精準算到 **缺口幾萬噸** ，而是要能抓到 **缺口方向** 與 **拐點** 。\n\n### 2. 價格型態：確認市場是否開始為缺口定價\n**原理**：供需指標只是 **基本面** ，市場不一定立刻反應；因此要加一層 **價格型態** 判斷：鋰價是否已從下跌／築底，轉為上行趨勢。\n\n常用的型態分類：下行, 築底, 上行, 過熱，常用指標（以週線為主，更貼近產業節奏）：\n- 動能（例如 12–26 週）\n- 趨勢斜率（滾動斜率）\n- 波動型態（波動擴張）\n\n> 若 **缺口指標上行** 但鋰價仍處於下行型態，代表市場尚未認同，或仍在消化庫存與供給重啟的預期。\n\n### 3. 傳導速度：鋰價是否真的影響到股票與主題基金？\n**原理**：即使鋰價上漲，也可能因為公司成本、合約定價、庫存週期、或下游競爭而造成 **股價不跟** 。  \n所以必須檢驗 **鋰 → 公司 → 主題基金** 這條傳導鏈是否有效。\n\n做法：\n- 將主題基金的成分股分段：**上游（礦）／中游（精煉化學）／下游（電池材料與製造）**\n- 計算：\n  - **主題基金對鋰價因子的敏感度（滾動敏感度）**\n  - **各分段的主導貢獻（是誰在帶動主題基金上漲）**\n\n> 傳導有效的典型特徵：鋰價的型態轉為偏多後，主題基金對鋰價因子的敏感度回升，且上游／中游權重股開始領漲。\n\n### 4. 趨勢判斷：把結論落到 **交易／配置路徑** \n**原理**：你最後要回答的是 **能不能做多**  **何時可能走到哪**  **什麼情況算失效** 。  \n因此要把基本面與傳導結論，落到主題基金的長週期結構（例如：週線通道、前高、支撐區）。\n\n常見輸出：\n- **目標路徑**：中軌 → 前高 → 上軌（以區間而非精準點位）\n- **失效條件**：跌破關鍵週線支撐、或傳導敏感度轉弱、或缺口指標反轉\n\n## 這個技能為什麼實用\n- **把敘事變成可驗證條件**：不是聽到 **即將出現缺口** 就追，而是看缺口指標與價格型態是否真的轉向\n- **把主題投資拆成可追蹤的儀表板**：每週／每月更新一次，就能維持一致邏輯\n- **能清楚定義失效**：多頭觀點不是信仰，而是有明確的破局條件",
        "skills/lithium-supply-demand-gap-radar/references/data-sources.md": "# 鋰數據來源參考\n\n本文件詳細說明所有可用的鋰相關數據來源，包括 URL、數據類型、更新頻率和使用限制。\n\n---\n\n## Tier 0: 免費、穩定、口徑一致\n\n### USGS Lithium Statistics & Information\n\n**主入口**\n- URL: https://www.usgs.gov/centers/national-minerals-information-center/lithium-statistics-and-information\n- 數據類型: 年度世界產量、國別結構、儲量、消費\n- 更新頻率: 年度（每年 1-2 月發布前年數據）\n- 格式: PDF (MCS)、Excel、HTML 表格\n\n**直接數據連結**\n- Mineral Commodity Summaries: https://pubs.usgs.gov/periodicals/mcs2025/mcs2025-lithium.pdf\n- 歷史統計: https://www.usgs.gov/media/files/lithium-statistics\n\n**關鍵欄位**\n| 欄位 | 說明 | 單位 |\n|------|------|------|\n| World mine production | 全球礦場產量 | metric tons (Li content) |\n| Production by country | 國別產量 | metric tons |\n| Reserves | 儲量 | metric tons |\n| Apparent consumption | 表觀消費（美國） | metric tons |\n\n**注意事項**\n- USGS 使用 Li content（鋰金屬含量），非 LCE\n- 轉換: 1 t Li ≈ 5.32 t LCE\n\n---\n\n### IEA Global EV Outlook\n\n**主入口**\n- URL: https://www.iea.org/reports/global-ev-outlook-2024\n- 數據類型: EV 銷量、電池需求、關鍵金屬需求\n- 更新頻率: 年度（通常 4 月發布）\n- 格式: 互動圖表、PDF、Excel\n\n**數據瀏覽器**\n- Global EV Data Explorer: https://www.iea.org/data-and-statistics/data-product/global-ev-data-explorer\n\n**關鍵欄位**\n| 欄位 | 說明 | 單位 |\n|------|------|------|\n| EV sales | 電動車銷量 | million units |\n| Battery demand | 電池需求 | GWh |\n| Lithium demand | 鋰需求（如有） | kt |\n| EV stock | 電動車保有量 | million units |\n\n**注意事項**\n- IEA 電池需求包含 EV 和儲能\n- 鋰需求需要自行轉換（假設 kg/kWh）\n\n---\n\n### Australia Resources & Energy Quarterly (REQ)\n\n**主入口**\n- URL: https://www.industry.gov.au/publications/resources-and-energy-quarterly\n- 數據類型: 澳洲鋰產量、出口、價格展望\n- 更新頻率: 季度\n- 格式: PDF、Excel\n\n**關鍵章節**\n- Lithium outlook\n- Export earnings\n- Production volumes\n- Price forecasts\n\n**關鍵欄位**\n| 欄位 | 說明 | 單位 |\n|------|------|------|\n| Production volume | 澳洲產量 | kt spodumene / kt LCE |\n| Export value | 出口金額 | AUD billion |\n| Export volume | 出口量 | kt |\n| Price outlook | 價格展望 | USD/t |\n\n**注意事項**\n- 澳洲以鋰輝石(spodumene)為主，需轉換\n- REQ 包含 5 年前瞻預測\n\n---\n\n### ABS Lithium Exports\n\n**主入口**\n- URL: https://www.abs.gov.au/statistics/economy/international-trade\n- 數據類型: 澳洲鋰出口金額/數量\n- 更新頻率: 月度\n- 格式: TableBuilder、API\n\n**HS Code**\n- 2825.20 (Lithium oxide and hydroxide)\n- 2836.91 (Lithium carbonate)\n- 2530.90 (部分鋰精礦)\n\n**關鍵欄位**\n| 欄位 | 說明 | 單位 |\n|------|------|------|\n| Export value | 出口金額 | AUD |\n| Export quantity | 出口數量 | kg |\n| Destination | 目的地國家 | - |\n\n---\n\n### Global X LIT ETF\n\n**主入口**\n- URL: https://www.globalxetfs.com/funds/lit/\n- 數據類型: ETF 持股、NAV、factsheet\n- 更新頻率: 日度（持股）、月度（factsheet）\n- 格式: HTML、PDF、CSV\n\n**Factsheet**\n- 通常在頁面底部或 Documents 區域\n\n**關鍵欄位**\n| 欄位 | 說明 | 單位 |\n|------|------|------|\n| Holdings | 持股列表 | ticker, weight |\n| NAV | 淨值 | USD |\n| Total assets | 總資產 | USD |\n| Sector breakdown | 產業分布 | % |\n\n---\n\n## Tier 1: 免費但分散、需整合\n\n### CME Lithium Hydroxide Futures\n\n**主入口**\n- URL: https://www.cmegroup.com/markets/metals/battery-metals/lithium-hydroxide-cif-cjk-fastmarkets.html\n- 數據類型: 期貨價格、成交量、未平倉\n- 更新頻率: 即時\n- 格式: HTML、API（付費）\n\n**合約規格**\n| 項目 | 說明 |\n|------|------|\n| 標的 | Lithium Hydroxide Monohydrate CIF CJK |\n| 報價基準 | Fastmarkets |\n| 合約大小 | 1 metric ton |\n| 報價單位 | USD/kg |\n\n**注意事項**\n- 流動性可能較低\n- 可作為價格 proxy，但不完全等於現貨\n\n---\n\n### 鋰相關公司財報\n\n主要公司及其報告來源：\n\n| 公司 | 來源 | 類型 |\n|------|------|------|\n| Albemarle (ALB) | SEC EDGAR | 10-K, 10-Q |\n| SQM | NYSE filings | 20-F |\n| Livent/Arcadium (LTHM) | SEC EDGAR | 10-K, 10-Q |\n| Pilbara Minerals (PLS.AX) | ASX | Annual Report |\n| IGO Limited (IGO.AX) | ASX | Annual Report |\n| Mineral Resources (MIN.AX) | ASX | Annual Report |\n| Ganfeng Lithium | HKEX | Annual Report |\n\n**關鍵數據**\n- 產量/銷量\n- 產能利用率\n- 價格實現（realized price）\n- 產能擴張計劃\n\n---\n\n## Tier 2: 付費、更即時完整\n\n### Fastmarkets\n\n**主入口**\n- URL: https://www.fastmarkets.com/\n- 數據類型: 碳酸鋰/氫氧化鋰報價\n- 更新頻率: 週度（部分日度）\n- 格式: API、Excel\n\n**方法學（免費）**\n- URL: https://www.fastmarkets.com/methodology\n- 可了解報價規格、樣本來源、計算方法\n\n**關鍵報價**\n| 報價 | 規格 | 頻率 |\n|------|------|------|\n| Lithium carbonate 99.5% battery grade | CIF China, Japan, Korea | Weekly |\n| Lithium hydroxide monohydrate 56.5% | CIF China, Japan, Korea | Weekly |\n| Spodumene concentrate 6% | FOB Australia | Weekly |\n\n---\n\n### SMM (上海有色網)\n\n**主入口**\n- URL: https://www.smm.cn/\n- 數據類型: 中國碳酸鋰現貨價格\n- 更新頻率: 日度\n- 格式: HTML、API（付費）\n\n**方法學（免費）**\n- 可查看指數計算方式、樣本企業\n\n**關鍵報價**\n| 報價 | 規格 | 頻率 |\n|------|------|------|\n| 電池級碳酸鋰 | 99.5% min | 日度 |\n| 工業級碳酸鋰 | 99.2% min | 日度 |\n| 電池級氫氧化鋰 | 56.5% min | 日度 |\n\n**注意事項**\n- 中國現貨價格，可能與國際價格有價差\n- 人民幣報價，需匯率轉換\n\n---\n\n### 其他付費來源\n\n| 來源 | 專長 | 網址 |\n|------|------|------|\n| Benchmark Mineral Intelligence | 電池供應鏈、成本曲線 | benchmarkminerals.com |\n| BloombergNEF | 能源轉型、電池技術 | about.bnef.com |\n| Wood Mackenzie | 採礦、金屬 | woodmac.com |\n| CRU | 金屬價格、供需 | crugroup.com |\n| S&P Global Market Intelligence | 礦業資產、產量 | spglobal.com |\n\n---\n\n## 數據等級對照表\n\n| data_level | 供給數據 | 需求數據 | 價格數據 | ETF 數據 |\n|------------|----------|----------|----------|----------|\n| free_nolimit | USGS, AU REQ | IEA | CME 期貨/Proxy | Global X |\n| free_limit | + ABS 月度 | + 公司財報 | + 方法學參考 | 同上 |\n| paid_low | 同上 | + 詳細電池拆分 | Fastmarkets/SMM | 同上 |\n| paid_high | + S&P mine DB | + BNEF 預測 | + Benchmark | 同上 |\n\n---\n\n## 數據抓取注意事項\n\n### 遵守 robots.txt\n- 所有網站抓取前檢查 robots.txt\n- 遵守 Crawl-delay 指令\n\n### 請求頻率\n- 保持合理間隔（至少 1-2 秒）\n- 使用隨機延遲避免被封鎖\n\n### User-Agent\n- 使用真實瀏覽器 User-Agent\n- 參考 `design-human-like-crawler.md`\n\n### 數據授權\n- 免費數據可用於分析\n- 付費數據需有效訂閱\n- 不得重新分發原始數據\n",
        "skills/lithium-supply-demand-gap-radar/references/etf-holdings-structure.md": "# LIT ETF 持股結構參考\n\n本文件說明 Global X Lithium & Battery Tech ETF (LIT) 的持股結構和產業鏈分類。\n\n---\n\n## ETF 概述\n\n### 基本資訊\n\n| 項目     | 說明                                |\n|----------|-------------------------------------|\n| 名稱     | Global X Lithium & Battery Tech ETF |\n| 代碼     | LIT                                 |\n| 發行商   | Global X                            |\n| 成立日期 | 2010-07-22                          |\n| 費用率   | 0.75%                               |\n| 追蹤指數 | Solactive Global Lithium Index      |\n\n### 投資範圍\n\nLIT 投資於鋰產業鏈的三個層級：\n\n1. **Upstream (上游)**: 鋰礦開採\n2. **Midstream (中游)**: 鋰精煉、化學品生產\n3. **Downstream (下游)**: 電池製造、電動車\n\n---\n\n## 持股分類框架\n\n### 產業鏈段定義\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                     鋰產業鏈                                 │\n├─────────────┬─────────────────┬─────────────────────────────┤\n│  Upstream   │    Midstream    │         Downstream          │\n│   (礦端)    │    (化學品)     │         (電池/EV)           │\n├─────────────┼─────────────────┼─────────────────────────────┤\n│ 鋰礦開採    │ 鋰精煉          │ 電池製造                    │\n│ 鋰輝石生產  │ 碳酸鋰生產      │ 電池材料（正極/負極）       │\n│             │ 氫氧化鋰生產    │ 電動車整車                  │\n├─────────────┼─────────────────┼─────────────────────────────┤\n│ 對鋰價敏感  │ 對鋰價敏感      │ 對鋰價較不敏感              │\n│ 高 (1.5-2.5)│ 中 (0.8-1.2)    │ 低 (0.3-0.8)                │\n└─────────────┴─────────────────┴─────────────────────────────┘\n```\n\n### 典型持股分類\n\n#### Upstream (上游礦業)\n\n| 股票代碼 | 公司名稱                  | 國家      | 主要業務           |\n|----------|---------------------------|-----------|--------------------|\n| ALB      | Albemarle Corp            | US        | 鋰化學品巨頭、礦業 |\n| SQM      | Sociedad Quimica y Minera | Chile     | 鹵水提鋰           |\n| PLS.AX   | Pilbara Minerals          | Australia | 硬岩鋰輝石         |\n| MIN.AX   | Mineral Resources         | Australia | 硬岩鋰輝石         |\n| IGO.AX   | IGO Ltd                   | Australia | 鋰、鎳礦           |\n| LAC      | Lithium Americas          | US/Canada | 鋰開發項目         |\n| SGML     | Sigma Lithium             | Brazil    | 鋰輝石開發         |\n\n**特徵**:\n- 營收直接與鋰價掛鉤\n- 高營業槓桿\n- 對鋰價 beta 最高\n\n#### Midstream (中游精煉)\n\n| 股票代碼 | 公司名稱              | 國家  | 主要業務     |\n|----------|-----------------------|-------|--------------|\n| LTHM     | Arcadium Lithium      | US    | 氫氧化鋰生產 |\n| GANF.PA  | Ganfeng Lithium (ADR) | China | 鋰化學品     |\n| TIAN.SZ  | Tianqi Lithium        | China | 鋰化學品     |\n\n**特徵**:\n- 受鋰價和加工費影響\n- 垂直整合程度不一\n- 對鋰價 beta 中等\n\n#### Downstream (下游電池/EV)\n\n| 股票代碼         | 公司名稱           | 國家  | 主要業務     |\n|------------------|--------------------|-------|--------------|\n| TSLA             | Tesla Inc          | US    | 電動車、儲能 |\n| CATL (300750.SZ) | CATL               | China | 電池製造     |\n| 6752.T           | Panasonic          | Japan | 電池製造     |\n| 051910.KS        | LG Energy Solution | Korea | 電池製造     |\n| 006400.KS        | Samsung SDI        | Korea | 電池製造     |\n| 1211.HK          | BYD                | China | 電動車、電池 |\n\n**特徵**:\n- 鋰是成本項目之一，非全部\n- 受競爭格局、技術路線影響\n- 對鋰價 beta 較低\n\n---\n\n## 預期 Beta 估計\n\n### 按產業鏈段\n\n| 產業鏈段   | 對鋰價 Beta 範圍 | 說明               |\n|------------|------------------|--------------------|\n| Upstream   | 1.5 - 2.5        | 營收直接受鋰價影響 |\n| Midstream  | 0.8 - 1.2        | 受鋰價和加工費影響 |\n| Downstream | 0.3 - 0.8        | 鋰是成本之一       |\n\n### 個股 Beta 估計\n\n```python\n# 基於歷史回歸的 beta 估計（示例）\nSTOCK_BETAS = {\n    # Upstream\n    \"ALB\": 1.8,\n    \"SQM\": 1.9,\n    \"PLS.AX\": 2.2,\n    \"MIN.AX\": 2.0,\n    \"LAC\": 2.5,\n\n    # Midstream\n    \"LTHM\": 1.1,\n    \"GANF\": 1.3,\n\n    # Downstream\n    \"TSLA\": 0.5,\n    \"CATL\": 0.6,\n    \"6752.T\": 0.4,\n    \"051910.KS\": 0.5,\n    \"006400.KS\": 0.5,\n    \"1211.HK\": 0.7\n}\n```\n\n---\n\n## 加權 Beta 計算\n\n### 公式\n\n```python\ndef compute_weighted_etf_beta(holdings, stock_betas):\n    \"\"\"\n    計算 ETF 的加權 beta\n\n    ETF_beta = Σ(weight_i × beta_i)\n    \"\"\"\n    weighted_beta = 0\n\n    for holding in holdings:\n        ticker = holding[\"ticker\"]\n        weight = holding[\"weight\"] / 100  # 轉為小數\n\n        beta = stock_betas.get(ticker, estimate_beta_by_segment(holding[\"segment\"]))\n        weighted_beta += weight * beta\n\n    return weighted_beta\n```\n\n### 示例計算\n\n假設 LIT 持股結構：\n\n| 股票     | 權重 | Beta | 貢獻      |\n|----------|------|------|-----------|\n| ALB      | 8%   | 1.8  | 0.144     |\n| SQM      | 6%   | 1.9  | 0.114     |\n| TSLA     | 10%  | 0.5  | 0.050     |\n| CATL     | 8%   | 0.6  | 0.048     |\n| ...      | ...  | ...  | ...       |\n| **合計** | 100% | -    | **~0.85** |\n\n---\n\n## 持股變動影響\n\n### 定期調整\n\n- LIT 追蹤 Solactive Global Lithium Index\n- 指數定期再平衡（通常季度）\n- 權重變動會影響 ETF 的整體 beta\n\n### 監控要點\n\n```python\ndef detect_holdings_change(current_holdings, previous_holdings):\n    \"\"\"\n    偵測持股變動\n    \"\"\"\n    changes = {\n        \"added\": [],\n        \"removed\": [],\n        \"weight_changed\": []\n    }\n\n    current_set = set(h[\"ticker\"] for h in current_holdings)\n    previous_set = set(h[\"ticker\"] for h in previous_holdings)\n\n    changes[\"added\"] = list(current_set - previous_set)\n    changes[\"removed\"] = list(previous_set - current_set)\n\n    # 權重變動\n    for c in current_holdings:\n        ticker = c[\"ticker\"]\n        prev = next((p for p in previous_holdings if p[\"ticker\"] == ticker), None)\n        if prev and abs(c[\"weight\"] - prev[\"weight\"]) > 1:\n            changes[\"weight_changed\"].append({\n                \"ticker\": ticker,\n                \"old_weight\": prev[\"weight\"],\n                \"new_weight\": c[\"weight\"]\n            })\n\n    return changes\n```\n\n---\n\n## 傳導敏感度分析\n\n### 傳導正常的特徵\n\n1. ETF 對鋰價 rolling beta > 0.5\n2. 上游持股權重穩定\n3. 無重大個股特殊事件\n\n### 傳導斷裂的特徵\n\n1. Beta 持續低於 0.3 超過 8 週\n2. 下游/非鋰業務持股權重上升\n3. 市場情緒主導個股走勢\n\n### 分析代碼\n\n```python\ndef analyze_transmission(beta_history, holdings_history, threshold=0.3, duration=8):\n    \"\"\"\n    分析傳導狀態\n    \"\"\"\n\n    recent_betas = beta_history[-duration:]\n\n    # 檢查 beta 趨勢\n    if all(b < threshold for b in recent_betas):\n        return {\n            \"status\": \"broken\",\n            \"reason\": f\"Beta 低於 {threshold} 持續 {duration} 週\",\n            \"recommendation\": \"分析個股因素，考慮直接交易鋰 proxy\"\n        }\n\n    # 檢查持股結構變化\n    upstream_weight_trend = compute_segment_weight_trend(holdings_history, \"upstream\")\n\n    if upstream_weight_trend < -5:  # 上游權重下降超過 5%\n        return {\n            \"status\": \"weakening\",\n            \"reason\": \"上游持股權重下降\",\n            \"recommendation\": \"監控 beta 是否持續下降\"\n        }\n\n    return {\n        \"status\": \"normal\",\n        \"reason\": f\"近期平均 Beta = {np.mean(recent_betas):.2f}\",\n        \"recommendation\": \"正常使用 ETF 作為鋰暴露工具\"\n    }\n```\n\n---\n\n## 替代 ETF 選項\n\n如果 LIT 傳導不佳，可考慮其他選項：\n\n| ETF                                      | 代碼 | 特點               |\n|------------------------------------------|------|--------------------|\n| Global X Lithium                         | LITM | 更集中於純鋰業務   |\n| Amplify Lithium & Battery Tech           | BATT | 更廣泛的電池供應鏈 |\n| First Trust NASDAQ Clean Edge Smart Grid | GRID | 電網/儲能相關      |\n| iShares Global Clean Energy              | ICLN | 更廣泛的清潔能源   |\n\n### 直接暴露選項\n\n- 個股籃子（ALB, SQM, PLS.AX）\n- CME 鋰期貨\n- 鋰相關公司債券\n",
        "skills/lithium-supply-demand-gap-radar/references/failure-modes.md": "# 失敗模式與緩解策略\n\n本文件記錄 Skill 執行過程中可能遇到的失敗模式及其緩解策略。\n\n---\n\n## 數據擷取失敗\n\n### FM-001: USGS 頁面結構變更\n\n**症狀**\n- 無法解析 USGS 頁面\n- 選擇器找不到目標元素\n\n**原因**\n- USGS 網站改版\n- 數據發布路徑變更\n\n**緩解策略**\n1. 使用多層備用選擇器\n2. 嘗試直接下載 PDF/Excel\n3. 使用緩存的歷史數據\n4. 標記 `confidence = 0.5`\n\n```python\ndef ingest_usgs_with_fallback():\n    try:\n        return scrape_usgs_html()\n    except SelectorError:\n        try:\n            return download_usgs_pdf()\n        except:\n            return load_cached_usgs()\n```\n\n---\n\n### FM-002: 價格數據不可得\n\n**症狀**\n- Fastmarkets/SMM 無法訪問\n- API 返回錯誤或空值\n\n**原因**\n- 付費牆限制\n- API 配額耗盡\n- 網站維護\n\n**緩解策略**\n1. 切換到 CME 期貨 proxy\n2. 使用股票籃子 proxy\n3. 向前填充最近有效價格\n4. 標記 `data_level = \"proxy\"`\n\n```python\ndef load_price_with_fallback(data_level):\n    if data_level in [\"paid_low\", \"paid_high\"]:\n        price = try_fastmarkets() or try_smm()\n        if price:\n            return price\n\n    # Fallback 到免費 proxy\n    return try_cme_futures() or compute_stock_proxy()\n```\n\n---\n\n### FM-003: ETF 持股載入失敗\n\n**症狀**\n- Global X 頁面無法解析\n- 持股數據為空\n\n**原因**\n- 頁面動態載入\n- factsheet 格式變更\n\n**緩解策略**\n1. 使用 Selenium 等待動態內容\n2. 嘗試解析 PDF factsheet\n3. 使用靜態備份（上次成功抓取）\n4. 標記 `asof_date = \"static\"`\n\n```python\ndef load_holdings_with_fallback(ticker):\n    # 優先：動態抓取\n    holdings = scrape_globalx_dynamic(ticker)\n\n    if not holdings:\n        # 備用：PDF factsheet\n        holdings = parse_factsheet_pdf(ticker)\n\n    if not holdings:\n        # 最後：靜態備份\n        holdings = load_static_backup(ticker)\n        holdings[\"source\"] = \"static_backup\"\n\n    return holdings\n```\n\n---\n\n## 計算邏輯失敗\n\n### FM-101: 數據對齊失敗\n\n**症狀**\n- 時間序列長度不一致\n- 合併後出現大量 NaN\n\n**原因**\n- 數據源更新頻率不同（年度 vs 月度）\n- 日期格式不一致\n\n**緩解策略**\n1. 標準化日期格式\n2. 使用適當的重採樣策略\n3. 明確標記缺失值處理\n\n```python\ndef align_series(series_list, freq=\"weekly\"):\n    \"\"\"對齊多個時間序列\"\"\"\n\n    # 1. 標準化日期格式\n    for s in series_list:\n        s.index = pd.to_datetime(s.index)\n\n    # 2. 重採樣到目標頻率\n    resampled = [s.resample(freq).last().ffill() for s in series_list]\n\n    # 3. 取交集時間範圍\n    common_start = max(s.index.min() for s in resampled)\n    common_end = min(s.index.max() for s in resampled)\n\n    aligned = [s.loc[common_start:common_end] for s in resampled]\n\n    return aligned\n```\n\n---\n\n### FM-102: 回歸計算異常\n\n**症狀**\n- Beta 值異常（極大或極小）\n- R² 接近 0 或負值\n\n**原因**\n- 數據點太少\n- 多重共線性\n- 異常值影響\n\n**緩解策略**\n1. 最低數據點要求（>= 30）\n2. 異常值檢測與處理\n3. 穩健回歸方法\n\n```python\ndef rolling_beta_robust(y, X, window=52, min_obs=30):\n    \"\"\"穩健的滾動 beta 計算\"\"\"\n\n    results = []\n\n    for i in range(window, len(y)):\n        y_window = y.iloc[i-window:i]\n        X_window = X.iloc[i-window:i]\n\n        # 檢查有效數據點\n        valid_mask = ~(y_window.isna() | X_window.isna().any(axis=1))\n        if valid_mask.sum() < min_obs:\n            results.append({\"date\": y.index[i], \"beta\": np.nan, \"valid\": False})\n            continue\n\n        # 異常值處理\n        y_clean, X_clean = remove_outliers(y_window[valid_mask], X_window[valid_mask])\n\n        # 回歸\n        try:\n            model = sm.OLS(y_clean, sm.add_constant(X_clean)).fit()\n            results.append({\n                \"date\": y.index[i],\n                \"beta\": model.params[1:].to_dict(),\n                \"r_squared\": model.rsquared,\n                \"valid\": True\n            })\n        except Exception as e:\n            results.append({\"date\": y.index[i], \"beta\": np.nan, \"valid\": False, \"error\": str(e)})\n\n    return pd.DataFrame(results)\n```\n\n---\n\n### FM-103: 單位轉換錯誤\n\n**症狀**\n- 數值異常大或異常小\n- 供需計算結果不合理\n\n**原因**\n- 混用不同單位（Li vs LCE vs ore）\n- 轉換係數錯誤\n\n**緩解策略**\n1. 強制單位標註\n2. 範圍檢查\n3. 轉換前後驗證\n\n```python\ndef validate_conversion(value, source_unit, target_unit, context=\"\"):\n    \"\"\"驗證單位轉換結果\"\"\"\n\n    # 合理範圍定義\n    ranges = {\n        \"kt_LCE\": {\"global_production\": (500, 2000), \"country_production\": (0, 500)},\n        \"kt_Li\": {\"global_production\": (100, 400), \"country_production\": (0, 100)},\n        \"GWh\": {\"global_battery\": (500, 5000), \"country_battery\": (0, 1000)}\n    }\n\n    expected_range = ranges.get(target_unit, {}).get(context, (0, float(\"inf\")))\n\n    if not expected_range[0] <= value <= expected_range[1]:\n        return {\n            \"status\": \"warning\",\n            \"message\": f\"轉換結果 {value} {target_unit} 超出預期範圍 {expected_range}\",\n            \"suggestion\": f\"請檢查 {source_unit} → {target_unit} 轉換是否正確\"\n        }\n\n    return {\"status\": \"ok\"}\n```\n\n---\n\n## 輸出格式失敗\n\n### FM-201: JSON 序列化錯誤\n\n**症狀**\n- TypeError: Object of type X is not JSON serializable\n- 輸出為空或格式錯誤\n\n**原因**\n- pandas 對象未轉換\n- numpy 類型未處理\n- 日期對象未格式化\n\n**緩解策略**\n1. 自定義 JSON encoder\n2. 序列化前轉換\n\n```python\nclass LithiumEncoder(json.JSONEncoder):\n    \"\"\"處理 numpy/pandas 類型的 JSON encoder\"\"\"\n\n    def default(self, obj):\n        if isinstance(obj, np.integer):\n            return int(obj)\n        if isinstance(obj, np.floating):\n            return float(obj)\n        if isinstance(obj, np.ndarray):\n            return obj.tolist()\n        if isinstance(obj, pd.Timestamp):\n            return obj.isoformat()\n        if isinstance(obj, pd.DataFrame):\n            return obj.to_dict(orient=\"records\")\n        if isinstance(obj, pd.Series):\n            return obj.to_dict()\n        return super().default(obj)\n```\n\n---\n\n### FM-202: Markdown 格式錯亂\n\n**症狀**\n- 表格不對齊\n- 代碼塊未正確渲染\n\n**原因**\n- 特殊字符未轉義\n- 中英文混排寬度問題\n\n**緩解策略**\n1. 使用 ASCII 表格（如示例）\n2. 轉義特殊字符\n3. 固定寬度格式化\n\n```python\ndef format_table_ascii(headers, rows, widths=None):\n    \"\"\"生成 ASCII 表格（避免 Markdown 渲染問題）\"\"\"\n\n    if widths is None:\n        widths = [max(len(str(h)), max(len(str(r[i])) for r in rows))\n                  for i, h in enumerate(headers)]\n\n    # 頂部邊框\n    top = \"┌\" + \"┬\".join(\"─\" * (w + 2) for w in widths) + \"┐\"\n\n    # 標題行\n    header_row = \"│\" + \"│\".join(f\" {h:<{w}} \" for h, w in zip(headers, widths)) + \"│\"\n\n    # 分隔線\n    sep = \"├\" + \"┼\".join(\"─\" * (w + 2) for w in widths) + \"┤\"\n\n    # 數據行\n    data_rows = []\n    for row in rows:\n        data_rows.append(\"│\" + \"│\".join(f\" {str(r):<{w}} \" for r, w in zip(row, widths)) + \"│\")\n\n    # 底部邊框\n    bottom = \"└\" + \"┴\".join(\"─\" * (w + 2) for w in widths) + \"┘\"\n\n    return \"\\n\".join([top, header_row, sep] + data_rows + [bottom])\n```\n\n---\n\n## 預防性檢查\n\n### 執行前檢查清單\n\n```python\ndef pre_execution_check(params):\n    \"\"\"執行前檢查\"\"\"\n\n    checks = []\n\n    # 1. 參數驗證\n    required_params = [\"etf_ticker\", \"lookback_years\", \"price_freq\"]\n    for p in required_params:\n        if p not in params:\n            checks.append({\"check\": f\"param_{p}\", \"status\": \"fail\", \"message\": f\"缺少必要參數: {p}\"})\n        else:\n            checks.append({\"check\": f\"param_{p}\", \"status\": \"pass\"})\n\n    # 2. 數據源可達性\n    sources = [\"usgs\", \"iea\", \"globalx\"]\n    for source in sources:\n        if is_source_reachable(source):\n            checks.append({\"check\": f\"source_{source}\", \"status\": \"pass\"})\n        else:\n            checks.append({\"check\": f\"source_{source}\", \"status\": \"warning\", \"message\": f\"{source} 可能不可達\"})\n\n    # 3. 依賴庫\n    required_libs = [\"pandas\", \"numpy\", \"yfinance\", \"statsmodels\"]\n    for lib in required_libs:\n        try:\n            __import__(lib)\n            checks.append({\"check\": f\"lib_{lib}\", \"status\": \"pass\"})\n        except ImportError:\n            checks.append({\"check\": f\"lib_{lib}\", \"status\": \"fail\", \"message\": f\"缺少依賴: {lib}\"})\n\n    return {\n        \"all_pass\": all(c[\"status\"] == \"pass\" for c in checks),\n        \"checks\": checks\n    }\n```\n\n---\n\n## 錯誤報告格式\n\n當發生錯誤時，輸出以下格式的錯誤報告：\n\n```markdown\n# 執行錯誤報告\n\n## 錯誤摘要\n- 錯誤代碼: [FM-XXX]\n- 錯誤類型: [類型]\n- 發生位置: [函數/模塊]\n- 時間: [YYYY-MM-DD HH:MM:SS]\n\n## 錯誤詳情\n[詳細描述]\n\n## 受影響的功能\n- [功能1]\n- [功能2]\n\n## 緩解措施\n1. [措施1]\n2. [措施2]\n\n## 降級輸出\n[如果仍有部分結果可用，在此顯示]\n\n## 建議行動\n- [ ] [用戶應採取的行動]\n```\n",
        "skills/lithium-supply-demand-gap-radar/references/price-methodology.md": "# 鋰價格數據方法學參考\n\n理解價格報價的方法學對於正確使用價格數據至關重要。本文件整理主要價格來源的方法學要點。\n\n---\n\n## Fastmarkets 方法學\n\n### 報價概述\n\nFastmarkets 是鋰價格報價的主要國際來源，其報價被 CME 期貨合約作為結算基準。\n\n**方法學文件**\n- URL: https://www.fastmarkets.com/methodology\n\n### 主要報價規格\n\n#### Lithium Carbonate (碳酸鋰)\n\n| 報價名稱 | 規格 | 頻率 |\n|----------|------|------|\n| Lithium carbonate 99.5% Li2CO3 min, battery grade | CIF China, Japan, Korea | Weekly (Thursday) |\n| Lithium carbonate 99% Li2CO3 min, technical/industrial grade | CIF China, Japan, Korea | Weekly |\n\n**規格說明**\n- 純度: ≥99.5% Li₂CO₃（電池級）\n- 交貨條件: CIF（含運保費）\n- 地點: 中國、日本、韓國港口\n- 包裝: 噸袋或 25kg 袋\n\n#### Lithium Hydroxide (氫氧化鋰)\n\n| 報價名稱 | 規格 | 頻率 |\n|----------|------|------|\n| Lithium hydroxide monohydrate 56.5% LiOH.H2O min, battery grade | CIF China, Japan, Korea | Weekly (Thursday) |\n\n**規格說明**\n- 純度: ≥56.5% LiOH·H₂O\n- 顆粒大小: 通常有規格要求\n- 雜質限制: 特定元素含量上限\n\n#### Spodumene Concentrate (鋰輝石精礦)\n\n| 報價名稱 | 規格 | 頻率 |\n|----------|------|------|\n| Spodumene concentrate 6% Li2O min | FOB Australia | Weekly |\n\n**規格說明**\n- Li₂O 含量: ≥6%\n- 水分: 通常 <8%\n- 鐵含量: 有上限要求\n\n### 報價計算方法\n\n1. **數據收集**\n   - 向生產商、貿易商、消費者收集成交/報價\n   - 最少需要一定數量的數據點\n\n2. **價格計算**\n   - 使用加權平均或區間報價\n   - 排除異常值\n   - 考慮交貨時間調整\n\n3. **發布**\n   - 週四倫敦時間發布\n   - 包含高、低、中間價\n\n### 使用注意\n\n- **時滯**: 報價反映過去一週的成交，非即時\n- **樣本**: 可能無法覆蓋所有交易\n- **規格**: 實際交易可能有規格差異，需調整\n\n---\n\n## SMM (上海有色網) 方法學\n\n### 報價概述\n\nSMM 是中國最大的金屬價格資訊平台，其碳酸鋰指數是中國市場的主要參考。\n\n**方法學文件**\n- 可在 SMM 網站查看指數計算說明\n\n### 主要報價\n\n| 報價名稱 | 規格 | 頻率 |\n|----------|------|------|\n| 電池級碳酸鋰 | ≥99.5% | 每日 |\n| 工業級碳酸鋰 | ≥99.2% | 每日 |\n| 電池級氫氧化鋰 | ≥56.5% | 每日 |\n| 電池級碳酸鋰（微粉） | ≥99.5%, D50<10μm | 每日 |\n\n### 報價計算方法\n\n1. **數據收集**\n   - 向國內主要生產商、貿易商收集報價\n   - 電話/線上訪談\n\n2. **指數計算**\n   - 加權平均\n   - 權重基於樣本企業市場份額\n\n3. **發布**\n   - 每日發布（工作日）\n   - 人民幣/噸\n\n### 中國 vs 國際價格差異\n\n| 因素 | 說明 |\n|------|------|\n| 匯率 | CNY/USD 匯率波動 |\n| 運費 | 國際運輸成本 |\n| 品質 | 規格可能略有差異 |\n| 供需 | 區域供需可能不同步 |\n| 關稅 | 進出口關稅影響 |\n\n**典型價差**: 中國價格通常低於國際價格 5-15%，但可能反轉\n\n---\n\n## CME 鋰期貨\n\n### 合約規格\n\n| 項目 | 說明 |\n|------|------|\n| 合約代碼 | LIH (氫氧化鋰) |\n| 合約大小 | 1 metric ton |\n| 報價單位 | USD / kilogram |\n| 最小變動 | 0.001 USD/kg |\n| 結算方式 | 現金結算 |\n| 結算價基準 | Fastmarkets Lithium Hydroxide CIF CJK |\n\n### 合約月份\n- 連續 12 個月\n\n### 交易時間\n- 芝加哥時間: Sunday - Friday, 5:00 PM - 4:00 PM CT\n\n### 使用作為價格 Proxy\n\n**優點**:\n- 可交易、可獲取\n- 反映市場預期\n- 有流動性數據\n\n**缺點**:\n- 流動性可能較低\n- 期貨 vs 現貨價差\n- 僅限氫氧化鋰\n\n**價差調整**:\n```python\n# 期貨 → 現貨估計\nspot_estimate = futures_price * (1 + basis_adjustment)\n\n# basis_adjustment 通常在 -5% 到 +5% 之間\n# 取決於市場狀態（contango/backwardation）\n```\n\n---\n\n## 價格 Proxy 方法\n\n當付費價格數據不可得時，可使用以下 proxy：\n\n### 1. 鋰礦股籃子 Proxy\n\n```python\ndef compute_lithium_stock_proxy(weights=None):\n    \"\"\"\n    使用鋰相關股票建立價格 proxy\n    \"\"\"\n    if weights is None:\n        weights = {\n            \"ALB\": 0.30,   # Albemarle\n            \"SQM\": 0.25,   # SQM\n            \"LTHM\": 0.20,  # Livent/Arcadium\n            \"LAC\": 0.15,   # Lithium Americas\n            \"PLS.AX\": 0.10 # Pilbara Minerals\n        }\n\n    # 載入股價\n    prices = load_stock_prices(list(weights.keys()))\n\n    # 計算加權指數\n    proxy_index = sum(prices[ticker] * weight for ticker, weight in weights.items())\n\n    return normalize_to_base_100(proxy_index)\n```\n\n**相關性驗證**:\n- 與 Fastmarkets 碳酸鋰價格相關性通常 > 0.7\n- 需定期重新校準權重\n\n### 2. ETF Price Proxy\n\n```python\ndef lit_etf_as_proxy():\n    \"\"\"\n    使用 LIT ETF 價格作為鋰市場情緒 proxy\n    \"\"\"\n    lit_price = load_price(\"LIT\")\n\n    # 注意：ETF 價格受多因素影響\n    # 僅作為方向性指標，非絕對價格\n\n    return lit_price\n```\n\n### 3. Spodumene → LCE 推算\n\n```python\ndef implied_lce_from_spodumene(sc6_price):\n    \"\"\"\n    從鋰輝石價格推算碳酸鋰價格\n    \"\"\"\n    # 加工成本假設（USD/t LCE）\n    conversion_cost = 3000  # 視市場狀況調整\n\n    # 轉換係數\n    sc6_to_lce_ratio = 7.0  # 約 7 噸 SC6 → 1 噸 LCE\n\n    implied_lce = sc6_price * sc6_to_lce_ratio + conversion_cost\n\n    return implied_lce\n```\n\n---\n\n## 價格數據品質評估\n\n### 評估維度\n\n| 維度 | 說明 | 權重 |\n|------|------|------|\n| 時效性 | 數據更新頻率 | 25% |\n| 覆蓋度 | 市場交易覆蓋比例 | 25% |\n| 規格一致性 | 報價規格是否標準化 | 20% |\n| 來源可靠性 | 數據收集方法是否透明 | 20% |\n| 歷史深度 | 歷史數據長度 | 10% |\n\n### 來源評分\n\n| 來源 | 時效性 | 覆蓋度 | 規格 | 可靠性 | 歷史 | 總分 |\n|------|--------|--------|------|--------|------|------|\n| Fastmarkets | 5 | 4 | 5 | 5 | 4 | 4.6 |\n| SMM | 5 | 5 | 4 | 4 | 4 | 4.5 |\n| CME Futures | 5 | 2 | 5 | 5 | 2 | 3.6 |\n| Stock Proxy | 5 | 3 | 2 | 3 | 5 | 3.5 |\n\n---\n\n## 價格分析最佳實踐\n\n### 1. 標註數據來源\n\n```python\nprice_data = {\n    \"value\": 15000,\n    \"unit\": \"USD/t\",\n    \"source\": \"Fastmarkets\",\n    \"spec\": \"Lithium carbonate 99.5% battery grade CIF CJK\",\n    \"asof_date\": \"2026-01-16\",\n    \"data_level\": \"paid\"\n}\n```\n\n### 2. 多來源交叉驗證\n\n```python\ndef validate_price(fastmarkets_price, smm_price, exchange_rate):\n    \"\"\"\n    交叉驗證價格合理性\n    \"\"\"\n    smm_usd = smm_price / exchange_rate\n\n    diff_pct = abs(fastmarkets_price - smm_usd) / fastmarkets_price * 100\n\n    if diff_pct > 20:\n        return {\"status\": \"warning\", \"message\": f\"價差異常: {diff_pct:.1f}%\"}\n\n    return {\"status\": \"ok\", \"price_consensus\": (fastmarkets_price + smm_usd) / 2}\n```\n\n### 3. 處理缺失數據\n\n```python\ndef fill_missing_price(price_series, method=\"ffill\"):\n    \"\"\"\n    填補缺失價格\n    \"\"\"\n    if method == \"ffill\":\n        return price_series.ffill()  # 向前填充\n    elif method == \"linear\":\n        return price_series.interpolate()  # 線性插值\n    else:\n        return price_series\n```\n",
        "skills/lithium-supply-demand-gap-radar/references/supply-chain-mapping.md": "# 鋰供應鏈完整映射\n\n本文件提供鋰從礦端到終端應用的完整供應鏈映射，幫助理解各環節的數據關係。\n\n---\n\n## 供應鏈概覽\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                           鋰供應鏈完整映射                                    │\n├─────────────────────────────────────────────────────────────────────────────┤\n│                                                                              │\n│  ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐            │\n│  │  礦端    │────▶│  精煉    │────▶│  材料    │────▶│  終端    │            │\n│  │ Mining   │     │ Refining │     │ Materials│     │ End Use  │            │\n│  └──────────┘     └──────────┘     └──────────┘     └──────────┘            │\n│       │               │               │               │                      │\n│       ▼               ▼               ▼               ▼                      │\n│  ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐            │\n│  │ 鋰輝石   │     │ 碳酸鋰   │     │ 正極材料 │     │ EV 電池  │            │\n│  │ 鹵水     │     │ 氫氧化鋰 │     │ 電解質   │     │ 儲能電池 │            │\n│  │ 黏土     │     │ 金屬鋰   │     │ 負極材料 │     │ 消費電子 │            │\n│  └──────────┘     └──────────┘     └──────────┘     └──────────┘            │\n│                                                                              │\n└─────────────────────────────────────────────────────────────────────────────┘\n```\n\n---\n\n## 第一層：礦端 (Mining)\n\n### 礦石類型\n\n| 類型                     | 典型產地               | Li₂O 含量 | 特點             |\n|--------------------------|------------------------|-----------|------------------|\n| 硬岩（鋰輝石 Spodumene） | 澳洲、巴西、加拿大     | 5-8%      | 開採快、成本中等 |\n| 鹵水（Brine）            | 智利、阿根廷、玻利維亞 | 0.1-0.3%  | 成本低、週期長   |\n| 黏土（Clay）             | 美國、墨西哥           | 0.2-0.5%  | 新興、技術開發中 |\n| 其他（雲母、鋰蒙脫石）   | 中國、辛巴威           | varies    | 區域性供給       |\n\n### 主要礦區/公司\n\n**澳洲（硬岩主力）**\n| 礦區        | 公司             | 產能 (ktpa Li₂O) |\n|-------------|------------------|------------------|\n| Greenbushes | Tianqi/IGO       | ~160             |\n| Mt Marion   | MIN/Ganfeng      | ~45              |\n| Pilgangoora | Pilbara Minerals | ~68              |\n| Wodgina     | MIN/Albemarle    | ~75              |\n| Finniss     | Core Lithium     | ~15              |\n\n**智利（鹵水）**\n| 鹽湖    | 公司      | 產能 (ktpa LCE) |\n|---------|-----------|-----------------|\n| Atacama | SQM       | ~180            |\n| Atacama | Albemarle | ~85             |\n\n**阿根廷（鹵水）**\n| 鹽湖            | 公司             | 產能 (ktpa LCE) |\n|-----------------|------------------|-----------------|\n| Olaroz          | Allkem           | ~42             |\n| Cauchari-Olaroz | Lithium Americas | ~40             |\n\n### 數據指標\n\n| 指標                 | 說明                  | 來源           |\n|----------------------|-----------------------|----------------|\n| Mine production      | 礦場產量（Li 或 SC6） | USGS, 公司報告 |\n| Capacity utilization | 產能利用率            | 公司報告       |\n| Cash cost            | 現金成本（USD/t LCE） | 公司報告       |\n| Export volume        | 出口量                | ABS, 海關數據  |\n\n---\n\n## 第二層：精煉 (Refining)\n\n### 產品類型\n\n| 產品            | 化學式   | 主要用途             |\n|-----------------|----------|----------------------|\n| 碳酸鋰 (Li₂CO₃) | Li₂CO₃   | LFP 電池、陶瓷、玻璃 |\n| 氫氧化鋰 (LiOH) | LiOH·H₂O | 高鎳 NMC/NCA 電池    |\n| 金屬鋰          | Li       | 航空、核能、特殊合金 |\n| 氯化鋰          | LiCl     | 空調、熔鹽           |\n\n### 生產路徑\n\n**硬岩路徑**\n```\n鋰輝石 (SC6) ──▶ 酸烘/熔煉 ──▶ 碳酸鋰/氫氧化鋰\n                     │\n                     └── 需要化學品（硫酸、石灰）\n```\n\n**鹵水路徑**\n```\n鹵水 ──▶ 蒸發濃縮 ──▶ 純化 ──▶ 碳酸鋰\n              │\n              └── 週期 12-18 個月\n```\n\n### 主要精煉產能\n\n| 國家   | 產能 (ktpa LCE) | 占比 |\n|--------|-----------------|------|\n| 中國   | ~600            | 60%  |\n| 智利   | ~200            | 20%  |\n| 阿根廷 | ~80             | 8%   |\n| 澳洲   | ~50             | 5%   |\n| 其他   | ~70             | 7%   |\n\n### 數據指標\n\n| 指標            | 說明     | 來源           |\n|-----------------|----------|----------------|\n| Refined output  | 精煉產量 | USGS, 公司報告 |\n| Conversion cost | 加工成本 | 公司報告       |\n| Grade/purity    | 純度規格 | 產品規格書     |\n\n---\n\n## 第三層：材料 (Materials)\n\n### 電池材料分類\n\n| 材料                     | 含鋰部分   | 鋰含量   |\n|--------------------------|------------|----------|\n| LFP 正極 (LiFePO₄)       | 磷酸鐵鋰   | ~4.4% Li |\n| NMC 正極 (LiNixMnyCozO2) | 鎳鈷錳酸鋰 | ~7% Li   |\n| NCA 正極 (LiNixCoyAlzO2) | 鎳鈷鋁酸鋰 | ~7% Li   |\n| LCO 正極 (LiCoO2)        | 鈷酸鋰     | ~7.1% Li |\n| 電解質 (LiPF6)           | 六氟磷酸鋰 | ~5% Li   |\n\n### 技術路線影響\n\n| 電池化學 | 鋰用量 (kg/kWh) | 趨勢        |\n|----------|-----------------|-------------|\n| NMC 111  | 0.14-0.16       | ↓ 下降      |\n| NMC 622  | 0.10-0.12       | → 持平      |\n| NMC 811  | 0.08-0.10       | ↑ 上升      |\n| LFP      | 0.05-0.08       | ↑↑ 快速上升 |\n| 固態電池 | TBD             | 未來        |\n\n**LFP vs NMC 市場份額演變**\n- 2020: LFP ~30%, NMC ~60%\n- 2023: LFP ~50%, NMC ~45%\n- 2025E: LFP ~55%, NMC ~40%\n\n### 數據指標\n\n| 指標               | 說明         | 來源      |\n|--------------------|--------------|-----------|\n| Cathode production | 正極材料產量 | 行業報告  |\n| Technology mix     | 技術路線占比 | IEA, BNEF |\n| Material cost      | 材料成本     | 行業報告  |\n\n---\n\n## 第四層：終端 (End Use)\n\n### 應用分類\n\n| 應用       | 2024 占比 | 增長率 |\n|------------|-----------|--------|\n| EV 電池    | ~75%      | 25-30% |\n| 儲能 (ESS) | ~10%      | 40-50% |\n| 消費電子   | ~8%       | 3-5%   |\n| 傳統工業   | ~7%       | 2-3%   |\n\n### EV 市場結構\n\n| 地區 | 2024 銷量 (M units) | 占比 |\n|------|---------------------|------|\n| 中國 | ~10                 | 55%  |\n| 歐洲 | ~3.5                | 20%  |\n| 美國 | ~1.8                | 10%  |\n| 其他 | ~2.7                | 15%  |\n\n### 儲能市場結構\n\n| 類型   | 2024 裝機 (GWh) | 增長率 |\n|--------|-----------------|--------|\n| 電網級 | ~100            | 50%    |\n| 工商業 | ~30             | 60%    |\n| 戶用   | ~20             | 40%    |\n\n### 數據指標\n\n| 指標               | 說明       | 來源           |\n|--------------------|------------|----------------|\n| EV sales           | EV 銷量    | IEA, 車企      |\n| Battery deployment | 電池裝機量 | IEA, BNEF      |\n| ESS installation   | 儲能裝機   | BNEF, 行業報告 |\n\n---\n\n## 供需平衡計算\n\n### 計算公式\n\n```python\ndef compute_supply_demand_balance(year):\n    \"\"\"\n    計算供需平衡\n    \"\"\"\n    # 供給側\n    supply = {\n        \"mine_production\": get_mine_production(year),  # kt Li\n        \"refined_output\": get_refined_output(year),    # kt LCE\n        \"recycling\": get_recycled_li(year),            # kt LCE\n    }\n\n    # 需求側\n    demand = {\n        \"ev_battery\": compute_ev_li_demand(year),      # kt LCE\n        \"ess\": compute_ess_li_demand(year),            # kt LCE\n        \"consumer_electronics\": get_ce_demand(year),   # kt LCE\n        \"industrial\": get_industrial_demand(year),     # kt LCE\n    }\n\n    total_supply = sum(supply.values())\n    total_demand = sum(demand.values())\n\n    balance = total_supply - total_demand\n\n    return {\n        \"supply\": total_supply,\n        \"demand\": total_demand,\n        \"balance\": balance,\n        \"balance_pct\": balance / total_demand * 100\n    }\n```\n\n### 供需平衡歷史\n\n| 年份  | 供給 (kt LCE) | 需求 (kt LCE) | 平衡 | 狀態   |\n|-------|---------------|---------------|------|--------|\n| 2020  | 440           | 420           | +20  | 過剩   |\n| 2021  | 540           | 560           | -20  | 缺口   |\n| 2022  | 690           | 750           | -60  | 缺口   |\n| 2023  | 950           | 880           | +70  | 過剩   |\n| 2024E | 1,100         | 1,050         | +50  | 微過剩 |\n| 2025E | 1,300         | 1,250         | +50  | 微過剩 |\n\n---\n\n## 價格傳導機制\n\n### 傳導路徑\n\n```\n鋰輝石價格 → 碳酸鋰價格 → 正極材料價格 → 電池成本 → EV/ESS 價格\n    │              │              │            │\n    └─ 即時 ─┐     └─ 1-3月 ─┐    └─ 1-2月 ─┐  └─ 3-6月\n             │              │             │\n             ▼              ▼             ▼\n         礦業股價      精煉商股價     電池商股價\n```\n\n### 價格敏感度\n\n| 環節         | 鋰價 +10% 影響 |\n|--------------|----------------|\n| 礦業毛利     | +15-25%        |\n| 精煉商毛利   | +8-12%         |\n| 正極材料成本 | +3-5%          |\n| 電池成本     | +1-2%          |\n| EV 價格      | +0.3-0.5%      |\n\n### 影響因素\n\n1. **合約期限**: 長單 vs 現貨比例\n2. **庫存水平**: 產業鏈庫存緩衝\n3. **議價能力**: 上下游博弈\n4. **替代性**: 技術路線轉換\n",
        "skills/lithium-supply-demand-gap-radar/references/unit-conversion.md": "# 鋰單位轉換參考\n\n鋰產業鏈中使用多種單位，混淆單位是最常見的分析錯誤之一。本文件提供標準轉換規則。\n\n---\n\n## 核心單位定義\n\n### Li (Lithium Metal Content)\n- 定義: 純鋰金屬含量\n- 用途: USGS 等機構的標準報告口徑\n- 符號: t Li, kt Li\n\n### LCE (Lithium Carbonate Equivalent)\n- 定義: 碳酸鋰當量，化學式 Li₂CO₃\n- 用途: 產業界最常用的統一口徑\n- 符號: t LCE, kt LCE\n- 鋰含量: 18.79% Li\n\n### LHE (Lithium Hydroxide Equivalent)\n- 定義: 氫氧化鋰當量，化學式 LiOH·H₂O\n- 用途: 電池級產品常用\n- 符號: t LHE\n- 鋰含量: 16.52% Li（一水合物）\n\n---\n\n## 轉換公式\n\n### Li ↔ LCE\n\n```python\n# Li → LCE\nLCE = Li * 5.323\n\n# LCE → Li\nLi = LCE / 5.323\n\n# 推導: Li₂CO₃ 分子量 73.89, Li 分子量 6.94\n# 73.89 / (6.94 * 2) = 5.323\n```\n\n**速算表**\n| Li (kt) | LCE (kt) |\n|---------|----------|\n| 10 | 53.23 |\n| 50 | 266.15 |\n| 100 | 532.3 |\n| 200 | 1,064.6 |\n\n---\n\n### Li ↔ LHE\n\n```python\n# Li → LHE (一水合物)\nLHE = Li * 6.048\n\n# LHE → Li\nLi = LHE / 6.048\n\n# 推導: LiOH·H₂O 分子量 41.96, Li 分子量 6.94\n# 41.96 / 6.94 = 6.048\n```\n\n---\n\n### LCE ↔ LHE\n\n```python\n# LCE → LHE\nLHE = LCE * 1.136\n\n# LHE → LCE\nLCE = LHE / 1.136\n\n# 推導: 6.048 / 5.323 = 1.136\n```\n\n---\n\n## 鋰輝石 (Spodumene) 轉換\n\n### Spodumene Concentrate (SC6)\n- 定義: 6% Li₂O 鋰輝石精礦\n- 用途: 澳洲礦場出口主要產品\n- 實際 Li₂O 含量: 5.5-7.0%\n\n```python\n# SC6 → LCE (假設 6% Li₂O)\nLCE = SC6_tonnes * 0.06 * 2.473 * (1 - moisture_loss)\n\n# 其中:\n# - 0.06 = 6% Li₂O 含量\n# - 2.473 = Li₂O 到 Li₂CO₃ 的轉換係數\n# - moisture_loss = 加工損失，通常 5-10%\n\n# 簡化（假設 8% 損失）:\nLCE ≈ SC6 * 0.136\n```\n\n**速算表**（SC6 @ 6% Li₂O, 8% 損失）\n| SC6 (kt) | LCE (kt) |\n|----------|----------|\n| 100 | 13.6 |\n| 500 | 68 |\n| 1,000 | 136 |\n| 5,000 | 680 |\n\n---\n\n## 電池需求轉換\n\n### GWh → kg Li\n\n電池到鋰需求的轉換取決於電池化學：\n\n| 電池類型 | kg Li / kWh | 說明 |\n|----------|-------------|------|\n| NMC 111 | 0.14-0.16 | 三元正極 |\n| NMC 532 | 0.12-0.14 | 改良三元 |\n| NMC 622 | 0.10-0.12 | 高鎳三元 |\n| NMC 811 | 0.08-0.10 | 超高鎳三元 |\n| NCA | 0.10-0.12 | 鎳鈷鋁 |\n| LFP | 0.05-0.08 | 磷酸鐵鋰（無鈷）|\n| LMO | 0.08-0.10 | 錳酸鋰 |\n\n**情境假設**\n\n```python\n# 保守估計（LFP 佔比上升）\nkg_per_kwh_conservative = 0.12\n\n# 中性估計（混合市場）\nkg_per_kwh_neutral = 0.15\n\n# 積極估計（高鎳主導）\nkg_per_kwh_aggressive = 0.18\n```\n\n**計算公式**\n\n```python\n# GWh → kt LCE\nli_demand_kt_lce = battery_gwh * kg_per_kwh * 5.323 / 1000\n\n# 例: 1000 GWh @ 0.15 kg/kWh\n# = 1000 * 0.15 * 5.323 / 1000 = 798.45 kt LCE\n```\n\n---\n\n## 價格單位轉換\n\n### 價格報價常見單位\n\n| 單位 | 說明 | 典型範圍 |\n|------|------|----------|\n| USD/t LCE | 碳酸鋰每噸 | 10,000 - 80,000 |\n| USD/kg LCE | 碳酸鋰每公斤 | 10 - 80 |\n| CNY/t | 中國人民幣每噸 | 70,000 - 600,000 |\n| USD/t SC6 | 鋰輝石每噸 | 1,000 - 6,000 |\n\n**轉換**\n\n```python\n# USD/t → USD/kg\nusd_per_kg = usd_per_t / 1000\n\n# CNY/t → USD/t (需匯率)\nusd_per_t = cny_per_t / exchange_rate\n\n# SC6 價格 → 隱含 LCE 價格\nimplied_lce = sc6_price / 0.136  # 大約\n```\n\n---\n\n## 常見錯誤與陷阱\n\n### 1. Li vs LCE 混淆\n\n**錯誤**: 「全球鋰產量 100 萬噸」\n**問題**: 是 Li 還是 LCE？差 5 倍！\n\n**正確表述**:\n- USGS 數據: 100 kt Li（鋰金屬含量）\n- 等於: 532 kt LCE\n\n### 2. Spodumene vs LCE 混淆\n\n**錯誤**: 「澳洲出口 500 萬噸鋰」\n**問題**: 是鋰輝石還是 LCE？\n\n**正確表述**:\n- 澳洲出口: 5,000 kt spodumene concentrate\n- 等於: ~680 kt LCE\n\n### 3. 電池容量 vs 鋰需求\n\n**錯誤**: 「1000 GWh 電池 = 1000 kt 鋰」\n**問題**: 完全錯誤的假設\n\n**正確計算**:\n- 1000 GWh × 0.15 kg/kWh = 150 kt Li\n- = 798 kt LCE\n\n### 4. 價格單位不一致\n\n**錯誤**: 比較 USD/kg 和 CNY/t 價格\n**問題**: 單位和幣種都不同\n\n**正確做法**:\n1. 統一為 USD/t 或 USD/kg\n2. 使用當日匯率\n3. 標註報價規格（CIF/FOB）\n\n---\n\n## 轉換函數模板\n\n```python\nclass LithiumUnitConverter:\n    \"\"\"鋰單位轉換工具\"\"\"\n\n    # 常數\n    LI_TO_LCE = 5.323\n    LI_TO_LHE = 6.048\n    LCE_TO_LHE = 1.136\n    SC6_TO_LCE = 0.136  # 假設 6% Li₂O, 8% 損失\n\n    @staticmethod\n    def li_to_lce(li_kt: float) -> float:\n        \"\"\"鋰金屬 → 碳酸鋰當量\"\"\"\n        return li_kt * LithiumUnitConverter.LI_TO_LCE\n\n    @staticmethod\n    def lce_to_li(lce_kt: float) -> float:\n        \"\"\"碳酸鋰當量 → 鋰金屬\"\"\"\n        return lce_kt / LithiumUnitConverter.LI_TO_LCE\n\n    @staticmethod\n    def sc6_to_lce(sc6_kt: float, li2o_pct: float = 6.0, loss_pct: float = 8.0) -> float:\n        \"\"\"鋰輝石精礦 → 碳酸鋰當量\"\"\"\n        effective = 1 - loss_pct / 100\n        return sc6_kt * (li2o_pct / 100) * 2.473 * effective\n\n    @staticmethod\n    def gwh_to_lce(gwh: float, kg_per_kwh: float = 0.15) -> float:\n        \"\"\"電池容量 → 碳酸鋰當量需求\"\"\"\n        li_kt = gwh * kg_per_kwh / 1000  # GWh → kt Li\n        return li_kt * LithiumUnitConverter.LI_TO_LCE\n\n    @staticmethod\n    def validate_unit(value: float, unit: str, context: str = \"\") -> dict:\n        \"\"\"驗證數值是否在合理範圍\"\"\"\n        ranges = {\n            \"kt_LCE\": (0, 5000),      # 全球年產量級\n            \"kt_Li\": (0, 1000),       # 全球年產量級\n            \"USD_per_t_LCE\": (5000, 100000),  # 價格範圍\n            \"GWh\": (0, 10000),        # 全球電池需求級\n        }\n\n        min_val, max_val = ranges.get(unit, (0, float(\"inf\")))\n        in_range = min_val <= value <= max_val\n\n        return {\n            \"value\": value,\n            \"unit\": unit,\n            \"in_range\": in_range,\n            \"expected_range\": f\"{min_val} - {max_val}\",\n            \"context\": context\n        }\n```\n\n---\n\n## 單位標註最佳實踐\n\n### 輸出格式\n\n每個數值都應包含單位標註：\n\n```json\n{\n  \"global_production_2024\": {\n    \"value\": 180,\n    \"unit\": \"kt_LCE\",\n    \"source\": \"USGS\",\n    \"original_unit\": \"kt_Li\",\n    \"conversion_applied\": true\n  }\n}\n```\n\n### 報告中的表述\n\n**推薦**:\n- 「全球鋰產量達 180 kt LCE（USGS 口徑：34 kt Li）」\n- 「電池需求 1,000 GWh，對應鋰需求約 150 kt Li（假設 0.15 kg/kWh）」\n\n**避免**:\n- 「全球鋰產量達 180 萬噸」（缺少單位說明）\n- 「鋰需求 1,000」（沒有單位，無法理解）\n",
        "skills/lithium-supply-demand-gap-radar/templates/output-json.md": "# JSON 輸出結構模板\n\n本文件定義 Skill 的標準 JSON 輸出結構。\n\n---\n\n## Full Analysis 輸出結構\n\n```json\n{\n  \"metadata\": {\n    \"skill\": \"lithium-supply-demand-gap-radar\",\n    \"version\": \"0.1.0\",\n    \"asof_date\": \"2026-01-16\",\n    \"etf_ticker\": \"LIT\",\n    \"data_level\": \"free_nolimit\",\n    \"generated_at\": \"2026-01-16T10:30:00Z\"\n  },\n\n  \"data_sources_used\": {\n    \"supply\": [\"USGS\", \"AU_REQ\", \"ABS\"],\n    \"demand\": [\"IEA\"],\n    \"price\": [\"CME_proxy\"],\n    \"etf\": [\"GlobalX\"]\n  },\n\n  \"balance_nowcast\": {\n    \"index\": {\n      \"conservative\": 0.65,\n      \"neutral\": 0.85,\n      \"aggressive\": 1.05\n    },\n    \"trend\": \"widening\",\n    \"inflection\": {\n      \"detected\": false,\n      \"type\": null\n    },\n    \"supply_summary\": {\n      \"latest_year\": 2024,\n      \"value\": 220,\n      \"unit\": \"kt_LCE\",\n      \"yoy_growth\": 22.2\n    },\n    \"demand_summary\": {\n      \"latest_year\": 2024,\n      \"scenarios\": {\n        \"conservative\": {\"value\": 180, \"kg_per_kwh\": 0.12},\n        \"neutral\": {\"value\": 200, \"kg_per_kwh\": 0.15},\n        \"aggressive\": {\"value\": 216, \"kg_per_kwh\": 0.18}\n      },\n      \"unit\": \"kt_LCE\"\n    }\n  },\n\n  \"price_regime\": {\n    \"carbonate\": {\n      \"regime\": \"bottoming\",\n      \"confidence\": 0.75,\n      \"indicators\": {\n        \"roc_12w\": -2.3,\n        \"roc_26w\": -8.5,\n        \"slope\": -0.12,\n        \"volatility\": 4.2,\n        \"mean_deviation\": -12\n      },\n      \"signal\": \"觀望，等待確認\"\n    },\n    \"hydroxide\": {\n      \"regime\": \"bottoming\",\n      \"confidence\": 0.75,\n      \"indicators\": {\n        \"roc_12w\": -3.1,\n        \"roc_26w\": -9.2,\n        \"slope\": -0.15,\n        \"volatility\": 4.8,\n        \"mean_deviation\": -14\n      },\n      \"signal\": \"觀望，等待確認\"\n    },\n    \"spread\": {\n      \"current\": 2500,\n      \"unit\": \"USD/t\",\n      \"percentile\": 45,\n      \"trend\": \"narrowing\"\n    },\n    \"sync_status\": \"synchronized\"\n  },\n\n  \"etf_exposure\": {\n    \"holdings_summary\": {\n      \"total_holdings\": 40,\n      \"asof_date\": \"2026-01-15\",\n      \"source\": \"GlobalX\"\n    },\n    \"segment_weights\": {\n      \"upstream\": 35.2,\n      \"midstream\": 18.5,\n      \"downstream\": 42.3,\n      \"unknown\": 4.0\n    },\n    \"beta_analysis\": {\n      \"current_beta_li\": 0.72,\n      \"current_beta_ev\": 0.58,\n      \"52w_avg_beta_li\": 0.68,\n      \"trend\": \"rising\"\n    },\n    \"transmission_status\": {\n      \"status\": \"normal\",\n      \"description\": \"傳導正常：近期平均 Beta = 0.72\"\n    },\n    \"top_holdings\": [\n      {\"rank\": 1, \"ticker\": \"ALB\", \"weight\": 8.2, \"segment\": \"upstream\", \"country\": \"US\"},\n      {\"rank\": 2, \"ticker\": \"TSLA\", \"weight\": 7.5, \"segment\": \"downstream\", \"country\": \"US\"},\n      {\"rank\": 3, \"ticker\": \"SQM\", \"weight\": 6.8, \"segment\": \"upstream\", \"country\": \"Chile\"}\n    ]\n  },\n\n  \"thesis\": {\n    \"direction\": \"neutral_bullish\",\n    \"confidence\": 0.70,\n    \"summary\": \"供需缺口擴大中，價格型態築底待確認，傳導正常\",\n    \"components\": {\n      \"balance_score\": 0.85,\n      \"regime_score\": 0.50,\n      \"transmission_score\": 0.72\n    }\n  },\n\n  \"targets\": {\n    \"support\": {\"level\": 38.50, \"type\": \"prior_low\"},\n    \"mid_channel\": {\"level\": 48.50, \"type\": \"ma_50w\"},\n    \"prior_high\": {\"level\": 56.20, \"type\": \"resistance\"},\n    \"upper_channel\": {\"level\": 68.00, \"type\": \"upper_band\"}\n  },\n\n  \"invalidation\": [\n    {\n      \"condition\": \"price < 38.50\",\n      \"description\": \"跌破關鍵支撐\",\n      \"severity\": \"high\"\n    },\n    {\n      \"condition\": \"balance_index < 0\",\n      \"description\": \"供需平衡轉負（過剩）\",\n      \"severity\": \"high\"\n    },\n    {\n      \"condition\": \"regime == downtrend\",\n      \"description\": \"價格型態再次轉弱\",\n      \"severity\": \"medium\"\n    },\n    {\n      \"condition\": \"beta_li < 0.3 for 8w\",\n      \"description\": \"傳導斷裂\",\n      \"severity\": \"medium\"\n    }\n  ],\n\n  \"catalysts\": [\n    {\n      \"event\": \"IEA Global EV Outlook 2026\",\n      \"expected_date\": \"2026-04\",\n      \"direction\": \"positive\",\n      \"impact\": \"medium\"\n    },\n    {\n      \"event\": \"Australia REQ Q1 2026\",\n      \"expected_date\": \"2026-03\",\n      \"direction\": \"neutral\",\n      \"impact\": \"low\"\n    }\n  ],\n\n  \"confidence_matrix\": {\n    \"overall\": 0.75,\n    \"by_component\": {\n      \"balance_nowcast\": 0.80,\n      \"price_regime\": 0.70,\n      \"etf_exposure\": 0.85\n    },\n    \"data_freshness\": {\n      \"supply_data\": \"2024-annual\",\n      \"demand_data\": \"2024-annual\",\n      \"price_data\": \"2026-01-16\",\n      \"holdings_data\": \"2026-01-15\"\n    }\n  }\n}\n```\n\n---\n\n## Balance Nowcast 輸出結構\n\n```json\n{\n  \"metadata\": {\n    \"skill\": \"lithium-supply-demand-gap-radar\",\n    \"workflow\": \"balance-nowcast\",\n    \"asof_date\": \"2026-01-16\"\n  },\n\n  \"balance_index\": {\n    \"conservative\": {\n      \"value\": 0.65,\n      \"trend\": \"widening\",\n      \"kg_per_kwh_assumption\": 0.12\n    },\n    \"neutral\": {\n      \"value\": 0.85,\n      \"trend\": \"widening\",\n      \"kg_per_kwh_assumption\": 0.15\n    },\n    \"aggressive\": {\n      \"value\": 1.05,\n      \"trend\": \"widening\",\n      \"kg_per_kwh_assumption\": 0.18\n    }\n  },\n\n  \"inflection\": {\n    \"detected\": false,\n    \"type\": null,\n    \"last_inflection\": {\n      \"date\": \"2023-06\",\n      \"type\": \"bearish\",\n      \"balance_index_at_time\": 1.2\n    }\n  },\n\n  \"supply\": {\n    \"world_production\": {\n      \"2020\": 82,\n      \"2021\": 107,\n      \"2022\": 130,\n      \"2023\": 180,\n      \"2024\": 220\n    },\n    \"unit\": \"kt_LCE\",\n    \"sources\": [\"USGS\", \"AU_REQ\"],\n    \"confidence\": 0.90\n  },\n\n  \"demand\": {\n    \"battery_gwh\": {\n      \"2020\": 150,\n      \"2021\": 330,\n      \"2022\": 550,\n      \"2023\": 750,\n      \"2024\": 1000\n    },\n    \"lithium_demand_kt\": {\n      \"conservative\": {\"2024\": 180},\n      \"neutral\": {\"2024\": 200},\n      \"aggressive\": {\"2024\": 216}\n    },\n    \"unit\": \"kt_LCE\",\n    \"sources\": [\"IEA\"],\n    \"confidence\": 0.85\n  },\n\n  \"interpretation\": \"需求增速持續高於供給增速，供需缺口擴大中。保守估計下缺口為負（過剩），但中性和積極估計均顯示缺口。\"\n}\n```\n\n---\n\n## Price Regime 輸出結構\n\n```json\n{\n  \"metadata\": {\n    \"skill\": \"lithium-supply-demand-gap-radar\",\n    \"workflow\": \"price-regime\",\n    \"asof_date\": \"2026-01-16\"\n  },\n\n  \"carbonate\": {\n    \"regime\": \"bottoming\",\n    \"confidence\": 0.75,\n    \"price_latest\": {\n      \"value\": 12500,\n      \"unit\": \"USD/t\",\n      \"source\": \"CME_proxy\"\n    },\n    \"indicators\": {\n      \"roc_12w\": {\"value\": -2.3, \"interpretation\": \"收斂中\"},\n      \"roc_26w\": {\"value\": -8.5, \"interpretation\": \"仍為負\"},\n      \"slope\": {\"value\": -0.12, \"interpretation\": \"趨緩\"},\n      \"volatility\": {\"value\": 4.2, \"interpretation\": \"下降\"},\n      \"mean_deviation\": {\"value\": -12, \"interpretation\": \"低於均線\"}\n    },\n    \"signal\": \"觀望，等待確認\",\n    \"confirmation_signals\": [\n      {\"signal\": \"12週動能轉正\", \"status\": \"pending\"},\n      {\"signal\": \"波動率擴大\", \"status\": \"pending\"},\n      {\"signal\": \"突破近期高點\", \"status\": \"pending\"}\n    ]\n  },\n\n  \"hydroxide\": {\n    \"regime\": \"bottoming\",\n    \"confidence\": 0.75,\n    \"price_latest\": {\n      \"value\": 15000,\n      \"unit\": \"USD/t\",\n      \"source\": \"CME_proxy\"\n    },\n    \"indicators\": {\n      \"roc_12w\": {\"value\": -3.1, \"interpretation\": \"收斂中\"},\n      \"roc_26w\": {\"value\": -9.2, \"interpretation\": \"仍為負\"},\n      \"slope\": {\"value\": -0.15, \"interpretation\": \"趨緩\"},\n      \"volatility\": {\"value\": 4.8, \"interpretation\": \"下降\"},\n      \"mean_deviation\": {\"value\": -14, \"interpretation\": \"低於均線\"}\n    },\n    \"signal\": \"觀望，等待確認\"\n  },\n\n  \"spread_analysis\": {\n    \"carbonate_hydroxide_spread\": {\n      \"current\": 2500,\n      \"unit\": \"USD/t\",\n      \"percentile_52w\": 45,\n      \"trend\": \"narrowing\"\n    },\n    \"interpretation\": \"氫氧化鋰溢價收窄，可能反映 LFP 需求上升\"\n  },\n\n  \"sync_status\": \"synchronized\",\n\n  \"cycle_position\": {\n    \"description\": \"DOWNTREND → [BOTTOMING] → UPTREND → OVERHEAT\",\n    \"current\": \"BOTTOMING\"\n  }\n}\n```\n\n---\n\n## ETF Exposure 輸出結構\n\n```json\n{\n  \"metadata\": {\n    \"skill\": \"lithium-supply-demand-gap-radar\",\n    \"workflow\": \"etf-exposure\",\n    \"asof_date\": \"2026-01-16\",\n    \"etf_ticker\": \"LIT\"\n  },\n\n  \"holdings\": {\n    \"total\": 40,\n    \"asof_date\": \"2026-01-15\",\n    \"source\": \"GlobalX\",\n    \"top_10\": [\n      {\"rank\": 1, \"ticker\": \"ALB\", \"name\": \"Albemarle Corp\", \"weight\": 8.2, \"segment\": \"upstream\", \"country\": \"US\"},\n      {\"rank\": 2, \"ticker\": \"TSLA\", \"name\": \"Tesla Inc\", \"weight\": 7.5, \"segment\": \"downstream\", \"country\": \"US\"},\n      {\"rank\": 3, \"ticker\": \"SQM\", \"name\": \"SQM\", \"weight\": 6.8, \"segment\": \"upstream\", \"country\": \"Chile\"},\n      {\"rank\": 4, \"ticker\": \"CATL\", \"name\": \"CATL\", \"weight\": 6.2, \"segment\": \"downstream\", \"country\": \"China\"},\n      {\"rank\": 5, \"ticker\": \"PLS.AX\", \"name\": \"Pilbara Minerals\", \"weight\": 5.5, \"segment\": \"upstream\", \"country\": \"Australia\"}\n    ]\n  },\n\n  \"segment_analysis\": {\n    \"weights\": {\n      \"upstream\": 35.2,\n      \"midstream\": 18.5,\n      \"downstream\": 42.3,\n      \"unknown\": 4.0\n    },\n    \"expected_beta_by_segment\": {\n      \"upstream\": 1.8,\n      \"midstream\": 1.0,\n      \"downstream\": 0.5\n    },\n    \"weighted_expected_beta\": 0.95\n  },\n\n  \"beta_analysis\": {\n    \"rolling_52w\": {\n      \"beta_li\": [0.65, 0.68, 0.71, 0.72],\n      \"beta_ev\": [0.52, 0.55, 0.57, 0.58],\n      \"dates\": [\"2025-10\", \"2025-11\", \"2025-12\", \"2026-01\"]\n    },\n    \"current\": {\n      \"beta_li\": 0.72,\n      \"beta_ev\": 0.58,\n      \"r_squared\": 0.45\n    },\n    \"52w_average\": {\n      \"beta_li\": 0.68,\n      \"beta_ev\": 0.55\n    },\n    \"trend\": \"rising\"\n  },\n\n  \"transmission\": {\n    \"status\": \"normal\",\n    \"description\": \"傳導正常：近期平均 Beta = 0.72\",\n    \"implication\": \"ETF 正常反映鋰價變動\",\n    \"threshold\": 0.3,\n    \"duration_below_threshold\": 0\n  }\n}\n```\n\n---\n\n## 通用欄位說明\n\n### 數據品質標記\n\n| 欄位         | 類型   | 說明             |\n|--------------|--------|------------------|\n| `confidence` | float  | 數據置信度 (0-1) |\n| `source`     | string | 數據來源         |\n| `asof_date`  | string | 數據截止日期     |\n| `data_level` | string | 數據等級         |\n\n### 判讀標記\n\n| 欄位             | 類型   | 說明         |\n|------------------|--------|--------------|\n| `trend`          | string | 趨勢方向     |\n| `signal`         | string | 交易信號     |\n| `interpretation` | string | 人類可讀解釋 |\n",
        "skills/lithium-supply-demand-gap-radar/templates/output-markdown.md": "# Markdown 輸出模板\n\n本文件定義 Skill 的標準 Markdown 報告格式。\n\n---\n\n## Full Analysis 報告模板\n\n```markdown\n# LIT（鋰產業鏈 ETF）供需×價格×傳導整合評估\n\n## 分析日期: {asof_date}\n## 數據等級: {data_level}\n\n---\n\n## 執行摘要\n\n{executive_summary}\n\n---\n\n## 1) 數據源摘要（本次使用）\n\n| 類型       | 來源             | 更新日期      | 置信度              |\n|------------|------------------|---------------|---------------------|\n| 供給基準   | {supply_sources} | {supply_date} | {supply_confidence} |\n| 需求 proxy | {demand_sources} | {demand_date} | {demand_confidence} |\n| 價格數據   | {price_sources}  | {price_date}  | {price_confidence}  |\n| ETF 暴露   | {etf_sources}    | {etf_date}    | {etf_confidence}    |\n\n**數據等級說明**: {data_level_description}\n\n---\n\n## 2) 供需平衡 Nowcast\n\n### Balance Index\n┌──────────┬───────────────┬────────────┬──────────────────┐\n│   情境   │ Balance Index │    趨勢    │    kg/kWh 假設   │\n├──────────┼───────────────┼────────────┼──────────────────┤\n│ 保守     │ {bi_cons}     │ {bi_trend} │ 0.12             │\n├──────────┼───────────────┼────────────┼──────────────────┤\n│ 中性     │ {bi_neut}     │ {bi_trend} │ 0.15             │\n├──────────┼───────────────┼────────────┼──────────────────┤\n│ 積極     │ {bi_aggr}     │ {bi_trend} │ 0.18             │\n└──────────┴───────────────┴────────────┴──────────────────┘\n\n### 拐點判斷\n- 是否出現拐點：{inflection_detected}\n- 類型：{inflection_type}\n\n### 供需摘要\n\n**供給側**\n┌──────┬──────────────┬────────────┐\n│ 年份 │ 產量 (kt LCE)│ YoY 增長   │\n├──────┼──────────────┼────────────┤\n{supply_table}\n└──────┴──────────────┴────────────┘\n\n**需求側**\n┌──────┬────────────┬──────────────┬────────────────┐\n│ 年份 │ 電池需求GWh│ 鋰需求(kt)   │ 假設 kg/kWh    │\n├──────┼────────────┼──────────────┼────────────────┤\n{demand_table}\n└──────┴────────────┴──────────────┴────────────────┘\n\n---\n\n## 3) 價格型態（Regime）\n\n### 碳酸鋰 (Lithium Carbonate)\n\n┌────────────────┬────────────┬──────────────────┐\n│      指標      │   當前值   │       判讀       │\n├────────────────┼────────────┼──────────────────┤\n│ 12週動能 (ROC) │ {roc_12w}% │ {roc_12w_interp} │\n├────────────────┼────────────┼──────────────────┤\n│ 26週動能 (ROC) │ {roc_26w}% │ {roc_26w_interp} │\n├────────────────┼────────────┼──────────────────┤\n│ 趨勢斜率       │ {slope}    │ {slope_interp}   │\n├────────────────┼────────────┼──────────────────┤\n│ 波動率 (ATR%)  │ {vol}%     │ {vol_interp}     │\n├────────────────┼────────────┼──────────────────┤\n│ 均值偏離度     │ {dev}%     │ {dev_interp}     │\n└────────────────┴────────────┴──────────────────┘\n\n**型態判定**: {carbonate_regime_emoji} {carbonate_regime}\n\n### 氫氧化鋰 (Lithium Hydroxide)\n\n**型態判定**: {hydroxide_regime_emoji} {hydroxide_regime}\n\n### 週期位置\n\n```\nDOWNTREND → [{current_regime}] → UPTREND → OVERHEAT\n                 ↑\n             目前位置\n```\n\n### 確認訊號\n\n| 訊號 | 狀態 | 重要性 |\n|------|------|--------|\n{confirmation_signals_table}\n\n---\n\n## 4) 鋰→股票→ETF 傳導\n\n### ETF 持股結構\n\n**產業鏈段分布**\n┌──────────────────┬────────────┬────────────────┐\n│     產業鏈段     │    權重    │ 預期鋰價 Beta  │\n├──────────────────┼────────────┼────────────────┤\n│ Upstream (礦業)  │ {up_wt}%   │ 1.5-2.5        │\n├──────────────────┼────────────┼────────────────┤\n│ Midstream (精煉) │ {mid_wt}%  │ 0.8-1.2        │\n├──────────────────┼────────────┼────────────────┤\n│ Downstream (電池)│ {down_wt}% │ 0.3-0.8        │\n└──────────────────┴────────────┴────────────────┘\n\n**前 5 大持股**\n┌──────┬────────┬────────────┬────────────┬────────┐\n│ 排名 │  股票  │   權重     │  產業鏈段  │  國家  │\n├──────┼────────┼────────────┼────────────┼────────┤\n{top_holdings_table}\n└──────┴────────┴────────────┴────────────┴────────┘\n\n### Beta 分析\n\n| 因子       | 當前 Beta | 52週平均      | 趨勢            |\n|------------|-----------|---------------|-----------------|\n| 鋰價因子   | {beta_li} | {beta_li_avg} | {beta_li_trend} |\n| EV需求因子 | {beta_ev} | {beta_ev_avg} | {beta_ev_trend} |\n\n### 傳導狀態\n\n- **狀態**: {transmission_status_emoji} {transmission_status}\n- **依據**: {transmission_description}\n- **含義**: {transmission_implication}\n\n---\n\n## 5) 結論與路徑\n\n### Thesis（投資論述）\n\n| 項目     | 判斷                  | 依據                        |\n|----------|-----------------------|-----------------------------|\n| 供需面   | {balance_thesis}      | Balance Index = {bi_neut}   |\n| 價格面   | {price_thesis}        | Regime = {carbonate_regime} |\n| 傳導面   | {transmission_thesis} | Beta = {beta_li}            |\n| **綜合** | **{overall_thesis}**  | 置信度 {confidence}%        |\n\n### 目標路徑\n\n```\n當前: ${current_price}\n          │\n          ├─── 支撐: ${support} (關鍵支撐)\n          │\n          ├─── 中軌: ${mid_channel} (50週均線)\n          │\n          ├─── 前高: ${prior_high} (阻力位)\n          │\n          └─── 上軌: ${upper_channel} (上升通道頂部)\n```\n\n### 失效條件\n\n| 條件 | 描述 | 嚴重度 |\n|------|------|--------|\n{invalidation_table}\n\n---\n\n## 6) 催化劑地圖\n\n| 事件 | 預期時間 | 方向 | 影響程度 |\n|------|----------|------|----------|\n{catalysts_table}\n\n---\n\n## 7) 風險提示\n\n{risk_warnings}\n\n---\n\n## 數據來源追溯\n\n┌───────────────────────────────────────────┬──────┬────────┬──────────┐\n│                   來源                    │ Tier │ 置信度 │   說明   │\n├───────────────────────────────────────────┼──────┼────────┼──────────┤\n{data_sources_table}\n└───────────────────────────────────────────┴──────┴────────┴──────────┘\n\n---\n\n## 報告生成資訊\n\n- 生成時間: {generated_at}\n- Skill 版本: {skill_version}\n- 數據等級: {data_level}\n```\n\n---\n\n## Balance Nowcast 報告模板\n\n```markdown\n# 鋰供需平衡 Nowcast 報告\n\n## 分析日期: {asof_date}\n## 數據來源: {data_sources}\n\n---\n\n## Balance Index\n\n┌──────────┬───────────────┬────────────┬──────────────────┐\n│   情境   │ Balance Index │    趨勢    │    kg/kWh 假設   │\n├──────────┼───────────────┼────────────┼──────────────────┤\n│ 保守     │ {bi_cons}     │ {bi_trend} │ 0.12 (LFP 主導)  │\n├──────────┼───────────────┼────────────┼──────────────────┤\n│ 中性     │ {bi_neut}     │ {bi_trend} │ 0.15 (混合市場)  │\n├──────────┼───────────────┼────────────┼──────────────────┤\n│ 積極     │ {bi_aggr}     │ {bi_trend} │ 0.18 (高鎳主導)  │\n└──────────┴───────────────┴────────────┴──────────────────┘\n\n**判讀**: {balance_interpretation}\n\n---\n\n## 供給側\n\n### 全球產量趨勢\n\n{supply_trend_chart_placeholder}\n\n### 產量數據\n\n┌──────┬──────────────┬────────────┐\n│ 年份 │ 產量 (kt LCE)│ YoY 增長   │\n├──────┼──────────────┼────────────┤\n{supply_table}\n└──────┴──────────────┴────────────┘\n\n### 供給側關鍵發現\n\n{supply_findings}\n\n---\n\n## 需求側\n\n### 電池需求趨勢\n\n{demand_trend_chart_placeholder}\n\n### 需求數據\n\n┌──────┬────────────┬──────────────┬────────────────┐\n│ 年份 │ 電池需求GWh│ 鋰需求(kt)   │ 假設 kg/kWh    │\n├──────┼────────────┼──────────────┼────────────────┤\n{demand_table}\n└──────┴────────────┴──────────────┴────────────────┘\n\n### 需求側關鍵發現\n\n{demand_findings}\n\n---\n\n## 拐點分析\n\n- 是否出現拐點：{inflection_detected}\n- 類型：{inflection_type}\n- 上次拐點：{last_inflection}\n- 判斷依據：{inflection_rationale}\n\n---\n\n## 數據來源\n\n| 指標 | 來源 | 更新頻率 | 置信度 |\n|------|------|----------|--------|\n{data_sources_table}\n```\n\n---\n\n## 表情符號對照\n\n| 狀態      | 符號  |\n|-----------|-------|\n| 上行/做多 | 📈 🟢 |\n| 下行/避險 | 📉 🔴 |\n| 築底/觀望 | ⏸️ 🟡  |\n| 過熱/警戒 | ⚠️ 🟠  |\n| 正常      | ✅     |\n| 警告      | ⚠️     |\n| 錯誤      | ❌     |\n\n---\n\n## 格式指南\n\n### ASCII 表格\n\n使用 Box Drawing 字符保證跨平台顯示：\n\n```\n┌─────┬─────┬─────┐  頂部\n│     │     │     │  內容\n├─────┼─────┼─────┤  分隔\n│     │     │     │  內容\n└─────┴─────┴─────┘  底部\n```\n\n### 數值格式\n\n| 類型   | 格式            | 範例   |\n|--------|-----------------|--------|\n| 百分比 | 1 位小數 + %    | 12.5%  |\n| 價格   | 整數或 2 位小數 | $48.50 |\n| Beta   | 2 位小數        | 0.72   |\n| 產量   | 整數 + 單位     | 220 kt |\n\n### 日期格式\n\n| 用途     | 格式       | 範例       |\n|----------|------------|------------|\n| 報告日期 | YYYY-MM-DD | 2026-01-16 |\n| 年度數據 | YYYY       | 2024       |\n| 季度數據 | YYYY-QN    | 2025-Q4    |\n| 月度數據 | YYYY-MM    | 2026-01    |\n",
        "skills/lithium-supply-demand-gap-radar/workflows/balance-nowcast.md": "# Workflow: Balance Nowcast（供需平衡即時估計）\n\n<required_reading>\n**Read these reference files NOW:**\n1. references/data-sources.md\n2. references/supply-chain-mapping.md\n3. references/unit-conversion.md\n</required_reading>\n\n<process>\n## Step 1: Load Supply Data\n\n從各來源載入供給數據：\n\n### 1.1 USGS（年度基準）\n\n```python\nusgs_data = load_usgs_lithium()\n\n# 產出結構\n# {\n#   \"world_production\": {2020: 82, 2021: 107, 2022: 130, 2023: 180, 2024: 220},  # kt LCE\n#   \"by_country\": {\n#     \"Australia\": {...},\n#     \"Chile\": {...},\n#     \"China\": {...},\n#     \"Argentina\": {...}\n#   },\n#   \"unit\": \"kt_LCE\",\n#   \"source_id\": \"USGS\",\n#   \"confidence\": 0.95\n# }\n```\n\n### 1.2 Australia REQ（季度展望）\n\n```python\naus_req = load_australia_req()\n\n# 產出結構\n# {\n#   \"lithium_exports\": {...},  # 出口量/金額\n#   \"production_outlook\": {...},  # 產量展望\n#   \"quarterly_update\": \"2025-Q4\",\n#   \"source_id\": \"AU_REQ\",\n#   \"confidence\": 0.90\n# }\n```\n\n### 1.3 ABS Exports（出口統計）\n\n```python\nabs_exports = load_abs_lithium_exports()\n\n# 產出結構\n# {\n#   \"export_value_aud\": {...},  # 出口金額\n#   \"export_volume\": {...},  # 出口量（如可得）\n#   \"monthly\": True,\n#   \"source_id\": \"ABS\",\n#   \"confidence\": 0.90\n# }\n```\n\n## Step 2: Load Demand Data\n\n### 2.1 IEA EV/Battery Demand\n\n```python\niea_data = load_iea_ev_outlook()\n\n# 產出結構\n# {\n#   \"ev_sales\": {2020: 3.1, 2021: 6.5, 2022: 10.6, 2023: 14.2, 2024: 17.5},  # million units\n#   \"battery_demand_gwh\": {2020: 150, 2021: 330, 2022: 550, 2023: 750, 2024: 1000},\n#   \"lithium_demand_by_battery\": {...},  # IEA 自己的估計（如有）\n#   \"source_id\": \"IEA\",\n#   \"confidence\": 0.90\n# }\n```\n\n## Step 3: Build Supply Proxy\n\n整合供給數據成單一 proxy：\n\n```python\ndef blend_supply(usgs, aus_req, abs_exports):\n    \"\"\"\n    策略：\n    1. 以 USGS 年度數據為基準\n    2. 用 AUS REQ 季度更新調整當年估計\n    3. 用 ABS 月度出口驗證趨勢\n    \"\"\"\n\n    # 年度基準\n    supply_annual = usgs[\"world_production\"]\n\n    # 季度調整（如果 REQ 有更新預測）\n    if aus_req[\"quarterly_update\"] >= current_quarter:\n        supply_annual = adjust_with_req(supply_annual, aus_req)\n\n    # 趨勢驗證（用出口數據）\n    trend_confirmation = validate_with_exports(supply_annual, abs_exports)\n\n    return {\n        \"values\": supply_annual,\n        \"unit\": \"kt_LCE\",\n        \"trend\": trend_confirmation,\n        \"confidence\": min(usgs[\"confidence\"], aus_req[\"confidence\"])\n    }\n```\n\n## Step 4: Build Demand Proxy\n\n將電池需求轉換為鋰需求（三情境）：\n\n```python\ndef build_demand_proxy(iea_data, kg_per_kwh_scenarios=[0.12, 0.15, 0.18]):\n    \"\"\"\n    轉換公式: Li demand (kt) = Battery (GWh) × kg/kWh\n    \"\"\"\n\n    battery_gwh = iea_data[\"battery_demand_gwh\"]\n\n    demand_scenarios = {}\n    for i, kg_kwh in enumerate(kg_per_kwh_scenarios):\n        scenario_name = [\"conservative\", \"neutral\", \"aggressive\"][i]\n        demand_scenarios[scenario_name] = {\n            year: gwh * kg_kwh for year, gwh in battery_gwh.items()\n        }\n\n    return {\n        \"scenarios\": demand_scenarios,\n        \"unit\": \"kt_LCE\",\n        \"assumptions\": {\n            \"conservative\": {\"kg_per_kwh\": 0.12, \"rationale\": \"LFP 佔比上升\"},\n            \"neutral\": {\"kg_per_kwh\": 0.15, \"rationale\": \"混合 NMC/LFP\"},\n            \"aggressive\": {\"kg_per_kwh\": 0.18, \"rationale\": \"高鎳 NMC 主導\"}\n        },\n        \"source_id\": \"IEA_derived\",\n        \"confidence\": 0.85\n    }\n```\n\n## Step 5: Compute Balance Index\n\n```python\ndef compute_balance_index(supply_proxy, demand_proxy):\n    \"\"\"\n    Balance Index = zscore(demand - supply)\n\n    解讀：\n    - > 0: 需求 > 供給，缺口擴大\n    - < 0: 供給 > 需求，過剩\n    - 趨勢變化比絕對值更重要\n    \"\"\"\n\n    results = {}\n    for scenario in [\"conservative\", \"neutral\", \"aggressive\"]:\n        demand = demand_proxy[\"scenarios\"][scenario]\n        supply = supply_proxy[\"values\"]\n\n        # 計算年度缺口\n        gap = {year: demand.get(year, 0) - supply.get(year, 0)\n               for year in set(demand.keys()) | set(supply.keys())}\n\n        # Z-score 標準化\n        gap_values = list(gap.values())\n        zscore = (gap_values[-1] - np.mean(gap_values)) / np.std(gap_values)\n\n        results[scenario] = {\n            \"balance_index\": zscore,\n            \"raw_gap_kt\": gap,\n            \"latest_year\": max(gap.keys()),\n            \"trend\": \"widening\" if zscore > 0 else \"narrowing\"\n        }\n\n    return results\n```\n\n## Step 6: Assess Inflection Points\n\n判斷是否出現拐點：\n\n```python\ndef detect_inflection(balance_index_history):\n    \"\"\"\n    拐點判斷條件：\n    1. 連續 3 期同方向後反轉\n    2. 變化幅度超過 0.5 標準差\n    \"\"\"\n\n    # 檢查方向變化\n    recent = balance_index_history[-4:]\n\n    if len(recent) < 4:\n        return {\"inflection\": False, \"reason\": \"數據不足\"}\n\n    prev_direction = np.sign(recent[-2] - recent[-3])\n    curr_direction = np.sign(recent[-1] - recent[-2])\n\n    if prev_direction != curr_direction and abs(recent[-1] - recent[-2]) > 0.5:\n        return {\n            \"inflection\": True,\n            \"type\": \"bullish\" if curr_direction > 0 else \"bearish\",\n            \"magnitude\": abs(recent[-1] - recent[-2])\n        }\n\n    return {\"inflection\": False, \"reason\": \"無明顯反轉\"}\n```\n\n## Step 7: Format Output\n\n```python\ndef format_balance_report(balance_results, inflection, supply_proxy, demand_proxy):\n    return {\n        \"asof_date\": date.today().isoformat(),\n        \"balance_index\": {\n            \"conservative\": balance_results[\"conservative\"][\"balance_index\"],\n            \"neutral\": balance_results[\"neutral\"][\"balance_index\"],\n            \"aggressive\": balance_results[\"aggressive\"][\"balance_index\"]\n        },\n        \"trend\": balance_results[\"neutral\"][\"trend\"],\n        \"inflection\": inflection,\n        \"supply_summary\": {\n            \"latest_value\": supply_proxy[\"values\"][max(supply_proxy[\"values\"].keys())],\n            \"unit\": supply_proxy[\"unit\"],\n            \"sources\": [\"USGS\", \"AU_REQ\", \"ABS\"]\n        },\n        \"demand_summary\": {\n            \"scenarios\": demand_proxy[\"assumptions\"],\n            \"sources\": [\"IEA\"]\n        },\n        \"interpretation\": generate_interpretation(balance_results, inflection)\n    }\n```\n\n## Step 8: Generate Inflection Point Chart\n\n**強制執行**：每次 Balance Nowcast 都必須生成拐點分析視覺化圖表\n\n```python\n# 生成拐點分析圖表\nfrom scripts.inflection_point_chart import generate_inflection_point_chart\n\nchart_path = generate_inflection_point_chart(\n    output_dir='output',\n    asof_date=date.today().strftime(\"%Y-%m-%d\")\n)\n\n# 輸出檔案：output/lithium_inflection_analysis_YYYY-MM-DD.png\n```\n\n**圖表內容**：\n1. 供需平衡指數演變（2020-2027）\n   - 歷史數據（實線）\n   - 未來預測（虛線，含三情境區間）\n2. 碳酸鋰價格走勢\n   - 歷史價格\n   - 預測價格\n3. 關鍵拐點標註\n   - 歷史拐點：2023Q2（供給反超需求）\n   - 預期拐點：2026Q4（中性情境）\n   - 當前位置\n4. 市場階段背景色塊\n   - 綠色：需求缺口期（2020-2023Q2）\n   - 紅色：供給過剩期（2023Q2-2025Q4）\n   - 黃色：預期反彈期（2026Q3+）\n5. 關鍵催化劑時間軸\n   - IEA EV Outlook、澳洲REQ更新等\n\n**技術規格**：\n- 解析度：300 DPI\n- 格式：PNG\n- 尺寸：16\" × 12\"\n- 中文支持：自動配置中文字體\n- 檔名格式：`lithium_inflection_analysis_YYYY-MM-DD.png`\n</process>\n\n<output_template>\n**Markdown 輸出：**\n\n```markdown\n# 鋰供需平衡 Nowcast 報告\n\n## 分析日期: [YYYY-MM-DD]\n## 數據來源: USGS + IEA + Australia REQ/ABS\n\n---\n## Balance Index\n\n| 情境 | Balance Index | 判讀 |\n|------|---------------|------|\n| 保守 | [值] | [缺口擴大/縮小] |\n| 中性 | [值] | [缺口擴大/縮小] |\n| 積極 | [值] | [缺口擴大/縮小] |\n\n## 拐點判斷\n- 是否出現拐點：[是/否]\n- 類型：[bullish/bearish/none]\n- 依據：[說明]\n\n## 供給側摘要\n| 年份 | 全球產量 (kt LCE) | YoY |\n|------|-------------------|-----|\n| ... | ... | ... |\n\n## 需求側摘要\n| 年份 | 電池需求 (GWh) | 鋰需求 (kt) | 假設 |\n|------|----------------|-------------|------|\n| ... | ... | ... | ... |\n\n## 關鍵發現\n1. [發現1]\n2. [發現2]\n3. [發現3]\n\n## 數據來源\n| 指標 | 來源 | 更新頻率 | 置信度 |\n|------|------|----------|--------|\n| ... | ... | ... | ... |\n```\n</output_template>\n\n<success_criteria>\n此工作流程完成時：\n- [ ] 供給數據從至少兩個來源整合\n- [ ] 需求 proxy 輸出三個情境\n- [ ] Balance Index 計算正確\n- [ ] 拐點判斷有明確條件\n- [ ] 單位轉換假設已標註\n- [ ] 數據來源可追溯\n</success_criteria>\n",
        "skills/lithium-supply-demand-gap-radar/workflows/etf-exposure.md": "# Workflow: ETF Exposure（ETF 持股暴露與傳導分析）\n\n<required_reading>\n**Read these reference files NOW:**\n1. references/data-sources.md\n2. references/etf-holdings-structure.md\n3. references/failure-modes.md\n</required_reading>\n\n<process>\n## Step 1: Load ETF Data\n\n### 1.1 Price Data\n\n```python\ndef load_etf_price(ticker, years, freq):\n    \"\"\"\n    使用 yfinance 載入 ETF 價格\n    \"\"\"\n    import yfinance as yf\n\n    etf = yf.Ticker(ticker)\n\n    # 計算起始日期\n    end_date = datetime.now()\n    start_date = end_date - timedelta(days=years * 365)\n\n    # 下載數據\n    df = etf.history(start=start_date, end=end_date, interval=\"1wk\" if freq == \"weekly\" else \"1d\")\n\n    # 計算收益率\n    df[\"returns\"] = df[\"Close\"].pct_change()\n\n    return {\n        \"prices\": df[\"Close\"].to_dict(),\n        \"returns\": df[\"returns\"].to_dict(),\n        \"ticker\": ticker,\n        \"freq\": freq\n    }\n```\n\n### 1.2 Holdings Data\n\n```python\ndef load_etf_holdings(ticker=\"LIT\"):\n    \"\"\"\n    從 Global X factsheet 或 ETF 官網載入持股\n\n    來源：https://www.globalxetfs.com/funds/lit/\n    \"\"\"\n\n    # 嘗試從官網 API 或 factsheet 抓取\n    holdings = fetch_holdings_from_globalx(ticker)\n\n    # 如果失敗，使用靜態備份\n    if not holdings:\n        holdings = load_static_holdings_backup(ticker)\n\n    # 分類持股\n    classified = classify_holdings(holdings)\n\n    return {\n        \"holdings\": classified,\n        \"asof_date\": holdings.get(\"asof_date\", \"static\"),\n        \"source\": \"GlobalX\" if holdings else \"StaticBackup\"\n    }\n\ndef classify_holdings(holdings):\n    \"\"\"\n    將持股分類為 upstream/midstream/downstream\n    \"\"\"\n\n    segment_mapping = {\n        # Upstream (礦業)\n        \"ALB\": \"upstream\",      # Albemarle\n        \"SQM\": \"upstream\",      # SQM\n        \"PLS.AX\": \"upstream\",   # Pilbara Minerals\n        \"MIN.AX\": \"upstream\",   # Mineral Resources\n        \"IGO.AX\": \"upstream\",   # IGO Limited\n        \"LAC\": \"upstream\",      # Lithium Americas\n\n        # Midstream (精煉/化學)\n        \"LTHM\": \"midstream\",    # Livent (現 Arcadium)\n        \"GANF.PA\": \"midstream\", # Ganfeng (if listed)\n\n        # Downstream (電池/材料)\n        \"TSLA\": \"downstream\",   # Tesla\n        \"CATL\": \"downstream\",   # CATL (if accessible)\n        \"PANW\": \"downstream\",   # Panasonic\n        \"LG\": \"downstream\",     # LG Energy\n        \"BYD\": \"downstream\",    # BYD\n        \"SSNLF\": \"downstream\",  # Samsung SDI\n    }\n\n    for holding in holdings[\"list\"]:\n        ticker = holding[\"ticker\"]\n        holding[\"segment\"] = segment_mapping.get(ticker, \"unknown\")\n\n    return holdings\n```\n\n## Step 2: Compute Segment Weights\n\n```python\ndef compute_segment_weights(holdings):\n    \"\"\"\n    計算各產業鏈段的權重\n    \"\"\"\n\n    segments = {\"upstream\": 0, \"midstream\": 0, \"downstream\": 0, \"unknown\": 0}\n\n    for holding in holdings[\"list\"]:\n        segment = holding[\"segment\"]\n        weight = holding[\"weight\"]\n        segments[segment] += weight\n\n    return {\n        \"weights\": segments,\n        \"dominant_segment\": max(segments, key=segments.get),\n        \"upstream_pct\": segments[\"upstream\"],\n        \"midstream_pct\": segments[\"midstream\"],\n        \"downstream_pct\": segments[\"downstream\"]\n    }\n```\n\n## Step 3: Build Factor Data\n\n### 3.1 Lithium Price Factor\n\n```python\ndef build_lithium_factor(chem_focus, data_level):\n    \"\"\"\n    建立鋰價因子（用於回歸）\n    \"\"\"\n\n    # 載入價格數據\n    li_price = load_lithium_price(chem_focus, data_level)\n\n    # 計算收益率\n    li_returns = compute_returns(li_price, freq=\"weekly\")\n\n    return {\n        \"factor_name\": \"lithium_price\",\n        \"returns\": li_returns,\n        \"source\": li_price[\"source\"]\n    }\n```\n\n### 3.2 Demand Proxy Factor\n\n```python\ndef build_demand_factor():\n    \"\"\"\n    建立需求因子（EV 相關指數或代理）\n    \"\"\"\n\n    # 使用 EV 相關 ETF 作為代理\n    ev_proxy = load_price(\"DRIV\", years=10, freq=\"weekly\")  # Global X Autonomous & Electric Vehicles ETF\n\n    # 或使用 Tesla 作為代理\n    tsla_proxy = load_price(\"TSLA\", years=10, freq=\"weekly\")\n\n    return {\n        \"factor_name\": \"ev_demand\",\n        \"returns\": ev_proxy[\"returns\"],\n        \"source\": \"DRIV_ETF\"\n    }\n```\n\n## Step 4: Rolling Beta Regression\n\n```python\ndef rolling_multifactor_beta(etf_returns, factors, window=52):\n    \"\"\"\n    滾動多因子回歸計算 beta\n\n    Model: ETF_ret = alpha + beta_li * Li_ret + beta_ev * EV_ret + epsilon\n    \"\"\"\n    import statsmodels.api as sm\n\n    # 對齊數據\n    aligned = align_all_series(etf_returns, factors)\n\n    results = []\n    dates = list(aligned.index)\n\n    for i in range(window, len(dates)):\n        window_data = aligned.iloc[i-window:i]\n\n        y = window_data[\"etf_returns\"]\n        X = window_data[[\"li_returns\", \"ev_returns\"]]\n        X = sm.add_constant(X)\n\n        model = sm.OLS(y, X).fit()\n\n        results.append({\n            \"date\": dates[i],\n            \"beta_li\": model.params.get(\"li_returns\", 0),\n            \"beta_ev\": model.params.get(\"ev_returns\", 0),\n            \"alpha\": model.params.get(\"const\", 0),\n            \"r_squared\": model.rsquared\n        })\n\n    return pd.DataFrame(results)\n```\n\n## Step 5: Compute Weighted Beta\n\n```python\ndef compute_weighted_etf_beta(holdings, stock_betas):\n    \"\"\"\n    計算持股加權 beta\n\n    ETF_beta_li = Σ(weight_i * beta_i_to_lithium)\n    \"\"\"\n\n    weighted_beta = 0\n\n    for holding in holdings[\"list\"]:\n        ticker = holding[\"ticker\"]\n        weight = holding[\"weight\"]\n\n        # 取得個股對鋰價的 beta\n        beta = stock_betas.get(ticker, {}).get(\"beta_li\", estimate_beta_by_segment(holding[\"segment\"]))\n\n        weighted_beta += weight * beta\n\n    return {\n        \"weighted_beta_li\": weighted_beta,\n        \"methodology\": \"holdings_weighted\",\n        \"coverage\": sum(1 for h in holdings[\"list\"] if h[\"ticker\"] in stock_betas) / len(holdings[\"list\"])\n    }\n\ndef estimate_beta_by_segment(segment):\n    \"\"\"\n    按產業鏈段估計 beta（如無實際數據）\n    \"\"\"\n\n    segment_betas = {\n        \"upstream\": 1.8,    # 礦業高 beta\n        \"midstream\": 1.0,   # 精煉中等\n        \"downstream\": 0.5,  # 電池低 beta\n        \"unknown\": 0.8\n    }\n\n    return segment_betas.get(segment, 0.8)\n```\n\n## Step 6: Assess Transmission Status\n\n```python\ndef assess_transmission(beta_history, threshold=0.3, duration=8):\n    \"\"\"\n    判斷傳導狀態\n\n    斷裂條件：beta < threshold 持續 > duration 週\n    \"\"\"\n\n    recent_betas = beta_history[\"beta_li\"].tail(duration).tolist()\n\n    if all(b < threshold for b in recent_betas):\n        return {\n            \"status\": \"broken\",\n            \"description\": f\"傳導斷裂：Beta 低於 {threshold} 已持續 {duration} 週\",\n            \"implication\": \"ETF 與鋰價脫鉤，需關注個股特殊因素\"\n        }\n\n    avg_beta = np.mean(recent_betas)\n\n    if avg_beta < 0.5:\n        return {\n            \"status\": \"weakening\",\n            \"description\": f\"傳導減弱：近期平均 Beta = {avg_beta:.2f}\",\n            \"implication\": \"傳導效率下降，可能受其他因素主導\"\n        }\n\n    return {\n        \"status\": \"normal\",\n        \"description\": f\"傳導正常：近期平均 Beta = {avg_beta:.2f}\",\n        \"implication\": \"ETF 正常反映鋰價變動\"\n    }\n```\n\n## Step 7: Format Output\n\n```python\ndef format_exposure_report(holdings, segment_weights, beta_results, transmission):\n    return {\n        \"asof_date\": date.today().isoformat(),\n        \"etf_ticker\": \"LIT\",\n        \"holdings_summary\": {\n            \"total_holdings\": len(holdings[\"list\"]),\n            \"top_10\": holdings[\"list\"][:10],\n            \"segment_weights\": segment_weights\n        },\n        \"beta_analysis\": {\n            \"current_beta_li\": beta_results[\"beta_li\"].iloc[-1],\n            \"current_beta_ev\": beta_results[\"beta_ev\"].iloc[-1],\n            \"52w_avg_beta_li\": beta_results[\"beta_li\"].mean(),\n            \"trend\": \"rising\" if beta_results[\"beta_li\"].iloc[-1] > beta_results[\"beta_li\"].iloc[-13] else \"falling\"\n        },\n        \"transmission_status\": transmission,\n        \"interpretation\": generate_exposure_interpretation(segment_weights, beta_results, transmission)\n    }\n```\n</process>\n\n<output_template>\n**Markdown 輸出：**\n\n```markdown\n# LIT ETF 暴露與傳導分析報告\n\n## 分析日期: [YYYY-MM-DD]\n## ETF: Global X Lithium & Battery Tech ETF (LIT)\n\n---\n## 持股結構\n\n### 前 10 大持股\n| 排名 | 股票     | 權重      | 產業鏈段  | 國家      |\n|------|----------|-----------|-----------|-----------|\n| 1    | [ticker] | [weight]% | [segment] | [country] |\n| ...  | ...      | ...       | ...       | ...       |\n\n### 產業鏈段分布\n| 產業鏈段          | 權重      | 預期鋰價 Beta |\n|-------------------|-----------|---------------|\n| Upstream (礦業)   | [weight]% | 1.5-2.5       |\n| Midstream (精煉)  | [weight]% | 0.8-1.2       |\n| Downstream (電池) | [weight]% | 0.3-0.8       |\n\n---\n## Beta 分析\n\n### ETF 對因子敏感度\n| 因子       | 當前 Beta | 52週平均 | 趨勢        |\n|------------|-----------|----------|-------------|\n| 鋰價因子   | [值]      | [值]     | [上升/下降] |\n| EV需求因子 | [值]      | [值]     | [上升/下降] |\n\n### Beta 歷史趨勢\n[過去 52 週 beta 變化描述]\n\n---\n## 傳導狀態\n\n- **狀態**: [normal/weakening/broken]\n- **依據**: [說明]\n- **含義**: [投資建議]\n\n---\n## 關鍵發現\n\n1. [發現1]\n2. [發現2]\n3. [發現3]\n\n---\n## 風險提示\n\n- [風險1]\n- [風險2]\n```\n</output_template>\n\n<success_criteria>\n此工作流程完成時：\n- [ ] ETF 持股已載入並分類\n- [ ] 產業鏈段權重已計算\n- [ ] Rolling beta 已計算（52 週滾動）\n- [ ] 傳導狀態已判斷\n- [ ] 輸出包含持股前 10 大\n- [ ] 數據來源已標註\n</success_criteria>\n",
        "skills/lithium-supply-demand-gap-radar/workflows/full-analysis.md": "# Workflow: Full Analysis（完整供需×價格×傳導整合分析）\n\n<required_reading>\n**Read these reference files NOW:**\n1. references/data-sources.md\n2. references/supply-chain-mapping.md\n3. references/price-methodology.md\n4. references/etf-holdings-structure.md\n5. references/failure-modes.md\n</required_reading>\n\n<process>\n## Step 1: Initialize Parameters\n\n解析輸入參數並設定預設值：\n\n```python\nparams = {\n    \"etf_ticker\": args.get(\"etf_ticker\", \"LIT\"),\n    \"lookback_years\": args.get(\"lookback_years\", 10),\n    \"price_freq\": args.get(\"price_freq\", \"weekly\"),\n    \"region_focus\": args.get(\"region_focus\", [\"China\", \"Australia\", \"Chile\", \"Argentina\"]),\n    \"chem_focus\": args.get(\"chem_focus\", \"both\"),\n    \"data_level\": args.get(\"data_level\", \"free_nolimit\"),\n    \"output_format\": args.get(\"output_format\", \"markdown\")\n}\n```\n\n## Step 2: Load Data Layers\n\n### 2.1 ETF Exposure Layer\n\n```python\n# ETF 價格\nlit_px = load_price(params[\"etf_ticker\"], years=params[\"lookback_years\"], freq=params[\"price_freq\"])\n\n# Holdings (從 Global X factsheet)\nholdings = load_lit_holdings_from_factsheet()\n# 輸出: {ticker, weight, segment: upstream/midstream/downstream, country}\n```\n\n### 2.2 Lithium Data Layer\n\n根據 `data_level` 載入對應數據源：\n\n```python\n# 供給數據\nusgs_supply = load_usgs_lithium_world_production()   # Tier 0: 年度基準\naus_req = load_australia_req_lithium_outlook()       # Tier 0: 季度更新\nabs_exports = load_abs_lithium_exports()             # Tier 0: 出口量\n\n# 需求數據\niea_battery = load_iea_battery_demand_proxy()        # Tier 0: GWh 需求\n\n# 價格數據 (根據 data_level 選擇)\nli_price = load_lithium_price_series(\n    data_level=params[\"data_level\"],\n    chem=params[\"chem_focus\"],\n    providers=[\"fastmarkets\", \"smm\", \"cme_fallback\"]\n)\n```\n\n## Step 3: Compute Middle Layers\n\n### 3.1 Balance Nowcast\n\n```python\n# 供給 proxy\nsupply_proxy = blend_supply(usgs_supply, aus_req, abs_exports)\n\n# 需求 proxy (三情境)\ndemand_scenarios = build_demand_proxy(\n    iea_battery,\n    scenario_kgs_per_kwh=[0.12, 0.15, 0.18]  # 保守/中性/積極\n)\n\n# 平衡指數\nbalance_index = {\n    \"conservative\": zscore(demand_scenarios[\"conservative\"] - supply_proxy),\n    \"neutral\": zscore(demand_scenarios[\"neutral\"] - supply_proxy),\n    \"aggressive\": zscore(demand_scenarios[\"aggressive\"] - supply_proxy)\n}\n```\n\n### 3.2 Price Regime\n\n```python\nprice_regime = classify_regime(li_price)\n\n# 輸出結構\n# {\n#   \"carbonate\": {\n#       \"regime\": \"bottoming\",\n#       \"roc_12w\": -2.3,\n#       \"roc_26w\": -8.5,\n#       \"slope\": -0.12,\n#       \"volatility\": 4.2,\n#       \"mean_deviation\": -12\n#   },\n#   \"hydroxide\": {...}\n# }\n```\n\n### 3.3 ETF Transmission\n\n```python\n# 因子對齊\nfactor_df = align_factors(lit_px, li_price, demand_proxy)\n\n# Rolling beta\nbeta_map = rolling_multifactor_beta(\n    etf_returns=lit_px[\"ret\"],\n    factors=factor_df,\n    window=52  # 52 週滾動\n)\n\n# 傳導狀態判斷\ntransmission_status = assess_transmission(beta_map)\n# \"normal\" | \"weakening\" | \"broken\"\n```\n\n## Step 4: Generate Insights\n\n### 4.1 Thesis Dashboard\n\n```python\nthesis = compute_thesis(\n    balance_index=balance_index[\"neutral\"],\n    price_regime=price_regime,\n    transmission=beta_map\n)\n\n# 輸出: \"bullish\" | \"neutral\" | \"bearish\" | \"neutral_bullish\" | \"neutral_bearish\"\n```\n\n### 4.2 Catalyst Map\n\n識別近期/即將發生的催化劑：\n\n```python\ncatalysts = [\n    {\"event\": \"IEA EV Outlook Release\", \"expected_date\": \"2026-04\", \"direction\": \"positive/negative/neutral\"},\n    {\"event\": \"Australia REQ Update\", \"expected_date\": \"2026-Q1\", \"direction\": \"...\"},\n    {\"event\": \"Chile Lithium Policy\", \"expected_date\": \"TBD\", \"direction\": \"...\"}\n]\n```\n\n### 4.3 Targets & Path\n\n```python\ntargets = derive_weekly_targets(lit_px)\n\n# 輸出:\n# {\n#   \"mid_channel\": 48.50,\n#   \"prior_high\": 56.20,\n#   \"upper_channel\": 68.00,\n#   \"support\": 38.50\n# }\n```\n\n### 4.4 Invalidation Rules\n\n```python\ninvalidation = build_invalidation_rules(\n    lit_px=lit_px,\n    balance_index=balance_index,\n    price_regime=price_regime,\n    beta_map=beta_map\n)\n\n# 輸出:\n# [\n#   {\"condition\": \"price < 38.50\", \"description\": \"跌破關鍵支撐\"},\n#   {\"condition\": \"balance_index < 0\", \"description\": \"供需平衡轉負\"},\n#   {\"condition\": \"regime == downtrend\", \"description\": \"價格型態轉弱\"},\n#   {\"condition\": \"beta_li < 0.3 for 8w\", \"description\": \"傳導斷裂\"}\n# ]\n```\n\n## Step 5: Format Output\n\n根據 `output_format` 生成報告：\n\n```python\nif params[\"output_format\"] == \"markdown\":\n    report = format_markdown_report(\n        thesis=thesis,\n        balance_index=balance_index,\n        price_regime=price_regime,\n        beta_map=beta_map,\n        holdings=holdings,\n        targets=targets,\n        invalidation=invalidation,\n        catalysts=catalysts\n    )\nelif params[\"output_format\"] == \"json\":\n    report = format_json_output(...)\n```\n\n## Step 6: Generate Visualizations\n\n**強制執行**：每次完整分析都必須生成視覺化圖表\n\n### 6.1 生成綜合儀表板\n\n```python\n# 生成完整儀表板（包含所有關鍵圖表）\nfrom scripts.visualize_analysis import generate_comprehensive_dashboard\n\ndashboard_path = generate_comprehensive_dashboard(\n    output_dir='output',\n    asof_date=params['asof_date']\n)\n\n# 輸出檔案：output/lithium_analysis_YYYY-MM-DD.png\n```\n\n**儀表板內容**：\n1. 投資論述摘要（Thesis + Confidence + 關鍵指標）\n2. 供需平衡演變圖（2024-2026，含缺口）\n3. 供需平衡指數（三情境：保守/中性/積極）\n4. 碳酸鋰價格走勢（歷史價格 + 市況型態）\n5. ETF 傳導敏感度分析（Beta to 鋰價/EV需求）\n6. LIT ETF 目標路徑（支撐/目標/上軌）\n\n**技術規格**：\n- 解析度：300 DPI（高畫質輸出）\n- 格式：PNG\n- 尺寸：18\" × 12\"（適合報告與簡報）\n- 中文支持：自動配置中文字體\n- 檔名格式：`lithium_analysis_YYYY-MM-DD.png`\n\n### 6.2 生成拐點分析圖表\n\n```python\n# 生成拐點分析專用圖表\nfrom scripts.inflection_point_chart import generate_inflection_point_chart\n\ninflection_chart_path = generate_inflection_point_chart(\n    output_dir='output',\n    asof_date=params['asof_date']\n)\n\n# 輸出檔案：output/lithium_inflection_analysis_YYYY-MM-DD.png\n```\n\n**拐點圖表內容**：\n1. 供需平衡指數演變（2020-2027）\n   - 歷史數據（2020-2025）\n   - 未來預測（2026-2027，含三情境區間）\n2. 碳酸鋰價格走勢（歷史 + 預測）\n3. 關鍵拐點標註\n   - ⭐ 歷史拐點：2023Q2（供給反超需求）\n   - ⭐ 預期拐點：2026Q4（中性情境）\n   - 🔵 當前位置標記\n4. 市場階段背景色塊\n   - 需求缺口期 vs 供給過剩期 vs 預期反彈期\n5. 關鍵催化劑時間軸\n\n**技術規格**：\n- 解析度：300 DPI\n- 格式：PNG\n- 尺寸：16\" × 12\"\n- 中文支持：自動配置中文字體\n- 檔名格式：`lithium_inflection_analysis_YYYY-MM-DD.png`\n</process>\n\n<output_template>\n**Markdown 輸出骨架：**\n\n```markdown\n# LIT（鋰產業鏈 ETF）供需×價格×傳導整合評估\n\n## 1) 數據源摘要（本次使用）\n- 供給基準：[來源列表]\n- 需求 proxy：[來源列表]\n- 價格：[來源列表]\n- ETF 暴露：[來源列表]\n- 數據等級：[free_nolimit/free_limit/paid_low/paid_high]\n\n## 2) 供需平衡 Nowcast\n- Balance Index：[值]（上行/下行；是否出現拐點）\n- 主要驅動：[需求/供給]\n- 三情境：\n  - 保守：[值]\n  - 中性：[值]\n  - 積極：[值]\n\n## 3) 價格型態（Regime）\n- 碳酸鋰：[downtrend/bottoming/uptrend/overheat]\n- 氫氧化鋰：[...]\n- 關鍵指標：\n  - 12週動能：[值]\n  - 波動率：[值]\n\n## 4) 鋰→股票→ETF 傳導\n- ETF 對鋰價因子 beta：[值]（上升=傳導恢復）\n- ETF 對需求因子 beta：[值]\n- 傳導狀態：[normal/weakening/broken]\n\n## 5) 結論與路徑\n- Thesis：[bullish/neutral/bearish]\n- 目標路徑：\n  - 中軌：[價格]\n  - 前高：[價格]\n  - 上軌：[價格]\n- 失效條件：\n  - [條件1]\n  - [條件2]\n  - [條件3]\n\n## 6) 催化劑地圖\n| 事件 | 預期時間 | 方向 |\n|------|----------|------|\n| ...  | ...      | ...  |\n\n## 7) 數據來源追溯\n| 指標 | 來源 | 更新頻率 | 置信度 |\n|------|------|----------|--------|\n| ...  | ...  | ...      | ...    |\n```\n</output_template>\n\n<success_criteria>\n此工作流程完成時：\n- [ ] 三個中介層（Balance/Regime/Transmission）都已計算\n- [ ] Thesis 判斷明確（含依據）\n- [ ] 目標路徑已標註（技術位）\n- [ ] 失效條件完整（供給/需求/市場端）\n- [ ] 數據來源可追溯\n- [ ] 輸出格式正確（markdown/json）\n- [ ] **綜合儀表板已生成**（`output/lithium_analysis_YYYY-MM-DD.png`）\n- [ ] **拐點分析圖表已生成**（`output/lithium_inflection_analysis_YYYY-MM-DD.png`）\n- [ ] **報告與圖表檔名日期一致**\n- [ ] **拐點判斷包含歷史與預期拐點**\n</success_criteria>\n",
        "skills/lithium-supply-demand-gap-radar/workflows/ingest.md": "# Workflow: Ingest（數據擷取與標準化）\n\n<required_reading>\n**Read these reference files NOW:**\n1. references/data-sources.md\n2. references/unit-conversion.md\n</required_reading>\n\n<process>\n## Step 1: Determine Data Sources\n\n根據 `data_level` 決定要擷取的數據源：\n\n```python\ndef get_data_sources(data_level, sources_config):\n    \"\"\"\n    根據數據等級決定來源\n    \"\"\"\n\n    source_tiers = {\n        \"free_nolimit\": {\n            \"usgs\": True,\n            \"iea_ev_outlook\": True,\n            \"australia_req\": True,\n            \"abs_exports\": True,\n            \"etf_holdings\": True,\n            \"fastmarkets\": False,  # 只有方法學\n            \"smm\": False           # 只有方法學\n        },\n        \"free_limit\": {\n            \"usgs\": True,\n            \"iea_ev_outlook\": True,\n            \"australia_req\": True,\n            \"abs_exports\": True,\n            \"etf_holdings\": True,\n            \"fastmarkets\": \"methodology_only\",\n            \"smm\": \"methodology_only\"\n        },\n        \"paid_low\": {\n            \"usgs\": True,\n            \"iea_ev_outlook\": True,\n            \"australia_req\": True,\n            \"abs_exports\": True,\n            \"etf_holdings\": True,\n            \"fastmarkets\": True,\n            \"smm\": True\n        },\n        \"paid_high\": {\n            \"usgs\": True,\n            \"iea_ev_outlook\": True,\n            \"australia_req\": True,\n            \"abs_exports\": True,\n            \"etf_holdings\": True,\n            \"fastmarkets\": True,\n            \"smm\": True,\n            \"benchmark\": True,\n            \"bnef\": True\n        }\n    }\n\n    # 取得預設來源\n    defaults = source_tiers.get(data_level, source_tiers[\"free_nolimit\"])\n\n    # 合併用戶配置\n    if sources_config:\n        for source, enabled in sources_config.items():\n            defaults[source] = enabled\n\n    return defaults\n```\n\n## Step 2: Ingest USGS Data\n\n```python\ndef ingest_usgs_lithium():\n    \"\"\"\n    從 USGS 擷取鋰統計數據\n\n    來源：\n    - https://www.usgs.gov/centers/national-minerals-information-center/lithium-statistics-and-information\n    - https://pubs.usgs.gov/periodicals/mcs2025/mcs2025-lithium.pdf\n    \"\"\"\n\n    import requests\n    from bs4 import BeautifulSoup\n\n    # 主頁面\n    url = \"https://www.usgs.gov/centers/national-minerals-information-center/lithium-statistics-and-information\"\n\n    # 抓取頁面\n    response = fetch_with_retry(url)\n    soup = BeautifulSoup(response.text, \"html.parser\")\n\n    # 找到數據表格或 PDF 連結\n    data_links = extract_data_links(soup)\n\n    # 下載並解析 MCS（Mineral Commodity Summaries）\n    mcs_data = parse_mcs_lithium(data_links.get(\"mcs\"))\n\n    # 標準化\n    standardized = {\n        \"source_id\": \"USGS\",\n        \"asof_date\": date.today().isoformat(),\n        \"data\": {\n            \"world_production\": mcs_data[\"world_production\"],\n            \"by_country\": mcs_data[\"by_country\"],\n            \"reserves\": mcs_data[\"reserves\"],\n            \"consumption\": mcs_data.get(\"consumption\")\n        },\n        \"unit\": \"kt_LCE\",\n        \"confidence\": 0.95,\n        \"update_frequency\": \"annual\"\n    }\n\n    return standardized\n```\n\n## Step 3: Ingest IEA Data\n\n```python\ndef ingest_iea_ev_outlook():\n    \"\"\"\n    從 IEA 擷取 EV/電池需求數據\n\n    來源：\n    - https://www.iea.org/reports/global-ev-outlook-2024\n    - https://www.iea.org/data-and-statistics/data-product/global-ev-data-explorer\n    \"\"\"\n\n    # 嘗試 API（如有）\n    api_data = try_iea_api()\n\n    if not api_data:\n        # 從報告頁面抓取關鍵數字\n        url = \"https://www.iea.org/reports/global-ev-outlook-2024\"\n        report_data = scrape_iea_report(url)\n\n    # 提取關鍵指標\n    extracted = {\n        \"ev_sales_by_year\": report_data.get(\"ev_sales\"),\n        \"battery_demand_gwh\": report_data.get(\"battery_demand\"),\n        \"lithium_demand\": report_data.get(\"lithium_demand\"),  # 如有\n        \"projections\": report_data.get(\"projections\")\n    }\n\n    # 標準化\n    standardized = {\n        \"source_id\": \"IEA\",\n        \"asof_date\": date.today().isoformat(),\n        \"data\": extracted,\n        \"unit\": \"mixed\",  # 需在欄位級別標註\n        \"confidence\": 0.90,\n        \"update_frequency\": \"annual\"\n    }\n\n    return standardized\n```\n\n## Step 4: Ingest Australia Data\n\n### 4.1 Resources & Energy Quarterly\n\n```python\ndef ingest_australia_req():\n    \"\"\"\n    從澳洲政府擷取 REQ 數據\n\n    來源：\n    - https://www.industry.gov.au/publications/resources-and-energy-quarterly\n    \"\"\"\n\n    url = \"https://www.industry.gov.au/publications/resources-and-energy-quarterly\"\n\n    # 找到最新季度報告\n    latest_report = find_latest_req_report(url)\n\n    # 下載 PDF 或 Excel\n    report_file = download_report(latest_report[\"url\"])\n\n    # 解析鋰相關章節\n    lithium_section = extract_lithium_section(report_file)\n\n    # 標準化\n    standardized = {\n        \"source_id\": \"AU_REQ\",\n        \"asof_date\": latest_report[\"quarter\"],\n        \"data\": {\n            \"production\": lithium_section.get(\"production\"),\n            \"exports\": lithium_section.get(\"exports\"),\n            \"outlook\": lithium_section.get(\"outlook\"),\n            \"prices\": lithium_section.get(\"prices\")\n        },\n        \"unit\": \"mixed\",\n        \"confidence\": 0.90,\n        \"update_frequency\": \"quarterly\"\n    }\n\n    return standardized\n```\n\n### 4.2 ABS Exports\n\n```python\ndef ingest_abs_exports():\n    \"\"\"\n    從 ABS 擷取鋰出口數據\n\n    來源：\n    - https://www.abs.gov.au/\n    - 國際貿易統計\n    \"\"\"\n\n    # ABS 通常需要使用 TableBuilder 或特定 API\n    # 這裡提供概念性代碼\n\n    abs_data = query_abs_trade_data(\n        commodity=\"lithium\",\n        measure=[\"value\", \"quantity\"],\n        frequency=\"monthly\"\n    )\n\n    # 標準化\n    standardized = {\n        \"source_id\": \"ABS\",\n        \"asof_date\": abs_data[\"latest_period\"],\n        \"data\": {\n            \"export_value_aud\": abs_data[\"value\"],\n            \"export_quantity\": abs_data.get(\"quantity\")\n        },\n        \"unit\": \"AUD/tonnes\",\n        \"confidence\": 0.90,\n        \"update_frequency\": \"monthly\"\n    }\n\n    return standardized\n```\n\n## Step 5: Ingest Price Data\n\n```python\ndef ingest_lithium_prices(data_level, chem_focus):\n    \"\"\"\n    根據數據等級擷取價格數據\n    \"\"\"\n\n    prices = {}\n\n    if data_level in [\"paid_low\", \"paid_high\"]:\n        # 付費來源\n        if chem_focus in [\"carbonate\", \"both\"]:\n            prices[\"carbonate\"] = ingest_fastmarkets_carbonate()\n            prices[\"carbonate_smm\"] = ingest_smm_carbonate()\n\n        if chem_focus in [\"hydroxide\", \"both\"]:\n            prices[\"hydroxide\"] = ingest_fastmarkets_hydroxide()\n\n    else:\n        # 免費來源（proxy）\n        prices[\"proxy\"] = ingest_cme_lithium_futures()\n\n        if not prices[\"proxy\"][\"data\"]:\n            # 使用股票籃子 proxy\n            prices[\"stock_proxy\"] = build_lithium_stock_proxy()\n\n    return {\n        \"source_id\": \"mixed\",\n        \"data\": prices,\n        \"data_level\": data_level,\n        \"confidence\": 0.85 if data_level.startswith(\"paid\") else 0.70\n    }\n```\n\n## Step 6: Ingest ETF Holdings\n\n```python\ndef ingest_etf_holdings(ticker=\"LIT\"):\n    \"\"\"\n    從 Global X 擷取 ETF 持股\n\n    來源：\n    - https://www.globalxetfs.com/funds/lit/\n    \"\"\"\n\n    url = f\"https://www.globalxetfs.com/funds/{ticker.lower()}/\"\n\n    # 嘗試從頁面抓取\n    holdings = scrape_globalx_holdings(url)\n\n    # 如果失敗，嘗試 factsheet PDF\n    if not holdings:\n        factsheet_url = find_factsheet_url(url)\n        holdings = parse_factsheet_pdf(factsheet_url)\n\n    # 標準化\n    standardized = {\n        \"source_id\": \"GlobalX\",\n        \"asof_date\": holdings.get(\"asof_date\", \"unknown\"),\n        \"data\": {\n            \"holdings\": holdings[\"list\"],\n            \"total_assets\": holdings.get(\"total_assets\"),\n            \"num_holdings\": len(holdings[\"list\"])\n        },\n        \"confidence\": 0.90,\n        \"update_frequency\": \"daily\"\n    }\n\n    return standardized\n```\n\n## Step 7: Normalize and Store\n\n```python\ndef normalize_and_store(all_data):\n    \"\"\"\n    標準化所有數據並存儲\n    \"\"\"\n\n    import duckdb\n\n    # 建立統一 schema\n    schema = \"\"\"\n    CREATE TABLE IF NOT EXISTS lithium_data (\n        date DATE,\n        metric_type VARCHAR,\n        metric_name VARCHAR,\n        value DOUBLE,\n        unit VARCHAR,\n        region VARCHAR,\n        source_id VARCHAR,\n        data_level VARCHAR,\n        confidence DOUBLE,\n        ingested_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n    )\n    \"\"\"\n\n    conn = duckdb.connect(\"data/lithium_lake.duckdb\")\n    conn.execute(schema)\n\n    # 轉換並插入各數據源\n    for source_name, source_data in all_data.items():\n        normalized_rows = normalize_source(source_name, source_data)\n        insert_rows(conn, normalized_rows)\n\n    conn.close()\n\n    return {\n        \"status\": \"success\",\n        \"records_inserted\": count_inserted,\n        \"sources_processed\": list(all_data.keys())\n    }\n```\n\n## Step 8: Validate Data\n\n```python\ndef validate_ingested_data(all_data):\n    \"\"\"\n    驗證擷取的數據\n    \"\"\"\n\n    validations = []\n\n    for source_name, source_data in all_data.items():\n        validation = {\n            \"source\": source_name,\n            \"has_data\": bool(source_data.get(\"data\")),\n            \"asof_date\": source_data.get(\"asof_date\"),\n            \"confidence\": source_data.get(\"confidence\"),\n            \"issues\": []\n        }\n\n        # 檢查數據新鮮度\n        if is_stale(source_data.get(\"asof_date\"), source_data.get(\"update_frequency\")):\n            validation[\"issues\"].append(\"數據可能過期\")\n\n        # 檢查必要欄位\n        if not source_data.get(\"unit\"):\n            validation[\"issues\"].append(\"缺少單位標註\")\n\n        validations.append(validation)\n\n    return {\n        \"validations\": validations,\n        \"overall_status\": \"pass\" if all(not v[\"issues\"] for v in validations) else \"warning\"\n    }\n```\n</process>\n\n<output_template>\n**擷取報告：**\n\n```markdown\n# 鋰數據擷取報告\n\n## 擷取日期: [YYYY-MM-DD]\n## 數據等級: [free_nolimit/free_limit/paid_low/paid_high]\n\n---\n## 擷取結果摘要\n\n| 數據源 | 狀態 | 記錄數 | 更新日期 | 置信度 |\n|--------|------|--------|----------|--------|\n| USGS | ✅ 成功 | [n] | [date] | 0.95 |\n| IEA | ✅ 成功 | [n] | [date] | 0.90 |\n| Australia REQ | ✅ 成功 | [n] | [date] | 0.90 |\n| ABS Exports | ✅ 成功 | [n] | [date] | 0.90 |\n| ETF Holdings | ✅ 成功 | [n] | [date] | 0.90 |\n| Price Data | ⚠️ Proxy | [n] | [date] | 0.70 |\n\n---\n## 數據驗證\n\n| 檢查項目 | 結果 |\n|----------|------|\n| 數據新鮮度 | [pass/warning] |\n| 單位一致性 | [pass/warning] |\n| 必要欄位 | [pass/warning] |\n\n---\n## 存儲位置\n\n- 本地數據湖: `data/lithium_lake.duckdb`\n- 原始檔案: `data/raw/[source]/`\n\n---\n## 下次更新建議\n\n| 數據源 | 建議更新頻率 | 下次更新 |\n|--------|--------------|----------|\n| USGS | 年度 | [date] |\n| IEA | 年度 | [date] |\n| Australia REQ | 季度 | [date] |\n| ABS | 月度 | [date] |\n| ETF Holdings | 週度 | [date] |\n| Price | 日度/週度 | [date] |\n```\n</output_template>\n\n<success_criteria>\n此工作流程完成時：\n- [ ] 根據 data_level 選擇正確的數據源\n- [ ] 所有已啟用的數據源都已嘗試擷取\n- [ ] 數據已標準化（統一 schema）\n- [ ] 數據已存儲到本地數據湖\n- [ ] 驗證報告已生成\n- [ ] 失敗的來源有明確錯誤訊息\n</success_criteria>\n",
        "skills/lithium-supply-demand-gap-radar/workflows/price-regime.md": "# Workflow: Price Regime（價格型態分析）\n\n<required_reading>\n**Read these reference files NOW:**\n1. references/data-sources.md\n2. references/price-methodology.md\n3. references/failure-modes.md\n</required_reading>\n\n<process>\n## Step 1: Load Price Data\n\n根據 `data_level` 載入價格數據：\n\n### 1.1 Free Data Level\n\n```python\ndef load_price_free(chem_focus):\n    \"\"\"\n    免費數據源：\n    1. CME Lithium Hydroxide Futures（可交易價格）\n    2. 相關股票籃子 proxy（ALB, SQM, LTHM 等）\n    \"\"\"\n\n    # CME 期貨（如可得）\n    cme_data = load_cme_lithium_futures()\n\n    # 股票 proxy（備援）\n    stock_proxy = compute_lithium_stock_index([\n        {\"ticker\": \"ALB\", \"weight\": 0.3},\n        {\"ticker\": \"SQM\", \"weight\": 0.3},\n        {\"ticker\": \"LTHM\", \"weight\": 0.2},\n        {\"ticker\": \"LAC\", \"weight\": 0.2}\n    ])\n\n    return {\n        \"carbonate\": cme_data.get(\"carbonate\") or stock_proxy,\n        \"hydroxide\": cme_data.get(\"hydroxide\") or stock_proxy,\n        \"source\": \"CME/StockProxy\",\n        \"data_level\": \"free_nolimit\"\n    }\n```\n\n### 1.2 Paid Data Level\n\n```python\ndef load_price_paid(chem_focus, providers=[\"fastmarkets\", \"smm\"]):\n    \"\"\"\n    付費數據源：\n    1. Fastmarkets 碳酸鋰/氫氧化鋰報價\n    2. SMM 碳酸鋰現貨指數\n    \"\"\"\n\n    prices = {}\n\n    if \"fastmarkets\" in providers:\n        prices[\"hydroxide\"] = load_fastmarkets_lithium_hydroxide()\n        prices[\"carbonate\"] = load_fastmarkets_lithium_carbonate()\n\n    if \"smm\" in providers:\n        prices[\"carbonate_smm\"] = load_smm_lithium_carbonate()\n\n    return {\n        \"carbonate\": prices.get(\"carbonate\") or prices.get(\"carbonate_smm\"),\n        \"hydroxide\": prices.get(\"hydroxide\"),\n        \"source\": providers,\n        \"data_level\": \"paid\"\n    }\n```\n\n## Step 2: Compute Regime Indicators\n\n### 2.1 Momentum Indicators\n\n```python\ndef compute_momentum(price_series, periods=[12, 26]):\n    \"\"\"\n    計算動能指標（Rate of Change）\n    \"\"\"\n\n    results = {}\n    for period in periods:\n        roc = (price_series[-1] / price_series[-period] - 1) * 100\n        results[f\"roc_{period}w\"] = roc\n\n    return results\n```\n\n### 2.2 Trend Slope\n\n```python\ndef compute_trend_slope(price_series, window=26):\n    \"\"\"\n    計算趨勢斜率（線性回歸）\n    \"\"\"\n    from scipy import stats\n\n    x = np.arange(len(price_series[-window:]))\n    y = price_series[-window:]\n\n    slope, intercept, r_value, p_value, std_err = stats.linregress(x, y)\n\n    return {\n        \"slope\": slope,\n        \"r_squared\": r_value ** 2,\n        \"slope_normalized\": slope / np.mean(y)  # 標準化斜率\n    }\n```\n\n### 2.3 Volatility\n\n```python\ndef compute_volatility(price_series, window=26):\n    \"\"\"\n    計算波動率（ATR% 或標準差）\n    \"\"\"\n\n    returns = np.diff(price_series) / price_series[:-1]\n\n    return {\n        \"volatility_std\": np.std(returns[-window:]) * 100,\n        \"volatility_expanding\": np.std(returns[-window//2:]) > np.std(returns[-window:-window//2]),\n        \"atr_pct\": compute_atr_pct(price_series, window)\n    }\n```\n\n### 2.4 Mean Reversion\n\n```python\ndef compute_mean_deviation(price_series, ma_window=200):\n    \"\"\"\n    計算均值偏離度\n    \"\"\"\n\n    ma = np.mean(price_series[-ma_window:])\n    current = price_series[-1]\n\n    deviation = (current - ma) / ma * 100\n\n    return {\n        \"ma_200w\": ma,\n        \"deviation_pct\": deviation,\n        \"extreme\": abs(deviation) > 30  # 超過 30% 視為極端\n    }\n```\n\n## Step 3: Classify Regime\n\n```python\ndef classify_regime(momentum, slope, volatility, mean_dev):\n    \"\"\"\n    四階段分類邏輯：\n\n    | Regime    | ROC_12w | Slope | Volatility | 判斷優先級                   |\n    |-----------|---------|-------|------------|------------------------------|\n    | downtrend | < 0     | < 0   | any        | slope < 0 且 ROC < -5%       |\n    | bottoming | 收斂    | 趨緩  | 下降       | -5% < ROC < 5%, slope 收斂   |\n    | uptrend   | > 0     | > 0   | any        | slope > 0 且 ROC > 5%        |\n    | overheat  | 極端+   | +     | 擴大       | ROC > 30% 或 deviation > 30% |\n    \"\"\"\n\n    roc_12w = momentum[\"roc_12w\"]\n    roc_26w = momentum[\"roc_26w\"]\n    slope_val = slope[\"slope_normalized\"]\n    vol_expanding = volatility[\"volatility_expanding\"]\n    deviation = mean_dev[\"deviation_pct\"]\n\n    # 過熱判斷（最高優先級）\n    if roc_12w > 30 or deviation > 30:\n        return {\n            \"regime\": \"overheat\",\n            \"confidence\": 0.9,\n            \"signal\": \"獲利了結風險\",\n            \"indicators\": {\"roc_12w\": roc_12w, \"deviation\": deviation}\n        }\n\n    # 上行判斷\n    if slope_val > 0 and roc_12w > 5:\n        return {\n            \"regime\": \"uptrend\",\n            \"confidence\": 0.85,\n            \"signal\": \"做多視窗開啟\",\n            \"indicators\": {\"roc_12w\": roc_12w, \"slope\": slope_val}\n        }\n\n    # 下行判斷\n    if slope_val < 0 and roc_12w < -5:\n        return {\n            \"regime\": \"downtrend\",\n            \"confidence\": 0.85,\n            \"signal\": \"空頭主導，避免做多\",\n            \"indicators\": {\"roc_12w\": roc_12w, \"slope\": slope_val}\n        }\n\n    # 築底判斷（預設）\n    return {\n        \"regime\": \"bottoming\",\n        \"confidence\": 0.75,\n        \"signal\": \"觀望，等待確認\",\n        \"indicators\": {\n            \"roc_12w\": roc_12w,\n            \"roc_26w\": roc_26w,\n            \"vol_trend\": \"下降\" if not vol_expanding else \"擴大\"\n        }\n    }\n```\n\n## Step 4: Multi-Chemical Analysis\n\n```python\ndef analyze_both_chemicals(carbonate_price, hydroxide_price):\n    \"\"\"\n    同時分析碳酸鋰和氫氧化鋰\n    \"\"\"\n\n    carbonate_regime = analyze_single(carbonate_price)\n    hydroxide_regime = analyze_single(hydroxide_price)\n\n    # 價差分析\n    spread = compute_carbonate_hydroxide_spread(carbonate_price, hydroxide_price)\n\n    # 同步性判斷\n    sync_status = \"synchronized\" if carbonate_regime[\"regime\"] == hydroxide_regime[\"regime\"] else \"divergent\"\n\n    return {\n        \"carbonate\": carbonate_regime,\n        \"hydroxide\": hydroxide_regime,\n        \"spread\": spread,\n        \"sync_status\": sync_status,\n        \"interpretation\": generate_spread_interpretation(spread, sync_status)\n    }\n```\n\n## Step 5: Generate Confirmation Signals\n\n```python\ndef generate_confirmation_signals(regime_result):\n    \"\"\"\n    生成型態轉換確認訊號\n    \"\"\"\n\n    signals = []\n    regime = regime_result[\"regime\"]\n\n    if regime == \"bottoming\":\n        signals = [\n            {\"signal\": \"12週動能轉正（ROC > 0）\", \"status\": \"pending\", \"importance\": \"high\"},\n            {\"signal\": \"波動率開始擴大\", \"status\": \"pending\", \"importance\": \"medium\"},\n            {\"signal\": \"價格突破近期高點\", \"status\": \"pending\", \"importance\": \"high\"},\n            {\"signal\": \"Balance Index 同步上行\", \"status\": \"pending\", \"importance\": \"high\"}\n        ]\n    elif regime == \"uptrend\":\n        signals = [\n            {\"signal\": \"維持 ROC > 5%\", \"status\": \"active\", \"importance\": \"high\"},\n            {\"signal\": \"斜率持續為正\", \"status\": \"active\", \"importance\": \"medium\"}\n        ]\n\n    return signals\n```\n\n## Step 6: Format Output\n\n```python\ndef format_regime_report(regime_results, confirmation_signals):\n    return {\n        \"asof_date\": date.today().isoformat(),\n        \"carbonate\": regime_results[\"carbonate\"],\n        \"hydroxide\": regime_results[\"hydroxide\"],\n        \"spread_analysis\": regime_results[\"spread\"],\n        \"sync_status\": regime_results[\"sync_status\"],\n        \"confirmation_signals\": confirmation_signals,\n        \"trading_implication\": generate_trading_advice(regime_results)\n    }\n```\n</process>\n\n<output_template>\n**Markdown 輸出：**\n\n```markdown\n# 鋰價型態分析報告\n\n## 分析日期: [YYYY-MM-DD]\n## 數據來源: [Fastmarkets/SMM/CME/Proxy]\n\n---\n## 碳酸鋰 (Lithium Carbonate)\n\n| 指標           | 當前值 | 判讀   |\n|----------------|--------|--------|\n| 12週動能 (ROC) | [值]%  | [說明] |\n| 26週動能 (ROC) | [值]%  | [說明] |\n| 趨勢斜率       | [值]   | [說明] |\n| 波動率 (ATR%)  | [值]%  | [說明] |\n| 均值偏離度     | [值]%  | [說明] |\n\n**型態判定**: [DOWNTREND/BOTTOMING/UPTREND/OVERHEAT]\n\n---\n## 氫氧化鋰 (Lithium Hydroxide)\n\n[同上結構]\n\n---\n## 碳酸鋰/氫氧化鋰價差\n\n| 指標     | 當前值      | 歷史分位 |\n|----------|-------------|----------|\n| 價差     | [值]        | [%]      |\n| 價差方向 | [擴大/收斂] | -        |\n\n---\n## 週期位置\n\n```\nDOWNTREND → [BOTTOMING] → UPTREND → OVERHEAT\n                 ↑\n             目前位置\n```\n\n---\n## 轉換確認訊號\n\n| 訊號    | 狀態             | 重要性        |\n|---------|------------------|---------------|\n| [訊號1] | [pending/active] | [high/medium] |\n| [訊號2] | ...              | ...           |\n\n---\n## 交易含義\n\n[根據型態生成的交易建議]\n```\n</output_template>\n\n<success_criteria>\n此工作流程完成時：\n- [ ] 價格數據已載入（含 fallback）\n- [ ] 四個指標都已計算（動能/斜率/波動/均值偏離）\n- [ ] 型態分類明確（四階段之一）\n- [ ] 碳酸鋰/氫氧化鋰分開分析\n- [ ] 確認訊號已生成\n- [ ] 數據來源已標註\n</success_criteria>\n",
        "skills/monitor-etf-holdings-drawdown-risk/SKILL.md": "---\nname: monitor-etf-holdings-drawdown-risk\ndescription: 偵測「商品價格上漲、但對應實物 ETF/信託持倉卻下滑」的背離現象，並用多指標交叉驗證，評估是否存在實物供給緊張/交割壓力風險。\n---\n\n<essential_principles>\n\n<principle name=\"divergence_core\">\n**背離訊號核心邏輯**\n\n背離事件定義：\n- **價格上漲**：`price_return >= min_price_return_pct`（如 +15%）\n- **庫存下滑**：`inventory_change <= -min_inventory_drawdown_pct`（如 -10%）\n- **同時發生**：在相同視窗期（如 180 天）內同時滿足\n\n當價格與庫存同向時（同漲同跌）為正常；**逆向時**（價漲庫跌）才需要警覺。\n</principle>\n\n<principle name=\"dual_hypothesis\">\n**雙重假設驗證**\n\n不能直接把「庫存下降」解讀為「實物被搶」，需要交叉驗證：\n\n| 假設 | 支持條件 | 反駁條件 |\n|------|----------|----------|\n| **實物緊張** | COMEX/LBMA 下降、backwardation、lease rates 上升、零售溢價擴大 | 其他庫存穩定、contango、溢價平穩 |\n| **資金流/贖回** | ETF 流出但交易所庫存穩定、期貨結構不緊 | 多重庫存同步下降 |\n\n**輸出兩種解釋，讓用戶判斷哪個更符合當前數據。**\n</principle>\n\n<principle name=\"data_access\">\n**資料取得方式**\n\n本 skill 優先使用：\n- **ETF 官網庫存**：Selenium 模擬人類瀏覽器行為抓取（避免 API 限制）\n- **Yahoo Finance**：`yfinance` 套件取得現貨/期貨價格\n- **交叉驗證**：COMEX 庫存、期貨結構等公開數據\n\n腳本位於 `scripts/` 目錄，遵循 `references/data-sources.md` 的反偵測策略。\n</principle>\n\n<principle name=\"stress_scoring\">\n**壓力分數計算**\n\n```\nstress_score = 100 × min(1.0,\n    0.6 × divergence_severity +      # 背離嚴重度\n    0.2 × decade_low_bonus +         # 十年低點加成\n    0.2 × ratio_extreme_bonus        # 比值極端加成\n)\n```\n\n| 分數區間 | 解讀 |\n|----------|------|\n| 0-30     | 正常，無明顯背離 |\n| 30-60    | 輕度背離，值得關注 |\n| 60-80    | 中度背離，建議深入驗證 |\n| 80-100   | 重度背離，高度警戒 |\n</principle>\n\n</essential_principles>\n\n<objective>\n監控實物型 ETF（如 SLV、PSLV、GLD）的持倉與商品價格背離現象：\n\n1. **偵測背離**：價格上漲但 ETF 庫存下滑\n2. **評估嚴重度**：計算背離程度、十年低點、比值極端\n3. **交叉驗證**：使用 COMEX、期貨結構、零售溢價等指標\n4. **產出洞察**：提供兩種對立假設，避免單一敘事偏誤\n\n輸出：背離狀態、壓力分數、交叉驗證結果、下一步檢查建議。\n</objective>\n\n<quick_start>\n\n**最快的方式：檢查 SLV 背離狀態**\n\n```bash\ncd skills/monitor-etf-holdings-drawdown-risk\npip install pandas numpy yfinance selenium webdriver-manager beautifulsoup4 matplotlib  # 首次使用\npython scripts/divergence_detector.py --etf SLV --quick\n```\n\n輸出範例：\n```json\n{\n  \"asof\": \"2026-01-20\",\n  \"divergence\": false,\n  \"price_return_window\": 1.92,\n  \"inventory_change_window\": 0.15,\n  \"inventory_decade_low\": false,\n  \"stress_score_0_100\": 20.0,\n  \"interpretations\": [\"Physical Tightness\", \"ETF Flow Hypothesis\"]\n}\n```\n\n**完整分析 + 視覺化報告**：\n```bash\n# 1. 執行背離偵測\npython scripts/divergence_detector.py \\\n  --etf SLV \\\n  --start 2010-01-01 \\\n  --end 2026-01-20 \\\n  --output result.json\n\n# 2. 生成視覺化報告\npython scripts/visualize_divergence.py \\\n  --result result.json \\\n  --output ../../../output/\n```\n\n**輸出**：\n- JSON 分析結果：`result.json`\n- 視覺化報告：`output/SLV_divergence_report_20260120.png`\n- PDF 報告：`output/SLV_divergence_report_20260120.pdf`\n\n</quick_start>\n\n<intake>\n需要進行什麼操作？\n\n1. **快速檢查** - 查看指定 ETF 目前的背離狀態與壓力分數\n2. **完整分析** - 執行完整的歷史背離分析\n3. **交叉驗證** - 使用多指標驗證背離訊號的真實性\n4. **監控模式** - 設定持續監控與背離警報\n5. **方法論學習** - 了解背離偵測與雙重假設邏輯\n\n**請選擇或直接提供分析參數（如 ETF 代碼）。**\n</intake>\n\n<routing>\n| Response                        | Action                                        |\n|---------------------------------|-----------------------------------------------|\n| 1, \"快速\", \"quick\", \"check\"     | 執行 `scripts/divergence_detector.py --quick` |\n| 2, \"分析\", \"analyze\", \"full\"    | 閱讀 `workflows/analyze.md` 並執行            |\n| 3, \"驗證\", \"validate\", \"cross\"  | 閱讀 `workflows/cross-validate.md` 並執行     |\n| 4, \"監控\", \"monitor\", \"alert\"   | 閱讀 `workflows/monitor.md` 並執行            |\n| 5, \"學習\", \"方法論\", \"why\"      | 閱讀 `references/methodology.md`              |\n| 提供 ETF 代碼 (如 SLV, GLD)     | 閱讀 `workflows/analyze.md` 並使用參數執行    |\n\n**路由後，閱讀對應文件並執行。**\n</routing>\n\n<directory_structure>\n```\nmonitor-etf-holdings-drawdown-risk/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元數據\n├── workflows/\n│   ├── analyze.md                     # 完整背離分析工作流\n│   ├── monitor.md                     # 持續監控工作流\n│   └── cross-validate.md              # 交叉驗證工作流\n├── references/\n│   ├── data-sources.md                # ETF 庫存與價格資料來源\n│   ├── methodology.md                 # 背離偵測方法論\n│   └── input-schema.md                # 完整輸入參數定義\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n└── scripts/\n    ├── divergence_detector.py         # 主偵測腳本\n    ├── fetch_etf_holdings.py          # ETF 庫存抓取（Selenium）\n    └── fetch_prices.py                # 價格數據抓取\n```\n</directory_structure>\n\n<reference_index>\n\n**方法論**: references/methodology.md\n- 背離偵測邏輯\n- 雙重假設驗證框架\n- 壓力分數計算\n\n**資料來源**: references/data-sources.md\n- ETF 官網庫存抓取（Selenium）\n- Yahoo Finance 價格數據\n- 交叉驗證數據源（COMEX、LBMA）\n\n**輸入參數**: references/input-schema.md\n- 完整參數定義\n- 預設值與建議範圍\n\n</reference_index>\n\n<workflows_index>\n| Workflow          | Purpose          | 使用時機               |\n|-------------------|------------------|------------------------|\n| analyze.md        | 完整背離分析     | 需要完整歷史分析時     |\n| monitor.md        | 持續監控狀態     | 日常監控或警報         |\n| cross-validate.md | 交叉驗證背離訊號 | 確認背離真實性時       |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose             |\n|--------------------|---------------------|\n| output-json.md     | JSON 輸出結構定義   |\n| output-markdown.md | Markdown 報告模板   |\n</templates_index>\n\n<scripts_index>\n| Script                  | Command                                 | Purpose              |\n|-------------------------|-----------------------------------------|----------------------|\n| divergence_detector.py  | `--etf SLV --quick`                     | 快速檢查背離狀態     |\n| divergence_detector.py  | `--start DATE --end DATE --output FILE` | 完整歷史分析         |\n| visualize_divergence.py | `--result result.json --output DIR`     | 生成視覺化報告       |\n| fetch_etf_holdings.py   | `--etf SLV --output holdings.csv`       | 抓取 ETF 庫存        |\n| fetch_prices.py         | `--symbol SI=F --output prices.csv`     | 抓取商品價格         |\n</scripts_index>\n\n<input_schema_summary>\n\n**核心參數**\n\n| 參數                   | 類型   | 預設值     | 說明                       |\n|------------------------|--------|------------|----------------------------|\n| etf_ticker             | string | (必填)     | ETF/信託代碼（如 SLV）     |\n| commodity_price_symbol | string | (必填)     | 商品價格代碼（如 XAGUSD）  |\n| start_date             | string | 10Y 前     | 分析起始日                 |\n| end_date               | string | today      | 分析結束日                 |\n\n**背離參數**\n\n| 參數                       | 類型  | 預設值 | 說明                   |\n|----------------------------|-------|--------|------------------------|\n| divergence_window_days     | int   | 180    | 背離計算視窗（天）     |\n| decade_low_window_days     | int   | 3650   | 十年低點視窗（天）     |\n| min_price_return_pct       | float | 0.15   | 價格上漲門檻           |\n| min_inventory_drawdown_pct | float | 0.10   | 庫存下滑門檻           |\n\n完整參數定義見 `references/input-schema.md`。\n\n</input_schema_summary>\n\n<output_schema_summary>\n```json\n{\n  \"skill\": \"monitor-etf-holdings-drawdown-risk\",\n  \"asof\": \"2026-01-16\",\n  \"inputs\": {\n    \"etf_ticker\": \"SLV\",\n    \"commodity_price_symbol\": \"XAGUSD\"\n  },\n  \"result\": {\n    \"divergence\": true,\n    \"price_return_window\": 0.32,\n    \"inventory_change_window\": -0.18,\n    \"inventory_decade_low\": true,\n    \"inventory_to_price_ratio_z\": -2.4,\n    \"stress_score_0_100\": 78.5\n  },\n  \"interpretations\": [...],\n  \"next_checks\": [...]\n}\n```\n\n完整輸出結構見 `templates/output-json.md`。\n</output_schema_summary>\n\n<success_criteria>\n執行成功時應產出：\n\n- [ ] 背離狀態判定（divergence: true/false）\n- [ ] 價格變化與庫存變化數值\n- [ ] 十年低點判定\n- [ ] 庫存/價格比值 Z 分數\n- [ ] 壓力分數（0-100）\n- [ ] 兩種對立假設解釋\n- [ ] 下一步驗證建議清單\n</success_criteria>\n",
        "skills/monitor-etf-holdings-drawdown-risk/references/data-sources.md": "# 數據來源 (Data Sources)\n\n本技能使用公開數據來源，部分需要 Selenium 模擬瀏覽器行為。\n\n## ETF 持倉數據（主要來源）\n\n### iShares Silver Trust (SLV)\n\n**官網**：https://www.ishares.com/us/products/239855/ishares-silver-trust-fund\n\n**持倉欄位**：\n| 欄位 | 說明 | 單位 |\n|------|------|------|\n| Total Ounces of Silver | 總白銀盎司 | troy oz |\n| NAV per Share | 每股淨值 | USD |\n| Shares Outstanding | 流通股數 | shares |\n\n**抓取方式**：Selenium + BeautifulSoup\n- 需要等待 JavaScript 渲染完成\n- 使用 `WebDriverWait` 等待持倉數據載入\n- 典型選擇器：`div.fund-header-content`\n\n**歷史數據**：\n- iShares 官網提供近期數據\n- 歷史數據可從 ETF.com 或 Bloomberg 取得\n- 建議建立本地快取避免重複抓取\n\n### Sprott Physical Silver Trust (PSLV)\n\n**官網**：https://sprott.com/investment-strategies/physical-bullion-trusts/silver/\n\n**持倉欄位**：\n| 欄位 | 說明 | 單位 |\n|------|------|------|\n| Silver Held | 白銀持倉量 | troy oz |\n| Net Asset Value | 淨資產值 | USD |\n| Premium/Discount | 溢價/折價 | % |\n\n**特點**：\n- PSLV 為封閉式基金，溢價/折價資訊有額外參考價值\n- 持倉存放於加拿大皇家鑄幣廠，非 LBMA 體系\n\n### SPDR Gold Shares (GLD)\n\n**官網**：https://www.spdrgoldshares.com/\n\n**持倉欄位**：\n| 欄位 | 說明 | 單位 |\n|------|------|------|\n| Gold Holdings | 黃金持倉量 | troy oz |\n| Tonnes | 噸數 | metric tonnes |\n| NAV | 淨資產值 | USD |\n\n### Sprott Physical Gold Trust (PHYS)\n\n**官網**：https://sprott.com/investment-strategies/physical-bullion-trusts/gold/\n\n## 商品價格數據\n\n### Yahoo Finance（yfinance 套件）\n\n**存取方式**：Python `yfinance` 套件\n\n```python\nimport yfinance as yf\n\ndef fetch_price_series(symbol, start_date, end_date):\n    \"\"\"從 Yahoo Finance 抓取價格數據\"\"\"\n    ticker = yf.Ticker(symbol)\n    data = ticker.history(start=start_date, end=end_date)\n    return data[\"Close\"]\n```\n\n**可用代碼**：\n\n| 代碼 | 名稱 | 說明 | 狀態 |\n|------|------|------|------|\n| ~~XAGUSD=X~~ | ~~白銀現貨~~ | ~~Silver Spot~~ | ❌ 已失效 |\n| ~~XAUUSD=X~~ | ~~黃金現貨~~ | ~~Gold Spot~~ | ❌ 已失效 |\n| **SI=F** | **白銀期貨近月** | Silver Futures Front Month | ✅ 推薦使用 |\n| **GC=F** | **黃金期貨近月** | Gold Futures Front Month | ✅ 推薦使用 |\n| SLV | SLV ETF | iShares Silver Trust | ✅ 可用 |\n| GLD | GLD ETF | SPDR Gold Shares | ✅ 可用 |\n\n**注意事項**：\n- **2026-01 更新**：Yahoo Finance 的現貨代碼（XAGUSD=X, XAUUSD=X）已失效，改用期貨代碼（SI=F, GC=F）\n- 使用 `Close`（收盤價）\n- 週末與假日無數據\n- 期貨價格與現貨價格高度相關，適合用於背離分析\n\n## 交叉驗證數據源\n\n### COMEX 庫存\n\n**來源**：CME Group\n**URL**：https://www.cmegroup.com/clearing/operations-and-deliveries/nymex-delivery-notices.html\n\n**庫存類型**：\n| 類型 | 說明 |\n|------|------|\n| Registered | 已註冊可交割庫存 |\n| Eligible | 符合交割規格但未註冊 |\n| Total | Registered + Eligible |\n\n**抓取方式**：\n- 每日發布 stocks report\n- PDF 或 Excel 格式\n- 需要解析表格\n\n**替代來源**：\n- 第三方彙總網站（如 goldchartsrus.com）\n- 付費數據服務\n\n### LBMA 金庫存量\n\n**來源**：London Bullion Market Association\n**URL**：https://www.lbma.org.uk/prices-and-data/london-vault-holdings\n\n**可用數據**：\n- London Gold Holdings（每月）\n- London Silver Holdings（每月）\n\n**注意**：\n- 僅為 LBMA 成員金庫彙總\n- 不包含 ETF 專屬金庫\n- 發布延遲約 2 週\n\n### 期貨曲線結構\n\n**判斷方式**：比較近月與遠月期貨價格\n\n```python\ndef check_curve_structure(commodity):\n    \"\"\"\n    檢查期貨曲線結構\n    commodity: 'SI' for Silver, 'GC' for Gold\n    \"\"\"\n    import yfinance as yf\n\n    # 近月期貨\n    front = yf.Ticker(f\"{commodity}=F\")\n    front_price = front.history(period=\"1d\")[\"Close\"].iloc[-1]\n\n    # 需要動態計算下個月合約代碼\n    # 例如：SIH25.CME (2025年3月白銀期貨)\n\n    # 簡化：使用價差判斷\n    # backwardation: 近月 > 遠月\n    # contango: 近月 < 遠月\n```\n\n### 零售溢價指標\n\n**來源**：主要零售商網站\n- APMEX: https://www.apmex.com/\n- JM Bullion: https://www.jmbullion.com/\n- SD Bullion: https://sdbullion.com/\n\n**計算方式**：\n```\nPremium = (零售價格 - 現貨價格) / 現貨價格 × 100%\n```\n\n**正常水準**：\n| 商品 | 正常溢價 | 緊張時溢價 |\n|------|----------|------------|\n| 銀幣 (American Eagle) | 8-12% | 20-50% |\n| 銀條 (1 oz bar) | 3-5% | 10-20% |\n| 金幣 (American Eagle) | 5-8% | 10-15% |\n| 金條 (1 oz bar) | 2-4% | 5-10% |\n\n## 反偵測策略（Selenium 爬蟲）\n\n### User-Agent 輪換\n\n```python\nUSER_AGENTS = [\n    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',\n    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',\n    'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0',\n    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.1 Safari/605.1.15',\n]\n```\n\n### Chrome 選項配置\n\n```python\nfrom selenium.webdriver.chrome.options import Options\n\nchrome_options = Options()\nchrome_options.add_argument('--headless')\nchrome_options.add_argument('--no-sandbox')\nchrome_options.add_argument('--disable-dev-shm-usage')\nchrome_options.add_argument('--disable-blink-features=AutomationControlled')\nchrome_options.add_experimental_option('excludeSwitches', ['enable-automation'])\nchrome_options.add_experimental_option('useAutomationExtension', False)\n```\n\n### 隨機延遲\n\n```python\nimport random\nimport time\n\n# 請求前隨機延遲\ndelay = random.uniform(1.0, 3.0)\ntime.sleep(delay)\n```\n\n### 定時任務 Jitter\n\n```python\nfrom apscheduler.triggers.interval import IntervalTrigger\n\n# 每 24 小時執行，±30 分鐘隨機偏移\ntrigger = IntervalTrigger(hours=24, jitter=30*60)\n```\n\n## 數據對齊\n\n### 頻率對齊\n\n所有數據統一對齊到**日頻（D）**：\n- ETF 持倉：前向填充（ffill），因為不是每日更新\n- 價格數據：直接使用\n- 交易日對齊\n\n### 時區處理\n\n- 統一使用 **UTC** 或 **America/New_York**\n- ETF 持倉以美東時間為準\n- Yahoo Finance 價格以交易所時區為準\n\n### 缺值處理\n\n```python\n# ETF 持倉前向填充\ndf[\"holdings\"] = df[\"holdings\"].ffill()\n\n# 價格不填充，保留 NaN\n# 最後移除同時缺失的列\ndf = df.dropna(subset=[\"price\", \"holdings\"])\n```\n\n## 程式碼範例\n\n### 抓取 SLV 持倉（Selenium）\n\n```python\nfrom selenium import webdriver\nfrom selenium.webdriver.chrome.service import Service\nfrom selenium.webdriver.chrome.options import Options\nfrom selenium.webdriver.common.by import By\nfrom selenium.webdriver.support.ui import WebDriverWait\nfrom selenium.webdriver.support import expected_conditions as EC\nfrom webdriver_manager.chrome import ChromeDriverManager\nfrom bs4 import BeautifulSoup\nimport random\nimport time\n\ndef fetch_slv_holdings():\n    \"\"\"從 iShares 官網抓取 SLV 持倉\"\"\"\n    url = \"https://www.ishares.com/us/products/239855/ishares-silver-trust-fund\"\n\n    chrome_options = Options()\n    chrome_options.add_argument('--headless')\n    chrome_options.add_argument('--no-sandbox')\n    chrome_options.add_argument('--disable-blink-features=AutomationControlled')\n\n    user_agent = random.choice(USER_AGENTS)\n    chrome_options.add_argument(f'user-agent={user_agent}')\n\n    service = Service(ChromeDriverManager().install())\n    driver = webdriver.Chrome(service=service, options=chrome_options)\n\n    try:\n        # 隨機延遲\n        time.sleep(random.uniform(1.0, 2.0))\n\n        driver.get(url)\n\n        # 等待頁面載入\n        wait = WebDriverWait(driver, 20)\n        wait.until(EC.presence_of_element_located((By.CLASS_NAME, \"fund-header-content\")))\n\n        # 額外等待 JS 執行\n        time.sleep(3)\n\n        # 解析\n        soup = BeautifulSoup(driver.page_source, 'lxml')\n\n        # 提取持倉數據（選擇器需根據實際頁面調整）\n        # ...\n\n        return holdings_data\n\n    finally:\n        driver.quit()\n```\n",
        "skills/monitor-etf-holdings-drawdown-risk/references/input-schema.md": "# 輸入參數定義 (Input Schema)\n\n## 必要參數\n\n### etf_ticker\n\n| 屬性 | 值 |\n|------|---|\n| 類型 | string |\n| 必要 | 是 |\n| 說明 | 實物型 ETF/信託代碼 |\n| 範例 | \"SLV\", \"PSLV\", \"GLD\", \"PHYS\" |\n\n**支援的 ETF**：\n\n| 代碼 | 名稱 | 商品 | 官網 |\n|------|------|------|------|\n| SLV | iShares Silver Trust | 白銀 | ishares.com |\n| PSLV | Sprott Physical Silver Trust | 白銀 | sprott.com |\n| GLD | SPDR Gold Shares | 黃金 | spdrgoldshares.com |\n| PHYS | Sprott Physical Gold Trust | 黃金 | sprott.com |\n| IAU | iShares Gold Trust | 黃金 | ishares.com |\n| SIVR | Aberdeen Standard Physical Silver | 白銀 | abrdn.com |\n\n### commodity_price_symbol\n\n| 屬性 | 值 |\n|------|---|\n| 類型 | string |\n| 必要 | 是 |\n| 說明 | 商品現貨或近月期貨價格代碼 |\n| 範例 | \"XAGUSD=X\", \"XAUUSD=X\", \"SI=F\", \"GC=F\" |\n\n**建議配對**：\n\n| ETF | 建議價格代碼 | 說明 |\n|-----|-------------|------|\n| SLV, PSLV, SIVR | XAGUSD=X | 白銀現貨 |\n| SLV, PSLV, SIVR | SI=F | 白銀期貨近月 |\n| GLD, PHYS, IAU | XAUUSD=X | 黃金現貨 |\n| GLD, PHYS, IAU | GC=F | 黃金期貨近月 |\n\n## 可選參數\n\n### start_date\n\n| 屬性 | 值 |\n|------|---|\n| 類型 | string (ISO date) |\n| 必要 | 否 |\n| 預設 | 10 年前 |\n| 格式 | \"YYYY-MM-DD\" |\n| 範例 | \"2010-01-01\" |\n| 說明 | 分析起始日期 |\n\n### end_date\n\n| 屬性 | 值 |\n|------|---|\n| 類型 | string (ISO date) |\n| 必要 | 否 |\n| 預設 | 今天 |\n| 格式 | \"YYYY-MM-DD\" |\n| 範例 | \"2026-01-16\" |\n| 說明 | 分析結束日期 |\n\n### inventory_field\n\n| 屬性 | 值 |\n|------|---|\n| 類型 | string |\n| 必要 | 否 |\n| 預設 | \"auto\" |\n| 可選值 | \"auto\", \"silver_held_tonnes\", \"oz_held\", \"shares_outstanding\" |\n| 說明 | 庫存欄位名稱，auto 會自動偵測 |\n\n**欄位說明**：\n\n| 值 | 說明 |\n|---|------|\n| auto | 自動偵測，優先使用實物持倉量 |\n| silver_held_tonnes | 白銀持倉量（噸） |\n| oz_held | 持倉量（盎司） |\n| shares_outstanding | 流通股數（可換算為持倉量） |\n\n### decade_low_window_days\n\n| 屬性 | 值 |\n|------|---|\n| 類型 | int |\n| 必要 | 否 |\n| 預設 | 3650 |\n| 範圍 | 365 - 7300 |\n| 說明 | 計算歷史低點的滾動視窗天數 |\n\n**建議值**：\n- 3650（10 年）：標準設定\n- 1825（5 年）：較短期視角\n- 5475（15 年）：更長期視角\n\n### divergence_window_days\n\n| 屬性 | 值 |\n|------|---|\n| 類型 | int |\n| 必要 | 否 |\n| 預設 | 180 |\n| 範圍 | 30 - 365 |\n| 說明 | 計算背離的視窗天數 |\n\n**建議值**：\n- 30：短期監控\n- 90：季度視角\n- 180：半年視角（推薦）\n- 365：年度視角\n\n### min_price_return_pct\n\n| 屬性 | 值 |\n|------|---|\n| 類型 | float |\n| 必要 | 否 |\n| 預設 | 0.15 |\n| 範圍 | 0.05 - 0.50 |\n| 說明 | 視窗內價格上漲至少多少才算「上漲期」 |\n\n**建議值**：\n- 0.10（10%）：較敏感\n- 0.15（15%）：標準\n- 0.20（20%）：較保守\n\n### min_inventory_drawdown_pct\n\n| 屬性 | 值 |\n|------|---|\n| 類型 | float |\n| 必要 | 否 |\n| 預設 | 0.10 |\n| 範圍 | 0.05 - 0.30 |\n| 說明 | 視窗內庫存下滑至少多少才算「庫存被抽走」 |\n\n**建議值**：\n- 0.05（5%）：較敏感\n- 0.10（10%）：標準\n- 0.15（15%）：較保守\n\n### confirm_signals\n\n| 屬性 | 值 |\n|------|---|\n| 類型 | array[string] |\n| 必要 | 否 |\n| 預設 | [] |\n| 說明 | 交叉驗證訊號清單 |\n\n**可用訊號**：\n\n| 訊號 | 說明 | 數據來源 |\n|------|------|----------|\n| comex_inventory | COMEX 庫存變化 | CME Group |\n| lbma_vault | LBMA 金庫存量 | LBMA |\n| lease_rates | 借貸利率 | 需要付費數據 |\n| futures_backwardation | 期貨曲線結構 | Yahoo Finance |\n| retail_premiums | 零售溢價 | 零售商網站 |\n\n### output_format\n\n| 屬性 | 值 |\n|------|---|\n| 類型 | string |\n| 必要 | 否 |\n| 預設 | \"json\" |\n| 可選值 | \"json\", \"markdown\", \"csv\" |\n| 說明 | 輸出格式 |\n\n### output_file\n\n| 屬性 | 值 |\n|------|---|\n| 類型 | string |\n| 必要 | 否 |\n| 預設 | stdout |\n| 說明 | 輸出檔案路徑 |\n\n## 完整範例\n\n### 最簡配置\n\n```json\n{\n  \"etf_ticker\": \"SLV\",\n  \"commodity_price_symbol\": \"XAGUSD=X\"\n}\n```\n\n### 完整配置\n\n```json\n{\n  \"etf_ticker\": \"SLV\",\n  \"commodity_price_symbol\": \"XAGUSD=X\",\n  \"start_date\": \"2010-01-01\",\n  \"end_date\": \"2026-01-16\",\n  \"inventory_field\": \"auto\",\n  \"decade_low_window_days\": 3650,\n  \"divergence_window_days\": 180,\n  \"min_price_return_pct\": 0.15,\n  \"min_inventory_drawdown_pct\": 0.10,\n  \"confirm_signals\": [\n    \"comex_inventory\",\n    \"futures_backwardation\",\n    \"retail_premiums\"\n  ],\n  \"output_format\": \"json\",\n  \"output_file\": \"result.json\"\n}\n```\n\n### 命令列範例\n\n**快速檢查**：\n```bash\npython scripts/divergence_detector.py \\\n  --etf SLV \\\n  --commodity XAGUSD=X \\\n  --quick\n```\n\n**完整分析**：\n```bash\npython scripts/divergence_detector.py \\\n  --etf SLV \\\n  --commodity XAGUSD=X \\\n  --start 2010-01-01 \\\n  --end 2026-01-16 \\\n  --divergence-window 180 \\\n  --price-threshold 0.15 \\\n  --inventory-threshold 0.10 \\\n  --output result.json\n```\n\n**多 ETF 監控**：\n```bash\npython scripts/divergence_detector.py \\\n  --etf SLV,PSLV,GLD \\\n  --commodity XAGUSD=X,XAGUSD=X,XAUUSD=X \\\n  --quick \\\n  --output monitor_report.json\n```\n\n## 參數驗證\n\n腳本會自動驗證參數：\n\n1. **etf_ticker**：必須是支援的代碼\n2. **commodity_price_symbol**：必須是有效的 Yahoo Finance 代碼\n3. **日期範圍**：start_date 必須早於 end_date\n4. **百分比門檻**：必須在 0-1 之間\n5. **視窗天數**：必須為正整數\n\n無效參數會回傳錯誤訊息並列出可用選項。\n",
        "skills/monitor-etf-holdings-drawdown-risk/references/methodology.md": "### 什麼是「價格-庫存背離」？\n\n在正常市場中，商品價格與對應 ETF 持倉應該**同向變動**：\n- 價格上漲 → 投資人買入 ETF → ETF 購買實物 → 持倉增加\n- 價格下跌 → 投資人賣出 ETF → ETF 賣出實物 → 持倉減少\n\n當出現**逆向變動**時（價格上漲但持倉下降），稱為「背離」（Divergence）。\n\n### 背離的兩種解釋\n\n**解釋 A：實物供給緊張（Physical Tightness）**\n- 實物需求強勁，交易所/金庫存量被提取\n- ETF 無法及時補充持倉\n- 可能預示供需失衡\n\n**解釋 B：ETF 資金流/贖回（ETF Flow）**\n- 投資人資金外流，贖回 ETF 份額\n- ETF 被迫賣出實物\n- 不代表整體市場實物短缺\n\n**重要**：不能只看 ETF 持倉就下結論，需要交叉驗證。\n\n## 偵測邏輯\n\n### 背離事件定義\n\n```\nDivergence Event = True\n  IF price_return >= min_price_return_pct (如 +15%)\n  AND inventory_change <= -min_inventory_drawdown_pct (如 -10%)\n  WITHIN divergence_window_days (如 180 天)\n```\n\n### 視窗期選擇\n\n| 視窗長度 | 特性         | 適用場景           |\n|----------|--------------|--------------------|\n| 30 天    | 短期波動敏感 | 日常監控           |\n| 90 天    | 季度視角     | 趨勢確認           |\n| 180 天   | 半年視角     | 結構性判斷（推薦） |\n| 365 天   | 年度視角     | 長期結構           |\n\n### 門檻參數\n\n| 參數                       | 預設值 | 說明                         |\n|----------------------------|--------|------------------------------|\n| min_price_return_pct       | 15%    | 價格需上漲多少才算「上漲期」 |\n| min_inventory_drawdown_pct | 10%    | 庫存需下滑多少才算「被抽走」 |\n\n門檻過低會產生太多假訊號，過高可能錯過真實背離。\n\n## 嚴重度評估\n\n### 十年低點判定\n\n```python\ninventory_decade_low = inventory <= rolling_min(inventory, 3650 days) × 1.001\n```\n\n當庫存處於十年最低區間時，背離訊號更具意義。\n\n### 庫存/價格比值 Z 分數\n\n```python\nratio = inventory / price\nratio_z = (ratio - rolling_mean(ratio, 3650)) / rolling_std(ratio, 3650)\n```\n\n| ratio_z | 解讀                       |\n|---------|----------------------------|\n| > 2     | 極高：庫存相對價格非常充裕 |\n| 0 附近  | 正常                       |\n| < -2    | 極低：庫存相對價格非常緊張 |\n\n### 壓力分數計算\n\n```python\nstress_score = 100 × min(1.0,\n    0.6 × divergence_severity +      # 背離嚴重度 = price_return × (-inventory_change)\n    0.2 × decade_low_bonus +         # 1.0 if decade_low else 0.0\n    0.2 × ratio_extreme_bonus        # 1.0 if ratio_z < -2 else 0.0\n)\n```\n\n| 分數區間 | 等級 | 建議行動           |\n|----------|------|--------------------|\n| 0-30     | 正常 | 無需特別關注       |\n| 30-60    | 輕度 | 保持監控           |\n| 60-80    | 中度 | 建議交叉驗證       |\n| 80-100   | 重度 | 高度警戒，深入分析 |\n\n## 雙重假設驗證框架\n\n### Physical Tightness 假設\n\n**支持條件**：\n- COMEX registered/eligible 庫存同步下降\n- 期貨曲線從 contango 轉為 backwardation\n- 白銀/黃金 lease rates 上升\n- 零售銀條/銀幣溢價擴大\n- LBMA 金庫存量下降\n\n**如果多數條件成立**：較支持「實物緊張」解釋\n\n### ETF Flow 假設\n\n**支持條件**：\n- COMEX 庫存穩定或上升\n- 期貨曲線維持 contango\n- 零售溢價平穩\n- ETF 資金流數據顯示淨流出\n- 其他 ETF（如 PSLV）持倉不降\n\n**如果多數條件成立**：較支持「資金流動」解釋\n\n### 驗證矩陣\n\n| 指標        | Physical Tightness | ETF Flow    |\n|-------------|--------------------|-------------|\n| COMEX 庫存  | 下降 ↓             | 穩定/上升 ↑ |\n| 期貨曲線    | Backwardation      | Contango    |\n| Lease rates | 上升 ↑             | 穩定        |\n| 零售溢價    | 擴大 ↑             | 穩定        |\n| 其他 ETF    | 同步下降           | 不同步      |\n\n## 歷史案例\n\n### 2020-2021 白銀背離事件\n\n**背景**：\n- 2020 年 COVID 導致礦山停產，實物供給收縮\n- 2021 年 WallStreetBets 發起「白銀擠壓」運動\n\n**觀察**：\n- SLV 持倉在 2021 初大幅增加後，於下半年持續下滑\n- 同期銀價維持高位震盪\n- COMEX 庫存同步下降\n- 零售溢價一度飆升至 20%+\n\n**結論**：同時存在 Physical Tightness 和 ETF Flow 因素\n\n### 2022-2023 黃金背離事件\n\n**背景**：\n- 央行大量購金（尤其中國、俄羅斯）\n- 但西方 ETF 持續流出\n\n**觀察**：\n- GLD 持倉持續下滑\n- 金價在央行購買支撐下上漲\n- COMEX 庫存相對穩定\n\n**結論**：主要是 ETF Flow（西方資金流出），非實物短缺\n\n## 限制與注意事項\n\n### 數據品質\n\n1. **ETF 持倉延遲**：通常有 1-2 天延遲\n2. **庫存口徑差異**：不同來源的庫存定義可能不同\n3. **選擇器失效**：網站改版可能導致爬蟲失敗\n\n### 解讀偏誤\n\n1. **敘事先行**：不要先有結論再找數據\n2. **單一指標**：不要只看 ETF 持倉就下結論\n3. **過度解讀**：正常波動不等於「危機」\n\n### 模型限制\n\n1. **線性假設**：壓力分數的加權可能過度簡化\n2. **歷史依賴**：十年視窗假設歷史模式會重複\n3. **缺乏因果**：只能識別相關性，無法證明因果\n\n## 建議工作流程\n\n1. **初步篩選**：執行快速檢查，看是否有背離\n2. **嚴重度評估**：計算壓力分數，判斷是否需要關注\n3. **交叉驗證**：使用多指標驗證背離真實性\n4. **雙重假設**：同時考慮兩種解釋，不預設立場\n5. **持續監控**：設定警報，追蹤趨勢變化\n",
        "skills/monitor-etf-holdings-drawdown-risk/templates/output-json.md": "# JSON 輸出模板 (Output JSON Template)\n\n## 完整輸出結構\n\n```json\n{\n  \"skill\": \"monitor-etf-holdings-drawdown-risk\",\n  \"version\": \"0.1.0\",\n  \"asof\": \"2026-01-16\",\n\n  \"inputs\": {\n    \"etf_ticker\": \"SLV\",\n    \"commodity_price_symbol\": \"XAGUSD\",\n    \"divergence_window_days\": 180,\n    \"decade_low_window_days\": 3650,\n    \"min_price_return_pct\": 0.15,\n    \"min_inventory_drawdown_pct\": 0.10\n  },\n\n  \"result\": {\n    \"divergence\": true,\n    \"price_return_window\": 0.32,\n    \"inventory_change_window\": -0.18,\n    \"inventory_decade_low\": true,\n    \"inventory_to_price_ratio_z\": -2.4,\n    \"stress_score_0_100\": 78.5,\n    \"stress_level\": \"HIGH\"\n  },\n\n  \"latest_values\": {\n    \"price\": 32.45,\n    \"price_date\": \"2026-01-16\",\n    \"inventory_oz\": 456789012,\n    \"inventory_tonnes\": 14203.5,\n    \"inventory_date\": \"2026-01-15\",\n    \"ratio\": 14073589.2\n  },\n\n  \"historical_context\": {\n    \"inventory_decade_min\": 445000000,\n    \"inventory_decade_max\": 612000000,\n    \"inventory_percentile\": 8.5,\n    \"ratio_mean\": 18500000,\n    \"ratio_std\": 2100000\n  },\n\n  \"interpretations\": [\n    {\n      \"name\": \"Physical Tightness Hypothesis\",\n      \"when_supported\": \"若交易所/金庫庫存同步下降、期貨 backwardation 變強、lease rates 上升、零售溢價擴大\",\n      \"note\": \"這才比較接近社群敘事所說的「實物吃緊/被抽走」。\"\n    },\n    {\n      \"name\": \"ETF Flow / Redemption Hypothesis\",\n      \"when_supported\": \"若其他實物緊張指標不跟，較可能是投資人資金外流或贖回機制所致\",\n      \"note\": \"ETF 持倉下降不必然等同「銀行搶銀條」。\"\n    }\n  ],\n\n  \"cross_validation\": {\n    \"performed\": false,\n    \"signals_checked\": [],\n    \"physical_tightness_score\": null,\n    \"etf_flow_score\": null,\n    \"dominant_hypothesis\": null\n  },\n\n  \"next_checks\": [\n    \"核對 SLV 官方持倉時間序列是否真為 10 年低點（避免圖表來源/口徑問題）\",\n    \"交叉比對 COMEX registered/eligible 是否同步下降\",\n    \"檢查期貨曲線是否 backwardation 加劇\",\n    \"觀察零售銀條/銀幣 premium 是否擴大\"\n  ],\n\n  \"time_series\": {\n    \"available\": true,\n    \"file\": \"time_series.csv\",\n    \"columns\": [\n      \"date\",\n      \"price\",\n      \"inventory\",\n      \"price_return\",\n      \"inventory_change\",\n      \"ratio\",\n      \"ratio_z\",\n      \"divergence\"\n    ]\n  },\n\n  \"metadata\": {\n    \"generated_at\": \"2026-01-16T10:30:00Z\",\n    \"execution_time_ms\": 2345,\n    \"data_freshness\": {\n      \"price_data\": \"2026-01-16\",\n      \"inventory_data\": \"2026-01-15\"\n    },\n    \"warnings\": []\n  }\n}\n```\n\n## 欄位說明\n\n### result\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| divergence | boolean | 是否偵測到背離 |\n| price_return_window | float | 視窗期價格變化率 |\n| inventory_change_window | float | 視窗期庫存變化率 |\n| inventory_decade_low | boolean | 庫存是否處於十年低點 |\n| inventory_to_price_ratio_z | float | 庫存/價格比值 Z 分數 |\n| stress_score_0_100 | float | 壓力分數（0-100） |\n| stress_level | string | 壓力等級（LOW/MEDIUM/HIGH/CRITICAL） |\n\n### stress_level 定義\n\n| 等級 | 分數範圍 | 說明 |\n|------|----------|------|\n| LOW | 0-30 | 正常，無明顯背離 |\n| MEDIUM | 30-60 | 輕度背離，值得關注 |\n| HIGH | 60-80 | 中度背離，建議深入驗證 |\n| CRITICAL | 80-100 | 重度背離，高度警戒 |\n\n### latest_values\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| price | float | 最新價格 |\n| price_date | string | 價格日期 |\n| inventory_oz | int | 庫存（盎司） |\n| inventory_tonnes | float | 庫存（噸） |\n| inventory_date | string | 庫存日期 |\n| ratio | float | 庫存/價格比值 |\n\n### historical_context\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| inventory_decade_min | int | 十年最低庫存 |\n| inventory_decade_max | int | 十年最高庫存 |\n| inventory_percentile | float | 當前庫存百分位數 |\n| ratio_mean | float | 比值滾動平均 |\n| ratio_std | float | 比值滾動標準差 |\n\n### cross_validation（交叉驗證後填入）\n\n| 欄位 | 類型 | 說明 |\n|------|------|------|\n| performed | boolean | 是否執行交叉驗證 |\n| signals_checked | array | 已檢查的訊號清單 |\n| physical_tightness_score | float | 實物緊張假設支持度 |\n| etf_flow_score | float | ETF 資金流假設支持度 |\n| dominant_hypothesis | string | 主導假設 |\n\n## 精簡輸出（--quick 模式）\n\n```json\n{\n  \"skill\": \"monitor-etf-holdings-drawdown-risk\",\n  \"asof\": \"2026-01-16\",\n  \"etf_ticker\": \"SLV\",\n  \"result\": {\n    \"divergence\": true,\n    \"price_return_window\": 0.32,\n    \"inventory_change_window\": -0.18,\n    \"inventory_decade_low\": true,\n    \"stress_score_0_100\": 78.5\n  },\n  \"next_checks\": [\n    \"核對 SLV 官方持倉時間序列是否真為 10 年低點\",\n    \"交叉比對 COMEX registered/eligible 是否同步下降\"\n  ]\n}\n```\n\n## 監控模式輸出\n\n```json\n{\n  \"skill\": \"monitor-etf-holdings-drawdown-risk\",\n  \"mode\": \"monitor\",\n  \"timestamp\": \"2026-01-16T10:30:00Z\",\n\n  \"summary\": {\n    \"total_monitored\": 4,\n    \"critical_alerts\": 1,\n    \"warning_alerts\": 1,\n    \"normal\": 2\n  },\n\n  \"alerts\": [\n    {\n      \"etf\": \"SLV\",\n      \"level\": \"CRITICAL\",\n      \"stress_score\": 78.5,\n      \"divergence\": true,\n      \"message\": \"iShares Silver Trust: stress=78.5, divergence=true\"\n    },\n    {\n      \"etf\": \"PSLV\",\n      \"level\": \"WARNING\",\n      \"stress_score\": 52.3,\n      \"divergence\": true,\n      \"message\": \"Sprott Physical Silver: stress=52.3, divergence=true\"\n    }\n  ],\n\n  \"details\": [\n    {\n      \"etf_ticker\": \"SLV\",\n      \"stress_score_0_100\": 78.5,\n      \"divergence\": true\n    },\n    {\n      \"etf_ticker\": \"PSLV\",\n      \"stress_score_0_100\": 52.3,\n      \"divergence\": true\n    },\n    {\n      \"etf_ticker\": \"GLD\",\n      \"stress_score_0_100\": 15.2,\n      \"divergence\": false\n    },\n    {\n      \"etf_ticker\": \"PHYS\",\n      \"stress_score_0_100\": 12.8,\n      \"divergence\": false\n    }\n  ]\n}\n```\n\n## 錯誤輸出\n\n```json\n{\n  \"skill\": \"monitor-etf-holdings-drawdown-risk\",\n  \"error\": true,\n  \"error_code\": \"DATA_FETCH_FAILED\",\n  \"error_message\": \"無法抓取 SLV 持倉數據：選擇器失效，請檢查網站結構\",\n  \"suggestions\": [\n    \"確認 iShares 官網是否可正常訪問\",\n    \"檢查 Selenium 爬蟲選擇器是否需要更新\",\n    \"嘗試使用替代數據源\"\n  ],\n  \"metadata\": {\n    \"generated_at\": \"2026-01-16T10:30:00Z\",\n    \"failed_at_step\": \"fetch_etf_holdings\"\n  }\n}\n```\n",
        "skills/monitor-etf-holdings-drawdown-risk/templates/output-markdown.md": "# Markdown 輸出模板 (Output Markdown Template)\n\n## 完整報告模板\n\n```markdown\n# {ETF_TICKER} 價格-庫存背離分析報告\n\n**生成時間**：{GENERATED_AT}\n**分析期間**：{START_DATE} 至 {END_DATE}\n\n---\n\n## 摘要\n\n| 指標 | 數值 | 狀態 |\n|------|------|------|\n| 背離判定 | {DIVERGENCE} | {DIVERGENCE_STATUS} |\n| {WINDOW_DAYS} 日價格變化 | {PRICE_RETURN_PCT}% | {PRICE_DIRECTION} |\n| {WINDOW_DAYS} 日庫存變化 | {INVENTORY_CHANGE_PCT}% | {INVENTORY_DIRECTION} |\n| 庫存十年低點 | {DECADE_LOW} | {DECADE_LOW_STATUS} |\n| 庫存/價格比值 Z | {RATIO_Z} | {RATIO_Z_STATUS} |\n| **壓力分數** | **{STRESS_SCORE}/100** | **{STRESS_LEVEL}** |\n\n---\n\n## 背離狀態詳情\n\n### 價格與庫存\n\n| 項目 | 最新值 | 日期 |\n|------|--------|------|\n| {COMMODITY} 價格 | ${PRICE} | {PRICE_DATE} |\n| {ETF_TICKER} 持倉 | {INVENTORY_OZ:,} oz | {INVENTORY_DATE} |\n| 持倉（噸） | {INVENTORY_TONNES:.1f} tonnes | - |\n\n### 歷史背景\n\n| 項目 | 數值 |\n|------|------|\n| 十年最低庫存 | {DECADE_MIN:,} oz |\n| 十年最高庫存 | {DECADE_MAX:,} oz |\n| 當前百分位數 | {PERCENTILE:.1f}% |\n\n---\n\n## 壓力分數計算\n\n```\nstress_score = 100 × min(1.0,\n    0.6 × {DIVERGENCE_SEVERITY:.3f} +    # 背離嚴重度\n    0.2 × {DECADE_LOW_BONUS:.1f} +       # 十年低點加成\n    0.2 × {RATIO_EXTREME_BONUS:.1f}      # 比值極端加成\n)\n= {STRESS_SCORE:.1f}\n```\n\n| 分數區間 | 等級 | 當前 |\n|----------|------|------|\n| 0-30 | 正常 | {LEVEL_LOW} |\n| 30-60 | 輕度 | {LEVEL_MEDIUM} |\n| 60-80 | 中度 | {LEVEL_HIGH} |\n| 80-100 | 重度 | {LEVEL_CRITICAL} |\n\n---\n\n## 雙重假設解釋\n\n### 假設 A：實物緊張 (Physical Tightness)\n\n**支持條件**：\n- 交易所/金庫庫存同步下降\n- 期貨 backwardation 變強\n- Lease rates 上升\n- 零售溢價擴大\n\n**解讀**：這才比較接近社群敘事所說的「實物吃緊/被抽走」。\n\n### 假設 B：ETF 資金流 (ETF Flow / Redemption)\n\n**支持條件**：\n- 其他實物緊張指標不跟\n- 期貨結構平穩\n- 零售溢價穩定\n\n**解讀**：ETF 持倉下降不必然等同「銀行搶銀條」，可能是投資人資金外流。\n\n---\n\n## 下一步驗證建議\n\n1. {NEXT_CHECK_1}\n2. {NEXT_CHECK_2}\n3. {NEXT_CHECK_3}\n4. {NEXT_CHECK_4}\n\n---\n\n## 附錄：數據來源\n\n| 數據 | 來源 | 更新頻率 |\n|------|------|----------|\n| 價格 | Yahoo Finance | 即時 |\n| ETF 持倉 | {ETF_ISSUER} 官網 | 每日 |\n| 交叉驗證 | 各交易所/公開數據 | 不定 |\n\n---\n\n*本報告由 monitor-etf-holdings-drawdown-risk skill 自動生成*\n*僅供參考，不構成投資建議*\n```\n\n## 簡化報告模板（快速檢查）\n\n```markdown\n# {ETF_TICKER} 背離快速檢查\n\n**截至**：{ASOF}\n\n## 結果\n\n| 指標 | 數值 |\n|------|------|\n| 背離 | {DIVERGENCE_EMOJI} {DIVERGENCE} |\n| 壓力分數 | {STRESS_SCORE}/100 ({STRESS_LEVEL}) |\n| 價格變化 | {PRICE_RETURN_PCT:+.1f}% |\n| 庫存變化 | {INVENTORY_CHANGE_PCT:+.1f}% |\n| 十年低點 | {DECADE_LOW_EMOJI} {DECADE_LOW} |\n\n## 建議\n\n{RECOMMENDATION}\n\n## 下一步\n\n- {NEXT_CHECK_1}\n- {NEXT_CHECK_2}\n```\n\n## 監控報告模板\n\n```markdown\n# ETF 持倉背離監控報告\n\n**時間**：{TIMESTAMP}\n\n## 警報摘要\n\n| 等級 | 數量 |\n|------|------|\n| 嚴重 (CRITICAL) | {CRITICAL_COUNT} |\n| 警告 (WARNING) | {WARNING_COUNT} |\n| 正常 (NORMAL) | {NORMAL_COUNT} |\n\n## 警報詳情\n\n{#each ALERTS}\n### {ALERT_EMOJI} {ETF_NAME} ({ETF_TICKER})\n\n- **等級**：{ALERT_LEVEL}\n- **壓力分數**：{STRESS_SCORE}/100\n- **背離**：{DIVERGENCE}\n\n{/each}\n\n## 所有監控 ETF\n\n| ETF | 壓力分數 | 背離 | 狀態 |\n|-----|----------|------|------|\n{#each DETAILS}\n| {ETF_TICKER} | {STRESS_SCORE} | {DIVERGENCE} | {STATUS_EMOJI} |\n{/each}\n\n---\n\n*下次檢查：{NEXT_CHECK_TIME}*\n```\n\n## 占位符說明\n\n| 占位符 | 類型 | 說明 |\n|--------|------|------|\n| {ETF_TICKER} | string | ETF 代碼 |\n| {COMMODITY} | string | 商品名稱 |\n| {DIVERGENCE} | boolean | 背離判定 |\n| {DIVERGENCE_EMOJI} | string | 背離表情符號（true: ⚠️, false: ✅） |\n| {PRICE_RETURN_PCT} | float | 價格變化百分比 |\n| {INVENTORY_CHANGE_PCT} | float | 庫存變化百分比 |\n| {STRESS_SCORE} | float | 壓力分數 |\n| {STRESS_LEVEL} | string | 壓力等級 |\n| {DECADE_LOW} | boolean | 十年低點判定 |\n| {DECADE_LOW_EMOJI} | string | 十年低點表情符號 |\n| {RATIO_Z} | float | 比值 Z 分數 |\n| {NEXT_CHECK_N} | string | 下一步驗證建議 |\n\n## 表情符號對照\n\n| 狀態 | 表情符號 |\n|------|----------|\n| 背離成立 | ⚠️ |\n| 無背離 | ✅ |\n| 十年低點 | 📉 |\n| 非十年低點 | ➖ |\n| 壓力：LOW | 🟢 |\n| 壓力：MEDIUM | 🟡 |\n| 壓力：HIGH | 🟠 |\n| 壓力：CRITICAL | 🔴 |\n",
        "skills/monitor-etf-holdings-drawdown-risk/workflows/analyze.md": "# Workflow: 完整背離分析\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/input-schema.md - 完整參數定義\n2. references/methodology.md - 背離偵測方法論\n3. references/data-sources.md - 數據來源與抓取方式\n</required_reading>\n\n<process>\n\n## Step 1: 確認參數\n\n檢查用戶提供的參數，補充預設值：\n\n```python\nparams = {\n    \"etf_ticker\": \"SLV\",              # ETF 代碼（必填）\n    \"commodity_price_symbol\": \"XAGUSD\",  # 商品價格代碼（必填）\n    \"start_date\": None,               # 預設 10 年前\n    \"end_date\": \"today\",              # 分析結束日\n    \"inventory_field\": \"auto\",        # 庫存欄位（自動偵測）\n    \"decade_low_window_days\": 3650,   # 十年低點視窗\n    \"divergence_window_days\": 180,    # 背離計算視窗\n    \"min_price_return_pct\": 0.15,     # 價格上漲門檻\n    \"min_inventory_drawdown_pct\": 0.10,  # 庫存下滑門檻\n}\n```\n\n若用戶有指定參數，覆蓋上述預設值。\n\n## Step 2: 抓取價格數據\n\n使用 `scripts/fetch_prices.py` 抓取商品價格：\n\n```bash\npython scripts/fetch_prices.py \\\n  --symbol {commodity_price_symbol} \\\n  --start {start_date} \\\n  --end {end_date} \\\n  --output prices.csv\n```\n\n或使用 Python API：\n\n```python\nfrom scripts.fetch_prices import fetch_price_series\n\nprice = fetch_price_series(\n    symbol=params[\"commodity_price_symbol\"],\n    start_date=params[\"start_date\"],\n    end_date=params[\"end_date\"]\n)\n```\n\n## Step 3: 抓取 ETF 庫存數據\n\n使用 `scripts/fetch_etf_holdings.py` 抓取 ETF 持倉：\n\n```bash\npython scripts/fetch_etf_holdings.py \\\n  --etf {etf_ticker} \\\n  --start {start_date} \\\n  --end {end_date} \\\n  --output holdings.csv\n```\n\n**注意**：此腳本使用 Selenium 模擬瀏覽器行為，需要：\n- Chrome 瀏覽器已安裝\n- webdriver-manager 自動管理 ChromeDriver\n- 隨機延遲與 User-Agent 輪換（防偵測）\n\n或使用 Python API：\n\n```python\nfrom scripts.fetch_etf_holdings import fetch_etf_inventory_series\n\ninventory = fetch_etf_inventory_series(\n    etf_ticker=params[\"etf_ticker\"],\n    start_date=params[\"start_date\"],\n    end_date=params[\"end_date\"]\n)\n```\n\n## Step 4: 對齊與清洗數據\n\n```python\nimport pandas as pd\n\n# 合併價格與庫存\ndf = pd.concat({\"price\": price, \"inv\": inventory}, axis=1).sort_index()\n\n# 庫存前向填充（庫存不是每日更新）\ndf[\"inv\"] = df[\"inv\"].ffill()\n\n# 移除缺失值\ndf = df.dropna(subset=[\"price\", \"inv\"])\n```\n\n## Step 5: 計算背離特徵\n\n```python\nw = params[\"divergence_window_days\"]\n\n# 視窗期變化率\ndf[\"price_ret\"] = df[\"price\"].pct_change(w)\ndf[\"inv_chg\"] = df[\"inv\"].pct_change(w)\n\n# 十年低點判定\ndf[\"inv_decade_min\"] = df[\"inv\"].rolling(\n    params[\"decade_low_window_days\"],\n    min_periods=252\n).min()\ndf[\"decade_low_flag\"] = df[\"inv\"] <= df[\"inv_decade_min\"] * 1.001\n\n# 庫存/價格比值 Z 分數\ndf[\"ratio\"] = df[\"inv\"] / df[\"price\"]\nratio_mean = df[\"ratio\"].rolling(params[\"decade_low_window_days\"], min_periods=252).mean()\nratio_std = df[\"ratio\"].rolling(params[\"decade_low_window_days\"], min_periods=252).std()\ndf[\"ratio_z\"] = (df[\"ratio\"] - ratio_mean) / ratio_std\n\n# 背離判定\ndf[\"divergence\"] = (\n    (df[\"price_ret\"] >= params[\"min_price_return_pct\"]) &\n    (df[\"inv_chg\"] <= -params[\"min_inventory_drawdown_pct\"])\n)\n```\n\n## Step 6: 計算壓力分數\n\n```python\nlatest = df.iloc[-1]\n\n# 背離嚴重度\ndivergence_severity = max(0, latest[\"price_ret\"]) * max(0, -latest[\"inv_chg\"])\n\n# 十年低點加成\ndecade_low_bonus = 1.0 if latest[\"decade_low_flag\"] else 0.0\n\n# 比值極端加成\nratio_extreme_bonus = 1.0 if latest[\"ratio_z\"] < -2 else 0.0\n\n# 壓力分數\nstress_score = 100 * min(1.0,\n    0.6 * divergence_severity +\n    0.2 * decade_low_bonus +\n    0.2 * ratio_extreme_bonus\n)\n```\n\n## Step 7: 產生雙重假設解釋\n\n根據背離狀態產生兩種對立假設：\n\n```python\ninterpretations = [\n    {\n        \"name\": \"Physical Tightness Hypothesis\",\n        \"when_supported\": \"若交易所/金庫庫存同步下降、期貨 backwardation 變強、lease rates 上升、零售溢價擴大\",\n        \"note\": \"這才比較接近社群敘事所說的「實物吃緊/被抽走」。\"\n    },\n    {\n        \"name\": \"ETF Flow / Redemption Hypothesis\",\n        \"when_supported\": \"若其他實物緊張指標不跟，較可能是投資人資金外流或贖回機制所致\",\n        \"note\": \"ETF 持倉下降不必然等同「銀行搶銀條」。\"\n    }\n]\n```\n\n## Step 8: 產生下一步檢查建議\n\n```python\nnext_checks = [\n    f\"拉 {params['etf_ticker']} 官方 holdings/bar list 歷史，確認是否真為十年低點\",\n    \"比對 COMEX registered/eligible 是否同步下降\",\n    \"檢查期貨曲線是否 backwardation 加劇\",\n    \"觀察零售銀條/銀幣 premium 是否擴大\"\n]\n```\n\n## Step 9: 輸出結果\n\n依據 `output_format` 參數產出結果：\n\n- JSON 格式：參考 `templates/output-json.md`\n- Markdown 格式：參考 `templates/output-markdown.md`\n\n```bash\npython scripts/divergence_detector.py \\\n  --etf {etf_ticker} \\\n  --commodity {commodity_price_symbol} \\\n  --start {start_date} \\\n  --end {end_date} \\\n  --output result.json\n```\n\n## Step 10: 生成視覺化報告（可選）\n\n使用 `visualize_divergence.py` 生成完整的圖表報告：\n\n```bash\npython scripts/visualize_divergence.py \\\n  --result result.json \\\n  --output ../../../output/\n```\n\n**輸出內容**：\n- PNG 圖表（高解析度 300 DPI）\n- PDF 報告\n- 包含：價格-庫存時間序列、壓力分數儀表盤、關鍵指標表格\n\n**檔名格式**：`{ETF}_divergence_report_{YYYYMMDD}.png`\n\n</process>\n\n<success_criteria>\n分析完成時應產出：\n\n- [ ] 背離狀態判定（divergence: true/false）\n- [ ] 價格變化率與庫存變化率\n- [ ] 十年低點判定\n- [ ] 庫存/價格比值 Z 分數\n- [ ] 壓力分數（0-100）\n- [ ] 兩種對立假設解釋\n- [ ] 下一步驗證建議清單\n- [ ] 結果輸出為指定格式\n- [ ] **視覺化報告**（PNG + PDF）\n</success_criteria>\n",
        "skills/monitor-etf-holdings-drawdown-risk/workflows/cross-validate.md": "# Workflow: 交叉驗證背離訊號\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/methodology.md - 雙重假設驗證框架\n2. references/data-sources.md - 交叉驗證數據來源\n</required_reading>\n\n<process>\n\n## Step 1: 確認需要驗證的背離訊號\n\n確認已有背離分析結果：\n\n```python\n# 假設已執行 analyze.md 工作流\n# 或直接讀取先前的分析結果\nimport json\n\nwith open(\"result.json\") as f:\n    divergence_result = json.load(f)\n\n# 確認存在背離\nif not divergence_result.get(\"divergence\"):\n    print(\"未偵測到背離，無需交叉驗證\")\n    exit()\n```\n\n## Step 2: 定義驗證指標\n\n```python\nvalidation_signals = {\n    \"supports_physical_tightness\": [\n        {\n            \"name\": \"comex_inventory\",\n            \"description\": \"COMEX registered/eligible 庫存下降\",\n            \"weight\": 0.25\n        },\n        {\n            \"name\": \"futures_backwardation\",\n            \"description\": \"期貨曲線從 contango 轉為 backwardation\",\n            \"weight\": 0.25\n        },\n        {\n            \"name\": \"lease_rates\",\n            \"description\": \"白銀/黃金 lease rates 上升\",\n            \"weight\": 0.20\n        },\n        {\n            \"name\": \"retail_premiums\",\n            \"description\": \"零售銀條/銀幣溢價擴大\",\n            \"weight\": 0.15\n        },\n        {\n            \"name\": \"lbma_vault\",\n            \"description\": \"LBMA 金庫存量下降\",\n            \"weight\": 0.15\n        }\n    ],\n    \"supports_etf_flow\": [\n        {\n            \"name\": \"comex_stable\",\n            \"description\": \"COMEX 庫存穩定或上升\",\n            \"weight\": 0.25\n        },\n        {\n            \"name\": \"futures_contango\",\n            \"description\": \"期貨曲線維持 contango\",\n            \"weight\": 0.25\n        },\n        {\n            \"name\": \"retail_premiums_stable\",\n            \"description\": \"零售溢價平穩\",\n            \"weight\": 0.25\n        },\n        {\n            \"name\": \"fund_flows_negative\",\n            \"description\": \"ETF 資金流數據顯示淨流出\",\n            \"weight\": 0.25\n        }\n    ]\n}\n```\n\n## Step 3: 檢查 COMEX 庫存\n\n抓取 COMEX registered/eligible 庫存數據：\n\n```python\n# COMEX 庫存數據通常需要從 CME 網站抓取\n# 或使用第三方彙總數據\n\ndef check_comex_inventory():\n    \"\"\"\n    檢查 COMEX 白銀/黃金庫存變化\n    返回：'declining', 'stable', 'increasing'\n    \"\"\"\n    # 實作：抓取 COMEX daily stocks report\n    # https://www.cmegroup.com/clearing/operations-and-deliveries/nymex-delivery-notices.html\n\n    # 簡化範例：手動輸入或抓取\n    comex_change = -0.05  # 假設下降 5%\n\n    if comex_change < -0.03:\n        return \"declining\"\n    elif comex_change > 0.03:\n        return \"increasing\"\n    else:\n        return \"stable\"\n```\n\n## Step 4: 檢查期貨曲線結構\n\n```python\nimport yfinance as yf\n\ndef check_futures_curve(commodity=\"SI\"):\n    \"\"\"\n    檢查期貨曲線是 contango 還是 backwardation\n    SI = 白銀, GC = 黃金\n    \"\"\"\n    # 抓取近月與遠月期貨\n    front_month = yf.Ticker(f\"{commodity}=F\")\n    back_month = yf.Ticker(f\"{commodity}H25.CME\")  # 需要動態計算\n\n    front_price = front_month.history(period=\"1d\")[\"Close\"].iloc[-1]\n    back_price = back_month.history(period=\"1d\")[\"Close\"].iloc[-1]\n\n    spread = (back_price - front_price) / front_price\n\n    if spread < -0.005:  # 遠月低於近月超過 0.5%\n        return \"backwardation\"\n    elif spread > 0.005:\n        return \"contango\"\n    else:\n        return \"flat\"\n```\n\n## Step 5: 檢查零售溢價\n\n```python\ndef check_retail_premiums():\n    \"\"\"\n    檢查零售銀條/銀幣相對現貨的溢價\n    通常需要從 APMEX、JM Bullion 等零售商抓取\n    \"\"\"\n    # 簡化範例：使用固定值或手動輸入\n    # 正常溢價約 3-5%，緊張時可達 10-20%\n\n    current_premium = 0.08  # 假設 8%\n    normal_premium = 0.05   # 正常水準 5%\n\n    if current_premium > normal_premium * 1.5:\n        return \"elevated\"\n    else:\n        return \"normal\"\n```\n\n## Step 6: 計算驗證分數\n\n```python\ndef calculate_validation_scores(signals_status):\n    \"\"\"\n    計算兩種假設的支持度\n    \"\"\"\n    physical_score = 0\n    etf_flow_score = 0\n\n    # Physical Tightness 假設\n    for signal in validation_signals[\"supports_physical_tightness\"]:\n        status = signals_status.get(signal[\"name\"])\n        if status == \"supports\":\n            physical_score += signal[\"weight\"]\n\n    # ETF Flow 假設\n    for signal in validation_signals[\"supports_etf_flow\"]:\n        status = signals_status.get(signal[\"name\"])\n        if status == \"supports\":\n            etf_flow_score += signal[\"weight\"]\n\n    return {\n        \"physical_tightness_score\": physical_score,\n        \"etf_flow_score\": etf_flow_score,\n        \"dominant_hypothesis\": \"physical_tightness\" if physical_score > etf_flow_score else \"etf_flow\"\n    }\n```\n\n## Step 7: 執行完整驗證\n\n```python\n# 收集所有訊號狀態\nsignals_status = {}\n\n# COMEX 庫存\ncomex = check_comex_inventory()\nif comex == \"declining\":\n    signals_status[\"comex_inventory\"] = \"supports\"\n    signals_status[\"comex_stable\"] = \"contradicts\"\nelif comex == \"stable\":\n    signals_status[\"comex_inventory\"] = \"contradicts\"\n    signals_status[\"comex_stable\"] = \"supports\"\n\n# 期貨曲線\ncurve = check_futures_curve()\nif curve == \"backwardation\":\n    signals_status[\"futures_backwardation\"] = \"supports\"\n    signals_status[\"futures_contango\"] = \"contradicts\"\nelif curve == \"contango\":\n    signals_status[\"futures_backwardation\"] = \"contradicts\"\n    signals_status[\"futures_contango\"] = \"supports\"\n\n# 零售溢價\npremium = check_retail_premiums()\nif premium == \"elevated\":\n    signals_status[\"retail_premiums\"] = \"supports\"\n    signals_status[\"retail_premiums_stable\"] = \"contradicts\"\nelse:\n    signals_status[\"retail_premiums\"] = \"contradicts\"\n    signals_status[\"retail_premiums_stable\"] = \"supports\"\n\n# 計算分數\nvalidation_result = calculate_validation_scores(signals_status)\n```\n\n## Step 8: 產出驗證報告\n\n```python\ncross_validation_report = {\n    \"original_divergence\": divergence_result,\n    \"validation_signals\": signals_status,\n    \"scores\": validation_result,\n    \"conclusion\": {\n        \"dominant_hypothesis\": validation_result[\"dominant_hypothesis\"],\n        \"confidence\": max(\n            validation_result[\"physical_tightness_score\"],\n            validation_result[\"etf_flow_score\"]\n        ),\n        \"recommendation\": get_recommendation(validation_result)\n    }\n}\n\ndef get_recommendation(result):\n    if result[\"physical_tightness_score\"] > 0.6:\n        return \"多重指標支持實物緊張假設，建議密切關注供需動態\"\n    elif result[\"etf_flow_score\"] > 0.6:\n        return \"較可能是 ETF 資金流動所致，非實物短缺\"\n    else:\n        return \"訊號混合，建議繼續監控等待更多數據\"\n```\n\n</process>\n\n<success_criteria>\n交叉驗證完成時應產出：\n\n- [ ] 已檢查 COMEX 庫存狀態\n- [ ] 已檢查期貨曲線結構\n- [ ] 已檢查零售溢價水準\n- [ ] 計算兩種假設的支持分數\n- [ ] 判定主導假設\n- [ ] 提供信心水準與建議\n- [ ] 產出完整驗證報告\n</success_criteria>\n",
        "skills/monitor-etf-holdings-drawdown-risk/workflows/monitor.md": "# Workflow: 持續監控模式\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/input-schema.md - 完整參數定義\n2. references/data-sources.md - 數據來源與抓取方式\n</required_reading>\n\n<process>\n\n## Step 1: 配置監控參數\n\n設定監控的 ETF 清單與警報門檻：\n\n```python\nmonitor_config = {\n    \"etfs\": [\n        {\"ticker\": \"SLV\", \"commodity\": \"XAGUSD\", \"name\": \"iShares Silver Trust\"},\n        {\"ticker\": \"PSLV\", \"commodity\": \"XAGUSD\", \"name\": \"Sprott Physical Silver\"},\n        {\"ticker\": \"GLD\", \"commodity\": \"XAUUSD\", \"name\": \"SPDR Gold Shares\"},\n        {\"ticker\": \"PHYS\", \"commodity\": \"XAUUSD\", \"name\": \"Sprott Physical Gold\"}\n    ],\n    \"alert_thresholds\": {\n        \"stress_score_warning\": 50,    # 警告門檻\n        \"stress_score_critical\": 75,   # 嚴重門檻\n        \"divergence_trigger\": True      # 背離觸發警報\n    },\n    \"check_interval_hours\": 24,        # 檢查間隔（小時）\n    \"output_dir\": \"output/monitor/\"\n}\n```\n\n## Step 2: 執行單次監控檢查\n\n對每個 ETF 執行快速檢查：\n\n```bash\npython scripts/divergence_detector.py \\\n  --etf SLV --commodity XAGUSD --quick \\\n  --output output/monitor/SLV_latest.json\n\npython scripts/divergence_detector.py \\\n  --etf PSLV --commodity XAGUSD --quick \\\n  --output output/monitor/PSLV_latest.json\n\npython scripts/divergence_detector.py \\\n  --etf GLD --commodity XAUUSD --quick \\\n  --output output/monitor/GLD_latest.json\n```\n\n## Step 3: 彙總監控結果\n\n```python\nimport json\nfrom pathlib import Path\n\nresults = []\nfor etf in monitor_config[\"etfs\"]:\n    result_file = Path(f\"output/monitor/{etf['ticker']}_latest.json\")\n    if result_file.exists():\n        with open(result_file) as f:\n            result = json.load(f)\n            result[\"etf_name\"] = etf[\"name\"]\n            results.append(result)\n```\n\n## Step 4: 判定警報等級\n\n```python\ndef get_alert_level(result, thresholds):\n    stress = result.get(\"stress_score_0_100\", 0)\n    divergence = result.get(\"divergence\", False)\n\n    if stress >= thresholds[\"stress_score_critical\"]:\n        return \"CRITICAL\"\n    elif stress >= thresholds[\"stress_score_warning\"] or divergence:\n        return \"WARNING\"\n    else:\n        return \"NORMAL\"\n\nalerts = []\nfor result in results:\n    level = get_alert_level(result, monitor_config[\"alert_thresholds\"])\n    if level != \"NORMAL\":\n        alerts.append({\n            \"etf\": result.get(\"etf_ticker\"),\n            \"level\": level,\n            \"stress_score\": result.get(\"stress_score_0_100\"),\n            \"divergence\": result.get(\"divergence\"),\n            \"message\": f\"{result['etf_name']}: stress={result.get('stress_score_0_100'):.1f}, divergence={result.get('divergence')}\"\n        })\n```\n\n## Step 5: 產出監控報告\n\n```python\nreport = {\n    \"timestamp\": datetime.now().isoformat(),\n    \"summary\": {\n        \"total_monitored\": len(results),\n        \"critical_alerts\": len([a for a in alerts if a[\"level\"] == \"CRITICAL\"]),\n        \"warning_alerts\": len([a for a in alerts if a[\"level\"] == \"WARNING\"]),\n        \"normal\": len(results) - len(alerts)\n    },\n    \"alerts\": alerts,\n    \"details\": results\n}\n\n# 輸出報告\nwith open(\"output/monitor/report.json\", \"w\") as f:\n    json.dump(report, f, indent=2)\n```\n\n## Step 6: 設定定時任務（可選）\n\n使用 APScheduler 設定定時檢查：\n\n```python\nfrom apscheduler.schedulers.blocking import BlockingScheduler\nfrom apscheduler.triggers.interval import IntervalTrigger\nimport random\n\nscheduler = BlockingScheduler()\n\ndef run_monitor_check():\n    # 隨機延遲 0-15 分鐘（避免固定時間爬取）\n    jitter = random.uniform(0, 15 * 60)\n    time.sleep(jitter)\n\n    # 執行監控檢查\n    check_all_etfs()\n\nscheduler.add_job(\n    run_monitor_check,\n    trigger=IntervalTrigger(hours=monitor_config[\"check_interval_hours\"]),\n    id='etf_monitor'\n)\n\nscheduler.start()\n```\n\n**注意**：定時任務需要額外安裝 `apscheduler`：\n```bash\npip install apscheduler\n```\n\n## Step 7: 歷史趨勢追蹤（可選）\n\n記錄每次檢查結果以追蹤趨勢：\n\n```python\nimport csv\nfrom datetime import datetime\n\ndef log_check_result(result):\n    log_file = f\"output/monitor/{result['etf_ticker']}_history.csv\"\n\n    with open(log_file, \"a\", newline=\"\") as f:\n        writer = csv.writer(f)\n        writer.writerow([\n            datetime.now().isoformat(),\n            result.get(\"stress_score_0_100\"),\n            result.get(\"divergence\"),\n            result.get(\"price_return_window\"),\n            result.get(\"inventory_change_window\"),\n            result.get(\"inventory_decade_low\")\n        ])\n```\n\n</process>\n\n<success_criteria>\n監控設定完成時應：\n\n- [ ] 配置監控 ETF 清單\n- [ ] 設定警報門檻\n- [ ] 執行單次監控檢查\n- [ ] 產出彙總報告\n- [ ] 識別需要關注的警報\n- [ ] （可選）設定定時任務\n- [ ] （可選）記錄歷史趨勢\n</success_criteria>\n",
        "skills/nickel-concentration-risk-analyzer/README.md": "# Nickel Concentration Risk Analyzer\n\n全球鎳供給集中度分析工具，量化各國主導程度（特別是印尼）、集中度指標演進、以及政策變動對全球供給的潛在衝擊。\n\n## 核心功能\n\n### 1. 供給集中度分析 (Analyze)\n- 計算國家市佔率（Country Share）\n- 計算集中度指標（CR1, CR3, CR5）\n- 計算HHI（Herfindahl-Hirschman Index）\n- 生成時序趨勢分析（2015-2024）\n- **視覺化圖表生成**\n\n### 2. 政策情境模擬 (Scenario)\n- 模擬RKAB配額變動影響\n- 計算政策槓桿效應\n- 輸出三層結果（Hard/Half/Soft）\n\n### 3. 數據來源驗證 (Validate)\n- 驗證市場說法的數據口徑\n- 追溯原始數據來源\n- 交叉驗證數據一致性\n\n### 4. 數據擷取 (Ingest)\n- Tier 0: USGS, INSG（免費穩定）\n- Tier 1: 公司報告（免費但分散）\n- Tier 2: S&P Global（付費精確）\n\n## 快速開始\n\n### 基礎分析\n\n```bash\n# 1. 進入腳本目錄\ncd .claude/skills/nickel-concentration-risk-analyzer/scripts\n\n# 2. 執行集中度分析\npython nickel_pipeline.py analyze --asof=2026-01-16 --scope=mined\n\n# 3. 生成視覺化圖表\npython visualize_concentration.py\n```\n\n### 視覺化輸出\n\n執行 `visualize_concentration.py` 會生成以下圖表（保存在項目根目錄 `output/` 資料夾）：\n\n| 圖表檔名 | 內容 |\n|---------|------|\n| `nickel_indonesia_share_trend_YYYYMMDD.png` | 印尼市佔率與HHI時序趨勢 (2015-2024) |\n| `nickel_country_share_pie_YYYYMMDD.png` | 2024年國家份額分布餅圖 |\n| `nickel_concentration_metrics_YYYYMMDD.png` | 集中度指標演進（CR1, CR3, CR5） |\n| `nickel_production_volume_YYYYMMDD.png` | 印尼vs全球產量對比堆疊圖 |\n| `nickel_risk_matrix_YYYYMMDD.png` | 集中度風險矩陣定位圖 |\n\n**範例輸出**：\n- 印尼市佔率：57.9% (2024)\n- HHI：3,779（高集中）\n- 市場結構：極高風險\n\n### Python Library 使用\n\n```python\nfrom nickel_pipeline import NickelConcentrationAnalyzer\n\n# 初始化分析器\nanalyzer = NickelConcentrationAnalyzer(\n    asof_date=\"2026-01-16\",\n    scope={\"supply_type\": \"mined\", \"unit\": \"t_Ni_content\"},\n    data_level=\"free_nolimit\"\n)\n\n# 計算集中度指標\nresult = analyzer.compute_concentration()\nprint(f\"Indonesia share: {result['indonesia_share']:.1%}\")\nprint(f\"HHI: {result['hhi']:.0f}\")\nprint(f\"Market structure: {result['market_structure']}\")\n\n# 計算時序趨勢\ntime_series = analyzer.compute_time_series(start_year=2015)\n\n# 輸出結果\nanalyzer.generate_output(output_format='json', output_dir='./output')\n```\n\n## 核心概念\n\n### 口徑先行 (Unit Enforcement)\n\n所有分析必須先確定數據口徑：\n\n| 口徑 | 說明 | 典型數值差異 |\n|------|------|-------------|\n| `t_Ni_content` | 鎳金屬含量（預設） | 基準值 |\n| `t_ore_wet` | 礦石濕噸 | 50-100x |\n| `t_NPI_product` | NPI產品噸 | 10-15% Ni |\n| `t_matte` | 鎳鋶噸 | 75% Ni |\n\n### 集中度指標\n\n| 指標 | 公式 | 解讀 |\n|------|------|------|\n| Country Share | `country_prod / global_prod` | 單國佔比 |\n| CR_n | `Σ top_n_share` | 前N國集中度 |\n| HHI | `Σ share²` | 市場集中度（0-10000） |\n\n**HHI判讀標準**：\n- < 1500：低集中（Unconcentrated）\n- 1500-2500：中等集中（Moderately Concentrated）\n- \\> 2500：高集中（Highly Concentrated）\n\n### 數據來源分層\n\n| Tier | 來源 | 特性 | 用途 |\n|------|------|------|------|\n| 0 | USGS MCS, INSG | 免費、穩定、口徑一致 | Baseline主幹 |\n| 1 | 公司年報 | 免費但分散 | Mine-level錨點 |\n| 2 | S&P Global | 付費、即時完整 | 精度驗證 |\n| 3 | 政策新聞 | 即時但需驗證 | 情境輸入 |\n\n## 目錄結構\n\n```\nnickel-concentration-risk-analyzer/\n├── SKILL.md                      # Skill 定義檔\n├── README.md                     # 本文件\n├── scripts/                      # Python 腳本\n│   ├── nickel_pipeline.py       # 核心分析管線\n│   ├── ingest_sources.py        # 數據擷取\n│   ├── compute_concentration.py # 集中度計算\n│   ├── scenario_impact.py       # 情境模擬\n│   └── visualize_concentration.py # 視覺化圖表生成 ⭐\n├── workflows/                    # 工作流程定義\n│   ├── analyze.md               # 分析流程\n│   ├── scenario-engine.md       # 情境模擬流程\n│   ├── validate-sources.md      # 驗證流程\n│   └── ingest.md               # 數據擷取流程\n├── references/                   # 參考文件\n│   ├── data-sources.md          # 數據來源說明\n│   ├── concentration-metrics.md # 集中度指標詳解\n│   ├── indonesia-supply-structure.md # 印尼供給結構\n│   └── unit-conversion.md       # 單位轉換規則\n└── templates/                    # 輸出模板\n    ├── output-json.md           # JSON輸出格式\n    ├── output-markdown.md       # Markdown報告格式\n    └── config.yaml              # 配置模板\n```\n\n## 2024年分析結果摘要\n\n**印尼主導地位**：\n- 市佔率：**57.9%** (2.2 Mt Ni / 3.8 Mt global)\n- 10年增長：**11倍**（2015: 5.1% → 2024: 57.9%）\n- 成長驅動：2020年礦石出口禁令、NPI產能擴張\n\n**市場集中度**：\n- CR1（最大國）：57.9%\n- CR3（前三國）：84.2%\n- CR5（前五國）：93.7%\n- HHI：**3,779**（高集中）\n\n**風險評級**：🔴 **極高風險**\n\n## 政策風險示例\n\n**假設：印尼RKAB配額減少20%**\n- 受影響供給：440 kt Ni\n- 全球衝擊：11.6%\n- 相當於：42天全球消費量\n- 風險等級：極高風險\n\n## 數據口徑注意事項\n\n⚠️ **重要提醒**：\n\n本工具使用 **mined nickel content**（礦場產量的鎳金屬含量）：\n- ✅ 鎳金屬含量（metric tons Ni）\n- ❌ 非 ore wet tonnes（礦石濕噸）\n- ❌ 非 refined production（精煉產量）\n- ❌ 非 NPI product tonnes（NPI產品噸）\n\n## 依賴套件\n\n```bash\npip install pandas numpy matplotlib requests beautifulsoup4\n```\n\n可選：\n```bash\npip install camelot-py tabula-py  # PDF解析（進階功能）\n```\n\n## License\n\nMIT License\n\n## Author\n\nRicky Wang\n\n---\n\n**最後更新**: 2026-01-16\n**版本**: 0.1.0\n",
        "skills/nickel-concentration-risk-analyzer/SKILL.md": "---\nname: nickel-concentration-risk-analyzer\ndescription: 以全球鎳供給結構為核心，量化各國的主導程度（例如印尼）、主要礦區供給量、以及政策配額/減產情境對全球供需平衡與價格非對稱的影響。\n---\n\n<essential_principles>\n**鎳供給集中度分析 核心原則**\n\n<principle name=\"unit_enforcement\">\n**口徑先行（Unit Enforcement）**\n\n所有分析必須先確定口徑，不同口徑會導致數量級差異：\n\n| 口徑            | 說明                        | 典型數值差異 |\n|-----------------|-----------------------------|--------------|\n| `t_Ni_content`  | 鎳金屬含量（本 Skill 預設） | 基準值       |\n| `t_ore_wet`     | 礦石濕噸                    | 可達 50-100x |\n| `t_NPI_product` | NPI 產品噸                  | 約 10-15% Ni |\n| `t_matte`       | 鎳鋶噸                      | 約 75% Ni    |\n\n**強制規則**：\n- 若輸入數據口徑不明確，必須標記為 `model_estimate`\n- 同一分析中不得混用不同口徑數據\n- 輸出必須包含 `unit` 欄位\n</principle>\n\n<principle name=\"supply_type_clarity\">\n**供給類型區分（Supply Type Clarity）**\n\n鎳供給鏈各階段必須分開計算：\n\n```\nMine Production (mined) → Intermediate (NPI/Matte/MHP) → Refined (class1/class2)\n```\n\n- **mined**: 礦場產量（鎳金屬含量）\n- **refined**: 精煉產量（含冶煉）\n- 「印尼 60% 市佔」通常指 **mined nickel content**\n</principle>\n\n<principle name=\"data_tiering\">\n**數據分層策略（Data Tiering）**\n\n| Tier | 特性                 | 來源           | 用途               |\n|------|----------------------|----------------|--------------------|\n| 0    | 免費、穩定、口徑一致 | USGS MCS, INSG | Baseline 主幹      |\n| 1    | 免費但分散、需整合   | 公司年報、財報 | Mine-level 錨點    |\n| 2    | 付費、更即時完整     | S&P Global MI  | 精度驗證、對齊口徑 |\n| 3    | 政策/配額近期訊息    | 新聞、官方公告 | 情境輸入           |\n\n**優先順序**：Tier 0 建立 baseline → Tier 1 補充 mine-level → Tier 2 驗證精度\n</principle>\n\n<principle name=\"execution_probability\">\n**政策執行機率（Execution Probability）**\n\n政策減產不需 100% 執行即可造成衝擊。預設模型：\n\n```python\nexpected_cut = cut_value * execution_prob  # 預設 execution_prob = 0.5\n```\n\n三層輸出：\n- **Hard cut**: 政策完全落地\n- **Half success**: 執行 50%（或指定值）\n- **Soft landing**: 只延遲投產/只砍新增產能\n</principle>\n\n<principle name=\"concentration_metrics\">\n**集中度指標定義**\n\n| 指標            | 公式                         | 解讀                     |\n|-----------------|------------------------------|--------------------------|\n| Country Share   | `country_prod / global_prod` | 單國佔比                 |\n| CR_n            | `Σ top_n_share`              | 前 N 國/礦集中度         |\n| HHI             | `Σ share²`                   | 市場集中度（0-10000）    |\n| Policy Leverage | `cut_amount / global_prod`   | 政策可撬動的全球供給比例 |\n\nHHI 判讀：< 1500 低集中、1500-2500 中等、> 2500 高集中\n</principle>\n</essential_principles>\n\n<intake>\n**您想要執行什麼操作？**\n\n1. **Analyze** - 分析全球鎳供給結構與集中度指標（CR_n, HHI, country share）\n2. **Scenario** - 模擬政策/減產情境對供給的衝擊（RKAB配額、出口限制等）\n3. **Validate** - 驗證市場說法的數據口徑與來源可靠度\n4. **Ingest** - 從各數據源擷取並標準化鎳供給數據\n\n**等待回應後再繼續。**\n</intake>\n\n<routing>\n| Response                                                | Workflow                      | Description          |\n|---------------------------------------------------------|-------------------------------|----------------------|\n| 1, \"analyze\", \"concentration\", \"share\", \"hhi\", \"集中度\" | workflows/analyze.md          | 供給結構與集中度分析 |\n| 2, \"scenario\", \"policy\", \"cut\", \"減產\", \"情境\", \"RKAB\"  | workflows/scenario-engine.md  | 政策情境衝擊模擬     |\n| 3, \"validate\", \"verify\", \"check\", \"驗證\", \"來源\"        | workflows/validate-sources.md | 數據來源與口徑驗證   |\n| 4, \"ingest\", \"fetch\", \"data\", \"抓取\", \"擷取\"            | workflows/ingest.md           | 數據擷取與標準化     |\n\n**讀取工作流程後，請完全遵循其步驟。**\n</routing>\n\n<reference_index>\n**參考文件** (`references/`)\n\n| 文件                          | 內容                       |\n|-------------------------------|----------------------------|\n| data-sources.md               | 所有數據來源詳細說明與 URL |\n| unit-conversion.md            | 單位轉換規則與假設         |\n| concentration-metrics.md      | 集中度指標詳細計算方法     |\n| indonesia-supply-structure.md | 印尼鎳供給結構與關鍵園區   |\n| mine-level-anchors.md         | 主要礦區/園區產量錨點      |\n| failure-modes.md              | 失敗模式與緩解策略         |\n</reference_index>\n\n<workflows_index>\n| Workflow            | Purpose                                  |\n|---------------------|------------------------------------------|\n| analyze.md          | 供給結構與集中度分析（CR_n, HHI, share） |\n| scenario-engine.md  | 政策情境衝擊模擬                         |\n| validate-sources.md | 數據來源與口徑驗證                       |\n| ingest.md           | 數據擷取與標準化                         |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構模板 |\n| output-markdown.md | Markdown 報告模板 |\n| config.yaml        | 分析參數配置模板  |\n| data-schema.yaml   | 數據 Schema 定義  |\n</templates_index>\n\n<scripts_index>\n| Script                   | Purpose                |\n|--------------------------|------------------------|\n| nickel_pipeline.py       | 核心數據管線           |\n| ingest_sources.py        | 數據來源擷取           |\n| compute_concentration.py | 集中度指標計算         |\n| scenario_impact.py       | 情境衝擊模擬           |\n| visualize_concentration.py | 集中度分析視覺化圖表 |\n| visualize_scenario.py    | 情境衝擊視覺化圖表     |\n</scripts_index>\n\n<quick_start>\n**CLI 快速開始：**\n\n```bash\n# 分析當前全球鎳供給集中度\npython scripts/nickel_pipeline.py analyze --asof=2026-01-16 --scope=mined\n\n# 生成集中度視覺化圖表（輸出到 output/ 目錄，檔名包含日期）\npython scripts/visualize_concentration.py\n\n# 模擬印尼減產 20% 的情境衝擊\npython scripts/nickel_pipeline.py scenario --cut=20 --target=Indonesia --exec-prob=0.5\n\n# 生成情境衝擊視覺化圖表\npython scripts/visualize_scenario.py\n\n# 驗證「印尼 60% 市佔」的數據來源\npython scripts/nickel_pipeline.py validate --claim=\"Indonesia 60% share\"\n```\n\n**Library 快速開始：**\n\n```python\nfrom nickel_pipeline import NickelConcentrationAnalyzer\n\nanalyzer = NickelConcentrationAnalyzer(\n    asof_date=\"2026-01-16\",\n    scope={\"supply_type\": \"mined\", \"unit\": \"t_Ni_content\"},\n    data_level=\"free_nolimit\"\n)\n\n# 計算集中度指標\nresult = analyzer.compute_concentration()\nprint(f\"Indonesia share: {result['indonesia_share_2024']:.1%}\")\nprint(f\"HHI: {result['hhi_2024']:.0f}\")\n```\n</quick_start>\n\n<success_criteria>\nSkill 成功執行時：\n- [ ] 正確識別數據口徑（mined/refined/nickel content）\n- [ ] 輸出包含 unit 欄位標註\n- [ ] 集中度指標計算正確（share, CR_n, HHI）\n- [ ] 情境分析輸出三層結果（hard/half/soft）\n- [ ] 數據來源可追溯（source_id, confidence）\n- [ ] 單位警告正確觸發（ore vs content）\n</success_criteria>\n\n<input_schema>\n**輸入參數定義**\n\n```yaml\n# 必要參數\nasof_date: string (ISO)  # 分析基準日\nhorizon:\n  history_start_year: int\n  history_end_year: int\n  forecast_end_year: int\n\n# 範圍參數\nscope:\n  supply_type: string  # mined | refined | nickel_content (必填)\n  product_group: string  # class1 | class2 | NPI | matte | MHP | mixed (選填)\n  countries: array[string]  # 預設: Indonesia, Philippines, Russia, Canada, Australia, Other\n\n# 情境參數 (scenario workflow 專用)\npolicy_scenarios:\n  - name: string\n    target_country: string  # 預設: Indonesia\n    policy_variable: string  # ore_quota_RKAB | mine_permit | export_rule | smelter_capacity\n    cut_type: string  # pct_global | pct_country | absolute\n    cut_value: number\n    start_year: int\n    end_year: int\n    execution_prob: number  # 0-1, 預設 0.5\n\n# 數據等級\ndata_level: string  # free_nolimit | free_limit | paid_low | paid_high\n```\n</input_schema>\n\n<data_pipeline_architecture>\n**數據流水線架構**\n\n```\n[Data Sources]\n     |\n     v\n+-------------------+\n|   ingest_sources  |  --> Tier 0: USGS, INSG\n+-------------------+      Tier 1: Company reports\n     |                     Tier 2: S&P Global (optional)\n     v\n+-------------------+\n|   normalize       |  --> 統一 schema + 單位標註\n+-------------------+      (year, country, supply_type, value, unit, source_id)\n     |\n     v\n+-------------------+\n| compute_concentration | --> share, CR_n, HHI\n+-------------------+\n     |\n     v\n+-------------------+\n|   scenario_impact |  --> expected_cut, global_hit_pct\n+-------------------+\n     |\n     v\n+-------------------+\n|   generate_output |  --> JSON + Markdown\n+-------------------+\n     |\n     v\n[Analysis Result]\n```\n\n**標準化欄位 Schema：**\n\n| 欄位          | 類型   | 說明                                     |\n|---------------|--------|------------------------------------------|\n| year          | int    | 年度                                     |\n| country       | string | 國家                                     |\n| supply_type   | string | mined/refined                            |\n| product_group | string | NPI/matte/MHP/class1...                  |\n| value         | float  | 數值                                     |\n| unit          | string | t_Ni_content / t_ore_wet / t_NPI_product |\n| source_id     | string | USGS/INSG/S&P/Company/Other              |\n| confidence    | float  | 來源品質評分 (0-1)                       |\n</data_pipeline_architecture>\n",
        "skills/nickel-concentration-risk-analyzer/examples/analysis_report.md": "## 全球鎳供給集中度分析報告\n\n**生成日期**: 2026-01-16T12:00:00Z\n**分析基準日**: 2026-01-16\n**數據口徑**: Mined nickel content (鎳金屬含量)\n\n---\n\n### 執行摘要\n\n全球鎳供給高度集中於印尼。2024 年印尼佔全球 mined nickel 產量約 60.2%（S&P Global 口徑），\n較 2020 年的 31.5% 幾乎翻倍。HHI 指數達 3950，屬於「高集中市場」。\n\n這種集中度意味著任何影響印尼供給的政策變動（如 RKAB 配額調整）都可能對全球市場造成重大衝擊。\n\n---\n\n### 關鍵發現\n\n| 指標 | 數值 | 解讀 |\n|------|------|------|\n| Indonesia share (2024) | **60.2%** | 單一國家主導全球供給 |\n| CR5 (前五國集中度) | 84.3% | 前五國控制超過 84% 供給 |\n| HHI | 3950 | 高集中市場（閾值 2500） |\n| 市場結構 | 高集中 (Highly Concentrated) | |\n\n---\n\n### 集中度時序趨勢\n\n| 年份 | Indonesia Share | HHI | 市場結構 |\n|------|-----------------|-----|----------|\n| 2015 | 5.4% | 1180 | 低集中 |\n| 2018 | 20.8% | 1520 | 中等集中 |\n| 2020 | 31.5% | 2100 | 中等集中 |\n| 2022 | 48.0% | 3020 | 高集中 |\n| 2024 | 60.2% | 3950 | 高集中 |\n\n**趨勢觀察**:\n- 印尼市佔在 10 年內從不到 10% 增長至超過 60%\n- 2020 年後增長加速（出口禁令 + NPI 產能擴張）\n- HHI 從低集中跨越到高集中，反映市場結構根本性變化\n\n---\n\n### 國家份額分布 (2024)\n\n```\nIndonesia    ████████████████████████████████████████████████████████████  60.2%\nPhilippines  ██████████▌                                                   10.6%\nRussia       █████▌                                                         5.6%\nCanada       ████                                                           4.0%\nAustralia    ███▌                                                           3.7%\nOthers       ████████████████                                              15.9%\n```\n\n---\n\n### 風險評估\n\n| 風險維度 | 評級 | 說明 |\n|----------|------|------|\n| 集中度風險 | **極高** | 單一國家主導 60%+ |\n| 政策敏感度 | **高** | RKAB 配額變動可影響全球 |\n| 單點故障 | **是** | 印尼供給中斷無法短期替代 |\n| 緩解難度 | **高** | 新產能開發需 3-5 年 |\n\n---\n\n### 數據來源\n\n| 來源 | Tier | 置信度 | 說明 |\n|------|------|--------|------|\n| USGS MCS 2025 | 0 | 95% | 主要國家歷史數據 |\n| INSG Statistics | 0 | 90% | 全球供需平衡 |\n| S&P Global MI | 2 | 90% | Indonesia 60.2% 錨點 |\n\n---\n\n### 口徑說明\n\n本分析使用 **mined nickel content**（礦場產量的鎳金屬含量）：\n\n- ✅ 適用口徑: mined nickel content (本報告)\n- ❌ 非 ore wet tonnes（礦石濕噸，數字會大 50-100 倍）\n- ❌ 非 refined production（精煉產量，國家排名會不同）\n\n此口徑與 S&P Global Market Intelligence 報告的 60.2% 市佔一致。\n\n---\n\n### 後續建議\n\n1. **情境分析**: 使用 `scenario` workflow 模擬 RKAB 配額變動影響\n2. **數據驗證**: 使用 `validate` workflow 驗證市場說法的口徑\n3. **持續監控**: 定期更新集中度指標，追蹤結構變化\n\n---\n\n### 免責聲明\n\n本分析基於公開可得數據，結果僅供參考。\n數據來源可能有時間滯後或口徑差異。\n投資決策請自行判斷。\n\n---\n\n*Generated by nickel-concentration-risk-analyzer v0.1.0*\n",
        "skills/nickel-concentration-risk-analyzer/methodology.md": "### 1. 供給集中度（Concentration）= 控制力的上限\n當某國家佔全球供給 **X%**，任何「對該國供給的變化」都能近似映射到全球供給衝擊：\n\n- **全球供給衝擊比例 ≈ X% × 該國供給變動比例**\n\n換句話說，若印尼佔全球鎳供給約 **60%**，印尼國內供給只要變動 **10%**，全球供給理論衝擊就可能達到 **~6%**（同口徑下）。\n\n> 這是「供給槓桿」的第一層：**國家份額越大，政策/供應變動的全球傳導越直接**。\n\n### 2. 「少數資產」可控性（Top mines / Industrial parks）= 槓桿的開關\n即使一國份額很高，真正能快速施力的常常不是「全國每個礦」，而是：\n\n- 產量極大、集中於少數礦山/園區\n- 許可與配額制度能鎖住上游（礦）或下游（冶煉/轉化）的擴張\n- 物流、環評、用電、港口等基礎設施形成瓶頸\n\n因此，分析上要做第二層拆解：\n\n- **Top N mines / Top N industrial parks 佔全球供給多少？**\n- 如果只「拴緊」這些關鍵節點，就可能快速造成可觀的供給缺口\n\n> 這是「供給槓桿」的第二層：**槓桿不只來自份額，也來自供給是否集中在少數可被管理的節點**。\n\n### 3. 市場定價（Consensus / Positioning）= 非對稱的來源\n供給槓桿不一定立刻導致行情，真正會引爆「非對稱」的是：\n\n- 市場長期看空、共識極度悲觀\n- 價格把「最壞情境」當成常態\n- 此時只要供給端出現「比預期少一點的利空」或「半成功的減產」，就可能造成**向上急拉**（short covering + re-pricing）\n\n> 這是「供給槓桿」的第三層：**供給衝擊 × 市場已定價程度 = 非對稱走勢的觸發條件**。\n\n用同一套工具，你也可以把它平移到其他商品（如鈀金、油、鋰、銅）去比較「誰才是真的單點槓桿」。",
        "skills/nickel-concentration-risk-analyzer/references/concentration-metrics.md": "# 集中度指標計算方法\n\n<overview>\n本文件詳細說明鎳供給集中度分析中使用的各項指標，\n包括計算方法、解讀標準與應用場景。\n</overview>\n\n<metric name=\"country_share\">\n**Country Share（國家市佔率）**\n\n<definition>\n單一國家在全球供給中的佔比。\n\n```\nCountry Share = Country_Production / Global_Production\n```\n</definition>\n\n<calculation>\n```python\ndef calculate_country_share(df, country, year):\n    \"\"\"\n    計算特定國家的市場份額\n\n    Args:\n        df: 供給數據 DataFrame\n        country: 目標國家\n        year: 目標年份\n\n    Returns:\n        float: 市場份額 (0-1)\n    \"\"\"\n    year_data = df[(df.year == year) & (df.supply_type == \"mined\")]\n\n    country_prod = year_data[year_data.country == country].value.sum()\n    global_prod = year_data.value.sum()\n\n    if global_prod == 0:\n        return 0\n\n    return country_prod / global_prod\n```\n</calculation>\n\n<interpretation>\n| 份額 | 解讀 | 風險等級 |\n|------|------|----------|\n| < 10% | 小型供給國 | 低 |\n| 10-30% | 重要供給國 | 中 |\n| 30-50% | 主要供給國 | 高 |\n| > 50% | 主導供給國 | 極高 |\n\n**印尼案例：**\n- 2020: ~31.5% → 主要供給國\n- 2024: ~60.2% → **主導供給國**\n</interpretation>\n</metric>\n\n<metric name=\"CRn\">\n**CR_n（n 國集中率）**\n\n<definition>\n前 n 個最大供給國/礦的累積市場份額。\n\n```\nCR_n = Σ(top_n_shares)\n```\n\n常用指標：\n- **CR1**: 最大單一供給者份額\n- **CR3**: 前三大累積份額\n- **CR5**: 前五大累積份額\n</definition>\n\n<calculation>\n```python\ndef calculate_CRn(df, year, n=5):\n    \"\"\"\n    計算前 N 大供給者集中率\n\n    Args:\n        df: 供給數據 DataFrame\n        year: 目標年份\n        n: 前 N 大（預設 5）\n\n    Returns:\n        dict: CR1, CR3, CR5 等指標\n    \"\"\"\n    year_data = df[(df.year == year) & (df.supply_type == \"mined\")]\n\n    # 計算各國份額\n    country_prod = year_data.groupby(\"country\").value.sum()\n    total_prod = country_prod.sum()\n    shares = (country_prod / total_prod).sort_values(ascending=False)\n\n    return {\n        \"CR1\": shares.iloc[0] if len(shares) >= 1 else 0,\n        \"CR3\": shares.head(3).sum() if len(shares) >= 3 else shares.sum(),\n        \"CR5\": shares.head(5).sum() if len(shares) >= 5 else shares.sum(),\n        f\"CR{n}\": shares.head(n).sum() if len(shares) >= n else shares.sum(),\n        \"top_countries\": shares.head(n).to_dict()\n    }\n```\n</calculation>\n\n<interpretation>\n| CR4 | 市場結構 | 說明 |\n|-----|----------|------|\n| < 40% | 競爭型 | 多元供給來源 |\n| 40-60% | 鬆散寡佔 | 數個主要供給者 |\n| 60-80% | 緊密寡佔 | 少數供給者主導 |\n| > 80% | 高度集中 | 極少數供給者控制 |\n\n**鎳市場 (2024 估計)：**\n- CR1 (Indonesia): ~60%\n- CR3 (Indonesia + Philippines + Russia): ~75%\n- CR5: ~85%\n- 判定：**高度集中市場**\n</interpretation>\n</metric>\n\n<metric name=\"HHI\">\n**HHI（赫芬達爾-赫希曼指數）**\n\n<definition>\n衡量市場集中程度的標準指標，由各供給者市場份額的平方和構成。\n\n```\nHHI = Σ(share_i² × 10000)\n```\n\n其中 share_i 為第 i 個供給者的市場份額（0-1）。\n乘以 10000 是為了得到 0-10000 的標準範圍。\n</definition>\n\n<calculation>\n```python\ndef calculate_HHI(df, year, by=\"country\"):\n    \"\"\"\n    計算 HHI 指數\n\n    Args:\n        df: 供給數據 DataFrame\n        year: 目標年份\n        by: 分組依據 (\"country\" 或 \"company\")\n\n    Returns:\n        float: HHI 指數 (0-10000)\n    \"\"\"\n    year_data = df[(df.year == year) & (df.supply_type == \"mined\")]\n\n    # 計算份額\n    group_prod = year_data.groupby(by).value.sum()\n    total_prod = group_prod.sum()\n    shares = group_prod / total_prod\n\n    # HHI = Σ(share² × 10000)\n    hhi = (shares ** 2).sum() * 10000\n\n    return round(hhi, 0)\n```\n</calculation>\n\n<interpretation>\n**美國司法部 / FTC 標準：**\n\n| HHI | 市場結構 | 說明 |\n|-----|----------|------|\n| < 1500 | 低集中 (Unconcentrated) | 競爭充分 |\n| 1500-2500 | 中等集中 (Moderately Concentrated) | 需關注 |\n| > 2500 | 高集中 (Highly Concentrated) | 壟斷風險 |\n\n**計算範例：**\n\n假設 2024 年各國份額：\n- Indonesia: 60%\n- Philippines: 10%\n- Russia: 6%\n- Canada: 5%\n- Australia: 4%\n- Others: 15%\n\n```\nHHI = (0.60² + 0.10² + 0.06² + 0.05² + 0.04² + 0.15²) × 10000\n    = (0.36 + 0.01 + 0.0036 + 0.0025 + 0.0016 + 0.0225) × 10000\n    = 0.4002 × 10000\n    = 4002\n\n結論：HHI ≈ 4000，屬於 **高集中市場**\n```\n</interpretation>\n\n<special_cases>\n**極端情況：**\n\n| 情境 | HHI | 說明 |\n|------|-----|------|\n| 完全壟斷 (1家 100%) | 10000 | 理論最大值 |\n| 雙寡頭 (2家各 50%) | 5000 | |\n| 10家各 10% | 1000 | 低集中 |\n| 100家各 1% | 100 | 高度分散 |\n</special_cases>\n</metric>\n\n<metric name=\"policy_leverage\">\n**Policy Leverage（政策槓桿）**\n\n<definition>\n衡量政策變動對全球供給的潛在影響力。\n\n```\nPolicy Leverage = Affected_Supply / Global_Supply\n```\n</definition>\n\n<calculation>\n```python\ndef calculate_policy_leverage(scenario, baseline):\n    \"\"\"\n    計算政策槓桿\n\n    Args:\n        scenario: 政策情境 (含 cut_value, cut_type, target_country)\n        baseline: 基準數據 (含 country_prod, global_prod)\n\n    Returns:\n        dict: 政策槓桿指標\n    \"\"\"\n    # 確定受影響供給量\n    if scenario.cut_type == \"pct_country\":\n        affected = baseline.country_prod * scenario.cut_value\n    elif scenario.cut_type == \"pct_global\":\n        affected = baseline.global_prod * scenario.cut_value\n    else:  # absolute\n        affected = scenario.cut_value\n\n    # 計算槓桿\n    leverage = affected / baseline.global_prod\n\n    return {\n        \"affected_supply_kt\": affected / 1000,\n        \"global_hit_pct\": leverage,\n        \"equivalent_days\": leverage * 365,  # 相當於多少天全球消費\n        \"risk_level\": classify_leverage(leverage)\n    }\n\ndef classify_leverage(leverage):\n    if leverage < 0.02:\n        return \"低風險\"\n    elif leverage < 0.05:\n        return \"中等風險\"\n    elif leverage < 0.10:\n        return \"高風險\"\n    else:\n        return \"極高風險\"\n```\n</calculation>\n\n<interpretation>\n| 槓桿 (%) | 相當於 | 風險等級 | 說明 |\n|----------|--------|----------|------|\n| < 2% | < 1 週消費 | 低 | 市場可吸收 |\n| 2-5% | 1-3 週消費 | 中 | 短期價格波動 |\n| 5-10% | 3-5 週消費 | 高 | 顯著供給衝擊 |\n| > 10% | > 5 週消費 | 極高 | 市場重大混亂 |\n\n**印尼減產 20% 情境：**\n- Indonesia share: 60%\n- Cut: 20% of Indonesia = 12% of global\n- Risk level: **極高風險**\n</interpretation>\n</metric>\n\n<metric name=\"mine_CRn\">\n**Mine CR_n（礦區集中率）**\n\n<definition>\n前 n 個最大礦區/園區的累積產量份額。\n用於評估「掐脖子」風險。\n\n```\nMine_CR5 = Σ(top_5_mine_production) / Global_Production\n```\n</definition>\n\n<calculation>\n```python\ndef calculate_mine_CRn(mine_data, year, n=5):\n    \"\"\"\n    計算礦區集中率\n\n    Note: 需要 mine-level 數據（Tier 1）\n\n    Args:\n        mine_data: 礦區產量數據\n        year: 目標年份\n        n: 前 N 大礦區\n    \"\"\"\n    year_data = mine_data[mine_data.year == year]\n\n    mine_prod = year_data.groupby(\"mine_name\").value.sum()\n    total_prod = mine_prod.sum()\n    shares = (mine_prod / total_prod).sort_values(ascending=False)\n\n    return {\n        f\"Mine_CR{n}\": shares.head(n).sum(),\n        \"top_mines\": shares.head(n).to_dict(),\n        \"concentration_risk\": \"若 Mine_CR5 > 20%，單一事件可影響顯著供給\"\n    }\n```\n</calculation>\n\n<data_availability>\n**數據可用性說明：**\n\nMine-level 數據較難取得：\n- 公開來源有限\n- 口徑不一致（ore vs content）\n- 需整合多家公司報告\n\n**可用錨點：**\n| 礦區/園區 | 估計產量 | 全球佔比 | 來源 |\n|-----------|----------|----------|------|\n| Weda Bay | ~X kt | ~X% | Eramet |\n| IMIP | ~X kt | ~X% | 產業報告 |\n| IWIP | ~X kt | ~X% | 產業報告 |\n| PT Vale | ~X kt | ~X% | 公司財報 |\n| Ramu | ~X kt | ~X% | 公司財報 |\n</data_availability>\n</metric>\n\n<time_series_analysis>\n**時序分析**\n\n追蹤集中度指標隨時間的變化：\n\n```python\ndef analyze_concentration_trend(df, years, metric=\"HHI\"):\n    \"\"\"\n    分析集中度趨勢\n\n    Returns:\n        DataFrame: 各年份集中度指標\n    \"\"\"\n    results = []\n    for year in years:\n        if metric == \"HHI\":\n            value = calculate_HHI(df, year)\n        elif metric == \"CR5\":\n            value = calculate_CRn(df, year, n=5)[\"CR5\"]\n        elif metric == \"indonesia_share\":\n            value = calculate_country_share(df, \"Indonesia\", year)\n\n        results.append({\"year\": year, \"metric\": metric, \"value\": value})\n\n    return pd.DataFrame(results)\n```\n\n**印尼市佔趨勢（2015-2024）：**\n\n| 年份 | Indonesia Share | HHI | 判讀 |\n|------|-----------------|-----|------|\n| 2015 | ~15% | ~1200 | 低集中 |\n| 2018 | ~25% | ~1800 | 中等集中 |\n| 2020 | ~31% | ~2100 | 中等集中 |\n| 2022 | ~48% | ~3000 | 高集中 |\n| 2024 | ~60% | ~4000 | 高集中 |\n\n**趨勢觀察：**\n- 印尼市佔 10 年間增長 4 倍\n- HHI 從低集中跨入高集中\n- 增長主要來自 NPI 產能擴張\n</time_series_analysis>\n\n<risk_matrix>\n**集中度風險矩陣**\n\n| | HHI < 1500 | HHI 1500-2500 | HHI > 2500 |\n|---|---|---|---|\n| **CR1 < 30%** | 低風險 | 中風險 | 中高風險 |\n| **CR1 30-50%** | 中風險 | 中高風險 | 高風險 |\n| **CR1 > 50%** | 中高風險 | 高風險 | **極高風險** |\n\n**2024 鎳市場定位：**\n- CR1 (Indonesia): ~60%\n- HHI: ~4000\n- **風險評級：極高**\n</risk_matrix>\n",
        "skills/nickel-concentration-risk-analyzer/references/data-sources.md": "# 數據來源詳細說明\n\n<overview>\n本文件詳細說明 nickel-concentration-risk-analyzer 使用的所有數據來源，\n按可靠度分為 Tier 0-3，並說明每個來源的取得方式、口徑特性與潛在陷阱。\n</overview>\n\n<tier_0_sources>\n**Tier 0: 免費、穩定、口徑一致（建議做 Baseline 主幹）**\n\n<source name=\"USGS_MCS\">\n**USGS Mineral Commodity Summaries (Nickel)**\n\n| 項目 | 說明 |\n|------|------|\n| URL | https://www.usgs.gov/centers/national-minerals-information-center/nickel-statistics-and-information |\n| 更新頻率 | 每年 1 月/2 月 |\n| 數據口徑 | Mine production (nickel content) |\n| 單位 | Metric tons (鎳金屬含量) |\n| 涵蓋範圍 | 全球 + 主要國家 |\n| 取得方式 | PDF 下載 → 表格解析 |\n| Confidence | 0.95 |\n\n**關鍵表格：**\n- Table: World Mine Production and Reserves\n- Table: U.S. Salient Statistics\n\n**解析注意事項：**\n- PDF 表格可用 `camelot` 或 `tabula-py` 解析\n- 數據單位為 metric tons（公噸），不是 short tons\n- 部分國家數據標記 \"e\" (estimated) 或 \"r\" (revised)\n\n**範例數據結構：**\n```\nCountry         | 2020    | 2021    | 2022    | 2023    | 2024e\n----------------|---------|---------|---------|---------|--------\nIndonesia       | 760,000 | 1,000,000| 1,600,000| 1,900,000| 2,200,000\nPhilippines     | 320,000 | 370,000 | 330,000 | 400,000 | 400,000\nRussia          | 250,000 | 250,000 | 220,000 | 220,000 | 210,000\n...\nWorld total     | 2,500,000| 2,800,000| 3,200,000| 3,500,000| 3,700,000\n```\n</source>\n\n<source name=\"INSG\">\n**INSG (International Nickel Study Group)**\n\n| 項目 | 說明 |\n|------|------|\n| URL | https://insg.org/ |\n| 更新頻率 | 月報 + 年度報告 |\n| 數據口徑 | Primary nickel production |\n| 單位 | Thousand tonnes (kt) |\n| 涵蓋範圍 | 全球供需平衡 |\n| 取得方式 | 網頁/PDF（部分需會員） |\n| Confidence | 0.90-0.95 |\n\n**主要出版物：**\n1. **Market Commentary** (月報): 供需摘要、價格趨勢\n2. **World Nickel Factbook**: 年度綜合報告\n3. **Statistics**: 歷史數據\n\n**INSG vs USGS 口徑差異：**\n- INSG \"primary nickel\" 可能包含部分 refined production\n- USGS \"mine production\" 嚴格指礦場產量\n- 差異通常在 5-10% 以內\n</source>\n</tier_0_sources>\n\n<tier_1_sources>\n**Tier 1: 免費但分散，需整合（Mine-level 最實用）**\n\n<source name=\"Company_Reports\">\n**上市公司年報與財報**\n\n| 公司 | Ticker | 主要產品 | 報告口徑 | URL |\n|------|--------|----------|----------|-----|\n| Nickel Industries | NIC.AX | NPI, nickel metal | Ni content | https://nickelindustries.com/investors/ |\n| PT Vale Indonesia | INCO.JK | Nickel matte | Matte tonnes | https://www.vale.com/indonesia |\n| Eramet (Weda Bay) | ERA.PA | Ore, ferronickel | Ore wet tonnes | https://www.eramet.com/en/investors |\n| Antam | ANTM.JK | Ferronickel, ore | Various | https://www.antam.com/investor-relations |\n\n**Nickel Industries (NIC.AX) 關鍵數據：**\n```yaml\nFY2024_guidance:\n  NPI_production: ~100,000 t (產品噸)\n  contained_nickel: ~13,000-15,000 t (按 ~13-15% Ni)\n  RKEF_capacity: growing\n```\n\n**PT Vale Indonesia 關鍵數據：**\n```yaml\nquarterly_production:\n  matte: ~X tonnes\n  contained_nickel: ~75% Ni content\n  notes: \"Class 1 nickel, high purity\"\n```\n\n**Eramet (Weda Bay) 關鍵數據：**\n```yaml\nsold_production:\n  ore_wet_tonnes: ~X Mt\n  grades: 1.5-1.8% Ni typical\n  notes: \"需轉換為 Ni content\"\n```\n\n**⚠️ 公司報告陷阱：**\n- 口徑常不一致（product tonnes vs contained Ni）\n- 年度 vs 財年 vs 日曆年\n- 速報 vs 審計數字可能微調\n</source>\n\n<source name=\"Industrial_Parks\">\n**印尼工業園區（IMIP/IWIP）**\n\n| 園區 | 位置 | 主要產品 | 估計產能 |\n|------|------|----------|----------|\n| IMIP (Indonesia Morowali Industrial Park) | Central Sulawesi | NPI, stainless steel | ~X Mt NPI capacity |\n| IWIP (Indonesia Weda Bay Industrial Park) | North Maluku | NPI, HPAL | ~X Mt capacity (growing) |\n\n**⚠️ 產能 vs 產量：**\n- 園區常報「設計產能」而非「實際產量」\n- 新產線 ramp-up 期間產量可能只有產能的 60-80%\n</source>\n</tier_1_sources>\n\n<tier_2_sources>\n**Tier 2: 付費/半付費（更快、更完整）**\n\n<source name=\"SP_Global\">\n**S&P Global Market Intelligence**\n\n| 項目 | 說明 |\n|------|------|\n| URL | https://www.spglobal.com/marketintelligence/ |\n| 訂閱費用 | 企業級訂閱 |\n| 數據口徑 | Mine production (nickel content) |\n| 關鍵數據點 | Indonesia 2024: 2.28 Mt, share 60.2% |\n| Confidence | 0.90-0.95 |\n\n**S&P 提供的關鍵錨點：**\n```yaml\nindonesia_2024:\n  production: 2.28 Mt (2,280,000 tonnes)\n  share: 60.2%  # up from 31.5% in 2020\n  unit: nickel_content\n  source: \"S&P Global Market Intelligence\"\n```\n\n**若無訂閱，可從以下管道取得 S&P 數據引用：**\n- 投行研報（常引用 S&P）\n- 新聞報導\n- 公開演講/webinar\n\n**⚠️ 注意：**\n- 二手引用可能有轉述誤差\n- 應盡可能追溯原始來源\n</source>\n\n<source name=\"Wood_Mackenzie\">\n**Wood Mackenzie**\n\n| 項目 | 說明 |\n|------|------|\n| 訂閱費用 | 企業級訂閱 |\n| 強項 | 長期供需預測、礦山級別數據 |\n| Confidence | 0.85-0.90 |\n</source>\n\n<source name=\"Investment_Research\">\n**投行/券商研報**\n\n| 來源 | 類型 | Confidence |\n|------|------|------------|\n| BTG Research | Sell-side | 0.70-0.80 |\n| Morgan Stanley | Sell-side | 0.75-0.85 |\n| Goldman Sachs | Sell-side | 0.75-0.85 |\n\n**⚠️ 研報注意事項：**\n- 常轉引 S&P/Wood Mac 數據，但可能不標來源\n- 預測值 vs 實際值需區分\n- \"Our estimate\" 需謹慎使用\n</source>\n</tier_2_sources>\n\n<tier_3_sources>\n**Tier 3: 政策/配額近期訊息**\n\n<source name=\"Policy_News\">\n**印尼政策與配額**\n\n| 資訊類型 | 來源 | 時效性 |\n|----------|------|--------|\n| RKAB 配額 | Indonesian government announcements | 即時 |\n| 出口規則 | Ministry of Trade | 即時 |\n| 減產傳聞 | Reuters, Bloomberg | 需驗證 |\n\n**2026 RKAB 配額範例：**\n```yaml\nclaim: \"2026 ore quota 250 Mt vs 2025 target 379 Mt\"\nunit: ore_wet_tonnes  # ⚠️ 非 nickel content\nsource: various_news\nconfidence: 0.60\nnotes: \"政策最終版本可能調整\"\n```\n\n**⚠️ 政策資訊陷阱：**\n- 配額常以 ore wet tonnes 計算\n- 「目標」vs「實際配額」vs「執行量」差異大\n- 政策可能在最後時刻調整\n</source>\n</tier_3_sources>\n\n<data_source_priority>\n**數據來源優先序**\n\n```\n建議流程：\n1. Tier 0 (USGS + INSG) → 建立 baseline\n2. Tier 1 (公司報告) → 補充 mine-level 細節\n3. Tier 2 (S&P) → 驗證關鍵數據點\n4. Tier 3 (政策新聞) → 情境分析輸入\n\n若只有免費資源：\nTier 0 + Tier 1 已足夠做出穩健分析\n```\n</data_source_priority>\n\n<url_registry>\n**URL 清單**\n\n| 來源 | URL |\n|------|-----|\n| USGS Nickel | https://www.usgs.gov/centers/national-minerals-information-center/nickel-statistics-and-information |\n| USGS MCS 2025 | https://pubs.usgs.gov/periodicals/mcs2025/mcs2025-nickel.pdf |\n| INSG Home | https://insg.org/ |\n| INSG Market Commentary | https://insg.org/index.php/about-nickel/market-commentary/ |\n| INSG Factbook | https://insg.org/index.php/publications/ |\n| Nickel Industries IR | https://nickelindustries.com/investors/ |\n| PT Vale Indonesia | https://www.vale.com/indonesia |\n| Eramet IR | https://www.eramet.com/en/investors |\n| Weda Bay Nickel | https://www.wedabaynickel.com/ |\n| S&P Global MI | https://www.spglobal.com/marketintelligence/ |\n</url_registry>\n",
        "skills/nickel-concentration-risk-analyzer/references/failure-modes.md": "# 失敗模式與緩解策略\n\n<overview>\n本文件列舉 nickel-concentration-risk-analyzer 可能遇到的\n失敗模式、錯誤類型與對應的緩解策略。\n</overview>\n\n<failure_category name=\"data_ingestion\">\n**數據擷取失敗**\n\n<failure name=\"pdf_parse_fail\">\n**PDF 解析失敗**\n\n| 項目 | 說明 |\n|------|------|\n| 症狀 | camelot/tabula 無法正確提取表格 |\n| 原因 | PDF 格式變更、掃描件、圖片式表格 |\n| 頻率 | 中等 |\n\n**緩解策略：**\n```python\ndef robust_pdf_parse(pdf_path):\n    \"\"\"\n    多重策略 PDF 解析\n    \"\"\"\n    # 策略 1: camelot (stream)\n    try:\n        tables = camelot.read_pdf(pdf_path, flavor='stream')\n        if len(tables) > 0:\n            return tables\n    except:\n        pass\n\n    # 策略 2: camelot (lattice)\n    try:\n        tables = camelot.read_pdf(pdf_path, flavor='lattice')\n        if len(tables) > 0:\n            return tables\n    except:\n        pass\n\n    # 策略 3: tabula\n    try:\n        tables = tabula.read_pdf(pdf_path, pages='all')\n        if len(tables) > 0:\n            return tables\n    except:\n        pass\n\n    # 策略 4: OCR fallback\n    try:\n        tables = ocr_extract(pdf_path)\n        return tables\n    except:\n        pass\n\n    # 全部失敗\n    raise PDFParseError(f\"All parse methods failed for {pdf_path}\")\n```\n</failure>\n\n<failure name=\"url_change\">\n**URL 變更/失效**\n\n| 項目 | 說明 |\n|------|------|\n| 症狀 | 404 錯誤、重新導向 |\n| 原因 | 網站改版、檔案更名 |\n| 頻率 | 低（年度報告）至 中（月度更新）|\n\n**緩解策略：**\n```python\nURL_ALTERNATIVES = {\n    \"usgs_nickel\": [\n        \"https://www.usgs.gov/centers/national-minerals-information-center/nickel-statistics-and-information\",\n        \"https://pubs.usgs.gov/periodicals/mcs2025/mcs2025-nickel.pdf\",\n        \"https://pubs.usgs.gov/periodicals/mcs2024/mcs2024-nickel.pdf\",  # fallback\n    ],\n    \"insg_main\": [\n        \"https://insg.org/\",\n        \"https://insg.org/index.php/about-nickel/\",\n    ]\n}\n\ndef fetch_with_fallback(source_key):\n    for url in URL_ALTERNATIVES[source_key]:\n        try:\n            response = requests.get(url, timeout=30)\n            if response.status_code == 200:\n                return response.content\n        except:\n            continue\n    raise DataFetchError(f\"All URLs failed for {source_key}\")\n```\n</failure>\n\n<failure name=\"anti_scraping\">\n**反爬蟲阻擋**\n\n| 項目 | 說明 |\n|------|------|\n| 症狀 | 403 Forbidden、CAPTCHA |\n| 原因 | 網站反爬蟲機制 |\n| 頻率 | 中等（付費來源） |\n\n**緩解策略：**\n見 `design-human-like-crawler.md` 指南：\n- 隨機延遲\n- User-Agent 輪換\n- Selenium/Playwright fallback\n</failure>\n</failure_category>\n\n<failure_category name=\"unit_errors\">\n**單位錯誤**\n\n<failure name=\"ore_content_mix\">\n**礦石/含量混淆**\n\n| 項目 | 說明 |\n|------|------|\n| 症狀 | 計算結果差異 50-100x |\n| 原因 | 誤將 ore wet tonnes 當作 nickel content |\n| 頻率 | **高**（最常見錯誤） |\n\n**檢測方法：**\n```python\ndef detect_unit_anomaly(value, unit, country, year):\n    \"\"\"\n    檢測可能的單位錯誤\n    \"\"\"\n    # 全球年產量約 3-4 Mt Ni content\n    # 單一國家不應超過 3 Mt\n    if unit == \"t_Ni_content\" and value > 3_000_000:\n        return {\n            \"warning\": \"POSSIBLE_ORE_NOT_CONTENT\",\n            \"message\": f\"Value {value:,} seems too high for nickel content\",\n            \"suggestion\": \"Check if this is ore wet tonnes instead\"\n        }\n\n    # Indonesia 2024 約 2.3 Mt，不應超過 3 Mt\n    if country == \"Indonesia\" and unit == \"t_Ni_content\":\n        if value > 3_000_000:\n            return {\n                \"warning\": \"POSSIBLE_ORE_NOT_CONTENT\",\n                \"message\": \"Indonesia Ni content should be ~2-2.5 Mt in 2024\"\n            }\n\n    return {\"status\": \"OK\"}\n```\n\n**緩解策略：**\n- 強制在 schema 中標註 unit\n- 執行 sanity check\n- 異常值需人工確認\n</failure>\n\n<failure name=\"product_content_mix\">\n**產品噸/含量混淆**\n\n| 項目 | 說明 |\n|------|------|\n| 症狀 | 計算結果差異 5-10x |\n| 原因 | 誤將 NPI 產品噸當作 nickel content |\n| 頻率 | 中等 |\n\n**範例：**\n```\n❌ 錯誤：NPI production 100,000 t = 100,000 t Ni\n✅ 正確：NPI production 100,000 t = ~12,000-15,000 t Ni (at 12-15%)\n```\n</failure>\n</failure_category>\n\n<failure_category name=\"calculation_errors\">\n**計算錯誤**\n\n<failure name=\"share_calculation\">\n**份額計算錯誤**\n\n| 項目 | 說明 |\n|------|------|\n| 症狀 | 份額總和 ≠ 100% |\n| 原因 | 遺漏 \"Other\" 類別、重複計算 |\n| 頻率 | 低 |\n\n**驗證方法：**\n```python\ndef validate_shares(shares_dict):\n    total = sum(shares_dict.values())\n    if abs(total - 1.0) > 0.01:  # 容許 1% 誤差\n        return {\n            \"error\": \"SHARES_NOT_SUM_TO_ONE\",\n            \"total\": total,\n            \"suggestion\": \"Check for missing 'Other' category or double counting\"\n        }\n    return {\"status\": \"OK\"}\n```\n</failure>\n\n<failure name=\"hhi_overflow\">\n**HHI 計算溢出**\n\n| 項目 | 說明 |\n|------|------|\n| 症狀 | HHI > 10000 |\n| 原因 | 份額未正規化為 0-1 |\n| 頻率 | 低 |\n\n**正確計算：**\n```python\ndef calculate_hhi_safe(shares):\n    # 確保份額在 0-1 範圍\n    shares = np.clip(shares, 0, 1)\n\n    # 正規化使總和為 1\n    if shares.sum() > 0:\n        shares = shares / shares.sum()\n\n    # HHI = Σ(share² × 10000)\n    hhi = (shares ** 2).sum() * 10000\n\n    # 驗證範圍\n    assert 0 <= hhi <= 10000, f\"HHI out of range: {hhi}\"\n\n    return hhi\n```\n</failure>\n</failure_category>\n\n<failure_category name=\"scenario_errors\">\n**情境模擬錯誤**\n\n<failure name=\"execution_prob_range\">\n**執行機率超出範圍**\n\n| 項目 | 說明 |\n|------|------|\n| 症狀 | 負數或 >1 的機率 |\n| 原因 | 用戶輸入錯誤 |\n| 頻率 | 低 |\n\n**驗證方法：**\n```python\ndef validate_scenario(scenario):\n    errors = []\n\n    if not 0 <= scenario.execution_prob <= 1:\n        errors.append({\n            \"field\": \"execution_prob\",\n            \"value\": scenario.execution_prob,\n            \"error\": \"Must be between 0 and 1\"\n        })\n\n    if scenario.cut_value < 0:\n        errors.append({\n            \"field\": \"cut_value\",\n            \"value\": scenario.cut_value,\n            \"error\": \"Cut value cannot be negative\"\n        })\n\n    return errors\n```\n</failure>\n\n<failure name=\"baseline_mismatch\">\n**Baseline 口徑不匹配**\n\n| 項目 | 說明 |\n|------|------|\n| 症狀 | 衝擊百分比異常大或小 |\n| 原因 | 情境減產量與 baseline 口徑不一致 |\n| 頻率 | 中等 |\n\n**緩解策略：**\n```python\ndef check_baseline_scenario_alignment(baseline, scenario):\n    warnings = []\n\n    # 檢查 supply_type 是否一致\n    if baseline.supply_type != scenario.implied_supply_type:\n        warnings.append({\n            \"type\": \"supply_type_mismatch\",\n            \"baseline\": baseline.supply_type,\n            \"scenario\": scenario.implied_supply_type\n        })\n\n    # 檢查 unit 是否一致\n    if baseline.unit != scenario.cut_unit:\n        warnings.append({\n            \"type\": \"unit_mismatch\",\n            \"baseline\": baseline.unit,\n            \"scenario\": scenario.cut_unit,\n            \"impact\": \"Results may be off by orders of magnitude\"\n        })\n\n    return warnings\n```\n</failure>\n</failure_category>\n\n<failure_category name=\"output_errors\">\n**輸出錯誤**\n\n<failure name=\"json_serialization\">\n**JSON 序列化失敗**\n\n| 項目 | 說明 |\n|------|------|\n| 症狀 | TypeError: Object not JSON serializable |\n| 原因 | numpy/pandas 類型未轉換 |\n| 頻率 | 低 |\n\n**緩解策略：**\n```python\nimport json\nimport numpy as np\nimport pandas as pd\n\nclass NumpyEncoder(json.JSONEncoder):\n    def default(self, obj):\n        if isinstance(obj, np.integer):\n            return int(obj)\n        if isinstance(obj, np.floating):\n            return float(obj)\n        if isinstance(obj, np.ndarray):\n            return obj.tolist()\n        if isinstance(obj, pd.Timestamp):\n            return obj.isoformat()\n        return super().default(obj)\n\n# 使用\njson.dumps(result, cls=NumpyEncoder)\n```\n</failure>\n\n<failure name=\"encoding_issues\">\n**編碼問題**\n\n| 項目 | 說明 |\n|------|------|\n| 症狀 | UnicodeEncodeError |\n| 原因 | 非 ASCII 字元（如中文公司名） |\n| 頻率 | 低 |\n\n**緩解策略：**\n```python\n# 確保 UTF-8 輸出\nwith open(output_path, 'w', encoding='utf-8') as f:\n    json.dump(result, f, ensure_ascii=False, indent=2)\n```\n</failure>\n</failure_category>\n\n<error_recovery>\n**錯誤恢復策略**\n\n```python\nclass NickelAnalysisError(Exception):\n    \"\"\"基礎錯誤類\"\"\"\n    pass\n\nclass DataIngestionError(NickelAnalysisError):\n    \"\"\"數據擷取錯誤\"\"\"\n    pass\n\nclass UnitError(NickelAnalysisError):\n    \"\"\"單位錯誤\"\"\"\n    pass\n\nclass CalculationError(NickelAnalysisError):\n    \"\"\"計算錯誤\"\"\"\n    pass\n\ndef run_analysis_with_recovery(config):\n    \"\"\"\n    帶錯誤恢復的分析執行\n    \"\"\"\n    result = {\n        \"status\": \"unknown\",\n        \"data\": None,\n        \"errors\": [],\n        \"warnings\": []\n    }\n\n    try:\n        # Step 1: 數據擷取\n        data = ingest_data(config)\n    except DataIngestionError as e:\n        result[\"errors\"].append({\"stage\": \"ingestion\", \"error\": str(e)})\n        result[\"status\"] = \"failed\"\n        return result\n\n    try:\n        # Step 2: 數據驗證\n        validation_result = validate_data(data)\n        result[\"warnings\"].extend(validation_result[\"warnings\"])\n    except UnitError as e:\n        result[\"errors\"].append({\"stage\": \"validation\", \"error\": str(e)})\n        result[\"status\"] = \"failed\"\n        return result\n\n    try:\n        # Step 3: 計算\n        analysis = compute_analysis(data, config)\n        result[\"data\"] = analysis\n        result[\"status\"] = \"success\"\n    except CalculationError as e:\n        result[\"errors\"].append({\"stage\": \"calculation\", \"error\": str(e)})\n        result[\"status\"] = \"partial\"  # 可能有部分結果\n\n    return result\n```\n</error_recovery>\n\n<monitoring>\n**監控建議**\n\n```python\n# 關鍵指標監控\nMONITORING_CHECKS = {\n    \"indonesia_share_range\": {\n        \"metric\": \"indonesia_share\",\n        \"min\": 0.50,\n        \"max\": 0.75,\n        \"alert\": \"Indonesia share outside expected range\"\n    },\n    \"global_production_range\": {\n        \"metric\": \"global_production\",\n        \"min\": 3_000_000,\n        \"max\": 5_000_000,\n        \"unit\": \"t_Ni_content\",\n        \"alert\": \"Global production outside expected range\"\n    },\n    \"hhi_range\": {\n        \"metric\": \"hhi\",\n        \"min\": 2500,\n        \"max\": 6000,\n        \"alert\": \"HHI outside expected range for nickel market\"\n    }\n}\n\ndef run_monitoring_checks(result):\n    alerts = []\n    for check_name, check_config in MONITORING_CHECKS.items():\n        value = result.get(check_config[\"metric\"])\n        if value is not None:\n            if value < check_config[\"min\"] or value > check_config[\"max\"]:\n                alerts.append({\n                    \"check\": check_name,\n                    \"value\": value,\n                    \"expected_range\": [check_config[\"min\"], check_config[\"max\"]],\n                    \"alert\": check_config[\"alert\"]\n                })\n    return alerts\n```\n</monitoring>\n",
        "skills/nickel-concentration-risk-analyzer/references/indonesia-supply-structure.md": "# 印尼鎳供給結構\n\n<overview>\n印尼已成為全球鎳供給的主導力量，從 2020 年的 31.5% 市佔\n上升至 2024 年的約 60.2%（S&P Global 口徑）。本文件詳述\n印尼鎳產業的結構、關鍵園區與政策框架。\n</overview>\n\n<market_position>\n**印尼市場地位**\n\n| 年份 | 產量 (kt Ni) | 全球份額 | 來源 |\n|------|-------------|----------|------|\n| 2015 | ~400 | ~15% | USGS |\n| 2018 | ~600 | ~22% | USGS |\n| 2020 | ~760 | 31.5% | S&P Global |\n| 2022 | ~1,600 | ~48% | S&P Global |\n| 2024 | ~2,280 | 60.2% | S&P Global |\n\n**成長驅動因素：**\n1. 2020 年礦石出口禁令 → 強制在地加工\n2. 大規模 NPI (Nickel Pig Iron) 產能投資\n3. HPAL 產能擴張（電池級鎳）\n4. 中國資本與技術支持\n</market_position>\n\n<key_industrial_parks>\n**關鍵工業園區**\n\n<park name=\"IMIP\">\n**IMIP (Indonesia Morowali Industrial Park)**\n\n| 項目 | 說明 |\n|------|------|\n| 位置 | Central Sulawesi |\n| 營運方 | PT Indonesia Morowali Industrial Park |\n| 主要股東 | Tsingshan, Bintang Delapan |\n| 主要產品 | NPI, Stainless Steel |\n| 估計產能 | ~X Mt NPI/year |\n| 特點 | 全球最大鎳加工園區之一 |\n\n**IMIP 產品結構：**\n- Rotary Kiln Electric Furnace (RKEF): 生產 NPI\n- Stainless steel mill: 不鏽鋼終端產品\n- HPAL (建設中): 電池級鎳\n</park>\n\n<park name=\"IWIP\">\n**IWIP (Indonesia Weda Bay Industrial Park)**\n\n| 項目 | 說明 |\n|------|------|\n| 位置 | North Maluku (Halmahera) |\n| 營運方 | PT Weda Bay Industrial Park |\n| 主要股東 | Tsingshan, Eramet (Weda Bay Nickel) |\n| 主要產品 | NPI, HPAL (MHP) |\n| 特點 | 快速擴張中 |\n\n**Weda Bay Nickel 特點：**\n- 與 Eramet 合資\n- 高品位紅土鎳礦 (>2% Ni typical)\n- 礦石銷售 + 園區加工\n</park>\n\n<park name=\"Other_Parks\">\n**其他重要園區**\n\n| 園區 | 位置 | 主要產品 |\n|------|------|----------|\n| OSS (Obi Stainless Steel) | North Maluku | NPI, Stainless |\n| VSIP | Central Sulawesi | NPI |\n| Hengjaya/Ranger | Morowali | NPI |\n</park>\n</key_industrial_parks>\n\n<production_breakdown>\n**產量結構（2024 估計）**\n\n| 產品類型 | 估計產量 | 佔比 | 說明 |\n|----------|----------|------|------|\n| NPI | ~X Mt (Ni content) | ~70% | 不鏽鋼原料 |\n| Matte | ~X kt | ~15% | Class 1 (PT Vale) |\n| MHP | ~X kt | ~10% | 電池級（HPAL） |\n| Ferronickel | ~X kt | ~5% | 合金 |\n\n**⚠️ 口徑注意：**\n- NPI 產量常以「產品噸」報告，非「鎳含量」\n- 需乘以約 12-15% 轉換為 Ni content\n</production_breakdown>\n\n<company_landscape>\n**主要企業**\n\n<company name=\"PT_Vale\">\n**PT Vale Indonesia (INCO.JK)**\n\n| 項目 | 說明 |\n|------|------|\n| 產品 | Nickel matte (Class 1) |\n| 年產能 | ~75,000 tonnes matte |\n| 含鎳 | ~75% → ~56,000 tonnes Ni |\n| 特點 | 印尼唯一 Class 1 生產商 |\n| 出口目的地 | 日本（歷史合約） |\n</company>\n\n<company name=\"Nickel_Industries\">\n**Nickel Industries (NIC.AX)**\n\n| 項目 | 說明 |\n|------|------|\n| 產品 | NPI, Nickel metal |\n| 主要資產 | Hengjaya, Ranger (Morowali) |\n| 年產量 | ~100,000 t NPI products |\n| 含鎳 | ~12-15% → ~12,000-15,000 t Ni |\n| 上市地 | ASX (Australia) |\n</company>\n\n<company name=\"Antam\">\n**PT Antam (ANTM.JK)**\n\n| 項目 | 說明 |\n|------|------|\n| 產品 | Ferronickel, Ore |\n| 業務 | 多元化礦業（金、銀、鎳） |\n| 鎳產能 | ~18,000-20,000 tonnes Ni |\n| 特點 | 國有企業 |\n</company>\n\n<company name=\"Harita_Group\">\n**Harita Group**\n\n| 項目 | 說明 |\n|------|------|\n| 位置 | Obi Island (North Maluku) |\n| 產品 | NPI (via OSS park), HPAL |\n| 特點 | 私人集團，快速擴張中 |\n</company>\n</company_landscape>\n\n<policy_framework>\n**政策框架**\n\n<policy name=\"RKAB\">\n**RKAB (Rencana Kerja Anggaran Biaya)**\n\n| 項目 | 說明 |\n|------|------|\n| 中文 | 年度工作與預算計劃 |\n| 性質 | 礦石開採配額制度 |\n| 單位 | **Ore wet tonnes**（非 nickel content） |\n| 核發 | Ministry of Energy and Mineral Resources (ESDM) |\n\n**近期 RKAB 配額變化（傳聞）：**\n\n| 年份 | 傳聞配額 | 實際開採 | 備註 |\n|------|----------|----------|------|\n| 2024 | ~400 Mt | TBD | |\n| 2025 | ~379 Mt (target) | TBD | |\n| 2026 | ~250 Mt (rumored) | N/A | 減少 34% |\n\n**⚠️ 重要提醒：**\n- RKAB 配額是 **ore wet tonnes**\n- 轉換為 Ni content 需考慮品位 (~1.5%) 和水分 (~30%)\n- 250 Mt ore ≈ 2.6 Mt Ni content（大約估計）\n</policy>\n\n<policy name=\"Export_Ban\">\n**礦石出口禁令**\n\n| 時間 | 政策 |\n|------|------|\n| 2014 | 首次礦石出口禁令 |\n| 2017 | 放寬低品位礦石出口 |\n| 2020 | 全面禁止礦石出口 |\n| 目前 | 維持禁止，強制在地加工 |\n\n**影響：**\n- 強制礦石在國內加工\n- 刺激 NPI 產能大規模擴張\n- 中國投資湧入\n</policy>\n\n<policy name=\"DMO\">\n**DMO (Domestic Market Obligation)**\n\n| 項目 | 說明 |\n|------|------|\n| 目的 | 確保國內供給 |\n| 要求 | 部分產品需優先供應國內 |\n| 適用 | 正在討論擴大適用範圍 |\n</policy>\n</policy_framework>\n\n<supply_chain>\n**供應鏈結構**\n\n```\n[Nickel Ore (Laterite)]\n        |\n        v\n+------------------+\n|    RKEF Smelter  |  --> NPI (10-15% Ni)\n+------------------+          |\n                              v\n                      [Stainless Steel]\n\n[Nickel Ore (Laterite)]\n        |\n        v\n+------------------+\n|   HPAL Process   |  --> MHP (35-40% Ni)\n+------------------+          |\n                              v\n                    [Battery Cathode]\n\n[Nickel Ore (Sulfide/Laterite)]\n        |\n        v\n+------------------+\n|   Pyrometallurgy |  --> Matte (75% Ni)\n+------------------+          |\n                              v\n                    [Class 1 Nickel]\n```\n</supply_chain>\n\n<risk_factors>\n**風險因素**\n\n<risk name=\"policy_uncertainty\">\n**政策不確定性**\n\n- RKAB 配額年度調整\n- 出口規則可能變化\n- 環境法規趨嚴\n- 稅收政策調整\n</risk>\n\n<risk name=\"infrastructure\">\n**基礎設施風險**\n\n- 電力供應（煤電為主）\n- 物流瓶頸\n- 港口容量\n</risk>\n\n<risk name=\"environmental\">\n**環境風險**\n\n- 尾礦處理\n- 海洋排放爭議\n- 碳足跡問題（歐盟 CBAM）\n</risk>\n\n<risk name=\"concentration\">\n**集中度風險**\n\n- 單一國家主導供給\n- 政策變動影響全球\n- 地緣政治風險\n</risk>\n</risk_factors>\n\n<key_numbers>\n**關鍵數字摘要**\n\n| 指標 | 數值 | 來源 |\n|------|------|------|\n| 2024 產量 | ~2.28 Mt Ni content | S&P Global |\n| 全球份額 | 60.2% | S&P Global |\n| 2020 份額 | 31.5% | S&P Global |\n| 份額增長 | +29 pp (5年) | 計算 |\n| 主要產品 | NPI (~70%) | 產業估計 |\n| RKAB 2025 | ~379 Mt ore | 傳聞 |\n| RKAB 2026 | ~250 Mt ore (?) | 傳聞 |\n</key_numbers>\n",
        "skills/nickel-concentration-risk-analyzer/references/mine-level-anchors.md": "# Mine-Level 產量錨點\n\n<overview>\n本文件提供主要礦區/園區的產量數據錨點，\n用於驗證國家級數據或計算 Mine_CR5 指標。\n數據來源主要為公司報告（Tier 1）。\n</overview>\n\n<data_quality_note>\n**數據品質說明**\n\nMine-level 數據的挑戰：\n1. **口徑不一致**：各公司報告口徑不同\n2. **時間差異**：財年 vs 日曆年\n3. **整合難度**：需手動收集多個來源\n4. **保守估計**：部分數據為估計值\n\n**Confidence 評分基準：**\n| 來源類型 | Confidence |\n|----------|------------|\n| 審計財報數字 | 0.90 |\n| 公司新聞稿 | 0.80 |\n| 產業報告估計 | 0.65 |\n| 媒體報導 | 0.50 |\n</data_quality_note>\n\n<indonesia_anchors>\n**印尼主要礦區錨點**\n\n<anchor name=\"weda_bay\">\n**Weda Bay Nickel (Eramet 合資)**\n\n| 項目 | 數據 | 口徑 | 年份 | 來源 |\n|------|------|------|------|------|\n| Ore sold | ~X Mt | wet tonnes | 2024e | Eramet |\n| Ni grade | ~1.8% | | | |\n| Implied Ni | ~X kt | Ni content | 2024e | 計算 |\n\n**來源 URL：**\n- https://www.eramet.com/en/investors\n- https://www.wedabaynickel.com/\n\n**⚠️ 注意：**\nEramet 報告的是 \"tonnes sold\"，可能包含第三方購入礦石。\n</anchor>\n\n<anchor name=\"IMIP\">\n**IMIP (Indonesia Morowali Industrial Park)**\n\n| 項目 | 數據 | 口徑 | 年份 | 來源 |\n|------|------|------|------|------|\n| NPI capacity | ~X Mt | NPI product | 2024 | 產業報告 |\n| Implied Ni | ~X-X kt | Ni content | 2024 | @12-15% |\n\n**⚠️ 注意：**\n- IMIP 無單一公開報告\n- 需整合多家公司數據\n- 產能 ≠ 實際產量\n</anchor>\n\n<anchor name=\"nickel_industries\">\n**Nickel Industries (NIC.AX)**\n\n| 項目 | 數據 | 口徑 | 年份 | 來源 |\n|------|------|------|------|------|\n| NPI production | ~100 kt | product tonnes | 2024 | Annual Report |\n| Nickel metal | ~X kt | Ni content | 2024 | Annual Report |\n| Total Ni | ~15-18 kt | Ni content | 2024 | 計算 |\n\n**來源 URL：**\n- https://nickelindustries.com/investors/\n\n**數據結構：**\n```json\n{\n  \"company\": \"Nickel Industries\",\n  \"ticker\": \"NIC.AX\",\n  \"products\": [\n    {\n      \"type\": \"NPI\",\n      \"volume\": 100000,\n      \"unit\": \"t_NPI_product\",\n      \"ni_content_pct\": 0.13,\n      \"implied_ni\": 13000\n    },\n    {\n      \"type\": \"Nickel metal\",\n      \"volume\": 5000,\n      \"unit\": \"t_Ni_content\",\n      \"ni_content_pct\": 0.99\n    }\n  ],\n  \"total_ni_content\": 18000,\n  \"year\": 2024,\n  \"confidence\": 0.85\n}\n```\n</anchor>\n\n<anchor name=\"pt_vale\">\n**PT Vale Indonesia (INCO.JK)**\n\n| 項目 | 數據 | 口徑 | 年份 | 來源 |\n|------|------|------|------|------|\n| Matte production | ~70-75 kt | matte tonnes | 2024 | 財報 |\n| Ni content | ~75% | | | |\n| Implied Ni | ~52-56 kt | Ni content | 2024 | 計算 |\n\n**來源 URL：**\n- https://www.vale.com/indonesia\n\n**特點：**\n- 印尼唯一 Class 1 nickel 生產商\n- 高純度鎳鋶 (~75% Ni)\n- 歷史出口合約至日本\n</anchor>\n\n<anchor name=\"antam\">\n**PT Antam (ANTM.JK)**\n\n| 項目 | 數據 | 口徑 | 年份 | 來源 |\n|------|------|------|------|------|\n| Ferronickel | ~18-20 kt | Ni content | 2024 | 財報 |\n| Ore sales | ~X Mt | wet tonnes | 2024 | |\n\n**來源 URL：**\n- https://www.antam.com/investor-relations\n</anchor>\n\n<anchor name=\"harita\">\n**Harita Group (OSS Park)**\n\n| 項目 | 數據 | 口徑 | 年份 | 來源 |\n|------|------|------|------|------|\n| NPI capacity | ~X kt | Ni content | 2024 | 產業報告 |\n| HPAL capacity | ~X kt | Ni content | 2025+ | 建設中 |\n\n**⚠️ 注意：**\n- 私人企業，公開數據有限\n- 需依賴產業報告估計\n</anchor>\n</indonesia_anchors>\n\n<global_anchors>\n**全球其他主要礦區**\n\n<anchor name=\"russia\">\n**俄羅斯**\n\n| 礦區/公司 | 產量 (kt Ni) | 年份 | 來源 |\n|-----------|-------------|------|------|\n| Norilsk Nickel | ~180-200 | 2024 | 公司報告 |\n| (全國總計) | ~210 | 2024 | USGS |\n\n**Norilsk Nickel (MCX: GMKN):**\n- 全球最大硫化鎳生產商\n- 副產品：鈀、鉑、銅\n- 受制裁影響出口\n</anchor>\n\n<anchor name=\"philippines\">\n**菲律賓**\n\n| 礦區 | 產量 (kt Ni) | 年份 | 來源 |\n|------|-------------|------|------|\n| Nickel Asia | ~X | 2024 | 公司報告 |\n| Others | ~X | 2024 | 產業報告 |\n| (全國總計) | ~400 | 2024 | USGS |\n\n**特點：**\n- 主要出口礦石（過去）\n- 近年發展在地加工\n</anchor>\n\n<anchor name=\"australia\">\n**澳洲**\n\n| 礦區/公司 | 產量 (kt Ni) | 年份 | 來源 |\n|-----------|-------------|------|------|\n| BHP Nickel West | ~70-80 | 2024 | 公司報告 |\n| IGO | ~20-25 | 2024 | 公司報告 |\n| (全國總計) | ~130-150 | 2024 | USGS |\n\n**⚠️ 注意：**\n- 澳洲鎳礦面臨成本壓力\n- 部分礦山已停產或 care & maintenance\n</anchor>\n\n<anchor name=\"canada\">\n**加拿大**\n\n| 礦區/公司 | 產量 (kt Ni) | 年份 | 來源 |\n|-----------|-------------|------|------|\n| Vale Sudbury | ~X | 2024 | Vale 報告 |\n| Glencore | ~X | 2024 | Glencore 報告 |\n| (全國總計) | ~130-150 | 2024 | USGS |\n</anchor>\n\n<anchor name=\"new_caledonia\">\n**新喀里多尼亞**\n\n| 礦區/公司 | 產量 (kt Ni) | 年份 | 來源 |\n|-----------|-------------|------|------|\n| SLN (Eramet) | ~40-50 | 2024 | Eramet 報告 |\n| Prony Resources | ~X | 2024 | |\n| (全國總計) | ~100-120 | 2024 | USGS |\n\n**⚠️ 注意：**\n- 面臨營運困難\n- 政治不穩定\n- 高品位但成本高\n</anchor>\n</global_anchors>\n\n<aggregation_template>\n**數據整合模板**\n\n```python\nmine_level_data = [\n    # Indonesia\n    {\n        \"mine_name\": \"Weda Bay\",\n        \"country\": \"Indonesia\",\n        \"company\": \"Eramet JV\",\n        \"year\": 2024,\n        \"value\": X,  # kt Ni content\n        \"unit\": \"t_Ni_content\",\n        \"source_id\": \"Eramet_AR\",\n        \"confidence\": 0.80,\n        \"notes\": \"Converted from ore sales\"\n    },\n    {\n        \"mine_name\": \"IMIP Aggregate\",\n        \"country\": \"Indonesia\",\n        \"company\": \"Multiple\",\n        \"year\": 2024,\n        \"value\": X,\n        \"unit\": \"t_Ni_content\",\n        \"source_id\": \"Industry_estimate\",\n        \"confidence\": 0.60,\n        \"notes\": \"Park-level aggregate\"\n    },\n    {\n        \"mine_name\": \"Nickel Industries\",\n        \"country\": \"Indonesia\",\n        \"company\": \"Nickel Industries\",\n        \"year\": 2024,\n        \"value\": 18,\n        \"unit\": \"kt_Ni_content\",\n        \"source_id\": \"NIC_AR\",\n        \"confidence\": 0.85,\n        \"notes\": \"NPI + Nickel metal\"\n    },\n    {\n        \"mine_name\": \"PT Vale\",\n        \"country\": \"Indonesia\",\n        \"company\": \"Vale\",\n        \"year\": 2024,\n        \"value\": 55,\n        \"unit\": \"kt_Ni_content\",\n        \"source_id\": \"INCO_AR\",\n        \"confidence\": 0.90,\n        \"notes\": \"Matte production\"\n    },\n    # Russia\n    {\n        \"mine_name\": \"Norilsk\",\n        \"country\": \"Russia\",\n        \"company\": \"Norilsk Nickel\",\n        \"year\": 2024,\n        \"value\": 190,\n        \"unit\": \"kt_Ni_content\",\n        \"source_id\": \"GMKN_AR\",\n        \"confidence\": 0.85,\n        \"notes\": \"Primary nickel\"\n    },\n    # ... more entries\n]\n```\n</aggregation_template>\n\n<mine_cr5_calculation>\n**Mine CR5 計算範例**\n\n```python\ndef calculate_mine_cr5(mine_data, global_production):\n    \"\"\"\n    計算前 5 大礦區集中度\n\n    Args:\n        mine_data: List of mine production records\n        global_production: 全球總產量 (kt Ni)\n\n    Returns:\n        dict: Mine CR5 指標\n    \"\"\"\n    # 按產量排序\n    sorted_mines = sorted(\n        mine_data,\n        key=lambda x: x[\"value\"],\n        reverse=True\n    )\n\n    # 取前 5 大\n    top_5 = sorted_mines[:5]\n    top_5_total = sum(m[\"value\"] for m in top_5)\n\n    # 計算份額\n    mine_cr5 = top_5_total / global_production\n\n    return {\n        \"mine_cr5\": mine_cr5,\n        \"top_5_mines\": [\n            {\n                \"name\": m[\"mine_name\"],\n                \"value\": m[\"value\"],\n                \"share\": m[\"value\"] / global_production,\n                \"confidence\": m[\"confidence\"]\n            }\n            for m in top_5\n        ],\n        \"data_quality_note\": \"Mine-level data has higher uncertainty than country-level\"\n    }\n\n# 範例計算\n# global_production = 3700  # kt Ni (2024 estimate)\n# mine_cr5_result = calculate_mine_cr5(mine_level_data, global_production)\n```\n</mine_cr5_calculation>\n\n<limitations>\n**數據限制**\n\n1. **覆蓋率不完整**：無法覆蓋所有礦區\n2. **口徑差異**：各公司報告標準不一\n3. **時間差異**：財年與日曆年混合\n4. **估計成分高**：部分數據為產業估計\n\n**建議使用方式：**\n- 作為「錨點」驗證國家級數據\n- 計算 Mine_CR5 時標註高不確定性\n- 優先使用審計數字\n</limitations>\n",
        "skills/nickel-concentration-risk-analyzer/references/unit-conversion.md": "# 單位轉換規則與假設\n\n<overview>\n鎳供給分析中最大的陷阱是單位混淆。本文件定義所有相關單位、\n轉換規則與必要假設，確保分析口徑一致。\n</overview>\n\n<unit_definitions>\n**單位定義**\n\n| Unit Code | 中文 | 英文 | 說明 |\n|-----------|------|------|------|\n| `t_Ni_content` | 鎳金屬含量噸 | Tonnes of nickel content | 純鎳金屬重量，**本 Skill 預設** |\n| `t_ore_wet` | 礦石濕噸 | Wet tonnes of ore | 含水礦石重量（最常見誤用） |\n| `t_ore_dry` | 礦石乾噸 | Dry tonnes of ore | 乾燥後礦石重量 |\n| `t_NPI_product` | NPI 產品噸 | Tonnes of NPI product | NPI 產品重量（約 10-15% Ni） |\n| `t_matte` | 鎳鋶噸 | Tonnes of nickel matte | 鎳鋶重量（約 70-78% Ni） |\n| `t_MHP` | MHP 產品噸 | Tonnes of MHP | 氫氧化鎳鈷（約 35-40% Ni） |\n| `t_ferronickel` | 鎳鐵噸 | Tonnes of ferronickel | 鎳鐵合金（約 20-40% Ni） |\n| `t_class1` | Class 1 鎳噸 | Tonnes of Class 1 nickel | 高純度鎳（≥99.8% Ni） |\n| `t_class2` | Class 2 鎳噸 | Tonnes of Class 2 nickel | 低純度鎳（<99.8% Ni） |\n</unit_definitions>\n\n<conversion_formulas>\n**轉換公式**\n\n<formula name=\"ore_to_content\">\n**礦石 → 鎳含量**\n\n```python\ndef ore_to_nickel_content(ore_tonnes, ni_grade, moisture=0.30):\n    \"\"\"\n    將礦石噸數轉換為鎳金屬含量\n\n    Args:\n        ore_tonnes: 礦石噸數（濕噸或乾噸）\n        ni_grade: 鎳品位（小數，如 0.015 = 1.5%）\n        moisture: 水分含量（若輸入為濕噸，預設 30%）\n\n    Returns:\n        鎳金屬含量（噸）\n    \"\"\"\n    # 若為濕噸，先轉乾噸\n    dry_tonnes = ore_tonnes * (1 - moisture)\n\n    # 計算鎳含量\n    ni_content = dry_tonnes * ni_grade\n\n    return ni_content\n```\n\n**範例：**\n```\n輸入：100 Mt ore wet tonnes, 1.5% Ni grade, 30% moisture\n計算：100 * (1-0.30) * 0.015 = 1.05 Mt Ni content\n\n⚠️ 這就是為什麼 379 Mt ore quota 不等於 379 Mt nickel！\n```\n</formula>\n\n<formula name=\"NPI_to_content\">\n**NPI 產品 → 鎳含量**\n\n```python\ndef npi_to_nickel_content(npi_tonnes, ni_content_pct=0.12):\n    \"\"\"\n    NPI (Nickel Pig Iron) 轉換為鎳含量\n\n    Args:\n        npi_tonnes: NPI 產品噸數\n        ni_content_pct: NPI 含鎳百分比（通常 10-15%）\n\n    Returns:\n        鎳金屬含量（噸）\n    \"\"\"\n    return npi_tonnes * ni_content_pct\n```\n\n**NPI 品位範圍：**\n| NPI 類型 | 典型 Ni% |\n|----------|----------|\n| Low-grade NPI | 8-12% |\n| High-grade NPI | 12-18% |\n| 常用假設 | 12-13% |\n</formula>\n\n<formula name=\"matte_to_content\">\n**鎳鋶 → 鎳含量**\n\n```python\ndef matte_to_nickel_content(matte_tonnes, ni_content_pct=0.75):\n    \"\"\"\n    Nickel matte 轉換為鎳含量\n\n    Args:\n        matte_tonnes: 鎳鋶噸數\n        ni_content_pct: 鎳鋶含鎳百分比（通常 70-78%）\n    \"\"\"\n    return matte_tonnes * ni_content_pct\n```\n\n**PT Vale Indonesia 範例：**\n- 產出：~X tonnes matte\n- 含鎳：~75%\n- 等於：~X * 0.75 tonnes Ni content\n</formula>\n\n<formula name=\"MHP_to_content\">\n**MHP → 鎳含量**\n\n```python\ndef mhp_to_nickel_content(mhp_tonnes, ni_content_pct=0.38):\n    \"\"\"\n    Mixed Hydroxide Precipitate (MHP) 轉換\n\n    MHP 常用於電池級鎳，含鎳約 35-40%\n    \"\"\"\n    return mhp_tonnes * ni_content_pct\n```\n</formula>\n</conversion_formulas>\n\n<grade_assumptions>\n**品位假設**\n\n當來源數據未提供品位時，使用以下假設：\n\n| 礦區/國家 | 典型 Ni 品位 | 範圍 | 備註 |\n|-----------|-------------|------|------|\n| Indonesia (laterite) | 1.5% | 1.2-1.8% | 紅土鎳礦 |\n| Philippines (laterite) | 1.3% | 1.0-1.6% | 紅土鎳礦 |\n| Russia (sulfide) | 1.8% | 1.5-2.5% | 硫化鎳礦 |\n| Canada (sulfide) | 1.2% | 0.8-2.0% | 硫化鎳礦 |\n| New Caledonia (laterite) | 2.5% | 2.0-3.0% | 高品位紅土 |\n\n**⚠️ 使用假設時必須：**\n1. 在輸出中標記 `confidence` 降低（建議 -0.2）\n2. 標記 `is_estimate: true`\n3. 說明使用的假設值\n</grade_assumptions>\n\n<moisture_assumptions>\n**水分假設**\n\n紅土鎳礦（laterite）的濕噸 vs 乾噸差異：\n\n| 地區 | 典型水分 | 範圍 |\n|------|----------|------|\n| Indonesia | 30% | 25-35% |\n| Philippines | 28% | 23-33% |\n| New Caledonia | 32% | 28-38% |\n\n**濕噸 → 乾噸轉換：**\n```python\ndry_tonnes = wet_tonnes * (1 - moisture_pct)\n```\n</moisture_assumptions>\n\n<common_mistakes>\n**常見錯誤**\n\n<mistake name=\"ore_as_content\">\n**錯誤 1：將礦石噸當作鎳含量**\n\n```\n❌ 錯誤：\"Indonesia produced 150 Mt of nickel in 2024\"\n✅ 正確：\"Indonesia produced 150 Mt of nickel ORE in 2024\"\n        \"Indonesia produced ~2.25 Mt of nickel CONTENT in 2024\"\n\n數量級差異：~66x\n```\n</mistake>\n\n<mistake name=\"product_as_content\">\n**錯誤 2：將產品噸當作鎳含量**\n\n```\n❌ 錯誤：\"NPI production of 1 Mt = 1 Mt nickel\"\n✅ 正確：\"NPI production of 1 Mt = ~0.12 Mt nickel content (at 12% Ni)\"\n\n數量級差異：~8x\n```\n</mistake>\n\n<mistake name=\"mixed_units\">\n**錯誤 3：混用不同口徑做計算**\n\n```\n❌ 錯誤：\n  global_share = Indonesia_ore / World_nickel_content\n\n✅ 正確：\n  global_share = Indonesia_nickel_content / World_nickel_content\n  # 或\n  global_share = Indonesia_ore / World_ore\n```\n</mistake>\n\n<mistake name=\"RKAB_misinterpret\">\n**錯誤 4：誤解 RKAB 配額口徑**\n\n```\n新聞：\"Indonesia cuts 2026 RKAB quota to 250 Mt from 379 Mt\"\n\n❌ 錯誤解讀：\"Indonesia cuts nickel production by 34%\"\n\n✅ 正確解讀：\n  - 250 Mt 是 ORE wet tonnes 配額\n  - 假設 1.5% Ni, 30% moisture：\n    250 Mt * 0.70 * 0.015 ≈ 2.6 Mt Ni content\n  - 這是配額，實際開採量可能不同\n```\n</mistake>\n</common_mistakes>\n\n<validation_rules>\n**驗證規則**\n\n在處理數據時，執行以下檢查：\n\n```python\ndef validate_unit_sanity(value, unit, country, year):\n    \"\"\"\n    檢查數值是否在合理範圍\n    \"\"\"\n    # 單一國家年產量上限（Ni content）\n    if unit == \"t_Ni_content\":\n        if value > 5_000_000:  # 5 Mt\n            return Warning(\"Suspiciously high - check if this is ore not content\")\n\n    # 全球年產量合理範圍\n    if country == \"World\" and unit == \"t_Ni_content\":\n        if value < 2_000_000 or value > 6_000_000:\n            return Warning(\"Global production outside expected range (2-6 Mt)\")\n\n    # Indonesia 產量快速增長，需依年份調整預期\n    if country == \"Indonesia\" and unit == \"t_Ni_content\":\n        expected_ranges = {\n            2020: (600_000, 900_000),\n            2021: (900_000, 1_200_000),\n            2022: (1_400_000, 1_800_000),\n            2023: (1_800_000, 2_200_000),\n            2024: (2_100_000, 2_500_000),\n        }\n        if year in expected_ranges:\n            low, high = expected_ranges[year]\n            if value < low * 0.8 or value > high * 1.2:\n                return Warning(f\"Indonesia {year} outside expected range\")\n\n    return OK()\n```\n</validation_rules>\n\n<conversion_workflow>\n**轉換工作流程**\n\n```\n1. 識別來源單位\n   ↓\n2. 確認品位/含量假設\n   ↓\n3. 執行轉換\n   ↓\n4. 標記 confidence 調整\n   ↓\n5. 記錄假設\n```\n\n**輸出範例：**\n```json\n{\n  \"original_value\": 100000000,\n  \"original_unit\": \"t_ore_wet\",\n  \"converted_value\": 1050000,\n  \"converted_unit\": \"t_Ni_content\",\n  \"conversion_assumptions\": {\n    \"ni_grade\": 0.015,\n    \"moisture\": 0.30\n  },\n  \"confidence_adjustment\": -0.2,\n  \"is_estimate\": true\n}\n```\n</conversion_workflow>\n",
        "skills/nickel-concentration-risk-analyzer/templates/output-json.md": "# JSON 輸出結構模板\n\n<overview>\n定義 nickel-concentration-risk-analyzer 的標準 JSON 輸出結構。\n所有 workflow 的 JSON 輸出應遵循此模板。\n</overview>\n\n<base_structure>\n**基礎結構**\n\n所有輸出共享的基礎欄位：\n\n```json\n{\n  \"metadata\": {\n    \"skill\": \"nickel-concentration-risk-analyzer\",\n    \"version\": \"0.1.0\",\n    \"generated_at\": \"2026-01-16T12:00:00Z\",\n    \"asof_date\": \"2026-01-16\",\n    \"workflow\": \"analyze|scenario|validate|ingest\"\n  },\n  \"scope\": {\n    \"commodity\": \"nickel\",\n    \"supply_type\": \"mined\",\n    \"unit\": \"t_Ni_content\"\n  },\n  \"data_sources_used\": [],\n  \"warnings\": [],\n  \"errors\": []\n}\n```\n</base_structure>\n\n<analyze_output>\n**Analyze Workflow 輸出**\n\n```json\n{\n  \"metadata\": {\n    \"skill\": \"nickel-concentration-risk-analyzer\",\n    \"version\": \"0.1.0\",\n    \"generated_at\": \"2026-01-16T12:00:00Z\",\n    \"asof_date\": \"2026-01-16\",\n    \"workflow\": \"analyze\"\n  },\n  \"scope\": {\n    \"commodity\": \"nickel\",\n    \"supply_type\": \"mined\",\n    \"unit\": \"t_Ni_content\",\n    \"horizon\": {\n      \"history_start_year\": 2015,\n      \"history_end_year\": 2024,\n      \"analysis_year\": 2024\n    }\n  },\n  \"concentration\": {\n    \"analysis_year\": 2024,\n    \"indonesia_share\": 0.602,\n    \"cr1\": 0.602,\n    \"cr3\": 0.75,\n    \"cr5\": 0.85,\n    \"hhi\": 4002,\n    \"market_structure\": \"高集中 (Highly Concentrated)\",\n    \"top_countries\": {\n      \"Indonesia\": 0.602,\n      \"Philippines\": 0.106,\n      \"Russia\": 0.056,\n      \"Canada\": 0.040,\n      \"Australia\": 0.035\n    }\n  },\n  \"time_series\": [\n    {\n      \"year\": 2020,\n      \"indonesia_share\": 0.315,\n      \"hhi\": 2100,\n      \"market_structure\": \"中等集中\"\n    },\n    {\n      \"year\": 2021,\n      \"indonesia_share\": 0.38,\n      \"hhi\": 2500,\n      \"market_structure\": \"高集中\"\n    },\n    {\n      \"year\": 2022,\n      \"indonesia_share\": 0.48,\n      \"hhi\": 3000,\n      \"market_structure\": \"高集中\"\n    },\n    {\n      \"year\": 2023,\n      \"indonesia_share\": 0.54,\n      \"hhi\": 3500,\n      \"market_structure\": \"高集中\"\n    },\n    {\n      \"year\": 2024,\n      \"indonesia_share\": 0.602,\n      \"hhi\": 4002,\n      \"market_structure\": \"高集中\"\n    }\n  ],\n  \"key_facts\": {\n    \"indonesia_share_2024\": 0.602,\n    \"share_source\": \"S&P Global Market Intelligence\",\n    \"share_growth_5yr\": 0.287,\n    \"dominant_product\": \"NPI (~70% of Indonesia production)\"\n  },\n  \"data_sources_used\": [\n    {\n      \"name\": \"USGS MCS 2025 (Nickel)\",\n      \"tier\": 0,\n      \"confidence\": 0.95\n    },\n    {\n      \"name\": \"INSG World Nickel Statistics\",\n      \"tier\": 0,\n      \"confidence\": 0.90\n    },\n    {\n      \"name\": \"S&P Global Market Intelligence\",\n      \"tier\": 2,\n      \"confidence\": 0.90,\n      \"note\": \"Used for Indonesia share validation\"\n    }\n  ],\n  \"warnings\": [],\n  \"errors\": []\n}\n```\n</analyze_output>\n\n<scenario_output>\n**Scenario Workflow 輸出**\n\n```json\n{\n  \"metadata\": {\n    \"skill\": \"nickel-concentration-risk-analyzer\",\n    \"version\": \"0.1.0\",\n    \"generated_at\": \"2026-01-16T12:00:00Z\",\n    \"asof_date\": \"2026-01-16\",\n    \"workflow\": \"scenario\"\n  },\n  \"scope\": {\n    \"commodity\": \"nickel\",\n    \"supply_type\": \"mined\",\n    \"unit\": \"t_Ni_content\"\n  },\n  \"baseline\": {\n    \"year\": 2024,\n    \"indonesia_production_kt\": 2280,\n    \"global_production_kt\": 3780,\n    \"indonesia_share\": 0.602\n  },\n  \"scenarios\": [\n    {\n      \"name\": \"ID_RKAB_cut_2026\",\n      \"description\": \"Indonesia RKAB ore quota reduction\",\n      \"parameters\": {\n        \"target_country\": \"Indonesia\",\n        \"policy_variable\": \"ore_quota_RKAB\",\n        \"cut_type\": \"pct_country\",\n        \"cut_value\": 0.20,\n        \"start_year\": 2026,\n        \"end_year\": 2026,\n        \"execution_prob\": 0.5\n      },\n      \"results\": {\n        \"hard_cut\": {\n          \"name\": \"完全執行\",\n          \"execution_rate\": 1.0,\n          \"cut_amount_kt\": 456,\n          \"global_hit_pct\": 0.121,\n          \"equivalent_days_consumption\": 44,\n          \"risk_level\": \"極高風險\",\n          \"description\": \"政策 100% 落地\"\n        },\n        \"half_success\": {\n          \"name\": \"半成功\",\n          \"execution_rate\": 0.5,\n          \"cut_amount_kt\": 228,\n          \"global_hit_pct\": 0.060,\n          \"equivalent_days_consumption\": 22,\n          \"risk_level\": \"高風險\",\n          \"description\": \"執行 50%\"\n        },\n        \"soft_landing\": {\n          \"name\": \"軟著陸\",\n          \"execution_rate\": 0.25,\n          \"cut_amount_kt\": 114,\n          \"global_hit_pct\": 0.030,\n          \"equivalent_days_consumption\": 11,\n          \"risk_level\": \"中等風險\",\n          \"description\": \"只延遲新增產能/部分執行\"\n        }\n      },\n      \"sensitivity\": [\n        {\"execution_rate\": 1.00, \"cut_kt\": 456, \"global_hit_pct\": 0.121},\n        {\"execution_rate\": 0.75, \"cut_kt\": 342, \"global_hit_pct\": 0.090},\n        {\"execution_rate\": 0.50, \"cut_kt\": 228, \"global_hit_pct\": 0.060},\n        {\"execution_rate\": 0.25, \"cut_kt\": 114, \"global_hit_pct\": 0.030},\n        {\"execution_rate\": 0.00, \"cut_kt\": 0, \"global_hit_pct\": 0.000}\n      ]\n    }\n  ],\n  \"assumptions\": [\n    \"Baseline uses S&P Global 2024 data\",\n    \"execution_prob = 0.5 (default)\",\n    \"cut_type = pct_country (20% of Indonesia production)\",\n    \"No supply response from other countries\"\n  ],\n  \"data_sources_used\": [\n    {\n      \"name\": \"S&P Global Market Intelligence\",\n      \"tier\": 2,\n      \"confidence\": 0.90\n    }\n  ],\n  \"warnings\": [\n    {\n      \"type\": \"unit_mismatch\",\n      \"code\": \"RKAB_ORE_QUOTA\",\n      \"message\": \"RKAB ore quota is in ore wet tonnes, not nickel content\",\n      \"impact\": \"Direct percentage application may underestimate actual impact\",\n      \"recommendation\": \"Consider ore-to-content conversion with grade assumptions\"\n    }\n  ],\n  \"errors\": []\n}\n```\n</scenario_output>\n\n<validate_output>\n**Validate Workflow 輸出**\n\n```json\n{\n  \"metadata\": {\n    \"skill\": \"nickel-concentration-risk-analyzer\",\n    \"version\": \"0.1.0\",\n    \"generated_at\": \"2026-01-16T12:00:00Z\",\n    \"asof_date\": \"2026-01-16\",\n    \"workflow\": \"validate\"\n  },\n  \"scope\": {\n    \"commodity\": \"nickel\",\n    \"supply_type\": \"mined\",\n    \"unit\": \"t_Ni_content\"\n  },\n  \"claims_validated\": [\n    {\n      \"claim_id\": 1,\n      \"original_claim\": \"Indonesia controls 60-70% of global nickel supply\",\n      \"source\": \"Social media / research report\",\n      \"verdict\": \"partially_correct\",\n      \"confidence\": 0.85,\n      \"validated_value\": 0.602,\n      \"validated_unit\": \"mined nickel content\",\n      \"validated_year\": 2024,\n      \"source_chain\": [\n        {\n          \"source\": \"S&P Global Market Intelligence\",\n          \"value\": 0.602,\n          \"tier\": 2,\n          \"confidence\": 0.90,\n          \"is_primary\": true\n        },\n        {\n          \"source\": \"USGS MCS 2025\",\n          \"value\": 0.55,\n          \"tier\": 0,\n          \"confidence\": 0.95,\n          \"note\": \"Slightly lower, possible timing difference\"\n        }\n      ],\n      \"caveats\": [\n        \"Value applies to mined nickel content, not ore wet tonnes\",\n        \"70% upper bound may refer to ore production or forecast\",\n        \"Refined production share would differ\"\n      ],\n      \"recommended_statement\": \"Indonesia's 2024 mined nickel production was approximately 60% of global total (S&P Global data)\"\n    }\n  ],\n  \"cross_validation\": {\n    \"sources_checked\": 4,\n    \"consistent\": 3,\n    \"divergent\": 1,\n    \"overall_confidence\": 0.85,\n    \"conclusion\": \"High confidence - data is usable with noted caveats\"\n  },\n  \"pitfall_checks\": [\n    {\n      \"check\": \"ore_vs_content\",\n      \"status\": \"warning\",\n      \"finding\": \"Original claim did not specify unit - could be ore or content\"\n    },\n    {\n      \"check\": \"mined_vs_refined\",\n      \"status\": \"ok\",\n      \"finding\": \"Context suggests mined production\"\n    },\n    {\n      \"check\": \"year_consistency\",\n      \"status\": \"ok\",\n      \"finding\": \"All sources refer to 2024 data\"\n    }\n  ],\n  \"data_sources_used\": [\n    {\n      \"name\": \"S&P Global Market Intelligence\",\n      \"tier\": 2,\n      \"confidence\": 0.90\n    },\n    {\n      \"name\": \"USGS MCS 2025\",\n      \"tier\": 0,\n      \"confidence\": 0.95\n    },\n    {\n      \"name\": \"INSG World Nickel Statistics\",\n      \"tier\": 0,\n      \"confidence\": 0.90\n    }\n  ],\n  \"warnings\": [\n    {\n      \"type\": \"unit_ambiguity\",\n      \"code\": \"CLAIM_UNIT_UNCLEAR\",\n      \"message\": \"Original claim did not specify unit (ore vs content)\"\n    }\n  ],\n  \"errors\": []\n}\n```\n</validate_output>\n\n<ingest_output>\n**Ingest Workflow 輸出**\n\n```json\n{\n  \"metadata\": {\n    \"skill\": \"nickel-concentration-risk-analyzer\",\n    \"version\": \"0.1.0\",\n    \"generated_at\": \"2026-01-16T12:00:00Z\",\n    \"asof_date\": \"2026-01-16\",\n    \"workflow\": \"ingest\"\n  },\n  \"scope\": {\n    \"commodity\": \"nickel\",\n    \"supply_type\": \"mined\",\n    \"unit\": \"t_Ni_content\"\n  },\n  \"ingest_summary\": {\n    \"status\": \"success\",\n    \"total_records\": 225,\n    \"years_covered\": [2015, 2024],\n    \"countries_covered\": 20,\n    \"sources_processed\": 3\n  },\n  \"sources_ingested\": [\n    {\n      \"name\": \"USGS MCS 2025 (Nickel)\",\n      \"tier\": 0,\n      \"status\": \"success\",\n      \"records\": 150,\n      \"confidence\": 0.95,\n      \"url\": \"https://www.usgs.gov/...\",\n      \"download_time\": \"2026-01-16T11:30:00Z\"\n    },\n    {\n      \"name\": \"INSG World Nickel Statistics\",\n      \"tier\": 0,\n      \"status\": \"success\",\n      \"records\": 50,\n      \"confidence\": 0.90,\n      \"url\": \"https://insg.org/...\",\n      \"download_time\": \"2026-01-16T11:32:00Z\"\n    },\n    {\n      \"name\": \"Company Reports (Tier 1)\",\n      \"tier\": 1,\n      \"status\": \"partial\",\n      \"records\": 25,\n      \"confidence\": 0.75,\n      \"note\": \"Some companies have delayed reports\"\n    }\n  ],\n  \"output_files\": {\n    \"parquet\": \"data/nickel/curated/nickel_supply.parquet\",\n    \"json\": \"data/nickel/curated/nickel_supply.json\",\n    \"metadata\": \"data/nickel/curated/metadata.json\"\n  },\n  \"data_quality\": {\n    \"avg_confidence\": 0.88,\n    \"records_with_estimates\": 15,\n    \"records_with_warnings\": 5,\n    \"schema_validation\": \"passed\"\n  },\n  \"warnings\": [],\n  \"errors\": []\n}\n```\n</ingest_output>\n\n<field_definitions>\n**欄位定義**\n\n| 欄位 | 類型 | 必填 | 說明 |\n|------|------|------|------|\n| `metadata.skill` | string | Y | Skill 名稱 |\n| `metadata.version` | string | Y | Skill 版本 |\n| `metadata.generated_at` | ISO datetime | Y | 生成時間 |\n| `metadata.asof_date` | ISO date | Y | 分析基準日 |\n| `metadata.workflow` | string | Y | 執行的 workflow |\n| `scope.commodity` | string | Y | 商品（nickel） |\n| `scope.supply_type` | string | Y | mined/refined |\n| `scope.unit` | string | Y | 數據單位 |\n| `data_sources_used` | array | Y | 使用的數據來源 |\n| `warnings` | array | Y | 警告訊息 |\n| `errors` | array | Y | 錯誤訊息 |\n</field_definitions>\n",
        "skills/nickel-concentration-risk-analyzer/templates/output-markdown.md": "# Markdown 報告模板\n\n<overview>\n定義 nickel-concentration-risk-analyzer 的標準 Markdown 報告結構。\n供人類閱讀的摘要報告。\n</overview>\n\n<analyze_report>\n**Analyze Workflow 報告模板**\n\n```markdown\n## 全球鎳供給集中度分析報告\n\n**生成日期**: {generated_at}\n**分析基準日**: {asof_date}\n**數據口徑**: {supply_type} ({unit})\n\n---\n\n### 執行摘要\n\n{executive_summary}\n\n---\n\n### 關鍵發現\n\n| 指標 | 數值 | 解讀 |\n|------|------|------|\n| Indonesia share (2024) | {indonesia_share:.1%} | {share_interpretation} |\n| CR5 (前五國集中度) | {cr5:.1%} | {cr5_interpretation} |\n| HHI | {hhi:.0f} | {hhi_interpretation} |\n| 市場結構 | {market_structure} | |\n\n---\n\n### 集中度時序趨勢\n\n| 年份 | Indonesia Share | HHI | 市場結構 |\n|------|-----------------|-----|----------|\n{time_series_table}\n\n**趨勢觀察**:\n{trend_observation}\n\n---\n\n### 國家份額分布 (2024)\n\n{country_share_chart_placeholder}\n\n| 排名 | 國家 | 份額 |\n|------|------|------|\n{top_countries_table}\n\n---\n\n### 數據來源\n\n{data_sources_list}\n\n---\n\n### 口徑說明\n\n本分析使用 **{supply_type}** ({unit}) 口徑：\n\n- **mined nickel content**: 礦場產量的鎳金屬含量\n- **非** ore wet tonnes（礦石濕噸）\n- **非** refined production（精煉產量）\n\n此口徑與 S&P Global Market Intelligence 報告的 60.2% 市佔一致。\n\n---\n\n### 免責聲明\n\n本分析基於公開可得數據，結果僅供參考。\n數據來源可能有時間滯後或口徑差異。\n投資決策請自行判斷。\n\n---\n\n*Generated by nickel-concentration-risk-analyzer v{version}*\n```\n</analyze_report>\n\n<scenario_report>\n**Scenario Workflow 報告模板**\n\n```markdown\n## 政策情境衝擊分析報告\n\n**生成日期**: {generated_at}\n**分析基準日**: {asof_date}\n\n---\n\n### 情境定義\n\n| 參數 | 設定值 |\n|------|--------|\n| 情境名稱 | {scenario_name} |\n| 目標國家 | {target_country} |\n| 政策變數 | {policy_variable} |\n| 減產幅度 | {cut_value:.0%} of {cut_type} |\n| 執行機率 | {execution_prob:.0%} |\n| 適用期間 | {start_year} - {end_year} |\n\n---\n\n### Baseline 數據\n\n| 指標 | 數值 | 來源 |\n|------|------|------|\n| {target_country} 產量 (2024) | {country_prod_kt:,.0f} kt | {baseline_source} |\n| 全球產量 (2024) | {global_prod_kt:,.0f} kt | {baseline_source} |\n| {target_country} 份額 | {country_share:.1%} | |\n\n---\n\n### 衝擊分析\n\n| 情境 | 執行率 | 減產量 | 全球衝擊 | 相當於 |\n|------|--------|--------|----------|--------|\n| **Hard cut** | 100% | {hard_cut_kt:,.0f} kt | {hard_hit_pct:.1%} | {hard_days:.0f} 天消費 |\n| **Half success** | {exec_prob:.0%} | {half_cut_kt:,.0f} kt | {half_hit_pct:.1%} | {half_days:.0f} 天消費 |\n| **Soft landing** | 25% | {soft_cut_kt:,.0f} kt | {soft_hit_pct:.1%} | {soft_days:.0f} 天消費 |\n\n---\n\n### 敏感度分析\n\n{sensitivity_chart_placeholder}\n\n| 執行率 | 減產量 (kt) | 全球衝擊 (%) |\n|--------|-------------|--------------|\n{sensitivity_table}\n\n---\n\n### 關鍵發現\n\n{key_findings}\n\n---\n\n### 口徑警告\n\n{unit_warnings}\n\n---\n\n### 假設說明\n\n{assumptions_list}\n\n---\n\n### 風險評估\n\n| 風險等級 | 情境 | 衝擊規模 |\n|----------|------|----------|\n{risk_assessment_table}\n\n---\n\n*Generated by nickel-concentration-risk-analyzer v{version}*\n```\n</scenario_report>\n\n<validate_report>\n**Validate Workflow 報告模板**\n\n```markdown\n## 數據來源驗證報告\n\n**生成日期**: {generated_at}\n\n---\n\n### 待驗證說法\n\n> \"{original_claim}\"\n>\n> — 來源: {claim_source}\n\n---\n\n### 驗證結果\n\n| 項目 | 結果 |\n|------|------|\n| **判定** | {verdict_emoji} {verdict} |\n| **驗證值** | {validated_value:.1%} |\n| **正確口徑** | {validated_unit} |\n| **參考年份** | {validated_year} |\n| **置信度** | {confidence:.0%} |\n\n---\n\n### 來源追溯\n\n| 層級 | 來源 | 數據點 | Tier | 置信度 |\n|------|------|--------|------|--------|\n{source_chain_table}\n\n---\n\n### 交叉驗證\n\n| 來源 | 數據值 | 口徑 | 一致性 |\n|------|--------|------|--------|\n{cross_validation_table}\n\n**驗證結論**: {cross_validation_conclusion}\n\n---\n\n### 口徑檢查\n\n{pitfall_checks_list}\n\n---\n\n### 警示事項\n\n{caveats_list}\n\n---\n\n### 建議表述\n\n✅ **推薦表述**:\n\n> {recommended_statement}\n\n❌ **避免表述**:\n\n> {avoid_statement}\n\n---\n\n### 驗證方法論\n\n1. 識別原始來源（追溯至 Tier 0/1 數據）\n2. 確認口徑一致性（supply_type, unit, year）\n3. 交叉驗證（至少 2 個獨立來源）\n4. 標註置信度與警示\n\n---\n\n*Generated by nickel-concentration-risk-analyzer v{version}*\n```\n</validate_report>\n\n<placeholder_definitions>\n**Placeholder 說明**\n\n| Placeholder | 類型 | 說明 |\n|-------------|------|------|\n| `{generated_at}` | datetime | 報告生成時間 |\n| `{asof_date}` | date | 分析基準日 |\n| `{version}` | string | Skill 版本 |\n| `{supply_type}` | string | mined/refined |\n| `{unit}` | string | t_Ni_content 等 |\n| `{indonesia_share}` | float | 印尼份額 (0-1) |\n| `{hhi}` | float | HHI 指數 |\n| `{verdict_emoji}` | string | ✅/⚠️/❌ |\n| `{*_table}` | string | Markdown 表格內容 |\n| `{*_list}` | string | Markdown 列表內容 |\n</placeholder_definitions>\n\n<formatting_guidelines>\n**格式化指南**\n\n**數字格式化**:\n- 百分比: `{value:.1%}` → \"60.2%\"\n- 大數字: `{value:,.0f}` → \"2,280,000\"\n- 小數: `{value:.2f}` → \"0.60\"\n\n**Emoji 使用**:\n- ✅ 驗證通過\n- ⚠️ 部分正確/警告\n- ❌ 驗證失敗\n- 📊 數據圖表\n- 📌 重點標記\n\n**表格對齊**:\n```markdown\n| 左對齊 | 置中對齊 | 右對齊 |\n|:-------|:-------:|-------:|\n| text   | text    | number |\n```\n</formatting_guidelines>\n",
        "skills/nickel-concentration-risk-analyzer/workflows/analyze.md": "# Workflow: 供給集中度分析\n\n<required_reading>\n**讀取以下參考文件：**\n1. references/data-sources.md\n2. references/concentration-metrics.md\n3. references/indonesia-supply-structure.md\n</required_reading>\n\n<process>\n## Step 1: 確認分析參數\n\n收集或確認以下參數：\n\n```yaml\nasof_date: \"2026-01-16\"  # 分析基準日\nhorizon:\n  history_start_year: 2015  # 歷史起始年\n  history_end_year: 2024    # 歷史結束年（通常為最新可用年）\nscope:\n  supply_type: \"mined\"      # 必填：mined | refined\n  unit: \"t_Ni_content\"      # 預設為鎳金屬含量\ncountries:\n  - Indonesia\n  - Philippines\n  - Russia\n  - Canada\n  - Australia\n  - New Caledonia\n  - Other\ndata_level: \"free_nolimit\"  # 數據等級\n```\n\n**若用戶未提供參數**，使用上述預設值並告知。\n\n## Step 2: 數據擷取\n\n依 data_level 決定數據來源優先序：\n\n**Tier 0（必須）- Baseline：**\n- USGS Mineral Commodity Summaries (Nickel)\n  - URL: https://www.usgs.gov/centers/national-minerals-information-center/nickel-statistics-and-information\n  - 抓取：全球 + 主要國家 mine production (nickel content)\n- INSG World Nickel Statistics\n  - 抓取：供需平衡、產量增長率\n\n**Tier 1（建議）- Mine-level 錨點：**\n- 若需要 mine_CR5，需抓取公司報告\n- 見 references/mine-level-anchors.md\n\n**Tier 2（選填）- 精度驗證：**\n- 若 data_level 為 paid_low 或 paid_high，可用 S&P Global 數據交叉驗證\n\n## Step 3: 數據標準化\n\n將所有數據轉換為統一 schema：\n\n```python\nschema = {\n    \"year\": int,\n    \"country\": str,\n    \"supply_type\": str,  # \"mined\" | \"refined\"\n    \"product_group\": str,  # \"all\" | \"NPI\" | \"matte\" | \"class1\" ...\n    \"value\": float,\n    \"unit\": str,  # \"t_Ni_content\" | \"t_ore_wet\" | \"t_NPI_product\"\n    \"source_id\": str,  # \"USGS\" | \"INSG\" | \"S&P\" | \"Company\"\n    \"confidence\": float  # 0-1\n}\n```\n\n**關鍵檢查：**\n- 若來源數據單位為 ore wet tonnes，必須：\n  1. 標記 unit = \"t_ore_wet\"\n  2. 若需轉換為 nickel content，需提供 assay_grade 假設\n  3. 轉換後的數據標記 confidence 降低\n\n## Step 4: 計算集中度指標\n\n使用 scripts/compute_concentration.py 或以下邏輯：\n\n```python\ndef compute_concentration(df, year):\n    # Filter to mined nickel content\n    data = df[(df.supply_type == \"mined\") & (df.year == year)]\n\n    # Country share\n    global_prod = data.value.sum()\n    share = data.groupby(\"country\").value.sum() / global_prod\n\n    # CR_n (top N concentration)\n    sorted_share = share.sort_values(ascending=False)\n    cr1 = sorted_share.iloc[0]\n    cr3 = sorted_share.head(3).sum()\n    cr5 = sorted_share.head(5).sum()\n\n    # HHI (Herfindahl-Hirschman Index)\n    hhi = (share * 10000).pow(2).sum() / 10000  # Scale to 0-10000\n\n    return {\n        \"indonesia_share\": share.get(\"Indonesia\", 0),\n        \"cr1\": cr1,\n        \"cr3\": cr3,\n        \"cr5\": cr5,\n        \"hhi\": hhi,\n        \"market_structure\": classify_hhi(hhi)\n    }\n\ndef classify_hhi(hhi):\n    if hhi < 1500:\n        return \"低集中 (Unconcentrated)\"\n    elif hhi < 2500:\n        return \"中等集中 (Moderately Concentrated)\"\n    else:\n        return \"高集中 (Highly Concentrated)\"\n```\n\n## Step 5: 生成時序趨勢\n\n計算歷史年份的集中度變化：\n\n| 年份 | Indonesia Share | CR5 | HHI | 判讀 |\n|------|-----------------|-----|-----|------|\n| 2015 | XX% | XX% | XXXX | ... |\n| ... | ... | ... | ... | ... |\n| 2024 | ~60% | XX% | XXXX | 高集中 |\n\n**關鍵觀察點：**\n- 印尼市佔從 2020 的 ~31.5% 增至 2024 的 ~60.2%（S&P 口徑）\n- 這個增長主要來自 NPI 產能擴張\n\n## Step 6: 生成視覺化圖表（可選）\n\n使用 scripts/visualize_concentration.py 生成視覺化圖表：\n\n```bash\npython scripts/visualize_concentration.py\n```\n\n**生成的圖表**：\n1. `nickel_indonesia_share_trend_YYYYMMDD.png` - 印尼市佔率與HHI時序趨勢\n2. `nickel_country_share_pie_YYYYMMDD.png` - 2024年國家份額餅圖\n3. `nickel_concentration_metrics_YYYYMMDD.png` - 集中度指標演進（CR1, CR3, CR5）\n4. `nickel_production_volume_YYYYMMDD.png` - 印尼vs全球產量對比\n5. `nickel_risk_matrix_YYYYMMDD.png` - 集中度風險矩陣\n\n圖表自動保存到項目根目錄的 `output/` 資料夾，檔名包含當天日期。\n\n## Step 7: 輸出結果\n\n使用 templates/output-json.md 和 templates/output-markdown.md 生成輸出。\n\n**JSON 輸出結構：**\n\n```json\n{\n  \"commodity\": \"nickel\",\n  \"asof_date\": \"2026-01-16\",\n  \"scope\": {\n    \"supply_type\": \"mined\",\n    \"unit\": \"t_Ni_content\"\n  },\n  \"concentration\": {\n    \"indonesia_share_2024\": 0.602,\n    \"cr1_2024\": 0.602,\n    \"cr3_2024\": 0.XX,\n    \"cr5_2024\": 0.XX,\n    \"hhi_2024\": XXXX,\n    \"market_structure\": \"高集中\"\n  },\n  \"time_series\": [...],\n  \"data_sources_used\": [\n    \"USGS MCS (Nickel)\",\n    \"INSG World Nickel Statistics\"\n  ],\n  \"unit_warnings\": []\n}\n```\n\n**Markdown 報告結構：**\n\n```markdown\n## 全球鎳供給集中度分析\n\n**分析日期**: 2026-01-16\n**數據口徑**: Mined nickel content (鎳金屬含量)\n\n### 關鍵發現\n\n- **Indonesia share (2024)**: ~60% (S&P Global 口徑為 60.2%)\n- **市場結構**: 高集中 (HHI > 2500)\n- **趨勢**: 印尼市佔從 2020 的 31.5% 升至 2024 的 60.2%\n\n### 集中度指標\n\n| 指標 | 2024 值 | 解讀 |\n|------|---------|------|\n| CR1 (Indonesia) | 60.2% | 單一國家主導 |\n| CR5 | XX% | 前五國控制 XX% |\n| HHI | XXXX | 高集中市場 |\n\n### 數據來源\n\n- USGS Mineral Commodity Summaries 2025\n- INSG World Nickel Statistics\n- S&P Global Market Intelligence (驗證用)\n\n### 口徑說明\n\n本分析使用 **mined nickel content**（礦場產量的鎳金屬含量），\n非 ore wet tonnes（礦石濕噸）或 refined production（精煉產量）。\n```\n</process>\n\n<success_criteria>\n此 workflow 完成時：\n- [ ] 分析參數已確認或使用預設值\n- [ ] 數據來源明確標註（source_id）\n- [ ] 單位一致為 t_Ni_content\n- [ ] 計算 share, CR_n, HHI 指標\n- [ ] 輸出 JSON + Markdown 格式\n- [ ] 包含時序趨勢（至少近 5 年）\n- [ ] 標註數據口徑與來源\n</success_criteria>\n",
        "skills/nickel-concentration-risk-analyzer/workflows/ingest.md": "# Workflow: 數據擷取與標準化\n\n<required_reading>\n**讀取以下參考文件：**\n1. references/data-sources.md\n2. references/unit-conversion.md\n3. references/mine-level-anchors.md\n</required_reading>\n\n<process>\n## Step 1: 確認數據需求\n\n根據分析目標確認需要擷取的數據：\n\n```yaml\ningest_config:\n  data_level: \"free_nolimit\"  # free_nolimit | free_limit | paid_low | paid_high\n\n  target_data:\n    - type: \"country_production\"\n      years: [2015, 2024]\n      granularity: \"annual\"\n\n    - type: \"mine_level\"  # 選填，用於 mine_CR5\n      countries: [\"Indonesia\"]\n\n    - type: \"policy_info\"  # 選填，用於情境分析\n      topics: [\"RKAB\", \"export_rules\"]\n```\n\n## Step 2: Tier 0 數據擷取（必須）\n\n**2.1 USGS Mineral Commodity Summaries**\n\n```python\n# scripts/ingest_sources.py\n\ndef ingest_usgs_nickel():\n    \"\"\"\n    擷取 USGS Nickel MCS 數據\n    \"\"\"\n    config = {\n        \"url\": \"https://www.usgs.gov/centers/national-minerals-information-center/nickel-statistics-and-information\",\n        \"pdf_pattern\": \"mcs*nickel*.pdf\",\n        \"tables_to_extract\": [\n            \"World Mine Production\",\n            \"U.S. Salient Statistics\"\n        ]\n    }\n\n    # 方法 1: 直接下載 PDF 並解析\n    pdf_data = fetch_usgs_pdf(config[\"url\"])\n    tables = extract_tables_from_pdf(pdf_data, method=\"camelot\")\n\n    # 方法 2: 使用 USGS Data 頁面（若有結構化數據）\n    # https://www.usgs.gov/media/files/nickel-data-through-2023\n\n    # 標準化輸出\n    return normalize_usgs_data(tables)\n\ndef normalize_usgs_data(tables):\n    \"\"\"\n    將 USGS 數據轉換為標準 schema\n    \"\"\"\n    records = []\n    for row in tables[\"World Mine Production\"]:\n        records.append({\n            \"year\": row[\"Year\"],\n            \"country\": row[\"Country\"],\n            \"supply_type\": \"mined\",\n            \"product_group\": \"all\",\n            \"value\": float(row[\"Production\"]) * 1000,  # kt → t\n            \"unit\": \"t_Ni_content\",\n            \"source_id\": \"USGS\",\n            \"confidence\": 0.95\n        })\n    return records\n```\n\n**2.2 INSG 數據**\n\n```python\ndef ingest_insg():\n    \"\"\"\n    擷取 INSG 數據（需要處理 PDF 或網頁）\n    \"\"\"\n    sources = [\n        {\n            \"name\": \"INSG Market Commentary\",\n            \"url\": \"https://insg.org/index.php/about-nickel/market-commentary/\",\n            \"type\": \"webpage\"\n        },\n        {\n            \"name\": \"INSG World Nickel Factbook\",\n            \"url\": \"https://insg.org/index.php/publications/\",\n            \"type\": \"pdf\"\n        }\n    ]\n\n    # INSG 數據通常需要手動解析或 OCR\n    # 主要提取：\n    # - Global nickel production (tonnes)\n    # - Usage/consumption\n    # - Supply-demand balance\n\n    return normalize_insg_data(extracted_data)\n```\n\n## Step 3: Tier 1 數據擷取（建議）\n\n**3.1 公司報告擷取**\n\n```python\ndef ingest_company_reports():\n    \"\"\"\n    擷取上市公司的產量報告\n    \"\"\"\n    companies = [\n        {\n            \"name\": \"Nickel Industries\",\n            \"ticker\": \"NIC.AX\",\n            \"report_type\": \"annual_report\",\n            \"metrics\": [\"NPI_production\", \"nickel_metal_production\"],\n            \"url_pattern\": \"https://nickelindustries.com/investors/\"\n        },\n        {\n            \"name\": \"PT Vale Indonesia\",\n            \"ticker\": \"INCO.JK\",\n            \"report_type\": \"quarterly_report\",\n            \"metrics\": [\"matte_production\"],\n            \"url_pattern\": \"https://www.vale.com/indonesia\"\n        },\n        {\n            \"name\": \"Eramet (Weda Bay)\",\n            \"ticker\": \"ERA.PA\",\n            \"report_type\": \"activity_report\",\n            \"metrics\": [\"ore_sold_wet_tonnes\"],\n            \"url_pattern\": \"https://www.eramet.com/en/investors\"\n        }\n    ]\n\n    results = []\n    for company in companies:\n        data = scrape_company_report(company)\n        normalized = normalize_company_data(data, company)\n        results.extend(normalized)\n\n    return results\n```\n\n**3.2 產量錨點驗證**\n\n| 礦區/公司 | 2024 產量 | 口徑 | 來源 |\n|-----------|-----------|------|------|\n| Weda Bay | ~X Mt | ore wet tonnes | Eramet 報告 |\n| IMIP (Morowali) | ~X kt | NPI capacity | Industry reports |\n| PT Vale | ~X kt | matte | 公司財報 |\n| Nickel Industries | ~X kt | nickel metal | 年報 |\n\n## Step 4: Tier 2 數據（選填）\n\n若 data_level 為 paid_low 或 paid_high：\n\n```python\ndef ingest_sp_global():\n    \"\"\"\n    S&P Global Market Intelligence 數據\n    需要訂閱或 API access\n    \"\"\"\n    # S&P 數據點：\n    # - Indonesia 2024: 2.28 Mt (nickel content)\n    # - Indonesia share: 60.2%\n    # - Global production breakdown by country\n\n    # 若無 API，可從研報引用\n    sp_anchors = {\n        \"indonesia_prod_2024\": 2280000,  # tonnes Ni content\n        \"indonesia_share_2024\": 0.602,\n        \"source\": \"S&P Global Market Intelligence\",\n        \"confidence\": 0.90\n    }\n\n    return sp_anchors\n```\n\n## Step 5: 數據標準化與合併\n\n```python\ndef normalize_and_merge(tier0, tier1, tier2=None):\n    \"\"\"\n    合併所有來源數據並標準化\n    \"\"\"\n    all_records = []\n\n    # Tier 0: 主幹數據\n    all_records.extend(tier0)\n\n    # Tier 1: 補充數據（標記較低 confidence）\n    for record in tier1:\n        record[\"confidence\"] = min(record.get(\"confidence\", 0.8), 0.85)\n        all_records.append(record)\n\n    # Tier 2: 驗證錨點\n    if tier2:\n        # 用 Tier 2 校正 Tier 0/1 數據\n        all_records = calibrate_with_anchors(all_records, tier2)\n\n    # 轉換為 DataFrame\n    df = pd.DataFrame(all_records)\n\n    # 強制 schema 驗證\n    validate_schema(df)\n\n    return df\n\ndef validate_schema(df):\n    \"\"\"\n    驗證數據符合標準 schema\n    \"\"\"\n    required_columns = [\n        \"year\", \"country\", \"supply_type\", \"product_group\",\n        \"value\", \"unit\", \"source_id\", \"confidence\"\n    ]\n\n    for col in required_columns:\n        if col not in df.columns:\n            raise ValueError(f\"Missing required column: {col}\")\n\n    # 驗證 unit 值\n    valid_units = [\"t_Ni_content\", \"t_ore_wet\", \"t_NPI_product\", \"t_matte\", \"t_MHP\"]\n    invalid_units = df[~df.unit.isin(valid_units)].unit.unique()\n    if len(invalid_units) > 0:\n        raise ValueError(f\"Invalid unit values: {invalid_units}\")\n\n    return True\n```\n\n## Step 6: 輸出標準化數據集\n\n**輸出格式：**\n\n```python\n# Parquet（推薦，保留 schema）\ndf.to_parquet(\"data/nickel/curated/nickel_supply.parquet\")\n\n# JSON（交換用）\ndf.to_json(\"data/nickel/curated/nickel_supply.json\", orient=\"records\")\n\n# CSV（備用）\ndf.to_csv(\"data/nickel/curated/nickel_supply.csv\", index=False)\n```\n\n**輸出目錄結構：**\n\n```\ndata/nickel/\n├── raw/                          # 原始下載檔案\n│   ├── usgs/\n│   │   └── mcs-2025-nickel.pdf\n│   ├── insg/\n│   │   └── factbook-2024.pdf\n│   └── companies/\n│       └── nickel-industries-ar-2024.pdf\n├── intermediate/                 # 中間處理結果\n│   ├── usgs_extracted.json\n│   └── ingest_status.json\n└── curated/                      # 標準化數據集\n    ├── nickel_supply.parquet\n    ├── nickel_supply.json\n    └── metadata.json\n```\n\n**Metadata 範例：**\n\n```json\n{\n  \"created_at\": \"2026-01-16T12:00:00Z\",\n  \"data_level\": \"free_nolimit\",\n  \"sources_used\": [\n    {\"name\": \"USGS MCS 2025\", \"tier\": 0, \"records\": 150},\n    {\"name\": \"INSG Factbook 2024\", \"tier\": 0, \"records\": 50},\n    {\"name\": \"Company Reports\", \"tier\": 1, \"records\": 25}\n  ],\n  \"coverage\": {\n    \"years\": [2015, 2024],\n    \"countries\": 20,\n    \"supply_types\": [\"mined\", \"refined\"]\n  },\n  \"quality_metrics\": {\n    \"avg_confidence\": 0.88,\n    \"records_with_warnings\": 5\n  }\n}\n```\n</process>\n\n<success_criteria>\n此 workflow 完成時：\n- [ ] Tier 0 數據已擷取（USGS + INSG）\n- [ ] Tier 1 數據已擷取（若需要 mine-level）\n- [ ] 所有數據已標準化為統一 schema\n- [ ] schema 驗證通過\n- [ ] 輸出 parquet/json 數據集\n- [ ] 生成 metadata.json\n- [ ] ingest_status 報告已產生\n</success_criteria>\n",
        "skills/nickel-concentration-risk-analyzer/workflows/scenario-engine.md": "# Workflow: 政策情境衝擊模擬\n\n<required_reading>\n**讀取以下參考文件：**\n1. references/data-sources.md\n2. references/concentration-metrics.md\n3. references/unit-conversion.md\n4. references/indonesia-supply-structure.md\n</required_reading>\n\n<process>\n## Step 1: 收集情境參數\n\n收集或確認政策情境定義：\n\n```yaml\npolicy_scenarios:\n  - name: \"ID_RKAB_cut_2026\"\n    target_country: \"Indonesia\"\n    policy_variable: \"ore_quota_RKAB\"  # ore_quota_RKAB | mine_permit | export_rule | smelter_capacity\n    cut_type: \"pct_country\"  # pct_global | pct_country | absolute\n    cut_value: 0.20  # 減產 20%\n    start_year: 2026\n    end_year: 2026\n    execution_prob: 0.5  # 執行機率\n\nbaseline:\n  indonesia_prod_2024: 2280000  # tonnes Ni content (S&P 口徑)\n  global_prod_2024: 3780000     # tonnes Ni content (estimated)\n  indonesia_share: 0.602\n```\n\n**若用戶只說「減產 20%」**：\n- 詢問是減產國內產量的 20%（pct_country）還是全球的 20%（pct_global）\n- 預設使用 pct_country\n- 預設 execution_prob = 0.5\n\n## Step 2: 口徑警告檢查\n\n**關鍵檢查**：政策配額通常以 ore quota（礦石配額）表述，而非 nickel content。\n\n```python\ndef check_unit_alignment(scenario):\n    warnings = []\n\n    # RKAB 配額通常是 ore wet tonnes\n    if scenario.policy_variable == \"ore_quota_RKAB\":\n        warnings.append({\n            \"type\": \"unit_mismatch\",\n            \"message\": \"RKAB ore quota 通常以 ore wet tonnes 計算，非 nickel content\",\n            \"impact\": \"若直接套用百分比到 nickel content，可能低估實際衝擊\",\n            \"recommendation\": \"建議使用 assay_grade 轉換，或明確標註口徑假設\"\n        })\n\n    return warnings\n```\n\n**輸出警告範例**：\n```\n⚠️ 口徑警告：RKAB 配額（ore_quota_wet_tonnes）與分析口徑（nickel_content）不同\n   - 2026 配額 250 Mt vs 2025 目標 379 Mt 是「濕噸」非鎳含量\n   - 若品位 1.5%，250 Mt ore ≈ 3.75 Mt Ni content\n```\n\n## Step 3: 計算衝擊量\n\n使用 scripts/scenario_impact.py 或以下邏輯：\n\n```python\ndef calculate_scenario_impact(scenario, baseline):\n    \"\"\"\n    計算政策情境對全球供給的衝擊\n    \"\"\"\n    # 確定減產基數\n    if scenario.cut_type == \"pct_country\":\n        base = baseline.country_prod  # e.g., 2.28 Mt for Indonesia\n        cut_amount = base * scenario.cut_value\n    elif scenario.cut_type == \"pct_global\":\n        base = baseline.global_prod  # e.g., 3.78 Mt global\n        cut_amount = base * scenario.cut_value\n    elif scenario.cut_type == \"absolute\":\n        cut_amount = scenario.cut_value  # 直接指定數量\n\n    # 計算三層情境\n    results = {\n        \"hard_cut\": {\n            \"name\": \"完全執行\",\n            \"execution_rate\": 1.0,\n            \"cut_amount\": cut_amount,\n            \"global_hit_pct\": cut_amount / baseline.global_prod,\n            \"description\": \"政策 100% 落地\"\n        },\n        \"half_success\": {\n            \"name\": \"半成功\",\n            \"execution_rate\": scenario.execution_prob,\n            \"cut_amount\": cut_amount * scenario.execution_prob,\n            \"global_hit_pct\": (cut_amount * scenario.execution_prob) / baseline.global_prod,\n            \"description\": f\"執行 {scenario.execution_prob:.0%}\"\n        },\n        \"soft_landing\": {\n            \"name\": \"軟著陸\",\n            \"execution_rate\": 0.25,\n            \"cut_amount\": cut_amount * 0.25,\n            \"global_hit_pct\": (cut_amount * 0.25) / baseline.global_prod,\n            \"description\": \"只延遲新增產能/部分執行\"\n        }\n    }\n\n    return results\n```\n\n## Step 4: 敏感度分析\n\n計算不同執行率下的衝擊：\n\n| 執行率 | 減產量 (kt Ni) | 全球衝擊 (%) | 敘事 |\n|--------|----------------|--------------|------|\n| 100% | 456 | 12.1% | Hard cut |\n| 75% | 342 | 9.0% | |\n| 50% | 228 | 6.0% | Half success |\n| 25% | 114 | 3.0% | Soft landing |\n| 0% | 0 | 0% | 空頭支票 |\n\n## Step 5: 情境組合分析（若有多個情境）\n\n若用戶提供多個情境，計算聯合衝擊：\n\n```python\ndef combined_impact(scenarios, baseline):\n    \"\"\"\n    假設情境獨立，計算聯合期望衝擊\n    \"\"\"\n    total_expected_cut = 0\n    for sc in scenarios:\n        result = calculate_scenario_impact(sc, baseline)\n        total_expected_cut += result[\"half_success\"][\"cut_amount\"]\n\n    return {\n        \"combined_expected_cut\": total_expected_cut,\n        \"combined_global_hit_pct\": total_expected_cut / baseline.global_prod\n    }\n```\n\n## Step 6: 生成輸出\n\n**JSON 輸出結構：**\n\n```json\n{\n  \"commodity\": \"nickel\",\n  \"asof_date\": \"2026-01-16\",\n  \"scope\": {\n    \"supply_type\": \"mined\",\n    \"unit\": \"t_Ni_content\"\n  },\n  \"baseline\": {\n    \"indonesia_prod_2024\": 2280000,\n    \"global_prod_2024\": 3780000,\n    \"indonesia_share\": 0.602\n  },\n  \"scenarios\": [\n    {\n      \"name\": \"ID_RKAB_cut_2026\",\n      \"target_country\": \"Indonesia\",\n      \"policy_variable\": \"ore_quota_RKAB\",\n      \"cut_type\": \"pct_country\",\n      \"cut_value\": 0.20,\n      \"execution_prob\": 0.5,\n      \"results\": {\n        \"hard_cut\": {\n          \"cut_amount_kt\": 456,\n          \"global_hit_pct\": 0.121\n        },\n        \"half_success\": {\n          \"cut_amount_kt\": 228,\n          \"global_hit_pct\": 0.060\n        },\n        \"soft_landing\": {\n          \"cut_amount_kt\": 114,\n          \"global_hit_pct\": 0.030\n        }\n      }\n    }\n  ],\n  \"unit_warnings\": [\n    {\n      \"type\": \"unit_mismatch\",\n      \"message\": \"RKAB ore quota 通常以 ore wet tonnes 計算\"\n    }\n  ],\n  \"assumptions\": [\n    \"execution_prob = 0.5\",\n    \"cut_type = pct_country (印尼產量的 20%)\",\n    \"baseline 使用 S&P Global 2024 數據\"\n  ]\n}\n```\n\n**Markdown 報告結構：**\n\n```markdown\n## 政策情境衝擊分析\n\n**情境名稱**: ID_RKAB_cut_2026\n**目標國家**: Indonesia\n**政策變數**: RKAB 礦石配額\n**減產幅度**: 印尼產量的 20%\n\n### 衝擊分析\n\n| 情境 | 執行率 | 減產量 | 全球衝擊 |\n|------|--------|--------|----------|\n| Hard cut | 100% | 456 kt | 12.1% |\n| Half success | 50% | 228 kt | 6.0% |\n| Soft landing | 25% | 114 kt | 3.0% |\n\n### 關鍵發現\n\n- 即使只有「半成功」執行，印尼減產對全球供給仍有 **6%** 衝擊\n- 這相當於全球約 2-3 週的消費量\n- 對價格的影響可能是非對稱的（上行風險大於下行）\n\n### 口徑警告\n\n⚠️ **RKAB 配額口徑注意**：\n- RKAB 配額以「ore wet tonnes」計算\n- 本分析假設直接換算為 nickel content\n- 若礦石品位 (Ni%) 有顯著變化，衝擊量需調整\n\n### 假設說明\n\n1. Baseline 使用 S&P Global 2024 數據\n2. 執行機率預設 50%（政策不需完美執行）\n3. 減產為印尼產量的百分比（非全球）\n```\n</process>\n\n<success_criteria>\n此 workflow 完成時：\n- [ ] 情境參數完整定義\n- [ ] 輸出三層情境（hard/half/soft）\n- [ ] 包含口徑警告（若適用）\n- [ ] 敏感度分析表格\n- [ ] JSON + Markdown 輸出\n- [ ] 假設清楚說明\n- [ ] 對價格影響的定性敘述\n</success_criteria>\n",
        "skills/nickel-concentration-risk-analyzer/workflows/validate-sources.md": "# Workflow: 數據來源與口徑驗證\n\n<required_reading>\n**讀取以下參考文件：**\n1. references/data-sources.md\n2. references/unit-conversion.md\n3. references/failure-modes.md\n</required_reading>\n\n<process>\n## Step 1: 識別待驗證說法\n\n收集用戶提供的市場說法或數據點：\n\n**常見待驗證說法範例：**\n- 「印尼控制 60-70% 全球鎳供給」\n- 「Top 5 mines 控制 20% 全球產量」\n- 「2026 印尼 RKAB 配額從 379 Mt 降至 250 Mt」\n- 「印尼市佔從 30% 升至 60%」\n\n**結構化待驗證項目：**\n\n```yaml\nclaims_to_validate:\n  - claim: \"Indonesia 控制 60-70% 全球鎳供給\"\n    source: \"社群貼文/研報\"\n    claimed_value: 0.60-0.70\n    claimed_unit: \"不明確\"\n    claimed_year: 2024\n```\n\n## Step 2: 查找原始來源\n\n針對每個待驗證說法，查找可追溯的原始數據來源：\n\n**驗證 \"Indonesia 60% share\" 的來源鏈：**\n\n| 來源層級 | 來源 | 數據點 | 口徑 |\n|----------|------|--------|------|\n| L1 (原始) | S&P Global MI | 60.2% (2024) | mined nickel content |\n| L2 (引用) | BTG Research Report | ~60% | 轉引 S&P |\n| L3 (傳播) | 社群貼文 | 60-70% | 口徑不明 |\n\n**來源可靠度評分：**\n\n| Tier | 來源類型 | Confidence | 說明 |\n|------|----------|------------|------|\n| 0 | USGS/INSG 官方 | 0.9-1.0 | 口徑一致、可追溯 |\n| 1 | 公司財報 | 0.7-0.9 | 需注意報告口徑 |\n| 2 | 付費研究 (S&P) | 0.8-0.95 | 專業但需訂閱驗證 |\n| 3 | 研報/新聞 | 0.5-0.7 | 常有轉引誤差 |\n| 4 | 社群貼文 | 0.2-0.5 | 需完整驗證 |\n\n## Step 3: 口徑對齊檢查\n\n執行口徑一致性檢查：\n\n```python\ndef check_unit_consistency(claim, reference_data):\n    \"\"\"\n    檢查 claim 的口徑是否與 reference 一致\n    \"\"\"\n    issues = []\n\n    # 檢查 1: supply_type 是否一致\n    if claim.supply_type != reference_data.supply_type:\n        issues.append({\n            \"type\": \"supply_type_mismatch\",\n            \"claim_type\": claim.supply_type,\n            \"reference_type\": reference_data.supply_type,\n            \"impact\": \"mined vs refined 可差 10-30%\"\n        })\n\n    # 檢查 2: unit 是否一致\n    if claim.unit != reference_data.unit:\n        issues.append({\n            \"type\": \"unit_mismatch\",\n            \"claim_unit\": claim.unit,\n            \"reference_unit\": reference_data.unit,\n            \"impact\": \"ore_wet vs Ni_content 可差 50-100x\"\n        })\n\n    # 檢查 3: year 是否一致\n    if abs(claim.year - reference_data.year) > 1:\n        issues.append({\n            \"type\": \"year_mismatch\",\n            \"claim_year\": claim.year,\n            \"reference_year\": reference_data.year,\n            \"impact\": \"印尼市佔快速成長中，年份差異影響顯著\"\n        })\n\n    return issues\n```\n\n## Step 4: 交叉驗證\n\n使用多個獨立來源交叉驗證：\n\n**範例：驗證 \"Indonesia 60% share (2024)\"**\n\n| 來源 | 數據點 | 口徑 | 一致性 |\n|------|--------|------|--------|\n| S&P Global MI | 60.2% | mined Ni content | ✓ 基準 |\n| USGS MCS 2025 | ~55% (估) | mine production | ≈ 合理範圍 |\n| INSG | ~58% (估) | nickel production | ≈ 合理範圍 |\n| Wood Mackenzie | 60% | mined | ✓ 一致 |\n\n**驗證結論**：\n- Confidence: 0.85\n- 口徑: mined nickel content\n- 有效範圍: 58-62%\n\n## Step 5: 識別潛在陷阱\n\n常見口徑陷阱檢查清單：\n\n```yaml\npitfall_checks:\n  - name: \"ore_vs_content\"\n    description: \"礦石濕噸 vs 鎳金屬含量\"\n    red_flag: \"數字大於預期 10x 以上\"\n    example: \"379 Mt RKAB quota 是 ore wet tonnes，非 nickel content\"\n\n  - name: \"mined_vs_refined\"\n    description: \"礦場產量 vs 精煉產量\"\n    red_flag: \"不同國家排名差異大\"\n    example: \"China refined > mined，Indonesia mined > refined\"\n\n  - name: \"nickel_vs_NPI\"\n    description: \"純鎳 vs NPI 產品\"\n    red_flag: \"產品噸 vs 含鎳量\"\n    example: \"NPI 產品噸約含 10-15% Ni\"\n\n  - name: \"year_drift\"\n    description: \"年份不一致\"\n    red_flag: \"市佔快速變化時期\"\n    example: \"Indonesia 2020 31.5% → 2024 60.2%\"\n```\n\n## Step 6: 生成驗證報告\n\n**JSON 輸出結構：**\n\n```json\n{\n  \"validation_date\": \"2026-01-16\",\n  \"claims_validated\": [\n    {\n      \"claim\": \"Indonesia 控制 60-70% 全球鎳供給\",\n      \"verdict\": \"部分正確\",\n      \"confidence\": 0.85,\n      \"validated_value\": 0.602,\n      \"validated_unit\": \"mined nickel content\",\n      \"validated_year\": 2024,\n      \"source_chain\": [\n        {\n          \"source\": \"S&P Global Market Intelligence\",\n          \"value\": 0.602,\n          \"tier\": 2,\n          \"confidence\": 0.9\n        }\n      ],\n      \"caveats\": [\n        \"數字適用於 mined nickel content，非 ore wet tonnes\",\n        \"70% 上限可能是 ore 口徑或預測值\",\n        \"refined 口徑下市佔會不同\"\n      ]\n    }\n  ],\n  \"unit_warnings\": [\n    {\n      \"type\": \"unit_ambiguity\",\n      \"message\": \"原始說法未明確口徑，可能指 ore 或 content\"\n    }\n  ],\n  \"cross_validation\": {\n    \"sources_checked\": 4,\n    \"consistent\": 3,\n    \"divergent\": 1,\n    \"conclusion\": \"高置信度，數據可用\"\n  }\n}\n```\n\n**Markdown 報告結構：**\n\n```markdown\n## 數據來源驗證報告\n\n**驗證日期**: 2026-01-16\n\n### 待驗證說法\n\n> \"Indonesia 控制 60-70% 全球鎳供給\"\n\n### 驗證結果\n\n| 項目 | 結果 |\n|------|------|\n| 判定 | ⚠️ 部分正確 |\n| 驗證值 | 60.2% |\n| 正確口徑 | mined nickel content |\n| 年份 | 2024 |\n| 置信度 | 85% |\n\n### 來源追溯\n\n1. **S&P Global MI** (Tier 2): 60.2% → 基準來源\n2. **USGS MCS** (Tier 0): ~55% → 略低，可能口徑差異\n3. **INSG** (Tier 0): ~58% → 合理範圍\n\n### 口徑警告\n\n⚠️ **注意事項**：\n- 60% 適用於 **mined nickel content**\n- 若用 **ore wet tonnes**，數字會完全不同\n- **70%** 可能是預測值或不同口徑\n\n### 結論\n\n該說法在以下條件下成立：\n- ✅ 口徑: mined nickel content\n- ✅ 年份: 2024\n- ✅ 數值: ~60%（非 70%）\n\n建議表述：「印尼 2024 年 mined nickel 產量約佔全球 60%（S&P Global 數據）」\n```\n</process>\n\n<success_criteria>\n此 workflow 完成時：\n- [ ] 待驗證說法已結構化\n- [ ] 原始來源已追溯\n- [ ] 口徑對齊已檢查\n- [ ] 交叉驗證已執行\n- [ ] 潛在陷阱已識別\n- [ ] 輸出驗證報告（JSON + Markdown）\n- [ ] 給出置信度評分\n</success_criteria>\n",
        "skills/track-agri-hedge-fund-positioning/SKILL.md": "---\nname: track-agri-hedge-fund-positioning\ndescription: 用 COT 非商業部位變化，量化對沖基金在農產品期貨的資金流向，並把出口需求、USDA 數據、美元/原油/金屬等宏觀風向整合成可交易的敘事與訊號。\n---\n\n<essential_principles>\n\n<principle name=\"cot_as_flow_proxy\">\n**COT 週資料作為資金流代理**\n\nCFTC Commitments of Traders 報告是追蹤對沖基金農產品部位的核心資料：\n- **截止日**：每週二收盤\n- **發布日**：每週五下午 3:30 ET\n- **交易者分類**：非商業（投機/基金）、商業（避險）、非報告\n\n資金流 = 本週淨部位 - 上週淨部位（以合約口數計）\n</principle>\n\n<principle name=\"group_aggregation\">\n**分組彙總邏輯**\n\n使用 CFTC 原生分組（commodity_subgroup_name）：\n\n| 群組     | CFTC 分組名稱           | 包含商品                          |\n|----------|-------------------------|-----------------------------------|\n| Grains   | GRAINS                  | Corn, Wheat (SRW/HRW/HRS), Oats   |\n| Oilseeds | OILSEED and PRODUCTS    | Soybeans, Soybean Oil/Meal, Canola|\n| Meats    | LIVESTOCK/MEAT PRODUCTS | Live Cattle, Lean Hogs, Feeder    |\n| Softs    | FOODSTUFFS/SOFTS        | Coffee, Sugar, Cocoa, OJ          |\n| Fiber    | FIBER                   | Cotton                            |\n| Dairy    | DAIRY PRODUCTS          | Milk, Butter, Cheese              |\n\n**Total Flow = Grains + Oilseeds + Meats + Softs + Fiber + Dairy**\n</principle>\n\n<principle name=\"firepower_definition\">\n**火力（Buying Firepower）量化**\n\n火力衡量基金是否還有加碼空間：\n\n```\nnet_pos_percentile = rank(current_net_pos, past_N_weeks)\nfirepower = 1 - net_pos_percentile\n```\n\n- **高火力（>0.6）**：部位處於歷史低檔，仍有大量買進空間\n- **低火力（<0.3）**：部位已接近歷史高檔，擁擠風險高\n</principle>\n\n<principle name=\"macro_tailwind\">\n**宏觀順風評分**\n\n整合三個風險偏好指標：\n\n| 指標       | 訊號解讀                     |\n|------------|------------------------------|\n| 美元 (DXY) | 走弱（負報酬）= 利於商品     |\n| 原油 (WTI) | 走強（正報酬）= 風險偏好上升 |\n| 金屬       | 走強（正報酬）= 循環需求樂觀 |\n\n**macro_tailwind_score = (DXY弱 + WTI強 + Metals強) / 3**\n</principle>\n\n<principle name=\"wed_fri_validation\">\n**週中回補驗證框架**\n\nCOT 只到週二，週三～週五需用代理證據：\n\n1. **價格動能**：農產品/代理指數 Wed-Fri 累積報酬\n2. **未平倉變化**：OI 擴張 = 新倉（非純換手）\n3. **宏觀共振**：與 USD↓、油價↑、金屬↑ 同時性\n</principle>\n\n</essential_principles>\n\n<objective>\n追蹤對沖基金在農產品期貨的部位變化與資金流向：\n\n1. **取得資料**：COT 週報、宏觀指標（DXY/WTI/金屬）、基本面觸發（出口/USDA）\n2. **計算流量**：淨部位週變化，分組彙總（Grains/Oilseeds/Meats/Softs/Total）\n3. **量化火力**：用歷史分位數估算基金加碼空間\n4. **整合訊號**：判斷「基金回來買」+ 「宏觀順風」+ 「基本面支持」\n5. **產出敘事**：將圖表標註（如 Strong Corn Demand）轉為可重複的規則\n\n輸出：週流量時序、最新狀態、火力分數、宏觀評分、可交易註解。\n</objective>\n\n<quick_start>\n\n**快速開始：分析最新 COT 資料**\n\n```bash\ncd .claude/skills/track-agri-hedge-fund-positioning/scripts\npip install pandas numpy requests yfinance pyarrow  # 首次使用\npython analyze_positioning.py --start 2023-01-01\n```\n\n輸出範例（真實資料）：\n```json\n{\n  \"skill\": \"track-agri-hedge-fund-positioning\",\n  \"as_of\": \"2026-01-20\",\n  \"data_source\": \"CFTC Socrata API (real data)\",\n  \"summary\": {\n    \"call\": \"Funds continue selling\",\n    \"all_signals\": [\"Funds continue selling\", \"Extreme short - watch for reversal\", \"Macro mood bullish\"],\n    \"confidence\": 0.90\n  },\n  \"latest_metrics\": {\n    \"flow_total_contracts\": -24559,\n    \"flow_by_group_contracts\": {\"grains\": -31279, \"oilseeds\": 11517, \"meats\": 18972, \"softs\": -23887, \"fiber\": 1607, \"dairy\": -1489},\n    \"buying_firepower\": {\"total\": 0.86, \"grains\": 0.58, \"oilseeds\": 0.62, \"meats\": 0.31, \"softs\": 0.99, \"fiber\": 0.58, \"dairy\": 0.99},\n    \"macro_tailwind_score\": 0.67\n  }\n}\n```\n\n**視覺化圖表**：\n```bash\npython visualize_flows.py --weeks 52\n# 輸出：output/agri_fund_positioning_YYYY-MM-DD.png\n```\n\n</quick_start>\n\n<intake>\n需要進行什麼操作？\n\n1. **快速檢查** - 查看最新一週的基金部位變化與狀態\n2. **完整分析** - 指定日期範圍的資金流向分析與回測\n3. **視覺化圖表** - 生成分組柱狀圖與火力時序圖\n4. **監控模式** - 設定週度更新與訊號警報\n5. **方法論學習** - 了解 COT 分析與火力計算邏輯\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                       | Action                                                    |\n|--------------------------------|-----------------------------------------------------------|\n| 1, \"快速\", \"quick\", \"latest\"   | 執行 `python scripts/analyze_positioning.py`              |\n| 2, \"分析\", \"analyze\", \"full\"   | 執行 `python scripts/analyze_positioning.py --start DATE` |\n| 3, \"視覺化\", \"chart\", \"plot\"   | 執行 `python scripts/visualize_flows.py --weeks 52`       |\n| 4, \"監控\", \"monitor\", \"weekly\" | 閱讀 `workflows/monitor.md` 並執行                        |\n| 5, \"學習\", \"方法論\", \"why\"     | 閱讀 `references/methodology.md`                          |\n| 提供參數 (如日期範圍、商品)    | 使用參數執行 `analyze_positioning.py`                     |\n\n**所有腳本使用 CFTC Socrata API 取得真實資料，無模擬數據。**\n</routing>\n\n<reference_index>\n**參考文件** (`references/`)\n\n| 文件                | 內容                                   |\n|---------------------|----------------------------------------|\n| methodology.md      | COT 分析方法論、火力計算、訊號邏輯     |\n| data-sources.md     | CFTC COT、FRED、Yahoo Finance 資料來源 |\n| input-schema.md     | 完整輸入參數定義                       |\n| contracts-map.md    | 期貨合約與商品群組對照表               |\n| macro-indicators.md | 宏觀指標定義與代理序列                 |\n</reference_index>\n\n<workflows_index>\n| Workflow       | Purpose              | 使用時機           |\n|----------------|----------------------|--------------------|\n| analyze.md     | 完整資金流向分析     | 需要深度分析時     |\n| visualize.md   | 生成視覺化圖表       | 需要重建新聞圖表時 |\n| monitor.md     | 週度監控與警報       | 每週五 COT 更新後  |\n| cross-check.md | 宏觀與基本面交叉驗證 | 驗證敘事一致性時   |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose            |\n|--------------------|--------------------|\n| output-json.md     | JSON 輸出結構定義  |\n| output-markdown.md | Markdown 報告模板  |\n| annotations.md     | 圖表標註規則對照表 |\n</templates_index>\n\n<scripts_index>\n| Script                 | Command                           | Purpose                         |\n|------------------------|-----------------------------------|---------------------------------|\n| fetch_cot_data.py      | `--start 2023-01-01 --summary`    | 從 CFTC Socrata API 抓取 COT    |\n| fetch_macro_data.py    | `--start 2025-01-01 --summary`    | 抓取宏觀指標（Yahoo/FRED）      |\n| analyze_positioning.py | `--start 2023-01-01`              | 主分析腳本（自動抓取+計算）     |\n| visualize_flows.py     | `--weeks 52`                      | 生成 Bloomberg 風格視覺化圖表   |\n</scripts_index>\n\n<input_schema_summary>\n\n**必要參數**\n\n| 參數          | 類型   | 說明                            |\n|---------------|--------|---------------------------------|\n| date_start    | string | 起始日期 (YYYY-MM-DD)           |\n| date_end      | string | 結束日期 (YYYY-MM-DD)           |\n| cot_report    | string | COT 類型 (legacy/disaggregated) |\n| trader_group  | string | 交易者分類 (noncommercial)      |\n| contracts_map | object | 合約→群組對照表                 |\n\n**選用參數**\n\n| 參數                     | 類型   | 預設值 | 說明                      |\n|--------------------------|--------|--------|---------------------------|\n| position_metric          | string | net    | 部位衡量 (net/long/short) |\n| lookback_weeks_firepower | int    | 156    | 火力計算視窗（週）        |\n| macro_indicators         | object | {...}  | 宏觀指標設定              |\n| fundamental_inputs       | object | {...}  | 基本面資料設定            |\n| event_window_days        | int    | 3      | Wed-Fri 事件視窗          |\n| output_mode              | string | both   | 輸出格式 (markdown/json)  |\n\n完整參數定義見 `references/input-schema.md`。\n\n</input_schema_summary>\n\n<output_schema_summary>\n```json\n{\n  \"skill\": \"track-agri-hedge-fund-positioning\",\n  \"as_of\": \"2026-01-21\",\n  \"summary\": {\n    \"call\": \"Funds back & buying\",\n    \"confidence\": 0.72,\n    \"why\": [\"COT 週部位由負轉正\", \"分組同步改善\", \"宏觀順風\"],\n    \"risks\": [\"COT 只到週二\", \"USDA 報告可能反轉\"]\n  },\n  \"latest_metrics\": {\n    \"cot_week_end\": \"2026-01-21\",\n    \"flow_total_contracts\": 58,\n    \"flow_by_group_contracts\": {\n      \"grains\": 35, \"oilseeds\": 25, \"meats\": 5, \"softs\": 0\n    },\n    \"buying_firepower\": {\n      \"total\": 0.63, \"grains\": 0.58, \"oilseeds\": 0.67\n    },\n    \"macro_tailwind_score\": 0.67\n  },\n  \"annotations\": [\n    {\"label\": \"macro_mood_bullish\", \"rule_hit\": true, \"evidence\": [\"USD down\", \"crude up\"]}\n  ]\n}\n```\n\n完整輸出結構見 `templates/output-json.md`。\n</output_schema_summary>\n\n<success_criteria>\n執行成功時應產出：\n\n- [ ] 週流量時序（Grains/Oilseeds/Meats/Softs/Fiber/Dairy/Total）\n- [ ] 最新一週的流量與淨部位\n- [ ] 各群組的火力分數（buying_firepower）\n- [ ] 宏觀順風評分（macro_tailwind_score）\n- [ ] 可交易呼叫（call）與信心水準\n- [ ] 圖表標註（annotations）與規則觸發\n- [ ] 風險提示與下一步建議\n- [ ] Bloomberg 風格視覺化圖表（output/agri_fund_positioning_YYYY-MM-DD.png）\n</success_criteria>\n",
        "skills/track-agri-hedge-fund-positioning/references/contracts-map.md": "# 期貨合約與商品群組對照表\n\n## 1. 預設對照表\n\n```python\nDEFAULT_CONTRACTS_MAP = {\n    # Grains (穀物)\n    \"CORN\": \"grains\",\n    \"WHEAT-SRW\": \"grains\",      # Soft Red Winter (CBOT)\n    \"WHEAT-HRW\": \"grains\",      # Hard Red Winter (KCBT)\n    \"WHEAT-HRS\": \"grains\",      # Hard Red Spring (MGE)\n    \"OATS\": \"grains\",\n    \"ROUGH RICE\": \"grains\",\n    \"SORGHUM\": \"grains\",\n\n    # Oilseeds (油籽)\n    \"SOYBEANS\": \"oilseeds\",\n    \"SOYBEAN OIL\": \"oilseeds\",\n    \"SOYBEAN MEAL\": \"oilseeds\",\n\n    # Meats (肉類)\n    \"LIVE CATTLE\": \"meats\",\n    \"FEEDER CATTLE\": \"meats\",\n    \"LEAN HOGS\": \"meats\",\n\n    # Softs (軟性商品)\n    \"COFFEE C\": \"softs\",\n    \"SUGAR NO. 11\": \"softs\",\n    \"COCOA\": \"softs\",\n    \"COTTON NO. 2\": \"softs\",\n    \"ORANGE JUICE\": \"softs\"\n}\n```\n\n---\n\n## 2. 合約規格詳情\n\n### 2.1 Grains（穀物）\n\n| 商品       | CFTC 代碼 | 交易所 | 合約大小    | 報價單位       |\n|------------|-----------|--------|-------------|----------------|\n| Corn       | 002602    | CBOT   | 5,000 bu    | cents/bushel   |\n| Wheat SRW  | 001602    | CBOT   | 5,000 bu    | cents/bushel   |\n| Wheat HRW  | 001612    | KCBT   | 5,000 bu    | cents/bushel   |\n| Wheat HRS  | 001626    | MGE    | 5,000 bu    | cents/bushel   |\n| Oats       | 004603    | CBOT   | 5,000 bu    | cents/bushel   |\n| Rough Rice | 039601    | CBOT   | 2,000 cwt   | cents/cwt      |\n\n### 2.2 Oilseeds（油籽）\n\n| 商品         | CFTC 代碼 | 交易所 | 合約大小    | 報價單位       |\n|--------------|-----------|--------|-------------|----------------|\n| Soybeans     | 005602    | CBOT   | 5,000 bu    | cents/bushel   |\n| Soybean Oil  | 007601    | CBOT   | 60,000 lbs  | cents/lb       |\n| Soybean Meal | 026603    | CBOT   | 100 tons    | $/ton          |\n\n### 2.3 Meats（肉類）\n\n| 商品          | CFTC 代碼 | 交易所 | 合約大小    | 報價單位       |\n|---------------|-----------|--------|-------------|----------------|\n| Live Cattle   | 057642    | CME    | 40,000 lbs  | cents/lb       |\n| Feeder Cattle | 061641    | CME    | 50,000 lbs  | cents/lb       |\n| Lean Hogs     | 054642    | CME    | 40,000 lbs  | cents/lb       |\n\n### 2.4 Softs（軟性商品）\n\n| 商品         | CFTC 代碼 | 交易所 | 合約大小    | 報價單位       |\n|--------------|-----------|--------|-------------|----------------|\n| Coffee C     | 083731    | ICE    | 37,500 lbs  | cents/lb       |\n| Sugar No.11  | 080732    | ICE    | 112,000 lbs | cents/lb       |\n| Cocoa        | 073732    | ICE    | 10 MT       | $/MT           |\n| Cotton No.2  | 033661    | ICE    | 50,000 lbs  | cents/lb       |\n| Orange Juice | 040701    | ICE    | 15,000 lbs  | cents/lb       |\n\n---\n\n## 3. CFTC COT 報表中的名稱\n\nCOT 報表中的商品名稱可能與上述不完全一致，以下是常見對照：\n\n| COT 報表名稱                           | 簡稱         | 群組     |\n|----------------------------------------|--------------|----------|\n| CORN - CHICAGO BOARD OF TRADE          | CORN         | grains   |\n| WHEAT-SRW - CHICAGO BOARD OF TRADE     | WHEAT-SRW    | grains   |\n| WHEAT-HRW - KANSAS CITY BOARD OF TRADE | WHEAT-HRW    | grains   |\n| WHEAT-HRS - MINNEAPOLIS GRAIN EXCHANGE | WHEAT-HRS    | grains   |\n| SOYBEANS - CHICAGO BOARD OF TRADE      | SOYBEANS     | oilseeds |\n| SOYBEAN OIL - CHICAGO BOARD OF TRADE   | SOYBEAN OIL  | oilseeds |\n| SOYBEAN MEAL - CHICAGO BOARD OF TRADE  | SOYBEAN MEAL | oilseeds |\n| LIVE CATTLE - CHICAGO MERCANTILE EXCH  | LIVE CATTLE  | meats    |\n| LEAN HOGS - CHICAGO MERCANTILE EXCH    | LEAN HOGS    | meats    |\n| COFFEE C - ICE FUTURES U.S.            | COFFEE C     | softs    |\n| SUGAR NO. 11 - ICE FUTURES U.S.        | SUGAR NO. 11 | softs    |\n| COTTON NO. 2 - ICE FUTURES U.S.        | COTTON NO. 2 | softs    |\n\n---\n\n## 4. 標準化邏輯\n\n### 4.1 名稱匹配函數\n\n```python\ndef normalize_contract_name(raw_name):\n    \"\"\"標準化 COT 報表中的商品名稱\"\"\"\n    # 移除交易所後綴\n    name = raw_name.split(\" - \")[0].strip().upper()\n\n    # 處理特殊情況\n    mappings = {\n        \"WHEAT\": \"WHEAT-SRW\",  # 預設為 SRW\n        \"WHEAT (SOFT RED WINTER)\": \"WHEAT-SRW\",\n        \"WHEAT (HARD RED WINTER)\": \"WHEAT-HRW\",\n        \"WHEAT (HARD RED SPRING)\": \"WHEAT-HRS\",\n        \"SOYBEAN\": \"SOYBEANS\",\n        \"SOY MEAL\": \"SOYBEAN MEAL\",\n        \"SOY OIL\": \"SOYBEAN OIL\",\n        \"HOGS\": \"LEAN HOGS\",\n        \"CATTLE\": \"LIVE CATTLE\",\n        \"COFFEE\": \"COFFEE C\",\n        \"SUGAR\": \"SUGAR NO. 11\",\n        \"COTTON\": \"COTTON NO. 2\"\n    }\n\n    return mappings.get(name, name)\n```\n\n### 4.2 群組映射函數\n\n```python\ndef get_group(contract_name, contracts_map=None):\n    \"\"\"取得商品所屬群組\"\"\"\n    if contracts_map is None:\n        contracts_map = DEFAULT_CONTRACTS_MAP\n\n    normalized = normalize_contract_name(contract_name)\n    return contracts_map.get(normalized, \"other\")\n```\n\n---\n\n## 5. 自訂對照表\n\n使用者可以自訂對照表以符合特定需求：\n\n```json\n{\n  \"custom_contracts_map\": {\n    \"CORN\": \"row_crops\",\n    \"WHEAT-SRW\": \"row_crops\",\n    \"SOYBEANS\": \"row_crops\",\n    \"LIVE CATTLE\": \"proteins\",\n    \"LEAN HOGS\": \"proteins\",\n    \"COFFEE C\": \"tropical\",\n    \"SUGAR NO. 11\": \"tropical\",\n    \"COCOA\": \"tropical\"\n  }\n}\n```\n\n這樣可以依據分析目的調整分組邏輯。\n\n---\n\n## 6. 注意事項\n\n1. **Mini/Micro 合約**：部分商品有 Mini 版本，通常應排除或分開計算\n2. **期權與期貨**：COT 有分開報告和合併報告，建議使用合併報告\n3. **新上市商品**：新商品可能需要手動加入對照表\n4. **交易所變更**：部分商品可能轉移交易所，需注意歷史連續性\n",
        "skills/track-agri-hedge-fund-positioning/references/data-sources.md": "# 資料來源\n\n## 1. CFTC COT Reports（核心）\n\n### 1.1 官方來源\n\n| 項目         | 說明                                                    |\n|--------------|--------------------------------------------------------|\n| **官網**     | https://www.cftc.gov/MarketReports/CommitmentsofTraders |\n| **發布日**   | 每週五 15:30 ET                                         |\n| **截止日**   | 每週二收盤                                              |\n| **格式**     | CSV, TXT                                                |\n| **費用**     | 免費公開                                                |\n| **歷史檔案** | 1986 年至今                                             |\n\n### 1.2 下載 URL 格式\n\n**當年資料**：\n```\nhttps://www.cftc.gov/dea/newcot/deafut.txt        # 期貨\nhttps://www.cftc.gov/dea/newcot/deacom.txt        # 合併（期貨+選擇權）\nhttps://www.cftc.gov/dea/newcot/f_disagg.txt      # Disaggregated\n```\n\n**歷史資料**：\n```\nhttps://www.cftc.gov/files/dea/history/fut_fin_txt_{YEAR}.zip\nhttps://www.cftc.gov/files/dea/history/fut_disagg_txt_{YEAR}.zip\n```\n\n### 1.3 欄位說明（Legacy Report）\n\n| 欄位                      | 說明                  |\n|---------------------------|-----------------------|\n| Market_and_Exchange_Names | 商品與交易所          |\n| As_of_Date_In_Form_YYMMDD | COT 截止日期          |\n| Open_Interest_All         | 總未平倉量            |\n| NonComm_Positions_Long    | 非商業多單            |\n| NonComm_Positions_Short   | 非商業空單            |\n| NonComm_Positions_Spread  | 非商業價差            |\n| Comm_Positions_Long       | 商業多單              |\n| Comm_Positions_Short      | 商業空單              |\n| NonRept_Positions_Long    | 非報告多單            |\n| NonRept_Positions_Short   | 非報告空單            |\n\n---\n\n## 2. 宏觀指標\n\n### 2.1 FRED（免費，無需 API Key）\n\n**CSV 下載 URL**：\n```\nhttps://fred.stlouisfed.org/graph/fredgraph.csv?id={SERIES_ID}&cosd={START}&coed={END}\n```\n\n**可用序列**：\n\n| 用途        | Series ID      | 說明                        |\n|-------------|----------------|-----------------------------|\n| 美元指數    | DTWEXBGS       | Trade Weighted USD (Broad)  |\n| 短端利率    | DGS2           | 2Y Treasury                 |\n| 長端利率    | DGS10          | 10Y Treasury                |\n| VIX         | VIXCLS         | CBOE VIX                    |\n| 信用利差    | BAMLC0A0CM     | IG OAS                      |\n\n### 2.2 Yahoo Finance（免費）\n\n使用 `yfinance` 套件：\n\n```python\nimport yfinance as yf\n\n# 美元指數代理\nuup = yf.download(\"UUP\", start=\"2025-01-01\", end=\"2026-01-27\")\n\n# 原油\nwti = yf.download(\"CL=F\", start=\"2025-01-01\", end=\"2026-01-27\")\n\n# 金屬 ETF\nxme = yf.download(\"XME\", start=\"2025-01-01\", end=\"2026-01-27\")\n\n# 農產品 ETF\ndba = yf.download(\"DBA\", start=\"2025-01-01\", end=\"2026-01-27\")\n```\n\n**常用代碼**：\n\n| 用途         | Symbol   | 說明                    |\n|--------------|----------|-------------------------|\n| 美元 ETF     | UUP      | Invesco DB US Dollar    |\n| 原油期貨     | CL=F     | WTI Crude               |\n| 黃金期貨     | GC=F     | Gold                    |\n| 金屬 ETF     | XME      | SPDR S&P Metals & Mining|\n| 農產品 ETF   | DBA      | Invesco DB Agriculture  |\n| 玉米期貨     | ZC=F     | Corn                    |\n| 大豆期貨     | ZS=F     | Soybeans                |\n| 小麥期貨     | ZW=F     | Wheat                   |\n\n---\n\n## 3. 基本面資料\n\n### 3.1 USDA Export Sales\n\n| 項目         | 說明                                           |\n|--------------|------------------------------------------------|\n| **官網**     | https://apps.fas.usda.gov/export-sales/esrd1.html |\n| **發布日**   | 每週四 8:30 ET                                  |\n| **商品**     | 穀物、油籽、棉花、肉類                          |\n| **格式**     | HTML, Excel                                     |\n| **費用**     | 免費公開                                        |\n\n### 3.2 USDA WASDE\n\n| 項目         | 說明                                           |\n|--------------|------------------------------------------------|\n| **官網**     | https://www.usda.gov/oce/commodity/wasde       |\n| **發布日**   | 每月約 10-12 日                                 |\n| **格式**     | PDF, TXT                                        |\n| **費用**     | 免費公開                                        |\n\n可搭配 `wasde-ingestor` skill 使用。\n\n### 3.3 USDA Crop Progress\n\n| 項目         | 說明                                           |\n|--------------|------------------------------------------------|\n| **官網**     | https://usda.library.cornell.edu/concern/publications/8336h188j |\n| **發布日**   | 每週一 16:00 ET（生長季）                       |\n| **格式**     | PDF                                             |\n| **費用**     | 免費公開                                        |\n\n---\n\n## 4. 資料抓取範例\n\n### 4.1 抓取 COT 資料\n\n```python\nimport pandas as pd\nimport requests\nfrom io import StringIO\n\ndef fetch_cot_legacy(year=2026):\n    \"\"\"抓取 Legacy COT 資料\"\"\"\n    if year == 2026:\n        url = \"https://www.cftc.gov/dea/newcot/deafut.txt\"\n    else:\n        url = f\"https://www.cftc.gov/files/dea/history/fut_fin_txt_{year}.zip\"\n\n    response = requests.get(url, timeout=60)\n    response.raise_for_status()\n\n    df = pd.read_csv(StringIO(response.text))\n    return df\n```\n\n### 4.2 抓取 FRED 資料\n\n```python\ndef fetch_fred_series(series_id, start_date, end_date):\n    \"\"\"從 FRED 抓取時間序列（無需 API key）\"\"\"\n    url = \"https://fred.stlouisfed.org/graph/fredgraph.csv\"\n    params = {\n        \"id\": series_id,\n        \"cosd\": start_date,\n        \"coed\": end_date\n    }\n\n    response = requests.get(url, params=params, timeout=30)\n    response.raise_for_status()\n\n    df = pd.read_csv(StringIO(response.text))\n    df.columns = [\"DATE\", series_id]\n    df[\"DATE\"] = pd.to_datetime(df[\"DATE\"])\n    df[series_id] = pd.to_numeric(df[series_id].replace(\".\", pd.NA), errors=\"coerce\")\n    df = df.dropna().set_index(\"DATE\")\n\n    return df[series_id]\n```\n\n---\n\n## 5. 資料更新頻率\n\n| 資料來源       | 更新頻率 | 發布時間        | 延遲   |\n|----------------|----------|-----------------|--------|\n| CFTC COT       | 週       | 週五 15:30 ET   | T+3    |\n| FRED           | 日       | 即時            | T+0    |\n| Yahoo Finance  | 日       | 即時            | T+0    |\n| USDA Export    | 週       | 週四 8:30 ET    | T+0    |\n| USDA WASDE     | 月       | 約 10-12 日     | T+0    |\n\n---\n\n## 6. 備援與 Fallback\n\n### 6.1 COT 資料備援\n\n| 主要來源   | 備援來源                    |\n|------------|-----------------------------|\n| CFTC 官網  | Quandl (付費)               |\n| CFTC 官網  | CME Group (部分商品)        |\n| CFTC 官網  | 手動下載 + 本地快取         |\n\n### 6.2 宏觀指標備援\n\n| 主要來源       | 備援來源              |\n|----------------|-----------------------|\n| FRED DXY proxy | Yahoo Finance UUP     |\n| Yahoo CL=F     | FRED DCOILWTICO       |\n| Yahoo XME      | FRED 工業金屬指數     |\n",
        "skills/track-agri-hedge-fund-positioning/references/input-schema.md": "# 輸入參數定義\n\n## 1. 必要參數\n\n### date_start\n| 屬性     | 值                |\n|----------|-------------------|\n| 類型     | string            |\n| 格式     | YYYY-MM-DD        |\n| 必要     | 是                |\n| 說明     | 分析起始日期      |\n| 範例     | \"2025-01-01\"      |\n\n### date_end\n| 屬性     | 值                |\n|----------|-------------------|\n| 類型     | string            |\n| 格式     | YYYY-MM-DD        |\n| 必要     | 是                |\n| 說明     | 分析結束日期      |\n| 範例     | \"2026-01-21\"      |\n\n### cot_report\n| 屬性     | 值                                      |\n|----------|-----------------------------------------|\n| 類型     | string                                  |\n| 必要     | 是                                      |\n| 可用值   | \"legacy\", \"disaggregated\", \"tff\"        |\n| 預設     | \"legacy\"                                |\n| 說明     | COT 報表類型                            |\n\n**各類型說明**：\n- `legacy`: 傳統分類（Commercial/Non-Commercial），歷史最長\n- `disaggregated`: 細分類（Producer/Swap/Managed Money），2009 年後\n- `tff`: 金融期貨專用，不適用農產品\n\n### trader_group\n| 屬性     | 值                                      |\n|----------|-----------------------------------------|\n| 類型     | string                                  |\n| 必要     | 是                                      |\n| 可用值   | 依 cot_report 類型而定                  |\n| 預設     | \"noncommercial\"                         |\n| 說明     | 追蹤的交易者分類                        |\n\n**Legacy 報表可用值**：\n- `noncommercial`: 非商業（投機/基金）\n- `commercial`: 商業（避險）\n- `nonreportable`: 非報告（小戶）\n\n**Disaggregated 報表可用值**：\n- `managed_money`: 管理資金（對沖基金、CTA）\n- `producer_merchant`: 生產商/貿易商\n- `swap_dealer`: 交換交易商\n- `other_reportable`: 其他報告者\n\n### contracts_map\n| 屬性     | 值                                      |\n|----------|-----------------------------------------|\n| 類型     | object                                  |\n| 必要     | 是                                      |\n| 說明     | 期貨合約 → 商品群組對照表               |\n\n**範例**：\n```json\n{\n  \"CORN\": \"grains\",\n  \"WHEAT-SRW\": \"grains\",\n  \"WHEAT-HRW\": \"grains\",\n  \"SOYBEANS\": \"oilseeds\",\n  \"SOYBEAN OIL\": \"oilseeds\",\n  \"SOYBEAN MEAL\": \"oilseeds\",\n  \"LIVE CATTLE\": \"meats\",\n  \"LEAN HOGS\": \"meats\",\n  \"COFFEE C\": \"softs\",\n  \"SUGAR NO. 11\": \"softs\",\n  \"COTTON NO. 2\": \"softs\"\n}\n```\n\n詳細對照表見 `references/contracts-map.md`。\n\n---\n\n## 2. 選用參數\n\n### position_metric\n| 屬性     | 值                    |\n|----------|-----------------------|\n| 類型     | string                |\n| 必要     | 否                    |\n| 可用值   | \"net\", \"long\", \"short\"|\n| 預設     | \"net\"                 |\n| 說明     | 部位衡量方式          |\n\n**計算邏輯**：\n- `net`: Long - Short（淨部位）\n- `long`: 只看多單部位\n- `short`: 只看空單部位\n\n### lookback_weeks_firepower\n| 屬性     | 值                    |\n|----------|-----------------------|\n| 類型     | integer               |\n| 必要     | 否                    |\n| 預設     | 156                   |\n| 範圍     | 26 - 520              |\n| 說明     | 計算火力的歷史視窗週數|\n\n**常用值**：\n- 52: 1 年（短期循環）\n- 104: 2 年（中期循環）\n- 156: 3 年（完整景氣循環，推薦）\n- 260: 5 年（跨多個循環）\n\n### macro_indicators\n| 屬性     | 值                    |\n|----------|-----------------------|\n| 類型     | object                |\n| 必要     | 否                    |\n| 說明     | 宏觀指標設定          |\n\n**預設值**：\n```json\n{\n  \"usd\": {\n    \"source\": \"yahoo\",\n    \"symbol\": \"UUP\",\n    \"description\": \"美元 ETF\"\n  },\n  \"crude\": {\n    \"source\": \"yahoo\",\n    \"symbol\": \"CL=F\",\n    \"description\": \"WTI 原油期貨\"\n  },\n  \"metals\": {\n    \"source\": \"yahoo\",\n    \"symbol\": \"XME\",\n    \"description\": \"金屬礦業 ETF\"\n  },\n  \"bcom_proxy\": {\n    \"source\": \"yahoo\",\n    \"symbol\": \"DBC\",\n    \"description\": \"商品指數 ETF\"\n  }\n}\n```\n\n### fundamental_inputs\n| 屬性     | 值                    |\n|----------|-----------------------|\n| 類型     | object                |\n| 必要     | 否                    |\n| 說明     | 基本面資料設定        |\n\n**預設值**：\n```json\n{\n  \"us_export_sales\": true,\n  \"wasde_surprise\": true,\n  \"crop_progress\": false\n}\n```\n\n### event_window_days\n| 屬性     | 值                    |\n|----------|-----------------------|\n| 類型     | integer               |\n| 必要     | 否                    |\n| 預設     | 3                     |\n| 範圍     | 1 - 5                 |\n| 說明     | Wed-Fri 事件視窗天數  |\n\n用於驗證 COT 週二截止後的週中回補。\n\n### output_mode\n| 屬性     | 值                          |\n|----------|-----------------------------|\n| 類型     | string                      |\n| 必要     | 否                          |\n| 可用值   | \"markdown\", \"json\", \"both\"  |\n| 預設     | \"both\"                      |\n| 說明     | 輸出格式                    |\n\n---\n\n## 3. 進階參數\n\n### firepower_method\n| 屬性     | 值                              |\n|----------|--------------------------------|\n| 類型     | string                          |\n| 必要     | 否                              |\n| 可用值   | \"percentile\", \"distance\", \"oi_normalized\" |\n| 預設     | \"percentile\"                    |\n| 說明     | 火力計算方法                    |\n\n- `percentile`: 1 - 分位數\n- `distance`: (P90 - current) / P90\n- `oi_normalized`: 用 OI 標準化後的分位數\n\n### tailwind_lookback_days\n| 屬性     | 值                    |\n|----------|-----------------------|\n| 類型     | integer               |\n| 必要     | 否                    |\n| 預設     | 5                     |\n| 範圍     | 1 - 20                |\n| 說明     | 宏觀順風計算的回看天數|\n\n### confidence_method\n| 屬性     | 值                    |\n|----------|-----------------------|\n| 類型     | string                |\n| 必要     | 否                    |\n| 可用值   | \"simple\", \"weighted\"  |\n| 預設     | \"simple\"              |\n| 說明     | 信心水準計算方法      |\n\n---\n\n## 4. 完整輸入範例\n\n```json\n{\n  \"date_start\": \"2025-01-01\",\n  \"date_end\": \"2026-01-21\",\n  \"cot_report\": \"legacy\",\n  \"trader_group\": \"noncommercial\",\n  \"contracts_map\": {\n    \"CORN\": \"grains\",\n    \"WHEAT-SRW\": \"grains\",\n    \"SOYBEANS\": \"oilseeds\",\n    \"SOYBEAN OIL\": \"oilseeds\",\n    \"LIVE CATTLE\": \"meats\",\n    \"COFFEE C\": \"softs\",\n    \"SUGAR NO. 11\": \"softs\"\n  },\n  \"position_metric\": \"net\",\n  \"lookback_weeks_firepower\": 156,\n  \"macro_indicators\": {\n    \"usd\": {\"source\": \"yahoo\", \"symbol\": \"UUP\"},\n    \"crude\": {\"source\": \"yahoo\", \"symbol\": \"CL=F\"},\n    \"metals\": {\"source\": \"yahoo\", \"symbol\": \"XME\"}\n  },\n  \"fundamental_inputs\": {\n    \"us_export_sales\": true,\n    \"wasde_surprise\": true\n  },\n  \"event_window_days\": 3,\n  \"output_mode\": \"both\"\n}\n```\n",
        "skills/track-agri-hedge-fund-positioning/references/macro-indicators.md": "# 宏觀指標定義與代理序列\n\n## 1. 核心宏觀指標\n\n### 1.1 美元指數（USD）\n\n| 指標       | 來源          | 代碼/符號     | 頻率 | 說明                     |\n|------------|---------------|---------------|------|--------------------------|\n| DXY        | ICE           | DX=F          | 日   | 美元指數期貨             |\n| UUP        | Yahoo Finance | UUP           | 日   | Invesco DB US Dollar ETF |\n| DTWEXBGS   | FRED          | DTWEXBGS      | 日   | Trade Weighted USD Broad |\n| DTWEXAFEGS | FRED          | DTWEXAFEGS    | 日   | Trade Weighted USD AFE   |\n\n**推薦**：Yahoo Finance `UUP`（簡單）或 FRED `DTWEXBGS`（官方）\n\n**訊號解讀**：\n- 美元走弱（負報酬）→ 利於農產品價格\n- 美元走強（正報酬）→ 壓抑農產品價格\n\n### 1.2 原油（Crude Oil）\n\n| 指標       | 來源          | 代碼/符號     | 頻率 | 說明                     |\n|------------|---------------|---------------|------|--------------------------|\n| WTI        | Yahoo Finance | CL=F          | 日   | WTI 原油期貨             |\n| Brent      | Yahoo Finance | BZ=F          | 日   | Brent 原油期貨           |\n| USO        | Yahoo Finance | USO           | 日   | 原油 ETF                 |\n| DCOILWTICO | FRED          | DCOILWTICO    | 日   | WTI 原油現貨             |\n\n**推薦**：Yahoo Finance `CL=F`\n\n**訊號解讀**：\n- 原油走強 → 風險偏好上升，能源成本傳導\n- 原油走弱 → 需求疑慮，可能拖累商品\n\n### 1.3 金屬（Metals）\n\n| 指標       | 來源          | 代碼/符號     | 頻率 | 說明                     |\n|------------|---------------|---------------|------|--------------------------|\n| XME        | Yahoo Finance | XME           | 日   | SPDR S&P Metals & Mining |\n| COPX       | Yahoo Finance | COPX          | 日   | 銅礦 ETF                 |\n| GDX        | Yahoo Finance | GDX           | 日   | 黃金礦業 ETF             |\n| HG=F       | Yahoo Finance | HG=F          | 日   | 銅期貨                   |\n\n**推薦**：Yahoo Finance `XME`（廣義金屬）\n\n**訊號解讀**：\n- 金屬走強 → 循環需求樂觀，工業活動擴張\n- 金屬走弱 → 需求轉弱，通縮疑慮\n\n---\n\n## 2. 輔助宏觀指標\n\n### 2.1 商品綜合指數\n\n| 指標       | 來源          | 代碼/符號     | 頻率 | 說明                     |\n|------------|---------------|---------------|------|--------------------------|\n| DBC        | Yahoo Finance | DBC           | 日   | Invesco DB Commodity ETF |\n| GSG        | Yahoo Finance | GSG           | 日   | iShares S&P GSCI ETF     |\n| DBA        | Yahoo Finance | DBA           | 日   | 農產品 ETF               |\n\n### 2.2 風險偏好指標\n\n| 指標       | 來源          | 代碼/符號     | 頻率 | 說明                     |\n|------------|---------------|---------------|------|--------------------------|\n| VIX        | FRED          | VIXCLS        | 日   | CBOE VIX                 |\n| SPY        | Yahoo Finance | SPY           | 日   | S&P 500 ETF              |\n| HYG        | Yahoo Finance | HYG           | 日   | 高收益債 ETF             |\n\n### 2.3 利率指標\n\n| 指標       | 來源          | 代碼/符號     | 頻率 | 說明                     |\n|------------|---------------|---------------|------|--------------------------|\n| DGS10      | FRED          | DGS10         | 日   | 10Y 國債殖利率           |\n| DGS2       | FRED          | DGS2          | 日   | 2Y 國債殖利率            |\n| T10Y2Y     | FRED          | T10Y2Y        | 日   | 10Y-2Y 利差              |\n\n---\n\n## 3. 宏觀順風評分計算\n\n### 3.1 標準計算\n\n```python\ndef calculate_macro_tailwind(macro_df, lookback_days=5):\n    \"\"\"\n    計算宏觀順風評分\n\n    Parameters:\n    -----------\n    macro_df : pd.DataFrame\n        包含 usd, crude, metals 欄位的日頻資料\n    lookback_days : int\n        回看天數（預設 5 天）\n\n    Returns:\n    --------\n    float\n        宏觀順風評分 (0-1)\n    \"\"\"\n    recent = macro_df.iloc[-lookback_days:]\n\n    # 計算各指標報酬\n    usd_ret = (recent['usd'].iloc[-1] / recent['usd'].iloc[0]) - 1\n    crude_ret = (recent['crude'].iloc[-1] / recent['crude'].iloc[0]) - 1\n    metals_ret = (recent['metals'].iloc[-1] / recent['metals'].iloc[0]) - 1\n\n    # 判斷順風條件\n    flags = [\n        usd_ret < 0,      # 美元走弱\n        crude_ret > 0,    # 原油走強\n        metals_ret > 0    # 金屬走強\n    ]\n\n    return sum(flags) / len(flags)\n```\n\n### 3.2 加權計算（可選）\n\n```python\ndef calculate_macro_tailwind_weighted(macro_df, lookback_days=5,\n                                       weights=None):\n    \"\"\"加權版本的宏觀順風評分\"\"\"\n    if weights is None:\n        weights = {\n            'usd': 0.4,     # 美元權重最高\n            'crude': 0.35,  # 原油次之\n            'metals': 0.25  # 金屬\n        }\n\n    recent = macro_df.iloc[-lookback_days:]\n\n    scores = {}\n    for indicator, weight in weights.items():\n        ret = (recent[indicator].iloc[-1] / recent[indicator].iloc[0]) - 1\n\n        if indicator == 'usd':\n            # 美元反向\n            scores[indicator] = (1 if ret < -0.005 else\n                                0.5 if abs(ret) < 0.005 else\n                                0) * weight\n        else:\n            # 其他正向\n            scores[indicator] = (1 if ret > 0.005 else\n                                0.5 if abs(ret) < 0.005 else\n                                0) * weight\n\n    return sum(scores.values())\n```\n\n---\n\n## 4. 指標獲取範例\n\n### 4.1 使用 Yahoo Finance\n\n```python\nimport yfinance as yf\nimport pandas as pd\n\ndef fetch_macro_indicators(start_date, end_date):\n    \"\"\"抓取宏觀指標\"\"\"\n    symbols = {\n        'usd': 'UUP',\n        'crude': 'CL=F',\n        'metals': 'XME'\n    }\n\n    data = {}\n    for name, symbol in symbols.items():\n        try:\n            df = yf.download(symbol, start=start_date, end=end_date,\n                            progress=False)\n            data[name] = df['Adj Close']\n        except Exception as e:\n            print(f\"Error fetching {symbol}: {e}\")\n            data[name] = pd.Series(dtype=float)\n\n    return pd.DataFrame(data)\n```\n\n### 4.2 使用 FRED\n\n```python\nimport requests\nfrom io import StringIO\n\ndef fetch_fred_series(series_id, start_date, end_date):\n    \"\"\"從 FRED 抓取序列\"\"\"\n    url = \"https://fred.stlouisfed.org/graph/fredgraph.csv\"\n    params = {\n        \"id\": series_id,\n        \"cosd\": start_date,\n        \"coed\": end_date\n    }\n\n    response = requests.get(url, params=params, timeout=30)\n    response.raise_for_status()\n\n    df = pd.read_csv(StringIO(response.text))\n    df.columns = [\"DATE\", series_id]\n    df[\"DATE\"] = pd.to_datetime(df[\"DATE\"])\n    df[series_id] = pd.to_numeric(\n        df[series_id].replace(\".\", pd.NA),\n        errors=\"coerce\"\n    )\n\n    return df.dropna().set_index(\"DATE\")[series_id]\n```\n\n---\n\n## 5. 解讀指南\n\n### 5.1 宏觀順風評分解讀\n\n| 評分區間    | 意義           | 對農產品含義                 |\n|-------------|----------------|------------------------------|\n| 0.67 - 1.00 | 強順風         | 風險偏好高，商品需求樂觀     |\n| 0.33 - 0.66 | 中性           | 方向不明確，謹慎對待         |\n| 0.00 - 0.33 | 逆風           | 風險規避，商品承壓           |\n\n### 5.2 與資金流的交叉解讀\n\n| 資金流   | 宏觀順風 | 解讀                               |\n|----------|----------|-----------------------------------|\n| 流入     | 高       | 敘事一致，順勢做多                |\n| 流入     | 低       | 資金流與宏觀背離，謹慎            |\n| 流出     | 高       | 宏觀利好但資金離場，觀望          |\n| 流出     | 低       | 敘事一致，避險情緒主導            |\n\n---\n\n## 6. 注意事項\n\n1. **資料延遲**：部分 FRED 序列有 1 天延遲\n2. **時區**：Yahoo Finance 使用美東時間\n3. **假日**：需處理非交易日的缺值\n4. **ETF 追蹤誤差**：ETF 價格可能與標的指數有差異\n5. **季節性**：部分指標有明顯季節性（如農產品 ETF）\n",
        "skills/track-agri-hedge-fund-positioning/references/methodology.md": "CFTC Commitments of Traders (COT) 報告是追蹤期貨市場部位的官方資料：\n\n| 報告類型      | 分類                                         | 可用期間 |\n|---------------|----------------------------------------------|----------|\n| Legacy        | Commercial / Non-Commercial / Non-Reportable | 1986-    |\n| Disaggregated | Producer, Swap Dealer, Managed Money, Other  | 2009-    |\n| TFF           | Dealer, Asset Manager, Leveraged, Other      | 2010-    |\n\n**本技能預設使用 Legacy 報告的 Non-Commercial（非商業）部位**，因為：\n- 歷史最長，可用於長期回測\n- 非商業部位主要代表投機資金（對沖基金、CTA）\n- 是市場情緒的經典代理指標\n\n### 1.2 資金流定義\n\n```\n淨部位 = Long - Short\n資金流 = 本週淨部位 - 上週淨部位\n```\n\n單位：合約口數（contracts）\n\n**注意**：不同商品的合約規格不同，跨商品比較時需標準化。\n\n### 1.3 分組彙總邏輯\n\n將個別商品依特性分組：\n\n| 群組     | 商品                                  | 典型合約  |\n|----------|---------------------------------------|-----------|\n| Grains   | Corn, Wheat (CBOT/KC/MGE), Rice, Oats | 5000 bu   |\n| Oilseeds | Soybeans, Soybean Oil, Soybean Meal   | 5000 bu   |\n| Meats    | Live Cattle, Lean Hogs, Feeder Cattle | 40000 lbs |\n| Softs    | Coffee, Sugar #11, Cocoa, Cotton #2   | 各異      |\n\n**Total Flow = Grains + Oilseeds + Meats + Softs**\n\n---\n\n## 2. 火力（Buying Firepower）量化\n\n### 2.1 定義\n\n火力衡量「基金還有多少加碼空間」：\n\n```python\ndef calculate_firepower(net_pos_series, lookback_weeks=156):\n    \"\"\"\n    firepower = 1 - percentile_rank(current_net_pos)\n\n    - 高火力（>0.6）：部位處於歷史低檔，仍有大量買進空間\n    - 低火力（<0.3）：部位已接近歷史高檔，擁擠風險高\n    \"\"\"\n    historical = net_pos_series.iloc[-lookback_weeks:]\n    current = net_pos_series.iloc[-1]\n    percentile = (historical <= current).mean()\n    return 1 - percentile\n```\n\n### 2.2 視窗選擇\n\n| lookback_weeks | 意義               | 適用場景           |\n|----------------|--------------------|--------------------|\n| 52             | 1 年，短期循環     | 戰術性交易         |\n| 104            | 2 年，中期循環     | 波段交易           |\n| 156            | 3 年，完整景氣循環 | 策略性配置（預設） |\n| 260            | 5 年，跨多個循環   | 長期歷史比較       |\n\n### 2.3 替代計算方法\n\n**距離上緣法**：\n```python\np90 = net_pos_series.quantile(0.9)\nfirepower = (p90 - current) / abs(p90)\n```\n\n**風險容量法**（需 Open Interest）：\n```python\nnet_pos_ratio = net_pos / open_interest\n# 用 ratio 取代絕對部位做分位數\n```\n\n---\n\n## 3. 宏觀順風評分\n\n### 3.1 指標選擇\n\n| 指標       | 代理序列         | 訊號解讀            |\n|------------|------------------|---------------------|\n| 美元 (USD) | DXY / DTWEXBGS   | 走弱 = 利於商品     |\n| 原油 (Oil) | WTI / CL=F       | 走強 = 風險偏好上升 |\n| 金屬       | XME / GDX / COPX | 走強 = 循環需求樂觀 |\n\n### 3.2 計算方式\n\n```python\ndef calculate_macro_tailwind(macro_df, lookback_days=5):\n    \"\"\"\n    計算宏觀順風分數\n\n    macro_tailwind_score = (USD弱 + Oil強 + Metals強) / 3\n    \"\"\"\n    recent = macro_df.iloc[-lookback_days:]\n\n    usd_ret = recent['dxy'].pct_change().sum()\n    oil_ret = recent['wti'].pct_change().sum()\n    metals_ret = recent['metals'].pct_change().sum()\n\n    flags = [\n        usd_ret < 0,      # USD 走弱\n        oil_ret > 0,      # Oil 走強\n        metals_ret > 0    # Metals 走強\n    ]\n\n    return sum(flags) / len(flags)\n```\n\n### 3.3 解讀\n\n| macro_tailwind_score | 意義   | 對農產品含義         |\n|----------------------|--------|----------------------|\n| 0.67 - 1.00          | 強順風 | 風險偏好高，利於商品 |\n| 0.33 - 0.66          | 中性   | 方向不明確           |\n| 0.00 - 0.33          | 逆風   | 風險規避，壓抑商品   |\n\n---\n\n## 4. 週中回補驗證框架\n\n### 4.1 問題背景\n\nCOT 資料截止到週二收盤，但新聞敘事常提到「週三到週五基金買回」。這段期間只能用代理證據驗證：\n\n### 4.2 代理證據\n\n| 證據類型 | 資料來源          | 驗證邏輯                    |\n|----------|-------------------|-----------------------------|\n| 價格動能 | 農產品 ETF（DBA） | Wed-Fri 累積報酬 > 0        |\n| 成交量   | 期貨成交量        | 高於 20 日均量 = 有資金參與 |\n| 未平倉量 | Open Interest     | OI 擴張 = 新倉（非純換手）  |\n| 宏觀共振 | DXY, WTI, XME     | 與 USD↓、Oil↑、Metals↑ 同向 |\n\n### 4.3 驗證流程\n\n```\nStep 1: COT 週（到週二）是否淨賣？\n        └─ flow_week < 0 或 net_pos 下滑\n\nStep 2: 週三～週五是否出現回補跡象？\n        ├─ 農產品價格 Wed-Fri 報酬 > 0\n        ├─ 成交量 > 20日均量\n        └─ 宏觀指標共振 >= 2/3\n\nStep 3: 綜合判斷\n        └─ 若 Step 1 + Step 2 皆成立 → 支持「賣出後買回」敘事\n```\n\n---\n\n## 5. 訊號生成規則\n\n### 5.1 Signal 1: Funds Back & Buying\n\n**觸發條件**：\n- `total_flow_week` 由負轉正，或正向加速\n- 主要子群組（穀物/油籽）同步轉正\n- `firepower_total` > 0.5\n\n### 5.2 Signal 2: Macro Tailwind Bullish\n\n**觸發條件**：\n- `macro_tailwind_score` >= 0.67\n- 與資金流入同向\n\n### 5.3 Signal 3: Fundamental Trigger\n\n**觸發條件**：\n- 當週有 USDA 報告發布\n- 報告內容與流量方向一致\n- 例：出口銷售超預期 + 穀物流入\n\n### 5.4 Signal 4: Crowded Risk\n\n**觸發條件**：\n- `firepower_total` < 0.2\n- 部位接近歷史極端\n- 警告：擁擠風險高，可能反轉\n\n---\n\n## 6. 圖表標註規則對照\n\n將圖表上的敘事標註轉為可重複的規則：\n\n| 標註                | 觸發條件                                       |\n|---------------------|------------------------------------------------|\n| Strong Corn Demand  | corn_export_surprise > 0 AND grains_flow > 0   |\n| Bearish USDA Stats  | wasde_surprise < 0 AND grains_flow < 0         |\n| Small Holiday Flows | abs(total_flow) < p25_historical               |\n| Macro Mood Bullish  | macro_tailwind_score >= 0.67                   |\n| Fund Capitulation   | total_flow < p5_historical AND firepower > 0.8 |\n\n---\n\n## 7. 限制與注意事項\n\n1. **COT 延遲**：資料到週二，週三～週五需用代理\n2. **合約規格**：跨商品比較需標準化\n3. **報告修正**：CFTC 可能修正歷史資料\n4. **假日效應**：假日週流量偏低，不宜過度解讀\n5. **結構變化**：Managed Money 興起後，Non-Commercial 含義略有變化\n",
        "skills/track-agri-hedge-fund-positioning/templates/annotations.md": "# 圖表標註規則對照表\n\n## 1. 標註規則定義\n\n將圖表上的敘事標註轉為可重複驗證的規則：\n\n### 1.1 基本面驅動標註\n\n| 標註 ID              | 顯示文字           | 觸發條件                                    |\n|----------------------|--------------------|--------------------------------------------|\n| `strong_corn_demand` | Strong Corn Demand | corn_export_surprise > 0 AND grains_flow > 0 |\n| `strong_soy_demand`  | Strong Soy Demand  | soy_export_surprise > 0 AND oilseeds_flow > 0 |\n| `bearish_usda_stats` | Bearish USDA Stats | wasde_surprise < 0 AND grains_flow < 0      |\n| `bullish_usda_stats` | Bullish USDA Stats | wasde_surprise > 0 AND grains_flow > 0      |\n| `weather_premium`    | Weather Premium    | weather_concern = true AND flow > 0         |\n\n### 1.2 宏觀驅動標註\n\n| 標註 ID              | 顯示文字           | 觸發條件                                    |\n|----------------------|--------------------|--------------------------------------------|\n| `macro_mood_bullish` | Macro Mood Bullish | macro_tailwind_score >= 0.67                |\n| `macro_headwind`     | Macro Headwind     | macro_tailwind_score <= 0.33                |\n| `usd_tailwind`       | USD Tailwind       | usd_weekly_return < -0.5%                   |\n| `risk_on_mode`       | Risk-On Mode       | spy_return > 1% AND vix_down                |\n\n### 1.3 流量特徵標註\n\n| 標註 ID              | 顯示文字           | 觸發條件                                    |\n|----------------------|--------------------|--------------------------------------------|\n| `funds_back_buying`  | Funds Back & Buying| flow_reversal = positive AND firepower > 0.5 |\n| `fund_capitulation`  | Fund Capitulation  | flow < p5_historical AND firepower > 0.8   |\n| `crowded_long`       | Crowded Long       | firepower < 0.2                             |\n| `extreme_short`      | Extreme Short      | firepower > 0.85                            |\n| `small_holiday_flows`| Small Holiday Flows| abs(total_flow) < p25_historical            |\n\n### 1.4 群組動態標註\n\n| 標註 ID               | 顯示文字            | 觸發條件                                    |\n|-----------------------|---------------------|--------------------------------------------|\n| `grains_momentum_up`  | Grains Momentum Up  | grains_flow > 0 for 2+ weeks               |\n| `oilseeds_outflow`    | Oilseeds Outflow    | oilseeds_flow < 0 for 2+ weeks             |\n| `meats_rotation`      | Meats Rotation      | meats_flow direction changed               |\n| `broad_based_buying`  | Broad-Based Buying  | 3+ groups with positive flow               |\n| `sector_divergence`   | Sector Divergence   | grains and oilseeds flow opposite signs    |\n\n---\n\n## 2. 規則實作\n\n```python\nANNOTATION_RULES = {\n    # 基本面驅動\n    \"strong_corn_demand\": {\n        \"label\": \"Strong Corn Demand\",\n        \"condition\": lambda ctx: (\n            ctx.get(\"corn_export_surprise\", 0) > 0 and\n            ctx.get(\"grains_flow\", 0) > 0\n        ),\n        \"evidence_fn\": lambda ctx: [\n            f\"Corn export surprise: +{ctx.get('corn_export_surprise', 0):.1%}\",\n            f\"Grains flow: {ctx.get('grains_flow', 0):+,} contracts\"\n        ],\n        \"priority\": 2\n    },\n\n    \"bearish_usda_stats\": {\n        \"label\": \"Bearish USDA Stats\",\n        \"condition\": lambda ctx: (\n            ctx.get(\"wasde_surprise\", 0) < 0 and\n            ctx.get(\"grains_flow\", 0) < 0\n        ),\n        \"evidence_fn\": lambda ctx: [\n            f\"WASDE surprise: {ctx.get('wasde_surprise', 0):+.1%}\",\n            f\"Grains outflow: {ctx.get('grains_flow', 0):,} contracts\"\n        ],\n        \"priority\": 2\n    },\n\n    # 宏觀驅動\n    \"macro_mood_bullish\": {\n        \"label\": \"Macro Mood Bullish\",\n        \"condition\": lambda ctx: ctx.get(\"macro_tailwind_score\", 0) >= 0.67,\n        \"evidence_fn\": lambda ctx: [\n            f\"Macro tailwind: {ctx.get('macro_tailwind_score', 0):.0%}\",\n            *[k for k, v in ctx.get(\"macro_components\", {}).items() if v]\n        ],\n        \"priority\": 1\n    },\n\n    \"macro_headwind\": {\n        \"label\": \"Macro Headwind\",\n        \"condition\": lambda ctx: ctx.get(\"macro_tailwind_score\", 0) <= 0.33,\n        \"evidence_fn\": lambda ctx: [\n            f\"Macro tailwind: {ctx.get('macro_tailwind_score', 0):.0%}\",\n            \"USD strong\" if not ctx.get(\"macro_components\", {}).get(\"usd_down\") else None,\n            \"Oil weak\" if not ctx.get(\"macro_components\", {}).get(\"crude_up\") else None\n        ],\n        \"priority\": 1\n    },\n\n    # 流量特徵\n    \"funds_back_buying\": {\n        \"label\": \"Funds Back & Buying\",\n        \"condition\": lambda ctx: (\n            ctx.get(\"flow_reversal\") == \"positive\" and\n            ctx.get(\"firepower_total\", 0) > 0.5\n        ),\n        \"evidence_fn\": lambda ctx: [\n            \"Flow reversed to positive\",\n            f\"Firepower: {ctx.get('firepower_total', 0):.0%}\"\n        ],\n        \"priority\": 1\n    },\n\n    \"crowded_long\": {\n        \"label\": \"Crowded Long\",\n        \"condition\": lambda ctx: ctx.get(\"firepower_total\", 1) < 0.2,\n        \"evidence_fn\": lambda ctx: [\n            f\"Firepower critically low: {ctx.get('firepower_total', 0):.0%}\",\n            \"Position near historical high\"\n        ],\n        \"priority\": 1\n    },\n\n    \"small_holiday_flows\": {\n        \"label\": \"Small Holiday Flows\",\n        \"condition\": lambda ctx: (\n            abs(ctx.get(\"total_flow\", 0)) < ctx.get(\"flow_p25\", float(\"inf\"))\n        ),\n        \"evidence_fn\": lambda ctx: [\n            f\"Flow: {ctx.get('total_flow', 0):,} (below 25th percentile)\",\n            \"Likely holiday/thin liquidity\"\n        ],\n        \"priority\": 3\n    },\n\n    # 群組動態\n    \"broad_based_buying\": {\n        \"label\": \"Broad-Based Buying\",\n        \"condition\": lambda ctx: (\n            sum(1 for g in [\"grains\", \"oilseeds\", \"meats\", \"softs\"]\n                if ctx.get(f\"{g}_flow\", 0) > 0) >= 3\n        ),\n        \"evidence_fn\": lambda ctx: [\n            f\"{g.capitalize()}: +{ctx.get(f'{g}_flow', 0):,}\"\n            for g in [\"grains\", \"oilseeds\", \"meats\", \"softs\"]\n            if ctx.get(f\"{g}_flow\", 0) > 0\n        ],\n        \"priority\": 2\n    }\n}\n```\n\n---\n\n## 3. 標註生成函數\n\n```python\ndef generate_annotations(context: dict) -> list:\n    \"\"\"\n    根據上下文生成所有觸發的標註\n\n    Parameters:\n    -----------\n    context : dict\n        包含所有指標的上下文字典\n\n    Returns:\n    --------\n    list\n        觸發的標註清單\n    \"\"\"\n    annotations = []\n\n    for rule_id, rule in ANNOTATION_RULES.items():\n        try:\n            if rule[\"condition\"](context):\n                evidence = rule[\"evidence_fn\"](context)\n                # 過濾 None 值\n                evidence = [e for e in evidence if e is not None]\n\n                annotations.append({\n                    \"label\": rule_id,\n                    \"display\": rule[\"label\"],\n                    \"rule_hit\": True,\n                    \"evidence\": evidence,\n                    \"priority\": rule.get(\"priority\", 2),\n                    \"date\": context.get(\"date\")\n                })\n        except Exception as e:\n            # 規則執行失敗時跳過\n            continue\n\n    # 按優先級排序（1 最高）\n    annotations.sort(key=lambda x: x[\"priority\"])\n\n    return annotations\n```\n\n---\n\n## 4. 標註優先級\n\n| 優先級 | 說明                 | 範例                           |\n|--------|----------------------|--------------------------------|\n| 1      | 核心訊號             | Funds Back & Buying, Crowded   |\n| 2      | 重要驅動             | Strong Demand, USDA Stats      |\n| 3      | 輔助資訊             | Small Holiday Flows            |\n\n---\n\n## 5. 標註顯示樣式\n\n### 5.1 圖表標註\n\n```python\nANNOTATION_STYLES = {\n    \"funds_back_buying\": {\"color\": \"green\", \"marker\": \"^\", \"size\": 12},\n    \"fund_capitulation\": {\"color\": \"darkgreen\", \"marker\": \"^\", \"size\": 14},\n    \"crowded_long\": {\"color\": \"red\", \"marker\": \"v\", \"size\": 12},\n    \"extreme_short\": {\"color\": \"darkred\", \"marker\": \"v\", \"size\": 14},\n    \"macro_mood_bullish\": {\"color\": \"blue\", \"marker\": \"o\", \"size\": 10},\n    \"macro_headwind\": {\"color\": \"orange\", \"marker\": \"o\", \"size\": 10},\n    \"strong_corn_demand\": {\"color\": \"gold\", \"marker\": \"s\", \"size\": 8},\n    \"bearish_usda_stats\": {\"color\": \"brown\", \"marker\": \"s\", \"size\": 8},\n    \"small_holiday_flows\": {\"color\": \"gray\", \"marker\": \".\", \"size\": 6}\n}\n```\n\n### 5.2 Markdown 標註\n\n```python\ndef format_annotation_markdown(ann: dict) -> str:\n    \"\"\"格式化標註為 Markdown\"\"\"\n    emoji_map = {\n        \"funds_back_buying\": \"🟢\",\n        \"crowded_long\": \"🔴\",\n        \"macro_mood_bullish\": \"🔵\",\n        \"strong_corn_demand\": \"🌽\",\n        \"bearish_usda_stats\": \"📉\",\n        \"small_holiday_flows\": \"🏖️\"\n    }\n\n    emoji = emoji_map.get(ann[\"label\"], \"📌\")\n    evidence_str = \", \".join(ann[\"evidence\"])\n\n    return f\"{emoji} **{ann['display']}**: {evidence_str}\"\n```\n\n---\n\n## 6. 使用範例\n\n```python\n# 建立上下文\ncontext = {\n    \"date\": \"2026-01-21\",\n    \"total_flow\": 65000,\n    \"grains_flow\": 35000,\n    \"oilseeds_flow\": 25000,\n    \"meats_flow\": 5000,\n    \"softs_flow\": 0,\n    \"firepower_total\": 0.63,\n    \"macro_tailwind_score\": 0.67,\n    \"macro_components\": {\n        \"usd_down\": True,\n        \"crude_up\": True,\n        \"metals_up\": False\n    },\n    \"corn_export_surprise\": 0.05,\n    \"flow_reversal\": \"positive\",\n    \"flow_p25\": 20000\n}\n\n# 生成標註\nannotations = generate_annotations(context)\n\n# 輸出\nfor ann in annotations:\n    print(f\"[{ann['priority']}] {ann['display']}: {ann['evidence']}\")\n```\n\n輸出：\n```\n[1] Funds Back & Buying: ['Flow reversed to positive', 'Firepower: 63%']\n[1] Macro Mood Bullish: ['Macro tailwind: 67%', 'usd_down', 'crude_up']\n[2] Strong Corn Demand: ['Corn export surprise: +5.0%', 'Grains flow: +35,000 contracts']\n[2] Broad-Based Buying: ['Grains: +35,000', 'Oilseeds: +25,000', 'Meats: +5,000']\n```\n",
        "skills/track-agri-hedge-fund-positioning/templates/output-json.md": "# JSON 輸出結構定義\n\n## 完整輸出結構\n\n```json\n{\n  \"skill\": \"track-agri-hedge-fund-positioning\",\n  \"version\": \"0.1.0\",\n  \"generated_at\": \"2026-01-27T10:30:00Z\",\n  \"as_of\": \"2026-01-21\",\n\n  \"summary\": {\n    \"call\": \"Funds back & buying\",\n    \"confidence\": 0.72,\n    \"why\": [\n      \"COT 週部位變化顯示農產品總流量由負轉正\",\n      \"分組（穀物/油籽）同步改善，非單一品種噪音\",\n      \"宏觀順風：美元走弱、原油與金屬偏強\"\n    ],\n    \"risks\": [\n      \"COT 只到週二：Wed–Fri 的『買回』屬推估\",\n      \"USDA 報告或天氣變動可能讓訊號反轉\"\n    ],\n    \"next_steps\": [\n      \"監控週五 USDA Export Sales 報告\",\n      \"觀察火力是否持續回升\"\n    ]\n  },\n\n  \"latest_metrics\": {\n    \"cot_week_end\": \"2026-01-21\",\n    \"flow_total_contracts\": 58,\n    \"flow_by_group_contracts\": {\n      \"grains\": 35,\n      \"oilseeds\": 25,\n      \"meats\": 5,\n      \"softs\": 0\n    },\n    \"net_position_by_group\": {\n      \"grains\": 125000,\n      \"oilseeds\": 85000,\n      \"meats\": 12000,\n      \"softs\": -5000,\n      \"total\": 217000\n    },\n    \"buying_firepower\": {\n      \"total\": 0.63,\n      \"grains\": 0.58,\n      \"oilseeds\": 0.67,\n      \"meats\": 0.41,\n      \"softs\": 0.75\n    },\n    \"macro_tailwind_score\": 0.67,\n    \"macro_components\": {\n      \"usd_down\": true,\n      \"crude_up\": true,\n      \"metals_up\": false\n    }\n  },\n\n  \"weekly_flows\": [\n    {\n      \"date\": \"2026-01-21\",\n      \"grains\": 35,\n      \"oilseeds\": 25,\n      \"meats\": 5,\n      \"softs\": 0,\n      \"total\": 65\n    },\n    {\n      \"date\": \"2026-01-14\",\n      \"grains\": -10,\n      \"oilseeds\": 15,\n      \"meats\": -5,\n      \"softs\": 2,\n      \"total\": 2\n    }\n  ],\n\n  \"firepower_history\": [\n    {\n      \"date\": \"2026-01-21\",\n      \"total\": 0.63,\n      \"grains\": 0.58,\n      \"oilseeds\": 0.67,\n      \"meats\": 0.41,\n      \"softs\": 0.75\n    }\n  ],\n\n  \"annotations\": [\n    {\n      \"label\": \"macro_mood_bullish\",\n      \"rule_hit\": true,\n      \"evidence\": [\"USD down\", \"crude up\"],\n      \"date\": \"2026-01-21\"\n    },\n    {\n      \"label\": \"grains_momentum_up\",\n      \"rule_hit\": true,\n      \"evidence\": [\"Grains flow turned positive\", \"Corn export sales up\"],\n      \"date\": \"2026-01-21\"\n    }\n  ],\n\n  \"validation\": {\n    \"wed_fri_buyback\": {\n      \"price_momentum\": \"bullish\",\n      \"volume_elevated\": true,\n      \"macro_resonance\": 0.67\n    },\n    \"macro_alignment\": {\n      \"aligned\": true,\n      \"interpretation\": \"資金流入且宏觀順風，敘事一致\"\n    },\n    \"overall_consistency\": 0.78,\n    \"confidence_adjustment\": 0.1\n  },\n\n  \"metadata\": {\n    \"cot_report_type\": \"legacy\",\n    \"trader_group\": \"noncommercial\",\n    \"position_metric\": \"net\",\n    \"lookback_weeks\": 156,\n    \"data_sources\": {\n      \"cot\": \"CFTC\",\n      \"macro\": \"Yahoo Finance\",\n      \"fundamentals\": \"USDA\"\n    }\n  }\n}\n```\n\n---\n\n## 欄位說明\n\n### 頂層欄位\n\n| 欄位         | 類型   | 說明                         |\n|--------------|--------|------------------------------|\n| skill        | string | 技能名稱                     |\n| version      | string | 技能版本                     |\n| generated_at | string | 報告生成時間（ISO 8601）     |\n| as_of        | string | 資料截止日期                 |\n\n### summary 區塊\n\n| 欄位       | 類型     | 說明                           |\n|------------|----------|--------------------------------|\n| call       | string   | 可交易呼叫（主要結論）         |\n| confidence | number   | 信心水準（0-1）                |\n| why        | string[] | 結論依據清單                   |\n| risks      | string[] | 風險提示清單                   |\n| next_steps | string[] | 下一步建議                     |\n\n### latest_metrics 區塊\n\n| 欄位                    | 類型   | 說明                         |\n|-------------------------|--------|------------------------------|\n| cot_week_end            | string | COT 週截止日期               |\n| flow_total_contracts    | number | 總流量（合約數）             |\n| flow_by_group_contracts | object | 各群組流量                   |\n| net_position_by_group   | object | 各群組淨部位                 |\n| buying_firepower        | object | 各群組火力分數               |\n| macro_tailwind_score    | number | 宏觀順風評分（0-1）          |\n| macro_components        | object | 宏觀成分詳情                 |\n\n### annotations 區塊\n\n| 欄位     | 類型     | 說明                         |\n|----------|----------|------------------------------|\n| label    | string   | 標註名稱                     |\n| rule_hit | boolean  | 規則是否觸發                 |\n| evidence | string[] | 觸發證據                     |\n| date     | string   | 觸發日期                     |\n\n### validation 區塊\n\n| 欄位                  | 類型   | 說明                         |\n|-----------------------|--------|------------------------------|\n| wed_fri_buyback       | object | 週中回補驗證                 |\n| macro_alignment       | object | 宏觀一致性                   |\n| overall_consistency   | number | 整體一致性評分               |\n| confidence_adjustment | number | 信心調整值                   |\n\n---\n\n## 可能的 call 值\n\n| call                        | 意義                           |\n|-----------------------------|--------------------------------|\n| Funds back & buying         | 基金回來買進                   |\n| Funds selling               | 基金賣出                       |\n| Macro mood bullish          | 宏觀情緒偏多                   |\n| Macro headwind              | 宏觀逆風                       |\n| Crowded long - caution      | 多單擁擠，謹慎                 |\n| Extreme short - watch       | 極端空頭，留意反彈             |\n| Mixed signals               | 訊號混合                       |\n| Holiday thin flows          | 假日薄流量                     |\n\n---\n\n## 快速輸出模式\n\n使用 `--quick` 時的簡化輸出：\n\n```json\n{\n  \"cot_week_end\": \"2026-01-21\",\n  \"flow_total_contracts\": 58,\n  \"flow_by_group\": {\"grains\": 35, \"oilseeds\": 25, \"meats\": 5, \"softs\": 0},\n  \"buying_firepower\": {\"total\": 0.63},\n  \"macro_tailwind_score\": 0.67,\n  \"call\": \"Funds back & buying\"\n}\n```\n",
        "skills/track-agri-hedge-fund-positioning/templates/output-markdown.md": "# Markdown 報告模板\n\n## 模板結構\n\n```markdown\n# 農產品對沖基金部位追蹤報告\n\n> **報告日期**: {generated_at}\n> **資料截止**: {as_of}（COT 週截止日）\n\n---\n\n## TL;DR\n\n**{call}** (信心: {confidence:.0%})\n\n{why[0]}\n\n---\n\n## 最新指標\n\n### 週流量（合約數）\n\n| 群組     | 流量     | 淨部位       | 火力   |\n|----------|----------|--------------|--------|\n| 穀物     | {grains_flow:+,} | {grains_pos:,} | {grains_fp:.0%} |\n| 油籽     | {oilseeds_flow:+,} | {oilseeds_pos:,} | {oilseeds_fp:.0%} |\n| 肉類     | {meats_flow:+,} | {meats_pos:,} | {meats_fp:.0%} |\n| 軟性商品 | {softs_flow:+,} | {softs_pos:,} | {softs_fp:.0%} |\n| **總計** | **{total_flow:+,}** | **{total_pos:,}** | **{total_fp:.0%}** |\n\n### 宏觀順風\n\n**評分: {macro_score:.0%}**\n\n| 指標 | 方向 | 訊號 |\n|------|------|------|\n| 美元 | {usd_direction} | {usd_signal} |\n| 原油 | {crude_direction} | {crude_signal} |\n| 金屬 | {metals_direction} | {metals_signal} |\n\n---\n\n## 結論依據\n\n{for why in why_list}\n- {why}\n{endfor}\n\n---\n\n## 風險提示\n\n{for risk in risks}\n- ⚠️ {risk}\n{endfor}\n\n---\n\n## 下一步建議\n\n{for step in next_steps}\n1. {step}\n{endfor}\n\n---\n\n## 圖表標註\n\n{for ann in annotations}\n### {ann.label}\n- **觸發**: {ann.rule_hit}\n- **證據**: {ann.evidence}\n{endfor}\n\n---\n\n## 驗證結果\n\n### 週中回補驗證（Wed-Fri）\n\n| 項目       | 結果              |\n|------------|-------------------|\n| 價格動能   | {wed_fri_momentum} |\n| 成交量     | {wed_fri_volume}   |\n| 宏觀共振   | {wed_fri_resonance:.0%} |\n\n### 敘事一致性\n\n**整體一致性: {overall_consistency:.0%}**\n\n{narrative_assessment}\n\n---\n\n## 技術細節\n\n- COT 報表類型: {cot_report_type}\n- 交易者分類: {trader_group}\n- 部位衡量: {position_metric}\n- 火力視窗: {lookback_weeks} 週\n- 資料來源: CFTC / Yahoo Finance / USDA\n\n---\n\n*本報告由 track-agri-hedge-fund-positioning v{version} 生成*\n```\n\n---\n\n## 填充範例\n\n```markdown\n# 農產品對沖基金部位追蹤報告\n\n> **報告日期**: 2026-01-27 10:30 UTC\n> **資料截止**: 2026-01-21（COT 週截止日）\n\n---\n\n## TL;DR\n\n**Funds back & buying** (信心: 72%)\n\nCOT 週部位變化顯示農產品總流量由負轉正，分組同步改善，宏觀順風。\n\n---\n\n## 最新指標\n\n### 週流量（合約數）\n\n| 群組     | 流量     | 淨部位       | 火力   |\n|----------|----------|--------------|--------|\n| 穀物     | +35,000  | 125,000      | 58%    |\n| 油籽     | +25,000  | 85,000       | 67%    |\n| 肉類     | +5,000   | 12,000       | 41%    |\n| 軟性商品 | +0       | -5,000       | 75%    |\n| **總計** | **+65,000** | **217,000** | **63%** |\n\n### 宏觀順風\n\n**評分: 67%**\n\n| 指標 | 方向 | 訊號     |\n|------|------|----------|\n| 美元 | ↓    | 利多商品 |\n| 原油 | ↑    | 風險偏好 |\n| 金屬 | →    | 中性     |\n\n---\n\n## 結論依據\n\n- COT 週部位變化顯示農產品總流量由負轉正\n- 分組（穀物/油籽）同步改善，非單一品種噪音\n- 宏觀順風：美元走弱、原油與金屬偏強\n\n---\n\n## 風險提示\n\n- ⚠️ COT 只到週二：Wed–Fri 的『買回』屬推估，需要價格/未平倉等代理證據佐證\n- ⚠️ USDA 報告或天氣/南美供給變動可能讓訊號反轉\n\n---\n\n## 下一步建議\n\n1. 監控週五 USDA Export Sales 報告\n2. 觀察火力是否持續回升\n3. 若火力突破 70%，考慮減碼\n\n---\n\n## 圖表標註\n\n### macro_mood_bullish\n- **觸發**: ✓\n- **證據**: USD down, crude up\n\n### grains_momentum_up\n- **觸發**: ✓\n- **證據**: Grains flow turned positive, Corn export sales up\n\n---\n\n## 驗證結果\n\n### 週中回補驗證（Wed-Fri）\n\n| 項目       | 結果              |\n|------------|-------------------|\n| 價格動能   | 偏多              |\n| 成交量     | 正常              |\n| 宏觀共振   | 67%               |\n\n### 敘事一致性\n\n**整體一致性: 78%**\n\n敘事高度一致，可信度高\n\n---\n\n## 技術細節\n\n- COT 報表類型: legacy\n- 交易者分類: noncommercial\n- 部位衡量: net\n- 火力視窗: 156 週\n- 資料來源: CFTC / Yahoo Finance / USDA\n\n---\n\n*本報告由 track-agri-hedge-fund-positioning v0.1.0 生成*\n```\n\n---\n\n## Python 生成函數\n\n```python\ndef generate_markdown_report(result: dict) -> str:\n    \"\"\"生成 Markdown 報告\"\"\"\n    template = \"\"\"\n# 農產品對沖基金部位追蹤報告\n\n> **報告日期**: {generated_at}\n> **資料截止**: {as_of}（COT 週截止日）\n\n---\n\n## TL;DR\n\n**{call}** (信心: {confidence:.0%})\n\n{primary_reason}\n\n---\n\n## 最新指標\n\n### 週流量（合約數）\n\n| 群組     | 流量     | 淨部位       | 火力   |\n|----------|----------|--------------|--------|\n| 穀物     | {grains_flow:+,} | {grains_pos:,} | {grains_fp:.0%} |\n| 油籽     | {oilseeds_flow:+,} | {oilseeds_pos:,} | {oilseeds_fp:.0%} |\n| 肉類     | {meats_flow:+,} | {meats_pos:,} | {meats_fp:.0%} |\n| 軟性商品 | {softs_flow:+,} | {softs_pos:,} | {softs_fp:.0%} |\n| **總計** | **{total_flow:+,}** | **{total_pos:,}** | **{total_fp:.0%}** |\n\n### 宏觀順風評分: {macro_score:.0%}\n\n---\n\n## 結論依據\n\n{reasons}\n\n---\n\n## 風險提示\n\n{risks}\n\n---\n\n*本報告由 track-agri-hedge-fund-positioning v{version} 生成*\n\"\"\"\n\n    # 填充模板\n    metrics = result['latest_metrics']\n    summary = result['summary']\n\n    return template.format(\n        generated_at=result['generated_at'],\n        as_of=result['as_of'],\n        call=summary['call'],\n        confidence=summary['confidence'],\n        primary_reason=summary['why'][0],\n        grains_flow=metrics['flow_by_group_contracts']['grains'],\n        grains_pos=metrics['net_position_by_group']['grains'],\n        grains_fp=metrics['buying_firepower']['grains'],\n        oilseeds_flow=metrics['flow_by_group_contracts']['oilseeds'],\n        oilseeds_pos=metrics['net_position_by_group']['oilseeds'],\n        oilseeds_fp=metrics['buying_firepower']['oilseeds'],\n        meats_flow=metrics['flow_by_group_contracts']['meats'],\n        meats_pos=metrics['net_position_by_group']['meats'],\n        meats_fp=metrics['buying_firepower']['meats'],\n        softs_flow=metrics['flow_by_group_contracts']['softs'],\n        softs_pos=metrics['net_position_by_group']['softs'],\n        softs_fp=metrics['buying_firepower']['softs'],\n        total_flow=metrics['flow_total_contracts'],\n        total_pos=metrics['net_position_by_group']['total'],\n        total_fp=metrics['buying_firepower']['total'],\n        macro_score=metrics['macro_tailwind_score'],\n        reasons='\\n'.join(f'- {r}' for r in summary['why']),\n        risks='\\n'.join(f'- ⚠️ {r}' for r in summary['risks']),\n        version=result['version']\n    )\n```\n",
        "skills/track-agri-hedge-fund-positioning/workflows/analyze.md": "# Workflow: 完整資金流向分析\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/methodology.md\n2. references/data-sources.md\n3. references/input-schema.md\n4. references/contracts-map.md\n</required_reading>\n\n<process>\n\n## Step 1: 參數確認與驗證\n\n確認使用者提供的參數，或使用預設值：\n\n```python\nparams = {\n    \"date_start\": user_input.get(\"date_start\", \"2025-01-01\"),\n    \"date_end\": user_input.get(\"date_end\", \"today\"),\n    \"cot_report\": user_input.get(\"cot_report\", \"legacy\"),\n    \"trader_group\": user_input.get(\"trader_group\", \"noncommercial\"),\n    \"position_metric\": user_input.get(\"position_metric\", \"net\"),\n    \"lookback_weeks_firepower\": user_input.get(\"lookback_weeks_firepower\", 156),\n    \"output_mode\": user_input.get(\"output_mode\", \"both\")\n}\n```\n\n驗證：\n- [ ] 日期格式正確 (YYYY-MM-DD)\n- [ ] cot_report 為 legacy / disaggregated / tff 之一\n- [ ] trader_group 對應 cot_report 類型\n\n## Step 2: 抓取 COT 資料\n\n執行 `scripts/fetch_cot_data.py`：\n\n```bash\npython scripts/fetch_cot_data.py \\\n  --report {cot_report} \\\n  --start {date_start} \\\n  --end {date_end} \\\n  --output cache/cot_data.parquet\n```\n\n預期輸出：\n- 每週每商品的 long / short / spreading / open_interest\n- 欄位：date, contract, long, short, spreading, open_interest\n\n## Step 3: 抓取宏觀指標\n\n執行 `scripts/fetch_macro_data.py`：\n\n```bash\npython scripts/fetch_macro_data.py \\\n  --indicators dxy,wti,metals \\\n  --start {date_start} \\\n  --end {date_end} \\\n  --output cache/macro_data.parquet\n```\n\n預期輸出：\n- 日頻資料：date, dxy, wti, metals (或代理 ETF)\n- 計算 weekly return 用於 macro_tailwind_score\n\n## Step 4: 計算基金流量與分組彙總\n\n執行主分析腳本 `scripts/analyze_positioning.py`：\n\n```python\n# 核心邏輯摘要\ndf = load_cot_data()\ndf[\"group\"] = df[\"contract\"].map(contracts_map)\n\n# 計算淨部位與流量\nif position_metric == \"net\":\n    df[\"pos\"] = df[\"long\"] - df[\"short\"]\ndf[\"flow\"] = df.groupby(\"contract\")[\"pos\"].diff()\n\n# 分組彙總\nflows = df.groupby([\"date\", \"group\"])[\"flow\"].sum().unstack()\nflows[\"total\"] = flows[[\"grains\", \"oilseeds\", \"meats\", \"softs\"]].sum(axis=1)\n```\n\n## Step 5: 計算火力分數\n\n```python\ndef calculate_firepower(net_pos_series, lookback_weeks=156):\n    \"\"\"計算 buying firepower\"\"\"\n    hist = net_pos_series.iloc[-lookback_weeks:]\n    current = net_pos_series.iloc[-1]\n    percentile = (hist <= current).mean()\n    return 1 - percentile  # 越低的部位 = 越高的火力\n\nfirepower = {}\nfor group in [\"total\", \"grains\", \"oilseeds\", \"meats\", \"softs\"]:\n    net_pos = df.groupby([\"date\", \"group\"])[\"pos\"].sum().unstack()[group]\n    firepower[group] = calculate_firepower(net_pos)\n```\n\n## Step 6: 計算宏觀順風評分\n\n```python\nmacro_df = load_macro_data()\nlatest = macro_df.iloc[-1]\n\ntailwind_flags = [\n    latest[\"dxy_ret\"] < 0,    # USD 走弱\n    latest[\"wti_ret\"] > 0,    # 原油走強\n    latest[\"metals_ret\"] > 0  # 金屬走強\n]\n\nmacro_tailwind_score = sum(tailwind_flags) / len(tailwind_flags)\n```\n\n## Step 7: 產生訊號與呼叫\n\n```python\ndef generate_call(flow_total, firepower_total, macro_score):\n    \"\"\"產生可交易呼叫\"\"\"\n    signals = []\n\n    # Signal 1: Funds back & buying\n    if flow_total > 0 and firepower_total > 0.5:\n        signals.append(\"Funds back & buying\")\n\n    # Signal 2: Macro tailwind\n    if macro_score >= 0.67:\n        signals.append(\"Macro mood bullish\")\n\n    # Signal 3: Crowded risk\n    if firepower_total < 0.2:\n        signals.append(\"Crowded positioning - caution\")\n\n    return signals\n```\n\n## Step 8: 生成標註規則\n\n依據 `templates/annotations.md` 的規則對照表：\n\n```python\nannotations = []\n\n# Strong Corn Demand\nif corn_export_surprise > 0 and grains_flow > 0:\n    annotations.append({\n        \"label\": \"strong_corn_demand\",\n        \"rule_hit\": True,\n        \"evidence\": [\"Export sales up\", \"Grains flow positive\"]\n    })\n\n# Bearish USDA Stats\nif usda_surprise < 0 and grains_flow < 0:\n    annotations.append({\n        \"label\": \"bearish_usda_stats\",\n        \"rule_hit\": True,\n        \"evidence\": [\"WASDE bearish\", \"Grains outflow\"]\n    })\n```\n\n## Step 9: 組裝輸出\n\n依據 `templates/output-json.md` 格式輸出：\n\n```python\nresult = {\n    \"skill\": \"track-agri-hedge-fund-positioning\",\n    \"as_of\": date_end,\n    \"summary\": {\n        \"call\": primary_call,\n        \"confidence\": confidence_score,\n        \"why\": reasons_list,\n        \"risks\": risks_list\n    },\n    \"latest_metrics\": {\n        \"cot_week_end\": cot_week_end,\n        \"flow_total_contracts\": flow_total,\n        \"flow_by_group_contracts\": flow_by_group,\n        \"buying_firepower\": firepower,\n        \"macro_tailwind_score\": macro_score\n    },\n    \"weekly_flows\": weekly_flows_list,\n    \"annotations\": annotations\n}\n```\n\n## Step 10: 輸出報告\n\n依據 output_mode 輸出：\n- `json`：儲存至 `output/result.json`\n- `markdown`：依據 `templates/output-markdown.md` 格式輸出\n- `both`：兩者皆輸出\n\n</process>\n\n<success_criteria>\n此工作流程完成時應確認：\n\n- [ ] COT 資料成功抓取並解析\n- [ ] 分組彙總計算正確（Grains/Oilseeds/Meats/Softs/Total）\n- [ ] 火力分數落在 0-1 範圍\n- [ ] 宏觀順風評分計算完成\n- [ ] 產生至少一個可交易呼叫\n- [ ] 輸出格式符合 template 定義\n- [ ] 風險提示已包含\n</success_criteria>\n",
        "skills/track-agri-hedge-fund-positioning/workflows/cross-check.md": "# Workflow: 宏觀與基本面交叉驗證\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/methodology.md\n2. references/macro-indicators.md\n</required_reading>\n\n<process>\n\n## Step 1: 確認驗證目標\n\n交叉驗證的核心問題：\n- COT 週資料只到週二，週三～週五的「買回」是否有代理證據？\n- 資金流向是否與宏觀風向一致？\n- 基本面事件是否支持當週的流量變化？\n\n```python\nvalidation_targets = {\n    \"wed_fri_buyback\": \"週三～週五是否出現回補跡象\",\n    \"macro_alignment\": \"資金流向與宏觀指標是否同向\",\n    \"fundamental_trigger\": \"是否有對應的基本面事件\"\n}\n```\n\n## Step 2: 週中回補驗證（Wed-Fri）\n\n```python\ndef validate_wed_fri_buyback(cot_week_end, price_df, macro_df):\n    \"\"\"驗證週三～週五的回補跡象\"\"\"\n\n    # 取得 Wed-Fri 的資料\n    wed = cot_week_end + timedelta(days=1)  # COT 截止週二\n    fri = cot_week_end + timedelta(days=3)\n\n    wed_fri_data = price_df.loc[wed:fri]\n\n    evidence = {\n        \"price_momentum\": None,\n        \"volume_change\": None,\n        \"macro_resonance\": None\n    }\n\n    # 1. 價格動能\n    if len(wed_fri_data) > 0:\n        wed_fri_return = (wed_fri_data['close'].iloc[-1] /\n                          wed_fri_data['close'].iloc[0] - 1)\n        evidence[\"price_momentum\"] = {\n            \"value\": wed_fri_return,\n            \"signal\": \"bullish\" if wed_fri_return > 0.005 else\n                      \"bearish\" if wed_fri_return < -0.005 else \"neutral\"\n        }\n\n    # 2. 成交量變化\n    if 'volume' in wed_fri_data.columns:\n        avg_volume = price_df['volume'].rolling(20).mean().iloc[-1]\n        wed_fri_volume = wed_fri_data['volume'].mean()\n        vol_ratio = wed_fri_volume / avg_volume\n        evidence[\"volume_change\"] = {\n            \"value\": vol_ratio,\n            \"signal\": \"elevated\" if vol_ratio > 1.2 else \"normal\"\n        }\n\n    # 3. 宏觀共振\n    macro_wed_fri = macro_df.loc[wed:fri]\n    if len(macro_wed_fri) > 0:\n        usd_down = macro_wed_fri['dxy_ret'].sum() < 0\n        oil_up = macro_wed_fri['wti_ret'].sum() > 0\n        metals_up = macro_wed_fri['metals_ret'].sum() > 0\n\n        resonance_score = sum([usd_down, oil_up, metals_up]) / 3\n        evidence[\"macro_resonance\"] = {\n            \"value\": resonance_score,\n            \"details\": {\n                \"usd_down\": usd_down,\n                \"oil_up\": oil_up,\n                \"metals_up\": metals_up\n            },\n            \"signal\": \"supportive\" if resonance_score >= 0.67 else\n                      \"mixed\" if resonance_score >= 0.33 else \"unsupportive\"\n        }\n\n    return evidence\n```\n\n## Step 3: 宏觀一致性驗證\n\n```python\ndef validate_macro_alignment(flow_direction, macro_score):\n    \"\"\"驗證資金流向與宏觀指標的一致性\"\"\"\n\n    alignment = {\n        \"flow_direction\": \"inflow\" if flow_direction > 0 else \"outflow\",\n        \"macro_bias\": \"bullish\" if macro_score >= 0.67 else\n                      \"bearish\" if macro_score <= 0.33 else \"neutral\",\n        \"aligned\": None,\n        \"interpretation\": None\n    }\n\n    # 判斷一致性\n    if flow_direction > 0 and macro_score >= 0.5:\n        alignment[\"aligned\"] = True\n        alignment[\"interpretation\"] = \"資金流入且宏觀順風，敘事一致\"\n    elif flow_direction < 0 and macro_score <= 0.5:\n        alignment[\"aligned\"] = True\n        alignment[\"interpretation\"] = \"資金流出且宏觀逆風，敘事一致\"\n    elif flow_direction > 0 and macro_score < 0.5:\n        alignment[\"aligned\"] = False\n        alignment[\"interpretation\"] = \"資金流入但宏觀逆風，需警惕反轉\"\n    else:\n        alignment[\"aligned\"] = False\n        alignment[\"interpretation\"] = \"資金流出但宏觀順風，可能是超賣反彈機會\"\n\n    return alignment\n```\n\n## Step 4: 基本面事件匹配\n\n```python\nFUNDAMENTAL_EVENTS = {\n    \"export_sales\": {\n        \"source\": \"USDA FAS Weekly Export Sales\",\n        \"frequency\": \"weekly\",\n        \"impact_groups\": [\"grains\", \"oilseeds\"]\n    },\n    \"wasde_release\": {\n        \"source\": \"USDA WASDE\",\n        \"frequency\": \"monthly\",\n        \"impact_groups\": [\"grains\", \"oilseeds\", \"meats\", \"softs\"]\n    },\n    \"crop_progress\": {\n        \"source\": \"USDA Crop Progress\",\n        \"frequency\": \"weekly\",\n        \"impact_groups\": [\"grains\", \"oilseeds\"]\n    },\n    \"cattle_on_feed\": {\n        \"source\": \"USDA Cattle on Feed\",\n        \"frequency\": \"monthly\",\n        \"impact_groups\": [\"meats\"]\n    }\n}\n\ndef match_fundamental_events(cot_week_end, flow_by_group):\n    \"\"\"匹配當週的基本面事件\"\"\"\n    week_start = cot_week_end - timedelta(days=6)\n\n    matched_events = []\n\n    for event_name, event_info in FUNDAMENTAL_EVENTS.items():\n        # 檢查該週是否有事件發布\n        event_dates = get_event_dates(event_name, week_start, cot_week_end)\n\n        if event_dates:\n            # 取得事件內容\n            event_data = fetch_event_data(event_name, event_dates[-1])\n\n            # 判斷事件偏向\n            bias = interpret_event_bias(event_data)\n\n            # 檢查與流量方向的一致性\n            for group in event_info[\"impact_groups\"]:\n                if group in flow_by_group:\n                    flow = flow_by_group[group]\n                    consistent = (bias == \"bullish\" and flow > 0) or \\\n                                (bias == \"bearish\" and flow < 0)\n\n                    matched_events.append({\n                        \"event\": event_name,\n                        \"date\": str(event_dates[-1]),\n                        \"bias\": bias,\n                        \"group\": group,\n                        \"flow\": flow,\n                        \"consistent\": consistent\n                    })\n\n    return matched_events\n```\n\n## Step 5: 生成驗證報告\n\n```python\ndef generate_validation_report(cot_result, validation_results):\n    \"\"\"生成交叉驗證報告\"\"\"\n\n    report = {\n        \"validation_timestamp\": datetime.now().isoformat(),\n        \"cot_week_end\": cot_result[\"cot_week_end\"],\n\n        \"wed_fri_validation\": validation_results[\"wed_fri\"],\n        \"macro_alignment\": validation_results[\"macro\"],\n        \"fundamental_events\": validation_results[\"fundamentals\"],\n\n        \"overall_consistency\": None,\n        \"confidence_adjustment\": None,\n        \"narrative_assessment\": None\n    }\n\n    # 計算整體一致性分數\n    consistency_scores = []\n\n    # Wed-Fri 驗證\n    wed_fri = validation_results[\"wed_fri\"]\n    if wed_fri[\"price_momentum\"][\"signal\"] == \"bullish\":\n        consistency_scores.append(1)\n    elif wed_fri[\"price_momentum\"][\"signal\"] == \"bearish\":\n        consistency_scores.append(0)\n    else:\n        consistency_scores.append(0.5)\n\n    # 宏觀一致性\n    if validation_results[\"macro\"][\"aligned\"]:\n        consistency_scores.append(1)\n    else:\n        consistency_scores.append(0)\n\n    # 基本面一致性\n    fundamentals = validation_results[\"fundamentals\"]\n    if fundamentals:\n        fund_score = sum(1 for f in fundamentals if f[\"consistent\"]) / len(fundamentals)\n        consistency_scores.append(fund_score)\n\n    report[\"overall_consistency\"] = sum(consistency_scores) / len(consistency_scores)\n\n    # 信心調整\n    if report[\"overall_consistency\"] >= 0.7:\n        report[\"confidence_adjustment\"] = 0.1  # 增加 10% 信心\n        report[\"narrative_assessment\"] = \"敘事高度一致，可信度高\"\n    elif report[\"overall_consistency\"] >= 0.5:\n        report[\"confidence_adjustment\"] = 0\n        report[\"narrative_assessment\"] = \"敘事部分一致，需持續觀察\"\n    else:\n        report[\"confidence_adjustment\"] = -0.15  # 降低 15% 信心\n        report[\"narrative_assessment\"] = \"敘事存在矛盾，謹慎對待\"\n\n    return report\n```\n\n## Step 6: 輸出驗證結果\n\n```bash\npython scripts/cross_check.py \\\n  --cot-result output/result.json \\\n  --output output/validation_report.json\n```\n\n</process>\n\n<success_criteria>\n此工作流程完成時應確認：\n\n- [ ] Wed-Fri 價格動能已計算\n- [ ] 宏觀一致性已評估\n- [ ] 基本面事件已匹配\n- [ ] 整體一致性分數落在 0-1 範圍\n- [ ] 信心調整建議已給出\n- [ ] 敘事評估結論明確\n</success_criteria>\n",
        "skills/track-agri-hedge-fund-positioning/workflows/monitor.md": "# Workflow: 週度監控與警報\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/methodology.md\n2. references/data-sources.md\n</required_reading>\n\n<process>\n\n## Step 1: 確認 COT 發布時間\n\nCFTC COT 報告發布時間表：\n- **截止日**：每週二收盤\n- **發布日**：每週五 15:30 ET（美東時間）\n- **例外**：遇假日可能延後\n\n```python\nfrom datetime import datetime, timedelta\nimport pytz\n\ndef get_next_cot_release():\n    \"\"\"計算下一次 COT 發布時間\"\"\"\n    et = pytz.timezone('US/Eastern')\n    now = datetime.now(et)\n\n    # 找到下一個週五\n    days_until_friday = (4 - now.weekday()) % 7\n    if days_until_friday == 0 and now.hour >= 16:\n        days_until_friday = 7\n\n    next_friday = now + timedelta(days=days_until_friday)\n    release_time = next_friday.replace(hour=15, minute=30, second=0)\n\n    return release_time\n```\n\n## Step 2: 設定監控排程\n\n建議監控頻率：\n\n| 時間點           | 動作                         |\n|------------------|------------------------------|\n| 週五 16:00 ET    | 抓取最新 COT 資料            |\n| 週五 16:30 ET    | 執行完整分析                 |\n| 週一開盤前       | 檢查 Wed-Fri 價格動能        |\n| 週中 USDA 發布後 | 交叉驗證基本面               |\n\n```bash\n# 設定 cron job 範例（週五 16:00 ET）\n0 16 * * 5 cd /path/to/skill && python scripts/analyze_positioning.py --quick --alert\n```\n\n## Step 3: 定義警報條件\n\n```python\nALERT_CONDITIONS = {\n    # 高優先級警報\n    \"regime_change\": {\n        \"condition\": lambda r: abs(r['flow_total']) > threshold_high and\n                               r['prev_flow_total'] * r['flow_total'] < 0,\n        \"message\": \"Regime change detected: Flow reversed sign\",\n        \"priority\": \"high\"\n    },\n\n    # 中優先級警報\n    \"firepower_extreme\": {\n        \"condition\": lambda r: r['firepower_total'] < 0.15 or\n                               r['firepower_total'] > 0.85,\n        \"message\": \"Extreme firepower level detected\",\n        \"priority\": \"medium\"\n    },\n\n    # 低優先級警報\n    \"macro_divergence\": {\n        \"condition\": lambda r: (r['flow_total'] > 0 and r['macro_score'] < 0.33) or\n                               (r['flow_total'] < 0 and r['macro_score'] > 0.67),\n        \"message\": \"Macro divergence: Flow and macro signals misaligned\",\n        \"priority\": \"low\"\n    }\n}\n```\n\n## Step 4: 執行監控分析\n\n```bash\npython scripts/analyze_positioning.py \\\n  --mode monitor \\\n  --lookback-weeks 4 \\\n  --alert-config config/alert_rules.yaml \\\n  --output monitor_result.json\n```\n\n輸出範例：\n```json\n{\n  \"monitor_timestamp\": \"2026-01-24T16:30:00-05:00\",\n  \"cot_week_end\": \"2026-01-21\",\n  \"alerts_triggered\": [\n    {\n      \"alert_id\": \"firepower_extreme\",\n      \"priority\": \"medium\",\n      \"message\": \"Extreme firepower level detected\",\n      \"details\": {\n        \"firepower_total\": 0.12,\n        \"interpretation\": \"Crowded long positioning\"\n      }\n    }\n  ],\n  \"week_over_week_changes\": {\n    \"flow_total\": {\"current\": -25, \"previous\": 58, \"change\": -83},\n    \"firepower_total\": {\"current\": 0.12, \"previous\": 0.18, \"change\": -0.06}\n  }\n}\n```\n\n## Step 5: 發送通知\n\n支援多種通知管道：\n\n```python\ndef send_alert(alert_data, channels=['log']):\n    \"\"\"發送警報通知\"\"\"\n    for channel in channels:\n        if channel == 'log':\n            log_alert(alert_data)\n        elif channel == 'email':\n            send_email_alert(alert_data)\n        elif channel == 'slack':\n            send_slack_alert(alert_data)\n        elif channel == 'telegram':\n            send_telegram_alert(alert_data)\n\n# 設定檔範例 (config/alert_channels.yaml)\n\"\"\"\nchannels:\n  - type: log\n    path: logs/alerts.log\n\n  - type: slack\n    webhook_url: ${SLACK_WEBHOOK_URL}\n    channel: \"#trading-alerts\"\n\n  - type: email\n    smtp_server: smtp.gmail.com\n    recipients:\n      - trader@example.com\n\"\"\"\n```\n\n## Step 6: 歷史比對\n\n監控時自動比對歷史類似情境：\n\n```python\ndef find_similar_episodes(current_state, history_df, top_n=3):\n    \"\"\"找出歷史上的類似情境\"\"\"\n    similarity_scores = []\n\n    for date, row in history_df.iterrows():\n        # 計算特徵相似度\n        features = ['firepower_total', 'macro_score', 'flow_direction']\n        score = compute_similarity(current_state, row, features)\n        similarity_scores.append((date, score, row))\n\n    # 排序並返回最相似的 N 個\n    similar = sorted(similarity_scores, key=lambda x: x[1], reverse=True)[:top_n]\n\n    return [\n        {\n            \"date\": str(s[0]),\n            \"similarity\": s[1],\n            \"subsequent_move\": get_subsequent_move(s[0], history_df)\n        }\n        for s in similar\n    ]\n```\n\n## Step 7: 生成週報\n\n每週五分析後自動生成週報：\n\n```bash\npython scripts/generate_weekly_report.py \\\n  --result monitor_result.json \\\n  --template templates/output-markdown.md \\\n  --output reports/weekly_2026-01-24.md\n```\n\n</process>\n\n<success_criteria>\n此工作流程完成時應確認：\n\n- [ ] 在 COT 發布後及時執行分析\n- [ ] 警報條件正確觸發\n- [ ] 通知成功發送至指定管道\n- [ ] 週報自動生成\n- [ ] 歷史比對提供參考情境\n- [ ] 監控日誌完整記錄\n</success_criteria>\n",
        "skills/track-agri-hedge-fund-positioning/workflows/visualize.md": "# Workflow: 視覺化圖表\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/methodology.md\n2. templates/annotations.md\n</required_reading>\n\n<process>\n\n## Step 1: 確認輸入資料\n\n需要以下資料作為輸入：\n- 分析結果 JSON（來自 `workflows/analyze.md` 輸出）\n- 或直接重新執行分析\n\n```bash\n# 使用既有分析結果\npython scripts/visualize_flows.py -i output/result.json -o output/chart.png\n\n# 或重新分析並視覺化\npython scripts/analyze_positioning.py --full --visualize\n```\n\n## Step 2: 生成分組柱狀圖\n\n重建新聞風格的週流量柱狀圖：\n\n```python\nimport matplotlib.pyplot as plt\nimport numpy as np\n\ndef plot_weekly_flows(flows_df, output_path):\n    \"\"\"生成分組柱狀圖\"\"\"\n    fig, ax = plt.subplots(figsize=(14, 7))\n\n    dates = flows_df.index\n    width = 0.15\n    x = np.arange(len(dates))\n\n    # 分組柱狀\n    colors = {\n        'grains': '#F4A460',     # 橙色\n        'oilseeds': '#32CD32',   # 綠色\n        'meats': '#DC143C',      # 紅色\n        'softs': '#8B4513'       # 棕色\n    }\n\n    for i, (group, color) in enumerate(colors.items()):\n        ax.bar(x + i*width, flows_df[group], width,\n               label=group.capitalize(), color=color)\n\n    # 總和線\n    ax.plot(x + 2*width, flows_df['total'], 'k-o',\n            label='Total', linewidth=2)\n\n    ax.axhline(y=0, color='gray', linestyle='--', alpha=0.5)\n    ax.set_xlabel('Week')\n    ax.set_ylabel('Net Flow (# contracts)')\n    ax.set_title('Hedge Fund Positioning: Weekly Flows by Group')\n    ax.legend()\n\n    plt.tight_layout()\n    plt.savefig(output_path, dpi=150)\n    plt.close()\n```\n\n## Step 3: 生成火力時序圖\n\n```python\ndef plot_firepower_timeseries(firepower_df, output_path):\n    \"\"\"生成火力時序圖\"\"\"\n    fig, axes = plt.subplots(2, 1, figsize=(14, 10))\n\n    # 上圖：各群組火力\n    for group in ['grains', 'oilseeds', 'meats', 'softs']:\n        axes[0].plot(firepower_df.index, firepower_df[group],\n                    label=group.capitalize())\n\n    axes[0].axhline(y=0.6, color='green', linestyle='--',\n                   alpha=0.5, label='High Firepower Zone')\n    axes[0].axhline(y=0.3, color='red', linestyle='--',\n                   alpha=0.5, label='Low Firepower Zone')\n    axes[0].fill_between(firepower_df.index, 0.6, 1.0,\n                        alpha=0.1, color='green')\n    axes[0].fill_between(firepower_df.index, 0.0, 0.3,\n                        alpha=0.1, color='red')\n\n    axes[0].set_ylabel('Buying Firepower')\n    axes[0].set_title('Buying Firepower by Group')\n    axes[0].legend()\n    axes[0].set_ylim(0, 1)\n\n    # 下圖：總火力與宏觀評分\n    axes[1].plot(firepower_df.index, firepower_df['total'],\n                'b-', label='Total Firepower', linewidth=2)\n    axes[1].set_ylabel('Total Firepower', color='blue')\n\n    ax2 = axes[1].twinx()\n    ax2.plot(firepower_df.index, firepower_df['macro_score'],\n            'orange', label='Macro Tailwind', linewidth=2)\n    ax2.set_ylabel('Macro Tailwind Score', color='orange')\n\n    axes[1].set_title('Total Firepower vs Macro Tailwind')\n    axes[1].legend(loc='upper left')\n    ax2.legend(loc='upper right')\n\n    plt.tight_layout()\n    plt.savefig(output_path, dpi=150)\n    plt.close()\n```\n\n## Step 4: 添加標註\n\n依據 `templates/annotations.md` 的規則，在圖表上添加事件標註：\n\n```python\ndef add_annotations(ax, annotations_list, flows_df):\n    \"\"\"在圖表上添加事件標註\"\"\"\n    label_styles = {\n        'strong_corn_demand': {'color': 'green', 'marker': '^'},\n        'bearish_usda_stats': {'color': 'red', 'marker': 'v'},\n        'macro_mood_bullish': {'color': 'blue', 'marker': 'o'},\n        'small_holiday_flows': {'color': 'gray', 'marker': 's'}\n    }\n\n    for ann in annotations_list:\n        if ann['rule_hit']:\n            date = ann.get('date')\n            idx = flows_df.index.get_loc(date)\n            style = label_styles.get(ann['label'], {})\n\n            ax.annotate(\n                ann['label'].replace('_', ' ').title(),\n                xy=(idx, flows_df.loc[date, 'total']),\n                xytext=(10, 10),\n                textcoords='offset points',\n                fontsize=8,\n                arrowprops=dict(arrowstyle='->', color=style.get('color', 'black'))\n            )\n```\n\n## Step 5: 生成綜合儀表板\n\n```python\ndef create_dashboard(result_json, output_path):\n    \"\"\"生成綜合儀表板\"\"\"\n    fig = plt.figure(figsize=(16, 12))\n\n    # 布局：2x2 格子\n    gs = fig.add_gridspec(2, 2, hspace=0.3, wspace=0.3)\n\n    # 左上：週流量柱狀圖\n    ax1 = fig.add_subplot(gs[0, 0])\n    plot_weekly_flows_subplot(ax1, result_json['weekly_flows'])\n\n    # 右上：火力儀表\n    ax2 = fig.add_subplot(gs[0, 1])\n    plot_firepower_gauge(ax2, result_json['latest_metrics']['buying_firepower'])\n\n    # 左下：宏觀順風指標\n    ax3 = fig.add_subplot(gs[1, 0])\n    plot_macro_indicators(ax3, result_json)\n\n    # 右下：摘要卡片\n    ax4 = fig.add_subplot(gs[1, 1])\n    plot_summary_card(ax4, result_json['summary'])\n\n    plt.savefig(output_path, dpi=150, bbox_inches='tight')\n    plt.close()\n```\n\n## Step 6: 輸出檔案\n\n```bash\n# 輸出目錄結構\noutput/\n├── flows_chart.png          # 週流量柱狀圖\n├── firepower_chart.png      # 火力時序圖\n├── dashboard.png            # 綜合儀表板\n└── charts/                  # 單獨群組圖表\n    ├── grains.png\n    ├── oilseeds.png\n    ├── meats.png\n    └── softs.png\n```\n\n</process>\n\n<success_criteria>\n此工作流程完成時應確認：\n\n- [ ] 週流量柱狀圖成功生成（重建新聞風格）\n- [ ] 各群組顏色區分清楚\n- [ ] 火力分數圖包含區間標示（綠/紅區）\n- [ ] 事件標註正確顯示\n- [ ] 圖表解析度足夠（>= 150 dpi）\n- [ ] 輸出至指定路徑\n</success_criteria>\n",
        "skills/track-equity-cumulative-return/SKILL.md": "---\nname: track-equity-cumulative-return\nversion: 1.1.0\nupdated: 2026-01-28\ndescription: Track cumulative return of stocks/indices with multi-ticker comparison, index Top N ranking, and visualization. All comparisons use S&P 500 as the fixed benchmark.\n---\n\n<essential_principles>\n\n<principle name=\"sp500_benchmark\">\n**S&P 500 Fixed Benchmark (Core Methodology)**\n\nAll cumulative return analyses use S&P 500 (^GSPC) as the fixed benchmark. This is a core methodology decision:\n\n- S&P 500 represents the broad US equity market\n- Provides consistent, comparable baseline across all analyses\n- \"vs Benchmark\" = Stock Return - S&P 500 Return\n- Positive vs Benchmark indicates outperformance (Alpha)\n\n**This is hardcoded and cannot be changed.**\n</principle>\n\n<principle name=\"base_date_methodology\">\n**Base Date Methodology**\n\nFor cumulative return calculation, the base date is the **last trading day of the previous year**:\n\n```\nCumulative Return = ((Final Price / Base Price) - 1) × 100%\n```\n\n**Key methodology**:\n- Analyzing 2024 → Base date is 2023-12-29 (last trading day of 2023)\n- This captures the true return from year-end investment to period end\n\nAll tickers are aligned to common trading days with data.\n</principle>\n\n<principle name=\"four_scenarios\">\n**Four Analysis Scenarios**\n\nThis skill supports 4 distinct scenarios:\n\n| Scenario | Mode                       | Description                                     | Example                             |\n|----------|----------------------------|-------------------------------------------------|-------------------------------------|\n| **1.a**  | Stock(s), Year Only        | Analyze specific tickers for a single full year | NVDA, AMD in 2024 only              |\n| **1.b**  | Stock(s), Year to Today    | Analyze specific tickers from a year to today   | NVDA, AMD from 2022 to today        |\n| **2.a**  | Index Top N, Year Only     | Rank index components for a single full year    | Nasdaq 100 Top N in 2024 only       |\n| **2.b**  | Index Top N, Year to Today | Rank index components from a year to today      | Nasdaq 100 Top N from 2022 to today |\n\nUse `--year-only` flag to switch between \"Year Only\" (a) and \"Year to Today\" (b) modes.\n</principle>\n\n<principle name=\"supported_indices\">\n**Supported Index Components**\n\n| Index Code | Name                             | Components |\n|------------|----------------------------------|------------|\n| nasdaq100  | Nasdaq 100 Index                 | ~100       |\n| sp100      | S&P 100 Index                    | 100        |\n| dow30      | Dow Jones 30 Index               | 30         |\n| sox        | Philadelphia Semiconductor Index | 30         |\n\nTop N analysis fetches all component stocks and ranks by return.\n</principle>\n\n</essential_principles>\n\n<objective>\nTrack cumulative return performance of stocks and indices:\n\n1. **Fetch Data**: Get historical prices from Yahoo Finance (with caching)\n2. **Calculate Returns**: Cumulative return\n3. **Benchmark Comparison**: Compare against S&P 500 (fixed)\n4. **Rank Analysis**: Index component Top N performance ranking\n5. **Visualization**: dark theme PNG charts\n\nOutput: Cumulative return time series chart, performance ranking table, JSON data, Markdown report.\n</objective>\n\n<quick_start>\n\n**Quick Start: Analyze Stock Cumulative Returns**\n\n```bash\ncd skills/track-equity-cumulative-return/scripts\npip install pandas numpy yfinance matplotlib  # First time only\n\n# Scenario 1.a: Stock(s), 2024 Year Only\npython cumulative_return_analyzer.py --ticker NVDA AMD --year 2024 --year-only\n\n# Scenario 1.b: Stock(s), 2022 to Today\npython cumulative_return_analyzer.py --ticker NVDA AMD GOOGL --year 2022\n\n# Scenario 2.a: Nasdaq 100 Top 10, 2024 Year Only\npython index_component_analyzer.py --index nasdaq100 --year 2024 --year-only --top 10\n\n# Scenario 2.b: Nasdaq 100 Top 20, 2022 to Today\npython index_component_analyzer.py --index nasdaq100 --year 2022 --top 20\n\n# Visualization (with charts)\npython visualize_cumulative.py --ticker NVDA AMD --year 2024 --year-only\npython visualize_cumulative.py --mode top20 --index nasdaq100 --year 2022 --top 20\n```\n\nSample output:\n```json\n{\n  \"skill\": \"track-equity-cumulative-return\",\n  \"as_of\": \"2026-01-28\",\n  \"mode\": \"year_to_today\",\n  \"parameters\": {\n    \"tickers\": [\"NVDA\", \"AMD\"],\n    \"start_year\": 2022,\n    \"year_only\": false\n  },\n  \"benchmark\": {\n    \"ticker\": \"^GSPC\",\n    \"name\": \"S&P 500\",\n    \"cumulative_return_pct\": 45.2\n  },\n  \"summary\": {\n    \"best_performer\": \"NVDA\",\n    \"best_return\": 542.2,\n    \"beat_benchmark_count\": 2\n  }\n}\n```\n\n</quick_start>\n\n<intake>\nWhat analysis do you need?\n\n**Scenario Selection**:\n\n1. **Scenario 1.a** - Analyze stock(s) for a specific year only (e.g., \"NVDA in 2024 full year\")\n2. **Scenario 1.b** - Analyze stock(s) from a year to today (e.g., \"NVDA from 2022 to today\")\n3. **Scenario 2.a** - Index Top N for a specific year only (e.g., \"Nasdaq 100 Top N in 2024\")\n4. **Scenario 2.b** - Index Top N from a year to today (e.g., \"Nasdaq 100 Top N since 2022\")\n5. **Methodology** - Learn about cumulative return calculation\n\n**Provide your analysis parameters or select a scenario.**\n</intake>\n\n<routing>\n| User Input                         | Scenario | Command                                                                                 |\n|------------------------------------|----------|-----------------------------------------------------------------------------------------|\n| \"NVDA 2024 full year\", \"2024 only\" | **1.a**  | `python cumulative_return_analyzer.py --ticker NVDA --year 2024 --year-only`            |\n| \"NVDA from 2022\", \"since 2022\"     | **1.b**  | `python cumulative_return_analyzer.py --ticker NVDA --year 2022`                        |\n| \"Nasdaq 100 top 10 2024 only\"      | **2.a**  | `python index_component_analyzer.py --index nasdaq100 --year 2024 --year-only --top 10` |\n| \"Nasdaq 100 top 20 since 2022\"     | **2.b**  | `python index_component_analyzer.py --index nasdaq100 --year 2022 --top 20`             |\n| \"chart\", \"visualization\"           | Add      | `python visualize_cumulative.py` with same parameters                                   |\n| \"methodology\", \"how\"               | Info     | Read `references/methodology.md`                                                        |\n\n**Key flags**:\n- `--year-only`: Analyze only the specified year (scenarios a)\n- Without `--year-only`: Analyze from year to today (scenarios b)\n- `--top N`: Select Top N for index analysis\n\n**All scripts use Yahoo Finance real data with caching. Benchmark is always S&P 500.**\n</routing>\n\n<reference_index>\n**Reference Documents** (`references/`)\n\n| File                | Content                                  |\n|---------------------|------------------------------------------|\n| methodology.md      | Cumulative return calculation methodology |\n| data-sources.md     | Yahoo Finance data source documentation   |\n| input-schema.md     | Complete input parameter definitions      |\n| index-components.md | Supported index component lists           |\n</reference_index>\n\n<workflows_index>\n| Workflow       | Scenario | Use Case                  |\n|----------------|----------|---------------------------|\n| quick-check.md | 1.a/1.b  | Quick check single ticker |\n| compare.md     | 1.a/1.b  | Compare multiple tickers  |\n| top20.md       | 2.a/2.b  | Index Top N analysis      |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose                          |\n|--------------------|----------------------------------|\n| output-json.md     | JSON output structure definition |\n| output-markdown.md | Markdown report template         |\n</templates_index>\n\n<scripts_index>\n| Script                        | Command Example                    | Purpose                                 |\n|-------------------------------|------------------------------------|-----------------------------------------|\n| fetch_price_data.py           | `--ticker NVDA --start 2022-01-01` | Yahoo Finance data fetching             |\n| cumulative_return_analyzer.py | `--ticker NVDA AMD --year 2022`    | Cumulative return calculation (1.a/1.b) |\n| index_component_analyzer.py   | `--index nasdaq100 --year 2022`    | Index component analysis (2.a/2.b)      |\n| visualize_cumulative.py       | `--ticker NVDA AMD --year 2022`    | visualization                           |\n</scripts_index>\n\n<input_schema_summary>\n\n**Required Parameters**\n\n| Parameter | Type   | Description                       |\n|-----------|--------|-----------------------------------|\n| ticker    | string | Stock ticker(s) - can be multiple |\n| year      | int    | Start year                        |\n\n**Optional Parameters**\n\n| Parameter | Type   | Default   | Description                             |\n|-----------|--------|-----------|-----------------------------------------|\n| year-only | flag   | false     | If set, analyze only the specified year |\n| index     | string | nasdaq100 | Index type (for Top N mode)             |\n| top       | int    | 20        | Top N to select                         |\n| output    | string | auto      | Output file path                        |\n| mode      | string | compare   | Mode (compare/top20)                    |\n\n**Note**: Benchmark is hardcoded to S&P 500 (^GSPC) and cannot be changed.\n\nSee `references/input-schema.md` for complete parameter definitions.\n\n</input_schema_summary>\n\n<visualization>\n\n**Chart Specifications**\n\nCharts follow `thoughts/shared/guide/bloomberg-style-chart-guide.md`:\n\n- **Background**: `#1a1a2e` (dark blue-black)\n- **Grid**: `#2d2d44` (dark gray-purple)\n- **Primary lines**: `#ff6b35` (orange-red), `#ffaa00` (orange-yellow)\n- **Benchmark line**: `#004E89` (deep blue dashed)\n- **Zero line**: `#666666` (gray dotted)\n\n**X-axis format**:\n- January: Show year (e.g., \"2024\")\n- February-December: Show month number (e.g., \"2\", \"3\", ... \"12\")\n\nOutput specs:\n- Size: 14×8 inches (compare) / 16×10 inches (top20)\n- Resolution: 150 dpi\n- Format: PNG\n\n</visualization>\n\n<output_schema_summary>\n```json\n{\n  \"skill\": \"track-equity-cumulative-return\",\n  \"as_of\": \"2026-01-28\",\n  \"mode\": \"year_to_today\",\n  \"parameters\": {\n    \"tickers\": [\"NVDA\", \"AMD\"],\n    \"start_year\": 2022,\n    \"year_only\": false\n  },\n  \"period\": {\n    \"start_date\": \"2021-12-31\",\n    \"end_date\": \"2026-01-28\",\n    \"years_held\": 4.08\n  },\n  \"benchmark\": {\n    \"ticker\": \"^GSPC\",\n    \"name\": \"S&P 500\",\n    \"cumulative_return_pct\": 45.2\n  },\n  \"summary\": {\n    \"best_performer\": \"NVDA\",\n    \"best_return\": 542.2,\n    \"benchmark_return\": 45.2,\n    \"beat_benchmark_count\": 2\n  },\n  \"results\": [\n    {\n      \"ticker\": \"NVDA\",\n      \"name\": \"NVIDIA (NVDA)\",\n      \"cumulative_return_pct\": 542.2,\n      \"vs_benchmark\": 497.0\n    }\n  ],\n  \"chart_path\": \"output/cumulative_return_2026-01-28.png\"\n}\n```\n\nSee `templates/output-json.md` for complete output structure.\n</output_schema_summary>\n\n<success_criteria>\nSuccessful execution should produce:\n\n- [ ] Cumulative return time series data\n- [ ] Cumulative return for each ticker\n- [ ] Comparison against S&P 500 benchmark (vs benchmark)\n- [ ] Performance ranking (sorted by return descending)\n- [ ] Beat benchmark statistics\n- [ ] visualization chart (output/*.png)\n- [ ] JSON result output (optional)\n\n**Chart X-axis**: Year shown in January, month numbers (2-12) for other months.\n</success_criteria>\n\n<extended_examples>\n\n**Example 1: Single Stock Full Year Analysis (Scenario 1.a)**\n\nAnalyze NVIDIA's performance in 2024:\n\n```bash\ncd skills/track-equity-cumulative-return/scripts\npython cumulative_return_analyzer.py --ticker NVDA --year 2024 --year-only\n```\n\nExpected output:\n```\n==========================================================================================\nCumulative Return Analysis Report\n==========================================================================================\nPeriod: 2024 Full Year (2023-12-29 ~ 2024-12-31)\nBenchmark: S&P 500\n==========================================================================================\n\nRank  Ticker  Name                 Cum. Return   vs Bench\n----------------------------------------------------------------------\n1     NVDA    NVIDIA (NVDA)          +185.52%  +160.97% ✓\n----------------------------------------------------------------------\nBench ^GSPC   S&P 500                 +24.54%\n==========================================================================================\n\nStatistics:\n  - Best performer: NVDA (+185.52%)\n  - Beat benchmark: 1 / 1\n```\n\n**Example 2: Multi-Stock Long-Term Comparison (Scenario 1.b)**\n\nCompare FAANG stocks from 2020 to today:\n\n```bash\npython cumulative_return_analyzer.py --ticker META AAPL AMZN NFLX GOOGL --year 2020\npython visualize_cumulative.py --ticker META AAPL AMZN NFLX GOOGL --year 2020\n```\n\n**Example 3: Semiconductor Index Top 10 (Scenario 2.a)**\n\nFind top 10 semiconductor performers in 2024:\n\n```bash\npython index_component_analyzer.py --index sox --year 2024 --year-only --top 10\npython visualize_cumulative.py --mode top20 --index sox --year 2024 --year-only --top 10\n```\n\n**Example 4: Dow 30 Long-Term Analysis (Scenario 2.b)**\n\nAnalyze Dow 30 components from 2020:\n\n```bash\npython index_component_analyzer.py --index dow30 --year 2020 --top 30\n```\n\n</extended_examples>\n\n<error_handling>\n\n**Input Validation**\n\nThe skill includes comprehensive input validation:\n\n- **Ticker validation**: Checks format, applies corrections (e.g., `BRK.B` → `BRK-B`, `FB` → `META`)\n- **Year validation**: Must be between 1970 and current year\n- **Index validation**: Must be one of: `nasdaq100`, `sp100`, `dow30`, `sox`\n- **Top N validation**: Must be positive integer ≤ 100\n\n**Network Retry Logic**\n\nYahoo Finance API calls include automatic retry:\n\n- Up to 3 retry attempts\n- Exponential backoff (2s, 3s, 4.5s delays)\n- Clear error messages on failure\n\n**Data Quality Checks**\n\n- Minimum data points required (5 rows)\n- NaN percentage threshold (max 10%)\n- Invalid price detection (non-positive values)\n- Automatic data cleaning with warnings\n\n</error_handling>\n\n<testing>\n\n**Running Tests**\n\n```bash\ncd skills/track-equity-cumulative-return/scripts/tests\npython test_calculations.py\n```\n\n**Test Coverage**:\n\n1. **Cumulative return formula** - Validates calculation accuracy\n2. **Cumulative return series** - Validates time series generation\n3. **Validators** - Tests all input validation functions\n4. **Golden cases** - Structure validation of expected results\n\n**Golden Cases**\n\nLocated in `scripts/tests/golden_cases.json`:\n\n- NVDA 2024 full year (expected: 170-190% return)\n- AMD 2024 full year (expected: -20% to -10% return)\n- S&P 500 2024 benchmark (expected: 20-28% return)\n\n</testing>\n\n<data_governance>\n\n**Data Sources**\n\n| Source        | Type    | Caching       | Notes            |\n|---------------|---------|---------------|------------------|\n| Yahoo Finance | Primary | 12-hour cache | Free, public API |\n\n**Caching**\n\n- Cache directory: `scripts/cache/`\n- Cache format: Parquet (efficient storage)\n- Cache validity: 12 hours\n- Clear cache: `python fetch_price_data.py --clear-cache`\n\n**Known Limitations**\n\n1. **Survivorship bias**: Index components are current, not historical\n2. **Price-only returns**: Does not include dividends\n3. **Yahoo Finance rate limits**: Heavy usage may be throttled\n\n</data_governance>\n",
        "skills/track-equity-cumulative-return/references/data-sources.md": "# 數據來源說明\n\n本文檔說明累積報酬率追蹤技能使用的數據來源。\n\n---\n\n## 1. Yahoo Finance\n\n### 概述\n\n| 項目     | 說明                           |\n|----------|--------------------------------|\n| 來源     | Yahoo Finance                  |\n| API      | yfinance Python 套件           |\n| 費用     | 免費                           |\n| 限制     | 有速率限制，高頻請求可能被擋   |\n\n### 官方連結\n\n- 網站：https://finance.yahoo.com\n- 套件：https://pypi.org/project/yfinance/\n\n### 數據類型\n\n| 欄位          | 說明                     |\n|---------------|--------------------------|\n| Open          | 開盤價                   |\n| High          | 最高價                   |\n| Low           | 最低價                   |\n| Close         | 收盤價                   |\n| Adj Close     | 調整後收盤價（已調整分割）|\n| Volume        | 成交量                   |\n\n### 本技能使用\n\n- 使用 `Close`（收盤價）計算報酬率\n- Yahoo Finance 的 Close 已經過股票分割調整\n\n---\n\n## 2. 支援的標的類型\n\n### 個股\n\n```\nNVDA    NVIDIA\nAMD     AMD\nAAPL    Apple\nGOOGL   Google\nMSFT    Microsoft\nTSLA    Tesla\nMETA    Meta\nAMZN    Amazon\n```\n\n### 指數\n\n```\n^GSPC   S&P 500\n^NDX    Nasdaq 100\n^IXIC   Nasdaq Composite\n^DJI    Dow Jones Industrial\n^SOX    Philadelphia Semiconductor\n```\n\n### ADR\n\n```\nTSM     台積電 ADR\nASML    ASML ADR\n```\n\n---\n\n## 3. 快取機制\n\n### 設計\n\n為減少 API 請求，實作本地快取：\n\n| 參數           | 設定              |\n|----------------|-------------------|\n| 快取目錄       | scripts/cache/    |\n| 快取格式       | Parquet           |\n| 有效期         | 12 小時           |\n\n### 快取邏輯\n\n1. 檢查是否有快取檔案\n2. 檢查快取是否在有效期內\n3. 若有效則使用快取，否則重新抓取\n4. 抓取後更新快取\n\n### 清除快取\n\n```bash\npython fetch_price_data.py --clear-cache\n```\n\n---\n\n## 4. 數據品質\n\n### 已知問題\n\n| 問題           | 說明                               | 處理方式           |\n|----------------|------------------------------------|--------------------|\n| 缺值           | 部分日期可能無數據                 | dropna() 對齊      |\n| 延遲           | 收盤價可能有 15 分鐘延遲           | 接受，非即時用途   |\n| 分割           | 已調整，無需額外處理               | -                  |\n| 股息           | **未**計入                         | 註明為價格報酬     |\n\n### 數據驗證\n\n建議與其他來源交叉驗證：\n\n- Google Finance\n- Bloomberg Terminal\n- 券商平台\n\n---\n\n## 5. API 限制\n\n### Yahoo Finance 限制\n\n- 無明確公開的 rate limit\n- 高頻請求可能被暫時封鎖\n- 建議使用快取減少請求\n\n### 最佳實踐\n\n1. 使用快取（預設開啟）\n2. 避免過於頻繁的請求\n3. 批次抓取時加入延遲\n4. 處理 API 錯誤並重試\n\n---\n\n## 6. 替代數據來源\n\n若 Yahoo Finance 不可用，可考慮：\n\n| 來源            | 特點                           | 費用    |\n|-----------------|--------------------------------|---------|\n| Alpha Vantage   | 需要 API key，有免費額度       | 免費/付費|\n| IEX Cloud       | 可靠，但免費額度有限           | 免費/付費|\n| Polygon.io      | 專業級數據，需付費             | 付費    |\n| FRED            | 僅限總經數據                   | 免費    |\n\n目前本技能僅支援 Yahoo Finance。\n",
        "skills/track-equity-cumulative-return/references/index-components.md": "# 支援的指數成分股列表\n\n本文檔列出支援的指數及其成分股。\n\n> **注意**：成分股列表可能會隨時間調整，此為 2026 年初的參考版本。\n\n---\n\n## 1. Nasdaq 100 (nasdaq100)\n\n**描述**：納斯達克 100 指數，追蹤納斯達克交易所市值最大的 100 家非金融公司。\n\n**預設基準**：^NDX\n\n**成分股**（約 100 支）：\n\n```\nAAPL    MSFT    AMZN    NVDA    GOOGL   GOOG    META    TSLA    AVGO    COST\nNFLX    AMD     PEP     ADBE    CSCO    TMUS    INTC    CMCSA   INTU    QCOM\nTXN     AMGN    HON     AMAT    ISRG    BKNG    SBUX    LRCX    VRTX    ADP\nMDLZ    GILD    ADI     REGN    PANW    KLAC    MU      SNPS    CDNS    PYPL\nMELI    CSX     ASML    CRWD    MAR     ORLY    ABNB    MRVL    CTAS    NXPI\nPCAR    WDAY    CPRT    ROP     MNST    FTNT    DXCM    PAYX    ROST    KDP\nODFL    MCHP    KHC     AEP     IDXX    GEHC    FAST    AZN     LULU    EXC\nVRSK    EA      CTSH    CSGP    XEL     DLTR    BKR     FANG    TTWO\nTEAM    ON      CDW     BIIB    ZS      DDOG    GFS     ILMN    MDB     WBD\nCEG     LCID    RIVN    SIRI    JD      PDD     BIDU    NTES    ZM\n```\n\n---\n\n## 2. S&P 100 (sp100)\n\n**描述**：標普 100 指數，追蹤美國市值最大的 100 家公司。\n\n**預設基準**：^GSPC\n\n**成分股**（100 支）：\n\n```\nAAPL    ABBV    ABT     ACN     ADBE    AIG     AMD     AMGN    AMZN    AVGO\nAXP     BA      BAC     BK      BKNG    BLK     BMY     BRK-B   C       CAT\nCHTR    CL      CMCSA   COF     COP     COST    CRM     CSCO    CVS     CVX\nDE      DHR     DIS     DOW     DUK     EMR     EXC     F       FDX     GD\nGE      GILD    GM      GOOG    GOOGL   GS      HD      HON     IBM     INTC\nJNJ     JPM     KHC     KO      LIN     LLY     LMT     LOW     MA      MCD\nMDLZ    MDT     MET     META    MMM     MO      MRK     MS      MSFT    NEE\nNFLX    NKE     NVDA    ORCL    PEP     PFE     PG      PM      PYPL    QCOM\nRTX     SBUX    SCHW    SO      SPG     T       TGT     TMO     TMUS    TSLA\nTXN     UNH     UNP     UPS     USB     V       VZ      WFC     WMT     XOM\n```\n\n---\n\n## 3. Dow Jones 30 (dow30)\n\n**描述**：道瓊工業平均指數，追蹤美國 30 家大型藍籌股。\n\n**預設基準**：^DJI\n\n**成分股**（30 支）：\n\n```\nAAPL    AMGN    AMZN    AXP     BA      CAT     CRM     CSCO    CVX     DIS\nDOW     GS      HD      HON     IBM     INTC    JNJ     JPM     KO      MCD\nMMM     MRK     MSFT    NKE     PG      TRV     UNH     V       VZ      WMT\n```\n\n---\n\n## 4. Philadelphia Semiconductor (sox)\n\n**描述**：費城半導體指數，追蹤美國上市的半導體公司。\n\n**預設基準**：^SOX\n\n**成分股**（30 支）：\n\n```\nNVDA    AVGO    AMD     QCOM    TXN     INTC    MU      AMAT    LRCX    KLAC\nADI     MRVL    NXPI    ON      MCHP    MPWR    SWKS    QRVO    TER     ENTG\nTSM     ASML    ARM     WOLF    ACLS    ALGM    AMKR    COHR    CRUS    FORM\n```\n\n---\n\n## 5. 成分股分類\n\n### 按產業（Nasdaq 100）\n\n| 產業         | 代表公司                        |\n|--------------|---------------------------------|\n| 科技         | AAPL, MSFT, GOOGL, META         |\n| 半導體       | NVDA, AMD, AVGO, INTC           |\n| 電商/零售    | AMZN, COST                      |\n| 串流/娛樂    | NFLX, EA, TTWO                  |\n| 電動車       | TSLA, RIVN, LCID                |\n| 雲端/SaaS    | CRM, WDAY, DDOG, ZS             |\n| 生技/醫療    | AMGN, GILD, REGN, VRTX          |\n| 電信         | TMUS, CMCSA                     |\n\n### 按產業（費城半導體）\n\n| 類型         | 代表公司                        |\n|--------------|---------------------------------|\n| GPU/AI       | NVDA, AMD                       |\n| 代工         | TSM                             |\n| 設備         | ASML, AMAT, LRCX, KLAC          |\n| 通訊晶片     | QCOM, AVGO                      |\n| 記憶體       | MU                              |\n| 類比/混合    | ADI, TXN                        |\n| 車用/工業    | ON, NXPI, MCHP                  |\n\n---\n\n## 6. 更新說明\n\n### 成分股調整\n\n- 指數成分股會定期調整（通常季度或年度）\n- 本列表需定期更新以反映最新組成\n\n### 最後更新\n\n- 日期：2026-01-28\n- 來源：各指數官方網站、Yahoo Finance\n\n### 更新方式\n\n若需更新成分股列表，請編輯：\n`scripts/index_component_analyzer.py` 中的以下變數：\n\n- `SP100_COMPONENTS`\n- `NASDAQ100_COMPONENTS`\n- `DOW30_COMPONENTS`\n- `SOX_COMPONENTS`\n",
        "skills/track-equity-cumulative-return/references/input-schema.md": "# 完整輸入參數定義\n\n本文檔定義累積報酬率追蹤技能的所有輸入參數。\n\n---\n\n## 1. cumulative_return_analyzer.py\n\n### 必要參數\n\n| 參數     | 類型     | 說明               |\n|----------|----------|--------------------|\n| --ticker | str list | 股票代碼（可多個） |\n\n### 選用參數\n\n| 參數        | 類型 | 預設值 | 說明               |\n|-------------|------|--------|--------------------|\n| --year      | int  | 2022   | 起始年份           |\n| --benchmark | str  | ^GSPC  | 基準指數代碼       |\n| --output    | str  | None   | 輸出 JSON 檔案路徑 |\n\n### 使用範例\n\n```bash\n# 單一標的\npython cumulative_return_analyzer.py --ticker NVDA --year 2022\n\n# 多標的比較\npython cumulative_return_analyzer.py --ticker NVDA AMD GOOGL --year 2022\n\n# 自訂基準\npython cumulative_return_analyzer.py --ticker NVDA AMD --year 2022 --benchmark ^NDX\n\n# 輸出 JSON\npython cumulative_return_analyzer.py --ticker NVDA --year 2022 --output result.json\n```\n\n---\n\n## 2. index_component_analyzer.py\n\n### 必要參數\n\n無（有預設值）\n\n### 選用參數\n\n| 參數     | 類型 | 預設值    | 說明               |\n|----------|------|-----------|--------------------|\n| --index  | str  | nasdaq100 | 指數類型           |\n| --year   | int  | 2022      | 起始年份           |\n| --top    | int  | 20        | 取前 N 名          |\n| --output | str  | None      | 輸出 JSON 檔案路徑 |\n\n### 支援的指數\n\n| 代碼      | 名稱              |\n|-----------|-------------------|\n| nasdaq100 | 納斯達克 100 指數 |\n| sp100     | 標普 100 指數     |\n| dow30     | 道瓊工業 30 指數  |\n| sox       | 費城半導體指數    |\n\n### 使用範例\n\n```bash\n# Nasdaq 100 Top N\npython index_component_analyzer.py --index nasdaq100 --year 2022\n\n# S&P 100 Top 30\npython index_component_analyzer.py --index sp100 --year 2022 --top 30\n\n# 費城半導體\npython index_component_analyzer.py --index sox --year 2023\n\n# 輸出 JSON\npython index_component_analyzer.py --index nasdaq100 --year 2022 --output result.json\n```\n\n---\n\n## 3. visualize_cumulative.py\n\n### 必要參數\n\n無（有預設值）\n\n### 選用參數\n\n| 參數        | 類型     | 預設值    | 說明                     |\n|-------------|----------|-----------|--------------------------|\n| --mode      | str      | compare   | 模式 (compare/top20)     |\n| --ticker    | str list | NVDA AMD  | 股票代碼（compare 模式） |\n| --index     | str      | nasdaq100 | 指數類型（top20 模式）   |\n| --year      | int      | 2022      | 起始年份                 |\n| --benchmark | str      | ^GSPC     | 基準指數代碼             |\n| --output    | str      | auto      | 輸出 PNG 檔案路徑        |\n| --top       | int      | 20        | Top N（top20 模式）      |\n\n### 使用範例\n\n```bash\n# 多標的比較圖\npython visualize_cumulative.py --ticker NVDA AMD --year 2022\n\n# 指定輸出路徑\npython visualize_cumulative.py --ticker NVDA AMD GOOGL --year 2022 --output output/my_chart.png\n\n# Top N 圖表\npython visualize_cumulative.py --mode top20 --index nasdaq100 --year 2022\n\n# 費城半導體 Top 10\npython visualize_cumulative.py --mode top20 --index sox --year 2023 --top 10\n```\n\n---\n\n## 4. fetch_price_data.py\n\n### 必要參數\n\n| 參數     | 類型     | 說明               |\n|----------|----------|--------------------|\n| --ticker | str list | 股票代碼（可多個） |\n\n### 選用參數\n\n| 參數          | 類型 | 預設值     | 說明                  |\n|---------------|------|------------|-----------------------|\n| --start       | str  | 2022-01-01 | 起始日期 (YYYY-MM-DD) |\n| --end         | str  | 今日       | 結束日期 (YYYY-MM-DD) |\n| --no-cache    | flag | False      | 不使用快取            |\n| --clear-cache | flag | False      | 清除所有快取          |\n| --summary     | flag | False      | 顯示摘要              |\n\n### 使用範例\n\n```bash\n# 抓取單一標的\npython fetch_price_data.py --ticker NVDA --start 2022-01-01\n\n# 抓取多標的\npython fetch_price_data.py --ticker NVDA AMD GOOGL --start 2022-01-01\n\n# 不使用快取\npython fetch_price_data.py --ticker NVDA --start 2022-01-01 --no-cache\n\n# 清除快取\npython fetch_price_data.py --clear-cache\n\n# 顯示摘要\npython fetch_price_data.py --ticker NVDA --start 2022-01-01 --summary\n```\n\n---\n\n## 5. 參數驗證規則\n\n### ticker\n\n- 必須是有效的 Yahoo Finance 代碼\n- 大小寫不敏感（會自動轉大寫）\n- 指數以 ^ 開頭（如 ^GSPC）\n\n### year\n\n- 必須是整數\n- 建議範圍：2000 - 當前年份\n- 太早的年份可能缺少部分股票數據\n\n### index\n\n- 必須是預定義的指數代碼之一\n- 區分大小寫（使用小寫）\n\n### output\n\n- 若提供，必須是有效的檔案路徑\n- 目錄會自動建立\n- JSON 副檔名：.json\n- PNG 副檔名：.png\n",
        "skills/track-equity-cumulative-return/references/methodology.md": "## 1. 累積報酬率 (Cumulative Return)\n\n### 定義\n\n從某一時點（基準日）到另一時點的總報酬百分比。\n\n### 公式\n\n```\n累積報酬率 = ((最終價格 / 起始價格) - 1) × 100%\n```\n\n### 範例\n\n- 起始價格：$100\n- 最終價格：$150\n- 累積報酬率 = (150/100 - 1) × 100% = **+50%**\n\n### 時序計算\n\n對於每個交易日，計算相對於起始日的累積報酬：\n\n```python\ncumulative_return_t = ((price_t / price_0) - 1) × 100%\n```\n\n---\n\n## 2. 基準比較\n\n### 超額報酬 (Alpha)\n\n```\nvs_benchmark = 標的報酬率 - 基準報酬率\n```\n\n### 預設基準\n\n| 場景     | 預設基準          |\n|----------|-------------------|\n| 一般股票 | S&P 500 (^GSPC)   |\n| 科技股   | Nasdaq 100 (^NDX) |\n| 半導體   | 費城半導體 (^SOX) |\n| 藍籌股   | Dow Jones (^DJI)  |\n\n### 解讀\n\n| vs_benchmark | 意義                 |\n|--------------|----------------------|\n| > 0          | 打敗基準，有正 Alpha |\n| = 0          | 與基準持平           |\n| < 0          | 落後基準，有負 Alpha |\n\n---\n\n## 3. 日期對齊\n\n### 問題\n\n不同標的可能有不同的交易日（例如 ADR vs 美股）。\n\n### 解決方案\n\n1. 抓取所有標的的價格數據\n2. 取交集（所有標的都有數據的日期）\n3. 對齊後再計算報酬率\n\n```python\ncombined = combined.dropna()  # 只保留完整數據\n```\n\n### 起始日期處理（關鍵方法論）\n\n**核心原則**：累積報酬率的起始點應為「指定年份前一日的收盤價」，即**前一年最後一個交易日**。\n\n例如分析 2024 年的報酬率：\n- ❌ 錯誤：從 2024-01-02（第一個交易日）開始計算\n- ✅ 正確：從 2023-12-29（2023 年最後一個交易日）開始計算\n\n**處理流程**：\n\n1. 從前一年 12 月開始抓取數據（例如 2023-12-01）\n2. 找出**前一年最後一個交易日**（< {year}-01-01 的最後一筆）\n3. 以該日期為基準日（base_date），計算累積報酬率\n\n```python\n# 取得前一年最後一個交易日\nyear_start = f\"{start_year}-01-01\"\nprev_year_data = benchmark_data[benchmark_data.index < year_start]\nbase_date = prev_year_data.index[-1]  # 2023-12-29\n\n# 從 base_date 開始計算報酬率\ndata = data[data.index >= base_date]\ncumulative_return = ((price_end / price_base) - 1) * 100%\n```\n\n**為什麼這樣做？**\n\n- 投資者在 2023 年底買入，持有到 2024 年底\n- 真實報酬率應從買入日（2023 年最後交易日）計算\n- 若從 2024 年第一個交易日計算，會錯過跨年的價格變動\n\n---\n\n## 4. 指數成分股分析\n\n### Top N 排序\n\n1. 抓取所有成分股的價格數據\n2. 計算各股的累積報酬率\n3. 依報酬率降序排列\n4. 取前 N 名\n\n### 統計指標\n\n| 指標           | 計算方式                         |\n|----------------|----------------------------------|\n| 打敗基準數量   | 報酬率 > 基準報酬率的股票數      |\n| 打敗基準比例   | 打敗基準數量 / 總分析數量 × 100% |\n| Top N 平均報酬 | Top N 股票報酬率總和 / N         |\n| 全體平均報酬   | 所有股票報酬率總和 / 總數        |\n\n---\n\n## 5. 注意事項\n\n### 倖存者偏差\n\n- 成分股列表是**當前**的組成\n- 歷史上可能有不同的成分股\n- 分析結果會有倖存者偏差\n\n### 股息處理\n\n- 本工具使用**價格報酬**（Price Return）\n- **未**計入股息再投資\n- 對高股息股票，實際總報酬會更高\n\n### 股票分割\n\n- Yahoo Finance 已調整歷史價格（Adjusted Close）\n- 不需額外處理股票分割\n\n---\n\n## 6. 參考資料\n\n- [Investopedia: Cumulative Return](https://www.investopedia.com/terms/c/cumulativereturn.asp)\n- [Investopedia: Total Return vs Price Return](https://www.investopedia.com/terms/t/totalreturn.asp)\n",
        "skills/track-equity-cumulative-return/templates/output-json.md": "# JSON 輸出格式定義\n\n本文檔定義累積報酬率追蹤技能的 JSON 輸出結構。\n\n---\n\n## 1. 多標的比較模式 (mode: compare)\n\n**注意**：`start_date` 為前一年最後一個交易日（基準日），例如分析 2022 年起的報酬率，start_date 為 2021-12-31。\n\n```json\n{\n  \"skill\": \"track-equity-cumulative-return\",\n  \"as_of\": \"2026-01-28\",\n  \"mode\": \"compare\",\n  \"parameters\": {\n    \"tickers\": [\"NVDA\", \"AMD\", \"GOOGL\"],\n    \"start_year\": 2022,\n    \"benchmark\": \"^GSPC\"\n  },\n  \"period\": {\n    \"start_date\": \"2021-12-31\",\n    \"end_date\": \"2026-01-28\",\n    \"days_held\": 1489,\n    \"years_held\": 4.08\n  },\n  \"benchmark\": {\n    \"ticker\": \"^GSPC\",\n    \"name\": \"S&P 500\",\n    \"cumulative_return_pct\": 45.2\n  },\n  \"summary\": {\n    \"best_performer\": \"NVDA\",\n    \"best_return\": 320.5,\n    \"benchmark_return\": 45.2,\n    \"beat_benchmark_count\": 3,\n    \"total_count\": 3\n  },\n  \"results\": [\n    {\n      \"ticker\": \"NVDA\",\n      \"name\": \"NVIDIA (NVDA)\",\n      \"cumulative_return_pct\": 320.5,\n      \"vs_benchmark\": 275.3,\n      \"price_start\": 29.25,\n      \"price_end\": 123.15\n    },\n    {\n      \"ticker\": \"AMD\",\n      \"name\": \"AMD (AMD)\",\n      \"cumulative_return_pct\": 180.2,\n      \"vs_benchmark\": 135.0,\n      \"price_start\": 45.50,\n      \"price_end\": 127.48\n    },\n    {\n      \"ticker\": \"GOOGL\",\n      \"name\": \"Google (GOOGL)\",\n      \"cumulative_return_pct\": 65.3,\n      \"vs_benchmark\": 20.1,\n      \"price_start\": 144.25,\n      \"price_end\": 238.50\n    }\n  ]\n}\n```\n\n---\n\n## 2. 指數 Top N 模式 (mode: top20)\n\n**注意**：`start_date` 為前一年最後一個交易日（基準日），例如分析 2022 年起的報酬率，start_date 為 2021-12-31。\n\n```json\n{\n  \"skill\": \"track-equity-cumulative-return\",\n  \"as_of\": \"2026-01-28\",\n  \"mode\": \"top20\",\n  \"parameters\": {\n    \"index\": \"nasdaq100\",\n    \"index_name\": \"Nasdaq 100\",\n    \"start_year\": 2022,\n    \"top_n\": 20\n  },\n  \"period\": {\n    \"start_date\": \"2021-12-31\",\n    \"end_date\": \"2026-01-28\",\n    \"days_held\": 1489,\n    \"years_held\": 4.08\n  },\n  \"benchmark\": {\n    \"ticker\": \"^GSPC\",\n    \"name\": \"S&P 500\",\n    \"cumulative_return_pct\": 45.2\n  },\n  \"summary\": {\n    \"total_components\": 100,\n    \"analyzed\": 98,\n    \"failed\": 2,\n    \"beat_benchmark\": 45,\n    \"beat_benchmark_pct\": 45.9,\n    \"top_n_avg_return\": 145.6,\n    \"all_avg_return\": 52.3\n  },\n  \"top_performers\": [\n    {\n      \"rank\": 1,\n      \"ticker\": \"NVDA\",\n      \"name\": \"NVIDIA (NVDA)\",\n      \"cumulative_return_pct\": 320.5,\n      \"vs_benchmark\": 275.3\n    },\n    {\n      \"rank\": 2,\n      \"ticker\": \"META\",\n      \"name\": \"Meta (META)\",\n      \"cumulative_return_pct\": 250.2,\n      \"vs_benchmark\": 205.0\n    }\n  ]\n}\n```\n\n---\n\n## 3. 欄位說明\n\n### 基本資訊\n\n| 欄位       | 類型   | 說明                           |\n|------------|--------|--------------------------------|\n| skill      | string | 技能名稱                       |\n| as_of      | string | 分析日期 (YYYY-MM-DD)          |\n| mode       | string | 模式 (compare/top20)           |\n\n### parameters\n\n| 欄位        | 類型       | 說明                           |\n|-------------|------------|--------------------------------|\n| tickers     | string[]   | 股票代碼列表 (compare 模式)    |\n| start_year  | int        | 起始年份                       |\n| benchmark   | string     | 基準指數代碼                   |\n| index       | string     | 指數代碼 (top20 模式)          |\n| index_name  | string     | 指數名稱 (top20 模式)          |\n| top_n       | int        | Top N 數量 (top20 模式)        |\n\n### period\n\n| 欄位        | 類型   | 說明                           |\n|-------------|--------|--------------------------------|\n| start_date  | string | 起始日期 (YYYY-MM-DD)          |\n| end_date    | string | 結束日期 (YYYY-MM-DD)          |\n| days_held   | int    | 持有天數                       |\n| years_held  | float  | 持有年數                       |\n\n### benchmark\n\n| 欄位                  | 類型   | 說明                           |\n|-----------------------|--------|--------------------------------|\n| ticker                | string | 基準代碼                       |\n| name                  | string | 基準名稱                       |\n| cumulative_return_pct | float  | 基準累積報酬率 (%)             |\n\n### summary (compare 模式)\n\n| 欄位                 | 類型   | 說明                           |\n|----------------------|--------|--------------------------------|\n| best_performer       | string | 最佳表現者代碼                 |\n| best_return          | float  | 最佳報酬率 (%)                 |\n| benchmark_return     | float  | 基準報酬率 (%)                 |\n| beat_benchmark_count | int    | 打敗基準數量                   |\n| total_count          | int    | 總標的數量                     |\n\n### summary (top20 模式)\n\n| 欄位              | 類型   | 說明                           |\n|-------------------|--------|--------------------------------|\n| total_components  | int    | 指數總成分股數                 |\n| analyzed          | int    | 成功分析數量                   |\n| failed            | int    | 失敗/跳過數量                  |\n| beat_benchmark    | int    | 打敗基準數量                   |\n| beat_benchmark_pct| float  | 打敗基準比例 (%)               |\n| top_n_avg_return  | float  | Top N 平均報酬率 (%)           |\n| all_avg_return    | float  | 全體平均報酬率 (%)             |\n\n### results / top_performers\n\n| 欄位                  | 類型   | 說明                           |\n|-----------------------|--------|--------------------------------|\n| rank                  | int    | 排名 (僅 top20 模式)           |\n| ticker                | string | 股票代碼                       |\n| name                  | string | 股票名稱                       |\n| cumulative_return_pct | float  | 累積報酬率 (%)                 |\n| vs_benchmark          | float  | 相對基準報酬 (%)               |\n| price_start           | float  | 起始價格 (僅 compare 模式)     |\n| price_end             | float  | 結束價格 (僅 compare 模式)     |\n",
        "skills/track-equity-cumulative-return/templates/output-markdown.md": "# Markdown 報告模板\n\n本文檔定義累積報酬率分析的 Markdown 報告格式。\n\n---\n\n## 1. 多標的比較報告\n\n**注意**：起始日期為前一年最後一個交易日（基準日），例如分析 2022 年起，start_date 為 2021-12-31。\n\n```markdown\n# 累積報酬率分析報告\n\n**分析日期**: 2026-01-28\n**分析期間**: 2021-12-31 ~ 2026-01-28 (4.08 年)\n**基準日**: 2021-12-31 (2021 年最後交易日)\n**基準指數**: S&P 500\n\n---\n\n## 績效排名\n\n| 排名 | 代碼  | 名稱           | 累積報酬率 | vs 基準    |\n|------|-------|----------------|------------|------------|\n| 1    | NVDA  | NVIDIA (NVDA)  | +320.50%   | +275.30% ✓ |\n| 2    | AMD   | AMD (AMD)      | +180.20%   | +135.00% ✓ |\n| 3    | GOOGL | Google (GOOGL) | +65.30%    | +20.10% ✓  |\n| 基準 | ^GSPC | S&P 500        | +45.20%    | -          |\n\n---\n\n## 統計摘要\n\n- **最佳表現**: NVDA (+320.50%)\n- **打敗基準**: 3 / 3 支 (100%)\n- **平均報酬**: +188.67%\n\n---\n\n## 視覺化圖表\n\n![累積報酬率比較](output/cumulative_return_2026-01-28.png)\n\n---\n\n## 資料來源\n\n- 價格數據: Yahoo Finance\n- 截至日期: 2026-01-28\n```\n\n---\n\n## 2. 指數 Top N 報告\n\n**注意**：起始日期為前一年最後一個交易日（基準日），例如分析 2022 年起，start_date 為 2021-12-31。\n\n```markdown\n# Nasdaq 100 成分股績效分析\n\n**分析日期**: 2026-01-28\n**分析期間**: 2021-12-31 ~ 2026-01-28 (4.08 年)\n**基準日**: 2021-12-31 (2021 年最後交易日)\n**基準指數**: S&P 500\n\n---\n\n## Top N 績效排名\n\n| 排名 | 代碼 | 名稱   | 累積報酬率 | vs 基準  |\n|------|------|--------|------------|----------|\n| 1    | NVDA | NVIDIA | +320.50%   | +275.30% |\n| 2    | META | Meta   | +250.20%   | +205.00% |\n| 3    | AMD  | AMD    | +180.20%   | +135.00% |\n| ...  | ...  | ...    | ...        | ...      |\n| 20   | AAPL | Apple  | +65.30%    | +20.10%  |\n\n---\n\n## 統計摘要\n\n| 指標           | 數值       |\n|----------------|------------|\n| 分析股票數     | 98 / 100   |\n| 打敗基準數     | 45 (45.9%) |\n| Top N 平均報酬 | +145.60%   |\n| 全體平均報酬   | +52.30%    |\n\n---\n\n## 關鍵發現\n\n1. **龍頭效應明顯**: NVDA 單獨貢獻大部分指數漲幅\n2. **AI 概念領跑**: 前五名有三支為 AI 相關股票\n3. **分化加劇**: Top N 報酬率是全體平均的 2.8 倍\n\n---\n\n## 視覺化圖表\n\n![Nasdaq 100 Top N](output/nasdaq100_top20_2026-01-28.png)\n\n---\n\n## 風險提示\n\n- 成分股列表為當前組成，存在倖存者偏差\n- 報酬率為價格報酬，未計入股息\n- 過去績效不代表未來表現\n\n---\n\n## 資料來源\n\n- 價格數據: Yahoo Finance\n- 截至日期: 2026-01-28\n```\n\n---\n\n## 3. 模板使用方式\n\n### 替換變數\n\n| 變數               | 說明         |\n|--------------------|--------------|\n| `{as_of}`          | 分析日期     |\n| `{start_date}`     | 起始日期     |\n| `{end_date}`       | 結束日期     |\n| `{years_held}`     | 持有年數     |\n| `{benchmark_name}` | 基準名稱     |\n| `{best_performer}` | 最佳表現者   |\n| `{best_return}`    | 最佳報酬率   |\n| `{beat_count}`     | 打敗基準數量 |\n| `{total_count}`    | 總標的數量   |\n| `{chart_path}`     | 圖表路徑     |\n\n### 生成方式\n\n可透過 Python 腳本讀取 JSON 輸出並套用模板：\n\n```python\nimport json\n\nwith open('result.json', 'r') as f:\n    data = json.load(f)\n\nreport = f\"\"\"\n# 累積報酬率分析報告\n\n**分析日期**: {data['as_of']}\n**分析期間**: {data['period']['start_date']} ~ {data['period']['end_date']}\n\n...\n\"\"\"\n```\n",
        "skills/track-equity-cumulative-return/workflows/compare.md": "# 多標的比較工作流程\n\n比較多個股票/指數的累積報酬率表現。\n\n---\n\n## 使用場景\n\n- 比較同類型股票的表現（如多個半導體股）\n- 評估投資組合中各持股的貢獻\n- 找出表現最佳/最差的標的\n\n---\n\n## 執行步驟\n\n### 1. 基本比較\n\n```bash\ncd skills/track-equity-cumulative-return/scripts\n\n# 比較兩支股票\npython cumulative_return_analyzer.py --ticker NVDA AMD --year 2022\n\n# 比較多支股票\npython cumulative_return_analyzer.py --ticker NVDA AMD AVGO INTC --year 2022\n```\n\n### 2. 生成視覺化圖表\n\n```bash\n# 基本圖表\npython visualize_cumulative.py --ticker NVDA AMD --year 2022\n\n# 指定輸出路徑\npython visualize_cumulative.py --ticker NVDA AMD GOOGL --year 2022 --output output/tech_comparison.png\n\n# 更多標的\npython visualize_cumulative.py --ticker NVDA AMD AVGO INTC TSM QCOM --year 2022\n```\n\n### 3. 科技龍頭比較\n\n```bash\n# FAANG + Tesla\npython cumulative_return_analyzer.py --ticker AAPL AMZN META NFLX GOOGL TSLA --year 2022\n\n# 生成圖表\npython visualize_cumulative.py --ticker AAPL AMZN META NFLX GOOGL TSLA --year 2022\n```\n\n### 4. 半導體股比較\n\n```bash\n# 主要半導體股\npython cumulative_return_analyzer.py --ticker NVDA AMD AVGO INTC TSM QCOM --year 2022 --benchmark ^SOX\n\n# 使用費城半導體作為基準\npython visualize_cumulative.py --ticker NVDA AMD AVGO INTC --year 2022 --benchmark ^SOX\n```\n\n### 5. 指數比較\n\n```bash\n# 比較不同指數\npython cumulative_return_analyzer.py --ticker ^SOX ^NDX ^GSPC ^DJI --year 2022\n\n# 圖表\npython visualize_cumulative.py --ticker ^SOX ^NDX ^DJI --year 2022 --benchmark ^GSPC\n```\n\n---\n\n## 輸出範例\n\n### 文字報告\n\n```\n==========================================================================================\n累積報酬率分析報告\n==========================================================================================\n分析期間: 2022-01-03 ~ 2026-01-28 (4.07 年)\n基準指數: S&P 500\n==========================================================================================\n\n排名   代碼     名稱                  累積報酬率     vs 基準\n----------------------------------------------------------------------\n1     NVDA     NVIDIA (NVDA)          +320.50%     +275.30% ✓\n2     AMD      AMD (AMD)              +180.20%     +135.00% ✓\n3     AVGO     Broadcom (AVGO)        +120.50%      +75.30% ✓\n4     INTC     Intel (INTC)            -25.30%      -70.50%\n----------------------------------------------------------------------\n基準   ^GSPC    S&P 500                 +45.20%\n======================================================================\n\n統計:\n  - 最佳表現: NVDA (+320.50%)\n  - 打敗基準: 3 / 4 支\n  - 平均報酬: +148.98%\n```\n\n### 圖表輸出\n\n圖表會儲存到指定路徑（預設 `output/cumulative_return_YYYY-MM-DD.png`），特點：\n\n- 深色主題\n- 每條線標註最終報酬率\n- 基準線以虛線顯示\n- 零線輔助參考\n\n---\n\n## 建議的比較組合\n\n### 科技龍頭\n\n```bash\npython visualize_cumulative.py --ticker AAPL MSFT GOOGL AMZN META --year 2022\n```\n\n### AI 概念股\n\n```bash\npython visualize_cumulative.py --ticker NVDA AMD GOOGL MSFT META --year 2022\n```\n\n### 半導體設備\n\n```bash\npython visualize_cumulative.py --ticker AMAT LRCX KLAC ASML --year 2022 --benchmark ^SOX\n```\n\n### 電動車\n\n```bash\npython visualize_cumulative.py --ticker TSLA RIVN LCID --year 2022\n```\n\n---\n\n## 最佳實踐\n\n1. **相似標的比較**：比較同產業或同類型的標的更有意義\n2. **適當的基準**：選擇與標的相關的基準（如半導體股用 ^SOX）\n3. **合理的標的數量**：建議 2-8 個標的，太多會讓圖表難以閱讀\n4. **一致的時間範圍**：確保所有標的都有足夠的歷史數據\n\n---\n\n## 下一步\n\n- 若要分析整個指數的成分股，請參考 [top20.md](top20.md)\n",
        "skills/track-equity-cumulative-return/workflows/quick-check.md": "# 快速檢查工作流程\n\n快速查看單一標的從指定年份至今的累積報酬率。\n\n---\n\n## 使用場景\n\n- 快速查看某股票的長期表現\n- 確認報酬率與基準的比較\n\n---\n\n## 執行步驟\n\n### 1. 基本查詢\n\n```bash\ncd skills/track-equity-cumulative-return/scripts\npython cumulative_return_analyzer.py --ticker NVDA --year 2022\n```\n\n### 2. 自訂起始年份\n\n```bash\n# 從 2020 年開始\npython cumulative_return_analyzer.py --ticker NVDA --year 2020\n\n# 從 2023 年開始\npython cumulative_return_analyzer.py --ticker NVDA --year 2023\n```\n\n### 3. 自訂基準\n\n```bash\n# 使用 Nasdaq 100 作為基準\npython cumulative_return_analyzer.py --ticker NVDA --year 2022 --benchmark ^NDX\n\n# 使用費城半導體作為基準\npython cumulative_return_analyzer.py --ticker NVDA --year 2022 --benchmark ^SOX\n```\n\n### 4. 輸出 JSON\n\n```bash\npython cumulative_return_analyzer.py --ticker NVDA --year 2022 --output result.json\n```\n\n---\n\n## 輸出範例\n\n```\n==========================================================================================\n累積報酬率追蹤器\n標的: NVIDIA (NVDA)\n基準: S&P 500\n從 2022 年開始至今\n==========================================================================================\n\n正在抓取數據...\n  [Fetch] NVDA: 1000 筆 (2022-01-03 ~ 2026-01-28)\n  [Fetch] S&P 500 (基準)...\n\n正在計算累積報酬率...\n\n==========================================================================================\n累積報酬率分析報告\n==========================================================================================\n分析期間: 2022-01-03 ~ 2026-01-28 (4.07 年)\n基準指數: S&P 500\n==========================================================================================\n\n排名   代碼     名稱                  累積報酬率     vs 基準\n----------------------------------------------------------------------\n1     NVDA     NVIDIA (NVDA)          +320.50%     +275.30% ✓\n----------------------------------------------------------------------\n基準   ^GSPC    S&P 500                 +45.20%\n======================================================================\n\n統計:\n  - 最佳表現: NVDA (+320.50%)\n  - 打敗基準: 1 / 1 支\n  - 平均報酬: +320.50%\n```\n\n---\n\n## 常見股票代碼\n\n### 科技龍頭\n\n```\nAAPL    Apple\nMSFT    Microsoft\nGOOGL   Google\nAMZN    Amazon\nMETA    Meta\nNFLX    Netflix\nTSLA    Tesla\n```\n\n### 半導體\n\n```\nNVDA    NVIDIA\nAMD     AMD\nAVGO    Broadcom\nINTC    Intel\nTSM     台積電 ADR\nQCOM    Qualcomm\n```\n\n### 指數\n\n```\n^GSPC   S&P 500\n^NDX    Nasdaq 100\n^DJI    Dow Jones\n^SOX    費城半導體\n```\n\n---\n\n## 下一步\n\n- 若要比較多個標的，請參考 [compare.md](compare.md)\n- 若要分析指數成分股，請參考 [top20.md](top20.md)\n",
        "skills/track-equity-cumulative-return/workflows/top-n.md": "# 指數 Top N 分析工作流程\n\n分析指數成分股的累積報酬率，找出表現最佳的 Top N 標的。\n\n---\n\n## 使用場景\n\n- 找出某指數中表現最好的股票\n- 了解指數內部的分化情況\n- 識別龍頭股與落後股\n- 評估「打敗指數」的難度\n\n---\n\n## 支援的指數\n\n| 代碼      | 名稱              | 成分股數 |\n|-----------|-------------------|----------|\n| nasdaq100 | 納斯達克 100 指數 | ~100     |\n| sp100     | 標普 100 指數     | 100      |\n| dow30     | 道瓊工業 30 指數  | 30       |\n| sox       | 費城半導體指數    | 30       |\n\n---\n\n## 執行步驟\n\n### 1. 基本分析\n\n```bash\ncd skills/track-equity-cumulative-return/scripts\n\n# Nasdaq 100 Top N\npython index_component_analyzer.py --index nasdaq100 --year 2022\n\n# S&P 100 Top N\npython index_component_analyzer.py --index sp100 --year 2022\n\n# 費城半導體 Top N\npython index_component_analyzer.py --index sox --year 2022\n```\n\n### 2. 調整 Top N\n\n```bash\n# Top 10\npython index_component_analyzer.py --index nasdaq100 --year 2022 --top 10\n\n# Top 30\npython index_component_analyzer.py --index nasdaq100 --year 2022 --top 30\n```\n\n### 3. 生成視覺化圖表\n\n```bash\n# Nasdaq 100 Top N 圖表\npython visualize_cumulative.py --mode top20 --index nasdaq100 --year 2022\n\n# S&P 100 Top N 圖表\npython visualize_cumulative.py --mode top20 --index sp100 --year 2022\n\n# 費城半導體 Top 15 圖表\npython visualize_cumulative.py --mode top20 --index sox --year 2022 --top 15\n```\n\n### 4. 輸出 JSON\n\n```bash\npython index_component_analyzer.py --index nasdaq100 --year 2022 --output result.json\n```\n\n---\n\n## 輸出範例\n\n### 文字報告\n\n```\n====================================================================================================\nNasdaq 100 成分股績效排名\n分析期間: 2022-01-03 ~ 2026-01-28 (4.07 年)\n====================================================================================================\n\n排名   代碼     名稱                       累積報酬率     vs 基準\n--------------------------------------------------------------------------------\n1     NVDA     NVIDIA (NVDA)               +320.50%     +275.30% ✓\n2     META     Meta (META)                 +250.20%     +205.00% ✓\n3     AMD      AMD (AMD)                   +180.20%     +135.00% ✓\n4     AVGO     Broadcom (AVGO)             +120.50%      +75.30% ✓\n5     NFLX     Netflix (NFLX)              +110.30%      +65.10% ✓\n...\n20    AAPL     Apple (AAPL)                 +65.30%      +20.10% ✓\n--------------------------------------------------------------------------------\n基準   ^GSPC    S&P 500                      +45.20%\n================================================================================\n\n統計:\n  - 分析股票數: 98 / 100\n  - 打敗基準: 45 支 (45.9%)\n  - Top N 平均報酬: +145.60%\n  - 全體平均報酬: +52.30%\n```\n\n### 圖表輸出\n\n圖表會儲存到指定路徑（預設 `output/{index}_top{n}_YYYY-MM-DD.png`），特點：\n\n- 深色主題\n- Top N 條報酬率線\n- 基準線以粗虛線顯示\n- 圖例顯示各股最終報酬率\n\n---\n\n## 分析解讀\n\n### 打敗基準比例\n\n| 比例  | 解讀                               |\n|-------|------------------------------------|\n| > 50% | 多數成分股表現優於基準，市場氣氛佳 |\n| = 50% | 均衡                               |\n| < 50% | 少數股票拉動指數，集中度高         |\n\n### Top N vs 全體平均\n\n| 情況              | 解讀                         |\n|-------------------|------------------------------|\n| Top N >> 全體平均 | 龍頭股領跑，指數依賴少數股票 |\n| Top N ≈ 全體平均  | 分化不明顯，普漲行情         |\n\n### 龍頭股佔比\n\n觀察前幾名是否過度集中：\n- 若第一名報酬率遠超第二名，表示單一股票主導\n- 若前五名報酬率接近，表示多頭氣氛廣泛\n\n---\n\n## 進階應用\n\n### 季度追蹤\n\n```bash\n# 每季執行一次，觀察排名變化\npython index_component_analyzer.py --index nasdaq100 --year 2025 --output result_2025Q1.json\n```\n\n### 跨指數比較\n\n```bash\n# 分別分析不同指數\npython index_component_analyzer.py --index nasdaq100 --year 2022\npython index_component_analyzer.py --index sp100 --year 2022\npython index_component_analyzer.py --index sox --year 2022\n```\n\n### 特定產業深入\n\n若發現某產業表現突出，可進一步比較：\n\n```bash\n# 半導體股詳細比較\npython cumulative_return_analyzer.py --ticker NVDA AMD AVGO INTC TSM QCOM MU AMAT --year 2022 --benchmark ^SOX\n```\n\n---\n\n## 注意事項\n\n1. **執行時間**：分析 100 支股票需要較長時間（約 2-3 分鐘）\n2. **API 限制**：Yahoo Finance 可能有速率限制，使用快取可加速\n3. **資料缺失**：部分股票可能因上市時間不足而被跳過\n4. **倖存者偏差**：成分股列表是當前的，歷史成分可能不同\n\n---\n\n## 下一步\n\n- 找到感興趣的股票後，可使用 [compare.md](compare.md) 進行詳細比較\n- 單一股票詳情請參考 [quick-check.md](quick-check.md)\n",
        "skills/us-cpi-pce-comparator/SKILL.md": "---\nname: us-cpi-pce-comparator\ndescription: 自動比較美國 CPI（固定權重）與 PCE（動態權重）的通膨訊號，識別低波動高權重桶位的 PCE 上行風險。用於分析 Fed 關注的 PCE 是否正在 re-accelerate，即使 CPI 看似降溫。\n---\n\n<essential_principles>\n\n<principle name=\"weight_difference\">\n**CPI vs PCE 權重差異是核心**\n\n- **CPI（固定權重）**: BLS Relative Importance，每年或每兩年更新，反映「固定籃子」\n- **PCE（動態/鏈結權重）**: BEA 名目支出占比，每月隨實際消費行為調整\n\n關鍵洞見：當消費者把錢花在「價格較不波動」的品項時，若這些品項的通膨走高，PCE 會比 CPI 更敏感地反映這個上行壓力。\n</principle>\n\n<principle name=\"volatility_matters\">\n**低波動 + 高權重 = PCE 上行風險訊號**\n\n識別邏輯：\n1. 找出 PCE 權重較高的消費桶（consumer spending buckets）\n2. 在這些桶中，篩選價格波動度較低者\n3. 若這些桶的通膨近期轉正或加速，標記為 PCE upside risk\n</principle>\n\n<principle name=\"scope_difference\">\n**CPI 與 PCE 的範圍差異**\n\nPCE 涵蓋項目比 CPI 更廣：\n- 第三方支付的醫療費用（employer-paid healthcare）\n- 非營利機構對家庭的服務\n- 某些金融服務的隱含費用\n\n這些 scope 差異也會造成 CPI/PCE 分歧。詳見 `references/cpi-pce-methodology.md`。\n</principle>\n\n<principle name=\"data_access\">\n**資料取得方式**\n\n本 skill 使用**無需 API key** 的資料來源：\n- **FRED CSV**: `https://fred.stlouisfed.org/graph/fredgraph.csv?id={SERIES_ID}`\n- **BLS Public API**: `https://api.bls.gov/publicAPI/v2/timeseries/data/`\n\n腳本位於 `scripts/` 目錄，可直接執行。\n</principle>\n\n</essential_principles>\n\n<objective>\n比較 CPI 與 PCE 通膨訊號的分歧，並識別「低波動、高 PCE 權重」的消費桶是否正在推升 Fed 關注的 PCE 通膨路徑。\n\n輸出三層訊號：\n1. **Headline level**: CPI vs PCE divergence（bps）\n2. **Attribution**: 哪些 buckets 在推升 PCE（weighted contribution）\n3. **Risk framing**: 觀察點與延續性風險評估\n</objective>\n\n<quick_start>\n\n**最快的方式：執行快速檢查**\n\n```bash\ncd skills/us-cpi-pce-comparator\npip install pandas numpy requests  # 首次使用\npython scripts/cpi_pce_analyzer.py --quick\n```\n\n輸出範例：\n```json\n{\n  \"headline\": {\"cpi_yoy\": 2.65, \"pce_yoy\": 2.79, \"gap_bps\": 14},\n  \"core\": {\"cpi_core_yoy\": 2.65, \"pce_core_yoy\": 2.83, \"gap_bps\": 18},\n  \"momentum\": {\"cpi_3m_saar\": 2.07, \"pce_3m_saar\": 2.82}\n}\n```\n\n**完整分析**：\n```bash\npython scripts/cpi_pce_analyzer.py --start 2020-01-01 --measure yoy\n```\n\n</quick_start>\n\n<intake>\n需要進行什麼分析？\n\n1. **快速檢查** - 查看最新的 CPI/PCE 分歧數據\n2. **完整分析** - 執行完整的三步驟分析工作流\n3. **方法論學習** - 了解 CPI/PCE 差異的深層原因\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                     | Action                                            |\n|------------------------------|---------------------------------------------------|\n| 1, \"快速\", \"quick\", \"check\"  | 執行 `python scripts/cpi_pce_analyzer.py --quick` |\n| 2, \"完整\", \"full\", \"analyze\" | 閱讀 `workflows/analyze.md` 並執行                |\n| 3, \"學習\", \"方法論\", \"why\"   | 閱讀 `references/cpi-pce-methodology.md`          |\n| 提供參數 (如日期範圍)        | 閱讀 `workflows/analyze.md` 並使用參數執行        |\n\n**路由後，閱讀對應文件並執行。**\n</routing>\n\n<directory_structure>\n```\nus-cpi-pce-comparator/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── workflows/\n│   ├── analyze.md                     # 完整分析工作流\n│   └── quick-check.md                 # 快速檢查工作流\n├── references/\n│   ├── data-sources.md                # FRED/BLS 系列代碼與資料來源\n│   ├── cpi-pce-methodology.md         # CPI/PCE 方法論深度解析\n│   └── implementation.md              # 計算公式與程式碼範例\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n└── scripts/\n    ├── fetch_fred_data.py             # FRED 資料抓取（無需 API key）\n    ├── fetch_bls_data.py              # BLS 資料抓取\n    └── cpi_pce_analyzer.py            # 主分析腳本\n```\n</directory_structure>\n\n<reference_index>\n\n**方法論**: references/cpi-pce-methodology.md\n- CPI vs PCE 的五大差異（權重、範圍、公式、住房、人口）\n- 分歧模式與交易含義\n- Fed 如何解讀兩指標\n\n**資料來源**: references/data-sources.md\n- FRED CSV endpoint（無需 API key）\n- FRED 系列代碼對照表\n- 桶位定義與近似計算\n\n**實作指南**: references/implementation.md\n- 通膨計算公式（YoY, MoM SAAR, QoQ SAAR）\n- 權重效應計算\n- 波動度分析\n\n</reference_index>\n\n<workflows_index>\n| Workflow       | Purpose        | 使用時機           |\n|----------------|----------------|--------------------|\n| analyze.md     | 完整三步驟分析 | 需要深度分析時     |\n| quick-check.md | 快速檢查分歧   | 日常監控或快速回答 |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構定義 |\n| output-markdown.md | Markdown 報告模板 |\n</templates_index>\n\n<scripts_index>\n| Script              | Command                      | Purpose           |\n|---------------------|------------------------------|-------------------|\n| cpi_pce_analyzer.py | `--quick`                    | 快速檢查最新分歧  |\n| cpi_pce_analyzer.py | `--start DATE --measure yoy` | 完整分析          |\n| fetch_fred_data.py  | `--series CPIAUCSL,PCEPI`    | 抓取 FRED 資料    |\n| fetch_bls_data.py   | `--full`                     | 抓取 BLS CPI 資料 |\n</scripts_index>\n\n<input_schema>\n\n<parameter name=\"start_date\" required=\"true\">\n**Type**: string (ISO YYYY-MM-DD)\n**Description**: 分析起始日\n</parameter>\n\n<parameter name=\"end_date\" required=\"false\" default=\"today\">\n**Type**: string (ISO YYYY-MM-DD)\n**Description**: 分析結束日\n</parameter>\n\n<parameter name=\"measure\" required=\"false\" default=\"yoy\">\n**Type**: string\n**Options**: `yoy` | `mom_saar` | `qoq_saar`\n</parameter>\n\n<parameter name=\"baseline\" required=\"false\">\n**Type**: string\n**Format**: `YYYY-MM-DD:YYYY-MM-DD`\n**Description**: 基準期範圍，用於計算偏離度\n</parameter>\n\n</input_schema>\n\n<output_schema>\n參見 `templates/output-json.md` 的完整結構定義。\n\n**摘要**：\n```json\n{\n  \"headline\": {\"cpi_yoy\": 2.65, \"pce_yoy\": 2.79, \"gap_bps\": 14},\n  \"low_vol_high_weight_buckets\": [{\"bucket\": \"...\", \"signal\": \"upside\"}],\n  \"attribution\": {\"top_contributors\": [...], \"weight_effect_bps\": 12},\n  \"interpretation\": [\"...\"],\n  \"caveats\": [\"...\"]\n}\n```\n</output_schema>\n\n<success_criteria>\n分析成功時應產出：\n\n- [ ] Headline level 的 CPI/PCE 分歧數值（bps）\n- [ ] 識別出低波動、高 PCE 權重的桶位\n- [ ] 各桶位的加權通膨貢獻（attribution）\n- [ ] 若有 baseline，產出「less baseline」偏離度\n- [ ] 可操作的解讀與風險提示\n- [ ] 明確標註資料限制與近似處理\n</success_criteria>\n",
        "skills/us-cpi-pce-comparator/references/cpi-pce-methodology.md": "<overview>\n此參考文件深入解釋 CPI 與 PCE 的方法論差異，是理解兩指標分歧的核心知識。\n</overview>\n\n<why_two_measures>\n\n**為什麼美國有兩個主要通膨指標？**\n\n| 指標 | 發布單位 | 用途 |\n|------|---------|------|\n| **CPI** (Consumer Price Index) | BLS (勞工統計局) | 工資調整、社會福利、TIPS、公眾通膨預期 |\n| **PCE** (Personal Consumption Expenditures) | BEA (經濟分析局) | **Fed 貨幣政策目標** (2% 目標) |\n\nFed 在 2000 年正式將 PCE 作為通膨目標指標，因為 PCE 的計算方式更能反映「消費者實際承受的通膨」。\n\n</why_two_measures>\n\n<key_differences>\n\n<difference name=\"weighting_method\" importance=\"highest\">\n**權重方法：最重要的差異**\n\n| | CPI | PCE |\n|---|-----|-----|\n| **類型** | 固定權重 (Laspeyres-like) | 鏈結權重 (Fisher-Ideal) |\n| **更新頻率** | 每年或每兩年 | 每月 |\n| **反應速度** | 慢 | 快 |\n| **替代效應** | 不捕捉 | 捕捉 |\n\n**替代效應範例**：\n- 當牛肉價格上漲時，消費者改買雞肉\n- CPI：仍按原本的牛肉權重計算 → 高估通膨\n- PCE：權重自動移向雞肉 → 更真實反映消費者支出\n\n**結果**：長期而言，CPI 傾向高估通膨約 0.2-0.3 個百分點。\n\n</difference>\n\n<difference name=\"scope\" importance=\"high\">\n**涵蓋範圍差異**\n\n| 項目 | CPI | PCE |\n|------|-----|-----|\n| 消費者直接支付 | ✅ | ✅ |\n| 雇主代付醫療 | ❌ | ✅ |\n| 政府補貼醫療 | ❌ | ✅ |\n| 非營利組織服務 | ❌ | ✅ |\n| 金融服務隱含費用 | 部分 | ✅ |\n\n**醫療是最大的 scope 差異**：\n- CPI 醫療權重：約 7%（只計消費者自付）\n- PCE 醫療權重：約 17%（含第三方支付）\n\n這解釋了為什麼當醫療通膨走高時，PCE 受影響更大。\n\n</difference>\n\n<difference name=\"housing_weight\" importance=\"high\">\n**住房權重差異**\n\n| | CPI | PCE |\n|---|-----|-----|\n| 住房權重 | ~34% | ~15-18% |\n| OER 權重 | ~26% | ~12% |\n\n**OER (Owner's Equivalent Rent)**：用於估算自有住房的「隱含租金」。\n\n**影響**：\n- 當 OER/租金通膨走高時，CPI 受影響更大\n- 當 OER 下降時，CPI 降溫速度比 PCE 快\n\n這是 2022-2024 年間 CPI/PCE 分歧的主要來源之一。\n\n</difference>\n\n<difference name=\"formula\" importance=\"medium\">\n**計算公式差異**\n\n**CPI (Modified Laspeyres)**：\n$$CPI_t = \\frac{\\sum_i p_i^t \\cdot q_i^0}{\\sum_i p_i^0 \\cdot q_i^0} \\times 100$$\n\n其中 $q_i^0$ 是基準期的消費量（固定）。\n\n**PCE (Fisher-Ideal Chain)**：\n$$PCE_t = PCE_{t-1} \\times \\sqrt{\\frac{\\sum_i p_i^t \\cdot q_i^{t-1}}{\\sum_i p_i^{t-1} \\cdot q_i^{t-1}} \\times \\frac{\\sum_i p_i^t \\cdot q_i^t}{\\sum_i p_i^{t-1} \\cdot q_i^t}}$$\n\nFisher-Ideal 指數是 Laspeyres 和 Paasche 的幾何平均，減少了偏誤。\n\n</difference>\n\n<difference name=\"population\" importance=\"low\">\n**人口涵蓋**\n\n| | CPI | PCE |\n|---|-----|-----|\n| 涵蓋 | 都市消費者 (Urban Consumers) | 所有消費者 + 非營利組織 |\n| 比例 | 約 93% 人口 | 100% |\n\n實務上，這個差異影響較小。\n\n</difference>\n\n</key_differences>\n\n<divergence_patterns>\n\n**常見的 CPI/PCE 分歧模式**\n\n<pattern name=\"pce_higher_than_cpi\">\n**PCE > CPI 的情況**（較常見）\n\n可能原因：\n1. 醫療通膨走高（PCE 醫療權重更高）\n2. 住房通膨降溫（CPI 住房權重更高）\n3. 消費者支出移向通膨較高的桶位（PCE 動態權重）\n\n**交易含義**：Fed 看到的通膨比市場預期更頑固，鷹派機率上升。\n</pattern>\n\n<pattern name=\"cpi_higher_than_pce\">\n**CPI > PCE 的情況**（較少見）\n\n可能原因：\n1. 住房/租金通膨大幅走高\n2. 能源/食品價格衝擊\n3. 替代效應發生（消費者換購便宜商品）\n\n**交易含義**：市場可能高估通膨壓力，Fed 實際目標指標較低。\n</pattern>\n\n<pattern name=\"divergence_widening\">\n**分歧擴大中**\n\n需要關注：\n1. 哪些桶位在驅動分歧？\n2. 是暫時性還是結構性？\n3. Fed 會如何解讀？\n</pattern>\n\n</divergence_patterns>\n\n<fed_perspective>\n\n**Fed 如何看待 CPI/PCE 差異**\n\n1. **政策目標是 PCE**（具體是 Core PCE）\n   - Fed 的 2% 通膨目標是針對 PCE\n   - SEP (經濟預測摘要) 中的通膨預測是 PCE\n\n2. **但 Fed 也看 CPI**\n   - CPI 先於 PCE 公布（約早 2 週）\n   - 市場對 CPI 反應更大\n   - TIPS 盈虧平衡率基於 CPI\n\n3. **Fed 特別關注**\n   - **Core PCE**：排除波動的食品和能源\n   - **Supercore**：Core Services ex Housing（勞動密集服務）\n   - **Trimmed Mean PCE**（達拉斯 Fed 編製）\n\n**Powell 的常見說法**：\n> \"We look at a variety of measures... PCE is our target, but we also look at CPI, trimmed mean, and other measures.\"\n\n</fed_perspective>\n\n<trading_implications>\n\n**對交易的影響**\n\n<scenario name=\"cpi_release\">\n**CPI 公布日**\n\n- 市場反應：即時且大\n- 但需要注意：Fed 目標是 PCE\n- 交易策略：CPI 意外後，評估對 PCE 的含義\n</scenario>\n\n<scenario name=\"pce_release\">\n**PCE 公布日**\n\n- 市場反應：通常較小（因 CPI 已公布）\n- 但這是 Fed 的目標指標\n- 若 PCE 與 CPI 分歧擴大，可能影響 Fed 政策\n</scenario>\n\n<scenario name=\"divergence_trade\">\n**分歧交易機會**\n\n當 CPI 數據引發市場大幅反應，但你預期 PCE 將有不同訊號：\n1. 分析分歧來源（住房？醫療？權重？）\n2. 預測 PCE 數據\n3. 在 CPI 反應過度時逆向操作\n</scenario>\n\n</trading_implications>\n\n<historical_context>\n\n**歷史上的重大分歧**\n\n| 時期 | 分歧方向 | 主因 |\n|------|---------|------|\n| 2008-2009 | CPI > PCE | 能源價格衝擊 |\n| 2014-2015 | PCE > CPI | 醫療通膨走高 |\n| 2021-2022 | 混合 | 供應鏈衝擊 + 住房滯後 |\n| 2023-2024 | CPI > PCE | 住房通膨（OER）高位 |\n\n**2023-2024 的案例**：\n- CPI 中 OER 權重 ~26%，通膨 5-6%\n- PCE 中 OER 權重 ~12%\n- 結果：CPI 比 PCE 高約 0.3-0.5 個百分點\n- 市場一度過度悲觀（盯著 CPI）\n- Fed 持續強調「看 PCE」\n\n</historical_context>\n",
        "skills/us-cpi-pce-comparator/references/data-sources.md": "<overview>\n此參考文件列出 CPI-PCE 比較分析所需的資料來源、FRED 系列代碼，以及桶位對應關係。\n\n**重要更新**：經測試，FRED CSV endpoint 無需 API key 即可使用，BLS 公開 API 也可用。\n</overview>\n\n<data_access_methods>\n\n<method name=\"fred_csv\" recommended=\"true\">\n**FRED CSV Endpoint（推薦，無需 API key）**\n\n```\nhttps://fred.stlouisfed.org/graph/fredgraph.csv?id={SERIES_ID}\n```\n\n**參數**：\n- `id`: 系列代碼（如 CPIAUCSL）\n- `cosd`: 起始日期（可選，格式 YYYY-MM-DD）\n- `coed`: 結束日期（可選）\n\n**範例**：\n```\nhttps://fred.stlouisfed.org/graph/fredgraph.csv?id=CPIAUCSL&cosd=2020-01-01&coed=2024-12-01\n```\n\n**優點**：\n- 無需 API key\n- 直接返回 CSV\n- 無請求限制（合理使用）\n\n**腳本位置**: `scripts/fetch_fred_data.py`\n</method>\n\n<method name=\"bls_api\">\n**BLS Public Data API**\n\n```\nPOST https://api.bls.gov/publicAPI/v2/timeseries/data/\n```\n\n**限制**（無 API key）：\n- 每次最多 50 個系列\n- 每日 500 次請求\n- 歷史資料限 20 年\n\n**腳本位置**: `scripts/fetch_bls_data.py`\n</method>\n\n<method name=\"bea_api\" needs_key=\"true\">\n**BEA API（需要 API key）**\n\n若需要 BEA 細項資料，需申請免費 API key：\nhttps://apps.bea.gov/api/signup/\n\n**替代方案**：多數 BEA 資料已收錄於 FRED，可直接使用 FRED CSV。\n</method>\n\n</data_access_methods>\n\n<fred_series>\n\n<category name=\"Headline Indexes\">\n**主要通膨指數**\n\n| 別名 | Series ID | 描述 | 頻率 |\n|------|-----------|------|------|\n| `cpi_headline` | CPIAUCSL | CPI All Urban Consumers | 月 |\n| `pce_headline` | PCEPI | PCE Chain-type Price Index | 月 |\n</category>\n\n<category name=\"Core Indexes\">\n**核心通膨指數（排除食品和能源）**\n\n| 別名 | Series ID | 描述 | 頻率 |\n|------|-----------|------|------|\n| `cpi_core` | CPILFESL | CPI Less Food and Energy | 月 |\n| `pce_core` | PCEPILFE | PCE Excluding Food and Energy | 月 |\n</category>\n\n<category name=\"PCE Components\">\n**PCE 分項價格指數**\n\n| 別名 | Series ID | 描述 | Bucket Mapping |\n|------|-----------|------|----------------|\n| `pce_goods` | DGDSRG3M086SBEA | PCE: Goods | goods |\n| `pce_services` | DSERRG3M086SBEA | PCE: Services | services |\n| `pce_durable_goods` | DDURRG3M086SBEA | PCE: Durable Goods | durable_goods |\n| `pce_nondurable_goods` | DNDGRG3M086SBEA | PCE: Nondurable Goods | nondurable_goods |\n| `pce_housing` | DHUTRG3M086SBEA | PCE: Housing and Utilities | housing |\n| `pce_medical` | DHLCRG3M086SBEA | PCE: Health Care | medical |\n</category>\n\n<category name=\"CPI Components\">\n**CPI 分項**\n\n| 別名 | Series ID | 描述 | Bucket Mapping |\n|------|-----------|------|----------------|\n| `cpi_shelter` | CUSR0000SAH1 | CPI: Shelter | housing |\n| `cpi_medical` | CUSR0000SAM | CPI: Medical Care | medical |\n| `cpi_services` | CUSR0000SAS | CPI: Services | services |\n| `cpi_food` | CUSR0000SAF1 | CPI: Food | food |\n| `cpi_energy` | CUSR0000SA0E | CPI: Energy | energy |\n</category>\n\n<category name=\"PCE Nominal\">\n**PCE 名目值（用於計算動態權重）**\n\n| 別名 | Series ID | 描述 |\n|------|-----------|------|\n| `pce_nominal_total` | PCE | Personal Consumption Expenditures |\n| `pce_nominal_goods` | PCEDG | PCE: Goods |\n| `pce_nominal_services` | PCES | PCE: Services |\n</category>\n\n</fred_series>\n\n<bucket_definitions>\n\n<bucket name=\"core_goods\">\n**定義**：扣除食品和能源的商品\n\n**近似計算**：\n```python\n# 方案 A：使用 Goods - Food goods - Energy goods\ncore_goods ≈ pce_goods - food_goods - energy_goods\n\n# 方案 B：使用 Durable + Nondurable（粗粒度）\ncore_goods ≈ pce_durable_goods + pce_nondurable_goods\n```\n\n**注意**：FRED 無直接 Core Goods 單一序列\n</bucket>\n\n<bucket name=\"core_services_ex_housing\">\n**定義**：核心服務扣除住房（Fed 的 \"Supercore\"）\n\n**近似計算**：\n```python\ncore_services_ex_housing = pce_services - pce_housing\n```\n\n**重要性**：Fed 越來越關注此指標，因為它反映勞動成本傳導。\n</bucket>\n\n<bucket name=\"housing\">\n**定義**：住房相關消費\n\n**權重對比**：\n| | PCE | CPI |\n|---|-----|-----|\n| 住房權重 | ~15-18% | ~34% |\n| OER 權重 | ~12% | ~26% |\n\n**這是 CPI/PCE 分歧的重要來源。**\n</bucket>\n\n<bucket name=\"medical\">\n**定義**：醫療相關消費\n\n**Scope 差異**：\n- PCE 包含第三方支付（雇主、政府）\n- CPI 只計消費者直接支付\n- 結果：PCE 醫療權重 (~17%) > CPI 醫療權重 (~7%)\n</bucket>\n\n</bucket_definitions>\n\n<weight_sources>\n\n<source name=\"pce_dynamic_weights\">\n**PCE 動態權重計算**\n\n使用 FRED 名目支出資料計算：\n```python\n# 各桶占比\nweight[bucket] = nominal_pce[bucket] / nominal_pce['total']\n```\n\n**近似權重（2024 年）**：\n```python\nDEFAULT_PCE_WEIGHTS = {\n    'pce_goods': 0.31,\n    'pce_services': 0.69,\n    'pce_housing': 0.18,\n    'pce_medical': 0.17,\n}\n```\n</source>\n\n<source name=\"cpi_fixed_weights\">\n**CPI 固定權重**\n\nBLS 每年 12 月發布 \"Relative Importance\" 表。\n\n**近似權重（2024 年）**：\n```python\nDEFAULT_CPI_WEIGHTS = {\n    'cpi_shelter': 0.36,\n    'cpi_services': 0.62,\n    'cpi_medical': 0.07,\n    'cpi_food': 0.14,\n    'cpi_energy': 0.07,\n}\n```\n\n**注意**：CPI 權重更新較慢，這是與 PCE 的核心差異。\n</source>\n\n</weight_sources>\n\n<scripts_reference>\n\n**資料抓取腳本**\n\n| 腳本 | 功能 | 資料來源 |\n|------|------|---------|\n| `scripts/fetch_fred_data.py` | 抓取 FRED 資料 | FRED CSV (無需 API key) |\n| `scripts/fetch_bls_data.py` | 抓取 BLS 資料 | BLS Public API |\n| `scripts/cpi_pce_analyzer.py` | 完整分析 | 整合 FRED + BLS |\n\n**使用範例**：\n\n```bash\n# 快速檢查\npython scripts/cpi_pce_analyzer.py --quick\n\n# 完整分析\npython scripts/cpi_pce_analyzer.py --start 2020-01-01 --end 2024-12-01 --measure yoy\n\n# 含 baseline 調整\npython scripts/cpi_pce_analyzer.py --start 2016-01-01 --baseline 2018-10-01:2018-12-31\n```\n\n</scripts_reference>\n\n<update_schedule>\n\n**資料更新時程**\n\n| 資料 | 發布時間 | 延遲 |\n|------|---------|------|\n| CPI | 每月中旬 | 約 2 週 |\n| PCE | 每月底 | 約 4 週 |\n| PCE 權重 | 隨 PCE 發布 | 即時 |\n| CPI 權重 | 每年 12 月 | 年度 |\n\n**注意**：CPI 比 PCE 早約 2 週公布，市場通常對 CPI 反應更大。\n\n</update_schedule>\n",
        "skills/us-cpi-pce-comparator/references/implementation.md": "<overview>\n此參考文件包含 CPI-PCE 比較分析的核心計算公式與 Python 實作範例。\n</overview>\n\n<dependencies>\n```python\n# Required libraries\nimport pandas as pd\nimport numpy as np\nfrom fredapi import Fred\nfrom datetime import datetime, timedelta\nfrom typing import Dict, List, Optional, Literal\n```\n</dependencies>\n\n<inflation_calculations>\n\n<formula name=\"year_over_year\">\n**YoY 通膨率**\n\n$$\\pi_{yoy}(t) = \\left(\\frac{P_t}{P_{t-12}} - 1\\right) \\times 100$$\n\n```python\ndef calc_yoy(series: pd.Series) -> pd.Series:\n    \"\"\"Calculate year-over-year inflation rate.\"\"\"\n    return series.pct_change(12) * 100\n```\n</formula>\n\n<formula name=\"mom_saar\">\n**月增年化率 (MoM SAAR)**\n\n$$\\pi_{saar}(t) = \\left[\\left(1 + \\frac{P_t - P_{t-1}}{P_{t-1}}\\right)^{12} - 1\\right] \\times 100$$\n\n```python\ndef calc_mom_saar(series: pd.Series) -> pd.Series:\n    \"\"\"Calculate month-over-month seasonally adjusted annual rate.\"\"\"\n    mom = series.pct_change(1)\n    return ((1 + mom) ** 12 - 1) * 100\n```\n</formula>\n\n<formula name=\"qoq_saar\">\n**季增年化率 (QoQ SAAR)**\n\n$$\\pi_{qsaar}(t) = \\left[\\left(1 + \\frac{P_t - P_{t-3}}{P_{t-3}}\\right)^{4} - 1\\right] \\times 100$$\n\n```python\ndef calc_qoq_saar(series: pd.Series) -> pd.Series:\n    \"\"\"Calculate quarter-over-quarter seasonally adjusted annual rate.\"\"\"\n    qoq = series.pct_change(3)\n    return ((1 + qoq) ** 4 - 1) * 100\n```\n</formula>\n\n<unified_function>\n```python\ndef calc_inflation(\n    series: pd.Series,\n    measure: Literal[\"yoy\", \"mom_saar\", \"qoq_saar\"]\n) -> pd.Series:\n    \"\"\"\n    Calculate inflation rate based on specified measure.\n\n    Args:\n        series: Price index series\n        measure: One of \"yoy\", \"mom_saar\", \"qoq_saar\"\n\n    Returns:\n        Inflation rate series (in percentage points)\n    \"\"\"\n    if measure == \"yoy\":\n        return series.pct_change(12) * 100\n    elif measure == \"mom_saar\":\n        mom = series.pct_change(1)\n        return ((1 + mom) ** 12 - 1) * 100\n    elif measure == \"qoq_saar\":\n        qoq = series.pct_change(3)\n        return ((1 + qoq) ** 4 - 1) * 100\n    else:\n        raise ValueError(f\"Unsupported measure: {measure}\")\n```\n</unified_function>\n\n</inflation_calculations>\n\n<weighted_inflation>\n\n<formula name=\"pce_weighted\">\n**PCE 動態加權通膨**\n\n$$\\pi^{PCE}(t) = \\sum_b w_b^{PCE}(t) \\cdot \\pi_b(t)$$\n\n其中 $w_b^{PCE}(t)$ 是 bucket $b$ 在時間 $t$ 的 PCE 支出占比。\n</formula>\n\n<formula name=\"fixed_weighted\">\n**固定權重加權通膨（CPI-style proxy）**\n\n$$\\pi^{FIX}(t) = \\sum_b w_b^{FIX} \\cdot \\pi_b(t)$$\n\n其中 $w_b^{FIX}$ 是固定在某基準期的權重。\n</formula>\n\n<formula name=\"divergence\">\n**分歧計算**\n\n$$\\Delta_{bps}(t) = \\left(\\pi^{PCE}(t) - \\pi^{FIX}(t)\\right) \\times 100$$\n</formula>\n\n<implementation>\n```python\ndef calc_weighted_inflation(\n    pi_buckets: Dict[str, pd.Series],\n    weights: Dict[str, pd.Series],\n    focus_buckets: List[str]\n) -> pd.Series:\n    \"\"\"\n    Calculate weighted inflation across buckets.\n\n    Args:\n        pi_buckets: Dict mapping bucket name to inflation series\n        weights: Dict mapping bucket name to weight series\n        focus_buckets: List of bucket names to include\n\n    Returns:\n        Weighted inflation series\n    \"\"\"\n    result = pd.Series(0.0, index=pi_buckets[focus_buckets[0]].index)\n\n    for bucket in focus_buckets:\n        if bucket in pi_buckets and bucket in weights:\n            # Align weights to inflation index\n            w = weights[bucket].reindex(result.index, method='ffill')\n            result += w * pi_buckets[bucket]\n\n    return result\n```\n</implementation>\n\n</weighted_inflation>\n\n<weight_effect_proxy>\n\n<formula name=\"weight_effect\">\n**權重效應近似**\n\n$$\\Delta_{weight}(t) = \\sum_b \\left(w_b^{PCE}(t) - w_b^{FIX}\\right) \\cdot \\pi_b(t)$$\n\n這量化了「因為 PCE 使用動態權重，而 CPI 使用固定權重」所造成的通膨差異。\n</formula>\n\n<implementation>\n```python\ndef calc_weight_effect(\n    pi_buckets: Dict[str, pd.Series],\n    w_pce: Dict[str, pd.Series],\n    w_fix: Dict[str, float],\n    focus_buckets: List[str]\n) -> pd.Series:\n    \"\"\"\n    Calculate weight effect proxy.\n\n    This measures how much of the CPI-PCE divergence\n    is attributable to weight differences.\n    \"\"\"\n    result = pd.Series(0.0, index=pi_buckets[focus_buckets[0]].index)\n\n    for bucket in focus_buckets:\n        w_pce_aligned = w_pce[bucket].reindex(result.index, method='ffill')\n        delta_w = w_pce_aligned - w_fix[bucket]\n        result += delta_w * pi_buckets[bucket]\n\n    return result * 100  # Convert to bps\n```\n</implementation>\n\n</weight_effect_proxy>\n\n<volatility_analysis>\n\n<formula name=\"rolling_volatility\">\n**滾動波動度**\n\n$$\\sigma_b(t) = \\text{std}\\left(\\pi_b(t-n+1), \\ldots, \\pi_b(t)\\right)$$\n\n其中 $n$ 是視窗大小（月數）。\n</formula>\n\n<implementation>\n```python\ndef calc_rolling_volatility(\n    series: pd.Series,\n    window: int = 24\n) -> pd.Series:\n    \"\"\"\n    Calculate rolling standard deviation of inflation.\n\n    Args:\n        series: Inflation rate series\n        window: Rolling window in months\n\n    Returns:\n        Rolling volatility series\n    \"\"\"\n    return series.rolling(window).std()\n\n\ndef identify_low_vol_high_weight_buckets(\n    pi_buckets: Dict[str, pd.Series],\n    weights: Dict[str, pd.Series],\n    vol_window: int = 24,\n    vol_quantile: float = 0.4\n) -> List[str]:\n    \"\"\"\n    Identify buckets with low volatility and high weight.\n\n    These are the buckets that, if they re-accelerate,\n    would push PCE higher even if CPI looks calm.\n    \"\"\"\n    # Calculate latest volatility and weight for each bucket\n    vol = {\n        b: calc_rolling_volatility(pi_buckets[b], vol_window).iloc[-1]\n        for b in pi_buckets\n    }\n    latest_w = {\n        b: weights[b].iloc[-1]\n        for b in weights\n    }\n\n    # Determine thresholds\n    vol_threshold = np.quantile(list(vol.values()), vol_quantile)\n    weight_median = np.median(list(latest_w.values()))\n\n    # Filter: low vol AND high weight\n    candidates = [\n        b for b in pi_buckets\n        if vol[b] <= vol_threshold and latest_w[b] > weight_median\n    ]\n\n    # Sort by (low vol, high weight)\n    candidates.sort(key=lambda b: (vol[b], -latest_w[b]))\n\n    return candidates\n```\n</implementation>\n\n</volatility_analysis>\n\n<baseline_adjustment>\n\n<formula name=\"subtract_mean\">\n**減去基準期平均**\n\n$$\\pi_b^{adj}(t) = \\pi_b(t) - \\bar{\\pi}_b(\\text{baseline})$$\n\n其中 $\\bar{\\pi}_b(\\text{baseline})$ 是基準期內的平均通膨率。\n</formula>\n\n<formula name=\"subtract_end\">\n**減去基準期末值**\n\n$$\\pi_b^{adj}(t) = \\pi_b(t) - \\pi_b(t_{\\text{end}})$$\n\n其中 $t_{\\text{end}}$ 是基準期的最後一天。\n</formula>\n\n<implementation>\n```python\ndef apply_baseline_adjustment(\n    series: pd.Series,\n    baseline_start: str,\n    baseline_end: str,\n    mode: Literal[\"subtract_mean\", \"subtract_end\"] = \"subtract_mean\"\n) -> pd.Series:\n    \"\"\"\n    Adjust inflation series relative to a baseline period.\n\n    Args:\n        series: Inflation series\n        baseline_start: Start of baseline period (YYYY-MM-DD)\n        baseline_end: End of baseline period (YYYY-MM-DD)\n        mode: \"subtract_mean\" or \"subtract_end\"\n\n    Returns:\n        Adjusted inflation series\n    \"\"\"\n    mask = (series.index >= baseline_start) & (series.index <= baseline_end)\n    baseline_data = series[mask]\n\n    if mode == \"subtract_mean\":\n        baseline_level = baseline_data.mean()\n    else:  # subtract_end\n        baseline_level = baseline_data.iloc[-1]\n\n    return series - baseline_level\n```\n</implementation>\n\n</baseline_adjustment>\n\n<contribution_analysis>\n\n<formula name=\"weighted_contribution\">\n**加權通膨貢獻**\n\n$$C_b(t) = w_b(t) \\cdot \\pi_b(t)$$\n\n這表示 bucket $b$ 對總體通膨的貢獻（以百分點計）。\n</formula>\n\n<implementation>\n```python\ndef calc_contributions(\n    pi_buckets: Dict[str, pd.Series],\n    weights: Dict[str, pd.Series],\n    focus_buckets: List[str]\n) -> Dict[str, float]:\n    \"\"\"\n    Calculate weighted inflation contribution for each bucket.\n\n    Returns the latest contribution value for each bucket.\n    \"\"\"\n    contributions = {}\n\n    for bucket in focus_buckets:\n        if bucket in pi_buckets and bucket in weights:\n            w = weights[bucket].iloc[-1]\n            pi = pi_buckets[bucket].iloc[-1]\n            contributions[bucket] = w * pi\n\n    return contributions\n\n\ndef get_top_contributors(\n    contributions: Dict[str, float],\n    n: int = 5\n) -> List[tuple]:\n    \"\"\"Get top N contributors by absolute contribution.\"\"\"\n    return sorted(\n        contributions.items(),\n        key=lambda kv: abs(kv[1]),\n        reverse=True\n    )[:n]\n```\n</implementation>\n\n</contribution_analysis>\n\n<signal_detection>\n\n<implementation>\n```python\ndef detect_upside_signals(\n    pi_buckets: Dict[str, pd.Series],\n    pi_adjusted: Dict[str, pd.Series],\n    low_vol_high_weight: List[str],\n    threshold_bps: float = 50\n) -> List[dict]:\n    \"\"\"\n    Detect PCE upside risk signals in low-vol high-weight buckets.\n\n    Args:\n        pi_buckets: Original inflation series\n        pi_adjusted: Baseline-adjusted inflation series\n        low_vol_high_weight: List of identified buckets\n        threshold_bps: Meaningful upside threshold in bps\n\n    Returns:\n        List of signal dictionaries\n    \"\"\"\n    signals = []\n\n    for bucket in low_vol_high_weight:\n        latest = pi_buckets[bucket].iloc[-1]\n        prev_3m = pi_buckets[bucket].iloc[-4] if len(pi_buckets[bucket]) > 3 else None\n        momentum_3m = latest - prev_3m if prev_3m else None\n\n        # Check baseline deviation\n        if bucket in pi_adjusted:\n            deviation = pi_adjusted[bucket].iloc[-1]\n            if deviation > threshold_bps / 100:\n                signals.append({\n                    'bucket': bucket,\n                    'signal': 'upside',\n                    'deviation_pct': deviation,\n                    'deviation_bps': deviation * 100,\n                    'momentum_3m': momentum_3m,\n                    'latest_inflation': latest\n                })\n        elif momentum_3m and momentum_3m > 0:\n            # Fallback: use momentum if no baseline\n            signals.append({\n                'bucket': bucket,\n                'signal': 'accelerating',\n                'momentum_3m': momentum_3m,\n                'latest_inflation': latest\n            })\n\n    return signals\n```\n</implementation>\n\n</signal_detection>\n\n<full_analysis_class>\n\n```python\nclass CPIPCEComparator:\n    \"\"\"\n    CPI-PCE Comparator for analyzing inflation divergence.\n    \"\"\"\n\n    def __init__(self, fred_api_key: str):\n        self.fred = Fred(api_key=fred_api_key)\n\n    def fetch_data(\n        self,\n        start_date: str,\n        end_date: str,\n        price_indexes: dict,\n        focus_buckets: List[str]\n    ) -> dict:\n        \"\"\"Fetch all required data from FRED.\"\"\"\n        data = {}\n\n        # Headline indexes\n        data['cpi'] = self.fred.get_series(\n            price_indexes['cpi_series'], start_date, end_date\n        )\n        data['pce'] = self.fred.get_series(\n            price_indexes['pce_series'], start_date, end_date\n        )\n\n        if 'pce_core_series' in price_indexes:\n            data['pce_core'] = self.fred.get_series(\n                price_indexes['pce_core_series'], start_date, end_date\n            )\n\n        # Bucket series (implement based on bucket definitions)\n        # data['buckets'] = self._fetch_bucket_series(focus_buckets, ...)\n\n        return data\n\n    def analyze(\n        self,\n        start_date: str,\n        end_date: str,\n        inflation_measure: str,\n        price_indexes: dict,\n        focus_buckets: List[str],\n        weight_source: str,\n        baseline_period: Optional[dict] = None,\n        vol_window_months: int = 24,\n        signal_thresholds: Optional[dict] = None\n    ) -> dict:\n        \"\"\"Run full CPI-PCE comparison analysis.\"\"\"\n\n        # 1. Fetch data\n        data = self.fetch_data(start_date, end_date, price_indexes, focus_buckets)\n\n        # 2. Calculate inflation\n        pi_cpi = calc_inflation(data['cpi'], inflation_measure)\n        pi_pce = calc_inflation(data['pce'], inflation_measure)\n\n        # 3. Calculate bucket-level inflation\n        pi_buckets = {\n            b: calc_inflation(data['buckets'][b], inflation_measure)\n            for b in focus_buckets\n        }\n\n        # 4. Load weights\n        weights = self._load_weights(weight_source, focus_buckets)\n\n        # 5. Calculate weighted inflation and divergence\n        pi_pce_weighted = calc_weighted_inflation(pi_buckets, weights, focus_buckets)\n        # ... (continue with full analysis)\n\n        return output\n```\n\n</full_analysis_class>\n\n<error_handling>\n\n```python\nimport time\nfrom functools import wraps\n\ndef retry_with_backoff(max_retries: int = 3, base_delay: float = 1.0):\n    \"\"\"Decorator for retrying API calls with exponential backoff.\"\"\"\n    def decorator(func):\n        @wraps(func)\n        def wrapper(*args, **kwargs):\n            for attempt in range(max_retries):\n                try:\n                    return func(*args, **kwargs)\n                except Exception as e:\n                    if attempt == max_retries - 1:\n                        raise\n                    delay = base_delay * (2 ** attempt)\n                    time.sleep(delay)\n        return wrapper\n    return decorator\n\n\n@retry_with_backoff(max_retries=3)\ndef fetch_fred_series(fred: Fred, series_id: str, start: str, end: str):\n    \"\"\"Fetch FRED series with retry logic.\"\"\"\n    return fred.get_series(series_id, start, end)\n```\n\n</error_handling>\n",
        "skills/us-cpi-pce-comparator/templates/output-json.md": "<template_description>\nCPI-PCE 比較分析的 JSON 輸出模板。\n此模板定義完整分析結果的結構。\n</template_description>\n\n<json_schema>\n```json\n{\n  \"metadata\": {\n    \"analysis_time\": \"ISO 8601 timestamp\",\n    \"start_date\": \"YYYY-MM-DD\",\n    \"end_date\": \"YYYY-MM-DD\",\n    \"measure\": \"yoy | mom_saar | qoq_saar\",\n    \"as_of_date\": \"YYYY-MM-DD (資料最新日期)\"\n  },\n\n  \"headline\": {\n    \"cpi_headline\": \"number (CPI YoY %)\",\n    \"pce_headline\": \"number (PCE YoY %)\",\n    \"headline_gap_bps\": \"number (PCE - CPI in bps)\",\n    \"cpi_core\": \"number (Core CPI YoY %)\",\n    \"pce_core\": \"number (Core PCE YoY %)\",\n    \"core_gap_bps\": \"number (Core PCE - Core CPI in bps)\"\n  },\n\n  \"low_vol_high_weight_buckets\": [\n    {\n      \"bucket\": \"string (桶位名稱)\",\n      \"volatility\": \"number (24M 標準差)\",\n      \"weight\": \"number (PCE 權重)\",\n      \"latest_inflation\": \"number (最新通膨率)\",\n      \"momentum_3m\": \"number (3M 動能)\",\n      \"signal\": \"upside | neutral | downside\"\n    }\n  ],\n\n  \"attribution\": {\n    \"top_contributors\": [\n      {\n        \"bucket\": \"string\",\n        \"weight\": \"number\",\n        \"inflation\": \"number\",\n        \"contribution\": \"number (weight * inflation)\"\n      }\n    ],\n    \"weight_effect_bps\": \"number (權重效應 in bps)\"\n  },\n\n  \"baseline_adjustment\": {\n    \"baseline_range\": \"string (e.g., 2018-10-01:2018-12-31)\",\n    \"mode\": \"subtract_mean | subtract_end\",\n    \"latest_deviation\": \"number (最新偏離度)\"\n  },\n\n  \"interpretation\": [\n    \"string (解讀文字 1)\",\n    \"string (解讀文字 2)\"\n  ],\n\n  \"caveats\": [\n    \"string (注意事項 1)\",\n    \"string (注意事項 2)\"\n  ]\n}\n```\n</json_schema>\n\n<example_output>\n```json\n{\n  \"metadata\": {\n    \"analysis_time\": \"2026-01-14T16:57:00.000Z\",\n    \"start_date\": \"2020-01-01\",\n    \"end_date\": \"2026-01-01\",\n    \"measure\": \"yoy\",\n    \"as_of_date\": \"2025-12-01\"\n  },\n  \"headline\": {\n    \"cpi_headline\": 2.65,\n    \"pce_headline\": 2.79,\n    \"headline_gap_bps\": 14,\n    \"cpi_core\": 2.65,\n    \"pce_core\": 2.83,\n    \"core_gap_bps\": 18\n  },\n  \"low_vol_high_weight_buckets\": [\n    {\n      \"bucket\": \"pce_services\",\n      \"volatility\": 0.42,\n      \"weight\": 0.69,\n      \"latest_inflation\": 3.21,\n      \"momentum_3m\": 0.15,\n      \"signal\": \"upside\"\n    },\n    {\n      \"bucket\": \"pce_housing\",\n      \"volatility\": 0.38,\n      \"weight\": 0.18,\n      \"latest_inflation\": 4.85,\n      \"momentum_3m\": -0.22,\n      \"signal\": \"neutral\"\n    }\n  ],\n  \"attribution\": {\n    \"top_contributors\": [\n      {\"bucket\": \"pce_services\", \"weight\": 0.69, \"inflation\": 3.21, \"contribution\": 2.21},\n      {\"bucket\": \"pce_goods\", \"weight\": 0.31, \"inflation\": 0.58, \"contribution\": 0.18}\n    ],\n    \"weight_effect_bps\": 12\n  },\n  \"baseline_adjustment\": {\n    \"baseline_range\": \"2018-10-01:2018-12-31\",\n    \"mode\": \"subtract_mean\",\n    \"latest_deviation\": 0.45\n  },\n  \"interpretation\": [\n    \"PCE 通膨高於 CPI 約 14 bps，Fed 關注的通膨指標比 CPI 更具黏性。\",\n    \"低波動高權重桶位 (pce_services) 顯示上行訊號，若趨勢延續將推升 PCE。\",\n    \"監控重點：core_goods 和 core_services_ex_housing 的 3M 動能 vs 12M 趨勢。\"\n  ],\n  \"caveats\": [\n    \"權重為近似值，基於 BEA/BLS 2024 年數據\",\n    \"部分桶位對應可能有誤差\",\n    \"此為權重效應的工程近似，非完整 BEA/BLS 方法論調和\"\n  ]\n}\n```\n</example_output>\n\n<field_descriptions>\n\n<field name=\"metadata\">\n分析元資料，包含時間範圍和計算方式。\n</field>\n\n<field name=\"headline\">\nHeadline level 的通膨數據與分歧。\n- `headline_gap_bps`: PCE - CPI 的差距（正數表示 PCE 較高）\n- `core_gap_bps`: Core PCE - Core CPI 的差距\n</field>\n\n<field name=\"low_vol_high_weight_buckets\">\n識別出的低波動高權重桶位列表。這些是 PCE 上行風險的關鍵監控點。\n- `signal: upside` 表示 3M 動能為正，有上行風險\n- `signal: neutral` 表示無明顯方向\n</field>\n\n<field name=\"attribution\">\n各桶位對總體通膨的貢獻分析。\n- `contribution = weight × inflation`\n- `weight_effect_bps`: 因 PCE/CPI 權重差異造成的分歧\n</field>\n\n<field name=\"baseline_adjustment\">\n相對於歷史基準期的偏離度。若 `latest_deviation > 0`，表示當前通膨高於歷史常態。\n</field>\n\n<field name=\"interpretation\">\n可操作的解讀文字，適合直接用於報告或交易筆記。\n</field>\n\n<field name=\"caveats\">\n分析的限制與注意事項，務必閱讀。\n</field>\n\n</field_descriptions>\n",
        "skills/us-cpi-pce-comparator/templates/output-markdown.md": "<template_description>\nCPI-PCE 比較分析的 Markdown 報告模板。\n適合用於研究報告、交易筆記或團隊分享。\n</template_description>\n\n<markdown_template>\n```markdown\n# CPI-PCE 通膨分歧分析報告\n\n**分析日期**: {{analysis_time}}\n**資料期間**: {{start_date}} 至 {{end_date}}\n**計算方式**: {{measure_description}}\n**資料截至**: {{as_of_date}}\n\n---\n\n## 摘要\n\n| 指標 | CPI | PCE | 分歧 (bps) |\n|------|-----|-----|-----------|\n| Headline | {{cpi_headline}}% | {{pce_headline}}% | {{headline_gap_bps}} |\n| Core | {{cpi_core}}% | {{pce_core}}% | {{core_gap_bps}} |\n\n**結論**: {{headline_summary}}\n\n---\n\n## 低波動高權重桶位分析\n\n這些桶位在 PCE 中權重較高，且價格波動相對穩定。若這些桶位的通膨走高，將顯著推升 Fed 關注的 PCE 指標。\n\n| 桶位 | PCE 權重 | 波動度 (24M) | 最新通膨 | 3M 動能 | 訊號 |\n|------|---------|-------------|---------|--------|------|\n{{#low_vol_buckets}}\n| {{bucket}} | {{weight}} | {{volatility}} | {{latest_inflation}}% | {{momentum_3m}} | {{signal_emoji}} {{signal}} |\n{{/low_vol_buckets}}\n\n### 關鍵觀察\n\n{{low_vol_interpretation}}\n\n---\n\n## 通膨貢獻分解\n\n各消費桶位對 PCE 通膨的貢獻：\n\n| 桶位 | 權重 | 通膨率 | 加權貢獻 |\n|------|------|-------|---------|\n{{#top_contributors}}\n| {{bucket}} | {{weight}} | {{inflation}}% | {{contribution}} |\n{{/top_contributors}}\n\n**權重效應**: {{weight_effect_bps}} bps\n\n> 權重效應說明：因 PCE 使用動態權重、CPI 使用固定權重，同樣的分項通膨會產生不同的加總結果。\n\n---\n\n## Baseline 偏離度分析\n\n{{#baseline_adjustment}}\n**基準期**: {{baseline_range}}\n**調整方式**: {{mode_description}}\n**最新偏離**: {{latest_deviation}} 個百分點\n\n{{baseline_interpretation}}\n{{/baseline_adjustment}}\n\n{{^baseline_adjustment}}\n*本次分析未設定 baseline 基準期*\n{{/baseline_adjustment}}\n\n---\n\n## 解讀與建議\n\n{{#interpretation}}\n- {{.}}\n{{/interpretation}}\n\n### 監控重點\n\n1. **短期動能**: 觀察 3M SAAR 是否加速\n2. **桶位動態**: 低波動高權重桶位的走勢\n3. **權重變化**: PCE 權重是否向通膨較高的桶位移動\n\n---\n\n## 注意事項\n\n{{#caveats}}\n- ⚠️ {{.}}\n{{/caveats}}\n\n---\n\n*此報告由 CPI-PCE Comparator Skill 自動生成*\n*資料來源: FRED (St. Louis Fed), BLS*\n```\n</markdown_template>\n\n<variable_definitions>\n\n| 變數 | 說明 | 範例 |\n|------|------|------|\n| `{{analysis_time}}` | 分析執行時間 | 2026-01-14 16:57 |\n| `{{start_date}}` | 分析起始日 | 2020-01-01 |\n| `{{end_date}}` | 分析結束日 | 2026-01-01 |\n| `{{measure_description}}` | 計算方式描述 | 年增率 (YoY) |\n| `{{as_of_date}}` | 資料最新日期 | 2025-12-01 |\n| `{{cpi_headline}}` | CPI Headline 通膨 | 2.65 |\n| `{{pce_headline}}` | PCE Headline 通膨 | 2.79 |\n| `{{headline_gap_bps}}` | Headline 分歧 | +14 |\n| `{{cpi_core}}` | Core CPI 通膨 | 2.65 |\n| `{{pce_core}}` | Core PCE 通膨 | 2.83 |\n| `{{core_gap_bps}}` | Core 分歧 | +18 |\n| `{{headline_summary}}` | Headline 結論 | PCE 高於 CPI... |\n| `{{signal_emoji}}` | 訊號符號 | 🔺 / ⚪ / 🔻 |\n\n</variable_definitions>\n\n<signal_emoji_mapping>\n- `upside` → 🔺 (上行風險)\n- `neutral` → ⚪ (中性)\n- `downside` → 🔻 (下行風險)\n</signal_emoji_mapping>\n\n<measure_descriptions>\n- `yoy` → 年增率 (Year-over-Year)\n- `mom_saar` → 月增年化率 (MoM SAAR)\n- `qoq_saar` → 季增年化率 (QoQ SAAR)\n</measure_descriptions>\n\n<example_filled_report>\n```markdown\n# CPI-PCE 通膨分歧分析報告\n\n**分析日期**: 2026-01-14 16:57\n**資料期間**: 2020-01-01 至 2026-01-01\n**計算方式**: 年增率 (YoY)\n**資料截至**: 2025-12-01\n\n---\n\n## 摘要\n\n| 指標 | CPI | PCE | 分歧 (bps) |\n|------|-----|-----|-----------|\n| Headline | 2.65% | 2.79% | +14 |\n| Core | 2.65% | 2.83% | +18 |\n\n**結論**: PCE 通膨持續高於 CPI，Fed 關注的通膨指標比市場常看的 CPI 更具黏性。\n\n---\n\n## 低波動高權重桶位分析\n\n| 桶位 | PCE 權重 | 波動度 (24M) | 最新通膨 | 3M 動能 | 訊號 |\n|------|---------|-------------|---------|--------|------|\n| pce_services | 0.69 | 0.42 | 3.21% | +0.15 | 🔺 upside |\n| pce_housing | 0.18 | 0.38 | 4.85% | -0.22 | ⚪ neutral |\n\n### 關鍵觀察\n\nServices 桶位（PCE 權重 69%）顯示上行動能，若趨勢延續將對 PCE 造成上行壓力。Housing 通膨雖高但動能已轉弱。\n\n---\n\n## 解讀與建議\n\n- PCE 通膨高於 CPI 約 14 bps，Fed 關注的通膨指標比 CPI 更具黏性。\n- 低波動高權重桶位 (pce_services) 顯示上行訊號，若趨勢延續將推升 PCE。\n- 監控重點：core_goods 和 core_services_ex_housing 的 3M 動能 vs 12M 趨勢。\n\n---\n\n## 注意事項\n\n- ⚠️ 權重為近似值，基於 BEA/BLS 2024 年數據\n- ⚠️ 部分桶位對應可能有誤差\n- ⚠️ 此為權重效應的工程近似，非完整 BEA/BLS 方法論調和\n\n---\n\n*此報告由 CPI-PCE Comparator Skill 自動生成*\n*資料來源: FRED (St. Louis Fed), BLS*\n```\n</example_filled_report>\n",
        "skills/us-cpi-pce-comparator/workflows/analyze.md": "<required_reading>\n**執行此 workflow 前，先閱讀：**\n1. references/data-sources.md - 資料來源與 FRED 系列代碼\n2. references/cpi-pce-methodology.md - CPI/PCE 方法論差異\n</required_reading>\n\n<objective>\n執行完整的 CPI-PCE 比較分析，產出三層訊號：Headline 分歧、桶位歸因、風險框架。\n</objective>\n\n<process>\n\n<step number=\"1\" name=\"執行分析腳本\">\n\n**使用 Python 腳本執行分析**\n\n```bash\n# 進入 skill 目錄\ncd skills/us-cpi-pce-comparator\n\n# 安裝依賴（首次使用）\npip install pandas numpy requests\n\n# 執行完整分析\npython scripts/cpi_pce_analyzer.py \\\n  --start {START_DATE} \\\n  --end {END_DATE} \\\n  --measure {MEASURE} \\\n  --output analysis_result.json\n```\n\n**參數說明**：\n- `--start`: 起始日期 (YYYY-MM-DD)\n- `--end`: 結束日期 (YYYY-MM-DD)\n- `--measure`: 計算方式 (`yoy` | `mom_saar` | `qoq_saar`)\n- `--baseline`: 基準期 (可選，如 `2018-10-01:2018-12-31`)\n- `--cache-dir`: 快取目錄 (可選，加速重複分析)\n\n**範例**：\n```bash\n# YoY 分析，2020 年至今\npython scripts/cpi_pce_analyzer.py --start 2020-01-01 --measure yoy\n\n# 含 baseline 調整\npython scripts/cpi_pce_analyzer.py --start 2016-01-01 --baseline 2018-10-01:2018-12-31\n\n# 使用快取加速\npython scripts/cpi_pce_analyzer.py --start 2020-01-01 --cache-dir ./cache\n```\n\n</step>\n\n<step number=\"2\" name=\"解讀分析結果\">\n\n**檢查輸出的 JSON 結構**\n\n```python\nimport json\nwith open('analysis_result.json', 'r') as f:\n    result = json.load(f)\n\n# 1. Headline 分歧\nprint(f\"CPI YoY: {result['headline']['cpi_headline']}%\")\nprint(f\"PCE YoY: {result['headline']['pce_headline']}%\")\nprint(f\"分歧: {result['headline']['headline_gap_bps']} bps\")\n\n# 2. 低波動高權重桶位\nfor bucket in result['low_vol_high_weight_buckets']:\n    print(f\"{bucket['bucket']}: signal={bucket['signal']}, momentum={bucket['momentum_3m']}\")\n\n# 3. 歸因\nfor contrib in result['attribution']['top_contributors']:\n    print(f\"{contrib['bucket']}: {contrib['contribution']}\")\n```\n\n</step>\n\n<step number=\"3\" name=\"生成報告（可選）\">\n\n**使用模板生成 Markdown 報告**\n\n參考 `templates/output-markdown.md` 的模板結構，將 JSON 結果轉換為可讀報告。\n\n```python\n# 簡易報告生成\nresult = json.load(open('analysis_result.json'))\n\nreport = f\"\"\"\n# CPI-PCE 分析報告\n\n## 摘要\n- CPI: {result['headline']['cpi_headline']}%\n- PCE: {result['headline']['pce_headline']}%\n- 分歧: {result['headline']['headline_gap_bps']} bps\n\n## 解讀\n{chr(10).join('- ' + i for i in result['interpretation'])}\n\n## 注意事項\n{chr(10).join('- ' + c for c in result['caveats'])}\n\"\"\"\nprint(report)\n```\n\n</step>\n\n<step number=\"4\" name=\"驗證與交叉檢查\">\n\n**驗證步驟**：\n\n1. **數據一致性檢查**\n   - 比對 FRED 網站的最新數據\n   - 確認日期範圍正確\n\n2. **計算邏輯檢查**\n   - YoY: `(current / year_ago - 1) * 100`\n   - 確認無異常跳躍\n\n3. **權重合理性檢查**\n   - PCE 權重總和應接近 1\n   - 與 BEA 公布值比對\n\n</step>\n\n</process>\n\n<alternative_approach>\n\n**若腳本無法執行，可手動分析**\n\n1. **手動下載資料**\n   ```\n   https://fred.stlouisfed.org/graph/fredgraph.csv?id=CPIAUCSL\n   https://fred.stlouisfed.org/graph/fredgraph.csv?id=PCEPI\n   ```\n\n2. **在 Excel/Google Sheets 中計算**\n   - YoY: `=(current/OFFSET(current,-12,0)-1)*100`\n   - Gap: `=PCE_YoY - CPI_YoY`\n\n3. **參考 references/implementation.md 中的公式**\n\n</alternative_approach>\n\n<troubleshooting>\n\n**常見問題**\n\n<issue name=\"module_not_found\">\n**錯誤**: `ModuleNotFoundError: No module named 'pandas'`\n\n**解決**:\n```bash\npip install pandas numpy requests\n```\n</issue>\n\n<issue name=\"connection_error\">\n**錯誤**: `ConnectionError` 或 `Timeout`\n\n**解決**:\n- 檢查網路連線\n- 重試幾次\n- 使用 `--cache-dir` 啟用快取\n</issue>\n\n<issue name=\"empty_data\">\n**錯誤**: 部分序列無資料\n\n**原因**: 某些 FRED 序列可能有延遲或不存在\n\n**解決**:\n- 檢查 `data-sources.md` 中的系列代碼\n- 使用備用序列\n</issue>\n\n</troubleshooting>\n\n<success_criteria>\n此 workflow 完成時應確認：\n\n- [ ] 成功執行分析腳本\n- [ ] 輸出包含 headline 分歧數據\n- [ ] 識別出低波動高權重桶位\n- [ ] 計算出各桶位貢獻\n- [ ] 若有 baseline_period，產出偏離度\n- [ ] 輸出包含可操作的解讀\n- [ ] 明確標註資料限制\n</success_criteria>\n",
        "skills/us-cpi-pce-comparator/workflows/quick-check.md": "<required_reading>\n**執行此 workflow 前，可選擇閱讀：**\n1. references/data-sources.md - 了解資料來源\n</required_reading>\n\n<objective>\n快速檢查最新的 CPI/PCE 分歧，適合日常監控或快速回答「現在 CPI/PCE 差多少？」\n</objective>\n\n<process>\n\n<step number=\"1\" name=\"執行快速檢查\">\n\n**最簡單的方式**\n\n```bash\ncd skills/us-cpi-pce-comparator\npython scripts/cpi_pce_analyzer.py --quick\n```\n\n這會輸出：\n```json\n{\n  \"as_of\": \"2026-01-14\",\n  \"headline\": {\n    \"cpi_yoy\": 2.65,\n    \"pce_yoy\": 2.79,\n    \"gap_bps\": 14\n  },\n  \"core\": {\n    \"cpi_core_yoy\": 2.65,\n    \"pce_core_yoy\": 2.83,\n    \"gap_bps\": 18\n  },\n  \"momentum\": {\n    \"cpi_3m_saar\": 2.07,\n    \"pce_3m_saar\": 2.82,\n    \"momentum_divergence\": 0.75\n  }\n}\n```\n\n</step>\n\n<step number=\"2\" name=\"解讀結果\">\n\n**關鍵指標解讀**\n\n| 指標 | 含義 |\n|------|------|\n| `headline.gap_bps > 0` | PCE 高於 CPI，Fed 目標指標更具黏性 |\n| `headline.gap_bps < 0` | PCE 低於 CPI，罕見 |\n| `core.gap_bps` | Core 分歧，排除食品能源波動 |\n| `momentum_divergence > 0` | PCE 短期動能更強 |\n\n**快速結論模板**：\n\n```\n當前 CPI/PCE 分歧：{gap_bps} bps\n\n解讀：\n- PCE {'高於' if gap > 0 else '低於'} CPI\n- {'Fed 目標指標更頑固，鷹派風險' if gap > 0 else '市場可能高估通膨壓力'}\n- 3M 動能：{'PCE 加速更快' if momentum > 0 else 'CPI 加速更快'}\n```\n\n</step>\n\n<step number=\"3\" name=\"（可選）手動檢查\">\n\n**若不想執行腳本，可直接查看 FRED**\n\n1. 打開瀏覽器訪問：\n   - CPI: https://fred.stlouisfed.org/series/CPIAUCSL\n   - PCE: https://fred.stlouisfed.org/series/PCEPI\n   - Core CPI: https://fred.stlouisfed.org/series/CPILFESL\n   - Core PCE: https://fred.stlouisfed.org/series/PCEPILFE\n\n2. 查看「Percent Change from Year Ago」選項\n\n3. 手動計算 gap = PCE - CPI\n\n</step>\n\n</process>\n\n<quick_interpretation_guide>\n\n**快速解讀指南**\n\n| 情境 | 分歧 | 含義 |\n|------|------|------|\n| 常態 | PCE > CPI 10-30 bps | 正常範圍 |\n| 分歧擴大 | PCE > CPI > 30 bps | 醫療或權重效應推升 PCE |\n| 分歧縮小 | PCE ≈ CPI | 兩指標訊號趨於一致 |\n| 反轉 | CPI > PCE | 住房或能源價格衝擊 |\n\n**動能解讀**\n\n| momentum_divergence | 含義 |\n|---------------------|------|\n| > 0.5 | PCE 短期加速明顯，關注上行風險 |\n| -0.5 ~ 0.5 | 兩指標動能相近 |\n| < -0.5 | CPI 短期加速更快，可能是住房驅動 |\n\n</quick_interpretation_guide>\n\n<success_criteria>\n快速檢查完成時應輸出：\n\n- [ ] 最新 CPI 和 PCE 的 YoY 數值\n- [ ] Core CPI 和 Core PCE 的 YoY 數值\n- [ ] Headline 和 Core 的 gap（bps）\n- [ ] 3M SAAR 動能比較\n- [ ] 一句話 quick take\n</success_criteria>\n",
        "skills/usd-reserve-loss-gold-revaluation/SKILL.md": "---\nname: usd-reserve-loss-gold-revaluation\ndescription: 在「美元／某貨幣失去儲備地位、黃金成為唯一錨」的假設下，用央行貨幣負債 ÷ 黃金儲備，推演「資產負債表可承受的隱含金價」，並輸出各國/各貨幣的槓桿程度、缺口與排名。\n---\n\n<essential_principles>\n\n<principle name=\"gold_anchor_hypothesis\">\n**黃金錨定假說**\n\n本模型基於極端情境假設：若法定貨幣體系瓦解、黃金成為唯一錨定資產，則：\n- **隱含金價** = 貨幣負債 ÷ 黃金儲備\n- 這不是「預測」，而是「壓力測試」：資產負債表要撐得住需要多高的金價\n\n典型論述來源：VanEck「$39k gold」分析（M0 + FX turnover 加權）\n</principle>\n\n<principle name=\"two_aggregates\">\n**兩種貨幣口徑差異**\n\n| 口徑 | 定義 | 隱含金價 | 解讀 |\n|------|------|----------|------|\n| M0 (Monetary Base) | 央行直接負債（通貨 + 準備金） | ~$39k | 央行資產負債表壓力 |\n| M2 (Broad Money) | 含銀行體系信用擴張 | ~$184k | 全體信用體系壓力 |\n\n**關鍵洞察**：兩者差距反映「信用乘數」的槓桿效應。\n</principle>\n\n<principle name=\"weighting_logic\">\n**加權方法的直覺**\n\n| 方法 | 數據來源 | 直覺 |\n|------|----------|------|\n| fx_turnover | BIS 三年調查 | 外匯交易份額 ≈ 國際結算/儲備使用強度 |\n| reserve_share | IMF COFER | 官方外匯儲備幣別佔比 |\n| equal | - | 不考慮貨幣重要性差異 |\n| custom | 用戶自訂 | 可配合特定情境分析 |\n\n加權的直覺：份額越高的貨幣，在「重新錨定」時需吸收的負債壓力越大。\n</principle>\n\n<principle name=\"backing_ratio\">\n**黃金支撐率 (Backing Ratio)**\n\n```\nbacking_ratio = (gold_oz × gold_spot) / money_base\n```\n\n解讀：\n- backing_ratio ≈ 3% → 黃金僅支撐 3% 的貨幣負債（高槓桿）\n- backing_ratio ≈ 60% → 黃金接近完全支撐（低槓桿）\n\n貼文中「日本黃金只支撐約 3% 的 M0」即此概念。\n</principle>\n\n<principle name=\"data_access\">\n**資料取得方式**\n\n本 skill 使用**公開數據**：\n- **黃金儲備**：World Gold Council / IMF IFS（tonnes）\n- **貨幣量**：各國央行 / FRED / IMF IFS（M0/M2）\n- **FX Turnover**：BIS Triennial Survey（每三年更新）\n- **金價**：Yahoo Finance / FRED（XAU/USD）\n\n腳本位於 `scripts/` 目錄，可直接執行。\n</principle>\n\n</essential_principles>\n\n<objective>\n實作「美元失去儲備地位下的黃金重估」壓力測試模型：\n\n1. **數據整合**：抓取各國 M0/M2、黃金儲備、匯率、FX turnover 權重\n2. **計算隱含金價**：未加權與加權版本\n3. **計算黃金支撐率**：衡量各國槓桿程度\n4. **計算缺口**：需要再買多少黃金才能達到目標支撐率\n5. **排名輸出**：誰最槓桿、誰最穩健\n\n輸出：隱含金價、支撐率排名、缺口分析、敘事洞察。\n</objective>\n\n<quick_start>\n\n**最快的方式：執行預設情境分析**\n\n```bash\ncd skills/usd-reserve-loss-gold-revaluation\npip install pandas numpy requests yfinance  # 首次使用\npython scripts/gold_revaluation.py --quick\n```\n\n輸出範例：\n```json\n{\n  \"headline\": {\n    \"implied_gold_price_m0_weighted\": 39210.0,\n    \"implied_gold_price_m2_weighted\": 184500.0,\n    \"interpretation\": \"壓力測試數字，非價格預測\"\n  },\n  \"ranking\": [\n    {\"entity\": \"JPY\", \"backing_ratio\": 0.03, \"lever_multiple\": 41.0},\n    {\"entity\": \"USD\", \"backing_ratio\": 0.08, \"lever_multiple\": 12.5},\n    {\"entity\": \"ZAR\", \"backing_ratio\": 0.60, \"lever_multiple\": 0.16}\n  ]\n}\n```\n\n**完整情境分析**：\n```bash\npython scripts/gold_revaluation.py \\\n  --date 2026-01-07 \\\n  --entities USD,CNY,JPY,EUR,GBP \\\n  --aggregate M0 \\\n  --weighting fx_turnover \\\n  --output result.json\n```\n\n</quick_start>\n\n<intake>\n需要進行什麼操作？\n\n1. **快速計算** - 使用預設參數計算主要貨幣的隱含金價\n2. **完整分析** - 自訂參數進行情境分析（可選擇口徑、權重、實體）\n3. **比較分析** - 同時比較 M0 vs M2、不同加權方法的差異\n4. **監控模式** - 追蹤黃金支撐率的變化趨勢\n5. **方法論學習** - 了解計算邏輯與數據來源\n6. **視覺化圖表** - 生成分析結果的視覺化圖表\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                        | Action                                        |\n|---------------------------------|-----------------------------------------------|\n| 1, \"快速\", \"quick\", \"計算\"      | 執行 `python scripts/gold_revaluation.py --quick` |\n| 2, \"完整\", \"full\", \"分析\"       | 閱讀 `workflows/analyze.md` 並執行            |\n| 3, \"比較\", \"compare\", \"對比\"    | 閱讀 `workflows/compare.md` 並執行            |\n| 4, \"監控\", \"monitor\", \"追蹤\"    | 閱讀 `workflows/monitor.md` 並執行            |\n| 5, \"學習\", \"方法論\", \"why\"      | 閱讀 `references/methodology.md`              |\n| 6, \"圖表\", \"畫圖\", \"視覺化\"     | 執行 `python scripts/visualize_revaluation.py` |\n| 提供參數 (如實體清單)            | 閱讀 `workflows/analyze.md` 並使用參數執行    |\n\n**路由後，閱讀對應文件並執行。**\n</routing>\n\n<directory_structure>\n```\nusd-reserve-loss-gold-revaluation/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元數據\n├── workflows/\n│   ├── analyze.md                     # 完整情境分析工作流\n│   ├── compare.md                     # M0/M2 比較分析工作流\n│   └── monitor.md                     # 持續監控工作流\n├── references/\n│   ├── data-sources.md                # 數據來源與獲取方式\n│   ├── methodology.md                 # 方法論與計算邏輯\n│   └── input-schema.md                # 完整輸入參數定義\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n└── scripts/\n    ├── gold_revaluation.py            # 主計算腳本\n    └── visualize_revaluation.py       # 視覺化腳本\n```\n</directory_structure>\n\n<reference_index>\n\n**方法論**: references/methodology.md\n- 黃金錨定假說解析\n- 隱含金價計算公式\n- 支撐率與槓桿解讀\n\n**資料來源**: references/data-sources.md\n- 黃金儲備數據來源\n- 貨幣量 M0/M2 數據來源\n- BIS FX Turnover 數據\n- 匯率與金價來源\n\n**輸入參數**: references/input-schema.md\n- 完整參數定義\n- 預設值與建議範圍\n\n</reference_index>\n\n<workflows_index>\n| Workflow    | Purpose          | 使用時機                   |\n|-------------|------------------|---------------------------|\n| analyze.md  | 完整情境分析     | 需要自訂參數進行壓力測試   |\n| compare.md  | M0/M2 比較分析   | 比較不同口徑的隱含金價差異 |\n| monitor.md  | 持續監控         | 追蹤支撐率變化趨勢         |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構定義 |\n| output-markdown.md | Markdown 報告模板 |\n</templates_index>\n\n<scripts_index>\n| Script                    | Command                         | Purpose                |\n|---------------------------|---------------------------------|------------------------|\n| gold_revaluation.py       | `--quick`                       | 快速計算主要貨幣       |\n| gold_revaluation.py       | `--entities USD,CNY --agg M0`   | 自訂實體與口徑         |\n| gold_revaluation.py       | `--compare-aggregates`          | M0 vs M2 比較          |\n| visualize_revaluation.py  | `--mode usd`                    | 美元單一視覺化圖表     |\n| visualize_revaluation.py  | `--mode multi`                  | 多貨幣比較視覺化圖表   |\n| visualize_revaluation.py  | `--mode all --output-dir DIR`   | 生成所有圖表至指定目錄 |\n</scripts_index>\n\n<input_schema_summary>\n\n**核心參數**\n\n| 參數               | 類型   | 預設值       | 說明                       |\n|--------------------|--------|--------------|---------------------------|\n| scenario_date      | string | today        | 情境估算基準日期           |\n| entities           | array  | 主要貨幣     | 分析對象（國家/貨幣代碼）  |\n| monetary_aggregate | string | M0           | 貨幣口徑（M0/M2/MB/M1/M3） |\n| weighting_method   | string | fx_turnover  | 加權方式                   |\n| fx_base            | string | USD          | 計價幣別基準               |\n\n**進階參數**\n\n| 參數             | 類型   | 預設值     | 說明                   |\n|------------------|--------|------------|------------------------|\n| liability_scope  | string | broad_money | 負債口徑               |\n| gold_reserve_unit| string | troy_oz    | 黃金單位（oz/tonnes）  |\n| gold_price_spot  | float  | auto       | 基準日金價（可自動抓取）|\n| fx_rates         | object | auto       | 匯率（可自動抓取）     |\n\n完整參數定義見 `references/input-schema.md`。\n\n</input_schema_summary>\n\n<output_schema_summary>\n```json\n{\n  \"skill\": \"usd-reserve-loss-gold-revaluation\",\n  \"scenario_date\": \"2026-01-07\",\n  \"assumptions\": {\n    \"monetary_aggregate\": \"M0\",\n    \"weighting_method\": \"fx_turnover\",\n    \"fx_base\": \"USD\",\n    \"gold_spot_usd_per_oz\": 2050.0\n  },\n  \"headline\": {\n    \"implied_gold_price_weighted_usd_per_oz\": 39210.0,\n    \"interpretation\": \"資產負債表壓力測算（非價格預測）\"\n  },\n  \"table\": [...],\n  \"insights\": [...]\n}\n```\n\n完整輸出結構見 `templates/output-json.md`。\n</output_schema_summary>\n\n<success_criteria>\n執行成功時應產出：\n\n- [ ] 隱含金價（未加權與加權版本）\n- [ ] 各實體的黃金支撐率（backing_ratio）\n- [ ] 槓桿倍數排名（lever_multiple_vs_spot）\n- [ ] 黃金缺口分析（additional_gold_oz_needed）\n- [ ] 敘事洞察（M0 vs M2 差異、槓桿解讀）\n- [ ] 結果輸出為指定格式（JSON 或 Markdown）\n- [ ] 視覺化圖表（可選，包含金價比較、支撐率、信用乘數等 6 個面板）\n</success_criteria>\n",
        "skills/usd-reserve-loss-gold-revaluation/methodology.md": "\n這不是在「預測金價」，而是在做一個**資產負債表壓力測試（balance-sheet stress test）**：\n\n**假設**：若美元（或某貨幣）失去儲備地位，全球體系需要更「硬」的錨（anchor），而黃金成為主要或唯一錨。  \n\n**問題**：在這種極端情境下，金價需要被**重估到多少**，才能讓「貨幣負債」與「黃金儲備」之間的缺口被吸收？\n\n因此它本質上是一個「**錨定定價（anchor pricing）／儲備比率重估（reserve-ratio revaluation）**」的算術模型：  \n\n用央行（或貨幣體系）的**貨幣負債（money liabilities）**去對比可用的**黃金儲備（gold reserves）**。\n\n**這套方法是「用資產負債表視角，把儲備地位流失的系統性壓力映射成黃金的隱含重估價格」：**  \n\n它不回答短期走勢，但能提供一個極端情境下的「壓力上限」與「體系脆弱度地圖」。",
        "skills/usd-reserve-loss-gold-revaluation/references/data-sources.md": "# 數據來源 (Data Sources)\n\n本技能需要整合多種宏觀經濟數據，以下詳細說明各數據的來源與獲取方式。\n\n## 數據總覽\n\n| 數據類型 | 主要來源 | 替代來源 | 更新頻率 | API/下載方式 |\n|----------|----------|----------|----------|--------------|\n| 黃金儲備 | World Gold Council | IMF IFS | 月度/季度 | 公開報告 |\n| 貨幣量 M0 | 各國央行 | FRED, IMF | 月度 | API / CSV |\n| 貨幣量 M2 | 各國央行 | FRED, IMF | 月度 | API / CSV |\n| 金價 | FRED | Yahoo Finance | 即時 | API |\n| 匯率 | ECB | FRED, 各國央行 | 即時 | API |\n| FX Turnover | BIS | - | 三年 | 公開報告 |\n\n---\n\n## 1. 黃金儲備 (Gold Reserves)\n\n### 主要來源：World Gold Council\n\n**網址**: https://www.gold.org/goldhub/data/gold-reserves-by-country\n\n**數據內容**：\n- 各國央行持有的黃金儲備（噸）\n- 月度更新\n- 歷史數據可追溯至 2000 年\n\n**獲取方式**：\n```python\n# 手動下載 CSV 或使用 Selenium 爬取\n# WGC 網站需要點擊下載按鈕\n\nimport requests\nfrom bs4 import BeautifulSoup\n\n# 示例：解析 WGC 頁面\n# 注意：WGC 可能需要接受 cookies\n```\n\n### 替代來源：IMF IFS\n\n**網址**: https://data.imf.org/regular.aspx?key=61280849\n\n**數據內容**：\n- 官方儲備資產中的黃金持有量\n- 以 SDR 或美元計價\n\n**API 存取**：\n```python\n# IMF 提供 SDMX API\n# 但需要解析複雜的 XML 結構\n```\n\n### 主要國家黃金儲備參考值（2024 Q3）\n\n| 國家/地區 | 代碼 | 黃金儲備 (噸) | 佔外匯儲備比例 |\n|-----------|------|--------------|---------------|\n| 美國 | USD | 8,133.5 | 72.4% |\n| 德國 | EUR | 3,351.5 | 71.5% |\n| 義大利 | EUR | 2,451.8 | 67.8% |\n| 法國 | EUR | 2,436.9 | 68.1% |\n| 俄羅斯 | RUB | 2,335.9 | 28.6% |\n| 中國 | CNY | 2,264.3 | 4.9% |\n| 瑞士 | CHF | 1,040.0 | 7.3% |\n| 日本 | JPY | 845.9 | 4.4% |\n| 印度 | INR | 840.8 | 9.3% |\n| 荷蘭 | EUR | 612.5 | 60.8% |\n| 英國 | GBP | 310.3 | 12.3% |\n| 澳洲 | AUD | 79.9 | 6.7% |\n| 加拿大 | CAD | 0.0 | 0.0% |\n\n---\n\n## 2. 貨幣量 (Money Supply)\n\n### 美國：FRED\n\n**網址**: https://fred.stlouisfed.org\n\n**系列代碼**：\n\n| 系列 | 名稱 | 說明 |\n|------|------|------|\n| BOGMBASE | Monetary Base; Total | M0 貨幣基數 |\n| M1SL | M1 Money Stock | M1 |\n| M2SL | M2 Money Stock | M2 |\n\n**API 存取（無需 API Key）**：\n```python\nimport pandas as pd\nimport requests\nfrom io import StringIO\n\ndef fetch_fred_series(series_id, start_date, end_date):\n    \"\"\"從 FRED 抓取時間序列\"\"\"\n    url = \"https://fred.stlouisfed.org/graph/fredgraph.csv\"\n    params = {\n        \"id\": series_id,\n        \"cosd\": start_date,\n        \"coed\": end_date\n    }\n    response = requests.get(url, params=params)\n    response.raise_for_status()\n\n    df = pd.read_csv(StringIO(response.text), parse_dates=[\"DATE\"], index_col=\"DATE\")\n    df.columns = [series_id]\n    return df\n\n# 範例\nm0_us = fetch_fred_series(\"BOGMBASE\", \"2020-01-01\", \"2026-01-01\")\nm2_us = fetch_fred_series(\"M2SL\", \"2020-01-01\", \"2026-01-01\")\n```\n\n### 歐元區：ECB\n\n**網址**: https://data.ecb.europa.eu\n\n**系列代碼**：\n\n| 系列 | 名稱 | 說明 |\n|------|------|------|\n| BSI.M.U2.N.A.L20.A.1.U2.2300.Z01.E | M1 | 窄義貨幣 |\n| BSI.M.U2.N.A.L21.A.1.U2.2300.Z01.E | M2 | 中間貨幣 |\n| BSI.M.U2.N.A.L22.A.1.U2.2300.Z01.E | M3 | 廣義貨幣 |\n\n### 中國：人民銀行\n\n**網址**: http://www.pbc.gov.cn/diaochatongjisi/116219/index.html\n\n**數據**：\n- M0：流通中現金\n- M1：M0 + 企業活期存款\n- M2：M1 + 準貨幣\n\n### 日本：日本銀行\n\n**網址**: https://www.stat-search.boj.or.jp\n\n**數據**：\n- 貨幣基數（Monetary Base）\n- M2\n\n### IMF IFS（國際比較用）\n\n**網址**: https://data.imf.org\n\n**好處**：口徑相對統一，適合跨國比較\n**壞處**：更新較慢，可能有 1-2 季度延遲\n\n---\n\n## 3. 金價 (Gold Price)\n\n### FRED\n\n**系列**: GOLDAMGBD228NLBM (London Bullion Market Association Gold Price)\n\n```python\ngold_price = fetch_fred_series(\"GOLDAMGBD228NLBM\", \"2020-01-01\", \"2026-01-01\")\n```\n\n### Yahoo Finance\n\n```python\nimport yfinance as yf\n\n# 黃金期貨\ngold_futures = yf.download(\"GC=F\", start=\"2020-01-01\", end=\"2026-01-01\")\n\n# 黃金 ETF\ngld = yf.download(\"GLD\", start=\"2020-01-01\", end=\"2026-01-01\")\n```\n\n---\n\n## 4. 匯率 (Exchange Rates)\n\n### FRED\n\n```python\n# 主要匯率對美元\nfx_series = {\n    \"DEXJPUS\": \"JPY/USD\",  # 日圓\n    \"DEXUSEU\": \"USD/EUR\",  # 歐元\n    \"DEXCHUS\": \"CNY/USD\",  # 人民幣\n    \"DEXUSUK\": \"USD/GBP\",  # 英鎊\n    \"DEXSZUS\": \"CHF/USD\",  # 瑞郎\n    \"DEXUSAL\": \"USD/AUD\",  # 澳元\n    \"DEXCAUS\": \"CAD/USD\",  # 加元\n}\n```\n\n### ECB\n\n**網址**: https://www.ecb.europa.eu/stats/eurofxref/\n\n提供對歐元的匯率，需轉換為對美元。\n\n### Yahoo Finance\n\n```python\n# 範例：美元/日圓\nusdjpy = yf.download(\"USDJPY=X\", start=\"2020-01-01\", end=\"2026-01-01\")\n```\n\n---\n\n## 5. FX Turnover 權重 (BIS Triennial Survey)\n\n### 來源：BIS\n\n**網址**: https://www.bis.org/statistics/rpfx22.htm\n\n**最新調查**: 2022 年（每三年更新）\n\n**2022 年 FX Turnover 份額**：\n\n| 貨幣 | 份額 | 說明 |\n|------|------|------|\n| USD | 88.25% | 全球最主要 |\n| EUR | 30.92% | 第二大 |\n| JPY | 16.92% | 第三大 |\n| GBP | 12.88% | 第四大 |\n| CNY | 7.04% | 持續上升 |\n| AUD | 6.31% | - |\n| CAD | 6.20% | - |\n| CHF | 5.03% | - |\n| HKD | 2.64% | - |\n| SGD | 2.40% | - |\n\n**注意**：BIS 使用雙邊計算，總和約 200%（因為每筆交易涉及兩種貨幣）。\n\n**使用方式**：可直接使用份額作為權重，或正規化為總和 100%。\n\n```python\n# BIS 2022 原始份額\nFX_TURNOVER_2022 = {\n    \"USD\": 0.8825,\n    \"EUR\": 0.3092,\n    \"JPY\": 0.1692,\n    \"GBP\": 0.1288,\n    \"CNY\": 0.0704,\n    \"AUD\": 0.0631,\n    \"CAD\": 0.0620,\n    \"CHF\": 0.0503,\n}\n\n# 正規化為總和 1.0（可選）\ntotal = sum(FX_TURNOVER_2022.values())\nFX_TURNOVER_NORMALIZED = {k: v/total for k, v in FX_TURNOVER_2022.items()}\n```\n\n---\n\n## 6. 外匯儲備幣別組成 (IMF COFER)\n\n### 來源：IMF\n\n**網址**: https://data.imf.org/regular.aspx?key=41175\n\n**2023 Q4 外匯儲備幣別組成**：\n\n| 貨幣 | 份額 |\n|------|------|\n| USD | 58.89% |\n| EUR | 19.98% |\n| JPY | 5.45% |\n| GBP | 4.87% |\n| CNY | 2.62% |\n| CAD | 2.53% |\n| AUD | 2.02% |\n| CHF | 0.20% |\n| 其他 | 3.44% |\n\n---\n\n## 數據獲取程式碼範例\n\n```python\n\"\"\"\n完整數據獲取範例\n\"\"\"\nimport pandas as pd\nimport requests\nimport yfinance as yf\nfrom io import StringIO\nfrom typing import Dict, Optional\nfrom datetime import datetime\n\nclass GoldRevaluationDataFetcher:\n    \"\"\"黃金重估數據獲取器\"\"\"\n\n    FRED_BASE_URL = \"https://fred.stlouisfed.org/graph/fredgraph.csv\"\n\n    def __init__(self):\n        self.cache = {}\n\n    def fetch_fred(self, series_id: str, start: str, end: str) -> pd.Series:\n        \"\"\"從 FRED 獲取數據\"\"\"\n        params = {\"id\": series_id, \"cosd\": start, \"coed\": end}\n        resp = requests.get(self.FRED_BASE_URL, params=params)\n        resp.raise_for_status()\n        df = pd.read_csv(StringIO(resp.text), parse_dates=[\"DATE\"], index_col=\"DATE\")\n        return df[series_id]\n\n    def fetch_gold_price(self, start: str, end: str) -> pd.Series:\n        \"\"\"獲取金價\"\"\"\n        return self.fetch_fred(\"GOLDAMGBD228NLBM\", start, end)\n\n    def fetch_us_money_supply(self, aggregate: str, start: str, end: str) -> pd.Series:\n        \"\"\"獲取美國貨幣供給\"\"\"\n        series_map = {\n            \"M0\": \"BOGMBASE\",\n            \"M1\": \"M1SL\",\n            \"M2\": \"M2SL\"\n        }\n        return self.fetch_fred(series_map[aggregate], start, end)\n\n    def fetch_fx_rate(self, ticker: str, start: str, end: str) -> pd.Series:\n        \"\"\"從 Yahoo Finance 獲取匯率\"\"\"\n        data = yf.download(ticker, start=start, end=end, progress=False)\n        return data[\"Adj Close\"]\n\n    def get_gold_reserves_static(self) -> Dict[str, float]:\n        \"\"\"\n        返回靜態的黃金儲備數據（噸）\n        實際應用中應從 WGC/IMF 動態獲取\n        \"\"\"\n        return {\n            \"USD\": 8133.5,\n            \"EUR\": 10773.5,  # 歐元區合計\n            \"CNY\": 2264.3,\n            \"JPY\": 845.9,\n            \"GBP\": 310.3,\n            \"CHF\": 1040.0,\n            \"AUD\": 79.9,\n            \"CAD\": 0.0,\n            \"RUB\": 2335.9,\n            \"INR\": 840.8,\n        }\n\n    def get_fx_turnover_weights(self) -> Dict[str, float]:\n        \"\"\"返回 BIS 2022 FX Turnover 權重\"\"\"\n        return {\n            \"USD\": 0.8825,\n            \"EUR\": 0.3092,\n            \"JPY\": 0.1692,\n            \"GBP\": 0.1288,\n            \"CNY\": 0.0704,\n            \"AUD\": 0.0631,\n            \"CAD\": 0.0620,\n            \"CHF\": 0.0503,\n        }\n\n    def get_reserve_share_weights(self) -> Dict[str, float]:\n        \"\"\"返回 IMF COFER 外匯儲備幣別權重\"\"\"\n        return {\n            \"USD\": 0.5889,\n            \"EUR\": 0.1998,\n            \"JPY\": 0.0545,\n            \"GBP\": 0.0487,\n            \"CNY\": 0.0262,\n            \"CAD\": 0.0253,\n            \"AUD\": 0.0202,\n            \"CHF\": 0.0020,\n        }\n```\n\n---\n\n## 數據更新時間表\n\n| 數據 | 更新頻率 | 典型發布時間 |\n|------|----------|--------------|\n| 黃金儲備 (WGC) | 月度 | 每月中旬 |\n| 美國 M0/M2 | 週度/月度 | 每週四/每月 |\n| 金價 | 即時 | 交易日收盤 |\n| 匯率 | 即時 | 交易日收盤 |\n| BIS FX Survey | 三年 | 下次 2025 年 |\n| IMF COFER | 季度 | 季度後約 3 個月 |\n\n---\n\n## 注意事項\n\n1. **口徑差異**：各國 M0/M2 定義不完全一致，跨國比較需謹慎\n2. **數據延遲**：宏觀數據有 1-3 個月發布延遲\n3. **BIS 調查**：每三年更新，中間期間使用舊數據\n4. **黃金儲備**：某些國家不完全公開，數據可能不準確\n5. **匯率波動**：建議使用月均值或期末值保持一致\n",
        "skills/usd-reserve-loss-gold-revaluation/references/input-schema.md": "# 輸入參數定義 (Input Schema)\n\n本文件定義 `usd-reserve-loss-gold-revaluation` 技能的完整輸入參數。\n\n---\n\n## 參數總覽\n\n| 參數 | 類型 | 必要 | 預設值 | 說明 |\n|------|------|------|--------|------|\n| scenario_date | string | ✅ | - | 情境估算基準日期 |\n| entities | array[string] | ✅ | - | 分析對象清單 |\n| monetary_aggregate | string | ✅ | - | 貨幣口徑 |\n| liability_scope | string | ❌ | broad_money | 負債口徑 |\n| weighting_method | string | ✅ | - | 加權方式 |\n| weights | object | ❌ | - | 自訂權重 |\n| fx_base | string | ❌ | USD | 計價幣別基準 |\n| gold_reserve_unit | string | ❌ | troy_oz | 黃金單位 |\n| gold_price_spot | float | ❌ | auto | 基準日金價 |\n| fx_rates | object | ❌ | auto | 匯率 |\n| data_providers | object | ❌ | - | 資料來源偏好 |\n| output_format | string | ❌ | json | 輸出格式 |\n\n---\n\n## 詳細參數定義\n\n### scenario_date\n\n**類型**: `string` (YYYY-MM-DD)\n**必要**: ✅\n\n情境估算的基準日期，用於對應匯率、金價、貨幣量。\n\n```json\n{\n  \"scenario_date\": \"2026-01-07\"\n}\n```\n\n**特殊值**:\n- `\"today\"`: 使用當日日期\n- `\"latest\"`: 使用最新可得數據\n\n---\n\n### entities\n\n**類型**: `array[string]`\n**必要**: ✅\n\n分析對象清單（國家或貨幣代碼）。\n\n```json\n{\n  \"entities\": [\"USD\", \"CNY\", \"JPY\", \"EUR\", \"GBP\", \"CHF\", \"AUD\", \"CAD\"]\n}\n```\n\n**支援的代碼**:\n\n| 代碼 | 國家/地區 | 說明 |\n|------|-----------|------|\n| USD | 美國 | |\n| EUR | 歐元區 | 包含 ECB + 成員國 |\n| CNY | 中國 | |\n| JPY | 日本 | |\n| GBP | 英國 | |\n| CHF | 瑞士 | |\n| AUD | 澳洲 | |\n| CAD | 加拿大 | 注意：無黃金儲備 |\n| INR | 印度 | |\n| RUB | 俄羅斯 | 數據可能受限 |\n| ZAR | 南非 | |\n| KZT | 哈薩克 | |\n\n---\n\n### monetary_aggregate\n\n**類型**: `string`\n**必要**: ✅\n\n貨幣口徑選擇。\n\n```json\n{\n  \"monetary_aggregate\": \"M0\"\n}\n```\n\n**可用值**:\n\n| 值 | 說明 | 使用場景 |\n|----|------|----------|\n| M0 | 貨幣基數（央行負債） | 央行壓力測試 |\n| M1 | 狹義貨幣 | 中間口徑 |\n| M2 | 廣義貨幣（含銀行存款） | 全體系壓力測試 |\n| MB | Monetary Base（同 M0） | 美國術語 |\n| M3 | 最廣義貨幣 | 某些國家使用 |\n\n---\n\n### liability_scope\n\n**類型**: `string`\n**必要**: ❌\n**預設**: `\"broad_money\"`\n\n貨幣負債口徑。\n\n```json\n{\n  \"liability_scope\": \"central_bank\"\n}\n```\n\n**可用值**:\n\n| 值 | 說明 |\n|----|------|\n| central_bank | 央行直接負債（偏向貨幣基數） |\n| broad_money | 全體銀行體系的廣義貨幣 |\n\n---\n\n### weighting_method\n\n**類型**: `string`\n**必要**: ✅\n\n加權方式選擇。\n\n```json\n{\n  \"weighting_method\": \"fx_turnover\"\n}\n```\n\n**可用值**:\n\n| 值 | 說明 | 來源 |\n|----|------|------|\n| fx_turnover | 外匯成交佔比加權 | BIS Triennial Survey |\n| reserve_share | 外匯儲備幣別佔比 | IMF COFER |\n| equal | 等權重 | - |\n| custom | 自訂權重 | 需配合 weights 參數 |\n\n---\n\n### weights\n\n**類型**: `object{string: float}`\n**必要**: 當 `weighting_method=\"custom\"` 時必要\n\n自訂權重。\n\n```json\n{\n  \"weighting_method\": \"custom\",\n  \"weights\": {\n    \"USD\": 0.88,\n    \"EUR\": 0.31,\n    \"JPY\": 0.17,\n    \"CNY\": 0.10\n  }\n}\n```\n\n**注意**:\n- 權重總和不需要等於 1（BIS 口徑允許 > 1）\n- 未列出的 entity 權重視為 0\n\n---\n\n### fx_base\n\n**類型**: `string`\n**必要**: ❌\n**預設**: `\"USD\"`\n\n將各國貨幣量換算成同一計價幣別的基準。\n\n```json\n{\n  \"fx_base\": \"USD\"\n}\n```\n\n**可用值**: `USD`, `EUR`, `SDR`（特別提款權）\n\n---\n\n### gold_reserve_unit\n\n**類型**: `string`\n**必要**: ❌\n**預設**: `\"troy_oz\"`\n\n黃金儲備的輸出單位。\n\n```json\n{\n  \"gold_reserve_unit\": \"tonnes\"\n}\n```\n\n**可用值**:\n\n| 值 | 說明 |\n|----|------|\n| troy_oz | 金衡盎司（內部計算用） |\n| tonnes | 公噸（WGC 常用） |\n\n---\n\n### gold_price_spot\n\n**類型**: `float`\n**必要**: ❌\n**預設**: 自動抓取\n\n基準日金價（USD per troy oz）。\n\n```json\n{\n  \"gold_price_spot\": 2050.0\n}\n```\n\n若不填，腳本會從 FRED 或 Yahoo Finance 抓取。\n\n---\n\n### fx_rates\n\n**類型**: `object{string: float}`\n**必要**: ❌\n**預設**: 自動抓取\n\n基準日匯率。格式：`1 單位該貨幣 = ? USD`。\n\n```json\n{\n  \"fx_rates\": {\n    \"USD\": 1.0,\n    \"EUR\": 1.08,\n    \"JPY\": 0.0068,\n    \"CNY\": 0.14,\n    \"GBP\": 1.27,\n    \"CHF\": 1.17\n  }\n}\n```\n\n若不填，腳本會自動抓取。\n\n---\n\n### data_providers\n\n**類型**: `object`\n**必要**: ❌\n\n指定資料來源偏好。\n\n```json\n{\n  \"data_providers\": {\n    \"money\": \"FRED\",\n    \"gold\": \"WGC\",\n    \"fx_turnover\": \"BIS\",\n    \"fx_rates\": \"ECB\"\n  }\n}\n```\n\n**可用值**:\n\n| 數據類型 | 可用來源 |\n|----------|----------|\n| money | FRED, IMF, central_bank |\n| gold | WGC, IMF |\n| fx_turnover | BIS |\n| fx_rates | FRED, ECB, yahoo |\n\n---\n\n### output_format\n\n**類型**: `string`\n**必要**: ❌\n**預設**: `\"json\"`\n\n輸出格式。\n\n```json\n{\n  \"output_format\": \"markdown\"\n}\n```\n\n**可用值**:\n\n| 值 | 說明 |\n|----|------|\n| json | JSON 格式（工程串接用） |\n| markdown | Markdown 格式（人類閱讀用） |\n\n---\n\n## 完整輸入範例\n\n### 範例 1: 快速檢查（使用預設）\n\n```json\n{\n  \"scenario_date\": \"today\",\n  \"entities\": [\"USD\", \"EUR\", \"CNY\", \"JPY\"],\n  \"monetary_aggregate\": \"M0\",\n  \"weighting_method\": \"fx_turnover\"\n}\n```\n\n### 範例 2: 完整自訂\n\n```json\n{\n  \"scenario_date\": \"2026-01-07\",\n  \"entities\": [\"USD\", \"CNY\", \"JPY\", \"GBP\", \"ZAR\", \"RUB\", \"KZT\"],\n  \"monetary_aggregate\": \"M2\",\n  \"liability_scope\": \"broad_money\",\n  \"weighting_method\": \"fx_turnover\",\n  \"fx_base\": \"USD\",\n  \"gold_reserve_unit\": \"troy_oz\",\n  \"gold_price_spot\": 2050.0,\n  \"fx_rates\": {\n    \"USD\": 1.0,\n    \"CNY\": 0.14,\n    \"JPY\": 0.0068,\n    \"GBP\": 1.27,\n    \"ZAR\": 0.053,\n    \"RUB\": 0.011,\n    \"KZT\": 0.0020\n  },\n  \"data_providers\": {\n    \"money\": \"FRED\",\n    \"gold\": \"WGC\"\n  },\n  \"output_format\": \"json\"\n}\n```\n\n### 範例 3: 自訂權重\n\n```json\n{\n  \"scenario_date\": \"2026-01-07\",\n  \"entities\": [\"USD\", \"EUR\", \"CNY\"],\n  \"monetary_aggregate\": \"M0\",\n  \"weighting_method\": \"custom\",\n  \"weights\": {\n    \"USD\": 0.70,\n    \"EUR\": 0.20,\n    \"CNY\": 0.15\n  },\n  \"output_format\": \"markdown\"\n}\n```\n\n### 範例 4: M0 vs M2 比較\n\n```json\n{\n  \"mode\": \"compare_aggregates\",\n  \"scenario_date\": \"2026-01-07\",\n  \"entities\": [\"USD\", \"EUR\", \"CNY\", \"JPY\", \"GBP\"],\n  \"weighting_method\": \"fx_turnover\",\n  \"output_format\": \"json\"\n}\n```\n\n---\n\n## 參數驗證規則\n\n```python\nfrom pydantic import BaseModel, Field, validator\nfrom typing import List, Dict, Optional, Literal\nfrom datetime import date\n\nclass GoldRevaluationInput(BaseModel):\n    scenario_date: str\n    entities: List[str] = Field(min_items=1)\n    monetary_aggregate: Literal[\"M0\", \"M1\", \"M2\", \"MB\", \"M3\"]\n    liability_scope: Literal[\"central_bank\", \"broad_money\"] = \"broad_money\"\n    weighting_method: Literal[\"fx_turnover\", \"reserve_share\", \"equal\", \"custom\"]\n    weights: Optional[Dict[str, float]] = None\n    fx_base: str = \"USD\"\n    gold_reserve_unit: Literal[\"troy_oz\", \"tonnes\"] = \"troy_oz\"\n    gold_price_spot: Optional[float] = None\n    fx_rates: Optional[Dict[str, float]] = None\n    data_providers: Optional[Dict[str, str]] = None\n    output_format: Literal[\"json\", \"markdown\"] = \"json\"\n\n    @validator('weights', always=True)\n    def validate_weights(cls, v, values):\n        if values.get('weighting_method') == 'custom' and v is None:\n            raise ValueError('weights required when weighting_method is custom')\n        return v\n\n    @validator('entities')\n    def validate_entities(cls, v):\n        valid = {\"USD\", \"EUR\", \"CNY\", \"JPY\", \"GBP\", \"CHF\", \"AUD\", \"CAD\",\n                 \"INR\", \"RUB\", \"ZAR\", \"KZT\", \"BRL\", \"MXN\", \"KRW\"}\n        for e in v:\n            if e not in valid:\n                raise ValueError(f'Unknown entity: {e}')\n        return v\n```\n\n---\n\n## CLI 參數對應\n\n```bash\npython scripts/gold_revaluation.py \\\n  --date 2026-01-07 \\\n  --entities USD,CNY,JPY,EUR,GBP \\\n  --aggregate M0 \\\n  --weighting fx_turnover \\\n  --gold-price 2050 \\\n  --output result.json \\\n  --format json\n```\n\n| CLI 參數 | JSON 參數 |\n|----------|-----------|\n| --date | scenario_date |\n| --entities | entities |\n| --aggregate | monetary_aggregate |\n| --weighting | weighting_method |\n| --gold-price | gold_price_spot |\n| --output | (輸出檔案路徑) |\n| --format | output_format |\n",
        "skills/usd-reserve-loss-gold-revaluation/references/methods.md": "# 方法論 (Methodology)\n\n本文件詳細解釋「美元失去儲備地位下黃金重估」壓力測試模型的計算邏輯與理論基礎。\n\n---\n\n## 核心假設：黃金錨定情境\n\n### 情境設定\n\n本模型基於以下極端假設：\n\n1. **法定貨幣體系瓦解**：美元或其他儲備貨幣失去其儲備地位\n2. **黃金成為唯一錨**：各國需要用實物黃金來「支撐」其貨幣負債\n3. **全額支撐要求**：貨幣負債需要完全由黃金價值覆蓋\n\n### 這不是什麼\n\n- **不是價格預測**：這是壓力測試，不是預測金價會漲到 $39k\n- **不是機率模型**：不評估此情境發生的可能性\n- **不是投資建議**：僅用於理解極端情境下的資產負債表壓力\n\n### 來源與啟發\n\n此模型受 VanEck 的黃金分析啟發：\n> \"If you divide central bank money liabilities by gold reserves...\"\n> — VanEck Gold Research\n\n---\n\n## 核心公式\n\n### 1. 隱含金價（Implied Gold Price）\n\n**未加權版本**：\n\n```\nimplied_gold_price = money_base_usd / gold_oz\n```\n\n其中：\n- `money_base_usd`：以美元計價的貨幣量（M0 或 M2）\n- `gold_oz`：黃金儲備（金衡盎司）\n\n**加權版本**：\n\n```\nimplied_gold_price_weighted = (money_base_usd × weight) / gold_oz\n```\n\n其中 `weight` 來自 FX turnover 或 reserve share。\n\n### 2. Headline 隱含金價（加權總計）\n\n```\nheadline_implied_price = Σ(money_base_i × weight_i) / Σ(gold_oz_i)\n```\n\n這是「若全球體系重新錨定到黃金」的總隱含金價。\n\n### 3. 黃金支撐率（Backing Ratio）\n\n```\nbacking_ratio = (gold_oz × gold_spot) / money_base_usd\n```\n\n解讀：\n- `backing_ratio = 1.0`：黃金完全支撐貨幣負債\n- `backing_ratio = 0.03`：黃金僅支撐 3% 的貨幣負債\n\n### 4. 槓桿倍數（Leverage Multiple）\n\n```\nlever_multiple = implied_gold_price_weighted / gold_spot\n```\n\n表示「金價需要漲多少倍才能完全支撐」。\n\n### 5. 黃金缺口（Gold Gap）\n\n若要達到 100% 支撐：\n\n```\nrequired_gold_oz = money_base_usd / gold_spot\nadditional_gold_oz = max(0, required_gold_oz - gold_oz)\n```\n\n若要達到目標支撐率 X：\n\n```\nrequired_gold_oz = (money_base_usd × X) / gold_spot\n```\n\n---\n\n## 貨幣口徑選擇\n\n### M0（Monetary Base / 貨幣基數）\n\n**定義**：央行直接創造的貨幣\n- 流通中現金（Currency in Circulation）\n- 銀行準備金（Bank Reserves）\n\n**使用場景**：\n- 評估央行資產負債表的直接壓力\n- VanEck \"$39k gold\" 論點使用此口徑\n\n**優點**：\n- 口徑相對明確\n- 數據可得性高\n- 代表「高能貨幣」\n\n### M2（Broad Money / 廣義貨幣）\n\n**定義**：包含銀行體系信用擴張\n- M0\n- 活期存款\n- 定期存款\n- 貨幣市場基金等\n\n**使用場景**：\n- 評估整體金融體系的極端壓力\n- 「如果連銀行存款都要黃金支撐」的情境\n\n**優點**：\n- 更全面反映貨幣供給\n- 捕捉信用擴張程度\n\n### M0 vs M2 的關係\n\n```\nCredit Multiplier = M2 / M0\n```\n\n典型值：4-10 倍，代表銀行體系的信用擴張程度。\n\n| 口徑 | 典型隱含金價 | 解讀 |\n|------|-------------|------|\n| M0 | ~$39k | 央行壓力 |\n| M2 | ~$184k | 全體系壓力 |\n\n---\n\n## 加權方法\n\n### FX Turnover 加權\n\n**來源**：BIS Triennial Survey（每三年更新）\n\n**直覺**：\n- 外匯交易份額 ≈ 國際結算/儲備使用強度\n- 份額越高，在「重新錨定」時需吸收的壓力越大\n\n**數學**：\n```\nweight_i = fx_turnover_share_i / Σ(fx_turnover_share)\n```\n\n**優點**：\n- 反映實際國際使用強度\n- 捕捉貨幣的「結算功能」\n\n**缺點**：\n- 每三年才更新\n- 雙邊計算導致總和 > 100%\n\n### Reserve Share 加權\n\n**來源**：IMF COFER（季度更新）\n\n**直覺**：\n- 官方外匯儲備中的幣別佔比\n- 反映各國央行對不同貨幣的「信任度」\n\n**數學**：\n```\nweight_i = reserve_share_i\n```\n\n**優點**：\n- 季度更新，較新\n- 直接反映官方偏好\n\n**缺點**：\n- 主要反映官方行為，非市場行為\n- CNY 佔比可能低估實際使用\n\n### Equal Weight（等權重）\n\n**直覺**：不考慮貨幣重要性差異\n\n**使用場景**：\n- 簡單比較各國單獨的壓力\n- 避免權重選擇的主觀性\n\n### Custom Weight（自訂權重）\n\n**使用場景**：\n- 特定情境分析（如「只考慮 G7」）\n- 研究假設檢驗\n\n---\n\n## 單位換算\n\n### 黃金單位\n\n| 單位 | 轉換 |\n|------|------|\n| 1 噸 (tonne) | = 32,150.7466 金衡盎司 (troy oz) |\n| 1 金衡盎司 | = 31.1035 克 |\n| 1 公斤 | = 32.1507 金衡盎司 |\n\n```python\nTONNE_TO_TROY_OZ = 32150.7466\ngold_oz = gold_tonnes * TONNE_TO_TROY_OZ\n```\n\n### 貨幣換算\n\n將本幣貨幣量轉為 USD：\n\n```python\nmoney_base_usd = money_local * fx_rate_to_usd\n```\n\n其中 `fx_rate_to_usd` 是「1 單位本幣 = ? USD」。\n\n---\n\n## 解讀指南\n\n### Backing Ratio 解讀\n\n| 範圍 | 解讀 | 典型國家 |\n|------|------|----------|\n| < 5% | 極度槓桿 | 日本 (~3%) |\n| 5-15% | 高度槓桿 | 美國 (~8%), 英國 |\n| 15-30% | 中度槓桿 | 歐元區 |\n| 30-50% | 低度槓桿 | 瑞士 (~35%) |\n| > 50% | 接近完全支撐 | 某些新興市場 |\n\n### Lever Multiple 解讀\n\n| 倍數 | 解讀 |\n|------|------|\n| < 1x | 黃金已「超額支撐」，隱含金價低於市價 |\n| 1-5x | 低槓桿，金價小幅重估即可支撐 |\n| 5-20x | 中高槓桿，需金價顯著重估 |\n| > 20x | 極度槓桿，需金價大幅重估 |\n\n### Headline Number 解讀\n\nVanEck 的 \"$39k gold\"：\n- 口徑：M0\n- 權重：FX turnover\n- 解讀：這是壓力測試，非預測\n\n要達到這個數字：\n- 需要極端情境（法定貨幣體系瓦解）\n- 需要全球同時發生\n- 需要黃金成為唯一被接受的價值儲存\n\n---\n\n## 模型限制\n\n### 1. 數據口徑不一致\n\n各國 M0/M2 定義略有差異：\n- 美國 M0 = Monetary Base\n- 日本 M0 = 日銀券發行額 + 準備預金\n- 中國 M0 = 流通中現金（不含準備金）\n\n**緩解**：使用 IMF IFS 數據可提高可比性，但更新較慢。\n\n### 2. 黃金儲備數據不完整\n\n- 某些國家不完全公開\n- 可能包含未配置儲備（Allocated vs Unallocated）\n- 租借 (leasing) 可能重複計算\n\n### 3. 情境的極端性\n\n- 假設「全球同時發生」不切實際\n- 忽略漸進調整過程\n- 忽略其他價值儲存（如加密貨幣）\n\n### 4. 權重的時效性\n\n- BIS 調查每三年更新\n- FX 格局可能已變化（尤其 CNY）\n\n---\n\n## 進階分析\n\n### 情境模擬\n\n可以調整參數進行敏感度分析：\n\n```python\n# 情境 1: 只考慮 G7\nentities = [\"USD\", \"EUR\", \"JPY\", \"GBP\", \"CAD\"]\n\n# 情境 2: 加入新興市場\nentities = [\"USD\", \"EUR\", \"CNY\", \"INR\", \"BRL\", \"RUB\"]\n\n# 情境 3: 調整權重（假設 CNY 份額上升）\ncustom_weights = {\"USD\": 0.70, \"EUR\": 0.25, \"CNY\": 0.15, ...}\n```\n\n### 歷史回測\n\n追蹤 backing ratio 的歷史變化：\n\n```python\n# 過去 20 年的 backing ratio 變化\n# 識別趨勢：各國是在「去槓桿化」還是「加槓桿」\n```\n\n### 央行行為追蹤\n\n關聯央行的黃金買賣行為：\n\n```python\n# 過去 10 年央行淨買入/賣出\n# 與 backing ratio 變化的關係\n```\n\n---\n\n## 參考文獻\n\n1. VanEck Gold Research Reports\n2. BIS Triennial Central Bank Survey (2022)\n3. IMF Currency Composition of Official Foreign Exchange Reserves (COFER)\n4. World Gold Council Gold Demand Trends\n5. Central Bank Gold Agreements (CBGA)\n",
        "skills/usd-reserve-loss-gold-revaluation/templates/output-json.md": "# JSON 輸出模板 (Output JSON Template)\n\n## 完整輸出結構\n\n```json\n{\n  \"skill\": \"usd-reserve-loss-gold-revaluation\",\n  \"version\": \"0.1.0\",\n  \"scenario_date\": \"2026-01-07\",\n\n  \"assumptions\": {\n    \"monetary_aggregate\": \"M0\",\n    \"liability_scope\": \"broad_money\",\n    \"weighting_method\": \"fx_turnover\",\n    \"fx_base\": \"USD\",\n    \"gold_spot_usd_per_oz\": 2050.0,\n    \"data_sources\": {\n      \"gold_reserves\": \"World Gold Council (2024-Q3)\",\n      \"money_supply\": \"FRED, IMF IFS\",\n      \"fx_rates\": \"FRED (2026-01-07)\",\n      \"fx_turnover\": \"BIS Triennial Survey (2022)\"\n    }\n  },\n\n  \"headline\": {\n    \"implied_gold_price_weighted_usd_per_oz\": 39210.0,\n    \"vs_spot_multiple\": 19.1,\n    \"interpretation\": \"資產負債表壓力測算（非價格預測）：在該權重與口徑下，若黃金成為唯一錨且需承擔相應貨幣負債，金價需重估至此水平。\"\n  },\n\n  \"table\": [\n    {\n      \"entity\": \"USD\",\n      \"currency\": \"US Dollar\",\n      \"gold_tonnes\": 8133.5,\n      \"gold_oz\": 261495775,\n      \"money_local\": 5800000000000,\n      \"money_base_usd\": 5800000000000,\n      \"fx_rate_to_usd\": 1.0,\n      \"weight\": 0.8825,\n      \"implied_gold_price\": 22180.0,\n      \"implied_gold_price_weighted\": 19573.9,\n      \"backing_ratio_at_spot\": 0.092,\n      \"lever_multiple_vs_spot\": 9.5,\n      \"required_gold_oz_full_back_at_spot\": 2829268292,\n      \"additional_gold_oz_needed\": 2567772517\n    },\n    {\n      \"entity\": \"JPY\",\n      \"currency\": \"Japanese Yen\",\n      \"gold_tonnes\": 845.9,\n      \"gold_oz\": 27201545,\n      \"money_local\": 680000000000000,\n      \"money_base_usd\": 4624000000000,\n      \"fx_rate_to_usd\": 0.0068,\n      \"weight\": 0.1692,\n      \"implied_gold_price\": 170011.0,\n      \"implied_gold_price_weighted\": 28773.9,\n      \"backing_ratio_at_spot\": 0.012,\n      \"lever_multiple_vs_spot\": 14.0,\n      \"required_gold_oz_full_back_at_spot\": 2256097560,\n      \"additional_gold_oz_needed\": 2228896015\n    },\n    {\n      \"entity\": \"CNY\",\n      \"currency\": \"Chinese Yuan\",\n      \"gold_tonnes\": 2264.3,\n      \"gold_oz\": 72808850,\n      \"money_local\": 11600000000000,\n      \"money_base_usd\": 1624000000000,\n      \"fx_rate_to_usd\": 0.14,\n      \"weight\": 0.0704,\n      \"implied_gold_price\": 22305.0,\n      \"implied_gold_price_weighted\": 1570.3,\n      \"backing_ratio_at_spot\": 0.092,\n      \"lever_multiple_vs_spot\": 0.77,\n      \"required_gold_oz_full_back_at_spot\": 792195121,\n      \"additional_gold_oz_needed\": 719386271\n    },\n    {\n      \"entity\": \"EUR\",\n      \"currency\": \"Euro\",\n      \"gold_tonnes\": 10773.5,\n      \"gold_oz\": 346416058,\n      \"money_local\": 6200000000000,\n      \"money_base_usd\": 6696000000000,\n      \"fx_rate_to_usd\": 1.08,\n      \"weight\": 0.3092,\n      \"implied_gold_price\": 19331.0,\n      \"implied_gold_price_weighted\": 5979.1,\n      \"backing_ratio_at_spot\": 0.106,\n      \"lever_multiple_vs_spot\": 2.9,\n      \"required_gold_oz_full_back_at_spot\": 3266341463,\n      \"additional_gold_oz_needed\": 2919925405\n    },\n    {\n      \"entity\": \"GBP\",\n      \"currency\": \"British Pound\",\n      \"gold_tonnes\": 310.3,\n      \"gold_oz\": 9976771,\n      \"money_local\": 870000000000,\n      \"money_base_usd\": 1104900000000,\n      \"fx_rate_to_usd\": 1.27,\n      \"weight\": 0.1288,\n      \"implied_gold_price\": 110752.0,\n      \"implied_gold_price_weighted\": 14264.8,\n      \"backing_ratio_at_spot\": 0.019,\n      \"lever_multiple_vs_spot\": 7.0,\n      \"required_gold_oz_full_back_at_spot\": 538975609,\n      \"additional_gold_oz_needed\": 528998838\n    },\n    {\n      \"entity\": \"CHF\",\n      \"currency\": \"Swiss Franc\",\n      \"gold_tonnes\": 1040.0,\n      \"gold_oz\": 33436776,\n      \"money_local\": 720000000000,\n      \"money_base_usd\": 842400000000,\n      \"fx_rate_to_usd\": 1.17,\n      \"weight\": 0.0503,\n      \"implied_gold_price\": 25197.0,\n      \"implied_gold_price_weighted\": 1267.4,\n      \"backing_ratio_at_spot\": 0.081,\n      \"lever_multiple_vs_spot\": 0.62,\n      \"required_gold_oz_full_back_at_spot\": 411024390,\n      \"additional_gold_oz_needed\": 377587614\n    },\n    {\n      \"entity\": \"ZAR\",\n      \"currency\": \"South African Rand\",\n      \"gold_tonnes\": 125.4,\n      \"gold_oz\": 4031687,\n      \"money_local\": 150000000000,\n      \"money_base_usd\": 7950000000,\n      \"fx_rate_to_usd\": 0.053,\n      \"weight\": 0.01,\n      \"implied_gold_price\": 1972.0,\n      \"implied_gold_price_weighted\": 19.7,\n      \"backing_ratio_at_spot\": 1.04,\n      \"lever_multiple_vs_spot\": 0.01,\n      \"required_gold_oz_full_back_at_spot\": 3878048,\n      \"additional_gold_oz_needed\": 0\n    }\n  ],\n\n  \"ranking\": {\n    \"by_lever_multiple_desc\": [\n      {\"rank\": 1, \"entity\": \"JPY\", \"lever_multiple\": 14.0},\n      {\"rank\": 2, \"entity\": \"USD\", \"lever_multiple\": 9.5},\n      {\"rank\": 3, \"entity\": \"GBP\", \"lever_multiple\": 7.0},\n      {\"rank\": 4, \"entity\": \"EUR\", \"lever_multiple\": 2.9},\n      {\"rank\": 5, \"entity\": \"CNY\", \"lever_multiple\": 0.77},\n      {\"rank\": 6, \"entity\": \"CHF\", \"lever_multiple\": 0.62},\n      {\"rank\": 7, \"entity\": \"ZAR\", \"lever_multiple\": 0.01}\n    ],\n    \"by_backing_ratio_asc\": [\n      {\"rank\": 1, \"entity\": \"JPY\", \"backing_ratio\": 0.012},\n      {\"rank\": 2, \"entity\": \"GBP\", \"backing_ratio\": 0.019},\n      {\"rank\": 3, \"entity\": \"CHF\", \"backing_ratio\": 0.081},\n      {\"rank\": 4, \"entity\": \"USD\", \"backing_ratio\": 0.092},\n      {\"rank\": 5, \"entity\": \"CNY\", \"backing_ratio\": 0.092},\n      {\"rank\": 6, \"entity\": \"EUR\", \"backing_ratio\": 0.106},\n      {\"rank\": 7, \"entity\": \"ZAR\", \"backing_ratio\": 1.04}\n    ]\n  },\n\n  \"insights\": [\n    {\n      \"id\": 1,\n      \"title\": \"M0 與 M2 的差異\",\n      \"content\": \"M0 與 M2 的差異主要反映『貨幣口徑』：廣義貨幣把銀行體系信用也算進來，因此隱含金價會極端放大（M2 約為 M0 的 4-5 倍）。\"\n    },\n    {\n      \"id\": 2,\n      \"title\": \"日本的高槓桿\",\n      \"content\": \"backing_ratio 很低（約 1.2%）代表日本貨幣體系對信用擴張依賴度極高；在『黃金唯一錨』情境下，必然需要金價大幅重估或大規模增持黃金。\"\n    },\n    {\n      \"id\": 3,\n      \"title\": \"FX Turnover 權重的直覺\",\n      \"content\": \"使用 fx_turnover 權重的直覺是：儲備/結算使用份額越高，被重錨時吸收的壓力越大；因此 headline 更像在描述『全球體系再定價』而不是單一國家內生均衡。\"\n    },\n    {\n      \"id\": 4,\n      \"title\": \"南非的特殊性\",\n      \"content\": \"南非（ZAR）的 backing_ratio 超過 100%，表示其黃金儲備價值已超過 M0 貨幣量，這與其作為主要產金國的歷史有關。\"\n    }\n  ],\n\n  \"aggregates_comparison\": null,\n\n  \"metadata\": {\n    \"generated_at\": \"2026-01-07T10:30:00Z\",\n    \"execution_time_ms\": 1234,\n    \"data_freshness\": {\n      \"gold_reserves\": \"2024-Q3\",\n      \"money_supply\": \"2025-11\",\n      \"fx_rates\": \"2026-01-07\",\n      \"fx_turnover\": \"2022\"\n    },\n    \"warnings\": [\n      \"BIS FX Turnover 數據為 2022 年，可能不反映最新格局\",\n      \"各國 M0 定義略有差異，跨國比較需謹慎\"\n    ]\n  }\n}\n```\n\n---\n\n## 欄位說明\n\n### assumptions\n\n| 欄位 | 說明 |\n|------|------|\n| monetary_aggregate | 使用的貨幣口徑（M0/M2） |\n| liability_scope | 負債口徑 |\n| weighting_method | 加權方式 |\n| fx_base | 計價幣別基準 |\n| gold_spot_usd_per_oz | 使用的金價 |\n| data_sources | 各數據來源與時間 |\n\n### headline\n\n| 欄位 | 說明 |\n|------|------|\n| implied_gold_price_weighted_usd_per_oz | 加權總隱含金價 |\n| vs_spot_multiple | 相對於現價的倍數 |\n| interpretation | 解讀說明 |\n\n### table (各實體明細)\n\n| 欄位 | 說明 |\n|------|------|\n| entity | 貨幣代碼 |\n| currency | 貨幣名稱 |\n| gold_tonnes | 黃金儲備（噸） |\n| gold_oz | 黃金儲備（金衡盎司） |\n| money_local | 本幣貨幣量 |\n| money_base_usd | USD 計價貨幣量 |\n| fx_rate_to_usd | 匯率（1 本幣 = ? USD） |\n| weight | 權重 |\n| implied_gold_price | 未加權隱含金價 |\n| implied_gold_price_weighted | 加權隱含金價 |\n| backing_ratio_at_spot | 黃金支撐率 |\n| lever_multiple_vs_spot | 槓桿倍數 |\n| required_gold_oz_full_back_at_spot | 完全支撐所需黃金量 |\n| additional_gold_oz_needed | 黃金缺口 |\n\n### ranking\n\n| 欄位 | 說明 |\n|------|------|\n| by_lever_multiple_desc | 按槓桿倍數降序排名 |\n| by_backing_ratio_asc | 按支撐率升序排名（最槓桿在前） |\n\n---\n\n## 精簡輸出（--quick 模式）\n\n```json\n{\n  \"skill\": \"usd-reserve-loss-gold-revaluation\",\n  \"scenario_date\": \"2026-01-07\",\n  \"headline\": {\n    \"implied_gold_price_m0_weighted\": 39210.0,\n    \"vs_spot_multiple\": 19.1\n  },\n  \"top_leveraged\": [\n    {\"entity\": \"JPY\", \"backing_ratio\": 0.012, \"lever_multiple\": 14.0},\n    {\"entity\": \"USD\", \"backing_ratio\": 0.092, \"lever_multiple\": 9.5},\n    {\"entity\": \"GBP\", \"backing_ratio\": 0.019, \"lever_multiple\": 7.0}\n  ]\n}\n```\n\n---\n\n## 比較模式輸出\n\n```json\n{\n  \"skill\": \"usd-reserve-loss-gold-revaluation\",\n  \"mode\": \"compare_aggregates\",\n  \"scenario_date\": \"2026-01-07\",\n  \"headline_comparison\": {\n    \"m0\": {\n      \"implied_gold_price_weighted\": 39210.0,\n      \"vs_spot_multiple\": 19.1\n    },\n    \"m2\": {\n      \"implied_gold_price_weighted\": 184500.0,\n      \"vs_spot_multiple\": 90.0\n    },\n    \"credit_multiplier\": 4.7\n  },\n  \"entity_comparison\": [\n    {\n      \"entity\": \"USD\",\n      \"m0_backing_ratio\": 0.092,\n      \"m2_backing_ratio\": 0.026,\n      \"credit_expansion_ratio\": 3.6\n    },\n    {\n      \"entity\": \"JPY\",\n      \"m0_backing_ratio\": 0.012,\n      \"m2_backing_ratio\": 0.007,\n      \"credit_expansion_ratio\": 1.8\n    }\n  ],\n  \"insights\": [\n    \"M0 vs M2 差距約 4.7 倍，反映全球平均信用乘數\",\n    \"日本的信用擴張比率較低（1.8x），因 M0 本身已很大\"\n  ]\n}\n```\n",
        "skills/usd-reserve-loss-gold-revaluation/templates/output-markdown.md": "# Markdown 輸出模板 (Output Markdown Template)\n\n## 完整報告格式\n\n```markdown\n# 黃金重估壓力測試報告\n\n**情境日期**: 2026-01-07\n**貨幣口徑**: M0 (Monetary Base)\n**加權方式**: FX Turnover (BIS 2022)\n**基準金價**: $2,050 / oz\n\n---\n\n## Headline 隱含金價\n\n| 指標 | 數值 |\n|------|------|\n| 加權隱含金價 | **$39,210 / oz** |\n| 相對現價倍數 | **19.1x** |\n\n> **解讀**: 這是資產負債表壓力測算（非價格預測）。在該權重與口徑下，若黃金成為唯一錨且需承擔相應貨幣負債，金價需重估至此水平。\n\n---\n\n## 各貨幣槓桿分析\n\n### 按槓桿程度排名（從高到低）\n\n| 排名 | 貨幣 | 黃金支撐率 | 槓桿倍數 | 解讀 |\n|:----:|------|----------:|--------:|------|\n| 1 | JPY 🇯🇵 | 1.2% | 14.0x | 極度槓桿 |\n| 2 | USD 🇺🇸 | 9.2% | 9.5x | 高度槓桿 |\n| 3 | GBP 🇬🇧 | 1.9% | 7.0x | 高度槓桿 |\n| 4 | EUR 🇪🇺 | 10.6% | 2.9x | 中度槓桿 |\n| 5 | CNY 🇨🇳 | 9.2% | 0.8x | 低度槓桿 |\n| 6 | CHF 🇨🇭 | 8.1% | 0.6x | 低度槓桿 |\n| 7 | ZAR 🇿🇦 | 104% | 0.01x | 超額支撐 |\n\n---\n\n## 詳細數據表\n\n| 貨幣 | 黃金儲備 | 貨幣量 (USD) | 隱含金價 | 支撐率 | 黃金缺口 |\n|------|-------:|------------:|--------:|------:|--------:|\n| USD | 8,133 噸 | $5.8T | $22,180 | 9.2% | 80,000 噸 |\n| EUR | 10,774 噸 | $6.7T | $19,331 | 10.6% | 91,000 噸 |\n| CNY | 2,264 噸 | $1.6T | $22,305 | 9.2% | 22,000 噸 |\n| JPY | 846 噸 | $4.6T | $170,011 | 1.2% | 69,000 噸 |\n| GBP | 310 噸 | $1.1T | $110,752 | 1.9% | 16,000 噸 |\n| CHF | 1,040 噸 | $0.8T | $25,197 | 8.1% | 12,000 噸 |\n| ZAR | 125 噸 | $8B | $1,972 | 104% | 0 噸 |\n\n> **黃金缺口**: 若要在當前金價下達到 100% 支撐，需要再增持的黃金量\n\n---\n\n## 關鍵洞察\n\n### 1. M0 vs M2 的差異\n\nM0 與 M2 的差異主要反映「信用乘數」槓桿效應：\n\n| 口徑 | 隱含金價 | 倍數 |\n|------|-------:|-----:|\n| M0 (央行負債) | $39,210 | 19.1x |\n| M2 (廣義貨幣) | $184,500 | 90.0x |\n\n廣義貨幣把銀行體系信用也算進來，因此隱含金價會極端放大。\n\n### 2. 日本的極端槓桿\n\n日本的 backing ratio 僅 1.2%，代表：\n- 黃金僅支撐約 1.2% 的 M0 貨幣量\n- 在「黃金唯一錨」情境下，金價需漲 14 倍才能支撐\n- 或需增持約 69,000 噸黃金（幾乎是全球央行總持有量）\n\n### 3. FX Turnover 權重的意義\n\n使用外匯成交佔比權重的直覺：\n- 份額越高的貨幣，在「重新錨定」時需吸收的壓力越大\n- 因此 headline 更像在描述「全球體系再定價」\n- 而不是單一國家的內生均衡\n\n### 4. 南非的特殊性\n\n南非是少數 backing ratio 超過 100% 的國家：\n- 這與其作為主要產金國的歷史地位有關\n- 黃金儲備價值已超過 M0 貨幣量\n- 在「黃金唯一錨」情境下相對穩健\n\n---\n\n## 數據來源\n\n| 數據類型 | 來源 | 時間 |\n|----------|------|------|\n| 黃金儲備 | World Gold Council | 2024 Q3 |\n| 貨幣量 | FRED, IMF IFS | 2025-11 |\n| 匯率 | FRED | 2026-01-07 |\n| FX Turnover | BIS Triennial Survey | 2022 |\n| 金價 | FRED | 2026-01-07 |\n\n---\n\n## 注意事項\n\n⚠️ **重要提醒**：\n1. 這是壓力測試框架，**不是價格預測**\n2. 各國 M0/M2 定義略有差異，跨國比較需謹慎\n3. BIS FX Turnover 每三年更新，可能不反映最新格局\n4. 部分國家黃金儲備數據可能不完全公開\n\n---\n\n*報告生成時間: 2026-01-07 10:30:00 UTC*\n*Skill: usd-reserve-loss-gold-revaluation v0.1.0*\n```\n\n---\n\n## 精簡報告格式\n\n```markdown\n# 黃金重估快速檢查\n\n**日期**: 2026-01-07 | **口徑**: M0 | **金價**: $2,050/oz\n\n## Headline\n\n| **加權隱含金價** | **$39,210 / oz** (19.1x 現價) |\n|-----------------|------------------------------|\n\n## 槓桿排名\n\n| 貨幣 | 支撐率 | 槓桿 |\n|------|------:|-----:|\n| JPY | 1.2% | 14.0x |\n| USD | 9.2% | 9.5x |\n| GBP | 1.9% | 7.0x |\n\n*壓力測試數字，非價格預測*\n```\n\n---\n\n## 比較報告格式\n\n```markdown\n# M0 vs M2 隱含金價比較\n\n**日期**: 2026-01-07 | **金價**: $2,050/oz\n\n## Headline 比較\n\n| 口徑 | 隱含金價 | 相對現價 |\n|------|--------:|--------:|\n| **M0** (央行負債) | $39,210 | 19.1x |\n| **M2** (廣義貨幣) | $184,500 | 90.0x |\n| **信用乘數** | | **4.7x** |\n\n## 各貨幣信用擴張\n\n| 貨幣 | M0 支撐率 | M2 支撐率 | 信用擴張 |\n|------|--------:|--------:|--------:|\n| USD | 9.2% | 2.6% | 3.6x |\n| JPY | 1.2% | 0.7% | 1.8x |\n| EUR | 10.6% | 4.2% | 2.5x |\n\n## 解讀\n\n1. **M0 vs M2 差距約 4.7 倍** - 反映全球平均信用乘數\n2. **VanEck \"$39k\" 使用 M0** - 這是相對「保守」的估計\n3. **M2 口徑極端** - 代表「連銀行存款都要黃金支撐」的情境\n```\n\n---\n\n## 監控報告格式\n\n```markdown\n# 黃金支撐率監控報告\n\n**監控期間**: 2025-01-01 至 2026-01-07\n**口徑**: M0 | **權重**: FX Turnover\n\n## 當前快照\n\n| 指標 | 數值 |\n|------|------|\n| Headline 隱含金價 | $39,210 (+5.2% YoY) |\n| 金價 | $2,050 (+8.1% YoY) |\n| 全球央行黃金淨買入 | +1,050 噸 |\n\n## 支撐率變化趨勢\n\n| 貨幣 | 一年前 | 現在 | 變化 |\n|------|------:|-----:|-----:|\n| USD | 8.5% | 9.2% | ↑ +0.7% |\n| CNY | 7.8% | 9.2% | ↑ +1.4% |\n| JPY | 1.4% | 1.2% | ↓ -0.2% |\n\n## 央行行為\n\n| 國家 | 動作 | 數量 | 解讀 |\n|------|------|-----:|------|\n| 🇨🇳 中國 | BUY | +225 噸 | 持續增持第 18 個月 |\n| 🇵🇱 波蘭 | BUY | +45 噸 | 積極增持 |\n| 🇹🇷 土耳其 | SELL | -15 噸 | 應對匯率壓力 |\n\n## 警報\n\n⚠️ **日本支撐率持續下降**: 從 1.4% 降至 1.2%，槓桿程度上升\n\n## 下次數據更新\n\n- 黃金儲備: 2026-02-15 (WGC monthly)\n- M0/M2: 2026-02-01 (各國央行)\n- BIS Survey: 2025 (下次三年調查)\n```\n",
        "skills/usd-reserve-loss-gold-revaluation/workflows/analyze.md": "# Workflow: 完整情境分析\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/input-schema.md - 完整參數定義\n2. references/methodology.md - 方法論與計算邏輯\n3. references/data-sources.md - 數據來源與獲取方式\n</required_reading>\n\n<process>\n\n## Step 1: 確認參數\n\n檢查用戶提供的參數，補充預設值：\n\n```python\nparams = {\n    \"scenario_date\": \"today\",                # 情境基準日期\n    \"entities\": [\"USD\", \"EUR\", \"CNY\", \"JPY\", \"GBP\", \"CHF\", \"AUD\", \"CAD\"],\n    \"monetary_aggregate\": \"M0\",              # M0 或 M2\n    \"liability_scope\": \"broad_money\",        # central_bank 或 broad_money\n    \"weighting_method\": \"fx_turnover\",       # fx_turnover, reserve_share, equal, custom\n    \"weights\": None,                          # 若 weighting_method=\"custom\"\n    \"fx_base\": \"USD\",                         # 計價幣別\n    \"gold_reserve_unit\": \"troy_oz\",          # troy_oz 或 tonnes\n    \"gold_price_spot\": None,                 # 若不填則自動抓取\n    \"fx_rates\": None,                        # 若不填則自動抓取\n    \"output_format\": \"json\"                  # json 或 markdown\n}\n```\n\n若用戶有指定參數，覆蓋上述預設值。\n\n## Step 2: 抓取數據\n\n執行 `scripts/gold_revaluation.py` 抓取所需數據：\n\n### 2.1 黃金儲備數據\n\n```python\n# 從 World Gold Council 或 IMF 獲取各國黃金儲備（tonnes）\ngold_reserves = {\n    \"USD\": 8133.5,   # 美國\n    \"EUR\": 10773.5,  # 歐元區（ECB + 成員國）\n    \"CNY\": 2264.3,   # 中國\n    \"JPY\": 845.9,    # 日本\n    \"GBP\": 310.3,    # 英國\n    \"CHF\": 1040.0,   # 瑞士\n    \"AUD\": 79.9,     # 澳洲\n    \"CAD\": 0.0,      # 加拿大（已出售所有黃金）\n    # ... 更多國家\n}\n```\n\n### 2.2 貨幣量數據\n\n```python\n# 從各國央行/FRED/IMF 獲取 M0 或 M2（本幣計價）\nmoney_supply = {\n    \"USD\": {\"M0\": 5.8e12, \"M2\": 20.9e12},   # 美元\n    \"EUR\": {\"M0\": 6.2e12, \"M2\": 15.8e12},   # 歐元\n    \"CNY\": {\"M0\": 11.6e12, \"M2\": 292e12},   # 人民幣\n    \"JPY\": {\"M0\": 680e12, \"M2\": 1200e12},   # 日圓\n    # ... 更多國家\n}\n```\n\n### 2.3 匯率數據\n\n```python\n# 獲取各貨幣對 USD 的匯率\n# 格式：1 單位本幣 = ? USD\nfx_rates = {\n    \"USD\": 1.0,\n    \"EUR\": 1.08,      # 1 EUR = 1.08 USD\n    \"CNY\": 0.14,      # 1 CNY = 0.14 USD\n    \"JPY\": 0.0068,    # 1 JPY = 0.0068 USD\n    \"GBP\": 1.27,      # 1 GBP = 1.27 USD\n    \"CHF\": 1.17,      # 1 CHF = 1.17 USD\n    \"AUD\": 0.65,      # 1 AUD = 0.65 USD\n    \"CAD\": 0.74,      # 1 CAD = 0.74 USD\n}\n```\n\n### 2.4 FX Turnover 權重\n\n```python\n# BIS 2022 Triennial Survey\n# 注意：BIS 口徑是雙邊計算，總和 > 100%\nfx_turnover_weights = {\n    \"USD\": 0.8825,\n    \"EUR\": 0.3092,\n    \"JPY\": 0.1692,\n    \"GBP\": 0.1288,\n    \"CNY\": 0.0704,\n    \"AUD\": 0.0631,\n    \"CAD\": 0.0620,\n    \"CHF\": 0.0503,\n}\n```\n\n### 2.5 金價\n\n```python\n# 從 Yahoo Finance 或 FRED 獲取\ngold_price_spot = 2050.0  # USD per troy oz\n```\n\n## Step 3: 單位換算\n\n### 3.1 黃金儲備轉換\n\n```python\nTONNE_TO_TROY_OZ = 32150.7466\n\n# 轉換為金衡盎司\ngold_oz = {\n    entity: tonnes * TONNE_TO_TROY_OZ\n    for entity, tonnes in gold_reserves.items()\n}\n```\n\n### 3.2 貨幣量轉換為 USD 計價\n\n```python\n# 將各國貨幣量轉為 USD\nmoney_base = {\n    entity: money_supply[entity][params[\"monetary_aggregate\"]] * fx_rates[entity]\n    for entity in params[\"entities\"]\n}\n```\n\n## Step 4: 計算核心指標\n\n### 4.1 隱含金價（未加權）\n\n```python\nimplied_price = {\n    entity: money_base[entity] / gold_oz[entity]\n    for entity in params[\"entities\"]\n    if gold_oz[entity] > 0  # 排除無黃金儲備的國家\n}\n```\n\n### 4.2 隱含金價（加權）\n\n```python\nweights = get_weights(params[\"weighting_method\"], params[\"weights\"])\n\nimplied_price_weighted = {\n    entity: (money_base[entity] * weights[entity]) / gold_oz[entity]\n    for entity in params[\"entities\"]\n    if gold_oz[entity] > 0\n}\n```\n\n### 4.3 加權總隱含金價（Headline Number）\n\n```python\ntotal_weighted_money = sum(\n    money_base[e] * weights[e]\n    for e in params[\"entities\"]\n)\ntotal_gold_oz = sum(\n    gold_oz[e]\n    for e in params[\"entities\"]\n)\nheadline_implied_price = total_weighted_money / total_gold_oz\n```\n\n### 4.4 黃金支撐率\n\n```python\nbacking_ratio = {\n    entity: (gold_oz[entity] * gold_price_spot) / money_base[entity]\n    for entity in params[\"entities\"]\n}\n```\n\n### 4.5 槓桿倍數\n\n```python\nlever_multiple = {\n    entity: implied_price_weighted[entity] / gold_price_spot\n    for entity in params[\"entities\"]\n}\n```\n\n### 4.6 黃金缺口\n\n```python\n# 若要達到 100% 支撐，需要再買多少黃金\nadditional_gold_needed = {\n    entity: max(0, (money_base[entity] / gold_price_spot) - gold_oz[entity])\n    for entity in params[\"entities\"]\n}\n```\n\n## Step 5: 排名與洞察\n\n### 5.1 按槓桿倍數排名\n\n```python\nranking = sorted(\n    lever_multiple.items(),\n    key=lambda x: x[1],\n    reverse=True  # 從高槓桿到低槓桿\n)\n```\n\n### 5.2 生成洞察\n\n```python\ninsights = [\n    f\"M0 與 M2 的差異主要反映『信用乘數』槓桿效應\",\n    f\"backing_ratio 很低（如 ~3%）代表該貨幣體系對信用擴張依賴度高\",\n    f\"使用 {params['weighting_method']} 權重的直覺是：...\",\n]\n```\n\n## Step 6: 輸出結果\n\n依據 `output_format` 參數產出結果：\n\n- JSON 格式：參考 `templates/output-json.md`\n- Markdown 格式：參考 `templates/output-markdown.md`\n\n```bash\npython scripts/gold_revaluation.py \\\n  --date {scenario_date} \\\n  --entities {entities} \\\n  --aggregate {monetary_aggregate} \\\n  --weighting {weighting_method} \\\n  --output result.json\n```\n\n</process>\n\n<success_criteria>\n分析完成時應產出：\n\n- [ ] Headline 隱含金價（加權總計）\n- [ ] 各實體的隱含金價（未加權與加權）\n- [ ] 各實體的黃金支撐率（backing_ratio）\n- [ ] 各實體的槓桿倍數（lever_multiple）\n- [ ] 各實體的黃金缺口（additional_gold_needed）\n- [ ] 按槓桿程度排名\n- [ ] 敘事洞察（至少 3 點）\n- [ ] 結果輸出為指定格式\n</success_criteria>\n",
        "skills/usd-reserve-loss-gold-revaluation/workflows/compare.md": "# Workflow: M0/M2 比較分析\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/methodology.md - 理解 M0 與 M2 的差異\n2. references/input-schema.md - 參數定義\n</required_reading>\n\n<process>\n\n## Step 1: 確認比較參數\n\n此工作流程會同時計算 M0 和 M2 兩種口徑的隱含金價：\n\n```python\ncompare_params = {\n    \"scenario_date\": \"today\",\n    \"entities\": [\"USD\", \"EUR\", \"CNY\", \"JPY\", \"GBP\", \"CHF\"],\n    \"aggregates\": [\"M0\", \"M2\"],           # 固定比較這兩個口徑\n    \"weighting_method\": \"fx_turnover\",    # 可選擇加權方式\n    \"fx_base\": \"USD\",\n    \"output_format\": \"json\"\n}\n```\n\n## Step 2: 執行雙口徑計算\n\n```bash\npython scripts/gold_revaluation.py \\\n  --compare-aggregates \\\n  --entities {entities} \\\n  --weighting {weighting_method} \\\n  --output comparison.json\n```\n\n或使用 Python API：\n\n```python\nfrom scripts.gold_revaluation import compute_gold_anchor_stress\n\n# M0 版本\nresult_m0 = compute_gold_anchor_stress(\n    monetary_aggregate=\"M0\",\n    weighting_method=\"fx_turnover\",\n    entities=params[\"entities\"]\n)\n\n# M2 版本\nresult_m2 = compute_gold_anchor_stress(\n    monetary_aggregate=\"M2\",\n    weighting_method=\"fx_turnover\",\n    entities=params[\"entities\"]\n)\n```\n\n## Step 3: 計算比較指標\n\n### 3.1 Headline 比較\n\n```python\ncomparison = {\n    \"m0\": {\n        \"headline_implied_price\": result_m0[\"headline\"][\"implied_gold_price_weighted\"],\n        \"vs_spot_multiple\": result_m0[\"headline\"][\"implied_gold_price_weighted\"] / gold_spot\n    },\n    \"m2\": {\n        \"headline_implied_price\": result_m2[\"headline\"][\"implied_gold_price_weighted\"],\n        \"vs_spot_multiple\": result_m2[\"headline\"][\"implied_gold_price_weighted\"] / gold_spot\n    },\n    \"credit_multiplier\": result_m2[\"headline\"][\"implied_gold_price_weighted\"] /\n                         result_m0[\"headline\"][\"implied_gold_price_weighted\"]\n}\n```\n\n### 3.2 各實體比較\n\n```python\nentity_comparison = []\nfor entity in params[\"entities\"]:\n    entity_comparison.append({\n        \"entity\": entity,\n        \"m0_implied_price\": result_m0[\"table\"][entity][\"implied_gold_price_weighted\"],\n        \"m2_implied_price\": result_m2[\"table\"][entity][\"implied_gold_price_weighted\"],\n        \"m0_backing_ratio\": result_m0[\"table\"][entity][\"backing_ratio\"],\n        \"m2_backing_ratio\": result_m2[\"table\"][entity][\"backing_ratio\"],\n        \"credit_expansion_ratio\": result_m2[\"table\"][entity][\"money_base\"] /\n                                  result_m0[\"table\"][entity][\"money_base\"]\n    })\n```\n\n## Step 4: 生成比較洞察\n\n```python\ninsights = [\n    {\n        \"title\": \"M0 vs M2 差異反映信用乘數\",\n        \"content\": f\"全體平均信用乘數約 {comparison['credit_multiplier']:.1f} 倍，\"\n                   f\"代表銀行體系的信用擴張程度\"\n    },\n    {\n        \"title\": \"使用場景區分\",\n        \"content\": \"M0 適合評估央行資產負債表壓力；\"\n                   \"M2 適合評估整體金融體系極端壓力\"\n    },\n    {\n        \"title\": \"VanEck 的選擇\",\n        \"content\": \"VanEck '$39k gold' 論點使用 M0 口徑，是相對保守的估計\"\n    },\n    {\n        \"title\": \"各國信用擴張程度差異\",\n        \"content\": f\"信用擴張最大：{max_credit_expansion_entity}；\"\n                   f\"信用擴張最小：{min_credit_expansion_entity}\"\n    }\n]\n```\n\n## Step 5: 輸出比較報告\n\n輸出格式包含：\n\n```json\n{\n  \"skill\": \"usd-reserve-loss-gold-revaluation\",\n  \"mode\": \"compare_aggregates\",\n  \"scenario_date\": \"2026-01-07\",\n  \"headline_comparison\": {\n    \"m0\": {\n      \"implied_gold_price\": 39210.0,\n      \"vs_spot_multiple\": 19.1\n    },\n    \"m2\": {\n      \"implied_gold_price\": 184500.0,\n      \"vs_spot_multiple\": 90.0\n    },\n    \"credit_multiplier\": 4.7\n  },\n  \"entity_comparison\": [...],\n  \"insights\": [...]\n}\n```\n\n</process>\n\n<success_criteria>\n比較分析完成時應產出：\n\n- [ ] M0 口徑的 Headline 隱含金價\n- [ ] M2 口徑的 Headline 隱含金價\n- [ ] 兩者倍數比較（信用乘數）\n- [ ] 各實體的 M0 vs M2 支撐率比較\n- [ ] 各實體的信用擴張比率\n- [ ] 比較洞察（至少 3 點）\n- [ ] 使用場景建議\n</success_criteria>\n",
        "skills/usd-reserve-loss-gold-revaluation/workflows/monitor.md": "# Workflow: 持續監控\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/data-sources.md - 數據更新頻率\n2. references/methodology.md - 指標解讀\n</required_reading>\n\n<process>\n\n## Step 1: 監控設定\n\n設定監控參數：\n\n```python\nmonitor_params = {\n    \"entities\": [\"USD\", \"EUR\", \"CNY\", \"JPY\", \"GBP\"],\n    \"monetary_aggregate\": \"M0\",\n    \"weighting_method\": \"fx_turnover\",\n    \"track_metrics\": [\n        \"implied_gold_price_weighted\",\n        \"backing_ratio\",\n        \"lever_multiple\"\n    ],\n    \"alert_thresholds\": {\n        \"backing_ratio_change\": 0.05,     # 支撐率變化超過 5%\n        \"gold_reserve_change\": 50,        # 黃金儲備變化超過 50 噸\n        \"implied_price_change\": 0.10      # 隱含金價變化超過 10%\n    },\n    \"history_lookback\": \"1Y\",             # 回顧 1 年歷史\n    \"output_dir\": \"output/\"\n}\n```\n\n## Step 2: 獲取歷史數據\n\n```python\n# 獲取歷史快照（通常季度更新）\nhistory = fetch_historical_snapshots(\n    entities=params[\"entities\"],\n    start_date=lookback_start,\n    end_date=\"today\",\n    freq=\"Q\"  # 季度快照\n)\n```\n\n**數據更新頻率參考**：\n\n| 數據類型 | 更新頻率 | 來源 |\n|----------|----------|------|\n| 黃金儲備 | 月度/季度 | World Gold Council / IMF |\n| M0/M2 | 月度 | 各國央行 / FRED |\n| 金價 | 即時 | Yahoo Finance / FRED |\n| FX Turnover | 三年 | BIS Triennial |\n\n## Step 3: 計算變化趨勢\n\n```python\ndef calculate_trends(history):\n    trends = {}\n    for entity in params[\"entities\"]:\n        entity_history = history[entity]\n\n        trends[entity] = {\n            \"backing_ratio_trend\": calculate_trend(\n                entity_history[\"backing_ratio\"]\n            ),\n            \"gold_reserve_change\": (\n                entity_history[\"gold_tonnes\"].iloc[-1] -\n                entity_history[\"gold_tonnes\"].iloc[0]\n            ),\n            \"implied_price_trend\": calculate_trend(\n                entity_history[\"implied_gold_price_weighted\"]\n            ),\n            \"money_growth_rate\": calculate_cagr(\n                entity_history[\"money_base\"]\n            )\n        }\n\n    return trends\n```\n\n## Step 4: 檢測重大變化\n\n```python\ndef detect_alerts(trends, thresholds):\n    alerts = []\n\n    for entity, trend in trends.items():\n        # 黃金儲備大幅變化\n        if abs(trend[\"gold_reserve_change\"]) > thresholds[\"gold_reserve_change\"]:\n            alerts.append({\n                \"entity\": entity,\n                \"type\": \"gold_reserve_change\",\n                \"value\": trend[\"gold_reserve_change\"],\n                \"threshold\": thresholds[\"gold_reserve_change\"],\n                \"message\": f\"{entity} 黃金儲備變化 {trend['gold_reserve_change']:.0f} 噸\"\n            })\n\n        # 支撐率大幅變化\n        if abs(trend[\"backing_ratio_trend\"][\"change\"]) > thresholds[\"backing_ratio_change\"]:\n            alerts.append({\n                \"entity\": entity,\n                \"type\": \"backing_ratio_change\",\n                \"value\": trend[\"backing_ratio_trend\"][\"change\"],\n                \"threshold\": thresholds[\"backing_ratio_change\"],\n                \"message\": f\"{entity} 黃金支撐率變化 {trend['backing_ratio_trend']['change']:.1%}\"\n            })\n\n    return alerts\n```\n\n## Step 5: 央行行為追蹤\n\n特別關注央行的黃金買賣行為：\n\n```python\ndef track_central_bank_activity(history):\n    \"\"\"追蹤各央行的黃金購買/出售行為\"\"\"\n    activity = []\n\n    for entity in params[\"entities\"]:\n        gold_history = history[entity][\"gold_tonnes\"]\n        latest_change = gold_history.iloc[-1] - gold_history.iloc[-2]\n\n        if abs(latest_change) > 5:  # 超過 5 噸的變化\n            activity.append({\n                \"entity\": entity,\n                \"action\": \"BUY\" if latest_change > 0 else \"SELL\",\n                \"tonnes\": abs(latest_change),\n                \"date\": gold_history.index[-1],\n                \"interpretation\": interpret_cb_action(entity, latest_change)\n            })\n\n    return activity\n```\n\n## Step 6: 生成監控報告\n\n```python\nreport = {\n    \"skill\": \"usd-reserve-loss-gold-revaluation\",\n    \"mode\": \"monitor\",\n    \"as_of\": \"2026-01-07\",\n    \"lookback_period\": \"1Y\",\n\n    \"current_snapshot\": {\n        \"headline_implied_price\": 39210.0,\n        \"gold_spot\": 2050.0,\n        \"entity_metrics\": current_metrics\n    },\n\n    \"trends\": {\n        \"headline_change_1y\": \"+5.2%\",\n        \"avg_backing_ratio_change\": \"-2.1%\",\n        \"gold_reserve_change_total\": \"+285 tonnes\"\n    },\n\n    \"alerts\": alerts,\n\n    \"central_bank_activity\": activity,\n\n    \"insights\": [\n        \"過去一年中國央行持續增持黃金，累計 +225 噸\",\n        \"日本黃金支撐率持續下降，從 3.5% 降至 3.0%\",\n        \"全球央行淨買入黃金 1050 噸，為連續第 N 年淨買入\"\n    ],\n\n    \"next_update\": {\n        \"gold_reserves\": \"2026-02-15 (WGC monthly)\",\n        \"bis_survey\": \"2025 (next triennial)\"\n    }\n}\n```\n\n## Step 7: 輸出與通知\n\n```bash\npython scripts/gold_revaluation.py \\\n  --monitor \\\n  --lookback 1Y \\\n  --output monitor_report.json\n```\n\n可選：設定定期執行\n\n```bash\n# cron job 範例（每月執行一次）\n0 9 1 * * python /path/to/gold_revaluation.py --monitor >> /var/log/gold_monitor.log\n```\n\n</process>\n\n<success_criteria>\n監控報告完成時應產出：\n\n- [ ] 當前快照（隱含金價、支撐率）\n- [ ] 歷史趨勢（選定週期內的變化）\n- [ ] 重大變化警報（若有）\n- [ ] 央行行為追蹤\n- [ ] 監控洞察（至少 3 點）\n- [ ] 下次數據更新時間\n</success_criteria>\n",
        "skills/wasde-ingestor/SKILL.md": "---\nname: wasde-ingestor\ndescription: 下載並解析 USDA 每月發布的 WASDE 報告，擷取所有主要商品（穀物、油籽、棉花、畜產品、糖）的供需平衡表。輸出標準化、可版本化的資料集，作為即時預測（nowcasting）的錨定基準。\n---\n\n<essential_principles>\n**WASDE Ingestor 核心原則**\n\n**1. 商品範圍**\n\nWASDE 涵蓋三大類商品，每類有不同的表格結構與單位：\n\n| 類別      | 商品                                     | US 單位                   | World 單位           |\n|-----------|------------------------------------------|---------------------------|----------------------|\n| Grains    | Wheat, Corn, Rice, Barley, Sorghum, Oats | million bushels / cwt     | million metric tons  |\n| Oilseeds  | Soybeans, Soybean Oil, Soybean Meal      | million bushels / pounds  | million metric tons  |\n| Cotton    | Upland, Pima                             | million 480-lb bales      | million 480-lb bales |\n| Livestock | Beef, Pork, Poultry, Eggs, Dairy         | million lbs / dozen / lbs | - (US only)          |\n| Sugar     | Sugar                                    | 1,000 short tons          | - (US + Mexico only) |\n\n**2. 表格結構一致性**\n\n所有供需表遵循相同的平衡公式：\n```\nEnding Stocks = Beginning Stocks + Production + Imports - Total Use - Exports\n```\n\n**3. 版本控制**\n\n- 每月報告可能修正前期數據\n- 使用 `content_hash` 追蹤數據變化\n- 保留 `revision_flag` 標記修正值\n\n**4. 解析優先級**\n\n1. PDF 結構化解析（優先）\n2. HTML 表格解析（fallback）\n3. TXT 固定寬度解析（legacy）\n</essential_principles>\n\n<intake>\n**您想要執行什麼操作？**\n\n1. **Ingest** - 抓取並解析最新或指定月份的 WASDE 報告\n2. **Backfill** - 批量回補歷史 WASDE 數據\n3. **Validate** - 驗證現有數據與最新報告的一致性\n4. **Configure** - 配置商品範圍、輸出路徑等參數\n\n**等待回應後再繼續。**\n</intake>\n\n<routing>\n| Response                                | Workflow               | Description         |\n|-----------------------------------------|------------------------|---------------------|\n| 1, \"ingest\", \"fetch\", \"parse\", \"latest\" | workflows/ingest.md    | 抓取解析 WASDE 報告 |\n| 2, \"backfill\", \"historical\", \"batch\"    | workflows/backfill.md  | 批量回補歷史數據    |\n| 3, \"validate\", \"check\", \"verify\"        | workflows/validate.md  | 驗證數據一致性      |\n| 4, \"configure\", \"config\", \"setup\"       | workflows/configure.md | 配置參數            |\n\n**讀取工作流程後，請完全遵循其步驟。**\n</routing>\n\n<reference_index>\n**商品參考文件** (`references/`)\n\n| 文件                    | 內容                                               |\n|-------------------------|----------------------------------------------------|\n| commodities-overview.md | 所有商品總覽與單位對照                             |\n| grains.md               | 穀物類（Wheat, Corn, Rice, Barley, Sorghum, Oats） |\n| oilseeds.md             | 油籽類（Soybeans, Soybean Oil, Soybean Meal）      |\n| cotton.md               | 棉花（US & World）                                 |\n| livestock.md            | 畜產品（Beef, Pork, Poultry, Eggs, Dairy）         |\n| sugar.md                | 糖（US & Mexico）                                  |\n| validation-rules.md     | 驗證規則與合理性檢查                               |\n| failure-modes.md        | 失敗模式與緩解策略                                 |\n</reference_index>\n\n<workflows_index>\n| Workflow     | Purpose                       |\n|--------------|-------------------------------|\n| ingest.md    | 抓取解析單一或多個 WASDE 報告 |\n| backfill.md  | 批量回補歷史數據              |\n| validate.md  | 驗證數據一致性與修正追蹤      |\n| configure.md | 配置商品範圍與輸出設定        |\n</workflows_index>\n\n<templates_index>\n| Template                  | Purpose             |\n|---------------------------|---------------------|\n| config.yaml               | 標準配置文件模板    |\n| us-balance-schema.yaml    | US 供需表 schema    |\n| world-balance-schema.yaml | World 供需表 schema |\n</templates_index>\n\n<scripts_index>\n| Script               | Purpose                   |\n|----------------------|---------------------------|\n| discover_releases.py | 發現 WASDE 發布日期與 URL |\n| fetch_report.py      | 下載 PDF/HTML 報告        |\n| parse_tables.py      | 解析表格提取數據          |\n| validate_data.py     | 執行驗證檢查              |\n</scripts_index>\n\n<examples_index>\n**範例輸出** (`examples/`)\n\n| 文件                       | 內容                   |\n|----------------------------|------------------------|\n| corn_us_balance.json       | 美國玉米供需平衡表範例 |\n| wheat_world_balance.json   | 世界小麥供需平衡表範例 |\n| ingest_status_success.json | 成功執行的狀態報告範例 |\n| backfill_result.json       | 批量回補作業結果範例   |\n</examples_index>\n\n<quick_start>\n**CLI 快速開始：**\n\n```bash\n# 抓取最新報告的所有商品\nmacro-skills wasde ingest --commodities=all --out=./data\n\n# 只抓取穀物類\nmacro-skills wasde ingest --commodities=grains --out=./data\n\n# 回補過去 24 個月的大豆數據\nmacro-skills wasde backfill --commodity=soybeans --months=24 --out=./data\n\n# 驗證現有數據\nmacro-skills wasde validate --data-dir=./data\n```\n\n**Library 快速開始：**\n\n```python\nfrom macro_skills.wasde import WASDEIngestor\n\ningestor = WASDEIngestor(\n    commodities=[\"wheat\", \"corn\", \"soybeans\"],\n    scope=[\"us\", \"world\"],\n    output_dir=\"./data/wasde\"\n)\n\nresult = ingestor.ingest_latest()\nprint(result.status)\n```\n</quick_start>\n\n<success_criteria>\nSkill 成功執行時：\n- [ ] 正確識別商品類別與對應表格\n- [ ] 解析所有指定商品的供需數據\n- [ ] 單位正確轉換與標記\n- [ ] 通過平衡公式驗證\n- [ ] 輸出標準化 parquet 數據集\n- [ ] 生成 ingest_status 報告\n</success_criteria>\n\n<detailed_usage_examples>\n**詳細使用範例**\n\n**範例 1：抓取最新玉米與大豆數據**\n```\nUser: 幫我抓取最新 WASDE 的玉米和大豆供需數據\n\nAssistant 執行步驟:\n1. 讀取 workflows/ingest.md\n2. 呼叫 discover_releases.py 找到最新發布 (2025-01-10)\n3. 下載 PDF 報告\n4. 解析 corn_us, corn_world, soybeans_us, soybeans_world 表格\n5. 驗證平衡公式\n6. 輸出 parquet 檔案\n7. 回報 ingest_status\n\n預期輸出:\n- ./data/wasde/curated/corn_us_balance.parquet\n- ./data/wasde/curated/corn_world_balance.parquet\n- ./data/wasde/curated/soybeans_us_balance.parquet\n- ./data/wasde/curated/soybeans_world_balance.parquet\n```\n\n**範例 2：回補歷史小麥數據並追蹤修正**\n```\nUser: 回補過去 12 個月的小麥數據，我想追蹤 USDA 的修正歷程\n\nAssistant 執行步驟:\n1. 讀取 workflows/backfill.md\n2. 確定日期範圍 (2024-01 至 2024-12)\n3. 依序處理 12 期報告\n4. 比對每期數據，標記修正值\n5. 輸出包含 revision_flag 的完整歷史數據\n\n預期輸出:\n- 12 期小麥數據\n- 修正追蹤報告\n```\n\n**範例 3：驗證現有數據一致性**\n```\nUser: 檢查我現有的 WASDE 數據是否與最新報告一致\n\nAssistant 執行步驟:\n1. 讀取 workflows/validate.md\n2. 載入現有 parquet 檔案\n3. 抓取最新報告\n4. 逐欄位比對\n5. 標記差異與修正\n6. 輸出驗證報告\n\n預期輸出:\n- validation_report.json (差異列表)\n- 修正建議\n```\n</detailed_usage_examples>\n\n<data_pipeline_architecture>\n**數據流水線架構**\n\n```\n[USDA WASDE Website]\n         |\n         v\n+-------------------+\n| discover_releases |  --> 找到 PDF URL 與發布日期\n+-------------------+\n         |\n         v\n+-------------------+\n|   fetch_report    |  --> 下載 PDF (fallback: HTML)\n+-------------------+\n         |\n         v\n+-------------------+\n|   parse_tables    |  --> 提取供需表格數據\n+-------------------+\n         |\n         v\n+-------------------+\n|   normalize_data  |  --> 標準化欄位與單位\n+-------------------+\n         |\n         v\n+-------------------+\n|   validate_data   |  --> 平衡公式與範圍檢查\n+-------------------+\n         |\n         v\n+-------------------+\n|   write_output    |  --> Parquet / JSON\n+-------------------+\n         |\n         v\n[Curated Dataset]\n```\n\n**目錄結構：**\n```\ndata/wasde/\n├── raw/                    # 原始 PDF 檔案\n│   └── 2025-01-10/\n│       └── wasde0125.pdf\n├── intermediate/           # 中間解析結果\n│   └── 2025-01-10/\n│       ├── tables.json\n│       └── ingest_status.json\n└── curated/                # 最終標準化數據\n    ├── corn_us_balance.parquet\n    ├── corn_world_balance.parquet\n    ├── wheat_us_balance.parquet\n    └── ...\n```\n</data_pipeline_architecture>\n",
        "skills/wasde-ingestor/references/commodities-overview.md": "<overview>\nWASDE (World Agricultural Supply and Demand Estimates) 是 USDA 每月發布的全球農產品供需預測報告。本文件提供所有涵蓋商品的總覽與單位對照。\n</overview>\n\n<commodity_categories>\n**商品類別總覽**\n\n| 類別 | 英文 | 商品數量 | 涵蓋範圍 |\n|------|------|----------|----------|\n| 穀物 | Grains | 6 | US + World |\n| 油籽 | Oilseeds | 3 | US + World |\n| 棉花 | Cotton | 1 | US + World |\n| 畜產品 | Livestock | 5 | US only |\n| 糖 | Sugar | 1 | US + Mexico |\n</commodity_categories>\n\n<grains_summary>\n**穀物類 (Grains)**\n\n| 商品 | 英文 | US 單位 | World 單位 | 行銷年度 (US) | 行銷年度 (World) |\n|------|------|---------|------------|---------------|------------------|\n| 小麥 | Wheat | million bushels | million metric tons | Jun-May | Jul-Jun |\n| 玉米 | Corn | million bushels | million metric tons | Sep-Aug | Oct-Sep |\n| 稻米 | Rice | million cwt | million metric tons | Aug-Jul | Jan-Dec |\n| 大麥 | Barley | million bushels | million metric tons | Jun-May | Jul-Jun |\n| 高粱 | Sorghum | million bushels | million metric tons | Sep-Aug | Oct-Sep |\n| 燕麥 | Oats | million bushels | million metric tons | Jun-May | Jul-Jun |\n\n**小麥 by-class 細分：**\n- Hard Red Winter (HRW)\n- Hard Red Spring (HRS)\n- Soft Red Winter (SRW)\n- White\n- Durum\n\n**稻米細分：**\n- Long-grain\n- Medium/Short-grain\n</grains_summary>\n\n<oilseeds_summary>\n**油籽類 (Oilseeds)**\n\n| 商品 | 英文 | US 單位 | World 單位 | 行銷年度 |\n|------|------|---------|------------|----------|\n| 大豆 | Soybeans | million bushels | million metric tons | Sep-Aug (US), Oct-Sep (World) |\n| 豆油 | Soybean Oil | million pounds | million metric tons | Oct-Sep |\n| 豆粕 | Soybean Meal | thousand short tons | million metric tons | Oct-Sep |\n\n**World 主要生產國單獨列出：**\n- Argentina\n- Brazil\n- China\n- United States\n- Paraguay\n- Others\n</oilseeds_summary>\n\n<cotton_summary>\n**棉花 (Cotton)**\n\n| 商品 | 英文 | 單位 | 行銷年度 |\n|------|------|------|----------|\n| 陸地棉 | Upland Cotton | million 480-lb bales | Aug-Jul |\n| 匹馬棉 | Pima (ELS) Cotton | million 480-lb bales | Aug-Jul |\n\n**World 主要生產國：**\n- United States\n- China\n- India\n- Brazil\n- Pakistan\n- Others\n</cotton_summary>\n\n<livestock_summary>\n**畜產品 (Livestock) - 僅美國**\n\n| 商品 | 英文 | 單位 | 年度 |\n|------|------|------|------|\n| 牛肉 | Beef | million pounds (carcass weight) | Calendar Year |\n| 豬肉 | Pork | million pounds (carcass weight) | Calendar Year |\n| 禽肉 | Broiler | million pounds (ready-to-cook) | Calendar Year |\n| 火雞 | Turkey | million pounds (ready-to-cook) | Calendar Year |\n| 雞蛋 | Eggs | million dozen | Calendar Year |\n| 乳製品 | Dairy/Milk | billion pounds | Calendar Year |\n\n**畜產品特殊欄位：**\n- Commercial Production\n- Farm Production\n- Imports\n- Exports\n- Per Capita Consumption\n</livestock_summary>\n\n<sugar_summary>\n**糖 (Sugar)**\n\n| 商品 | 英文 | 單位 | 年度 | 涵蓋範圍 |\n|------|------|------|------|----------|\n| 糖 | Sugar | 1,000 short tons (raw value) | Oct-Sep | US + Mexico |\n\n**US 糖細分：**\n- Beet Sugar\n- Cane Sugar (Florida, Louisiana, Texas, Hawaii)\n- Refined Sugar Imports\n</sugar_summary>\n\n<unit_conversions>\n**單位轉換參考**\n\n| 單位 | 縮寫 | 換算 |\n|------|------|------|\n| bushel (wheat) | bu | 1 bu = 27.216 kg |\n| bushel (corn) | bu | 1 bu = 25.401 kg |\n| bushel (soybeans) | bu | 1 bu = 27.216 kg |\n| bushel (barley) | bu | 1 bu = 21.772 kg |\n| hundredweight | cwt | 1 cwt = 45.359 kg |\n| short ton | st | 1 st = 907.185 kg |\n| metric ton | mt | 1 mt = 1,000 kg |\n| 480-lb bale | bale | 1 bale = 217.724 kg |\n</unit_conversions>\n\n<marketing_year_calendar>\n**行銷年度日曆**\n\n```\n       Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec\nWheat  [------US MY------][------US MY------]\n       [-------World MY-------][-------World MY-------]\n\nCorn   [--prev MY--][--------US MY--------]\n       [--prev MY---][--------World MY--------]\n\nSoy    [--prev MY--][--------US MY--------]\n       [--prev MY---][--------World MY--------]\n\nRice   [----US MY----][----US MY----]\n       [World MY = Calendar Year]\n\nCotton [-------MY-------][-------MY-------]\n```\n\n**注意：** 不同商品的行銷年度起始月不同，需特別注意時間序列對齊。\n</marketing_year_calendar>\n\n<data_sources>\n**數據來源**\n\n| 來源 | URL | 說明 |\n|------|-----|------|\n| WASDE 官網 | https://www.usda.gov/oce/commodity/wasde | 最新報告 |\n| NAL 歷史檔案 | https://esmis.nal.usda.gov/ | 1973 年至今 |\n| Cornell Library | https://usda.library.cornell.edu/concern/publications/3t945q76s | 備份檔案 |\n| ERS Projections | https://www.ers.usda.gov/topics/farm-economy/commodity-outlook/ | 快速查詢 |\n| FAS PSD Online | https://apps.fas.usda.gov/psdonline/ | 詳細國別數據 |\n</data_sources>\n",
        "skills/wasde-ingestor/references/cotton.md": "<overview>\n棉花 (Cotton) 是 WASDE 報告涵蓋的重要纖維作物。本文件詳細說明 US 與 World 棉花表格的結構、欄位映射與解析規則。\n</overview>\n\n<cotton_types>\n**棉花類型**\n\n| 類型 | 英文 | 說明 |\n|------|------|------|\n| 陸地棉 | Upland Cotton | 占美國產量 97%，主要短纖維棉 |\n| 匹馬棉 | Pima / ELS Cotton | Extra Long Staple，高品質長纖維棉 |\n| 全棉花 | All Cotton | Upland + Pima 合計 |\n</cotton_types>\n\n<us_cotton>\n**US 棉花供需**\n\n**表格名稱搜尋：**\n```yaml\nus_tables:\n  - \"U.S. Cotton Supply and Use\"\n  - \"Cotton: U.S. Supply and Use\"\n  - \"U.S. Upland Cotton Supply and Use\"\n  - \"U.S. All Cotton Supply and Use\"\n\nus_pima_tables:\n  - \"U.S. Pima Cotton Supply and Use\"\n  - \"U.S. Extra-Long Staple Cotton Supply and Use\"\n```\n\n**US 欄位映射：**\n```yaml\nfields_map:\n  area_planted: [\"Area Planted\"]\n  area_harvested: [\"Area Harvested\"]\n  yield: [\"Yield per Harvested Acre\"]\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  supply_total: [\"Supply, Total\", \"Total Supply\"]\n  mill_use: [\"Mill Use\", \"Domestic Mill Use\"]\n  exports: [\"Exports\"]\n  use_total: [\"Use, Total\", \"Total Use\"]\n  unaccounted: [\"Unaccounted\"]\n  ending_stocks: [\"Ending Stocks\"]\n  avg_farm_price: [\"Avg. Farm Price\", \"Upland Farm Price\"]\n  a_index: [\"A Index\", \"Cotlook A Index\"]\n```\n\n**區域細分（可選）：**\n```yaml\nregions:\n  southeast: [\"Southeast\", \"GA\", \"NC\", \"SC\", \"VA\", \"AL\"]\n  delta: [\"Delta\", \"MS\", \"AR\", \"LA\", \"TN\", \"MO\"]\n  southwest: [\"Southwest\", \"TX\", \"OK\", \"KS\"]\n  west: [\"West\", \"CA\", \"AZ\", \"NM\"]\n```\n\n**單位：**\n- 面積: million acres\n- 產量: million 480-lb bales\n- 單產: pounds/acre\n- 價格: cents/pound\n\n**行銷年度：** August 1 - July 31\n</us_cotton>\n\n<world_cotton>\n**World 棉花供需**\n\n**表格名稱搜尋：**\n```yaml\nworld_tables:\n  - \"World Cotton Supply and Use\"\n  - \"Cotton: World Supply and Use\"\n  - \"World Cotton Supply and Distribution\"\n```\n\n**World 欄位映射：**\n```yaml\nfields_map:\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  mill_use: [\"Mill Use\", \"Mill Consumption\"]\n  exports: [\"Exports\"]\n  loss_adjustment: [\"Loss Adjustment\", \"Statistical Discrepancy\"]\n  ending_stocks: [\"Ending Stocks\"]\n  stocks_to_use: [\"Stocks-to-Use Ratio\"]\n```\n\n**主要生產國：**\n```yaml\nmajor_producers:\n  - india: [\"India\"]\n  - china: [\"China\"]\n  - united_states: [\"United States\", \"USA\"]\n  - brazil: [\"Brazil\"]\n  - pakistan: [\"Pakistan\"]\n  - australia: [\"Australia\"]\n  - turkey: [\"Turkey\"]\n  - uzbekistan: [\"Uzbekistan\"]\n```\n\n**主要消費國（Mill Use）：**\n```yaml\nmajor_consumers:\n  - china: [\"China\"]  # 全球最大\n  - india: [\"India\"]\n  - pakistan: [\"Pakistan\"]\n  - bangladesh: [\"Bangladesh\"]\n  - vietnam: [\"Vietnam\"]\n  - turkey: [\"Turkey\"]\n```\n\n**主要出口國：**\n```yaml\nmajor_exporters:\n  - united_states: [\"United States\"]\n  - brazil: [\"Brazil\"]\n  - australia: [\"Australia\"]\n  - india: [\"India\"]\n```\n\n**單位：**\n- 產量/消費/庫存: million 480-lb bales\n- Stocks-to-Use: percentage\n\n**行銷年度：** August 1 - July 31 (全球統一)\n</world_cotton>\n\n<price_indices>\n**棉花價格指標**\n\n| 指標 | 說明 | 單位 |\n|------|------|------|\n| Upland Farm Price | 美國陸地棉農場價格 | cents/lb |\n| Cotlook A Index | 全球遠東交貨價格指標 | cents/lb |\n| ICE Cotton #2 | 紐約棉花期貨 | cents/lb |\n| CC Index | 中國棉花指數 | CNY/ton |\n\n**A Index 與 Farm Price 關係：**\n- A Index 通常高於 Farm Price\n- 價差反映運輸、品質溢價\n</price_indices>\n\n<validation_rules>\n**棉花驗證規則**\n\n**平衡公式：**\n```\nEnding Stocks = Beginning Stocks + Production + Imports - Mill Use - Exports - Loss\n```\n\n**US 合理性範圍 (million 480-lb bales)：**\n```yaml\nupland:\n  production: [10, 20]\n  mill_use: [2, 4]\n  exports: [10, 18]\n  ending_stocks: [2, 8]\n\npima:\n  production: [0.3, 1.0]\n  mill_use: [0.1, 0.3]\n  exports: [0.3, 0.8]\n```\n\n**World 合理性範圍 (million 480-lb bales)：**\n```yaml\nworld:\n  production: [100, 130]\n  mill_use: [100, 130]\n  ending_stocks: [70, 110]\n  stocks_to_use: [60, 100]  # percentage\n\nchina:\n  production: [25, 35]\n  mill_use: [35, 45]\n  imports: [5, 15]\n  ending_stocks: [30, 50]\n\nindia:\n  production: [25, 35]\n  mill_use: [20, 30]\n```\n\n**特殊檢查：**\n- World Mill Use ≈ World Production (長期)\n- China Imports ≈ China Mill Use - China Production\n- US Exports 占 World Trade 約 30-40%\n</validation_rules>\n\n<seasonal_patterns>\n**棉花季節性模式**\n\n| 月份 | 北半球 | 南半球 |\n|------|--------|--------|\n| 1-3月 | 淡季 | 收成 (Brazil, Australia) |\n| 4-6月 | 種植 | 淡季 |\n| 7-9月 | 生長 | 淡季 |\n| 10-12月 | 收成 (US) | 種植 |\n\n**關鍵報告月份：**\n- 5月 WASDE: 首次發布新年度預測\n- 8月 WASDE: 首次產量預估\n- 1月 WASDE: 最終產量確認\n</seasonal_patterns>\n",
        "skills/wasde-ingestor/references/failure-modes.md": "<overview>\n本文件定義 WASDE Ingestor 可能遇到的失敗模式及其緩解策略。\n</overview>\n\n<failure_categories>\n**失敗模式分類**\n\n| 類別 | 說明 | 嚴重程度 |\n|------|------|----------|\n| Network | 網路連線問題 | Low |\n| Parse | PDF/HTML 解析失敗 | Medium |\n| Schema | 表格結構變化 | High |\n| Validation | 數據驗證失敗 | Medium |\n| System | 系統資源問題 | Low |\n</failure_categories>\n\n<network_failures>\n**Network 失敗模式**\n\n**F001: Connection Timeout**\n```yaml\nid: F001\nsymptom: \"連線 USDA 網站超時\"\ncauses:\n  - USDA 伺服器負載過高（發布日當天）\n  - 網路不穩定\n  - 防火牆阻擋\n\nmitigation:\n  - retry:\n      max_attempts: 5\n      backoff: [1, 2, 4, 8, 16]  # exponential backoff\n  - alternative_source:\n      - \"https://usda.library.cornell.edu/\"\n      - \"https://esmis.nal.usda.gov/\"\n\nrecovery:\n  - \"等待 5-10 分鐘後重試\"\n  - \"使用備用數據源\"\n```\n\n**F002: HTTP 404 Not Found**\n```yaml\nid: F002\nsymptom: \"報告 URL 返回 404\"\ncauses:\n  - URL 結構變更\n  - 報告尚未發布\n  - 檔案名稱格式改變\n\nmitigation:\n  - discover_url:\n      description: \"重新發現報告 URL\"\n      pattern: \"/wasde/wasde{YYMM}.pdf\"\n  - check_release_calendar:\n      url: \"https://www.usda.gov/oce/commodity/wasde\"\n\nrecovery:\n  - \"確認發布日期是否正確\"\n  - \"嘗試不同的 URL pattern\"\n```\n\n**F003: SSL Certificate Error**\n```yaml\nid: F003\nsymptom: \"SSL 憑證驗證失敗\"\ncauses:\n  - 憑證過期\n  - 中間人攻擊（罕見）\n  - 本地時間錯誤\n\nmitigation:\n  - verify_ssl: true  # 不要關閉 SSL 驗證\n  - check_system_time: true\n  - use_alternative_source: true\n\nrecovery:\n  - \"檢查系統時間是否正確\"\n  - \"更新 CA 憑證\"\n```\n</network_failures>\n\n<parse_failures>\n**Parse 失敗模式**\n\n**F101: PDF Layout Break**\n```yaml\nid: F101\nsymptom: \"PDF 解析返回斷裂欄位或合併列\"\ncauses:\n  - PDF 生成工具變更\n  - 表格跨頁\n  - 特殊字元\n\nmitigation:\n  - fallback_parser:\n      order: [\"pdfplumber\", \"camelot\", \"tabula\"]\n  - html_fallback:\n      enabled: true\n      url_pattern: \"https://www.usda.gov/oce/commodity/wasde/\"\n  - row_reconstruction:\n      description: \"啟發式列重建\"\n      enabled: true\n\nrecovery:\n  - \"嘗試不同的 PDF 解析器\"\n  - \"切換到 HTML 解析\"\n  - \"人工檢查並標記異常\"\n\ndiagnostics:\n  output:\n    - \"raw_extraction.json\"\n    - \"problematic_pages.txt\"\n```\n\n**F102: Table Not Found**\n```yaml\nid: F102\nsymptom: \"找不到指定的表格\"\ncauses:\n  - 表格標題變更\n  - 表格被移除\n  - 頁碼變化\n\nmitigation:\n  - fuzzy_match:\n      enabled: true\n      threshold: 0.8  # 80% 相似度\n      aliases:\n        - \"U.S. Soybeans Supply and Use\"\n        - \"Soybeans: U.S. Supply and Use\"\n        - \"US SOYBEANS SUPPLY AND USE\"\n  - page_scan:\n      description: \"掃描所有頁面尋找表格\"\n      enabled: true\n\nrecovery:\n  - \"使用模糊匹配搜尋\"\n  - \"記錄失敗並通知維護者\"\n\ndiagnostics:\n  output:\n    - \"available_tables.json\"\n    - \"search_log.txt\"\n```\n\n**F103: Column Mismatch**\n```yaml\nid: F103\nsymptom: \"欄位數量或名稱與預期不符\"\ncauses:\n  - USDA 新增或刪除欄位\n  - 欄位重命名\n  - 表格格式調整\n\nmitigation:\n  - flexible_mapping:\n      enabled: true\n      strategy: \"best_effort\"\n  - column_aliases:\n      use_aliases: true\n      warn_on_missing: true\n\nrecovery:\n  - \"使用欄位別名映射\"\n  - \"記錄新增/刪除的欄位\"\n  - \"更新欄位映射配置\"\n\ndiagnostics:\n  output:\n    - \"column_diff.json\"\n    - \"mapping_result.json\"\n```\n\n**F104: Numeric Parse Error**\n```yaml\nid: F104\nsymptom: \"數值解析失敗\"\ncauses:\n  - 千分位符號（1,234 vs 1234）\n  - 負數表示法（(100) vs -100）\n  - 特殊值（N/A, -, *)\n\nmitigation:\n  - number_patterns:\n      thousands_sep: [\",\", \" \"]\n      decimal_sep: [\".\"]\n      negative_formats: [\"()\", \"-\", \"−\"]\n      null_values: [\"N/A\", \"-\", \"*\", \"--\", \"n.a.\"]\n\nrecovery:\n  - \"嘗試多種數值格式\"\n  - \"將無法解析的值標記為 null\"\n```\n</parse_failures>\n\n<schema_failures>\n**Schema 失敗模式**\n\n**F201: Schema Drift**\n```yaml\nid: F201\nsymptom: \"表格結構與基準不同\"\nseverity: high\ncauses:\n  - USDA 調整報告格式\n  - 新增商品或細分\n  - 合併或刪除表格\n\ndetection:\n  - schema_hash_check: true\n  - column_count_check: true\n  - column_name_check: true\n\nmitigation:\n  - on_minor_drift:  # 新增欄位\n      action: \"warn_and_continue\"\n      include_new_columns: true\n  - on_major_drift:  # 刪除或重命名\n      action: \"fail_with_report\"\n      create_issue: true\n\nrecovery:\n  - \"檢查 USDA 公告是否有格式變更說明\"\n  - \"更新欄位映射配置\"\n  - \"開立 GitHub issue 追蹤\"\n\ndiagnostics:\n  output:\n    - \"schema_diff_report.json\"\n    - \"migration_guide.md\"\n```\n\n**F202: Marketing Year Format Change**\n```yaml\nid: F202\nsymptom: \"行銷年度格式變更\"\ncauses:\n  - \"2024/25\" → \"24/25\"\n  - \"2024-25\" → \"2024/25\"\n\nmitigation:\n  - flexible_parsing:\n      patterns:\n        - \"\\\\d{4}/\\\\d{2}\"   # 2024/25\n        - \"\\\\d{2}/\\\\d{2}\"   # 24/25\n        - \"\\\\d{4}-\\\\d{2}\"   # 2024-25\n        - \"\\\\d{4}\"          # 2024\n\nrecovery:\n  - \"嘗試多種格式解析\"\n  - \"標準化為 YYYY/YY 格式\"\n```\n</schema_failures>\n\n<validation_failures>\n**Validation 失敗模式**\n\n**F301: Balance Check Failed**\n```yaml\nid: F301\nsymptom: \"供需平衡公式驗證失敗\"\ncauses:\n  - 解析錯誤\n  - 統計殘差超出預期\n  - 單位錯誤\n\nmitigation:\n  - tolerance_adjustment:\n      default: 1.0\n      allow_override: true\n  - residual_handling:\n      include_residual: true\n      max_residual_pct: 5.0\n\nrecovery:\n  - \"檢查是否有遺漏的欄位\"\n  - \"調整容許誤差\"\n  - \"人工檢查原始報告\"\n\ndiagnostics:\n  output:\n    - \"balance_check_details.json\"\n```\n\n**F302: Value Out of Range**\n```yaml\nid: F302\nsymptom: \"數值超出合理範圍\"\ncauses:\n  - 解析錯誤（小數點位置）\n  - 單位錯誤\n  - 實際異常值\n\nmitigation:\n  - range_check:\n      mode: \"warn\"  # warn | fail | skip\n      log_anomalies: true\n  - historical_comparison:\n      enabled: true\n      z_score_threshold: 3.0\n\nrecovery:\n  - \"與歷史數據比較\"\n  - \"檢查單位是否正確\"\n  - \"標記為待人工確認\"\n```\n\n**F303: Partial Data**\n```yaml\nid: F303\nsymptom: \"部分數據缺失\"\ncauses:\n  - 只找到 US 表格，缺少 World\n  - 部分商品解析失敗\n\nmitigation:\n  - partial_output:\n      enabled: true\n      when: \"scope_allows\"  # 當配置允許部分輸出\n  - fail_if_required:\n      check_scope: true\n\nrecovery:\n  - \"輸出可用數據並標記缺失\"\n  - \"或根據配置完全失敗\"\n```\n</validation_failures>\n\n<system_failures>\n**System 失敗模式**\n\n**F401: Disk Space**\n```yaml\nid: F401\nsymptom: \"磁碟空間不足\"\nmitigation:\n  - pre_check:\n      min_free_space_mb: 500\n  - cleanup:\n      remove_temp_files: true\n      compress_old_reports: true\n```\n\n**F402: Memory Error**\n```yaml\nid: F402\nsymptom: \"記憶體不足\"\nmitigation:\n  - streaming_parse:\n      enabled: true\n      chunk_size: 1000\n  - gc_aggressive:\n      enabled: true\n```\n\n**F403: Permission Denied**\n```yaml\nid: F403\nsymptom: \"檔案寫入權限不足\"\nmitigation:\n  - pre_check:\n      test_write: true\n  - fallback_dir:\n      use_temp: true\n```\n</system_failures>\n\n<error_handling_strategy>\n**錯誤處理策略**\n\n```python\nclass IngestError(Exception):\n    def __init__(self, error_id, message, recoverable=True, diagnostics=None):\n        self.error_id = error_id\n        self.message = message\n        self.recoverable = recoverable\n        self.diagnostics = diagnostics or {}\n\ndef handle_error(error: IngestError, config):\n    \"\"\"統一錯誤處理\"\"\"\n\n    # 記錄錯誤\n    log_error(error)\n\n    # 輸出診斷資訊\n    if error.diagnostics:\n        write_diagnostics(error.diagnostics, config.output_dir)\n\n    # 根據可恢復性決定行為\n    if error.recoverable and config.allow_partial:\n        return {\"status\": \"partial\", \"error\": error}\n    else:\n        raise error\n```\n\n**重試配置：**\n```yaml\nretry_config:\n  network_errors: [F001, F002, F003]\n  max_retries: 5\n  backoff_strategy: \"exponential\"\n  initial_delay_seconds: 1\n\n  parse_errors: [F101, F102, F103, F104]\n  max_retries: 2\n  fallback_enabled: true\n\n  schema_errors: [F201, F202]\n  max_retries: 0  # 不重試，直接報告\n  create_issue: true\n\n  validation_errors: [F301, F302, F303]\n  max_retries: 0\n  allow_partial: true\n```\n</error_handling_strategy>\n",
        "skills/wasde-ingestor/references/grains.md": "<overview>\n穀物類 (Grains) 是 WASDE 報告的核心內容，包含小麥、玉米、稻米、大麥、高粱、燕麥。本文件詳細說明各穀物的表格結構、欄位映射與解析規則。\n</overview>\n\n<wheat>\n**小麥 (Wheat)**\n\n**表格名稱搜尋：**\n```yaml\nus_tables:\n  - \"U.S. Wheat Supply and Use\"\n  - \"Wheat: U.S. Supply and Use\"\n  - \"U.S. Wheat Supply and Disappearance\"\n\nus_by_class_tables:\n  - \"U.S. Wheat Supply and Use by Class\"\n  - \"Wheat by Class: U.S. Supply and Use\"\n\nworld_tables:\n  - \"World Wheat Supply and Use\"\n  - \"Wheat: World Supply and Use\"\n```\n\n**US 欄位映射：**\n```yaml\nfields_map:\n  beginning_stocks: [\"Beginning Stocks\", \"Beg. Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  supply_total: [\"Supply, Total\", \"Total Supply\"]\n  food: [\"Food\"]\n  seed: [\"Seed\"]\n  feed_and_residual: [\"Feed and Residual\", \"Feed & Residual\"]\n  domestic_total: [\"Domestic, Total\", \"Total Domestic\"]\n  exports: [\"Exports\"]\n  use_total: [\"Use, Total\", \"Total Use\"]\n  ending_stocks: [\"Ending Stocks\"]\n  avg_farm_price: [\"Avg. Farm Price\", \"Season-Average Farm Price\"]\n```\n\n**US by-class 欄位：**\n```yaml\nwheat_classes:\n  - hard_red_winter: [\"Hard Red Winter\", \"HRW\"]\n  - hard_red_spring: [\"Hard Red Spring\", \"HRS\"]\n  - soft_red_winter: [\"Soft Red Winter\", \"SRW\"]\n  - white: [\"White\"]\n  - durum: [\"Durum\"]\n\nby_class_fields:\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  food: [\"Food\"]\n  seed: [\"Seed\"]\n  feed_and_residual: [\"Feed and Residual\"]\n  exports: [\"Exports\"]\n  ending_stocks: [\"Ending Stocks\"]\n```\n\n**World 欄位映射：**\n```yaml\nfields_map:\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  supply_total: [\"Supply\"]\n  domestic_use: [\"Domestic Use\", \"Dom. Consumption\"]\n  exports: [\"Exports\"]\n  use_total: [\"Use, Total\"]\n  ending_stocks: [\"Ending Stocks\"]\n\nmajor_exporters:\n  - united_states\n  - canada\n  - european_union\n  - australia\n  - argentina\n  - russia\n  - ukraine\n  - kazakhstan\n\nmajor_importers:\n  - egypt\n  - indonesia\n  - algeria\n  - philippines\n  - japan\n  - china\n```\n\n**單位：**\n- US: million bushels\n- World: million metric tons\n- Price: $/bushel\n\n**行銷年度：**\n- US: June 1 - May 31\n- World: July 1 - June 30\n</wheat>\n\n<corn>\n**玉米 (Corn)**\n\n**表格名稱搜尋：**\n```yaml\nus_tables:\n  - \"U.S. Feed Grain and Corn Supply and Use\"\n  - \"Corn: U.S. Supply and Use\"\n  - \"U.S. Corn Supply and Disappearance\"\n\nworld_tables:\n  - \"World Corn Supply and Use\"\n  - \"Corn: World Supply and Use\"\n  - \"Coarse Grains: World Supply and Use\"\n```\n\n**US 欄位映射：**\n```yaml\nfields_map:\n  area_planted: [\"Area Planted\"]\n  area_harvested: [\"Area Harvested\"]\n  yield: [\"Yield per Harvested Acre\"]\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  supply_total: [\"Supply, Total\"]\n  feed_and_residual: [\"Feed and Residual\"]\n  food_seed_industrial: [\"Food, Seed, and Industrial\", \"FSI\"]\n  ethanol: [\"Ethanol and by-products\", \"Ethanol\"]\n  domestic_total: [\"Domestic, Total\"]\n  exports: [\"Exports\"]\n  use_total: [\"Use, Total\"]\n  ending_stocks: [\"Ending Stocks\"]\n  avg_farm_price: [\"Avg. Farm Price\"]\n```\n\n**World 欄位映射：**\n```yaml\nfields_map:\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  domestic_use: [\"Domestic Use\", \"Feed Dom. Consumption\"]\n  exports: [\"Exports\"]\n  ending_stocks: [\"Ending Stocks\"]\n\nmajor_producers:\n  - united_states\n  - china\n  - brazil\n  - european_union\n  - argentina\n  - ukraine\n  - mexico\n```\n\n**單位：**\n- US: million bushels\n- World: million metric tons\n- Yield: bushels/acre\n- Price: $/bushel\n\n**行銷年度：**\n- US: September 1 - August 31\n- World: October 1 - September 30\n</corn>\n\n<rice>\n**稻米 (Rice)**\n\n**表格名稱搜尋：**\n```yaml\nus_tables:\n  - \"U.S. Rice Supply and Use\"\n  - \"Rice: U.S. Supply and Use\"\n\nus_by_type_tables:\n  - \"U.S. Long-grain Rice Supply and Use\"\n  - \"U.S. Medium/Short-grain Rice Supply and Use\"\n\nworld_tables:\n  - \"World Rice Supply and Use\"\n  - \"Rice: World Supply and Use\"\n```\n\n**US 欄位映射：**\n```yaml\nfields_map:\n  area_planted: [\"Area Planted\"]\n  area_harvested: [\"Area Harvested\"]\n  yield: [\"Yield\"]\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  imports_long_grain: [\"Long-grain Imports\"]\n  imports_med_short: [\"Med./Short-grain Imports\"]\n  supply_total: [\"Total Supply\"]\n  domestic_and_residual: [\"Domestic and Residual\"]\n  exports: [\"Exports\"]\n  use_total: [\"Total Use\"]\n  ending_stocks: [\"Ending Stocks\"]\n  avg_farm_price: [\"Avg. Farm Price\"]\n\nrice_types:\n  - long_grain: [\"Long-grain\", \"Long Grain\"]\n  - medium_short_grain: [\"Medium/Short-grain\", \"Med./Short-grain\", \"Medium and Short Grain\"]\n```\n\n**World 欄位映射：**\n```yaml\nfields_map:\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  domestic_use: [\"Domestic Use\", \"Domestic Consumption\"]\n  exports: [\"Exports\"]\n  ending_stocks: [\"Ending Stocks\"]\n\nmajor_producers:\n  - china\n  - india\n  - indonesia\n  - bangladesh\n  - vietnam\n  - thailand\n  - united_states\n```\n\n**單位：**\n- US: million cwt (hundredweight)\n- World: million metric tons (milled basis)\n- Price: $/cwt\n\n**行銷年度：**\n- US: August 1 - July 31\n- World: Calendar Year (January - December)\n</rice>\n\n<other_grains>\n**其他穀物 (Barley, Sorghum, Oats)**\n\n**大麥 (Barley):**\n```yaml\ntables:\n  - \"U.S. Barley Supply and Use\"\n  - \"Barley: U.S. Supply and Use\"\n\nmarketing_year: Jun-May\nunit: million bushels\n\nfields_map:\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  food_alcohol_industrial: [\"Food, Alcohol, and Industrial\"]\n  seed: [\"Seed\"]\n  feed_and_residual: [\"Feed and Residual\"]\n  exports: [\"Exports\"]\n  ending_stocks: [\"Ending Stocks\"]\n```\n\n**高粱 (Sorghum):**\n```yaml\ntables:\n  - \"U.S. Sorghum Supply and Use\"\n  - \"Sorghum: U.S. Supply and Use\"\n\nmarketing_year: Sep-Aug\nunit: million bushels\n\nfields_map:\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  feed_and_residual: [\"Feed and Residual\"]\n  food_alcohol_industrial: [\"Food, Alcohol, and Industrial\"]\n  exports: [\"Exports\"]\n  ending_stocks: [\"Ending Stocks\"]\n```\n\n**燕麥 (Oats):**\n```yaml\ntables:\n  - \"U.S. Oats Supply and Use\"\n  - \"Oats: U.S. Supply and Use\"\n\nmarketing_year: Jun-May\nunit: million bushels\n\nfields_map:\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  feed_and_residual: [\"Feed and Residual\"]\n  food_and_industrial: [\"Food and Industrial\"]\n  exports: [\"Exports\"]\n  ending_stocks: [\"Ending Stocks\"]\n```\n</other_grains>\n\n<validation_rules>\n**穀物類驗證規則**\n\n**平衡公式：**\n```\nSupply Total = Beginning Stocks + Production + Imports\nUse Total = Domestic Total + Exports\nEnding Stocks = Supply Total - Use Total\n```\n\n**合理性範圍 (US, million bushels)：**\n```yaml\nwheat:\n  production: [1000, 3000]\n  ending_stocks: [300, 1500]\n  exports: [500, 1500]\n\ncorn:\n  production: [10000, 18000]\n  ending_stocks: [500, 3000]\n  exports: [1500, 3000]\n  ethanol: [4000, 6000]\n\nrice:  # cwt\n  production: [100, 300]\n  ending_stocks: [20, 80]\n```\n\n**World 合理性範圍 (million metric tons)：**\n```yaml\nwheat:\n  production: [700, 850]\n  ending_stocks: [200, 350]\n\ncorn:\n  production: [1000, 1300]\n  ending_stocks: [200, 400]\n```\n</validation_rules>\n",
        "skills/wasde-ingestor/references/livestock.md": "<overview>\n畜產品 (Livestock) 僅涵蓋美國市場，包含牛肉、豬肉、禽肉、雞蛋、乳製品。本文件詳細說明表格結構、欄位映射與解析規則。\n</overview>\n\n<livestock_overview>\n**畜產品總覽**\n\n| 商品 | 英文 | 單位 | 年度 |\n|------|------|------|------|\n| 牛肉 | Beef | million lbs (carcass weight) | Calendar Year |\n| 豬肉 | Pork | million lbs (carcass weight) | Calendar Year |\n| 禽肉 | Broiler | million lbs (ready-to-cook) | Calendar Year |\n| 火雞 | Turkey | million lbs (ready-to-cook) | Calendar Year |\n| 雞蛋 | Eggs | million dozen | Calendar Year |\n| 乳製品 | Dairy/Milk | billion lbs | Calendar Year |\n\n**注意：** 畜產品僅有 US 數據，無 World 數據。\n</livestock_overview>\n\n<beef>\n**牛肉 (Beef)**\n\n**表格名稱搜尋：**\n```yaml\ntables:\n  - \"U.S. Beef Supply and Use\"\n  - \"Beef: U.S. Supply and Use\"\n  - \"U.S. Red Meat Supply and Use\"  # 可能與豬肉合併\n```\n\n**欄位映射：**\n```yaml\nfields_map:\n  beginning_stocks: [\"Beginning Stocks\", \"Beg. Stocks\"]\n  commercial_production: [\"Commercial Production\", \"Comm. Prod.\"]\n  farm_production: [\"Farm Production\"]\n  production_total: [\"Production, Total\", \"Total Production\"]\n  imports: [\"Imports\"]\n  supply_total: [\"Supply, Total\", \"Total Supply\"]\n  exports: [\"Exports\"]\n  domestic_use: [\"Domestic Use\", \"Dom. Disappearance\"]\n  ending_stocks: [\"Ending Stocks\"]\n  per_capita: [\"Per Capita Disappearance\", \"Per Capita\"]\n  price_choice: [\"Price, Choice\", \"Choice Beef Price\"]\n  price_all_fresh: [\"Price, All Fresh\", \"All Fresh Beef\"]\n```\n\n**單位：**\n- 產量/庫存: million pounds (carcass weight)\n- Per Capita: pounds/person\n- Price: $/cwt\n\n**特殊指標：**\n- Cattle on Feed (存欄)\n- Cattle Slaughter (屠宰)\n- Average Carcass Weight\n</beef>\n\n<pork>\n**豬肉 (Pork)**\n\n**表格名稱搜尋：**\n```yaml\ntables:\n  - \"U.S. Pork Supply and Use\"\n  - \"Pork: U.S. Supply and Use\"\n  - \"U.S. Red Meat Supply and Use\"\n```\n\n**欄位映射：**\n```yaml\nfields_map:\n  beginning_stocks: [\"Beginning Stocks\"]\n  commercial_production: [\"Commercial Production\"]\n  farm_production: [\"Farm Production\"]\n  production_total: [\"Production, Total\"]\n  imports: [\"Imports\"]\n  supply_total: [\"Supply, Total\"]\n  exports: [\"Exports\"]\n  domestic_use: [\"Domestic Use\"]\n  ending_stocks: [\"Ending Stocks\"]\n  per_capita: [\"Per Capita Disappearance\"]\n  price_51_52: [\"Price, 51-52%\", \"51-52% Lean\"]\n  price_national_base: [\"National Base\", \"National Base Price\"]\n```\n\n**單位：**\n- 產量/庫存: million pounds (carcass weight)\n- Per Capita: pounds/person\n- Price: $/cwt\n\n**特殊指標：**\n- Hog Slaughter\n- Average Carcass Weight\n- Pigs per Litter\n</pork>\n\n<poultry>\n**禽肉 (Poultry)**\n\n**表格名稱搜尋：**\n```yaml\nbroiler_tables:\n  - \"U.S. Broiler Supply and Use\"\n  - \"Broiler: U.S. Supply and Use\"\n\nturkey_tables:\n  - \"U.S. Turkey Supply and Use\"\n  - \"Turkey: U.S. Supply and Use\"\n```\n\n**Broiler 欄位映射：**\n```yaml\nfields_map:\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  supply_total: [\"Supply, Total\"]\n  exports: [\"Exports\"]\n  domestic_use: [\"Domestic Use\", \"Ending Stocks + Domestic\"]\n  ending_stocks: [\"Ending Stocks\"]\n  per_capita: [\"Per Capita Disappearance\"]\n  price_wholesale: [\"Price, Wholesale\", \"Wholesale Price\"]\n```\n\n**Turkey 欄位映射：**\n```yaml\nfields_map:\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  supply_total: [\"Supply, Total\"]\n  exports: [\"Exports\"]\n  domestic_use: [\"Domestic Use\"]\n  ending_stocks: [\"Ending Stocks\"]\n  per_capita: [\"Per Capita Disappearance\"]\n  price_wholesale: [\"Price, Wholesale\"]\n```\n\n**單位：**\n- 產量/庫存: million pounds (ready-to-cook weight)\n- Per Capita: pounds/person\n- Price: cents/lb\n\n**特殊注意：**\n- Broiler 生產週期短（6-7 週）\n- 季節性：感恩節、聖誕節前需求高\n</poultry>\n\n<eggs>\n**雞蛋 (Eggs)**\n\n**表格名稱搜尋：**\n```yaml\ntables:\n  - \"U.S. Egg Supply and Use\"\n  - \"Eggs: U.S. Supply and Use\"\n```\n\n**欄位映射：**\n```yaml\nfields_map:\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  supply_total: [\"Supply, Total\"]\n  hatching_use: [\"Hatching Use\"]\n  exports: [\"Exports\"]\n  domestic_food: [\"Domestic Food Use\", \"Food Use\"]\n  ending_stocks: [\"Ending Stocks\"]\n  per_capita: [\"Per Capita Disappearance\"]\n  price_ny: [\"Price, New York\", \"NY Price\"]\n  price_midwest: [\"Price, Midwest\"]\n```\n\n**單位：**\n- 產量: million dozen\n- Per Capita: number of eggs/person\n- Price: cents/dozen\n\n**特殊分類：**\n- Table Eggs (食用蛋)\n- Hatching Eggs (孵化蛋)\n- Breaking Stock (加工用蛋)\n</eggs>\n\n<dairy>\n**乳製品 (Dairy/Milk)**\n\n**表格名稱搜尋：**\n```yaml\ntables:\n  - \"U.S. Dairy Supply and Use\"\n  - \"Milk: U.S. Supply and Use\"\n  - \"U.S. Milk Production and Supply\"\n```\n\n**欄位映射：**\n```yaml\nfields_map:\n  milk_cows: [\"Milk Cows\", \"Number of Cows\"]\n  milk_per_cow: [\"Milk per Cow\", \"Production per Cow\"]\n  milk_production: [\"Milk Production\", \"Total Production\"]\n  beginning_stocks: [\"Beginning Stocks\"]\n  imports: [\"Imports\"]\n  supply_total: [\"Supply, Total\"]\n  domestic_use: [\"Domestic Use\", \"Commercial Disappearance\"]\n  exports: [\"Exports\"]\n  ending_stocks: [\"Ending Stocks\"]\n  all_milk_price: [\"All Milk Price\"]\n  class_iii_price: [\"Class III Price\"]\n  class_iv_price: [\"Class IV Price\"]\n```\n\n**乳製品細分：**\n```yaml\nproducts:\n  - butter: [\"Butter\"]\n  - cheese: [\"Cheese\", \"American Cheese\", \"Other Cheese\"]\n  - nonfat_dry_milk: [\"Nonfat Dry Milk\", \"NDM\"]\n  - dry_whey: [\"Dry Whey\"]\n```\n\n**單位：**\n- 牛奶產量: billion pounds\n- 乳製品: million pounds\n- Per Cow: pounds/year\n- Price: $/cwt\n\n**特殊指標：**\n- Milk-Feed Price Ratio\n- Class III/IV Prices (FMMO pricing)\n</dairy>\n\n<validation_rules>\n**畜產品驗證規則**\n\n**平衡公式：**\n```\nSupply Total = Beginning Stocks + Production + Imports\nUse Total = Domestic Use + Exports\nEnding Stocks = Supply Total - Use Total\n```\n\n**合理性範圍 (million pounds)：**\n```yaml\nbeef:\n  production: [25000, 30000]\n  imports: [2000, 4000]\n  exports: [2500, 4000]\n  per_capita: [55, 62]\n\npork:\n  production: [25000, 30000]\n  imports: [500, 1000]\n  exports: [6000, 8000]\n  per_capita: [45, 55]\n\nbroiler:\n  production: [42000, 50000]\n  exports: [6000, 8000]\n  per_capita: [90, 105]\n\neggs:  # million dozen\n  production: [8000, 9500]\n  per_capita: [275, 295]  # eggs per person\n\ndairy:  # billion pounds milk\n  production: [215, 235]\n  milk_per_cow: [23000, 26000]  # pounds/year\n```\n\n**價格合理性：**\n```yaml\nbeef_choice: [100, 250]  # $/cwt\npork_51_52: [40, 120]    # $/cwt\nbroiler_wholesale: [60, 150]  # cents/lb\negg_ny: [50, 300]        # cents/dozen\nall_milk: [15, 30]       # $/cwt\n```\n</validation_rules>\n",
        "skills/wasde-ingestor/references/oilseeds.md": "<overview>\n油籽類 (Oilseeds) 包含大豆、豆油、豆粕，是 WASDE 報告的重要組成部分。本文件詳細說明表格結構、欄位映射與解析規則。\n</overview>\n\n<soybeans>\n**大豆 (Soybeans)**\n\n**表格名稱搜尋：**\n```yaml\nus_tables:\n  - \"U.S. Soybeans Supply and Use\"\n  - \"Soybeans: U.S. Supply and Use\"\n  - \"U.S. Soybeans and Products Supply and Use\"\n\nworld_tables:\n  - \"World Soybean Supply and Use\"\n  - \"Soybeans: World Supply and Use\"\n```\n\n**US 欄位映射：**\n```yaml\nfields_map:\n  area_planted: [\"Area Planted\"]\n  area_harvested: [\"Area Harvested\"]\n  yield: [\"Yield per Harvested Acre\"]\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  supply_total: [\"Supply, Total\", \"Total Supply\"]\n  crushings: [\"Crushings\", \"Crush\"]\n  exports: [\"Exports\"]\n  seed: [\"Seed\"]\n  residual: [\"Residual\"]\n  use_total: [\"Use, Total\", \"Total Use\"]\n  ending_stocks: [\"Ending Stocks\"]\n  avg_farm_price: [\"Avg. Farm Price\", \"Season-Average Farm Price\"]\n```\n\n**World 欄位映射：**\n```yaml\nfields_map:\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  crush: [\"Crush\", \"Domestic Crush\"]\n  exports: [\"Exports\"]\n  ending_stocks: [\"Ending Stocks\"]\n\nmajor_producers:\n  - united_states\n  - brazil\n  - argentina\n  - china\n  - india\n  - paraguay\n\nmajor_exporters:\n  - brazil\n  - united_states\n  - argentina\n  - paraguay\n  - canada\n\nmajor_importers:\n  - china  # 占全球進口 60%+\n  - european_union\n  - mexico\n  - japan\n  - egypt\n```\n\n**單位：**\n- US: million bushels\n- World: million metric tons\n- Yield: bushels/acre\n- Price: $/bushel\n\n**行銷年度：**\n- US: September 1 - August 31\n- World: October 1 - September 30\n\n**特殊注意：**\n- 中國進口量是關鍵觀察指標\n- Brazil 與 US 的出口競爭關係\n- 南美收成季（3-5月）影響 World 供需\n</soybeans>\n\n<soybean_oil>\n**豆油 (Soybean Oil)**\n\n**表格名稱搜尋：**\n```yaml\nus_tables:\n  - \"U.S. Soybean Oil Supply and Use\"\n  - \"Soybean Oil: U.S. Supply and Use\"\n  - \"U.S. Soybean Oil Supply and Disappearance\"\n\nworld_tables:\n  - \"World Soybean Oil Supply and Use\"\n  - \"Soybean Oil: World Supply and Use\"\n```\n\n**US 欄位映射：**\n```yaml\nfields_map:\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  supply_total: [\"Supply, Total\"]\n  domestic_disappearance: [\"Domestic Disappearance\", \"Domestic Use\"]\n  biofuel: [\"Biofuel\", \"Biodiesel\"]  # 2021 年後改名\n  food_feed_other: [\"Food, Feed, and Other Industrial\"]\n  exports: [\"Exports\"]\n  use_total: [\"Use, Total\"]\n  ending_stocks: [\"Ending Stocks\"]\n  price: [\"Price\", \"Avg. Price\"]\n```\n\n**World 欄位映射：**\n```yaml\nfields_map:\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  domestic_use: [\"Domestic Use\", \"Dom. Consumption\"]\n  exports: [\"Exports\"]\n  ending_stocks: [\"Ending Stocks\"]\n```\n\n**單位：**\n- US: million pounds\n- World: million metric tons\n- Price: cents/pound\n\n**行銷年度：** October 1 - September 30\n\n**特殊注意：**\n- Biofuel 需求是重要驅動因素\n- 2021 年後 \"Biodiesel\" 改為 \"Biofuel\"\n</soybean_oil>\n\n<soybean_meal>\n**豆粕 (Soybean Meal)**\n\n**表格名稱搜尋：**\n```yaml\nus_tables:\n  - \"U.S. Soybean Meal Supply and Use\"\n  - \"Soybean Meal: U.S. Supply and Use\"\n\nworld_tables:\n  - \"World Soybean Meal Supply and Use\"\n  - \"Soybean Meal: World Supply and Use\"\n```\n\n**US 欄位映射：**\n```yaml\nfields_map:\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  supply_total: [\"Supply, Total\"]\n  domestic_disappearance: [\"Domestic Disappearance\"]\n  exports: [\"Exports\"]\n  use_total: [\"Use, Total\"]\n  ending_stocks: [\"Ending Stocks\"]\n  price: [\"Price\", \"Avg. Price\"]\n```\n\n**World 欄位映射：**\n```yaml\nfields_map:\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  domestic_use: [\"Domestic Use\"]\n  exports: [\"Exports\"]\n  ending_stocks: [\"Ending Stocks\"]\n\n# 2021 年後 China 單獨列出\nmajor_countries:\n  - china  # 單獨列出\n  - argentina\n  - brazil\n  - united_states\n  - european_union\n```\n\n**單位：**\n- US: thousand short tons\n- World: million metric tons\n- Price: $/short ton\n\n**行銷年度：** October 1 - September 30\n</soybean_meal>\n\n<crush_relationship>\n**壓榨關係 (Crush Relationship)**\n\n大豆壓榨產出豆油與豆粕，有固定的產出比例：\n\n```\n1 bushel soybeans (60 lbs) ≈\n  - 11 lbs soybean oil (18.3%)\n  - 48 lbs soybean meal (80%)\n  - 1 lb hulls & loss (1.7%)\n```\n\n**換算公式：**\n```python\n# US 單位換算\nsoybean_bushels_crushed = soybean_meal_production_tons * 2000 / 48 / 60\n# 或\nsoybean_bushels_crushed = soybean_oil_production_lbs / 11 / 60\n```\n\n**驗證規則：**\n- 豆粕產量 ≈ 壓榨量 * 0.80\n- 豆油產量 ≈ 壓榨量 * 0.183\n- 容許 5% 誤差（不同大豆品種含油量不同）\n</crush_relationship>\n\n<validation_rules>\n**油籽類驗證規則**\n\n**平衡公式：**\n```\nSupply Total = Beginning Stocks + Production + Imports\nUse Total = Crush + Exports + Seed + Residual\nEnding Stocks = Supply Total - Use Total\n```\n\n**合理性範圍 (US)：**\n```yaml\nsoybeans:  # million bushels\n  production: [3500, 5000]\n  crush: [2000, 2500]\n  exports: [1500, 2500]\n  ending_stocks: [100, 600]\n\nsoybean_oil:  # million pounds\n  production: [20000, 28000]\n  biofuel: [8000, 14000]\n  exports: [500, 2000]\n\nsoybean_meal:  # thousand short tons\n  production: [45000, 60000]\n  exports: [10000, 16000]\n```\n\n**World 合理性範圍 (million metric tons)：**\n```yaml\nsoybeans:\n  production: [350, 450]\n  crush: [300, 400]\n  ending_stocks: [80, 150]\n  china_imports: [90, 120]  # 關鍵指標\n```\n\n**跨表驗證：**\n- US Soybean Crush ≈ 計算自 Soybean Meal Production\n- World 各國加總 ≈ World Total\n</validation_rules>\n",
        "skills/wasde-ingestor/references/sugar.md": "<overview>\n糖 (Sugar) 在 WASDE 中涵蓋美國與墨西哥市場。本文件詳細說明表格結構、欄位映射與解析規則。\n</overview>\n\n<sugar_overview>\n**糖市場總覽**\n\n| 市場 | 說明 | 單位 |\n|------|------|------|\n| US Sugar | 美國糖供需 | 1,000 short tons (raw value) |\n| Mexico Sugar | 墨西哥糖供需 | 1,000 metric tons |\n\n**糖類型：**\n- Raw Sugar (原糖)\n- Refined Sugar (精製糖)\n- Beet Sugar (甜菜糖)\n- Cane Sugar (甘蔗糖)\n- High Fructose Corn Syrup (HFCS，玉米糖漿)\n</sugar_overview>\n\n<us_sugar>\n**US 糖供需**\n\n**表格名稱搜尋：**\n```yaml\ntables:\n  - \"U.S. Sugar Supply and Use\"\n  - \"Sugar: U.S. Supply and Use\"\n  - \"U.S. Sugar Supply and Use/Prices\"\n```\n\n**欄位映射：**\n```yaml\nfields_map:\n  beginning_stocks: [\"Beginning Stocks\"]\n\n  # Production 細分\n  beet_sugar: [\"Beet Sugar\"]\n  cane_sugar_florida: [\"Cane Sugar, Florida\", \"Florida Cane\"]\n  cane_sugar_louisiana: [\"Cane Sugar, Louisiana\", \"Louisiana Cane\"]\n  cane_sugar_texas: [\"Cane Sugar, Texas\", \"Texas Cane\"]\n  cane_sugar_hawaii: [\"Cane Sugar, Hawaii\", \"Hawaii Cane\"]  # 已減少\n  production_total: [\"Production, Total\", \"Total Production\"]\n\n  # Imports 細分\n  imports_tariff_rate_quota: [\"TRQ Imports\", \"Tariff-Rate Quota\"]\n  imports_other: [\"Other Program Imports\"]\n  imports_high_tier: [\"High-Tier Tariff Imports\"]\n  imports_total: [\"Imports, Total\", \"Total Imports\"]\n\n  supply_total: [\"Supply, Total\"]\n\n  exports: [\"Exports\"]\n  deliveries_domestic: [\"Deliveries, Domestic Food and Beverage\"]\n  deliveries_other: [\"Other Deliveries\"]\n  miscellaneous: [\"Miscellaneous\"]\n  use_total: [\"Use, Total\"]\n\n  ending_stocks: [\"Ending Stocks\"]\n  stocks_to_use: [\"Stocks-to-Use Ratio\"]\n\n  # Prices\n  raw_sugar_price: [\"Raw Sugar Price\", \"Raw Cane Sugar Price\"]\n  refined_sugar_price: [\"Refined Beet Sugar Price\", \"Refined Sugar Price\"]\n  world_raw_price: [\"World Raw Sugar Price\", \"World Price\"]\n```\n\n**單位：**\n- 供需量: 1,000 short tons (raw value)\n- Stocks-to-Use: percentage\n- Price: cents/lb\n\n**行銷年度：** October 1 - September 30\n\n**特殊注意：**\n- US 實施關稅配額 (TRQ) 制度\n- Mexico 根據北美貿易協定有特殊進口待遇\n</us_sugar>\n\n<mexico_sugar>\n**Mexico 糖供需**\n\n**表格名稱搜尋：**\n```yaml\ntables:\n  - \"Mexico Sugar Supply and Use\"\n  - \"Sugar: Mexico Supply and Use\"\n```\n\n**欄位映射：**\n```yaml\nfields_map:\n  beginning_stocks: [\"Beginning Stocks\"]\n  production: [\"Production\"]\n  imports: [\"Imports\"]\n  supply_total: [\"Supply, Total\"]\n  domestic_use: [\"Domestic Consumption\", \"Domestic Use\"]\n  exports_to_us: [\"Exports to United States\", \"Exports to US\"]\n  exports_other: [\"Exports, Other\", \"Other Exports\"]\n  exports_total: [\"Exports, Total\"]\n  use_total: [\"Use, Total\"]\n  ending_stocks: [\"Ending Stocks\"]\n```\n\n**單位：**\n- 供需量: 1,000 metric tons\n\n**行銷年度：** October 1 - September 30\n\n**特殊注意：**\n- Mexico 是 US 最大的糖進口來源\n- 受 USMCA (前 NAFTA) 貿易協定規範\n</mexico_sugar>\n\n<hfcs>\n**高果糖玉米糖漿 (HFCS)**\n\nWASDE 通常不單獨列出 HFCS 表格，但在 US Sugar 市場分析中需考慮：\n\n```yaml\nhfcs_context:\n  - HFCS 是糖的主要替代品\n  - 玉米價格影響 HFCS 生產成本\n  - 飲料產業是主要消費者\n  - 近年 HFCS 消費量下降\n```\n</hfcs>\n\n<trade_policy>\n**美國糖政策**\n\n**關稅配額 (TRQ) 制度：**\n```yaml\ntrq_system:\n  description: \"美國對糖進口實施二級關稅制度\"\n\n  in_quota:\n    description: \"配額內進口，低關稅\"\n    tariff: \"0.625 cents/lb (raw)\"\n\n  over_quota:\n    description: \"超配額進口，高關稅\"\n    tariff: \"15.36 cents/lb (raw)\"\n\n  country_allocations:\n    - dominican_republic\n    - brazil\n    - philippines\n    - australia\n    - guatemala\n    - others\n```\n\n**Mexico 特殊待遇：**\n```yaml\nmexico_access:\n  description: \"根據 USMCA，Mexico 有特殊進口待遇\"\n  provisions:\n    - \"Need-based access\"\n    - \"Export limit agreements\"\n    - \"Refined sugar restrictions\"\n```\n</trade_policy>\n\n<validation_rules>\n**糖驗證規則**\n\n**平衡公式：**\n```\nSupply Total = Beginning Stocks + Production + Imports\nUse Total = Domestic Use + Exports\nEnding Stocks = Supply Total - Use Total\n```\n\n**US 合理性範圍 (1,000 short tons)：**\n```yaml\nus_sugar:\n  beet_sugar: [4000, 5500]\n  cane_sugar: [3500, 4500]\n  production_total: [8000, 10000]\n  imports_total: [2500, 4000]\n  domestic_deliveries: [11000, 13000]\n  ending_stocks: [1200, 2200]\n  stocks_to_use: [10, 18]  # percentage\n\nprices:  # cents/lb\n  raw_sugar: [20, 50]\n  refined_sugar: [30, 70]\n  world_raw: [10, 30]\n```\n\n**Mexico 合理性範圍 (1,000 metric tons)：**\n```yaml\nmexico_sugar:\n  production: [5500, 7000]\n  domestic_use: [4000, 5000]\n  exports_to_us: [1000, 2000]\n  ending_stocks: [500, 1500]\n```\n\n**跨表驗證：**\n- US Imports from Mexico ≈ Mexico Exports to US (單位換算後)\n- World Price 通常低於 US Price (因為保護政策)\n</validation_rules>\n\n<seasonal_patterns>\n**糖季節性模式**\n\n| 月份 | US 甜菜 | US 甘蔗 | Mexico |\n|------|---------|---------|--------|\n| 1-3月 | 淡季 | 收割 (FL, LA) | 收割 |\n| 4-6月 | 種植 | 淡季 | 收割尾聲 |\n| 7-9月 | 生長 | 淡季 | 淡季 |\n| 10-12月 | 收割 | 開始收割 | 淡季 |\n\n**關鍵報告月份：**\n- 5月 WASDE: 新年度首次預測\n- 11月 WASDE: 甜菜產量更新\n- 1月 WASDE: 甘蔗產量更新\n</seasonal_patterns>\n",
        "skills/wasde-ingestor/references/validation-rules.md": "<overview>\n本文件定義 WASDE 數據解析的通用驗證規則，包含平衡公式檢查、數值合理性範圍、跨表一致性驗證等。\n</overview>\n\n<balance_formula>\n**供需平衡公式**\n\n所有供需表遵循相同的基本平衡公式：\n\n```\nSupply = Beginning Stocks + Production + Imports\nUse = Domestic Use + Exports\nEnding Stocks = Supply - Use\n```\n\n**驗證方式：**\n```python\ndef validate_balance(row, tolerance=1.0):\n    supply = row['beginning_stocks'] + row['production'] + row['imports']\n    use = row['domestic_total'] + row['exports']\n    calculated_ending = supply - use\n\n    actual_ending = row['ending_stocks']\n    diff = abs(calculated_ending - actual_ending)\n\n    return diff <= tolerance\n```\n\n**容許誤差：**\n| 商品類別 | US 容許誤差 | World 容許誤差 |\n|----------|------------|---------------|\n| Grains | 5.0 (million bu) | 1.0 (mmt) |\n| Oilseeds | 5.0 (million bu) | 1.0 (mmt) |\n| Cotton | 0.1 (million bales) | 0.5 (million bales) |\n| Livestock | 50.0 (million lbs) | N/A |\n| Sugar | 50.0 (1000 st) | N/A |\n\n**誤差來源：**\n- 四捨五入\n- Residual / Unaccounted 項目\n- Statistical discrepancy\n</balance_formula>\n\n<numeric_sanity>\n**數值合理性檢查**\n\n**原則：**\n1. 數值必須為非負數（除特定例外）\n2. 數值必須在歷史合理範圍內\n3. 年度變化幅度不應異常\n\n**允許負值的欄位：**\n```yaml\nallow_negative:\n  - feed_and_residual  # 統計殘差可能為負\n  - unaccounted        # 統計殘差\n  - loss_adjustment    # 損失調整\n  - residual           # 殘差項\n```\n\n**異常值檢測：**\n```python\ndef check_anomaly(value, historical_mean, historical_std, threshold=3.0):\n    \"\"\"檢測是否超過 3 個標準差\"\"\"\n    z_score = abs(value - historical_mean) / historical_std\n    return z_score > threshold\n```\n\n**年度變化限制：**\n```yaml\nmax_yoy_change:\n  production: 30%      # 產量年變化不超過 30%\n  ending_stocks: 100%  # 庫存可能大幅波動\n  exports: 50%         # 出口變化較大\n  domestic_use: 20%    # 國內消費較穩定\n```\n</numeric_sanity>\n\n<cross_table_validation>\n**跨表一致性驗證**\n\n**World 加總驗證：**\n```python\ndef validate_world_total(country_data, world_total, tolerance_pct=2.0):\n    \"\"\"各國加總應等於 World Total\"\"\"\n    calculated_total = sum(country_data.values())\n    diff_pct = abs(calculated_total - world_total) / world_total * 100\n    return diff_pct <= tolerance_pct\n```\n\n**油籽壓榨關係：**\n```python\ndef validate_crush_relationship(soybean_crush, meal_production, oil_production):\n    \"\"\"壓榨量與產品產量的對應關係\"\"\"\n    # 1 bushel = 60 lbs → 48 lbs meal + 11 lbs oil\n    expected_meal = soybean_crush * 60 * 0.80 / 2000  # thousand short tons\n    expected_oil = soybean_crush * 60 * 0.183  # million pounds\n\n    meal_diff = abs(meal_production - expected_meal) / expected_meal\n    oil_diff = abs(oil_production - expected_oil) / expected_oil\n\n    return meal_diff < 0.10 and oil_diff < 0.10  # 10% 容許\n```\n\n**US-Mexico 糖貿易對賬：**\n```python\ndef validate_sugar_trade(us_imports_from_mexico, mexico_exports_to_us):\n    \"\"\"US 進口 ≈ Mexico 出口（單位換算後）\"\"\"\n    # US: 1000 short tons → Mexico: 1000 metric tons\n    us_in_mt = us_imports_from_mexico * 0.9072\n    diff_pct = abs(us_in_mt - mexico_exports_to_us) / mexico_exports_to_us * 100\n    return diff_pct < 5.0\n```\n</cross_table_validation>\n\n<schema_validation>\n**Schema 驗證**\n\n**必要欄位檢查：**\n```yaml\nrequired_fields:\n  all_balance_tables:\n    - release_date\n    - marketing_year\n    - commodity\n    - unit\n    - beginning_stocks\n    - production\n    - imports\n    - exports\n    - ending_stocks\n    - content_hash\n\n  grains_us:\n    - area_planted\n    - area_harvested\n    - yield\n    - avg_farm_price\n\n  oilseeds_us:\n    - crushings\n    - seed\n    - residual\n\n  cotton_us:\n    - mill_use\n    - unaccounted\n\n  livestock_us:\n    - commercial_production\n    - per_capita\n```\n\n**資料類型驗證：**\n```yaml\nfield_types:\n  release_date: date\n  marketing_year: string  # \"2024/25\" format\n  commodity: string\n  unit: string\n  numeric_fields: float\n  content_hash: string (SHA256)\n```\n\n**Marketing Year 格式：**\n```python\nimport re\n\ndef validate_marketing_year(my_str):\n    \"\"\"驗證行銷年度格式\"\"\"\n    pattern = r'^\\d{4}/\\d{2}$'  # \"2024/25\"\n    return bool(re.match(pattern, my_str))\n```\n</schema_validation>\n\n<drift_detection>\n**Schema Drift 檢測**\n\n**表格結構變化檢測：**\n```python\ndef detect_schema_drift(current_columns, baseline_columns):\n    \"\"\"檢測表格結構是否變化\"\"\"\n    added = set(current_columns) - set(baseline_columns)\n    removed = set(baseline_columns) - set(current_columns)\n\n    if added or removed:\n        return {\n            \"drift_detected\": True,\n            \"added_columns\": list(added),\n            \"removed_columns\": list(removed)\n        }\n    return {\"drift_detected\": False}\n```\n\n**Schema Hash：**\n```python\nimport hashlib\nimport json\n\ndef compute_schema_hash(columns, dtypes):\n    \"\"\"計算 schema 的 hash 值\"\"\"\n    schema_str = json.dumps({\n        \"columns\": sorted(columns),\n        \"dtypes\": {k: str(v) for k, v in sorted(dtypes.items())}\n    }, sort_keys=True)\n    return hashlib.sha256(schema_str.encode()).hexdigest()[:16]\n```\n\n**Drift 處理策略：**\n```yaml\non_drift:\n  minor:  # 新增欄位\n    action: \"warn_and_continue\"\n    log_level: \"warning\"\n\n  major:  # 刪除欄位或重命名\n    action: \"fail_with_report\"\n    log_level: \"error\"\n    output: \"drift_report.json\"\n```\n</drift_detection>\n\n<content_hash>\n**Content Hash 計算**\n\n**目的：**\n- 追蹤數據變化\n- 識別修正值\n- 確保冪等性\n\n**計算方式：**\n```python\nimport hashlib\nimport json\n\ndef compute_content_hash(row_dict, exclude_fields=None):\n    \"\"\"計算行數據的 content hash\"\"\"\n    exclude = exclude_fields or ['content_hash', 'created_at', 'updated_at']\n\n    # 只包含數據欄位\n    data = {k: v for k, v in sorted(row_dict.items()) if k not in exclude}\n\n    # 處理浮點數精度\n    for k, v in data.items():\n        if isinstance(v, float):\n            data[k] = round(v, 6)\n\n    content_str = json.dumps(data, sort_keys=True, default=str)\n    return hashlib.sha256(content_str.encode()).hexdigest()[:32]\n```\n\n**修正值識別：**\n```python\ndef detect_revision(new_hash, old_hash, release_date, old_release_date):\n    \"\"\"識別數據修正\"\"\"\n    if new_hash != old_hash:\n        return {\n            \"is_revision\": True,\n            \"new_release\": release_date,\n            \"old_release\": old_release_date,\n            \"new_hash\": new_hash,\n            \"old_hash\": old_hash\n        }\n    return {\"is_revision\": False}\n```\n</content_hash>\n\n<quality_metrics>\n**數據品質指標**\n\n```yaml\nquality_metrics:\n  completeness:\n    description: \"必要欄位的填充率\"\n    threshold: 0.95  # 95% 以上\n\n  accuracy:\n    description: \"平衡公式驗證通過率\"\n    threshold: 0.99  # 99% 以上\n\n  consistency:\n    description: \"跨表數據一致性\"\n    threshold: 0.95\n\n  timeliness:\n    description: \"數據更新及時性\"\n    threshold: \"release_date + 1 day\"\n\n  uniqueness:\n    description: \"無重複記錄\"\n    threshold: 1.0  # 100%\n```\n\n**品質報告輸出：**\n```python\ndef generate_quality_report(df, checks):\n    \"\"\"生成數據品質報告\"\"\"\n    return {\n        \"total_rows\": len(df),\n        \"valid_rows\": sum(checks),\n        \"quality_score\": sum(checks) / len(checks) * 100,\n        \"issues\": [\n            {\"row\": i, \"reason\": \"balance_check_failed\"}\n            for i, passed in enumerate(checks) if not passed\n        ]\n    }\n```\n</quality_metrics>\n",
        "skills/wasde-ingestor/workflows/backfill.md": "<required_reading>\n**執行此工作流程前，請先閱讀：**\n1. references/commodities-overview.md - 了解商品範圍與行銷年度\n2. references/validation-rules.md - 了解驗證規則\n3. workflows/ingest.md - 了解單次 ingest 流程\n</required_reading>\n\n<objective>\n批量回補歷史 WASDE 數據，從指定起始日期開始，抓取並解析多個月份的報告。\n</objective>\n\n<process>\n**Step 1: 確認參數**\n\n```yaml\nparameters:\n  commodities:\n    description: \"要回補的商品\"\n    default: \"all\"\n\n  scope:\n    description: \"數據範圍\"\n    default: \"us,world\"\n\n  months_back:\n    description: \"回補多少個月\"\n    default: 24\n    min: 1\n    max: 240  # 最多 20 年\n\n  start_date:\n    description: \"起始日期（優先於 months_back）\"\n    format: \"YYYY-MM-DD\"\n    optional: true\n\n  end_date:\n    description: \"結束日期\"\n    format: \"YYYY-MM-DD\"\n    default: \"today\"\n\n  output_dir:\n    description: \"輸出目錄\"\n    default: \"./data/wasde\"\n\n  parallel:\n    description: \"並行處理數量\"\n    default: 3\n    max: 5\n\n  skip_existing:\n    description: \"跳過已存在的數據\"\n    default: true\n```\n\n**Step 2: 生成報告日期列表**\n\n```python\nfrom datetime import datetime, timedelta\nfrom scripts.discover_releases import get_release_calendar\n\ndef generate_release_dates(months_back=None, start_date=None, end_date=None):\n    \"\"\"生成要處理的 release dates 列表\"\"\"\n\n    if end_date is None:\n        end_date = datetime.today()\n    elif isinstance(end_date, str):\n        end_date = datetime.strptime(end_date, \"%Y-%m-%d\")\n\n    if start_date:\n        start = datetime.strptime(start_date, \"%Y-%m-%d\")\n    else:\n        # WASDE 每月發布一次\n        start = end_date - timedelta(days=months_back * 31)\n\n    # 獲取實際發布日曆\n    release_calendar = get_release_calendar(start, end_date)\n\n    return release_calendar\n\n# 範例輸出\n# [\n#   {\"release_date\": \"2024-12-10\", \"pdf_url\": \"...\"},\n#   {\"release_date\": \"2024-11-08\", \"pdf_url\": \"...\"},\n#   ...\n# ]\n```\n\n**Step 3: 檢查已存在數據**\n\n```python\nimport pandas as pd\nimport os\n\ndef get_existing_releases(output_dir, commodity):\n    \"\"\"獲取已存在的 release dates\"\"\"\n    parquet_path = f\"{output_dir}/curated/{commodity}_balance.parquet\"\n\n    if not os.path.exists(parquet_path):\n        return set()\n\n    df = pd.read_parquet(parquet_path)\n    return set(df['release_date'].astype(str).unique())\n\ndef filter_missing_releases(all_releases, existing_releases, skip_existing=True):\n    \"\"\"過濾出需要處理的 releases\"\"\"\n    if not skip_existing:\n        return all_releases\n\n    return [r for r in all_releases if r['release_date'] not in existing_releases]\n```\n\n**Step 4: 批量處理**\n\n```python\nfrom concurrent.futures import ThreadPoolExecutor, as_completed\nfrom workflows.ingest import run_single_ingest\nimport time\n\ndef run_backfill(releases, config, parallel=3):\n    \"\"\"批量執行 ingest\"\"\"\n\n    results = []\n    failed = []\n\n    with ThreadPoolExecutor(max_workers=parallel) as executor:\n        # 提交所有任務\n        future_to_release = {\n            executor.submit(\n                run_single_ingest,\n                release_info=release,\n                commodities=config.commodities,\n                scope=config.scope,\n                output_dir=config.output_dir\n            ): release\n            for release in releases\n        }\n\n        # 處理完成的任務\n        for future in as_completed(future_to_release):\n            release = future_to_release[future]\n            try:\n                result = future.result()\n                results.append({\n                    \"release_date\": release['release_date'],\n                    \"status\": \"success\",\n                    \"result\": result\n                })\n                print(f\"✓ {release['release_date']} completed\")\n\n            except Exception as e:\n                failed.append({\n                    \"release_date\": release['release_date'],\n                    \"status\": \"failed\",\n                    \"error\": str(e)\n                })\n                print(f\"✗ {release['release_date']} failed: {e}\")\n\n            # 避免過度請求\n            time.sleep(0.5)\n\n    return results, failed\n```\n\n**Step 5: 合併數據**\n\n```python\ndef consolidate_parquet_files(output_dir, commodity):\n    \"\"\"合併所有 parquet 文件，去重並排序\"\"\"\n\n    parquet_path = f\"{output_dir}/curated/{commodity}_balance.parquet\"\n\n    if not os.path.exists(parquet_path):\n        return\n\n    df = pd.read_parquet(parquet_path)\n\n    # 去重：保留最新的 content_hash\n    df = df.sort_values('release_date')\n    df = df.drop_duplicates(\n        subset=['release_date', 'marketing_year', 'commodity'],\n        keep='last'\n    )\n\n    # 排序\n    df = df.sort_values(['marketing_year', 'release_date'])\n\n    # 重新寫入\n    df.to_parquet(parquet_path, index=False)\n\n    return len(df)\n```\n\n**Step 6: 生成回補報告**\n\n```python\ndef generate_backfill_report(results, failed, config):\n    \"\"\"生成回補總結報告\"\"\"\n\n    report = {\n        \"backfill_config\": {\n            \"commodities\": config.commodities,\n            \"scope\": config.scope,\n            \"months_back\": config.months_back,\n            \"start_date\": config.start_date,\n            \"end_date\": config.end_date\n        },\n        \"summary\": {\n            \"total_releases\": len(results) + len(failed),\n            \"successful\": len(results),\n            \"failed\": len(failed),\n            \"success_rate\": len(results) / (len(results) + len(failed)) * 100\n        },\n        \"successful_releases\": [r['release_date'] for r in results],\n        \"failed_releases\": [\n            {\"release_date\": f['release_date'], \"error\": f['error']}\n            for f in failed\n        ],\n        \"data_coverage\": {\n            commodity: get_coverage_stats(config.output_dir, commodity)\n            for commodity in get_commodity_list(config.commodities)\n        }\n    }\n\n    # 寫入報告\n    report_path = f\"{config.output_dir}/backfill_report_{datetime.now():%Y%m%d_%H%M%S}.json\"\n    with open(report_path, 'w') as f:\n        json.dump(report, f, indent=2)\n\n    return report\n\ndef get_coverage_stats(output_dir, commodity):\n    \"\"\"獲取數據覆蓋統計\"\"\"\n    parquet_path = f\"{output_dir}/curated/{commodity}_balance.parquet\"\n\n    if not os.path.exists(parquet_path):\n        return {\"rows\": 0, \"date_range\": None}\n\n    df = pd.read_parquet(parquet_path)\n    return {\n        \"rows\": len(df),\n        \"date_range\": {\n            \"min\": df['release_date'].min(),\n            \"max\": df['release_date'].max()\n        },\n        \"marketing_years\": df['marketing_year'].unique().tolist()\n    }\n```\n\n**Step 7: 處理失敗重試**\n\n```python\ndef retry_failed_releases(failed, config, max_retries=2):\n    \"\"\"重試失敗的 releases\"\"\"\n\n    remaining_failed = failed\n    retry_count = 0\n\n    while remaining_failed and retry_count < max_retries:\n        retry_count += 1\n        print(f\"\\n--- Retry attempt {retry_count} ---\")\n\n        # 等待一段時間\n        time.sleep(30)\n\n        results, still_failed = run_backfill(\n            releases=remaining_failed,\n            config=config,\n            parallel=1  # 重試時使用單線程\n        )\n\n        remaining_failed = still_failed\n\n    return remaining_failed\n```\n</process>\n\n<success_criteria>\n此工作流程成功完成時：\n- [ ] 成功識別所有要處理的 release dates\n- [ ] 成功處理 90% 以上的 releases（允許部分失敗）\n- [ ] 所有成功的數據已合併到 curated parquet\n- [ ] 生成完整的 backfill_report.json\n- [ ] 失敗的 releases 已記錄並嘗試重試\n</success_criteria>\n\n<performance_notes>\n**效能建議：**\n\n1. **並行度**\n   - 建議 parallel=3，避免過度請求 USDA 伺服器\n   - 每次請求間隔至少 0.5 秒\n\n2. **記憶體管理**\n   - 每處理 10 個 releases 後執行一次 gc\n   - 大量回補時建議分批處理\n\n3. **斷點續傳**\n   - 使用 skip_existing=true 可以從失敗處繼續\n   - 每個 release 處理完立即寫入\n\n4. **預估時間**\n   - 單個 release 約 10-30 秒\n   - 24 個月約需 10-15 分鐘\n   - 240 個月約需 2-3 小時\n</performance_notes>\n",
        "skills/wasde-ingestor/workflows/configure.md": "<required_reading>\n**執行此工作流程前，請先閱讀：**\n1. references/commodities-overview.md - 了解可配置的商品範圍\n2. templates/config.yaml - 標準配置模板\n</required_reading>\n\n<objective>\n配置 WASDE Ingestor 的商品範圍、輸出路徑、解析選項等參數。\n</objective>\n\n<process>\n**Step 1: 確認配置需求**\n\n詢問用戶要配置哪些項目：\n\n1. **商品範圍** - 選擇要抓取的商品\n2. **數據範圍** - US only, World only, 或兩者\n3. **輸出設定** - 輸出目錄、格式、儲存後端\n4. **解析設定** - PDF/HTML 優先順序、fallback 行為\n5. **驗證設定** - 驗證嚴格度、容許誤差\n\n**Step 2: 商品配置**\n\n```yaml\n# 商品群組快捷選項\ncommodity_groups:\n  all:\n    description: \"所有商品\"\n    includes:\n      - grains\n      - oilseeds\n      - cotton\n      - livestock\n      - sugar\n\n  grains:\n    description: \"穀物類\"\n    includes:\n      - wheat\n      - wheat_by_class\n      - corn\n      - rice\n      - barley\n      - sorghum\n      - oats\n\n  oilseeds:\n    description: \"油籽類\"\n    includes:\n      - soybeans\n      - soybean_oil\n      - soybean_meal\n\n  cotton:\n    description: \"棉花\"\n    includes:\n      - cotton_us\n      - cotton_world\n\n  livestock:\n    description: \"畜產品（僅 US）\"\n    includes:\n      - beef\n      - pork\n      - broiler\n      - turkey\n      - eggs\n      - dairy\n\n  sugar:\n    description: \"糖（US + Mexico）\"\n    includes:\n      - sugar_us\n      - sugar_mexico\n\n# 單一商品選項\nindividual_commodities:\n  - wheat\n  - corn\n  - soybeans\n  - rice\n  - cotton\n  - beef\n  - pork\n  # ... 完整列表見 references/commodities-overview.md\n```\n\n**Step 3: 生成配置文件**\n\n```python\ndef generate_config(user_selections):\n    \"\"\"根據用戶選擇生成配置文件\"\"\"\n\n    config = {\n        \"version\": \"1.0\",\n        \"created_at\": datetime.now().isoformat(),\n\n        # 商品配置\n        \"commodities\": {\n            \"selection\": user_selections.get('commodities', 'all'),\n            \"scope\": user_selections.get('scope', ['us', 'world']),\n            \"exclude\": user_selections.get('exclude', [])\n        },\n\n        # 輸出配置\n        \"output\": {\n            \"dir\": user_selections.get('output_dir', './data/wasde'),\n            \"format\": user_selections.get('format', 'parquet'),\n            \"storage\": {\n                \"kind\": user_selections.get('storage_kind', 'local'),\n                \"bucket\": user_selections.get('bucket'),\n                \"prefix\": user_selections.get('prefix')\n            }\n        },\n\n        # 解析配置\n        \"parsing\": {\n            \"prefer\": user_selections.get('prefer_format', 'pdf'),\n            \"allow_fallback\": user_selections.get('allow_fallback', True),\n            \"fuzzy_match_threshold\": user_selections.get('fuzzy_threshold', 0.8),\n            \"locale\": user_selections.get('locale', 'en_US')\n        },\n\n        # 驗證配置\n        \"validation\": {\n            \"strict_mode\": user_selections.get('strict_mode', False),\n            \"balance_tolerance\": user_selections.get('balance_tolerance', 'auto'),\n            \"range_check\": user_selections.get('range_check', True),\n            \"schema_drift_action\": user_selections.get('drift_action', 'warn')\n        },\n\n        # 網路配置\n        \"network\": {\n            \"timeout_seconds\": user_selections.get('timeout', 30),\n            \"max_retries\": user_selections.get('max_retries', 5),\n            \"backoff_strategy\": \"exponential\",\n            \"user_agent\": \"WASDE-Ingestor/0.2.0\"\n        },\n\n        # 日誌配置\n        \"logging\": {\n            \"level\": user_selections.get('log_level', 'info'),\n            \"emit_metrics\": user_selections.get('emit_metrics', True),\n            \"trace_spans\": user_selections.get('trace_spans', True)\n        }\n    }\n\n    return config\n```\n\n**Step 4: 驗證配置**\n\n```python\ndef validate_config(config):\n    \"\"\"驗證配置的有效性\"\"\"\n\n    errors = []\n    warnings = []\n\n    # 檢查商品配置\n    valid_commodities = get_all_valid_commodities()\n    if config['commodities']['selection'] not in ['all'] + list(commodity_groups.keys()):\n        if not all(c in valid_commodities for c in config['commodities']['selection']):\n            errors.append(\"Invalid commodity in selection\")\n\n    # 檢查 scope 配置\n    if 'world' in config['commodities']['scope']:\n        livestock_selected = any(\n            c in ['beef', 'pork', 'broiler', 'turkey', 'eggs', 'dairy', 'livestock']\n            for c in expand_commodity_selection(config['commodities']['selection'])\n        )\n        if livestock_selected:\n            warnings.append(\"Livestock commodities only have US data, world scope will be ignored\")\n\n    # 檢查輸出目錄\n    output_dir = config['output']['dir']\n    if not os.path.exists(output_dir):\n        warnings.append(f\"Output directory {output_dir} does not exist, will be created\")\n\n    # 檢查儲存配置\n    if config['output']['storage']['kind'] in ['s3', 'gcs']:\n        if not config['output']['storage']['bucket']:\n            errors.append(\"Bucket is required for S3/GCS storage\")\n\n    return {\n        \"valid\": len(errors) == 0,\n        \"errors\": errors,\n        \"warnings\": warnings\n    }\n```\n\n**Step 5: 保存配置**\n\n```python\nimport yaml\n\ndef save_config(config, output_path=None):\n    \"\"\"保存配置到文件\"\"\"\n\n    if output_path is None:\n        output_path = os.path.join(config['output']['dir'], 'wasde_config.yaml')\n\n    # 確保目錄存在\n    os.makedirs(os.path.dirname(output_path), exist_ok=True)\n\n    with open(output_path, 'w') as f:\n        yaml.dump(config, f, default_flow_style=False, allow_unicode=True)\n\n    print(f\"Configuration saved to: {output_path}\")\n    return output_path\n```\n\n**Step 6: 載入配置**\n\n```python\ndef load_config(config_path=None):\n    \"\"\"載入配置文件\"\"\"\n\n    if config_path is None:\n        # 嘗試默認位置\n        default_paths = [\n            './wasde_config.yaml',\n            './data/wasde/wasde_config.yaml',\n            os.path.expanduser('~/.wasde/config.yaml')\n        ]\n        for path in default_paths:\n            if os.path.exists(path):\n                config_path = path\n                break\n\n    if config_path is None:\n        return get_default_config()\n\n    with open(config_path, 'r') as f:\n        config = yaml.safe_load(f)\n\n    # 合併默認值\n    config = merge_with_defaults(config, get_default_config())\n\n    return config\n```\n</process>\n\n<config_templates>\n**常用配置模板：**\n\n**穀物分析師：**\n```yaml\ncommodities:\n  selection: grains\n  scope: [us, world]\noutput:\n  dir: ./data/grains\nvalidation:\n  strict_mode: true\n```\n\n**大豆專家：**\n```yaml\ncommodities:\n  selection: oilseeds\n  scope: [us, world]\noutput:\n  dir: ./data/oilseeds\nvalidation:\n  balance_tolerance: 5.0\n```\n\n**美國畜產：**\n```yaml\ncommodities:\n  selection: livestock\n  scope: [us]\noutput:\n  dir: ./data/livestock\n```\n\n**完整監控：**\n```yaml\ncommodities:\n  selection: all\n  scope: [us, world]\noutput:\n  dir: ./data/wasde\nlogging:\n  level: debug\n  emit_metrics: true\n```\n</config_templates>\n\n<success_criteria>\n此工作流程成功完成時：\n- [ ] 用戶確認商品選擇\n- [ ] 生成有效的配置文件\n- [ ] 配置驗證通過（無 errors）\n- [ ] 配置文件保存成功\n- [ ] 用戶了解所有 warnings\n</success_criteria>\n",
        "skills/wasde-ingestor/workflows/ingest.md": "<required_reading>\n**執行此工作流程前，請先閱讀：**\n1. references/commodities-overview.md - 了解商品範圍與單位\n2. references/validation-rules.md - 了解驗證規則\n3. references/failure-modes.md - 了解失敗處理\n4. 根據指定商品，閱讀對應的參考文件（grains.md, oilseeds.md 等）\n</required_reading>\n\n<objective>\n抓取並解析最新或指定月份的 WASDE 報告，提取指定商品的供需數據。\n</objective>\n\n<process>\n**Step 1: 確認參數**\n\n詢問或確認以下參數：\n\n```yaml\nparameters:\n  commodities:\n    description: \"要抓取的商品\"\n    options:\n      - all          # 所有商品\n      - grains       # Wheat, Corn, Rice, Barley, Sorghum, Oats\n      - oilseeds     # Soybeans, Soybean Oil, Soybean Meal\n      - cotton       # Cotton\n      - livestock    # Beef, Pork, Broiler, Turkey, Eggs, Dairy\n      - sugar        # US & Mexico Sugar\n      - [specific]   # 指定單一商品，如 \"corn\", \"soybeans\"\n    default: \"all\"\n\n  scope:\n    description: \"數據範圍\"\n    options: [\"us\", \"world\", \"us,world\"]\n    default: \"us,world\"\n\n  release_date:\n    description: \"報告發布日期\"\n    format: \"YYYY-MM-DD\"\n    default: \"latest\"  # 抓取最新\n\n  output_dir:\n    description: \"輸出目錄\"\n    default: \"./data/wasde\"\n```\n\n**Step 2: 發現報告 URL**\n\n```python\n# 使用 scripts/discover_releases.py\nfrom scripts.discover_releases import discover_latest_release, discover_by_date\n\nif release_date == \"latest\":\n    release_info = discover_latest_release()\nelse:\n    release_info = discover_by_date(release_date)\n\n# release_info 包含:\n# - release_date: \"2025-01-10\"\n# - pdf_url: \"https://www.usda.gov/oce/commodity/wasde/wasde0125.pdf\"\n# - html_url: \"https://www.usda.gov/oce/commodity/wasde/\"\n```\n\n**Step 3: 下載報告**\n\n```python\n# 使用 scripts/fetch_report.py\nfrom scripts.fetch_report import fetch_pdf, fetch_html\n\n# 嘗試下載 PDF\npdf_path = fetch_pdf(\n    url=release_info['pdf_url'],\n    output_dir=f\"{output_dir}/raw/{release_info['release_date']}\",\n    retry_config={\n        \"max_attempts\": 5,\n        \"backoff\": [1, 2, 4, 8, 16]\n    }\n)\n\n# 如果 PDF 失敗，嘗試 HTML\nif not pdf_path and config.allow_fallback:\n    html_content = fetch_html(release_info['html_url'])\n```\n\n**Step 4: 解析表格**\n\n```python\n# 使用 scripts/parse_tables.py\nfrom scripts.parse_tables import parse_wasde_pdf, parse_wasde_html\n\n# 根據商品配置決定要解析的表格\ntables_to_parse = get_tables_for_commodities(commodities, scope)\n\n# 解析\nif pdf_path:\n    parsed_data = parse_wasde_pdf(\n        pdf_path=pdf_path,\n        tables=tables_to_parse,\n        fuzzy_match=True,\n        fuzzy_threshold=0.8\n    )\nelse:\n    parsed_data = parse_wasde_html(\n        html_content=html_content,\n        tables=tables_to_parse\n    )\n```\n\n**Step 5: 標準化數據**\n\n```python\n# 標準化欄位名稱\ndef normalize_fields(raw_data, commodity):\n    \"\"\"使用欄位映射標準化\"\"\"\n    field_map = load_field_map(commodity)  # 從 references 載入\n\n    normalized = {}\n    for raw_field, value in raw_data.items():\n        standard_field = map_field(raw_field, field_map)\n        if standard_field:\n            normalized[standard_field] = value\n\n    return normalized\n\n# 標準化單位\ndef normalize_units(data, commodity, scope):\n    \"\"\"確保單位一致\"\"\"\n    expected_unit = get_expected_unit(commodity, scope)\n    data['unit'] = expected_unit\n    return data\n\n# 計算衍生欄位\ndef compute_derived_fields(data):\n    \"\"\"計算 stocks_to_use 等衍生欄位\"\"\"\n    if data.get('ending_stocks') and data.get('total_use'):\n        data['stocks_to_use'] = data['ending_stocks'] / data['total_use']\n    return data\n```\n\n**Step 6: 驗證數據**\n\n```python\n# 使用 scripts/validate_data.py\nfrom scripts.validate_data import (\n    validate_balance,\n    validate_range,\n    validate_schema\n)\n\nvalidation_results = []\n\nfor commodity, data in normalized_data.items():\n    # 平衡公式檢查\n    balance_ok = validate_balance(data, tolerance=get_tolerance(commodity))\n\n    # 數值範圍檢查\n    range_ok = validate_range(data, commodity)\n\n    # Schema 檢查\n    schema_ok = validate_schema(data, commodity)\n\n    validation_results.append({\n        \"commodity\": commodity,\n        \"balance_check\": balance_ok,\n        \"range_check\": range_ok,\n        \"schema_check\": schema_ok,\n        \"overall\": balance_ok and range_ok and schema_ok\n    })\n```\n\n**Step 7: 計算 Content Hash**\n\n```python\nimport hashlib\nimport json\n\ndef compute_content_hash(row):\n    \"\"\"計算數據行的 content hash\"\"\"\n    # 排除 metadata 欄位\n    exclude = ['content_hash', 'created_at', 'updated_at']\n    data = {k: v for k, v in row.items() if k not in exclude}\n\n    # 處理浮點數精度\n    for k, v in data.items():\n        if isinstance(v, float):\n            data[k] = round(v, 6)\n\n    content_str = json.dumps(data, sort_keys=True, default=str)\n    return hashlib.sha256(content_str.encode()).hexdigest()[:32]\n```\n\n**Step 8: 寫入輸出**\n\n```python\nimport pandas as pd\n\n# 建立輸出目錄結構\noutput_paths = {\n    \"raw\": f\"{output_dir}/raw/{release_date}\",\n    \"intermediate\": f\"{output_dir}/intermediate/{release_date}\",\n    \"curated\": f\"{output_dir}/curated\"\n}\n\n# 寫入中間文件\nwith open(f\"{output_paths['intermediate']}/tables.json\", 'w') as f:\n    json.dump(parsed_data, f, indent=2)\n\n# 寫入 curated parquet\nfor commodity, data in curated_data.items():\n    df = pd.DataFrame([data])\n    df['release_date'] = release_date\n    df['content_hash'] = compute_content_hash(data)\n\n    parquet_path = f\"{output_paths['curated']}/{commodity}_balance.parquet\"\n\n    # Append 或 create\n    if os.path.exists(parquet_path):\n        existing = pd.read_parquet(parquet_path)\n        df = pd.concat([existing, df]).drop_duplicates(\n            subset=['release_date', 'marketing_year', 'commodity'],\n            keep='last'\n        )\n\n    df.to_parquet(parquet_path, index=False)\n```\n\n**Step 9: 生成狀態報告**\n\n```python\n# 生成 ingest_status\ningest_status = {\n    \"release_date\": release_date,\n    \"success\": all(v['overall'] for v in validation_results),\n    \"commodities_processed\": list(curated_data.keys()),\n    \"warnings\": collect_warnings(),\n    \"errors\": collect_errors(),\n    \"rows_written\": {c: 1 for c in curated_data.keys()},\n    \"timing_ms\": {\n        \"fetch\": fetch_time_ms,\n        \"parse\": parse_time_ms,\n        \"validate\": validate_time_ms,\n        \"write\": write_time_ms\n    }\n}\n\n# 寫入狀態文件\nwith open(f\"{output_paths['intermediate']}/ingest_status.json\", 'w') as f:\n    json.dump(ingest_status, f, indent=2)\n```\n</process>\n\n<success_criteria>\n此工作流程成功完成時：\n- [ ] 成功下載 WASDE 報告（PDF 或 HTML）\n- [ ] 解析所有指定商品的表格\n- [ ] 所有數據通過平衡公式驗證\n- [ ] 所有數據通過數值範圍檢查\n- [ ] 輸出 curated parquet 文件\n- [ ] 生成 ingest_status.json 且 success=true\n- [ ] 無 error 級別的日誌\n</success_criteria>\n\n<error_handling>\n**錯誤處理：**\n\n1. **網路錯誤** → 重試最多 5 次，指數退避\n2. **PDF 解析失敗** → 嘗試 HTML fallback\n3. **表格未找到** → 使用模糊匹配，記錄警告\n4. **驗證失敗** → 根據配置決定是輸出部分數據還是完全失敗\n5. **Schema Drift** → 記錄詳細報告，通知維護者\n\n參見 references/failure-modes.md 了解完整的錯誤處理策略。\n</error_handling>\n",
        "skills/wasde-ingestor/workflows/validate.md": "<required_reading>\n**執行此工作流程前，請先閱讀：**\n1. references/validation-rules.md - 了解驗證規則\n2. references/failure-modes.md - 了解錯誤處理\n</required_reading>\n\n<objective>\n驗證現有 WASDE 數據的一致性，識別數據修正，並與最新報告進行比對。\n</objective>\n\n<process>\n**Step 1: 確認驗證模式**\n\n```yaml\nvalidation_modes:\n  integrity:\n    description: \"檢查現有數據的完整性與一致性\"\n    checks:\n      - balance_formula\n      - value_range\n      - schema_compliance\n      - no_duplicates\n\n  revision:\n    description: \"識別 USDA 數據修正\"\n    checks:\n      - compare_with_latest\n      - flag_revisions\n      - track_changes\n\n  freshness:\n    description: \"檢查數據是否為最新\"\n    checks:\n      - latest_release_available\n      - missing_releases\n```\n\n**Step 2: 載入現有數據**\n\n```python\nimport pandas as pd\nimport os\n\ndef load_existing_data(data_dir, commodity=None):\n    \"\"\"載入現有的 curated 數據\"\"\"\n\n    curated_dir = f\"{data_dir}/curated\"\n    data = {}\n\n    if commodity:\n        parquet_path = f\"{curated_dir}/{commodity}_balance.parquet\"\n        if os.path.exists(parquet_path):\n            data[commodity] = pd.read_parquet(parquet_path)\n    else:\n        # 載入所有商品\n        for f in os.listdir(curated_dir):\n            if f.endswith('_balance.parquet'):\n                commodity_name = f.replace('_balance.parquet', '')\n                data[commodity_name] = pd.read_parquet(f\"{curated_dir}/{f}\")\n\n    return data\n```\n\n**Step 3: 完整性驗證**\n\n```python\nfrom scripts.validate_data import (\n    validate_balance,\n    validate_range,\n    check_duplicates\n)\n\ndef run_integrity_check(df, commodity):\n    \"\"\"執行完整性檢查\"\"\"\n\n    results = {\n        \"commodity\": commodity,\n        \"total_rows\": len(df),\n        \"issues\": []\n    }\n\n    # 平衡公式檢查\n    for idx, row in df.iterrows():\n        balance_ok, diff = validate_balance(row.to_dict())\n        if not balance_ok:\n            results['issues'].append({\n                \"row_index\": idx,\n                \"release_date\": row['release_date'],\n                \"marketing_year\": row['marketing_year'],\n                \"type\": \"balance_error\",\n                \"details\": f\"Balance diff: {diff}\"\n            })\n\n    # 數值範圍檢查\n    for idx, row in df.iterrows():\n        range_issues = validate_range(row.to_dict(), commodity)\n        for issue in range_issues:\n            results['issues'].append({\n                \"row_index\": idx,\n                \"release_date\": row['release_date'],\n                \"marketing_year\": row['marketing_year'],\n                \"type\": \"range_warning\",\n                \"details\": issue\n            })\n\n    # 重複檢查\n    duplicates = check_duplicates(df, ['release_date', 'marketing_year', 'commodity'])\n    for dup in duplicates:\n        results['issues'].append({\n            \"type\": \"duplicate\",\n            \"details\": dup\n        })\n\n    results['valid_rows'] = results['total_rows'] - len([\n        i for i in results['issues'] if i['type'] == 'balance_error'\n    ])\n    results['integrity_score'] = results['valid_rows'] / results['total_rows'] * 100\n\n    return results\n```\n\n**Step 4: 修正值識別**\n\n```python\ndef detect_revisions(existing_data, latest_data, commodity):\n    \"\"\"比對現有數據與最新數據，識別修正值\"\"\"\n\n    revisions = []\n\n    # 找出重疊的 marketing years\n    existing_mys = set(existing_data['marketing_year'].unique())\n    latest_mys = set(latest_data['marketing_year'].unique())\n    overlap_mys = existing_mys & latest_mys\n\n    for my in overlap_mys:\n        existing_row = existing_data[existing_data['marketing_year'] == my].iloc[-1]\n        latest_row = latest_data[latest_data['marketing_year'] == my].iloc[0]\n\n        # 比較數值欄位\n        numeric_fields = [\n            'beginning_stocks', 'production', 'imports',\n            'exports', 'ending_stocks', 'total_use'\n        ]\n\n        for field in numeric_fields:\n            if field not in existing_row or field not in latest_row:\n                continue\n\n            old_val = existing_row.get(field)\n            new_val = latest_row.get(field)\n\n            if pd.isna(old_val) or pd.isna(new_val):\n                continue\n\n            if abs(old_val - new_val) > 0.001:  # 有差異\n                revisions.append({\n                    \"marketing_year\": my,\n                    \"field\": field,\n                    \"old_value\": old_val,\n                    \"new_value\": new_val,\n                    \"change\": new_val - old_val,\n                    \"change_pct\": (new_val - old_val) / old_val * 100 if old_val != 0 else None,\n                    \"old_release\": existing_row['release_date'],\n                    \"new_release\": latest_row['release_date']\n                })\n\n    return revisions\n```\n\n**Step 5: 新鮮度檢查**\n\n```python\nfrom scripts.discover_releases import discover_latest_release\nfrom datetime import datetime, timedelta\n\ndef check_freshness(existing_data, commodity):\n    \"\"\"檢查數據新鮮度\"\"\"\n\n    # 獲取最新可用的 release\n    latest_available = discover_latest_release()\n\n    # 獲取現有數據的最新 release\n    latest_in_data = existing_data['release_date'].max()\n\n    is_current = str(latest_in_data) == latest_available['release_date']\n\n    # 計算缺失的 releases\n    missing_releases = []\n    if not is_current:\n        # 列出從 latest_in_data 到 latest_available 之間的所有 releases\n        from scripts.discover_releases import get_release_calendar\n        all_releases = get_release_calendar(\n            start=datetime.strptime(str(latest_in_data), \"%Y-%m-%d\"),\n            end=datetime.strptime(latest_available['release_date'], \"%Y-%m-%d\")\n        )\n        existing_dates = set(existing_data['release_date'].astype(str).unique())\n        missing_releases = [\n            r['release_date'] for r in all_releases\n            if r['release_date'] not in existing_dates\n        ]\n\n    return {\n        \"commodity\": commodity,\n        \"latest_available\": latest_available['release_date'],\n        \"latest_in_data\": str(latest_in_data),\n        \"is_current\": is_current,\n        \"missing_releases\": missing_releases,\n        \"days_behind\": (\n            datetime.strptime(latest_available['release_date'], \"%Y-%m-%d\") -\n            datetime.strptime(str(latest_in_data), \"%Y-%m-%d\")\n        ).days if not is_current else 0\n    }\n```\n\n**Step 6: 生成驗證報告**\n\n```python\ndef generate_validation_report(\n    integrity_results,\n    revision_results,\n    freshness_results,\n    output_dir\n):\n    \"\"\"生成完整的驗證報告\"\"\"\n\n    report = {\n        \"validation_timestamp\": datetime.now().isoformat(),\n        \"summary\": {\n            \"commodities_validated\": len(integrity_results),\n            \"overall_integrity_score\": sum(\n                r['integrity_score'] for r in integrity_results.values()\n            ) / len(integrity_results),\n            \"total_issues\": sum(\n                len(r['issues']) for r in integrity_results.values()\n            ),\n            \"revisions_detected\": sum(\n                len(r) for r in revision_results.values()\n            ),\n            \"commodities_current\": sum(\n                1 for r in freshness_results.values() if r['is_current']\n            )\n        },\n        \"integrity\": integrity_results,\n        \"revisions\": revision_results,\n        \"freshness\": freshness_results,\n        \"recommendations\": generate_recommendations(\n            integrity_results,\n            revision_results,\n            freshness_results\n        )\n    }\n\n    # 寫入報告\n    report_path = f\"{output_dir}/validation_report_{datetime.now():%Y%m%d_%H%M%S}.json\"\n    with open(report_path, 'w') as f:\n        json.dump(report, f, indent=2, default=str)\n\n    return report\n\ndef generate_recommendations(integrity, revisions, freshness):\n    \"\"\"生成建議操作\"\"\"\n\n    recommendations = []\n\n    # 完整性問題\n    for commodity, result in integrity.items():\n        if result['integrity_score'] < 95:\n            recommendations.append({\n                \"priority\": \"high\",\n                \"commodity\": commodity,\n                \"action\": \"re-ingest\",\n                \"reason\": f\"Integrity score {result['integrity_score']:.1f}% below threshold\"\n            })\n\n    # 修正值處理\n    for commodity, revs in revisions.items():\n        significant_revs = [r for r in revs if abs(r.get('change_pct', 0) or 0) > 5]\n        if significant_revs:\n            recommendations.append({\n                \"priority\": \"medium\",\n                \"commodity\": commodity,\n                \"action\": \"update_historical\",\n                \"reason\": f\"{len(significant_revs)} significant revisions detected\"\n            })\n\n    # 新鮮度問題\n    for commodity, result in freshness.items():\n        if result['days_behind'] > 30:\n            recommendations.append({\n                \"priority\": \"high\",\n                \"commodity\": commodity,\n                \"action\": \"ingest_latest\",\n                \"reason\": f\"Data is {result['days_behind']} days behind\"\n            })\n        elif result['missing_releases']:\n            recommendations.append({\n                \"priority\": \"medium\",\n                \"commodity\": commodity,\n                \"action\": \"backfill\",\n                \"reason\": f\"{len(result['missing_releases'])} missing releases\"\n            })\n\n    return sorted(recommendations, key=lambda x: {\"high\": 0, \"medium\": 1, \"low\": 2}[x['priority']])\n```\n\n**Step 7: 執行修復（可選）**\n\n```python\ndef apply_fixes(recommendations, config):\n    \"\"\"根據建議執行修復\"\"\"\n\n    for rec in recommendations:\n        if rec['action'] == 'ingest_latest':\n            # 執行最新 ingest\n            from workflows.ingest import run_single_ingest\n            run_single_ingest(\n                release_info=\"latest\",\n                commodities=[rec['commodity']],\n                scope=config.scope,\n                output_dir=config.output_dir\n            )\n\n        elif rec['action'] == 'backfill':\n            # 執行 backfill\n            from workflows.backfill import run_backfill\n            # ... backfill missing releases\n\n        elif rec['action'] == 're-ingest':\n            # 重新 ingest 有問題的數據\n            # ... re-ingest with force=True\n            pass\n```\n</process>\n\n<success_criteria>\n此工作流程成功完成時：\n- [ ] 完成所有指定商品的完整性檢查\n- [ ] 識別並記錄所有數據修正\n- [ ] 檢查數據新鮮度\n- [ ] 生成完整的 validation_report.json\n- [ ] 提供可操作的修復建議\n</success_criteria>\n\n<scheduled_validation>\n**建議定期執行：**\n\n```yaml\nschedule:\n  integrity_check:\n    frequency: \"weekly\"\n    day: \"Sunday\"\n\n  revision_check:\n    frequency: \"monthly\"\n    trigger: \"after WASDE release\"\n\n  freshness_check:\n    frequency: \"daily\"\n    alert_if_behind: 7  # days\n```\n</scheduled_validation>\n",
        "skills/zeberg-salomon-rotator/SKILL.md": "---\nname: zeberg-salomon-rotator\ndescription: 用領先和同時指標建構景氣模型，並判讀兩種景氣階段：景氣擴張期 (Risk-On) 與景氣收縮期 (Risk-Off)，並根據理論給出 \"撞冰山\" 與 \"下沉\" 事件訊號。\n---\n\n<essential_principles>\n\n<principle name=\"two_state_model\">\n**兩態切換模型核心**\n\nZeberg–Salomon 模型將市場簡化為兩種狀態：\n- **RISK_ON**: 持有股票（SPY），景氣擴張期\n- **RISK_OFF**: 持有長債（TLT），景氣收縮期\n\n切換邏輯基於「領先指標先轉弱，同時指標後確認」的景氣循環規律。\n</principle>\n\n<principle name=\"leading_coincident\">\n**領先 vs 同時指標**\n\n| 類型       | 作用 | 典型成分                     | 領先時間 |\n|------------|------|------------------------------|----------|\n| Leading    | 預警 | 殖利率曲線、新訂單、房市許可 | 6-12 月  |\n| Coincident | 確認 | 就業、工業生產、實質收入     | 同步     |\n\n**合成方式**：\n1. 各序列做 transform（yoy/mom/diff）\n2. 統一方向（direction +1/-1）\n3. Rolling z-score 標準化\n4. EMA 平滑\n5. 加權合成\n</principle>\n\n<principle name=\"iceberg_sinking\">\n**冰山事件 vs 下沉事件**\n\n```\nIceberg Event: LeadingIndex < iceberg_threshold\n  → 預警：景氣開始轉弱\n  → 搭配「領先指標下降」+ 可選「市場亢奮」濾鏡\n\nSinking Event: CoincidentIndex < sinking_threshold\n  → 確認：實體經濟收縮\n  → 通常在 Iceberg 之後數月發生\n```\n\n**狀態機邏輯**：\n- RISK_ON → RISK_OFF：Iceberg 連續確認 + 斜率為負\n- RISK_OFF → RISK_ON：領先指標回升超過 (threshold + hysteresis)\n</principle>\n\n<principle name=\"data_access\">\n**資料取得方式**\n\n本 skill 使用**無需 API key** 的資料來源：\n- **FRED CSV**: `https://fred.stlouisfed.org/graph/fredgraph.csv?id={SERIES_ID}`\n- **Yahoo Finance**: `yfinance` 套件抓取 SPY, TLT, VIX\n\n腳本位於 `scripts/` 目錄，可直接執行。\n</principle>\n\n</essential_principles>\n\n<objective>\n實作 Zeberg–Salomon 兩態輪動策略：\n\n1. **建構指標**：從 FRED 數據合成 LeadingIndex 與 CoincidentIndex\n2. **偵測事件**：識別「冰山」（領先轉弱）與「下沉」（同時確認）\n3. **切換訊號**：產生 RISK_ON ↔ RISK_OFF 切換事件\n4. **回測績效**：計算累積報酬、MaxDD、CAGR、與 benchmark 比較\n\n輸出：切換事件清單、指標時間序列、回測摘要、診斷資訊。\n</objective>\n\n<quick_start>\n\n**最快的方式：執行預設回測**\n\n```bash\ncd skills/zeberg-salomon-rotator\npip install pandas numpy yfinance pandas-datareader  # 首次使用\npython scripts/rotator.py --quick\n```\n\n輸出範例：\n```json\n{\n  \"state\": \"RISK_ON\",\n  \"latest_indices\": {\"LeadingIndex\": 0.41, \"CoincidentIndex\": 0.22},\n  \"iceberg_event\": false,\n  \"sinking_event\": false,\n  \"last_switch\": {\"date\": \"2023-06-30\", \"action\": \"EXIT_LONG_BOND_ENTER_EQUITY\"}\n}\n```\n\n**完整回測**：\n```bash\npython scripts/rotator.py --start 2000-01-01 --end 2026-01-01 --output result.json\n```\n\n</quick_start>\n\n<intake>\n需要進行什麼操作？\n\n1. **快速檢查** - 查看目前的景氣狀態與最新指標\n2. **完整回測** - 執行完整的歷史回測與績效分析\n3. **視覺化圖表** - 生成多面板回測結果圖表\n4. **監控模式** - 設定持續監控與切換警報\n5. **方法論學習** - 了解 Zeberg-Salomon 模型的邏輯\n\n**請選擇或直接提供分析參數。**\n</intake>\n\n<routing>\n| Response                      | Action                                      |\n|-------------------------------|---------------------------------------------|\n| 1, \"快速\", \"quick\", \"check\"   | 執行 `python scripts/rotator.py --quick`    |\n| 2, \"回測\", \"backtest\", \"full\" | 閱讀 `workflows/backtest.md` 並執行         |\n| 3, \"視覺化\", \"chart\", \"plot\"  | 閱讀 `workflows/visualize.md` 並執行        |\n| 4, \"監控\", \"monitor\", \"alert\" | 閱讀 `workflows/monitor.md` 並執行          |\n| 5, \"學習\", \"方法論\", \"why\"    | 閱讀 `references/methodology.md`            |\n| 提供參數 (如日期範圍)         | 閱讀 `workflows/backtest.md` 並使用參數執行 |\n\n**路由後，閱讀對應文件並執行。**\n</routing>\n\n<directory_structure>\n```\nzeberg-salomon-rotator/\n├── SKILL.md                           # 本文件（路由器）\n├── skill.yaml                         # 前端展示元數據\n├── manifest.json                      # 技能元數據\n├── workflows/\n│   ├── backtest.md                    # 完整回測工作流\n│   ├── visualize.md                   # 視覺化工作流\n│   ├── monitor.md                     # 持續監控工作流\n│   └── analyze.md                     # 深度分析工作流\n├── references/\n│   ├── data-sources.md                # FRED 系列代碼與資料來源\n│   ├── methodology.md                 # Zeberg-Salomon 方法論解析\n│   └── input-schema.md                # 完整輸入參數定義\n├── templates/\n│   ├── output-json.md                 # JSON 輸出模板\n│   └── output-markdown.md             # Markdown 報告模板\n└── scripts/\n    ├── rotator.py                     # 主輪動腳本\n    ├── visualize.py                   # 視覺化繪圖工具\n    └── fetch_data.py                  # 數據抓取工具\n```\n</directory_structure>\n\n<reference_index>\n\n**方法論**: references/methodology.md\n- Zeberg-Salomon 模型概念\n- 冰山/下沉事件定義\n- 兩態切換邏輯\n\n**資料來源**: references/data-sources.md\n- FRED 系列代碼（領先/同時）\n- Yahoo Finance 資產代碼\n- 數據頻率與對齊\n\n**輸入參數**: references/input-schema.md\n- 完整參數定義\n- 預設值與建議範圍\n\n</reference_index>\n\n<workflows_index>\n| Workflow     | Purpose        | 使用時機         |\n|--------------|----------------|------------------|\n| backtest.md  | 完整歷史回測   | 需要績效分析時   |\n| visualize.md | 生成視覺化圖表 | 需要圖表展示時   |\n| monitor.md   | 持續監控狀態   | 日常監控或警報   |\n| analyze.md   | 深度指標分析   | 理解當前市場狀態 |\n</workflows_index>\n\n<templates_index>\n| Template           | Purpose           |\n|--------------------|-------------------|\n| output-json.md     | JSON 輸出結構定義 |\n| output-markdown.md | Markdown 報告模板 |\n</templates_index>\n\n<scripts_index>\n| Script        | Command                       | Purpose          |\n|---------------|-------------------------------|------------------|\n| rotator.py    | `--quick`                     | 快速檢查當前狀態 |\n| rotator.py    | `--start DATE --end DATE`     | 完整回測         |\n| visualize.py  | `-i result.json -o chart.png` | 生成視覺化圖表   |\n| fetch_data.py | `--series T10Y3M,PAYEMS`      | 抓取 FRED 資料   |\n</scripts_index>\n\n<input_schema_summary>\n\n**核心參數**\n\n| 參數         | 類型   | 預設值     | 說明         |\n|--------------|--------|------------|--------------|\n| start_date   | string | 2000-01-01 | 回測起始日   |\n| end_date     | string | today      | 回測結束日   |\n| freq         | string | M          | 頻率（M=月） |\n| equity_proxy | string | SPY        | 風險資產代理 |\n| bond_proxy   | string | TLT        | 長債代理     |\n\n**門檻參數**\n\n| 參數              | 類型   | 預設值 | 說明         |\n|-------------------|--------|--------|--------------|\n| iceberg_threshold | number | -0.3   | 領先指標門檻 |\n| sinking_threshold | number | -0.5   | 同時指標門檻 |\n| confirm_periods   | int    | 2      | 連續確認期數 |\n| hysteresis        | number | 0.15   | 進出場間距   |\n\n完整參數定義見 `references/input-schema.md`。\n\n</input_schema_summary>\n\n<output_schema_summary>\n```json\n{\n  \"skill\": \"zeberg-salomon-rotator\",\n  \"as_of\": \"2026-01-14\",\n  \"state\": \"RISK_ON\",\n  \"latest_indices\": {\n    \"LeadingIndex\": 0.41,\n    \"CoincidentIndex\": 0.22,\n    \"iceberg_event\": false,\n    \"sinking_event\": false\n  },\n  \"switch_events\": [...],\n  \"backtest_summary\": {\n    \"cagr\": 0.123,\n    \"max_drawdown\": -0.27,\n    \"turnovers\": 10\n  }\n}\n```\n\n完整輸出結構見 `templates/output-json.md`。\n</output_schema_summary>\n\n<success_criteria>\n執行成功時應產出：\n\n- [ ] 當前狀態（RISK_ON 或 RISK_OFF）\n- [ ] LeadingIndex 與 CoincidentIndex 數值\n- [ ] 冰山/下沉事件判定\n- [ ] 切換事件清單（含日期、原因）\n- [ ] 回測績效摘要（CAGR, MaxDD, 換手次數）\n- [ ] 與 benchmark 比較（買入持有、60/40）\n- [ ] 診斷資訊（各指標貢獻）\n- [ ] 視覺化圖表（可選，輸出至 `output/` 目錄）\n</success_criteria>\n",
        "skills/zeberg-salomon-rotator/references/data-sources.md": "# 數據來源 (Data Sources)\n\n本技能使用**無需 API key** 的公開數據來源。\n\n## FRED (Federal Reserve Economic Data)\n\n**存取方式**：CSV endpoint（無需 API key）\n```\nhttps://fred.stlouisfed.org/graph/fredgraph.csv?id={SERIES_ID}&cosd={START_DATE}&coed={END_DATE}\n```\n\n### 領先指標 (Leading Indicators)\n\n| 系列代碼 | 名稱 | 說明 | 頻率 | 領先時間 |\n|----------|------|------|------|----------|\n| T10Y3M | 10-Year Treasury Constant Maturity Minus 3-Month | 殖利率曲線（10年-3月） | 日 | 12-18 月 |\n| T10Y2Y | 10-Year Treasury Constant Maturity Minus 2-Year | 殖利率曲線（10年-2年） | 日 | 12-18 月 |\n| PERMIT | New Privately-Owned Housing Units Authorized | 建築許可（房市領先） | 月 | 6-12 月 |\n| ACDGNO | Value of Manufacturers' New Orders: Durable Goods | 耐久財新訂單 | 月 | 3-6 月 |\n| UMCSENT | University of Michigan: Consumer Sentiment | 消費者信心指數 | 月 | 3-6 月 |\n| HOUST | Housing Starts | 新屋開工 | 月 | 6-12 月 |\n| NEWORDER | Manufacturers' New Orders: Nondefense Capital Goods | 非國防資本財訂單 | 月 | 3-6 月 |\n\n### 同時指標 (Coincident Indicators)\n\n| 系列代碼 | 名稱 | 說明 | 頻率 |\n|----------|------|------|------|\n| PAYEMS | All Employees, Total Nonfarm | 非農就業 | 月 |\n| INDPRO | Industrial Production Index | 工業生產指數 | 月 |\n| W875RX1 | Real Personal Income Excluding Current Transfer Receipts | 實質個人所得（排除轉移支付） | 月 |\n| CMRMTSPL | Real Manufacturing and Trade Industries Sales | 實質製造與貿易銷售 | 月 |\n| UNRATE | Unemployment Rate | 失業率（方向相反） | 月 |\n\n### 風險濾鏡指標 (Risk Filter Indicators)\n\n| 系列代碼 | 名稱 | 說明 | 用途 |\n|----------|------|------|------|\n| BAA10Y | Moody's Baa Corporate Bond Yield Relative to 10-Year Treasury | Baa 信用利差 | Euphoria filter |\n| AAA10Y | Moody's Aaa Corporate Bond Yield Relative to 10-Year Treasury | Aaa 信用利差 | Euphoria filter |\n| VIXCLS | CBOE Volatility Index (VIX) | VIX 波動率指數 | Euphoria filter |\n| BAMLH0A0HYM2 | ICE BofA US High Yield Index Option-Adjusted Spread | 高收益債利差 | Euphoria filter |\n\n## Yahoo Finance\n\n**存取方式**：`yfinance` Python 套件\n\n### 價格資產 (Price Assets)\n\n| Ticker | 名稱 | 說明 | 用途 |\n|--------|------|------|------|\n| SPY | SPDR S&P 500 ETF | S&P 500 指數 ETF | Risk-On 資產 |\n| TLT | iShares 20+ Year Treasury Bond ETF | 20年以上國債 ETF | Risk-Off 資產 |\n| ^GSPC | S&P 500 Index | S&P 500 指數 | 替代 SPY |\n| ^VIX | CBOE Volatility Index | VIX 指數 | 風險濾鏡 |\n\n### 價格數據說明\n\n- 使用 **Adjusted Close** 價格（含配息再投資）\n- 月頻數據取**月末收盤價**\n- TLT 從 2002 年開始有數據，之前需用 FRED 長債指數替代\n\n## 數據對齊 (Data Alignment)\n\n### 頻率對齊\n\n所有數據統一對齊到**月頻（M）**：\n- 日頻數據：取月末值或月均值\n- 月頻數據：直接使用\n- 價格數據：取月末收盤價\n\n### 時區與日期\n\n- FRED 數據以美東時間為準\n- Yahoo 數據以美東時間為準\n- 統一使用 **UTC** 或 **America/New_York**\n\n### 發布延遲 (Publication Lag)\n\n| 數據類型 | 典型延遲 | 說明 |\n|----------|----------|------|\n| 殖利率曲線 | 1 日 | 即時性高 |\n| 工業生產 | 15 天 | 月中發布上月數據 |\n| 就業數據 | 5 天 | 月初發布上月數據 |\n| 建築許可 | 18 天 | 月中發布上月數據 |\n| 消費者信心 | 立即 | 調查完成即發布 |\n\n**實務建議**：回測時使用 `T-1` 或 `T-2` 月數據，模擬真實可得資訊。\n\n## 替代數據 (Alternative Data Sources)\n\n若主要數據不可用，可使用以下替代：\n\n| 主要 | 替代 | 說明 |\n|------|------|------|\n| SPY | ^GSPC, VOO | S&P 500 替代 |\n| TLT | VGLT, FRED:DGS20 | 長債替代 |\n| T10Y3M | 手動計算 DGS10 - DGS3MO | 殖利率曲線替代 |\n\n## FRED API 程式碼範例\n\n```python\nimport pandas as pd\nimport requests\n\ndef fetch_fred_series(series_id, start_date, end_date):\n    \"\"\"從 FRED 抓取時間序列（無需 API key）\"\"\"\n    url = f\"https://fred.stlouisfed.org/graph/fredgraph.csv\"\n    params = {\n        \"id\": series_id,\n        \"cosd\": start_date,\n        \"coed\": end_date\n    }\n    response = requests.get(url, params=params)\n    response.raise_for_status()\n\n    from io import StringIO\n    df = pd.read_csv(StringIO(response.text), parse_dates=[\"DATE\"], index_col=\"DATE\")\n    df.columns = [series_id]\n    return df\n\n# 範例：抓取殖利率曲線\nyield_curve = fetch_fred_series(\"T10Y3M\", \"2000-01-01\", \"2026-01-01\")\n```\n\n## yfinance 程式碼範例\n\n```python\nimport yfinance as yf\nimport pandas as pd\n\ndef fetch_yahoo_prices(ticker, start_date, end_date):\n    \"\"\"從 Yahoo Finance 抓取價格數據\"\"\"\n    data = yf.download(ticker, start=start_date, end=end_date, progress=False)\n    return data[\"Adj Close\"]\n\n# 範例：抓取 SPY 和 TLT\nspy = fetch_yahoo_prices(\"SPY\", \"2000-01-01\", \"2026-01-01\")\ntlt = fetch_yahoo_prices(\"TLT\", \"2002-07-01\", \"2026-01-01\")\n```\n",
        "skills/zeberg-salomon-rotator/references/input-schema.md": "# 輸入參數定義 (Input Schema)\n\n## 完整參數列表\n\n### 時間與頻率\n\n<parameter name=\"start_date\" required=\"true\">\n**Type**: string (ISO YYYY-MM-DD)\n**Description**: 回測起始日期\n**Example**: `\"2000-01-01\"`\n</parameter>\n\n<parameter name=\"end_date\" required=\"true\">\n**Type**: string (ISO YYYY-MM-DD)\n**Default**: today\n**Description**: 回測結束日期\n**Example**: `\"2026-01-15\"`\n</parameter>\n\n<parameter name=\"freq\" required=\"false\">\n**Type**: string\n**Default**: `\"M\"`\n**Options**: `M` (月) | `W` (週)\n**Description**: 數據頻率。建議使用月頻（M）以對齊宏觀數據發布週期。\n</parameter>\n\n### 標的資產（兩態資產）\n\n<parameter name=\"equity_proxy\" required=\"false\">\n**Type**: string\n**Default**: `\"SPY\"`\n**Options**: `SPY`, `^GSPC`, `VOO`\n**Description**: Risk-On 狀態持有的風險資產代理。\n</parameter>\n\n<parameter name=\"bond_proxy\" required=\"false\">\n**Type**: string\n**Default**: `\"TLT\"`\n**Options**: `TLT`, `VGLT`, `IEF`\n**Description**: Risk-Off 狀態持有的長天期公債代理。\n</parameter>\n\n<parameter name=\"use_total_return\" required=\"false\">\n**Type**: boolean\n**Default**: `false`\n**Description**: 若為 true，優先使用總報酬數據（含配息再投資）。\n</parameter>\n\n### 領先指標配置\n\n<parameter name=\"leading_series\" required=\"true\">\n**Type**: array[object]\n**Description**: 領先指標序列配置清單。\n\n**Object 結構**:\n```json\n{\n  \"id\": \"string\",        // FRED series ID 或數據鍵\n  \"transform\": \"string\", // level|yoy|mom|diff|logdiff\n  \"direction\": 1,        // +1: 上升=景氣好, -1: 上升=景氣壞\n  \"weight\": 0.25         // 權重 (所有權重總和建議為 1.0)\n}\n```\n\n**預設配置**:\n```json\n[\n  {\"id\": \"T10Y3M\", \"transform\": \"level\", \"direction\": 1, \"weight\": 0.25},\n  {\"id\": \"T10Y2Y\", \"transform\": \"level\", \"direction\": 1, \"weight\": 0.15},\n  {\"id\": \"PERMIT\", \"transform\": \"yoy\", \"direction\": 1, \"weight\": 0.20},\n  {\"id\": \"ACDGNO\", \"transform\": \"yoy\", \"direction\": 1, \"weight\": 0.20},\n  {\"id\": \"UMCSENT\", \"transform\": \"level\", \"direction\": 1, \"weight\": 0.20}\n]\n```\n</parameter>\n\n### 同時指標配置\n\n<parameter name=\"coincident_series\" required=\"true\">\n**Type**: array[object]\n**Description**: 同時指標序列配置清單。格式同 leading_series。\n\n**預設配置**:\n```json\n[\n  {\"id\": \"PAYEMS\", \"transform\": \"yoy\", \"direction\": 1, \"weight\": 0.30},\n  {\"id\": \"INDPRO\", \"transform\": \"yoy\", \"direction\": 1, \"weight\": 0.30},\n  {\"id\": \"W875RX1\", \"transform\": \"yoy\", \"direction\": 1, \"weight\": 0.20},\n  {\"id\": \"CMRMTSPL\", \"transform\": \"yoy\", \"direction\": 1, \"weight\": 0.20}\n]\n```\n</parameter>\n\n### 標準化與平滑\n\n<parameter name=\"standardize_window\" required=\"false\">\n**Type**: integer\n**Default**: `120`\n**Description**: Z-score 滾動視窗期數。以 freq 為單位，月頻 120 = 10 年。\n**Range**: 60-240\n</parameter>\n\n<parameter name=\"smooth_window\" required=\"false\">\n**Type**: integer\n**Default**: `3`\n**Description**: EMA 平滑視窗期數。\n**Range**: 1-12\n</parameter>\n\n### 門檻與切換邏輯\n\n<parameter name=\"baseline_method\" required=\"false\">\n**Type**: string\n**Default**: `\"z0\"`\n**Options**: `z0` | `percentile` | `rolling_mean`\n**Description**: 基準線計算方法。\n- `z0`: 基準線 = 0（最可重現）\n- `percentile`: 基準線 = 歷史分位數\n- `rolling_mean`: 基準線 = 滾動均值\n</parameter>\n\n<parameter name=\"iceberg_threshold\" required=\"true\">\n**Type**: number\n**Default**: `-0.3`\n**Description**: 領先指標跌破此門檻觸發「冰山事件」。若 baseline_method=z0，建議設定為 -0.3 至 0。\n**Range**: -1.0 至 0.5\n</parameter>\n\n<parameter name=\"sinking_threshold\" required=\"true\">\n**Type**: number\n**Default**: `-0.5`\n**Description**: 同時指標跌破此門檻觸發「下沉事件」。\n**Range**: -1.5 至 0\n</parameter>\n\n<parameter name=\"confirm_periods\" required=\"false\">\n**Type**: integer\n**Default**: `2`\n**Description**: 連續確認期數，避免假訊號。\n**Range**: 1-6\n</parameter>\n\n<parameter name=\"hysteresis\" required=\"false\">\n**Type**: number\n**Default**: `0.15`\n**Description**: 進出場門檻間距，避免來回抖動。\n**Range**: 0.05-0.5\n</parameter>\n\n### 濾鏡配置（可選）\n\n<parameter name=\"euphoria_filters\" required=\"false\">\n**Type**: array[object]\n**Default**: `[]`\n**Description**: 亢奮濾鏡配置。當市場亢奮時，更容易觸發 Risk-Off。\n\n**支援類型**:\n```json\n[\n  {\n    \"type\": \"credit_spread_reversal\",\n    \"series_id\": \"BAA10Y\",\n    \"z_below\": -1.0,\n    \"turn_up\": true\n  },\n  {\n    \"type\": \"vix_turn_up\",\n    \"ticker\": \"VIXCLS\",\n    \"level_below\": 15,\n    \"turn_up\": true\n  }\n]\n```\n</parameter>\n\n<parameter name=\"recovery_doubt_filters\" required=\"false\">\n**Type**: array[object]\n**Default**: `[]`\n**Description**: 復甦懷疑濾鏡配置。當市場懷疑復甦時，更容易觸發 Risk-On。\n\n**支援類型**:\n```json\n[\n  {\n    \"type\": \"leading_momentum\",\n    \"above\": 0\n  }\n]\n```\n</parameter>\n\n### 回測假設\n\n<parameter name=\"rebalance_on\" required=\"false\">\n**Type**: string\n**Default**: `\"next_month_open\"`\n**Options**: `signal_close` | `next_open` | `next_month_open`\n**Description**: 切換執行時點。建議使用 `next_month_open` 以最保守方式回測。\n</parameter>\n\n<parameter name=\"transaction_cost_bps\" required=\"false\">\n**Type**: number\n**Default**: `5`\n**Description**: 單邊交易成本（basis points）。\n**Range**: 0-50\n</parameter>\n\n<parameter name=\"slippage_bps\" required=\"false\">\n**Type**: number\n**Default**: `0`\n**Description**: 單邊滑價（basis points）。\n**Range**: 0-50\n</parameter>\n\n### 輸出配置\n\n<parameter name=\"output_format\" required=\"false\">\n**Type**: string\n**Default**: `\"json\"`\n**Options**: `json` | `markdown`\n**Description**: 輸出格式。\n</parameter>\n\n<parameter name=\"include_diagnostics\" required=\"false\">\n**Type**: boolean\n**Default**: `true`\n**Description**: 是否輸出診斷資訊（各指標貢獻、觸發原因等）。\n</parameter>\n\n## 配置範例\n\n### 基本配置\n\n```json\n{\n  \"start_date\": \"2000-01-01\",\n  \"end_date\": \"2026-01-15\",\n  \"iceberg_threshold\": -0.3,\n  \"sinking_threshold\": -0.5\n}\n```\n\n### 完整配置\n\n```json\n{\n  \"start_date\": \"1990-01-01\",\n  \"end_date\": \"2026-01-15\",\n  \"freq\": \"M\",\n  \"equity_proxy\": \"SPY\",\n  \"bond_proxy\": \"TLT\",\n  \"use_total_return\": true,\n\n  \"leading_series\": [\n    {\"id\": \"T10Y3M\", \"transform\": \"level\", \"direction\": 1, \"weight\": 0.25},\n    {\"id\": \"T10Y2Y\", \"transform\": \"level\", \"direction\": 1, \"weight\": 0.15},\n    {\"id\": \"PERMIT\", \"transform\": \"yoy\", \"direction\": 1, \"weight\": 0.20},\n    {\"id\": \"ACDGNO\", \"transform\": \"yoy\", \"direction\": 1, \"weight\": 0.20},\n    {\"id\": \"UMCSENT\", \"transform\": \"level\", \"direction\": 1, \"weight\": 0.20}\n  ],\n\n  \"coincident_series\": [\n    {\"id\": \"PAYEMS\", \"transform\": \"yoy\", \"direction\": 1, \"weight\": 0.30},\n    {\"id\": \"INDPRO\", \"transform\": \"yoy\", \"direction\": 1, \"weight\": 0.30},\n    {\"id\": \"W875RX1\", \"transform\": \"yoy\", \"direction\": 1, \"weight\": 0.20},\n    {\"id\": \"CMRMTSPL\", \"transform\": \"yoy\", \"direction\": 1, \"weight\": 0.20}\n  ],\n\n  \"standardize_window\": 120,\n  \"smooth_window\": 3,\n  \"baseline_method\": \"z0\",\n  \"iceberg_threshold\": -0.3,\n  \"sinking_threshold\": -0.5,\n  \"confirm_periods\": 2,\n  \"hysteresis\": 0.15,\n\n  \"euphoria_filters\": [\n    {\"type\": \"credit_spread_reversal\", \"series_id\": \"BAA10Y\", \"z_below\": -1.0, \"turn_up\": true}\n  ],\n\n  \"rebalance_on\": \"next_month_open\",\n  \"transaction_cost_bps\": 5,\n  \"slippage_bps\": 0,\n\n  \"output_format\": \"json\",\n  \"include_diagnostics\": true\n}\n```\n\n## CLI 參數對應\n\n```bash\npython scripts/rotator.py \\\n  --start 2000-01-01 \\\n  --end 2026-01-15 \\\n  --equity SPY \\\n  --bond TLT \\\n  --iceberg-threshold -0.3 \\\n  --sinking-threshold -0.5 \\\n  --confirm-periods 2 \\\n  --hysteresis 0.15 \\\n  --rebalance next_month_open \\\n  --cost-bps 5 \\\n  --output result.json\n```\n",
        "skills/zeberg-salomon-rotator/references/methodology.md": "# Zeberg-Salomon 方法論 (Methodology)\n\n## 模型概述\n\nZeberg-Salomon 模型是一個**兩態景氣輪動系統**，基於以下核心假設：\n\n1. **景氣循環可預測**：領先指標會比實體經濟提前 6-12 個月轉折\n2. **兩態簡化**：市場可簡化為 Risk-On（股票）與 Risk-Off（長債）兩種狀態\n3. **漸進惡化**：衰退不會突然發生，而是「先撞冰山（領先轉弱）→ 再下沉（同時確認）」\n\n## 參考來源\n\n- **Zeberg Letter**: https://swissblock.net/products/reports/zeberg-letter\n- **@SystematicPeter**: https://x.com/SystematicPeter/status/2011460563096760388\n\n## 核心概念\n\n### 1. 領先指標 vs 同時指標\n\n| 類型 | 經濟意義 | 代表序列 | 作用 |\n|------|----------|----------|------|\n| **Leading** | 預測未來景氣 | 殖利率曲線、新訂單、房市 | 預警 |\n| **Coincident** | 反映當前景氣 | 就業、工業生產、實質收入 | 確認 |\n\n**為什麼要分開**：\n- 領先指標可能「假警報」（曲線倒掛但未衰退）\n- 同時指標確認後才行動，可降低錯誤切換\n- 但也不能只看同時，那樣會太滯後\n\n### 2. 冰山事件 (Iceberg Event)\n\n**定義**：LeadingIndex 跌破 `iceberg_threshold`\n\n**比喻**：鐵達尼號撞上冰山，船體已受損，但乘客尚未感知。\n\n**訊號特徵**：\n- 殖利率曲線倒掛或壓縮\n- 新訂單/房市許可轉負\n- 消費者信心開始下滑\n- 但就業、生產仍維持\n\n**建議反應**：\n- 提高警戒\n- 若連續確認 + 斜率為負 + 市場亢奮 → 考慮 Risk-Off\n\n### 3. 下沉事件 (Sinking Event)\n\n**定義**：CoincidentIndex 跌破 `sinking_threshold`\n\n**比喻**：船開始下沉，所有人都感受到了。\n\n**訊號特徵**：\n- 就業開始惡化\n- 工業生產收縮\n- 實質收入下滑\n- 零售銷售轉弱\n\n**建議反應**：\n- 此時應已在 Risk-Off\n- 若尚未切換，需立即行動\n- 但注意：此時切換可能已較晚\n\n### 4. 復甦訊號 (Recovery Signal)\n\n**定義**：LeadingIndex 回升超過 `iceberg_threshold + hysteresis`\n\n**訊號特徵**：\n- 殖利率曲線正常化\n- 新訂單回升\n- 消費者信心觸底回升\n- 房市活動恢復\n\n**建議反應**：\n- 連續確認後 → Risk-On\n\n## 合成指標計算\n\n### Step 1: 數據轉換 (Transform)\n\n將各原始序列轉換為可比較的形式：\n\n| 轉換 | 公式 | 適用 |\n|------|------|------|\n| level | 原值 | 殖利率曲線、情緒指標 |\n| yoy | (x_t - x_{t-12}) / x_{t-12} | 數量型指標 |\n| mom | (x_t - x_{t-1}) / x_{t-1} | 月變化 |\n| diff | x_t - x_{t-1} | 絕對變化 |\n| logdiff | ln(x_t) - ln(x_{t-1}) | 對數報酬 |\n\n### Step 2: 方向統一 (Direction)\n\n確保「上升 = 景氣好」：\n\n```python\nx = direction * x\n# direction = +1: 上升為好（多數指標）\n# direction = -1: 下降為好（如失業率）\n```\n\n### Step 3: 標準化 (Standardization)\n\nRolling z-score 將不同量綱統一：\n\n```python\ndef rolling_zscore(x, window):\n    mean = x.rolling(window).mean()\n    std = x.rolling(window).std()\n    return (x - mean) / std\n```\n\n**建議 window**：120 期（月頻 = 10 年）\n\n### Step 4: 平滑 (Smoothing)\n\nEMA 降低雜訊：\n\n```python\ndef ema(x, span):\n    return x.ewm(span=span, adjust=False).mean()\n```\n\n**建議 span**：3-6 期（月頻）\n\n### Step 5: 加權合成 (Weighted Sum)\n\n```python\ndef build_index(series_defs, data, z_win, smooth_win):\n    z_list = []\n    for sdef in series_defs:\n        x = transform(data[sdef[\"id\"]], sdef[\"transform\"])\n        x = sdef[\"direction\"] * x\n        z = rolling_zscore(x, z_win)\n        z = ema(z, smooth_win)\n        z_list.append(sdef[\"weight\"] * z)\n    return sum(z_list)\n```\n\n## 兩態切換邏輯\n\n### 狀態定義\n\n```\nRISK_ON:  持有 equity_proxy (SPY)\nRISK_OFF: 持有 bond_proxy (TLT)\n```\n\n### RISK_ON → RISK_OFF 條件\n\n```python\ncond_off = (\n    iceberg.loc[t] and           # A: 冰山事件發生\n    (dL < 0) and                  # B: 領先指標下降\n    eup.loc[t]                    # C: 亢奮濾鏡（可選）\n)\n\nif cond_off 連續 confirm_periods 期:\n    action = \"EXIT_EQUITY_ENTER_LONG_BOND\"\n    state = \"RISK_OFF\"\n```\n\n### RISK_OFF → RISK_ON 條件\n\n```python\ncond_on = (\n    (L.loc[t] > iceberg_threshold + hysteresis) and  # A: 領先回升超過門檻+間距\n    (dL > 0) and                                      # B: 領先指標上升\n    doubt.loc[t]                                      # C: 懷疑濾鏡（可選）\n)\n\nif cond_on 連續 confirm_periods 期:\n    action = \"EXIT_LONG_BOND_ENTER_EQUITY\"\n    state = \"RISK_ON\"\n```\n\n### Hysteresis 的作用\n\n防止在門檻邊界來回切換：\n\n```\niceberg_threshold = -0.3\nhysteresis = 0.15\n\nRisk-Off 觸發：L < -0.3\nRisk-On 恢復：L > -0.3 + 0.15 = -0.15\n```\n\n## 濾鏡系統（可選）\n\n### Euphoria Filters（亢奮濾鏡）\n\n當市場處於亢奮狀態時，更容易觸發 Risk-Off：\n\n```python\neuphoria_filters = [\n    # 信用利差低且開始上升\n    {\"type\": \"credit_spread_reversal\", \"series_id\": \"BAA10Y\", \"z_below\": -1.0, \"turn_up\": True},\n    # VIX 低且開始上升\n    {\"type\": \"vix_turn_up\", \"ticker\": \"VIXCLS\", \"level_below\": 15, \"turn_up\": True}\n]\n```\n\n**邏輯**：「大家都很樂觀，但領先指標已轉弱」→ 危險訊號\n\n### Recovery Doubt Filters（復甦懷疑濾鏡）\n\n當市場仍懷疑復甦時，更容易觸發 Risk-On：\n\n```python\nrecovery_doubt_filters = [\n    # 領先指標動量為正\n    {\"type\": \"leading_momentum\", \"above\": 0}\n]\n```\n\n**邏輯**：「大家還在懷疑，但領先指標已回升」→ 進場機會\n\n## 回測假設\n\n### 執行時點 (Rebalance On)\n\n| 選項 | 說明 | 保守程度 |\n|------|------|----------|\n| signal_close | 訊號當日收盤執行 | 最不保守 |\n| next_open | 訊號次日開盤執行 | 中等 |\n| next_month_open | 訊號次月開盤執行 | 最保守（建議） |\n\n### 交易成本\n\n```python\ntransaction_cost_bps = 5   # 單邊 5 bps\nslippage_bps = 0           # 滑價（可調整）\n```\n\n### 績效指標\n\n| 指標 | 計算方式 |\n|------|----------|\n| CAGR | (終值/初值)^(1/年數) - 1 |\n| Max Drawdown | max(1 - 價值/歷史高點) |\n| Sharpe | (年化報酬 - 無風險利率) / 年化波動 |\n| Turnovers | 切換次數 |\n\n## 模型限制\n\n1. **近似性**：本模型使用公開數據近似 Zeberg 原版，可能有差異\n2. **發布延遲**：宏觀數據有 1-2 個月延遲，實際訊號會滯後\n3. **樣本內偏差**：參數調整可能導致過度擬合\n4. **尾部風險**：模型無法預測黑天鵝事件\n5. **交易執行**：回測假設可能過於理想化\n",
        "skills/zeberg-salomon-rotator/templates/output-json.md": "# JSON 輸出模板 (Output JSON Template)\n\n## 完整輸出結構\n\n```json\n{\n  \"skill\": \"zeberg-salomon-rotator\",\n  \"version\": \"0.1.1\",\n  \"as_of\": \"2026-01-15\",\n  \"params_used\": {\n    \"start_date\": \"2000-01-01\",\n    \"end_date\": \"2026-01-15\",\n    \"freq\": \"M\",\n    \"equity_proxy\": \"SPY\",\n    \"bond_proxy\": \"TLT\",\n    \"iceberg_threshold\": -0.3,\n    \"sinking_threshold\": -0.5,\n    \"confirm_periods\": 2,\n    \"hysteresis\": 0.15,\n    \"rebalance_on\": \"next_month_open\",\n    \"transaction_cost_bps\": 5\n  },\n\n  \"current_state\": {\n    \"state\": \"RISK_ON\",\n    \"since\": \"2023-06-30\",\n    \"months_in_state\": 19\n  },\n\n  \"latest_indices\": {\n    \"LeadingIndex\": 0.41,\n    \"CoincidentIndex\": 0.22,\n    \"dL\": 0.05,\n    \"dC\": 0.02,\n    \"iceberg_event\": false,\n    \"sinking_event\": false,\n    \"distance_to_iceberg\": 0.71,\n    \"distance_to_sinking\": 0.72\n  },\n\n  \"latest_action\": null,\n\n  \"switch_events\": [\n    {\n      \"date\": \"2000-03-31\",\n      \"action\": \"EXIT_EQUITY_ENTER_LONG_BOND\",\n      \"from_state\": \"RISK_ON\",\n      \"to_state\": \"RISK_OFF\",\n      \"reason\": {\n        \"LeadingIndex\": -0.52,\n        \"CoincidentIndex\": 0.05,\n        \"iceberg\": true,\n        \"sinking\": false,\n        \"euphoria\": true,\n        \"dL\": -0.08,\n        \"confirm_periods_met\": 2\n      }\n    },\n    {\n      \"date\": \"2003-06-30\",\n      \"action\": \"EXIT_LONG_BOND_ENTER_EQUITY\",\n      \"from_state\": \"RISK_OFF\",\n      \"to_state\": \"RISK_ON\",\n      \"reason\": {\n        \"LeadingIndex\": 0.18,\n        \"CoincidentIndex\": -0.08,\n        \"recovery\": true,\n        \"hysteresis_cleared\": true,\n        \"dL\": 0.12,\n        \"confirm_periods_met\": 2\n      }\n    }\n  ],\n\n  \"backtest_summary\": {\n    \"period\": {\n      \"start\": \"2000-01-01\",\n      \"end\": \"2026-01-15\",\n      \"total_months\": 313\n    },\n    \"performance\": {\n      \"cumulative_return\": 4.25,\n      \"cagr\": 0.123,\n      \"annualized_volatility\": 0.12,\n      \"sharpe_ratio\": 0.85,\n      \"max_drawdown\": -0.27,\n      \"max_drawdown_date\": \"2008-11-30\",\n      \"calmar_ratio\": 0.46\n    },\n    \"turnover\": {\n      \"total_switches\": 10,\n      \"avg_months_per_state\": 31.3,\n      \"periods_in_equity\": 210,\n      \"periods_in_bonds\": 103\n    },\n    \"costs\": {\n      \"total_transaction_costs_bps\": 100,\n      \"total_slippage_bps\": 0,\n      \"net_return_after_costs\": 4.15\n    }\n  },\n\n  \"benchmarks\": {\n    \"equity_buy_hold\": {\n      \"cumulative_return\": 3.85,\n      \"cagr\": 0.108,\n      \"max_drawdown\": -0.55,\n      \"sharpe_ratio\": 0.52\n    },\n    \"bond_buy_hold\": {\n      \"cumulative_return\": 2.10,\n      \"cagr\": 0.058,\n      \"max_drawdown\": -0.35,\n      \"sharpe_ratio\": 0.38\n    },\n    \"60_40_portfolio\": {\n      \"cumulative_return\": 3.20,\n      \"cagr\": 0.092,\n      \"max_drawdown\": -0.38,\n      \"sharpe_ratio\": 0.65\n    }\n  },\n\n  \"relative_performance\": {\n    \"vs_equity\": {\n      \"excess_cagr\": 0.015,\n      \"reduced_drawdown\": 0.28\n    },\n    \"vs_60_40\": {\n      \"excess_cagr\": 0.031,\n      \"reduced_drawdown\": 0.11\n    }\n  },\n\n  \"diagnostics\": {\n    \"leading_components\": [\n      {\n        \"series_id\": \"T10Y3M\",\n        \"latest_value\": 0.85,\n        \"z_score\": 0.32,\n        \"contribution\": 0.08,\n        \"weight\": 0.25\n      },\n      {\n        \"series_id\": \"T10Y2Y\",\n        \"latest_value\": 0.42,\n        \"z_score\": 0.28,\n        \"contribution\": 0.04,\n        \"weight\": 0.15\n      },\n      {\n        \"series_id\": \"PERMIT\",\n        \"latest_value\": 0.05,\n        \"z_score\": 0.45,\n        \"contribution\": 0.09,\n        \"weight\": 0.20\n      },\n      {\n        \"series_id\": \"ACDGNO\",\n        \"latest_value\": 0.03,\n        \"z_score\": 0.38,\n        \"contribution\": 0.08,\n        \"weight\": 0.20\n      },\n      {\n        \"series_id\": \"UMCSENT\",\n        \"latest_value\": 72.5,\n        \"z_score\": 0.62,\n        \"contribution\": 0.12,\n        \"weight\": 0.20\n      }\n    ],\n    \"coincident_components\": [\n      {\n        \"series_id\": \"PAYEMS\",\n        \"latest_value\": 0.018,\n        \"z_score\": 0.28,\n        \"contribution\": 0.08,\n        \"weight\": 0.30\n      },\n      {\n        \"series_id\": \"INDPRO\",\n        \"latest_value\": 0.012,\n        \"z_score\": 0.15,\n        \"contribution\": 0.05,\n        \"weight\": 0.30\n      },\n      {\n        \"series_id\": \"W875RX1\",\n        \"latest_value\": 0.025,\n        \"z_score\": 0.22,\n        \"contribution\": 0.04,\n        \"weight\": 0.20\n      },\n      {\n        \"series_id\": \"CMRMTSPL\",\n        \"latest_value\": 0.015,\n        \"z_score\": 0.25,\n        \"contribution\": 0.05,\n        \"weight\": 0.20\n      }\n    ],\n    \"top_contributors\": [\n      {\"series_id\": \"UMCSENT\", \"contribution\": 0.12, \"direction\": \"positive\"},\n      {\"series_id\": \"PERMIT\", \"contribution\": 0.09, \"direction\": \"positive\"}\n    ],\n    \"top_detractors\": []\n  },\n\n  \"filters_status\": {\n    \"euphoria\": {\n      \"active\": false,\n      \"components\": [\n        {\"type\": \"credit_spread_reversal\", \"triggered\": false, \"value\": 1.85}\n      ]\n    },\n    \"recovery_doubt\": {\n      \"active\": true,\n      \"components\": [\n        {\"type\": \"leading_momentum\", \"triggered\": true, \"value\": 0.05}\n      ]\n    }\n  },\n\n  \"time_series\": {\n    \"available\": true,\n    \"file\": \"time_series.csv\",\n    \"columns\": [\"date\", \"LeadingIndex\", \"CoincidentIndex\", \"state\", \"equity_value\", \"bond_value\", \"portfolio_value\"]\n  },\n\n  \"notes\": [\n    \"Indices are built from public FRED proxies; proprietary Zeberg model is approximated.\",\n    \"TLT data starts from 2002-07; earlier periods use synthetic bond returns.\",\n    \"All returns are based on adjusted close prices (including dividends).\"\n  ],\n\n  \"metadata\": {\n    \"generated_at\": \"2026-01-15T10:30:00Z\",\n    \"execution_time_ms\": 2345,\n    \"data_freshness\": {\n      \"macro_data\": \"2025-11-30\",\n      \"price_data\": \"2026-01-14\"\n    }\n  }\n}\n```\n\n## 欄位說明\n\n### current_state\n\n| 欄位            | 說明                            |\n|-----------------|---------------------------------|\n| state           | 當前狀態（RISK_ON 或 RISK_OFF） |\n| since           | 進入當前狀態的日期              |\n| months_in_state | 在當前狀態的月數                |\n\n### latest_indices\n\n| 欄位                | 說明                         |\n|---------------------|------------------------------|\n| LeadingIndex        | 領先指標合成值               |\n| CoincidentIndex     | 同時指標合成值               |\n| dL                  | 領先指標月變化               |\n| dC                  | 同時指標月變化               |\n| iceberg_event       | 是否觸發冰山事件             |\n| sinking_event       | 是否觸發下沉事件             |\n| distance_to_iceberg | 距離冰山門檻的距離（標準差） |\n| distance_to_sinking | 距離下沉門檻的距離（標準差） |\n\n### switch_events\n\n| 欄位       | 說明         |\n|------------|--------------|\n| date       | 切換日期     |\n| action     | 執行動作     |\n| from_state | 原狀態       |\n| to_state   | 新狀態       |\n| reason     | 觸發原因詳情 |\n\n### backtest_summary.performance\n\n| 欄位                  | 說明                        |\n|-----------------------|-----------------------------|\n| cumulative_return     | 累積報酬倍數                |\n| cagr                  | 年化複合成長率              |\n| annualized_volatility | 年化波動率                  |\n| sharpe_ratio          | Sharpe 比率                 |\n| max_drawdown          | 最大回撤                    |\n| calmar_ratio          | Calmar 比率（CAGR / MaxDD） |\n\n## 精簡輸出（--quick 模式）\n\n```json\n{\n  \"skill\": \"zeberg-salomon-rotator\",\n  \"as_of\": \"2026-01-15\",\n  \"state\": \"RISK_ON\",\n  \"latest_indices\": {\n    \"LeadingIndex\": 0.41,\n    \"CoincidentIndex\": 0.22,\n    \"iceberg_event\": false,\n    \"sinking_event\": false\n  },\n  \"last_switch\": {\n    \"date\": \"2023-06-30\",\n    \"action\": \"EXIT_LONG_BOND_ENTER_EQUITY\"\n  }\n}\n```\n",
        "skills/zeberg-salomon-rotator/templates/output-markdown.md": "# Markdown 報告模板 (Output Markdown Template)\n\n## 報告結構\n\n```markdown\n# Zeberg-Salomon 景氣輪動報告\n\n**報告日期**: {as_of}\n**回測期間**: {start_date} - {end_date}\n**資料新鮮度**: 宏觀 {macro_freshness} / 價格 {price_freshness}\n\n---\n\n## 當前狀態\n\n| 指標 | 數值 |\n|------|------|\n| **狀態** | {state} |\n| **進入狀態日期** | {since} |\n| **已持續** | {months_in_state} 個月 |\n\n### 最新指標\n\n| 指標 | 數值 | 變化 | 距門檻 |\n|------|------|------|--------|\n| LeadingIndex | {L} | {dL} | {dist_iceberg} |\n| CoincidentIndex | {C} | {dC} | {dist_sinking} |\n\n### 事件狀態\n\n- 冰山事件 (Iceberg): {iceberg_emoji} {iceberg_status}\n- 下沉事件 (Sinking): {sinking_emoji} {sinking_status}\n\n---\n\n## 回測績效\n\n### 策略績效\n\n| 指標 | 數值 |\n|------|------|\n| 累積報酬 | {cumulative_return} |\n| CAGR | {cagr} |\n| 年化波動 | {volatility} |\n| Sharpe | {sharpe} |\n| Max Drawdown | {max_dd} |\n| Calmar | {calmar} |\n\n### 與 Benchmark 比較\n\n| 策略 | CAGR | MaxDD | Sharpe |\n|------|------|-------|--------|\n| **Zeberg-Salomon** | {strategy_cagr} | {strategy_dd} | {strategy_sharpe} |\n| Equity Buy & Hold | {equity_cagr} | {equity_dd} | {equity_sharpe} |\n| 60/40 Portfolio | {6040_cagr} | {6040_dd} | {6040_sharpe} |\n| Bond Buy & Hold | {bond_cagr} | {bond_dd} | {bond_sharpe} |\n\n### 相對表現\n\n- vs 股票買入持有：超額 CAGR {excess_vs_equity}，減少回撤 {dd_reduction_equity}\n- vs 60/40 組合：超額 CAGR {excess_vs_6040}，減少回撤 {dd_reduction_6040}\n\n---\n\n## 切換歷史\n\n總切換次數: {total_switches} 次\n平均持有期: {avg_holding_period} 個月\n\n### 最近 5 次切換\n\n| 日期 | 動作 | 原狀態 | 新狀態 | 原因 |\n|------|------|--------|--------|------|\n| {date1} | {action1} | {from1} | {to1} | {reason1} |\n| {date2} | {action2} | {from2} | {to2} | {reason2} |\n| ... | ... | ... | ... | ... |\n\n---\n\n## 指標歸因\n\n### 領先指標成分\n\n| 序列 | 最新值 | Z-Score | 貢獻 | 方向 |\n|------|--------|---------|------|------|\n| T10Y3M | {val} | {z} | {contrib} | {dir} |\n| T10Y2Y | {val} | {z} | {contrib} | {dir} |\n| PERMIT | {val} | {z} | {contrib} | {dir} |\n| ACDGNO | {val} | {z} | {contrib} | {dir} |\n| UMCSENT | {val} | {z} | {contrib} | {dir} |\n\n### 同時指標成分\n\n| 序列 | 最新值 | Z-Score | 貢獻 | 方向 |\n|------|--------|---------|------|------|\n| PAYEMS | {val} | {z} | {contrib} | {dir} |\n| INDPRO | {val} | {z} | {contrib} | {dir} |\n| W875RX1 | {val} | {z} | {contrib} | {dir} |\n| CMRMTSPL | {val} | {z} | {contrib} | {dir} |\n\n### 主要貢獻者\n\n**正向**:\n1. {top1_series}: +{top1_contrib}\n2. {top2_series}: +{top2_contrib}\n\n**負向**:\n1. {bot1_series}: {bot1_contrib}\n2. {bot2_series}: {bot2_contrib}\n\n---\n\n## 濾鏡狀態\n\n### 亢奮濾鏡 (Euphoria)\n\n| 類型 | 觸發 | 數值 |\n|------|------|------|\n| Credit Spread Reversal | {triggered} | {value} |\n| VIX Turn Up | {triggered} | {value} |\n\n### 復甦懷疑濾鏡 (Recovery Doubt)\n\n| 類型 | 觸發 | 數值 |\n|------|------|------|\n| Leading Momentum | {triggered} | {value} |\n\n---\n\n## 回測假設\n\n| 假設 | 設定值 |\n|------|--------|\n| 執行時點 | {rebalance_on} |\n| 單邊交易成本 | {cost_bps} bps |\n| 單邊滑價 | {slippage_bps} bps |\n| 總交易成本 | {total_costs} bps |\n\n---\n\n## 注意事項\n\n1. 本模型使用公開 FRED 數據近似 Zeberg 原版，具體數值可能有差異\n2. TLT 數據從 2002-07 開始，之前使用合成債券報酬\n3. 宏觀數據有 1-2 個月發布延遲，實際訊號會滯後\n4. 報酬使用調整後收盤價計算（含配息再投資）\n\n---\n\n## 參考\n\n- Zeberg Letter: https://swissblock.net/products/reports/zeberg-letter\n- @SystematicPeter: https://x.com/SystematicPeter/status/2011460563096760388\n\n---\n\n*Generated by zeberg-salomon-rotator v{version} at {generated_at}*\n```\n\n## 使用方式\n\n在腳本中使用模板：\n\n```python\nfrom string import Template\n\ndef generate_markdown_report(result):\n    template_path = \"templates/output-markdown.md\"\n    with open(template_path, \"r\", encoding=\"utf-8\") as f:\n        template = Template(f.read())\n\n    # 準備替換變數\n    vars = {\n        \"as_of\": result[\"as_of\"],\n        \"state\": result[\"current_state\"][\"state\"],\n        # ... 其他變數\n    }\n\n    return template.safe_substitute(vars)\n```\n\n## 狀態圖示\n\n| 狀態 | 圖示 |\n|------|------|\n| RISK_ON | `[ON]` 或 綠色標籤 |\n| RISK_OFF | `[OFF]` 或 紅色標籤 |\n| 冰山事件觸發 | `[!]` 警告 |\n| 下沉事件觸發 | `[!!]` 嚴重警告 |\n| 無事件 | `[-]` 正常 |\n",
        "skills/zeberg-salomon-rotator/workflows/analyze.md": "# Workflow: 深度分析\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/methodology.md - Zeberg-Salomon 模型邏輯\n2. references/data-sources.md - 各指標的經濟意義\n3. references/input-schema.md - 參數配置\n</required_reading>\n\n<process>\n\n## Step 1: 抓取完整數據\n\n```bash\npython scripts/fetch_data.py \\\n  --leading T10Y3M,T10Y2Y,PERMIT,ACDGNO,UMCSENT \\\n  --coincident PAYEMS,INDPRO,W875RX1,CMRMTSPL \\\n  --risk BAA10Y,VIXCLS \\\n  --prices SPY,TLT \\\n  --start 2015-01-01 \\\n  --output analysis_data.json\n```\n\n## Step 2: 建構並分解指標\n\n計算各成分對合成指標的貢獻：\n\n```python\nfrom scripts.rotator import build_index_with_attribution\n\nL, L_contrib = build_index_with_attribution(\n    leading_config,\n    data[\"macro\"],\n    z_win=120,\n    smooth_win=3\n)\n\nC, C_contrib = build_index_with_attribution(\n    coincident_config,\n    data[\"macro\"],\n    z_win=120,\n    smooth_win=3\n)\n\n# L_contrib 結構：\n# {\n#   \"T10Y3M\": {\"value\": -0.12, \"weight\": 0.25, \"contribution\": -0.03},\n#   \"T10Y2Y\": {\"value\": -0.08, \"weight\": 0.15, \"contribution\": -0.012},\n#   ...\n# }\n```\n\n## Step 3: 趨勢分析\n\n分析指標的趨勢方向與動量：\n\n```python\nfrom scripts.rotator import analyze_trend\n\ntrend_analysis = {\n    \"LeadingIndex\": analyze_trend(L, windows=[3, 6, 12]),\n    \"CoincidentIndex\": analyze_trend(C, windows=[3, 6, 12])\n}\n\n# analyze_trend 輸出：\n# {\n#   \"current_value\": 0.41,\n#   \"3m_change\": 0.15,\n#   \"6m_change\": 0.28,\n#   \"12m_change\": 0.45,\n#   \"slope_3m\": 0.05,\n#   \"slope_6m\": 0.047,\n#   \"direction\": \"rising\",\n#   \"momentum\": \"accelerating\"\n# }\n```\n\n## Step 4: 歷史分位數定位\n\n將當前值放在歷史分布中定位：\n\n```python\nfrom scripts.rotator import percentile_rank\n\npercentile = {\n    \"LeadingIndex\": percentile_rank(L.iloc[-1], L),\n    \"CoincidentIndex\": percentile_rank(C.iloc[-1], C)\n}\n\n# 例如：LeadingIndex 在歷史 65% 分位 → 高於 65% 的歷史觀測值\n```\n\n## Step 5: 濾鏡分析（可選）\n\n若配置了 euphoria_filters 或 recovery_doubt_filters：\n\n```python\nfrom scripts.rotator import evaluate_filters\n\n# 亢奮濾鏡（Risk-On 過熱信號）\neuphoria = evaluate_filters(\n    filters=[\n        {\"type\": \"credit_spread_reversal\", \"series_id\": \"BAA10Y\", \"z_below\": -1.0, \"turn_up\": True},\n        {\"type\": \"vix_turn_up\", \"ticker\": \"VIXCLS\", \"level_below\": 15, \"turn_up\": True}\n    ],\n    data=data\n)\n\n# 復甦懷疑濾鏡\ndoubt = evaluate_filters(\n    filters=[\n        {\"type\": \"leading_momentum\", \"above\": 0}\n    ],\n    data=data\n)\n```\n\n## Step 6: 情境分析\n\n基於當前狀態，分析各種情境：\n\n```python\nscenarios = {\n    \"current_path\": {\n        \"description\": \"若指標維持當前趨勢\",\n        \"expected_state_in_3m\": predict_state(L, C, months=3),\n        \"probability\": \"baseline\"\n    },\n    \"acceleration\": {\n        \"description\": \"若指標加速惡化（如衰退）\",\n        \"trigger\": \"ΔL < -0.1 連續 2 期\",\n        \"expected_action\": \"EXIT_EQUITY_ENTER_LONG_BOND\"\n    },\n    \"reversal\": {\n        \"description\": \"若指標反轉（如政策刺激）\",\n        \"trigger\": \"L 回升超過 hysteresis\",\n        \"expected_action\": \"EXIT_LONG_BOND_ENTER_EQUITY\"\n    }\n}\n```\n\n## Step 7: 生成分析報告\n\n```json\n{\n  \"analysis_date\": \"2026-01-15\",\n  \"current_state\": \"RISK_ON\",\n  \"indices\": {\n    \"LeadingIndex\": {\n      \"value\": 0.41,\n      \"percentile\": 65,\n      \"trend\": \"rising\",\n      \"momentum\": \"stable\"\n    },\n    \"CoincidentIndex\": {\n      \"value\": 0.22,\n      \"percentile\": 55,\n      \"trend\": \"flat\",\n      \"momentum\": \"decelerating\"\n    }\n  },\n  \"attribution\": {\n    \"leading_top_contributors\": [\n      {\"series\": \"T10Y3M\", \"contribution\": 0.12, \"direction\": \"positive\"},\n      {\"series\": \"PERMIT\", \"contribution\": 0.08, \"direction\": \"positive\"}\n    ],\n    \"leading_top_detractors\": [\n      {\"series\": \"UMCSENT\", \"contribution\": -0.05, \"direction\": \"negative\"}\n    ],\n    \"coincident_top_contributors\": [...],\n    \"coincident_top_detractors\": [...]\n  },\n  \"events\": {\n    \"iceberg\": false,\n    \"sinking\": false,\n    \"distance_to_iceberg\": 0.71,\n    \"distance_to_sinking\": 0.72\n  },\n  \"filters\": {\n    \"euphoria\": {\"active\": false, \"details\": {...}},\n    \"doubt\": {\"active\": true, \"details\": {...}}\n  },\n  \"scenarios\": [...],\n  \"interpretation\": [\n    \"領先指標目前在歷史 65% 分位，處於擴張區間\",\n    \"殖利率曲線（T10Y3M）貢獻最大正向動能\",\n    \"消費者信心（UMCSENT）近期走弱，需關注\",\n    \"距離「冰山事件」門檻還有 0.71 個標準差\"\n  ],\n  \"caveats\": [\n    \"FRED 數據有 1-2 個月延遲\",\n    \"本模型為 Zeberg 方法論的公開數據近似版\"\n  ]\n}\n```\n\n</process>\n\n<success_criteria>\n深度分析完成時應產出：\n\n- [ ] 當前指標值與歷史分位數定位\n- [ ] 趨勢分析（方向、動量、斜率）\n- [ ] 各成分指標的貢獻歸因\n- [ ] 距離事件門檻的距離\n- [ ] 濾鏡狀態（若有配置）\n- [ ] 情境分析\n- [ ] 可操作的解讀與注意事項\n</success_criteria>\n",
        "skills/zeberg-salomon-rotator/workflows/backtest.md": "# Workflow: 完整回測\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/input-schema.md - 完整參數定義\n2. references/methodology.md - 方法論與切換邏輯\n3. references/data-sources.md - 數據來源與系列代碼\n</required_reading>\n\n<process>\n\n## Step 1: 確認參數\n\n檢查用戶提供的參數，補充預設值：\n\n```python\nparams = {\n    \"start_date\": \"2000-01-01\",      # 回測起始\n    \"end_date\": \"today\",              # 回測結束\n    \"freq\": \"M\",                      # 月頻\n    \"equity_proxy\": \"SPY\",            # 風險資產\n    \"bond_proxy\": \"TLT\",              # 長債資產\n    \"iceberg_threshold\": -0.3,        # 冰山門檻\n    \"sinking_threshold\": -0.5,        # 下沉門檻\n    \"confirm_periods\": 2,             # 確認期數\n    \"hysteresis\": 0.15,               # 進出場間距\n    \"rebalance_on\": \"next_month_open\",\n    \"transaction_cost_bps\": 5,\n    \"slippage_bps\": 0\n}\n```\n\n若用戶有指定參數，覆蓋上述預設值。\n\n## Step 2: 抓取數據\n\n執行 `scripts/fetch_data.py` 抓取所需數據：\n\n```bash\npython scripts/fetch_data.py \\\n  --leading T10Y3M,T10Y2Y,PERMIT,ACDGNO,UMCSENT \\\n  --coincident PAYEMS,INDPRO,W875RX1,CMRMTSPL \\\n  --prices SPY,TLT \\\n  --start {start_date} \\\n  --end {end_date} \\\n  --output data.json\n```\n\n或使用 Python API：\n\n```python\nfrom scripts.fetch_data import fetch_all_data\n\ndata = fetch_all_data(\n    leading_series=[\"T10Y3M\", \"T10Y2Y\", \"PERMIT\", \"ACDGNO\", \"UMCSENT\"],\n    coincident_series=[\"PAYEMS\", \"INDPRO\", \"W875RX1\", \"CMRMTSPL\"],\n    price_tickers=[\"SPY\", \"TLT\"],\n    start_date=params[\"start_date\"],\n    end_date=params[\"end_date\"]\n)\n```\n\n## Step 3: 建構指標\n\n計算 LeadingIndex 和 CoincidentIndex：\n\n```python\nfrom scripts.rotator import build_index\n\nleading_config = [\n    {\"id\": \"T10Y3M\", \"transform\": \"level\", \"direction\": 1, \"weight\": 0.25},\n    {\"id\": \"T10Y2Y\", \"transform\": \"level\", \"direction\": 1, \"weight\": 0.15},\n    {\"id\": \"PERMIT\", \"transform\": \"yoy\", \"direction\": 1, \"weight\": 0.20},\n    {\"id\": \"ACDGNO\", \"transform\": \"yoy\", \"direction\": 1, \"weight\": 0.20},\n    {\"id\": \"UMCSENT\", \"transform\": \"level\", \"direction\": 1, \"weight\": 0.20}\n]\n\ncoincident_config = [\n    {\"id\": \"PAYEMS\", \"transform\": \"yoy\", \"direction\": 1, \"weight\": 0.30},\n    {\"id\": \"INDPRO\", \"transform\": \"yoy\", \"direction\": 1, \"weight\": 0.30},\n    {\"id\": \"W875RX1\", \"transform\": \"yoy\", \"direction\": 1, \"weight\": 0.20},\n    {\"id\": \"CMRMTSPL\", \"transform\": \"yoy\", \"direction\": 1, \"weight\": 0.20}\n]\n\nL = build_index(leading_config, data[\"macro\"], z_win=120, smooth_win=3)\nC = build_index(coincident_config, data[\"macro\"], z_win=120, smooth_win=3)\n```\n\n## Step 4: 執行切換邏輯\n\n使用 `protocol_signals` 產生切換訊號：\n\n```python\nfrom scripts.rotator import protocol_signals\n\nresult = protocol_signals(\n    params=params,\n    price_eq=data[\"prices\"][\"SPY\"],\n    price_bd=data[\"prices\"][\"TLT\"],\n    leading_index=L,\n    coincident_index=C\n)\n```\n\n## Step 5: 回測績效\n\n計算累積報酬與績效指標：\n\n```python\n# result 包含：\n# - signals: 切換事件清單\n# - backtest: 回測績效\n#   - cumulative_return\n#   - cagr\n#   - max_drawdown\n#   - sharpe_ratio\n#   - turnovers\n#   - periods_in_equity\n#   - periods_in_bonds\n```\n\n## Step 6: 比較 Benchmark\n\n與買入持有、60/40 組合比較：\n\n```python\nbenchmarks = {\n    \"equity_buy_hold\": calculate_buy_hold(data[\"prices\"][\"SPY\"]),\n    \"bond_buy_hold\": calculate_buy_hold(data[\"prices\"][\"TLT\"]),\n    \"60_40\": calculate_60_40(data[\"prices\"][\"SPY\"], data[\"prices\"][\"TLT\"])\n}\n```\n\n## Step 7: 輸出結果\n\n依據 `output_format` 參數產出結果：\n\n- JSON 格式：參考 `templates/output-json.md`\n- Markdown 格式：參考 `templates/output-markdown.md`\n\n```bash\npython scripts/rotator.py \\\n  --start {start_date} \\\n  --end {end_date} \\\n  --output result.json\n```\n\n</process>\n\n<success_criteria>\n回測完成時應產出：\n\n- [ ] LeadingIndex 與 CoincidentIndex 時間序列\n- [ ] 所有切換事件清單（含日期、動作、原因）\n- [ ] 回測期間的累積報酬曲線\n- [ ] CAGR、MaxDD、Sharpe、換手次數\n- [ ] 與 benchmark 比較\n- [ ] 診斷資訊（各指標貢獻）\n- [ ] 結果輸出為指定格式\n</success_criteria>\n",
        "skills/zeberg-salomon-rotator/workflows/monitor.md": "# Workflow: 監控模式\n\n<required_reading>\n**執行前請先閱讀：**\n1. references/methodology.md - 了解冰山/下沉事件定義\n2. references/data-sources.md - 數據來源與更新頻率\n</required_reading>\n\n<process>\n\n## Step 1: 確認監控配置\n\n```python\nmonitor_config = {\n    \"check_interval\": \"daily\",        # 檢查頻率\n    \"alert_on_iceberg\": True,         # 冰山事件警報\n    \"alert_on_sinking\": True,         # 下沉事件警報\n    \"alert_on_switch\": True,          # 切換事件警報\n    \"alert_threshold_change\": 0.1,    # 指標變化警報門檻\n    \"lookback_periods\": 3             # 回看期數\n}\n```\n\n## Step 2: 抓取最新數據\n\n```bash\npython scripts/fetch_data.py \\\n  --leading T10Y3M,T10Y2Y,PERMIT,ACDGNO,UMCSENT \\\n  --coincident PAYEMS,INDPRO,W875RX1,CMRMTSPL \\\n  --prices SPY,TLT \\\n  --start 2020-01-01 \\\n  --latest\n```\n\n**注意**：宏觀數據有 1-2 個月發布延遲，最新數據點可能是上月或前月。\n\n## Step 3: 計算當前狀態\n\n```python\nfrom scripts.rotator import get_current_state\n\nstate = get_current_state(\n    leading_series=leading_config,\n    coincident_series=coincident_config,\n    iceberg_threshold=-0.3,\n    sinking_threshold=-0.5\n)\n\n# state 包含：\n# - current_state: \"RISK_ON\" 或 \"RISK_OFF\"\n# - LeadingIndex: 最新值\n# - CoincidentIndex: 最新值\n# - iceberg_event: bool\n# - sinking_event: bool\n# - dL: 領先指標變化\n# - dC: 同時指標變化\n# - confirm_count: 當前確認計數\n```\n\n## Step 4: 檢查警報條件\n\n```python\nalerts = []\n\n# 冰山事件警報\nif state[\"iceberg_event\"] and not previous_state.get(\"iceberg_event\"):\n    alerts.append({\n        \"type\": \"ICEBERG_DETECTED\",\n        \"message\": f\"領先指標跌破門檻: LeadingIndex = {state['LeadingIndex']:.2f}\",\n        \"severity\": \"WARNING\"\n    })\n\n# 下沉事件警報\nif state[\"sinking_event\"] and not previous_state.get(\"sinking_event\"):\n    alerts.append({\n        \"type\": \"SINKING_DETECTED\",\n        \"message\": f\"同時指標跌破門檻: CoincidentIndex = {state['CoincidentIndex']:.2f}\",\n        \"severity\": \"CRITICAL\"\n    })\n\n# 狀態切換警報\nif state[\"current_state\"] != previous_state.get(\"current_state\"):\n    alerts.append({\n        \"type\": \"STATE_SWITCH\",\n        \"message\": f\"狀態切換: {previous_state.get('current_state')} → {state['current_state']}\",\n        \"severity\": \"ACTION_REQUIRED\"\n    })\n\n# 指標大幅變化警報\nif abs(state[\"dL\"]) > monitor_config[\"alert_threshold_change\"]:\n    alerts.append({\n        \"type\": \"LEADING_INDEX_MOVE\",\n        \"message\": f\"領先指標大幅變化: ΔL = {state['dL']:.2f}\",\n        \"severity\": \"INFO\"\n    })\n```\n\n## Step 5: 輸出監控報告\n\n```json\n{\n  \"timestamp\": \"2026-01-15T10:00:00Z\",\n  \"current_state\": \"RISK_ON\",\n  \"indices\": {\n    \"LeadingIndex\": 0.41,\n    \"CoincidentIndex\": 0.22,\n    \"dL\": 0.05,\n    \"dC\": 0.02\n  },\n  \"events\": {\n    \"iceberg\": false,\n    \"sinking\": false\n  },\n  \"confirm_status\": {\n    \"iceberg_confirm_count\": 0,\n    \"recovery_confirm_count\": 0\n  },\n  \"alerts\": [],\n  \"next_check\": \"2026-01-16T10:00:00Z\"\n}\n```\n\n## Step 6: 儲存狀態\n\n將當前狀態儲存供下次比較：\n\n```python\nsave_state(state, \"monitor_state.json\")\n```\n\n</process>\n\n<alert_severity_levels>\n| 級別 | 說明 | 建議行動 |\n|------|------|----------|\n| INFO | 資訊通知 | 記錄，無需行動 |\n| WARNING | 預警 | 關注，準備行動 |\n| CRITICAL | 嚴重 | 高度關注，考慮行動 |\n| ACTION_REQUIRED | 需行動 | 立即執行切換操作 |\n</alert_severity_levels>\n\n<success_criteria>\n監控完成時應產出：\n\n- [ ] 當前狀態（RISK_ON/RISK_OFF）\n- [ ] 最新指標值與變化\n- [ ] 冰山/下沉事件狀態\n- [ ] 確認計數\n- [ ] 警報清單（若有）\n- [ ] 下次檢查時間\n</success_criteria>\n",
        "skills/zeberg-salomon-rotator/workflows/visualize.md": "# Workflow: 視覺化回測結果\n\n<required_reading>\n**執行前請先閱讀：**\n1. workflows/backtest.md - 完整回測工作流程\n</required_reading>\n\n<process>\n\n## Step 1: 執行回測\n\n先執行完整回測以獲取數據：\n\n```bash\npython scripts/rotator.py --start 2000-01-01 --end 2026-01-01 --output result.json\n```\n\n## Step 2: 生成視覺化圖表\n\n使用 `scripts/visualize.py` 生成多面板圖表：\n\n```bash\n# 從 JSON 檔案讀取\npython scripts/visualize.py -i result.json -o output/zeberg-salomon-YYYY-MM-DD.png\n\n# 或透過 pipe 直接生成\npython scripts/rotator.py --start 2000-01-01 --end 2026-01-01 2>/dev/null | \\\n  python scripts/visualize.py -o output/zeberg-salomon-$(date +%Y-%m-%d).png\n```\n\n## Step 3: 圖表說明\n\n生成的圖表包含四個面板：\n\n### Panel 1: 景氣指標面板 (上)\n- **Leading Index** (藍色): 領先指標，預測經濟轉折\n- **Coincident Index** (紫色): 同時指標，確認經濟狀態\n- **Iceberg Threshold** (橙色虛線): 冰山門檻 (-0.3)\n- **Sinking Threshold** (紅色虛線): 下沉門檻 (-0.5)\n- **背景色**: 綠色=RISK_ON, 紅色=RISK_OFF\n- **圓點標記**: 切換事件位置\n\n### Panel 2: 累積報酬面板 (中)\n- **黑色粗線**: 策略累積報酬\n- **藍色虛線**: SPY 買入持有基準\n- **紫色虛線**: TLT 買入持有基準\n- **三角形標記**: ▼=進入 RISK_OFF, ▲=進入 RISK_ON\n\n### Panel 3: 狀態條帶 (下)\n- **綠色區段**: RISK_ON (持有股票)\n- **紅色區段**: RISK_OFF (持有長債)\n\n### Panel 4: 績效摘要\n- CAGR、總切換次數、當前狀態、最新指標值\n\n## 參數選項\n\n| 參數 | 說明 | 預設值 |\n|------|------|--------|\n| `-i, --input` | 輸入 JSON 檔案路徑 | stdin |\n| `-o, --output` | 輸出圖片路徑 | `output/zeberg-salomon-YYYY-MM-DD.png` |\n| `--show` | 互動式顯示圖表 | False |\n\n</process>\n\n<success_criteria>\n視覺化完成時應產出：\n\n- [ ] 多面板 PNG 圖表\n- [ ] 檔名包含當天日期\n- [ ] 圖表儲存於 `output/` 目錄\n</success_criteria>\n"
      },
      "plugins": [
        {
          "name": "zeberg-salomon-rotator",
          "description": "用領先和即時指標建構景氣模型，並判讀兩種景氣階段：景氣擴張與景氣收縮期，並根據理論給出\"撞冰山\"與\"下沉\"事件訊號",
          "version": "0.1.2",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/zeberg-salomon-rotator",
          "category": "business-cycles",
          "tags": [
            "景氣循環",
            "領先指標",
            "同時指標",
            "景氣擴張",
            "景氣收縮",
            "FRED"
          ],
          "categories": [
            "business-cycles",
            "fred",
            "同時指標",
            "景氣循環",
            "景氣擴張",
            "景氣收縮",
            "領先指標"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install zeberg-salomon-rotator@macro-skills"
          ]
        },
        {
          "name": "usd-reserve-loss-gold-revaluation",
          "description": "在「美元／某貨幣失去儲備地位、黃金成為唯一錨」的假設下，用央行貨幣負債 ÷ 黃金儲備，推演「資產負債表可承受的隱含金價」，並輸出各國/各貨幣的槓桿程度、缺口與排名",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/usd-reserve-loss-gold-revaluation",
          "category": "fx-factors",
          "tags": [
            "黃金",
            "央行",
            "儲備貨幣",
            "美元",
            "M0",
            "M2"
          ],
          "categories": [
            "fx-factors",
            "m0",
            "m2",
            "儲備貨幣",
            "央行",
            "美元",
            "黃金"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install usd-reserve-loss-gold-revaluation@macro-skills"
          ]
        },
        {
          "name": "compute-precious-miner-gross-margin",
          "description": "以公開金屬價格 + 礦業成本指標（AISC/All-in cost/現金成本）計算「黃金/白銀礦業毛利率代理值」，並判斷當前是否處於歷史高/低檔區間。",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/compute-precious-miner-gross-margin",
          "category": "commodity-sd",
          "tags": [
            "貴金屬",
            "黃金",
            "白銀",
            "礦業",
            "AISC",
            "毛利率"
          ],
          "categories": [
            "aisc",
            "commodity-sd",
            "毛利率",
            "白銀",
            "礦業",
            "貴金屬",
            "黃金"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install compute-precious-miner-gross-margin@macro-skills"
          ]
        },
        {
          "name": "us-cpi-pce-comparator",
          "description": "自動比較 CPI（固定權重）與 PCE（動態權重）的通膨訊號，識別低波動高權重桶位的 PCE 上行風險。用於分析 Fed 關注的 PCE 是否正在 re-accelerate，即使 CPI 看似降溫。",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/us-cpi-pce-comparator",
          "category": "inflation-analytics",
          "tags": [
            "CPI",
            "PCE",
            "通膨",
            "Fed",
            "權重差異",
            "FRED"
          ],
          "categories": [
            "cpi",
            "fed",
            "fred",
            "inflation-analytics",
            "pce",
            "權重差異",
            "通膨"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install us-cpi-pce-comparator@macro-skills"
          ]
        },
        {
          "name": "track-equity-cumulative-return",
          "description": "追蹤股票/指數的累積報酬率，支援多標的比較、指數成分股 Top N 排名，並與 S&P 500 作為基準進行比較，並輸出視覺化圖表。",
          "version": "0.1.1",
          "author": {
            "name": "macro-skills"
          },
          "source": "./skills/track-equity-cumulative-return",
          "category": "indicator-monitoring",
          "tags": [
            "股票",
            "美股",
            "YTD",
            "累積報酬",
            "股票指數",
            "基準比較"
          ],
          "categories": [
            "indicator-monitoring",
            "ytd",
            "基準比較",
            "累積報酬",
            "美股",
            "股票",
            "股票指數"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install track-equity-cumulative-return@macro-skills"
          ]
        },
        {
          "name": "wasde-ingestor",
          "description": "抓取並解析 USDA（美國農業部）每月發布的 WASDE（世界農產品供需估計）報告，擷取所有主要商品（穀物、油籽、棉花、畜產品、糖）的供需平衡表。產出經標準化、具版本控管的資料集，作為即時預測的基準錨點。",
          "version": "0.2.0",
          "author": {
            "name": "macro-skills"
          },
          "source": "./skills/wasde-ingestor",
          "category": "nowcasting",
          "tags": [],
          "categories": [
            "nowcasting"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install wasde-ingestor@macro-skills"
          ]
        },
        {
          "name": "track-agri-hedge-fund-positioning",
          "description": "用 COT 非商業部位變化，量化對沖基金在農產品期貨的資金流向，並把出口需求、USDA 數據、美元/原油/金屬等宏觀風向整合成可交易的敘事與訊號。",
          "version": "0.1.1",
          "author": {
            "name": "macro-skills"
          },
          "source": "./skills/track-agri-hedge-fund-positioning",
          "category": "commodity-sd",
          "tags": [
            "COT",
            "農產品",
            "穀物",
            "油籽",
            "肉類",
            "軟性商品"
          ],
          "categories": [
            "commodity-sd",
            "cot",
            "油籽",
            "穀物",
            "肉類",
            "軟性商品",
            "農產品"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install track-agri-hedge-fund-positioning@macro-skills"
          ]
        },
        {
          "name": "nickel-concentration-risk-analyzer",
          "description": "以全球鎳供給結構為核心，量化各國的主導程度（例如印尼）、主要礦區供給量、以及政策配額/減產情境對全球供需平衡與價格非對稱的影響。",
          "version": "0.1.1",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/nickel-concentration-risk-analyzer",
          "category": "event-scenario",
          "tags": [
            "鎳",
            "供給集中度",
            "原物料",
            "採礦",
            "地緣政治",
            "情境分析"
          ],
          "categories": [
            "event-scenario",
            "供給集中度",
            "原物料",
            "地緣政治",
            "情境分析",
            "採礦",
            "鎳"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install nickel-concentration-risk-analyzer@macro-skills"
          ]
        },
        {
          "name": "lithium-supply-demand-gap-radar",
          "description": "將鋰產業鏈（礦端 → 精煉化學品 → 電池與終端需求），整合為一套可運算的替代指標；再把這些指標映射到鋰主題 ETF（如 LIT）的成分暴露與長期價格走勢，形成可供決策的依據。 ",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/lithium-supply-demand-gap-radar",
          "category": "commodity-sd",
          "tags": [
            "鋰",
            "供需分析",
            "ETF",
            "LIT",
            "原物料",
            "電池"
          ],
          "categories": [
            "commodity-sd",
            "etf",
            "lit",
            "供需分析",
            "原物料",
            "鋰",
            "電池"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install lithium-supply-demand-gap-radar@macro-skills"
          ]
        },
        {
          "name": "google-trends-ath-detector",
          "description": "模擬真人操作瀏覽器抓取 Google Trends 數據，自動判定搜尋趨勢是否創下歷史新高（ATH）或出現異常飆升，並提供訊號分類。",
          "version": "0.1.1",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/google-trends-ath-detector",
          "category": "indicator-monitoring",
          "tags": [
            "Google Trends",
            "ATH",
            "歷史新高",
            "情緒指標",
            "異常偵測",
            "搜尋趨勢"
          ],
          "categories": [
            "ath",
            "google-trends",
            "indicator-monitoring",
            "情緒指標",
            "搜尋趨勢",
            "歷史新高",
            "異常偵測"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install google-trends-ath-detector@macro-skills"
          ]
        },
        {
          "name": "list-china-today-macro-news",
          "description": "彙整今日中國宏觀經濟新聞消息，從華爾街日報、36氪等來源抓取並篩選宏觀相關新聞，輸出雜誌風格的新聞摘要。適用於交易/研究開盤前快速掌握中國宏觀動態。",
          "version": "0.3.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/list-china-today-macro-news",
          "category": "nowcasting",
          "tags": [
            "中國",
            "宏觀經濟",
            "新聞",
            "華爾街日報",
            "央行",
            "利率"
          ],
          "categories": [
            "nowcasting",
            "中國",
            "利率",
            "央行",
            "宏觀經濟",
            "新聞",
            "華爾街日報"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install list-china-today-macro-news@macro-skills"
          ]
        },
        {
          "name": "forecast-sector-relative-return-from-yield-spread",
          "description": "用美債殖利率曲線利差（如 2Y-10Y）建立領先關係，推估未來一段時間內成長股（Nasdaq 100）相對防禦股（Healthcare/XLV）的相對績效方向與幅度。",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/forecast-sector-relative-return-from-yield-spread",
          "category": "interest-rates",
          "tags": [
            "殖利率",
            "利差",
            "領先指標",
            "相對報酬",
            "QQQ",
            "XLV"
          ],
          "categories": [
            "interest-rates",
            "qqq",
            "xlv",
            "利差",
            "殖利率",
            "相對報酬",
            "領先指標"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install forecast-sector-relative-return-from-yield-spread@macro-skills"
          ]
        },
        {
          "name": "monitor-etf-holdings-drawdown-risk",
          "description": "偵測「商品價格上漲、但對應實物 ETF/信託持倉卻下滑」的背離現象，並用多指標交叉驗證，評估是否存在實物供給緊張/交割壓力風險",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/monitor-etf-holdings-drawdown-risk",
          "category": "indicator-monitoring",
          "tags": [
            "ETF",
            "持倉監控",
            "背離分析",
            "實物短缺",
            "白銀",
            "黃金"
          ],
          "categories": [
            "etf",
            "indicator-monitoring",
            "實物短缺",
            "持倉監控",
            "白銀",
            "背離分析",
            "黃金"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install monitor-etf-holdings-drawdown-risk@macro-skills"
          ]
        },
        {
          "name": "evaluate-exponential-trend-deviation-regimes",
          "description": "計算資產價格相對長期指數成長趨勢線的偏離度，衡量當前是否處於歷史極端區間，並可選擇性地進行宏觀因子分析以判斷行情體質。",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/evaluate-exponential-trend-deviation-regimes",
          "category": "business-cycles",
          "tags": [
            "趨勢",
            "偏離度",
            "歷史峰值",
            "指數成長",
            "技術分析",
            "宏觀分析"
          ],
          "categories": [
            "business-cycles",
            "偏離度",
            "宏觀分析",
            "技術分析",
            "指數成長",
            "歷史峰值",
            "趨勢"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install evaluate-exponential-trend-deviation-regimes@macro-skills"
          ]
        },
        {
          "name": "detect-us-equity-valuation-percentile-extreme",
          "description": "把多個股票估值指標統一轉成在過去百年歷史中的分位數，再合成一個總分，判斷目前是否處於歷史極端高估區間，並用歷史類比（如 1929、1965、1999）給出風險解讀",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/detect-us-equity-valuation-percentile-extreme",
          "category": "indicator-monitoring",
          "tags": [
            "估值",
            "分位數",
            "CAPE",
            "本益比",
            "巴菲特指標",
            "GDP"
          ],
          "categories": [
            "cape",
            "gdp",
            "indicator-monitoring",
            "估值",
            "分位數",
            "巴菲特指標",
            "本益比"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install detect-us-equity-valuation-percentile-extreme@macro-skills"
          ]
        },
        {
          "name": "detect-shanghai-silver-stock-drain",
          "description": "以公開交易所庫存資料為核心，量化上海白銀庫存耗盡的方向、速度與加速度，並將其轉成可交易的供給緊縮訊號",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/detect-shanghai-silver-stock-drain",
          "category": "commodity-sd",
          "tags": [
            "白銀",
            "庫存監控",
            "上海黃金交易所",
            "上海期交所",
            "供給緊縮",
            "耗盡訊號"
          ],
          "categories": [
            "commodity-sd",
            "上海期交所",
            "上海黃金交易所",
            "供給緊縮",
            "庫存監控",
            "白銀",
            "耗盡訊號"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install detect-shanghai-silver-stock-drain@macro-skills"
          ]
        },
        {
          "name": "detect-palladium-lead-silver-turns",
          "description": "以鈀金的先行轉向作為確認條件，檢驗白銀短期漲跌是否獲得工業景氣與風險情緒的同步支持，並標記缺乏鈀金參與度的失敗走勢。",
          "version": "0.1.1",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/detect-palladium-lead-silver-turns",
          "category": "indicator-monitoring",
          "tags": [
            "鈀金",
            "白銀",
            "貴金屬",
            "拐點偵測",
            "領先指標",
            "跨金屬確認"
          ],
          "categories": [
            "indicator-monitoring",
            "拐點偵測",
            "白銀",
            "貴金屬",
            "跨金屬確認",
            "鈀金",
            "領先指標"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install detect-palladium-lead-silver-turns@macro-skills"
          ]
        },
        {
          "name": "detect-freight-led-inflation-turn",
          "description": "透過美國卡斯貨運指數 (CASS Freight Index) 的週期轉折，偵測美國通膨壓力是否進入放緩或反轉階段。用於判斷「通膨是否正在降溫」，並驗證市場對降息、通膨回落的宏觀敘事是否有實體經濟數據支撐。",
          "version": "0.1.1",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/detect-freight-led-inflation-turn",
          "category": "inflation-analytics",
          "tags": [
            "卡斯貨運指數",
            "貨運",
            "企業運費",
            "通貨膨脹",
            "領先指標",
            "CPI"
          ],
          "categories": [
            "cpi",
            "inflation-analytics",
            "企業運費",
            "卡斯貨運指數",
            "貨運",
            "通貨膨脹",
            "領先指標"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install detect-freight-led-inflation-turn@macro-skills"
          ]
        },
        {
          "name": "detect-fed-unamortized-discount-pattern",
          "description": "檢查聯準會持有證券的未攤銷折價（Unamortized Discounts）是否出現與特定歷史危機期間相似的走勢模板，並用多指標交叉驗證是否真的屬於「金融壓力升高」而非單純會計/利率效果",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/detect-fed-unamortized-discount-pattern",
          "category": "liquidity-fci",
          "tags": [
            "聯準會",
            "未攤銷折價",
            "WUDSHO",
            "流動性風險",
            "金融壓力",
            "交叉驗證"
          ],
          "categories": [
            "liquidity-fci",
            "wudsho",
            "交叉驗證",
            "未攤銷折價",
            "流動性風險",
            "聯準會",
            "金融壓力"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install detect-fed-unamortized-discount-pattern@macro-skills"
          ]
        },
        {
          "name": "detect-atr-squeeze-regime",
          "description": "以 14 日指數平滑 ATR 偵測市場是否從秩序型趨勢轉為波動主導的擠壓（squeeze）行情，並輸出對技術位、停損、交易持有期的可行性評估。",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/detect-atr-squeeze-regime",
          "category": "indicator-monitoring",
          "tags": [
            "ATR",
            "波動率",
            "擠壓行情",
            "停損管理",
            "風險控制",
            "技術分析"
          ],
          "categories": [
            "atr",
            "indicator-monitoring",
            "停損管理",
            "技術分析",
            "擠壓行情",
            "波動率",
            "風險控制"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install detect-atr-squeeze-regime@macro-skills"
          ]
        },
        {
          "name": "demographic-fiscal-trap-analyzer",
          "description": "分析人口老化、債務動態、官僚膨脹與通膨稀釋交互作用下的「財政陷阱」風險，量化各國/地區的財政脆弱度並識別潛在的貨幣稀釋路徑",
          "version": "0.1.0",
          "author": {
            "name": "macro-skills"
          },
          "source": "./skills/demographic-fiscal-trap-analyzer",
          "category": "policy-modeling",
          "tags": [
            "人口",
            "人口結構",
            "財政政策",
            "債務動能",
            "通貨膨脹",
            "人口老化"
          ],
          "categories": [
            "policy-modeling",
            "人口",
            "人口結構",
            "人口老化",
            "債務動能",
            "財政政策",
            "通貨膨脹"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install demographic-fiscal-trap-analyzer@macro-skills"
          ]
        },
        {
          "name": "cost-density-net-rr-calculator",
          "description": "計算非線性交易成本對風險報酬比的影響。將固定手續費與買賣價差整合為統一的成本密度（Cost Density）指標，揭示停損幅度與策略效率之間呈現雙曲線式的關係。",
          "version": "0.1.0",
          "author": {
            "name": "macro-skills"
          },
          "source": "./skills/cost-density-net-rr-calculator",
          "category": "indicator-monitoring",
          "tags": [],
          "categories": [
            "indicator-monitoring"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install cost-density-net-rr-calculator@macro-skills"
          ]
        },
        {
          "name": "backsolve-miner-vs-metal-ratio-with-fundamentals",
          "description": "從網路自動抓取礦業公司財務報表與營運揭露（產量、成本、資本支出），回算「礦業股/金屬本體比率」的基本面解釋與區間門檻（如 1.2/1.7），並輸出可重現的估值拆解（成本因子 / 槓桿因子 / 倍數因子 / 稀釋因子）。",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/backsolve-miner-vs-metal-ratio-with-fundamentals",
          "category": "commodity-sd",
          "tags": [
            "礦業股",
            "基本面",
            "AISC",
            "槓桿",
            "倍數",
            "稀釋"
          ],
          "categories": [
            "aisc",
            "commodity-sd",
            "倍數",
            "基本面",
            "槓桿",
            "礦業股",
            "稀釋"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install backsolve-miner-vs-metal-ratio-with-fundamentals@macro-skills"
          ]
        },
        {
          "name": "analyze-silver-miner-metal-ratio",
          "description": "以「銀礦股價格 / 白銀價格」的相對比率衡量礦業股板塊相對於金屬本體的估值區間（偏貴/偏便宜），並用歷史分位數與類比區間推導「底部/頂部」訊號與情境推演。",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/analyze-silver-miner-metal-ratio",
          "category": "commodity-sd",
          "tags": [
            "白銀",
            "礦業股",
            "SIL",
            "SILJ",
            "相對估值",
            "分位數"
          ],
          "categories": [
            "commodity-sd",
            "sil",
            "silj",
            "分位數",
            "白銀",
            "相對估值",
            "礦業股"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install analyze-silver-miner-metal-ratio@macro-skills"
          ]
        },
        {
          "name": "analyze-rolex-market-index-liquidity-proxy",
          "description": "用勞力士市場指數（WatchCharts Rolex Market Index）作為高 β 的風險偏好／流動性代理，建立可重現的公開數據流程，判讀「流動性改善但未到投機狂熱」的狀態",
          "version": "0.1.1",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/analyze-rolex-market-index-liquidity-proxy",
          "category": "liquidity-fci",
          "tags": [
            "勞力士市場指數",
            "Rolex",
            "流動性",
            "美聯儲",
            "實質利率",
            "二級市場"
          ],
          "categories": [
            "liquidity-fci",
            "rolex",
            "二級市場",
            "勞力士市場指數",
            "實質利率",
            "流動性",
            "美聯儲"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install analyze-rolex-market-index-liquidity-proxy@macro-skills"
          ]
        },
        {
          "name": "analyze-platinum-to-brazil-equities-transmission",
          "description": "使用公開市場資料量化驗證鉑/白金對巴西股市（EWZ）的長週期傳導/連動關係，輸出雙軸圖、領先落後分析、關聯強度分數與監控訊號。",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/analyze-platinum-to-brazil-equities-transmission",
          "category": "indicator-monitoring",
          "tags": [
            "白金",
            "巴西",
            "EWZ",
            "鉑",
            "原物料",
            "股市"
          ],
          "categories": [
            "ewz",
            "indicator-monitoring",
            "原物料",
            "巴西",
            "白金",
            "股市",
            "鉑"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install analyze-platinum-to-brazil-equities-transmission@macro-skills"
          ]
        },
        {
          "name": "analyze-us-bank-credit-deposit-decoupling",
          "description": "分析銀行貸款與存款之間的「信貸創造脫鉤」現象，用以辨識聯準會緊縮政策在銀行體系內部的真實傳導效果。",
          "version": "0.1.1",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/analyze-us-bank-credit-deposit-decoupling",
          "category": "credit-risk",
          "tags": [
            "QT",
            "聯準會",
            "銀行信貸",
            "存款",
            "RRP",
            "隱性緊縮"
          ],
          "categories": [
            "credit-risk",
            "qt",
            "rrp",
            "存款",
            "聯準會",
            "銀行信貸",
            "隱性緊縮"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install analyze-us-bank-credit-deposit-decoupling@macro-skills"
          ]
        },
        {
          "name": "analyze-move-risk-gauges-leadlag",
          "description": "用公開市場數據檢查「利率波動率（MOVE）是否對利率事件（如 JGB 殖利率變動）不恐慌，並且是否領先帶動 VIX / 信用利差走低」",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/analyze-move-risk-gauges-leadlag",
          "category": "interest-rates",
          "tags": [
            "利率波動率",
            "MOVE",
            "VIX",
            "信用利差",
            "領先落後",
            "事件分析"
          ],
          "categories": [
            "interest-rates",
            "move",
            "vix",
            "事件分析",
            "信用利差",
            "利率波動率",
            "領先落後"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install analyze-move-risk-gauges-leadlag@macro-skills"
          ]
        },
        {
          "name": "analyze-jgb-insurer-superlong-flow",
          "description": "從日本保險公司對長端/超長端 JGB 的淨買入(淨賣出) 時間序列，自動產出「本月是否創紀錄賣超、連續賣超月數、期間累積賣超」等結論。",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/analyze-jgb-insurer-superlong-flow",
          "category": "interest-rates",
          "tags": [
            "日本",
            "JGB",
            "保險公司",
            "長債",
            "淨買賣",
            "JSDA"
          ],
          "categories": [
            "interest-rates",
            "jgb",
            "jsda",
            "保險公司",
            "日本",
            "淨買賣",
            "長債"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install analyze-jgb-insurer-superlong-flow@macro-skills"
          ]
        },
        {
          "name": "analyze-japan-debt-service-tax-burden",
          "description": "以日本公債殖利率變化為觸發，量化「政府利息支出 / 稅收」負擔（含情境壓力測試），並判斷是否進入債務利息螺旋風險區。",
          "version": "0.1.1",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/analyze-japan-debt-service-tax-burden",
          "category": "interest-rates",
          "tags": [
            "日本",
            "國債",
            "債務",
            "利息支出",
            "稅收",
            "壓力測試"
          ],
          "categories": [
            "interest-rates",
            "債務",
            "利息支出",
            "國債",
            "壓力測試",
            "日本",
            "稅收"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install analyze-japan-debt-service-tax-burden@macro-skills"
          ]
        },
        {
          "name": "analyze-investment-clock-rotation",
          "description": "把「獲利成長 × 財務狀況（金融環境）」映射成「投資時鐘」，判斷目前落在哪個象限、近期是順時針還是逆時針旋轉、以及相對於上一輪循環的位置差異",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/analyze-investment-clock-rotation",
          "category": "business-cycles",
          "tags": [
            "投資時鐘",
            "景氣循環",
            "獲利成長",
            "金融環境",
            "資產配置",
            "象限分析"
          ],
          "categories": [
            "business-cycles",
            "投資時鐘",
            "景氣循環",
            "獲利成長",
            "象限分析",
            "資產配置",
            "金融環境"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install analyze-investment-clock-rotation@macro-skills"
          ]
        },
        {
          "name": "analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios",
          "description": "在「失業率走高／勞動市場轉弱」但「名目或實質 GDP 仍維持高位（或仍在成長）」的情境下，依據歷史關聯估算美國財政赤字占 GDP（Deficit/GDP）可能擴張的區間，並生成對長天期美債（長久期 UST）供給/利率風險的情境解讀。",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios",
          "category": "macro-indicator",
          "tags": [
            "失業率",
            "GDP",
            "財政赤字",
            "勞動市場",
            "JOLTS",
            "薩姆規則"
          ],
          "categories": [
            "gdp",
            "jolts",
            "macro-indicator",
            "勞動市場",
            "失業率",
            "薩姆規則",
            "財政赤字"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install analyze-high-unemployment-high-gdp-growth-fiscal-deficit-scenarios@macro-skills"
          ]
        },
        {
          "name": "analyze-gas-fertilizer-contract-shock",
          "description": "用天然氣與化肥價格的日頻數據，檢驗「天然氣暴漲→化肥供應受限/毀約→化肥飆價」敘事是否成立，輸出可標註到圖上的關鍵轉折點與領先落後分析。",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/analyze-gas-fertilizer-contract-shock",
          "category": "event-scenario",
          "tags": [
            "天然氣",
            "化肥",
            "尿素",
            "原物料",
            "事件分析",
            "不可抗力"
          ],
          "categories": [
            "event-scenario",
            "不可抗力",
            "事件分析",
            "化肥",
            "原物料",
            "天然氣",
            "尿素"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install analyze-gas-fertilizer-contract-shock@macro-skills"
          ]
        },
        {
          "name": "analyze-copper-supply-concentration-risk",
          "description": "用公開資料量化「銅供應是否過度集中、主要產地是否結構性衰退、替代增量是否依賴少數國家」，並輸出可行的中期供應風險結論與情境推演。",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/analyze-copper-supply-concentration-risk",
          "category": "commodity-sd",
          "tags": [
            "銅",
            "供給集中度",
            "原物料",
            "採礦",
            "地緣政治",
            "情境分析"
          ],
          "categories": [
            "commodity-sd",
            "供給集中度",
            "原物料",
            "地緣政治",
            "情境分析",
            "採礦",
            "銅"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install analyze-copper-supply-concentration-risk@macro-skills"
          ]
        },
        {
          "name": "analyze-copper-stock-resilience-dependency",
          "description": "用跨資產訊號（全球股市韌性 + 中國利率環境）評估銅價能否突破關卡或進入「回補/回踩」到支撐的機率與路徑",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/analyze-copper-stock-resilience-dependency",
          "category": "indicator-monitoring",
          "tags": [
            "銅價",
            "股市韌性",
            "跨資產分析",
            "中國利率",
            "關卡突破",
            "回補分析"
          ],
          "categories": [
            "indicator-monitoring",
            "中國利率",
            "回補分析",
            "股市韌性",
            "跨資產分析",
            "銅價",
            "關卡突破"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install analyze-copper-stock-resilience-dependency@macro-skills"
          ]
        },
        {
          "name": "analyze-copper-inventory-rebuild-signal",
          "description": "用「庫存快速回補」作為短期警戒訊號，評估銅價是否接近短線高點，同時給出一個「長期是否偏便宜」的歷史分位數判讀。",
          "version": "0.1.0",
          "author": {
            "name": "Ricky Wang"
          },
          "source": "./skills/analyze-copper-inventory-rebuild-signal",
          "category": "commodity-sd",
          "tags": [
            "銅",
            "庫存",
            "SHFE",
            "COMEX",
            "期貨",
            "技術分析"
          ],
          "categories": [
            "comex",
            "commodity-sd",
            "shfe",
            "庫存",
            "技術分析",
            "期貨",
            "銅"
          ],
          "install_commands": [
            "/plugin marketplace add fatfingererr/macro-skills",
            "/plugin install analyze-copper-inventory-rebuild-signal@macro-skills"
          ]
        }
      ]
    }
  ]
}