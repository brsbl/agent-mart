{
  "author": {
    "id": "empathic",
    "display_name": "empathic",
    "avatar_url": "https://avatars.githubusercontent.com/u/242685946?v=4"
  },
  "marketplaces": [
    {
      "name": "clash",
      "version": "0.1.0",
      "description": "Permission enforcement for Claude Code - policy-based tool access control with optional kernel-enforced sandboxing",
      "repo_full_name": "empathic/clash",
      "repo_url": "https://github.com/empathic/clash",
      "repo_description": "Command Line Agent Safety Harness. Stop babysitting Claude, go touch grass.",
      "signals": {
        "stars": 5,
        "forks": 0,
        "pushed_at": "2026-02-19T18:15:55Z"
      },
      "files": {
        ".claude-plugin/marketplace.json": "{\n  \"$schema\": \"https://anthropic.com/claude-code/marketplace.schema.json\",\n  \"name\": \"clash\",\n  \"version\": \"0.1.0\",\n  \"description\": \"Permission enforcement for Claude Code - policy-based tool access control with optional kernel-enforced sandboxing\",\n  \"owner\": {\n    \"name\": \"Empathic\"\n  },\n  \"plugins\": [\n    {\n      \"name\": \"clash\",\n      \"description\": \"Permission enforcement for Claude Code tool usage with policy-based rules, hierarchical settings, and optional kernel-enforced sandboxing via Landlock/seccomp (Linux) and Seatbelt (macOS)\",\n      \"version\": \"0.1.0\",\n      \"author\": {\n        \"name\": \"Empathic\"\n      },\n      \"source\": \"./clash-plugin\",\n      \"category\": \"security\"\n    }\n  ]\n}",
        "README.md": "# clash\n\n**C**ommand **L**ine **A**gent **S**afety **H**arness\n\nStop babysitting Claude, go touch grass.\n\n---\n> [!IMPORTANT]\n> Clash is under heavy development. It's being used by engineers at Empathic and is quite productive, but the API is not stable and is subject to change. Please report bugs!\n\n\n## The Problem\n\nClaude Code's default permission model is all-or-nothing: either you allow a tool entirely or get prompted every time. You end up clicking \"yes\" hundreds of times a session, or giving blanket approval and hoping for the best.\n\nClash gives you granular control. Write policy rules that decide what to **allow**, **deny**, or **ask** about — then let the agent work freely on safe operations while blocking dangerous ones. On Linux, rules can generate kernel-enforced filesystem sandboxes so even allowed commands can only touch the files you specify.\n\n---\n\n## Quick Start\n\nThere are two ways to run clash depending on what you're doing:\n\n### Install (use clash in your day-to-day work)\n\n```bash\ncargo install clash\nclash init\nclaude\n```\n\n`clash init` writes a default policy, installs the Claude Code plugin from GitHub, and walks you through initial configuration. After init, every `claude` session automatically loads clash.\n\nIf you have the repo checked out, you can also use `just install` which registers the plugin from the local source tree instead of GitHub.\n\n### Develop (hack on clash itself)\n\n```bash\njust dev\n```\n\nThis builds the binary, symlinks it into the source plugin directory, and launches a one-off Claude Code session with the plugin loaded directly from source. Changes to skills, hooks, or Rust code take effect on the next `just dev` — no install step needed.\n\n---\n\n## Interactive Configuration\n\nOnce clash is running inside Claude Code, you have access to slash commands (skills) for managing your policy without leaving your session:\n\n| Skill | What it does |\n|-------|-------------|\n| `/clash:onboard` | Interactively build your policy from scratch |\n| `/clash:edit` | Guided editing of your policy file |\n| `/clash:status` | Show current policy, rules, and enforcement status |\n| `/clash:describe` | Plain-English description of your active policy |\n| `/clash:explain` | See which rule matches a specific tool invocation |\n| `/clash:allow` | Quickly add an allow rule |\n| `/clash:deny` | Quickly add a deny rule |\n| `/clash:test` | Test your policy against hypothetical tool uses |\n| `/clash:audit` | View recent permission decisions from the audit log |\n\nIf you're new, start with `/clash:onboard` — it walks you through creating a policy tailored to your workflow.\n\n---\n\n## Policy Rules\n\nPolicies use s-expression syntax: `(effect (capability ...))`. Clash reads them on every tool invocation, so edits take effect immediately — no restart needed.\n\n### Policy Layers\n\nClash supports three policy levels, each automatically included and evaluated in order of precedence:\n\n| Level | Location | Purpose |\n|-------|----------|---------|\n| **User** | `~/.clash/policy.sexpr` | Your personal defaults across all projects |\n| **Project** | `<project>/.clash/policy.sexpr` | Shared rules for a specific repository |\n| **Session** | Created via `--scope session` | Temporary overrides for the current session |\n\n**Layer precedence:** Session > Project > User. Higher layers can shadow rules from lower layers — for example, a project-level deny overrides a user-level allow for the same capability. Use `clash status` to see all active layers and which rules are shadowed.\n\n### Example\n\n```lisp\n; ~/.clash/policy.sexpr (user level)\n(default ask \"main\")\n\n(policy \"main\"\n  (include \"cwd-access\")\n  (allow (exec \"cargo\" *))          ; let it run cargo commands\n  (allow (exec \"git\" *))            ; let it run git commands\n  (deny (exec \"git\" \"push\" *))      ; never allow push\n  (deny (exec \"git\" \"reset\" \"--hard\" *))\n  (allow (net \"github.com\")))        ; allow github.com access\n\n(policy \"cwd-access\"\n  (allow (fs read (subpath (env PWD))))\n  (allow (fs (or write create) (subpath (env PWD)))))\n```\n\n**Effects:** `allow` (auto-approve), `deny` (block), `ask` (prompt you)\n\n**Capabilities:** `exec` (commands), `fs` (filesystem), `net` (network)\n\n**Precedence:** `deny` always wins. More specific rules beat less specific. Within the same specificity, `ask` beats `allow`. Higher layers shadow lower layers at the same specificity. See [Policy Semantics](docs/policy-semantics.md) for the full algorithm.\n\n### Policy Blocks\n\nRules are organized into named **policy blocks** that can include other blocks, letting you compose reusable layers:\n\n```lisp\n(policy \"readonly\"\n  (allow (fs read (subpath (env PWD)))))\n\n(policy \"main\"\n  (include \"readonly\")              ; import rules from other blocks\n  (allow (exec \"git\" *)))\n```\n\n### Kernel Sandbox\n\nAllowed exec rules can carry sandbox constraints that clash compiles into OS-enforced sandboxes (Landlock on Linux, Seatbelt on macOS):\n\n```lisp\n(allow (exec \"cargo\" *)\n  (sandbox \"cargo-sandbox\"))\n\n(sandbox \"cargo-sandbox\"\n  (fs read (subpath (env PWD)))\n  (fs write (subpath \"./target\"))\n  (net allow))\n```\n\nEven if a command is allowed by policy, the sandbox ensures it can only access the paths you specify.\n\nFor the full rule syntax, see the [Policy Writing Guide](docs/policy-guide.md).\n\n---\n\n## Useful Commands\n\n```bash\nclash init                                   # set up clash with a safe default policy\nclash allow bash                             # allow command execution\nclash allow edit                             # allow file editing in project\nclash allow web                              # allow web access\nclash deny '(exec \"rm\" *)'                   # deny rm commands\nclash ask bash                               # require approval for bash commands\nclash status                                 # see all layers, rules, and shadowing\nclash update                                 # update clash to the latest release\nclash update --check                         # check for updates without installing\nclash explain bash \"git push\"                # see which rule matches a command\nclash policy list                            # list all rules with level tags\nclash policy remove '(deny (exec \"rm\" *))'   # remove a rule\nclash edit                                   # interactive policy editor\n```\n\nFor the full command reference, see the [CLI Reference](docs/cli-reference.md).\n\n---\n\n## Requirements\n\n- **macOS** (Apple Silicon or Intel) or **Linux** (x86_64 or aarch64)\n- [Claude Code](https://docs.anthropic.com/en/docs/claude-code) installed\n- Rust toolchain (for building from source)\n- Windows is **not** supported\n\n---\n\n## Troubleshooting\n\n### \"command not found: clash\"\n\nMake sure `~/.cargo/bin` is on your `PATH`:\n\n```bash\nexport PATH=\"$HOME/.cargo/bin:$PATH\"\n```\n\n### Double-prompting (clash asks, then Claude Code asks)\n\nThis means Claude Code's built-in permissions are still active. Re-run init — it sets `bypassPermissions: true` in your Claude Code user settings by default so clash is the sole permission handler:\n\n```bash\nclash init\n```\n\n### Policy not working as expected\n\nUse `clash explain` to see exactly which rule matches:\n\n```bash\nclash explain bash \"git push origin main\"\n```\n\nOr use the `/clash:explain` skill inside Claude Code for an interactive walkthrough.\n\n### All actions blocked — policy error\n\nIf every tool use is being denied with a \"policy failed to compile\" message, your policy file has a syntax error. Clash blocks all actions when it can't compile the policy rather than silently degrading.\n\nTo diagnose:\n\n```bash\nclash policy validate\n```\n\nThis will show which policy file has the error and suggest how to fix it. If you want to start fresh:\n\n```bash\nclash init\n```\n\n---\n\n## Documentation\n\n- [Policy Writing Guide](docs/policy-guide.md) — rules, profiles, constraints, and recipes\n- [CLI Reference](docs/cli-reference.md) — all commands, flags, and options\n- [Policy Grammar](docs/policy-grammar.md) — formal EBNF grammar\n- [Policy Semantics](docs/policy-semantics.md) — evaluation algorithm and sandbox generation\n\n---\n\n## Development\n\n### How it works\n\nClash is a Claude Code **plugin**. The plugin registers hooks that intercept every tool call and evaluate it against your policy before Claude Code executes it.\n\n```\nClaude Code → hook (PreToolUse) → clash binary → policy evaluation → allow / deny / ask\n```\n\nThe plugin lives in `clash-plugin/` and consists of hook definitions, skill definitions (slash commands), and the `clash` binary. In dev mode, `just dev` symlinks the freshly-built binary into `clash-plugin/bin/` and points Claude Code at the source directory. In install mode, `just install` stages a self-contained copy and registers it via the marketplace.\n\n### Recipes\n\n```bash\njust dev         # build + launch Claude Code with plugin from source\njust install     # build + install system-wide via marketplace\njust uninstall   # remove installed plugin and binary\njust check       # fmt + test + clippy\njust clester     # end-to-end tests (YAML-based hook simulation)\njust ci          # full CI (check + clester)\njust release 0.4.0  # bump versions, commit, tag (push to trigger release)\n```\n\n### Project Structure\n\n```\nclash/\n├── clash/              # CLI binary + library (Rust)\n├── clash-plugin/       # Claude Code plugin (hooks, skills, bin/)\n├── clash_notify/       # Notification support (desktop, Zulip)\n├── claude_settings/    # Claude Code settings library\n├── clester/            # End-to-end test harness\n└── docs/               # Documentation\n```\n\n---\n\n## License\n\nApache License 2.0\n",
        "clash-plugin/README.md": "# Clash Plugin for Claude Code\n\nThe Claude Code plugin that integrates clash into your agent sessions. It registers hooks to intercept tool calls and provides slash-command skills for managing your policy interactively.\n\nFor general usage and policy documentation, see the [project README](../README.md).\n\n## Building\n\nRequires Rust toolchain.\n\n```bash\n# Build the plugin (outputs to ./target/clash-dev/clash-plugin/)\njust build-plugin\n\n# Build and launch Claude Code with the plugin\njust dev\n```\n\n### Manual build\n\n```bash\ncargo build --release -p clash\nclaude --plugin-dir /path/to/clash-plugin\n```\n\nThe build copies this plugin directory and the compiled `clash` binary into a staging directory that Claude Code can load.\n\n## How It Works\n\nThe plugin registers four hook types via `hooks/hooks.json`:\n\n| Hook | Purpose |\n|------|---------|\n| **PreToolUse** | Evaluates policy rules before tool execution; returns Allow, Deny, or Ask |\n| **PostToolUse** | Runs after tool execution (audit logging) |\n| **PermissionRequest** | Responds to permission prompts on behalf of the user |\n| **Notification** | Handles notification events (permission prompts, idle detection, etc.) |\n\nPolicy rules are read from `~/.clash/policy.sexpr`. See the [Policy Writing Guide](../docs/policy-guide.md) for syntax.\n\n## Skills\n\nSkills are slash commands available inside Claude Code when the plugin is loaded:\n\n| Skill | Description |\n|-------|-------------|\n| `/clash:onboard` | Interactively build a policy from scratch |\n| `/clash:edit` | Guided editing of your policy file |\n| `/clash:status` | Show policy, rules, and enforcement status |\n| `/clash:describe` | Plain-English description of your active policy |\n| `/clash:explain` | See which rule matches a tool invocation |\n| `/clash:allow` | Add an allow rule |\n| `/clash:deny` | Add a deny rule |\n| `/clash:test` | Test policy against hypothetical tool uses |\n| `/clash:audit` | View recent permission decisions |\n| `/clash:bug-report` | File a bug report |\n\n## Project Structure\n\n```\nclash-plugin/\n├── .claude-plugin/\n│   └── plugin.json       # Plugin manifest\n├── hooks/\n│   └── hooks.json        # Hook configuration\n├── skills/\n│   ├── onboard/          # Interactive policy builder\n│   ├── edit/             # Guided policy editing\n│   ├── status/           # Status display\n│   ├── explain/          # Rule matching explanation\n│   ├── allow/            # Quick allow rule\n│   ├── deny/             # Quick deny rule\n│   ├── test/             # Policy testing\n│   ├── audit/            # Audit log viewer\n│   ├── describe/         # Policy description\n│   └── bug-report/       # Bug reporting\n└── bin/                  # Compiled clash binary (populated by build)\n```\n\n## Development\n\n```bash\njust dev       # build plugin and launch Claude Code with it\njust check     # fmt, test, clippy\n```\n\nLogs are written to `/tmp/clash.log`.\n"
      },
      "plugins": [
        {
          "name": "clash",
          "description": "Permission enforcement for Claude Code tool usage with policy-based rules, hierarchical settings, and optional kernel-enforced sandboxing via Landlock/seccomp (Linux) and Seatbelt (macOS)",
          "version": "0.1.0",
          "author": {
            "name": "Empathic"
          },
          "source": "./clash-plugin",
          "category": "security",
          "categories": [
            "security"
          ],
          "install_commands": [
            "/plugin marketplace add empathic/clash",
            "/plugin install clash@clash"
          ]
        }
      ]
    }
  ]
}