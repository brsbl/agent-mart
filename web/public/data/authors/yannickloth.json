{
  "author": {
    "id": "yannickloth",
    "display_name": "Yannick Loth",
    "avatar_url": "https://avatars.githubusercontent.com/u/727881?u=5695ae7ef945df90ca36f5792d07a6bbe6b2016f&v=4"
  },
  "marketplaces": [
    {
      "name": "yannickloth-claude-router-system",
      "version": null,
      "description": "Marketplace for Claude Code plugins with intelligent routing",
      "repo_full_name": "yannickloth/claude-router-system",
      "repo_url": "https://github.com/yannickloth/claude-router-system",
      "repo_description": "Reusable router system for Claude Code with IVP architecture, supporting intelligent agent delegation and cost optimization",
      "signals": {
        "stars": 0,
        "forks": 0,
        "pushed_at": "2026-02-14T20:07:42Z"
      },
      "files": {
        ".claude-plugin/marketplace.json": "{\n  \"name\": \"yannickloth-claude-router-system\",\n  \"owner\": {\n    \"name\": \"Yannick Loth\"\n  },\n  \"metadata\": {\n    \"description\": \"Marketplace for Claude Code plugins with intelligent routing\",\n    \"homepage\": \"https://github.com/yannickloth/claude-router-system\"\n  },\n  \"plugins\": [\n    {\n      \"name\": \"infolead-claude-subscription-router\",\n      \"version\": \"1.4.0\",\n      \"author\": {\n        \"name\": \"Yannick Loth\"\n      },\n      \"source\": \"./plugins/infolead-claude-subscription-router\",\n      \"category\": \"development\",\n      \"description\": \"Intelligent routing system for Claude Code with IVP-compliant architecture. Routes all requests through a central router that delegates to specialized or general agents based on task complexity, risk assessment, and cost optimization.\"\n    }\n  ]\n}\n",
        "README.md": "# Infolead Claude Code Marketplace\n\nA collection of plugins and tools for extending Claude Code with intelligent agent routing, cost optimization, and workflow automation.\n\n## Overview\n\nThis marketplace provides production-ready plugins that enhance Claude Code's capabilities through:\n\n- **Intelligent agent routing** - Automatically select the right model tier (Haiku/Sonnet/Opus) based on task complexity\n- **Cost optimization** - Minimize API costs while maintaining quality through smart delegation\n- **Workflow automation** - Coordinate multi-step processes with specialized agents\n- **State management** - Persistent cross-session memory and work queue coordination\n\n## Available Plugins\n\n### Infolead Claude Subscription Router\n\n**Status:** Production-ready\n**Location:** `plugins/infolead-claude-subscription-router/`\n\nAn intelligent routing system that analyzes user requests and delegates to the appropriate model tier. Features include:\n\n- **Automatic escalation** - Complex tasks route to more capable models\n- **Risk assessment** - Destructive operations get extra scrutiny\n- **WIP limits** - Prevent overwhelming parallel execution\n- **Semantic caching** - Avoid redundant expensive operations\n- **Cross-session state** - Persistent memory between Claude Code sessions\n\n**Quick start:**\n```bash\n# Install the plugin\nln -s $(pwd)/plugins/infolead-claude-subscription-router/.claude-plugin \\\n      ~/.claude/plugins/infolead-claude-subscription-router\n\n# Copy the configuration template to your project\ncp plugins/infolead-claude-subscription-router/EXAMPLE.claude.md \\\n   your-project/.claude/CLAUDE.md\n\n# Verify installation\nclaude /plugins\n```\n\nSee [plugin documentation](plugins/infolead-claude-subscription-router/README.md) for full details.\n\n## Roadmap\n\nSee [REFACTOR_PLAN.md](REFACTOR_PLAN.md) for the marketplace evolution plan, including:\n\n- Additional plugins (code review, testing, documentation)\n- Plugin discovery and versioning system\n- Community contribution guidelines\n- Quality standards and certification\n\n## Repository Structure\n\n```\nclaude-router-system/\nâ”œâ”€â”€ plugins/\nâ”‚   â””â”€â”€ infolead-claude-subscription-router/  # Router plugin\nâ”‚       â”œâ”€â”€ .claude-plugin/                    # Plugin definition\nâ”‚       â”œâ”€â”€ docs/                              # Documentation\nâ”‚       â””â”€â”€ README.md                          # Plugin-specific docs\nâ”œâ”€â”€ tests/\nâ”‚   â””â”€â”€ infolead-claude-subscription-router/   # Plugin tests\nâ”œâ”€â”€ README.md                                  # This file\nâ””â”€â”€ REFACTOR_PLAN.md                          # Roadmap\n```\n\n## Installation\n\n### Prerequisites\n\n- Claude Code CLI installed\n- Nix package manager (for running tests)\n- Python 3.12+ (for development)\n\n### Installing Plugins\n\n**Option 1: Symlink (recommended for development)**\n```bash\nln -s $(pwd)/plugins/PLUGIN_NAME/.claude-plugin \\\n      ~/.claude/plugins/PLUGIN_NAME\n```\n\n**Option 2: Copy (for stable usage)**\n```bash\ncp -r plugins/PLUGIN_NAME/.claude-plugin \\\n      ~/.claude/plugins/PLUGIN_NAME\n```\n\n### Verifying Installation\n\n```bash\n# Start Claude Code and check plugins loaded\nclaude /plugins\n\n# Verify agents available\nclaude /agents\n```\n\n## Testing\n\nEach plugin includes comprehensive tests:\n\n```bash\n# Run all tests for a plugin\n./tests/PLUGIN_NAME/run_all_tests.sh\n\n# Run specific test suites\n./tests/PLUGIN_NAME/test_hooks.sh\nnix-shell -p python312Packages.pytest python312Packages.pyyaml \\\n  --run \"pytest tests/PLUGIN_NAME/ -v\"\n```\n\nSee individual plugin documentation for detailed testing guides.\n\n## Development\n\n### Adding a New Plugin\n\n1. Create plugin directory: `plugins/your-plugin-name/`\n2. Add `.claude-plugin/` structure (see existing plugins as templates)\n3. Write comprehensive tests in `tests/your-plugin-name/`\n4. Document in `plugins/your-plugin-name/README.md`\n5. Update this README's plugin list\n\n### Plugin Structure Requirements\n\nEach plugin must include:\n\n- `.claude-plugin/plugin.json` - Plugin metadata\n- `.claude-plugin/agents/*.md` - Agent definitions\n- `.claude-plugin/hooks/` - Event hooks (optional)\n- `README.md` - Plugin documentation\n- `tests/` - Comprehensive test suite\n\n## Contributing\n\nContributions are welcome! Please:\n\n1. Follow the plugin structure requirements\n2. Include comprehensive tests (aim for >90% coverage)\n3. Document all features and configuration options\n4. Ensure tests pass: `./tests/PLUGIN_NAME/run_all_tests.sh`\n\n## License\n\nMIT License - see individual plugin directories for specific licensing details.\n\n## Support\n\n- **Documentation:** See `plugins/*/docs/` for detailed guides\n- **Issues:** GitHub Issues for bug reports and feature requests\n- **Discussions:** GitHub Discussions for questions and community support\n\n## Credits\n\nCreated and maintained by Infolead.\n\nBuilt on [Claude Code](https://claude.ai/code) by Anthropic.",
        "plugins/infolead-claude-subscription-router/README.md": "# Infolead Claude Subscription Router\n\n**Intelligent routing architecture for Claude Code with IVP-compliant design, cost optimization, and specialized agent delegation.**\n\n**Plugin name:** `infolead-claude-subscription-router`\n\n[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)\n[![Claude Code](https://img.shields.io/badge/Claude-Code-blue.svg)](https://github.com/anthropics/claude-code)\n\n---\n\n## What This Plugin Provides\n\n### ğŸ¯ Core Routing System (Phase 1 & 2)\n- **Central router**: All requests flow through a single routing decision point\n- **Risk assessment**: Automatic evaluation of destructive operations and high-stakes changes\n- **Agent matching**: Routes to appropriate agent based on task complexity and domain\n- **Cost optimization**: Strategy advisor analyzes execution patterns for cost efficiency\n- **Semantic caching**: Deduplication of similar requests with 40-50% hit rate\n- **Work coordination**: Parallel work tracking with completion guarantees\n\n### ğŸ¯ Domain Integration (Phase 3)\n- **Domain detection**: Automatic detection of project type (LaTeX, software-dev, knowledge-mgmt)\n- **Workflow management**: Domain-specific workflows with quality gates and parallelism settings\n- **Lazy context loading**: LRU-cached section-level file loading to minimize context overhead\n- **Context optimization**: 50k token budget for context, 150k for conversation\n\n### ğŸ“Š Monitoring & Metrics (Phase 4)\n- **Metrics collection**: Track performance across all 8 optimization solutions\n- **Daily/weekly reports**: Automated performance summaries with target assessment\n- **Monitoring hooks**: Routing audit, session state capture, morning briefing\n- **Usage tracking**: Agent invocation logging with duration, model tier, and cost estimates\n- **Integration testing**: Comprehensive test suite for all components\n\n### ğŸ¤– Agent Hierarchy\n- **Router agents**: `router`, `router-escalation`, `strategy-advisor`, `planner`\n- **General agents**: `haiku-general`, `sonnet-general`, `opus-general`\n- **Project agents**: Add your own specialized agents to `.claude/agents/`\n\n### ğŸ’° Cost Optimization\n- **Haiku pre-routing**: 30-40% escalation rate saves 60-70% quota\n- **Propose-review pattern**: Haiku proposes, Sonnet reviews for bulk mechanical edits\n- **Draft-then-evaluate pattern**: Haiku batch-drafts, Sonnet batch-evaluates for content generation (40-60% savings at batch 10+)\n- **Semantic deduplication**: 40-50% cache hit rate eliminates redundant work\n- **Break-even analysis**: Only use expensive models when justified\n\n### ğŸ”€ Adaptive Orchestration (v1.6.0, Enhanced in v1.6.1)\n\n**Intelligent orchestration strategy selection based on request complexity.**\n\nInstead of applying universal multi-stage orchestration (interpret â†’ plan â†’ execute) to all requests, adaptive orchestration classifies requests and chooses the optimal strategy.\n\n**NEW in v1.6.1:** YAML configuration support for customizing classification thresholds, pattern weights, and custom domain-specific patterns.\n\n**Three Orchestration Modes:**\n\n1. **Single-Stage (SIMPLE)** - Fast path for mechanical operations\n   - Pattern: `route â†’ execute`\n   - Examples: \"Fix typo in README.md\", \"Format code in main.py\"\n   - Overhead: ~50ms\n   - Use: 30% of requests\n\n2. **Single-Stage with Monitoring (MODERATE)** - Normal path for typical requests\n   - Pattern: `route â†’ execute + monitor`\n   - Examples: \"Fix bug in auth.py\", \"Add logging to payment module\"\n   - Overhead: ~100ms\n   - Use: 50% of requests\n\n3. **Multi-Stage (COMPLEX)** - Deliberate path for ambiguous/complex work\n   - Pattern: `interpret â†’ plan â†’ execute`\n   - Examples: \"Design caching architecture\", \"Which approach is best for auth?\"\n   - Overhead: ~300ms\n   - Use: 20% of requests\n\n**Performance Benefits:**\n\n- 12% average latency increase (vs 150% for universal multi-stage)\n- 12% average cost increase (vs 56% for universal multi-stage)\n- 15% accuracy improvement on complex requests\n- Maintained speed for simple requests\n\n### ğŸ—‚ï¸ Multi-Project Support (v1.7.0)\n\n**Complete project isolation with hybrid architecture.**\n\nWork on multiple projects simultaneously without state corruption, with per-project configuration and metrics tracking.\n\n**Key Features:**\n\n- **Automatic Project Detection** - Detects `.claude` directory to identify project boundaries\n- **Isolated State/Metrics/Logs** - Each project gets its own isolated storage\n- **Project-Aware Configuration** - Cascade: project â†’ global â†’ defaults\n- **Per-Project Enable/Disable** - Fine-grained router control per project\n- **Concurrent Sessions Safe** - File locking prevents race conditions\n- **Easy Migration** - One-command upgrade from v1.6.x\n\n**Architecture:**\n\n- **Global router logic** - One plugin installation, shared routing intelligence\n- **Project-specific state** - Complete isolation prevents state mixing\n- **Hybrid model** - Best of both worlds\n\n**Storage Structure:**\n\n```\n~/.claude/infolead-claude-subscription-router/projects/\n  â”œâ”€â”€ abc123/  # Project A (stable hash ID)\n  â”‚   â”œâ”€â”€ state/\n  â”‚   â”œâ”€â”€ metrics/\n  â”‚   â””â”€â”€ logs/\n  â””â”€â”€ 789def/  # Project B\n      â”œâ”€â”€ state/\n      â”œâ”€â”€ metrics/\n      â””â”€â”€ logs/\n```\n\n**Benefits:**\n\nâœ… No state corruption when switching projects\nâœ… Accurate per-project cost tracking\nâœ… Project-specific routing configuration\nâœ… Work on 5+ projects simultaneously\nâœ… Clean migration from v1.6.x\n\nSee [MULTI-PROJECT-ARCHITECTURE.md](docs/MULTI-PROJECT-ARCHITECTURE.md) for complete details.\n\n**Classification Criteria:**\n\n- Fast heuristic analysis (no API calls, <1ms)\n- Pattern matching on request text\n- Detects: mechanical ops, design keywords, judgment signals, multi-objective requests\n\n**CLI Usage:**\n\n```bash\n# Analyze request complexity and orchestration mode\npython3 implementation/adaptive_orchestrator.py \"Design a caching system\"\n\n# JSON output\npython3 implementation/adaptive_orchestrator.py --json \"Fix typo in README.md\"\n\n# Run tests (14 test cases)\npython3 implementation/adaptive_orchestrator.py --test\n```\n\n**Documentation:**\n\n- Technical details: [docs/Solution/Architecture/ADAPTIVE-ORCHESTRATION.md](docs/Solution/Architecture/ADAPTIVE-ORCHESTRATION.md)\n- Implementation: [implementation/adaptive_orchestrator.py](implementation/adaptive_orchestrator.py)\n- Optional hook integration: [hooks/user-prompt-submit-with-orchestration.sh.example](hooks/user-prompt-submit-with-orchestration.sh.example)\n\n### ğŸ“ IVP Architecture\nBuilt on the **Independent Variation Principle** (IVP): separate concerns with different change drivers into independent units.\n\n- **Router** changes when: task understanding evolves\n- **Strategy-advisor** changes when: API pricing or optimization strategies change\n- **Agents** change when: their specific domain capabilities change\n\n**Reference:** [Independent Variation Principle (DOI 10.5281/zenodo.17677315)](https://doi.org/10.5281/zenodo.17677315)\n\n---\n\n## ğŸ” Visibility & Monitoring (NEW in v1.3.0)\n\n### Real-Time Routing Recommendations\n\nEvery request now displays routing analysis **before** main Claude processes it:\n\n```\n[ROUTER] Recommendation: haiku-general (confidence: 0.95)\n[ROUTER] Reason: High-confidence agent match\n```\n\n**What you see:**\n\n- âœ… **Agent recommendation**: Which agent the pre-router suggests\n- âœ… **Confidence level**: How certain the recommendation is (0.0-1.0)\n- âœ… **Reasoning**: Why this agent was chosen\n\n**What happens:**\n1. Pre-router analyzes your request using mechanical escalation logic\n2. Recommendation is displayed to you (stderr)\n3. Recommendation is injected into main Claude's context\n4. Main Claude makes final decision with full context\n5. Both recommendation and actual decision are logged to metrics\n\n### Advisory System\n\n**Important**: Recommendations are **advisory, not mandatory**.\n\nMain Claude sees the pre-router's recommendation as input but makes the final decision based on:\n\n- Pre-router's recommendation\n- Conversation history\n- Project context\n- Your specific requirements\n\n**Claude can**:\n- âœ… Follow the recommendation\n- âš ï¸  Override (upgrade/downgrade tier)\n- â“ Escalate (ask for clarification)\n\n**You always see both** the recommendation and Claude's decision.\n\n### Metrics Collection\n\nAll routing decisions are tracked to:\n```\n~/.claude/infolead-claude-subscription-router/metrics/YYYY-MM-DD.jsonl\n```\n\n**What's logged:**\n\n- Timestamp of request\n- Request hash (for correlation)\n- Recommended agent\n- Confidence level\n- Reasoning\n- Full analysis\n\n**Performance:**\n- Average latency: ~108ms per request\n- Atomic writes: Safe for concurrent requests\n- Daily rotation: New file each day\n\n### Visibility Benefits\n\n**For you:**\n\n- See what the router is thinking\n- Verify system is working correctly\n- Build trust through transparency\n- Understand routing patterns\n\n**For main Claude:**\n- Advisory input for routing decisions\n- Context for explaining choices\n- Override when additional context changes assessment\n\n**For the system:**\n\n- Metrics enable continuous improvement\n- Track recommendation accuracy\n- Identify patterns for optimization\n- Auditable trail of all decisions\n\n### Example: Visible Routing Flow\n\n```\nUser: \"Fix typo in README.md line 42\"\n     â†“\n[Pre-Router analyzes automatically]\n     â†“\nYOU SEE:\n  [ROUTER] Recommendation: haiku-general (confidence: 0.98)\n  [ROUTER] Reason: Mechanical syntax fix with explicit file path\n     â†“\nCLAUDE SEES:\n  <routing-recommendation>\n    {\"decision\":\"direct\",\"agent\":\"haiku-general\",\"confidence\":0.98}\n  </routing-recommendation>\n     â†“\nCLAUDE RESPONDS:\n  \"The pre-router correctly identified this as a mechanical task.\n   I'll delegate to haiku-general.\"\n     â†“\nMETRICS LOG:\n  {\"timestamp\":\"2026-02-05T17:00:00+01:00\",\n   \"recommendation\":{\"agent\":\"haiku-general\",\"confidence\":0.98}}\n```\n\n### Testing Visibility\n\n```bash\n# From plugin directory\ncd plugins/infolead-claude-subscription-router\n\n# Test routing recommendations\necho \"Fix typo in README.md\" | python3 implementation/routing_core.py --json\n\n# Test full hook (with visibility)\nexport CLAUDE_PLUGIN_ROOT=\"$PWD\"\necho \"Fix typo in README.md\" | bash hooks/user-prompt-submit.sh\n\n# Check metrics\ncat ~/.claude/infolead-claude-subscription-router/metrics/$(date +%Y-%m-%d).jsonl | tail -5\n\n# Run comprehensive tests\nbash tests/test-routing-visibility.sh\n```\n\n### Documentation\n\n- **[OPTION-D-IMPLEMENTATION.md](docs/OPTION-D-IMPLEMENTATION.md)**: Technical implementation details\n- **[CLAUDE-ROUTING-ADVISORY.md](docs/CLAUDE-ROUTING-ADVISORY.md)**: Guide for main Claude\n- **[IMPLEMENTATION-REVIEW.md](docs/IMPLEMENTATION-REVIEW.md)**: Complete review and test results\n\n---\n\n## Prerequisites\n\n**System tools:**\n\n| Tool | Purpose | Required |\n|------|---------|----------|\n| `python3` (3.12+) | Implementation modules, routing core | Yes |\n| `jq` | JSON processing in hooks | Yes |\n| `bash` | Hook scripts | Yes |\n| `git` | Cache invalidation, metrics | Yes |\n| `shellcheck` | Hook script linting (dev only) | No |\n\n**Python packages:**\n\n| Package | Purpose | Required |\n|---------|---------|----------|\n| `pyyaml` | Domain adapter YAML parsing | Yes |\n| `pytest` | Test suite | Dev only |\n\n**NixOS/Nix users:** All dependencies are provided by `flake.nix`:\n\n```bash\nnix develop  # or direnv allow\n```\n\n---\n\n## Quick Start\n\n### Test the Implementation\n\n```bash\n# From the plugin directory\ncd plugins/infolead-claude-subscription-router\n\n# 1. List available domains\npython3 implementation/domain_adapter.py list\n\n# 2. Detect domain in your project\npython3 implementation/domain_adapter.py detect\n\n# 3. View a workflow\npython3 implementation/domain_adapter.py workflow latex-research formalization\n\n# 4. Record test metrics\npython3 implementation/metrics_collector.py record haiku_routing escalation --value 35\n\n# 5. Generate daily report\npython3 implementation/metrics_collector.py report daily\n\n# 6. Run integration tests (from repo root)\ncd ../..\n./tests/infolead-claude-subscription-router/run_all_tests.sh\n```\n\n---\n\n## Installation\n\n### Option 1: Via Claude Code Plugin System (Recommended)\n\n```bash\n# Install plugin\n/plugin install infolead-claude-subscription-router\n```\n\n### Option 2: Manual Installation\n\n```bash\n# Clone the marketplace repo\ncd ~/.claude\ngit clone https://github.com/yannickloth/claude-router-system.git marketplace\n\n# Symlink the plugin\nln -s ~/.claude/marketplace/plugins/infolead-claude-subscription-router~/.claude/plugins/\n\n# Symlink agents to global agents directory\nln -s ~/.claude/plugins/infolead-claude-subscription-router/agents/* ~/.claude/agents/\n```\n\n---\n\n## Update\n\nKeep your plugin up to date with the latest features and bug fixes:\n\n```bash\ncd ~/.claude/plugins/infolead-claude-subscription-router\n./scripts/update.sh\n```\n\n**What gets updated:**\n\n- Plugin code (via git pull)\n- Hooks in all settings files where currently installed\n- Skills (if changed and installed)\n- Systemd services (if changed and installed)\n\n**Options:**\n\n```bash\n./scripts/update.sh --dry-run     # Preview changes without applying\n./scripts/update.sh --skip-git    # Only update components, skip git pull\n./scripts/update.sh --force       # Force update even if unchanged\n```\n\n**When to update:**\n\n- After a new release is announced\n- When you encounter bugs that have been fixed\n- To get new features or performance improvements\n\n---\n\n## Uninstall\n\nTo completely remove the plugin:\n\n```bash\ncd ~/.claude/plugins/infolead-claude-subscription-router\n./scripts/uninstall.sh\n```\n\n**What gets removed:**\n\n- Plugin hooks from all settings files (local, project, global)\n- Write/Edit permissions from all settings files\n- Overnight execution system (skills, systemd, state/logs)\n- Plugin and agent symlinks (if manually installed)\n\n**Options:**\n\n```bash\n./scripts/uninstall.sh --dry-run     # Preview what would be removed\n./scripts/uninstall.sh --keep-data   # Keep metrics, state, and logs\n```\n\n**After uninstall:**\n\n1. Restart Claude Code\n2. All plugin functionality will be removed\n3. To reinstall: `/plugin install infolead-claude-subscription-router`\n\n---\n\n## Configuration\n\n### 1. Copy Routing Rules to Your Project\n\nCopy the routing configuration template:\n\n```bash\n# From your project root\ncp ~/.claude/plugins/infolead-claude-subscription-router/EXAMPLE.claude.md .claude/CLAUDE.md\n```\n\nOr add to your **global** `~/.claude/CLAUDE.md` to enable routing for all projects.\n\n### 2. (Optional) Add Project-Specific Agents\n\nCreate `.claude/agents/` in your project and add specialized agents:\n\n```bash\nmkdir -p .claude/agents\ntouch .claude/agents/my-domain-agent.md\n```\n\nThe router will check project-specific agents first before falling back to general agents.\n\n### 3. (Optional) Configure Adaptive Orchestration\n\n**New in v1.6.1:** Customize adaptive orchestration behavior via YAML configuration.\n\n**Configuration file:** `~/.claude/adaptive-orchestration.yaml`\n\n**Quick setup:**\n\n```bash\n# Copy example config\ncp ~/.claude/plugins/infolead-claude-subscription-router/adaptive-orchestration.yaml.example \\\n   ~/.claude/adaptive-orchestration.yaml\n\n# Edit to customize (optional)\nnano ~/.claude/adaptive-orchestration.yaml\n```\n\n**What you can configure:**\n\n- **Thresholds**: Control SIMPLE/COMPLEX classification strictness\n- **Weights**: Adjust pattern match influence on confidence\n- **Custom patterns**: Add domain-specific patterns (migrations, deployments, etc.)\n- **Force mode**: Override orchestration strategy (debugging only)\n\n**Example custom patterns:**\n\n```yaml\npatterns:\n  custom_simple:\n    - pattern: '\\\\brun\\\\s+tests?\\\\b'\n      name: 'run_tests'\n  custom_complex:\n    - pattern: '\\\\bmigrat(e|ion)\\\\b'\n      name: 'migration_task'\n    - pattern: '\\\\bdeploy\\\\s+to\\\\s+prod(uction)?\\\\b'\n      name: 'production_deployment'\n```\n\n**Fallback behavior:**\n\nThe system works perfectly without configuration. If the config file is missing or malformed, it uses built-in defaults. This ensures backward compatibility.\n\n**Documentation:**\n\n- Configuration reference: [adaptive-orchestration.yaml.example](adaptive-orchestration.yaml.example)\n- Technical details: [docs/Solution/Architecture/ADAPTIVE-ORCHESTRATION.md#configuration](docs/Solution/Architecture/ADAPTIVE-ORCHESTRATION.md#configuration)\n\n---\n\n## How It Works\n\n### Routing Flow\n\n```\nUser request\n    â†“\nrouter (parse intent, assess risk, match agent)\n    â†“\nstrategy-advisor (cost/benefit analysis)\n    â†“\nselected agent (execute task)\n    â†“\nresults returned to user\n```\n\n### Agent Selection Priority\n\n1. **Project-specific agents** (`.claude/agents/`) - exact domain match\n2. **General agents** - based on reasoning complexity:\n   - `haiku-general`: Mechanical, no judgment, explicit paths\n   - `sonnet-general`: Default for reasoning/analysis\n   - `opus-general`: Complex reasoning, proofs, high-stakes\n\n### Cost Optimization Patterns\n\n**Direct execution:**\n```\nrouter â†’ agent â†’ results\n```\n\n**Propose-review pattern** (for bulk mechanical file edits):\n```\nrouter â†’ strategy-advisor\n       â†“\nhaiku-general (propose changes)\n       â†“\nsonnet-general (review + apply)\n       â†“\nresults\n```\n\n**Break-even:** Haikuâ†’Sonnet saves money when success rate > 60%\n\n**Draft-then-evaluate pattern** (for bulk content generation):\n```\nrouter â†’ strategy-advisor\n       â†“\nhaiku-general (batch draft N items, 0 Sonnet quota)\n       â†“\nsonnet-general (batch evaluate all N in 1 message)\n       â†“\nsonnet-general (fix rejects only)\n       â†“\nresults\n```\n\n**Break-even:** Profitable when acceptance rate > 1/N (batch 10: >10%, batch 50: >2%)\n\n**When to use which:**\n- **Propose-review**: Modifying existing files (patches, syntax fixes, refactors)\n- **Draft-then-evaluate**: Generating new content (docstrings, comments, descriptions)\n\n---\n\n## Architecture Principles\n\n### Independent Variation Principle (IVP)\n\n**Change drivers are the reasons units change.** Units with different change drivers should be separated.\n\n#### Router Agent\n\n**Change Driver Set:** Task understanding evolution, risk categorization, agent capabilities\n\n- Changes when: New types of requests need routing, risk categories evolve, understanding of task patterns improves\n- **Does NOT change when:** API pricing changes, optimization strategies evolve\n\n#### Strategy-Advisor Agent\n\n**Change Driver Set:** API pricing models, cost optimization strategies, performance characteristics\n\n- Changes when: Anthropic updates pricing, new optimization patterns discovered, model performance shifts\n- **Does NOT change when:** New agent types added, task understanding improves, risk rules change\n\n#### General Agents (haiku/sonnet/opus)\n\n**Change Driver Set:** Model capabilities, safety protocols, output requirements\n\n- Changes when: Model capabilities change, safety best practices evolve, output format standards update\n- **Does NOT change when:** Routing logic changes, pricing changes, new domains added\n\n#### Project-Specific Agents\n\n**Change Driver Set:** Domain knowledge, domain-specific tooling, domain best practices\n\n- Changes when: Domain understanding deepens, domain tools evolve, best practices in that domain change\n- **Does NOT change when:** Global routing changes, pricing changes, other domains change\n\n**Why this matters:** When API pricing changes, you only update `strategy-advisor`. When task understanding improves, you only update `router`. Changes are isolated and predictable.\n\n---\n\n## Usage Examples\n\n### Basic Request Routing\n\n```\nUser: \"Fix all LaTeX syntax errors in chapter files\"\n\nrouter: Assesses â†’ mechanical task, multiple files, compiler verification\n       â†“\nstrategy-advisor: Recommends propose-review pattern\n       â†“\nhaiku-general: Proposes fixes across 30 files\n       â†“\nsonnet-general: Reviews, runs nix build, applies changes\n       â†“\nResults: \"Fixed 47 LaTeX errors across 30 files, build passes\"\n```\n\n### High-Stakes Request\n\n```\nUser: \"Delete all unused files\"\n\nrouter: Assesses â†’ destructive, ambiguous scope, high risk\n       â†“\nsonnet-general: Analyzes patterns, asks for confirmation\n       â†“\nUser confirms\n       â†“\nResults: \"Found 12 candidates, deleted 8 confirmed unused files\"\n```\n\n### Complex Reasoning Request\n\n```\nUser: \"Verify this mathematical proof is correct\"\n\nrouter: Assesses â†’ requires deep analysis, high error cost\n       â†“\nstrategy-advisor: Recommends direct-opus (no cheaper path)\n       â†“\nopus-general: Analyzes proof step-by-step\n       â†“\nResults: \"Proof verified. Found 1 subtle flaw in step 7: [detailed explanation]\"\n```\n\n### Bulk Content Generation (Draft-Then-Evaluate)\n\n```\nUser: \"Generate docstrings for all 50 functions in src/utils/\"\n\nrouter: Assesses â†’ content generation, high volume, mechanical\n       â†“\nstrategy-advisor: Recommends draft-then-evaluate (batch 50, ~60% acceptance expected)\n       â†“\nhaiku-general: Generates 50 docstring drafts (0 Sonnet quota)\n       â†“\nsonnet-general: Batch evaluates all 50 in 1 message (1 Sonnet quota)\n       â†“\nsonnet-general: Fixes 20 rejected drafts (20 Sonnet quota)\n       â†“\nResults: \"Generated 50 docstrings. 30 accepted, 15 refined, 5 replaced.\"\n         \"Total: 21 Sonnet messages (58% savings vs 50 direct)\"\n```\n\n---\n\n## Routing Rules Reference\n\n### Absolute Routing Enforcement\n\n**EVERY user request goes through router. No exceptions.**\n\n```\nâœ… User request â†’ router â†’ agent\nâŒ User request â†’ agent (bypasses router)\nâŒ User request â†’ Claude answers directly\n```\n\nEven simple questions route through the system:\n- \"What's the status?\" â†’ router â†’ haiku-general\n- \"Explain this code\" â†’ router â†’ sonnet-general\n- \"Is this proof valid?\" â†’ router â†’ opus-general\n\n**Why:** Consistency, cost optimization, risk assessment\n\n### Risk Assessment\n\nBefore routing destructive operations:\n\n1. **Identify scope**: Which files affected?\n2. **Assess value**: Is content important?\n3. **Check specificity**: Explicit paths or patterns?\n4. **Evaluate reversibility**: Can we undo?\n5. **Route defensively**:\n   - High risk â†’ `sonnet-general` or `opus-general`\n   - Low risk + explicit paths â†’ `haiku-general`\n   - ANY uncertainty â†’ `sonnet-general`\n\n### Protected Files\n\n**Never route to haiku-general:**\n- `.claude/agents/*.md` (agent definitions)\n- High-value content (proofs, papers, critical code)\n- Ambiguous patterns (user didn't specify exact files)\n\n---\n\n## Extending the System\n\n### Adding Project-Specific Agents\n\nCreate `.claude/agents/my-agent.md`:\n\n```markdown\n---\nname: my-domain-agent\ndescription: Handles X domain tasks with Y capabilities. Use when user requests Z.\nmodel: sonnet\ntools: Read, Edit, Write, Bash\n---\n\nYou are a specialized agent for [domain].\n\n## Capabilities\n- [What this agent does]\n\n## Change Driver Set\n**This agent changes when:** [list change drivers specific to this domain]\n**This agent does NOT change when:** [list unrelated change drivers]\n\n[Rest of agent specification]\n```\n\n**Change Driver Set:** Domain knowledge for X, tooling for Y, best practices in Z\n\nThe router will automatically discover and use your agent when requests match the description.\n\n### Creating Domain-Specific Plugins\n\nYou can create your own plugin that extends this router system:\n\n```\nmy-domain-plugin/\nâ”œâ”€â”€ .claude-plugin/\nâ”‚   â””â”€â”€ plugin.json\nâ”œâ”€â”€ agents/\nâ”‚   â”œâ”€â”€ domain-agent-1.md\nâ”‚   â””â”€â”€ domain-agent-2.md\nâ””â”€â”€ README.md\n```\n\nThe router will check both the core general agents and your domain agents.\n\n---\n\n## Cost Optimization Details\n\n### Model Pricing (as of 2026-01)\n\n| Model | Input | Output | Relative Cost |\n|-------|--------|--------|---------------|\n| Haiku | $0.25/MTok | $1.25/MTok | 1x |\n| Sonnet | $3.00/MTok | $15.00/MTok | 12x |\n| Opus | $15.00/MTok | $75.00/MTok | 60x |\n\n### Strategy Selection Criteria\n\n**Mechanical Score:** 0.0 (pure judgment) to 1.0 (fully mechanical)\n\n| Task Type | Score | Agent Choice |\n|-----------|-------|--------------|\n| Exact pattern replacement | 1.0 | haiku-general |\n| Syntax fixes (verified) | 0.9 | haikuâ†’sonnet (propose-review) |\n| Reference updates | 0.8 | haikuâ†’sonnet (propose-review) |\n| Formatting | 0.5 | sonnet-general |\n| Style improvements | 0.3 | sonnet-general |\n| Pure judgment | 0.1 | sonnet-general or opus-general |\n\n### Propose-Review Break-Even\n\n**Haikuâ†’Sonnet review:**\n- Saves money when haiku success rate > 60%\n- Typical use cases: 80-90% success rate\n- Estimated savings: 60-70% vs direct-sonnet\n\n**Sonnetâ†’Opus review:**\n- Saves money when sonnet success rate > 67%\n- Typical use cases: 75-85% success rate\n- Estimated savings: 40-50% vs direct-opus\n\n---\n\n## Usage Tracking & Cost Analysis\n\n### Metrics Collector CLI\n\nThe plugin tracks all agent invocations and computes solution-level metrics:\n\n```bash\ncd implementation/\n\n# Run tests to verify setup\npython3 metrics_collector.py --test\n\n# Compute all solution metrics with status vs targets\npython3 metrics_collector.py compute\n\n# Calculate cost efficiency (savings vs baseline)\npython3 metrics_collector.py efficiency\n\n# Live dashboard showing recent agent activity\npython3 metrics_collector.py dashboard\n\n# Generate daily report\npython3 metrics_collector.py report daily\n\n# Generate weekly report\npython3 metrics_collector.py report weekly\n```\n\n### Solution Metrics Output\n\n```\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n                   Solution Metrics Dashboard\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSolution             Metric                 Value    Target       Status\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nhaiku_routing        escalation_rate        35.2%    30-40%       âœ“ ON TARGET\nwork_coordination    completion_rate        94.5%    90-100%      âœ“ ON TARGET\ndomain_optimization  detection_accuracy     97.3%    95-100%      âœ“ ON TARGET\ntemporal_optimization quota_utilization     82.1%    80-90%       âœ“ ON TARGET\ndeduplication        cache_hit_rate         45.8%    40-50%       âœ“ ON TARGET\nprobabilistic_routing optimistic_success    89.2%    85-100%      âœ“ ON TARGET\nstate_continuity     save_success           99.1%    98-100%      âœ“ ON TARGET\ncontext_ux           avg_response_time      3.2s     0-5s         âœ“ ON TARGET\n```\n\n### Efficiency Report Output\n\n```text\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n                      Routing Efficiency Report\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nModel Distribution:\n  haiku:   28 invocations  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ\n  sonnet:  12 invocations  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ\n  opus:     2 invocations  â–ˆâ–ˆ\n\nCost Analysis (vs sonnet baseline):\n  Actual cost:        52 units\n  Baseline cost:     504 units (if all used sonnet)\n  Savings:           452 units\n  Savings percent:   89.7%\n```\n\n### Metrics Storage\n\n- **Project logs**: `.claude/logs/routing.log` - Per-project routing decisions\n- **Global metrics**: `~/.claude/infolead-claude-subscription-router/metrics/YYYY-MM-DD.jsonl` - Daily aggregated metrics\n\n### Hooks\n\nThe plugin uses Claude Code hooks for tracking:\n\n- **SubagentStart**: Logs when agents spawn (timestamp, agent type, ID)\n- **SubagentStop**: Logs when agents complete (duration, exit status, model tier)\n\n---\n\n## Troubleshooting\n\n### Hooks Not Executing (Plugin Bug)\n\n**Symptoms:** Routing recommendations don't appear, session hooks don't run, no metrics logged.\n\n**Cause:** Claude Code has a known bug where plugin-defined hooks are matched but never executed.\n\n**Affected issues:**\n- [#10225](https://github.com/anthropics/claude-code/issues/10225) - UserPromptSubmit hooks from plugins match but never execute\n- [#14410](https://github.com/anthropics/claude-code/issues/14410) - Local plugin hooks match but never execute\n\n**Workaround:** Copy hooks to settings.json:\n\n```bash\ncd plugins/infolead-claude-subscription-router\n\n# Choose your scope:\n./scripts/setup-hooks-workaround.sh --local    # This user, this project\n./scripts/setup-hooks-workaround.sh --project  # All users, this project\n./scripts/setup-hooks-workaround.sh --global   # This user, all projects\n\n# Preview first\n./scripts/setup-hooks-workaround.sh --local --dry-run\n\n# Revert when bug is fixed\n./scripts/setup-hooks-workaround.sh --local --revert\n```\n\nSee **[docs/HOOKS-WORKAROUND.md](docs/HOOKS-WORKAROUND.md)** for detailed instructions.\n\n---\n\n### \"Router not being used\"\n\nCheck your `.claude/CLAUDE.md`:\n- Routing rules copied from `EXAMPLE.claude.md`?\n- Absolute routing enforcement section present?\n- Global `~/.claude/CLAUDE.md` configured?\n\n### \"Agent completed silently\"\n\nAll agents have **mandatory output requirements**. If an agent produces no output:\n- Router will detect and re-route\n- Check agent definition for output requirements section\n- Verify agent is using correct output patterns\n\n### \"Wrong agent selected\"\n\nRouter logs reasoning before delegating:\n```\nRouting: sonnet-general\nReason: Requires judgment for ambiguous file patterns\n```\n\nCheck the routing explanation to understand the decision.\n\n### \"Agent doesn't know its tools\"\n\nGeneral agents now include explicit tool lists in their prompts. If you encounter this:\n\n- Ensure you have the latest agent definitions\n- Check that the agent file includes the \"Available Tools\" section\n\n### \"Agent can't spawn subagents\"\n\n**This is by design.** General agents (`haiku-general`, `sonnet-general`, `opus-general`) are execution endpointsâ€”they execute tasks themselves and do not further delegate.\n\n**Workaround for multi-step workflows:** The main session coordinates:\n\n```text\n1. Main session spawns agent for Phase 1\n2. Collect results\n3. Main session spawns agent for Phase 2\n4. Repeat as needed\n```\n\nSee \"Multi-Step Workflow Coordination\" in `EXAMPLE.claude.md` for detailed patterns.\n\n---\n\n## Known Limitations\n\n### General Agents Are Endpoints\n\nGeneral agents execute tasks directly. They cannot spawn other agents for sub-delegation. This prevents routing chains but means the main session must coordinate multi-phase workflows.\n\n### Model Parameter Behavior\n\nWhen using the Task tool:\n\n- Agent definitions specify a default `model:` in frontmatter\n- The Task tool's `model:` parameter can override this\n- Best practice: let agent definitions control their model\n\n### Namespace Resolution\n\nBoth short names (`haiku-general`) and fully qualified names (`infolead-claude-subscription-router:haiku-general`) work. Use short names unless you need to disambiguate between plugins with identical agent names.\n\n---\n\n## Contributing\n\nContributions welcome! Please:\n\n1. **Follow IVP**: Separate concerns by change driver\n2. **Document change drivers**: Every new agent must list its change driver set\n3. **Test routing**: Verify router correctly identifies when to use new agents\n4. **Update examples**: Add usage examples for new capabilities\n\n### Change Driver Documentation Template\n\nWhen adding new agents or modules:\n\n```markdown\n## Change Driver Set\n\n**This [unit] changes when:**\n- [Change driver 1]\n- [Change driver 2]\n\n**This [unit] does NOT change when:**\n- [Unrelated change driver 1]\n- [Unrelated change driver 2]\n\n**IVP Compliance:** [Explain how this unit maintains separation of concerns]\n```\n\n---\n\n## License\n\nMIT License - see [LICENSE](LICENSE) file for details.\n\n---\n\n## Acknowledgments\n\n- Built for [Claude Code](https://github.com/anthropics/claude-code)\n- Architecture based on [Independent Variation Principle](https://doi.org/10.5281/zenodo.17677315)\n- Inspired by cost-conscious LLM orchestration patterns\n\n---\n\n## Support\n\n- **Issues**: [GitHub Issues](https://github.com/yannickloth/claude-router-system/issues)\n- **Discussions**: [GitHub Discussions](https://github.com/yannickloth/claude-router-system/discussions)\n- **Claude Code**: [Official Docs](https://github.com/anthropics/claude-code)"
      },
      "plugins": [
        {
          "name": "infolead-claude-subscription-router",
          "version": "1.4.0",
          "author": {
            "name": "Yannick Loth"
          },
          "source": "./plugins/infolead-claude-subscription-router",
          "category": "development",
          "description": "Intelligent routing system for Claude Code with IVP-compliant architecture. Routes all requests through a central router that delegates to specialized or general agents based on task complexity, risk assessment, and cost optimization.",
          "categories": [
            "development"
          ],
          "install_commands": [
            "/plugin marketplace add yannickloth/claude-router-system",
            "/plugin install infolead-claude-subscription-router@yannickloth-claude-router-system"
          ]
        }
      ]
    }
  ]
}