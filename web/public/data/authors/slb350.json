{
  "author": {
    "id": "slb350",
    "display_name": "Stephen Brandon",
    "type": "User",
    "avatar_url": "https://avatars.githubusercontent.com/u/6173176?v=4",
    "url": "https://github.com/slb350",
    "bio": null,
    "stats": {
      "total_marketplaces": 1,
      "total_plugins": 1,
      "total_commands": 1,
      "total_skills": 1,
      "total_stars": 1,
      "total_forks": 0
    }
  },
  "marketplaces": [
    {
      "name": "gemini-peer-review",
      "version": "1.0.0",
      "description": "Claude Code plugin for AI peer review validation using Google Gemini CLI. Two AI perspectives catch more issues than one.",
      "owner_info": {
        "name": "slb350"
      },
      "keywords": [],
      "repo_full_name": "slb350/gemini-peer-review",
      "repo_url": "https://github.com/slb350/gemini-peer-review",
      "repo_description": "Claude Code plugin for AI peer review validation using Google Gemini CLI. Two AI perspectives catch more issues than one.",
      "homepage": "",
      "signals": {
        "stars": 1,
        "forks": 0,
        "pushed_at": "2026-01-20T17:58:13Z",
        "created_at": "2026-01-20T17:43:59Z",
        "license": null
      },
      "file_tree": [
        {
          "path": ".claude-plugin",
          "type": "tree",
          "size": null
        },
        {
          "path": ".claude-plugin/marketplace.json",
          "type": "blob",
          "size": 802
        },
        {
          "path": "plugins",
          "type": "tree",
          "size": null
        },
        {
          "path": "plugins/gemini-peer-review",
          "type": "tree",
          "size": null
        },
        {
          "path": "plugins/gemini-peer-review/.claude-plugin",
          "type": "tree",
          "size": null
        },
        {
          "path": "plugins/gemini-peer-review/.claude-plugin/plugin.json",
          "type": "blob",
          "size": 252
        },
        {
          "path": "plugins/gemini-peer-review/agents",
          "type": "tree",
          "size": null
        },
        {
          "path": "plugins/gemini-peer-review/agents/gemini-peer-reviewer.md",
          "type": "blob",
          "size": 6707
        },
        {
          "path": "plugins/gemini-peer-review/commands",
          "type": "tree",
          "size": null
        },
        {
          "path": "plugins/gemini-peer-review/commands/gemini-peer-review.md",
          "type": "blob",
          "size": 4164
        },
        {
          "path": "plugins/gemini-peer-review/hooks",
          "type": "tree",
          "size": null
        },
        {
          "path": "plugins/gemini-peer-review/hooks/hooks.json",
          "type": "blob",
          "size": 1648
        },
        {
          "path": "plugins/gemini-peer-review/hooks/peer-review-reminder.sh",
          "type": "blob",
          "size": 1217
        },
        {
          "path": "plugins/gemini-peer-review/hooks/plan-peer-review-check.sh",
          "type": "blob",
          "size": 664
        },
        {
          "path": "plugins/gemini-peer-review/hooks/stop-peer-review-check.sh",
          "type": "blob",
          "size": 1111
        },
        {
          "path": "plugins/gemini-peer-review/hooks/task-peer-review-check.sh",
          "type": "blob",
          "size": 655
        },
        {
          "path": "plugins/gemini-peer-review/hooks/user-prompt-check.sh",
          "type": "blob",
          "size": 891
        },
        {
          "path": "plugins/gemini-peer-review/hooks/write-peer-review-check.sh",
          "type": "blob",
          "size": 806
        },
        {
          "path": "plugins/gemini-peer-review/skills",
          "type": "tree",
          "size": null
        },
        {
          "path": "plugins/gemini-peer-review/skills/gemini-peer-review",
          "type": "tree",
          "size": null
        },
        {
          "path": "plugins/gemini-peer-review/skills/gemini-peer-review/SKILL.md",
          "type": "blob",
          "size": 13449
        },
        {
          "path": "plugins/gemini-peer-review/skills/gemini-peer-review/common-mistakes.md",
          "type": "blob",
          "size": 9700
        },
        {
          "path": "plugins/gemini-peer-review/skills/gemini-peer-review/discussion-protocol.md",
          "type": "blob",
          "size": 7516
        },
        {
          "path": "plugins/gemini-peer-review/skills/gemini-peer-review/escalation-criteria.md",
          "type": "blob",
          "size": 5249
        }
      ],
      "files": {
        ".claude-plugin/marketplace.json": "{\n  \"$schema\": \"https://anthropic.com/claude-code/marketplace.schema.json\",\n  \"name\": \"gemini-peer-review\",\n  \"version\": \"1.0.0\",\n  \"description\": \"Claude Code plugin for AI peer review validation using Google Gemini CLI. Two AI perspectives catch more issues than one.\",\n  \"owner\": {\n    \"name\": \"slb350\"\n  },\n  \"plugins\": [\n    {\n      \"name\": \"gemini-peer-review\",\n      \"version\": \"1.0.0\",\n      \"description\": \"Peer validation system using Google Gemini CLI. Validates Claude's designs and code reviews through structured discussion before presenting to user.\",\n      \"author\": {\n        \"name\": \"slb350\"\n      },\n      \"source\": \"./plugins/gemini-peer-review\",\n      \"category\": \"code-quality\",\n      \"tags\": [\"peer-review\", \"code-review\", \"validation\", \"gemini\", \"ai-collaboration\"]\n    }\n  ]\n}\n",
        "plugins/gemini-peer-review/.claude-plugin/plugin.json": "{\n  \"name\": \"gemini-peer-review\",\n  \"description\": \"Peer validation system using Google Gemini CLI. Validates Claude's designs and code reviews through structured discussion before presenting to user.\",\n  \"author\": {\n    \"name\": \"stephenbrandon\"\n  }\n}\n",
        "plugins/gemini-peer-review/agents/gemini-peer-reviewer.md": "---\nname: gemini-peer-reviewer\ndescription: Use this agent to run peer review validation with Gemini CLI. Dispatches to a separate context to keep the main conversation clean. Returns synthesized peer review results.\nmodel: sonnet\nskills:\n  - gemini-peer-review\nallowed-tools:\n  - Bash(gemini:*)\n  - Bash(mktemp:*)\n  - Bash(cat:*)\n  - Bash(command:*)\n  - Bash(which:*)\n  - Bash(jq:*)\n  - Bash(grep:*)\n  - Bash(head:*)\n  - Bash(tee:*)\n  - Bash(sed:*)\n  - Bash(rm:*)\n  - Read\n---\n\n# Gemini Peer Reviewer Agent\n\nYou are a peer review agent that validates Claude's work using Google Gemini CLI. You run in a separate context to keep the main conversation clean.\n\n## Your Task\n\nYou will receive one of the following from the main conversation:\n1. **Claude's design/plan** to validate\n2. **Claude's code review findings** to cross-check\n3. **An architecture recommendation** to verify\n4. **A broad technical question** Claude answered\n\n## Workflow\n\n### Step 1: Verify Prerequisites\n```bash\n# Check gemini CLI\nif ! command -v gemini &>/dev/null; then\n  echo \"ERROR: Gemini CLI not installed. Cannot proceed with peer review.\"\n  exit 1\nfi\n```\n\n### Step 2: Run Gemini Validation\n\n**CRITICAL - Gemini CLI Differences from Codex:**\n- Gemini has NO `review` command - everything uses prompts via `gemini` command directly\n- Always use `-s` (sandbox mode) and `-m gemini-3-pro-preview` and `-o json`\n- **MANDATORY:** Every prompt MUST end with: `CRITICAL: Do not use any tools. Output text only.`\n- Use temp files for prompts to avoid shell escaping issues\n\n**Command pattern:**\n```bash\nPROMPT_FILE=$(mktemp /tmp/gemini-prompt-XXXXXX.md)\ncat > \"$PROMPT_FILE\" <<'PROMPT_EOF'\n[Your review/validation prompt here]\n\nCRITICAL: Do not use any tools. Output text only.\nPROMPT_EOF\n\nOUTPUT_FILE=$(mktemp /tmp/gemini-output-XXXXXX.json)\ngemini -s -m gemini-3-pro-preview -o json \"$(cat \"$PROMPT_FILE\")\" > \"$OUTPUT_FILE\" 2>&1\n\n# Parse JSON (handles Markdown-wrapped output)\nRESPONSE=$(cat \"$OUTPUT_FILE\" | sed 's/^```json//; s/^```//; s/```$//' | grep -v '^Loaded cached' | jq -r '.response // .' 2>/dev/null || cat \"$OUTPUT_FILE\")\n\n# Cleanup\nrm -f \"$PROMPT_FILE\" \"$OUTPUT_FILE\"\n```\n\n### Robust JSON Parsing\n\nGemini's `-o json` output is sometimes wrapped in Markdown code blocks. Always parse output to extract clean JSON:\n\n```bash\n# Function to extract JSON from potentially wrapped output\nparse_gemini_output() {\n  local input=\"$1\"\n  # Strip markdown code fences if present\n  echo \"$input\" | sed 's/^```json//; s/^```//; s/```$//' | \\\n    # Remove CLI status messages\n    grep -v '^Loaded cached' | \\\n    # Extract response field, or return raw if not JSON\n    jq -r '.response // .' 2>/dev/null || echo \"$input\"\n}\n\n# Usage:\nRAW_OUTPUT=$(gemini -s -m gemini-3-pro-preview -o json \"$(cat \"$PROMPT_FILE\")\" 2>&1)\nRESPONSE=$(parse_gemini_output \"$RAW_OUTPUT\")\n```\n\n### For Code Review (reviewing actual code changes)\n\nSince Gemini has no `review` command, construct a prompt that includes the diff:\n\n```bash\n# Get the diff first\nDIFF=$(git diff --base [branch] 2>/dev/null || echo \"Unable to get diff\")\n\nPROMPT_FILE=$(mktemp /tmp/gemini-prompt-XXXXXX.md)\ncat > \"$PROMPT_FILE\" <<PROMPT_EOF\nReview the following code changes for:\n- Code quality issues\n- Potential bugs\n- Security concerns\n- Edge cases\n\nFocus area: [Claude's review focus]\n\n\\`\\`\\`diff\n$DIFF\n\\`\\`\\`\n\nCRITICAL: Do not use any tools. Output text only.\nPROMPT_EOF\n\ngemini -s -m gemini-3-pro-preview -o json \"$(cat \"$PROMPT_FILE\")\"\n```\n\n### For Design/Plan Validation\n\n```bash\nPROMPT_FILE=$(mktemp /tmp/gemini-prompt-XXXXXX.md)\ncat > \"$PROMPT_FILE\" <<'PROMPT_EOF'\nValidate this design/refactoring plan:\n\n[Summarize Claude's specific proposal in 2-3 sentences]\n\nFiles affected: [list specific files]\n\nCheck for:\n- Architecture issues\n- Potential problems with this approach\n- Better alternatives\n- Missing considerations\n\nProvide specific, actionable feedback.\n\nCRITICAL: Do not use any tools. Output text only.\nPROMPT_EOF\n\ngemini -s -m gemini-3-pro-preview -o json \"$(cat \"$PROMPT_FILE\")\"\n```\n\n### Step 3: Compare Results\n\nClassify the outcome:\n- **Agreement**: Both AIs aligned -> Synthesize and return\n- **Disagreement**: Positions differ -> Run discussion protocol (up to 2 rounds)\n- **Critical Issue**: Security/architecture/breaking change -> Escalate immediately\n\n### Step 4: Return Synthesized Result\n\nReturn ONLY the final peer review result to the main conversation:\n\n```markdown\n## Peer Review Result\n\n**Status:** [Validated | Resolved through discussion | Escalated]\n**Confidence:** [High | Medium-High | Medium]\n\n**Summary:** [2-3 sentence synthesis]\n\n**Key Findings:**\n- [Finding 1]\n- [Finding 2]\n\n**Recommendation:** [Final recommendation]\n```\n\n## Discussion Protocol (When Disagreement Occurs)\n\n**IMPORTANT:** Gemini's `--resume latest` is unreliable (index-based, not ID-based). For discussion rounds, **re-inject the full context** into each prompt rather than relying on session resume.\n\n### Round 1 (Initial Discussion)\n\n```bash\nPROMPT_FILE=$(mktemp /tmp/gemini-round1-XXXXXX.md)\ncat > \"$PROMPT_FILE\" <<'PROMPT_EOF'\nGiven this disagreement about [topic]:\n\nClaude's position: [summary with evidence]\n\nProvide your evidence-based reasoning. Reference specific code or conventions.\nWhat is your position and why?\n\nCRITICAL: Do not use any tools. Output text only.\nPROMPT_EOF\n\ngemini -s -m gemini-3-pro-preview -o json \"$(cat \"$PROMPT_FILE\")\" 2>&1 | tee /tmp/gemini_round1_$$.json\n```\n\n### Round 2 (Continued Discussion with Context Re-injection)\n\n```bash\n# Re-inject Round 1 context (don't rely on --resume)\nPROMPT_FILE=$(mktemp /tmp/gemini-round2-XXXXXX.md)\ncat > \"$PROMPT_FILE\" <<'PROMPT_EOF'\nContinuing discussion about [topic]:\n\nRound 1 summary:\n- Claude's position: [summary]\n- Gemini's position: [summary from Round 1]\n\nClaude's Round 2 response: [new evidence]\n\nCan we reach synthesis? What is your final position?\n\nCRITICAL: Do not use any tools. Output text only.\nPROMPT_EOF\n\ngemini -s -m gemini-3-pro-preview -o json \"$(cat \"$PROMPT_FILE\")\"\n```\n\n## Important Rules\n\n1. **Do NOT** return raw Gemini output to the main conversation\n2. **Do NOT** return discussion round details unless specifically requested\n3. **DO** keep the main context clean by summarizing results\n4. **DO** escalate immediately for security/architecture/breaking changes\n5. **ALWAYS** append the NO_TOOLS instruction to every prompt\n6. **NEVER** use `--resume` flag - re-inject context instead\n7. **ALWAYS** use `-s -m gemini-3-pro-preview -o json` flags\n\n## Reference\n\nThe full peer review protocol is defined in the `gemini-peer-review` skill. Load it if you need detailed guidance on:\n- Discussion protocol (2-round maximum)\n- Escalation criteria\n- Common mistakes to avoid\n",
        "plugins/gemini-peer-review/commands/gemini-peer-review.md": "---\nname: gemini-peer-review\ndescription: Trigger peer review validation with Gemini CLI. Use without arguments for current changes, --base <branch> for specific branch comparison, or add a question for broad technical validation.\nallowed-tools:\n  - Bash(gemini:*)\n  - Bash(mktemp:*)\n  - Bash(cat:*)\n  - Bash(command:*)\n  - Bash(which:*)\n  - Bash(jq:*)\n  - Bash(grep:*)\n  - Bash(head:*)\n  - Bash(tee:*)\n  - Bash(git:*)\n  - Read\n  - Task\n  - AskUserQuestion\n---\n\n# Gemini Peer Review Command\n\nYou have been explicitly asked to run peer review validation using Google Gemini CLI.\n\n## Parse Arguments\n\nCheck for arguments in the command:\n- `/gemini-peer-review` - Review current changes (will ask what to review)\n- `/gemini-peer-review --base <branch>` - Review against specified branch\n- `/gemini-peer-review --uncommitted` - Review staged/unstaged/untracked changes only\n- `/gemini-peer-review --commit <SHA>` - Review a specific commit\n- `/gemini-peer-review <question>` - Validate answer to a broad technical question\n\n## Execute\n\n**IMPORTANT:** All peer review work MUST run as a subagent to keep the main context clean.\n\n1. **Gather information** from the user (review type, branch, etc.)\n2. **Dispatch to the `gemini-peer-reviewer` agent** with the Task tool\n3. **Return only the synthesized result** to the user\n\nBased on the arguments:\n\n### No arguments (ask user what to review)\n**IMPORTANT:** Ask the user what type of review they want.\n\nUse `AskUserQuestion` tool:\n```yaml\nquestion: \"What would you like to review?\"\nheader: \"Review type\"\noptions:\n  - label: \"Changes vs branch\"\n    description: \"Compare current changes against a base branch (will ask which branch)\"\n  - label: \"Uncommitted changes\"\n    description: \"Review staged, unstaged, and untracked changes only\"\n  - label: \"Specific commit\"\n    description: \"Review changes from a specific commit (will ask for SHA)\"\nmultiSelect: false\n```\n\n#### If \"Changes vs branch\" selected\nAsk for the base branch:\n```yaml\nquestion: \"Which branch should I compare against?\"\nheader: \"Base branch\"\noptions:\n  - label: \"main\"\n    description: \"Compare against the main branch\"\n  - label: \"develop\"\n    description: \"Compare against the develop branch\"\n  - label: \"master\"\n    description: \"Compare against the master branch\"\nmultiSelect: false\n```\nThen the subagent will: get the diff with `git diff [branch]...HEAD` and review it via Gemini prompt\n\n#### If \"Uncommitted changes\" selected\nThe subagent will: get the diff with `git diff` and `git diff --staged` and review via Gemini prompt\n\n#### If \"Specific commit\" selected\nAsk: \"What is the commit SHA to review?\"\nThen the subagent will: get the diff with `git show [SHA]` and review via Gemini prompt\n\n### With explicit flags\nUse the specified flag directly:\n- `--base <branch>`: Get diff with `git diff [branch]...HEAD`\n- `--uncommitted`: Get diff with `git diff` and `git diff --staged`\n- `--commit <SHA>`: Get diff with `git show [SHA]`\n\n### Handling \"no changes\" case\nIf git reports no changes to review, inform the user:\n\"No changes found to review. Make sure you have uncommitted changes or specify a branch with divergent commits.\"\n\n### With a question\nThis is a **design/architecture validation**:\n\nDispatch a subagent with:\n```\nValidate Claude's response to this question using Gemini CLI.\n\nQuestion: [the question from arguments]\n\nUse gemini with focused prompt about the question.\n\nReturn findings for comparison and synthesis.\n```\n\n## Dispatch to Agent\n\nAfter gathering the review parameters, dispatch to the `gemini-peer-reviewer` agent:\n\n```\nUse Task tool:\n  subagent_type: \"gemini-peer-review:gemini-peer-reviewer\"\n  prompt: |\n    Run peer review validation.\n\n    Type: [code-review | design | architecture | question]\n    [For code-review]: Branch: [branch], Focus: [focus area if any]\n    [For design/arch/question]: Claude's position: [summary]\n\n    Return only the synthesized peer review result.\n```\n\n## Output\n\nThe agent will return a synthesized result. Present it to the user:\n- **Validated**: Both AIs agreed\n- **Resolved**: Disagreement resolved through discussion\n- **Escalated**: Required external research (Perplexity/WebSearch)\n",
        "plugins/gemini-peer-review/hooks/hooks.json": "{\n  \"description\": \"Peer review reminder hooks - multi-point triggering for comprehensive coverage\",\n  \"hooks\": {\n    \"SessionStart\": [\n      {\n        \"matcher\": \"*\",\n        \"hooks\": [\n          {\n            \"type\": \"command\",\n            \"command\": \"bash ${CLAUDE_PLUGIN_ROOT}/hooks/peer-review-reminder.sh\",\n            \"timeout\": 10\n          }\n        ]\n      }\n    ],\n    \"UserPromptSubmit\": [\n      {\n        \"matcher\": \"*\",\n        \"hooks\": [\n          {\n            \"type\": \"command\",\n            \"command\": \"bash ${CLAUDE_PLUGIN_ROOT}/hooks/user-prompt-check.sh\",\n            \"timeout\": 5\n          }\n        ]\n      }\n    ],\n    \"Stop\": [\n      {\n        \"matcher\": \"*\",\n        \"hooks\": [\n          {\n            \"type\": \"command\",\n            \"command\": \"bash ${CLAUDE_PLUGIN_ROOT}/hooks/stop-peer-review-check.sh\",\n            \"timeout\": 5\n          }\n        ]\n      }\n    ],\n    \"PreToolUse\": [\n      {\n        \"matcher\": \"ExitPlanMode\",\n        \"hooks\": [\n          {\n            \"type\": \"command\",\n            \"command\": \"bash ${CLAUDE_PLUGIN_ROOT}/hooks/plan-peer-review-check.sh\",\n            \"timeout\": 5\n          }\n        ]\n      },\n      {\n        \"matcher\": \"Task\",\n        \"hooks\": [\n          {\n            \"type\": \"command\",\n            \"command\": \"bash ${CLAUDE_PLUGIN_ROOT}/hooks/task-peer-review-check.sh\",\n            \"timeout\": 5\n          }\n        ]\n      },\n      {\n        \"matcher\": \"Write\",\n        \"hooks\": [\n          {\n            \"type\": \"command\",\n            \"command\": \"bash ${CLAUDE_PLUGIN_ROOT}/hooks/write-peer-review-check.sh\",\n            \"timeout\": 5\n          }\n        ]\n      }\n    ]\n  }\n}\n",
        "plugins/gemini-peer-review/hooks/peer-review-reminder.sh": "#!/bin/bash\n# SessionStart hook to remind Claude about peer review requirements\n# This hook runs at the start of each Claude Code session\n\n# Check if gemini CLI is available\nGEMINI_STATUS=\"\"\nif command -v gemini &>/dev/null; then\n  GEMINI_STATUS=\"✓ Gemini CLI is installed\"\nelse\n  GEMINI_STATUS=\"⚠ Gemini CLI not found\"\nfi\n\ncat << 'EOF'\n## Peer Review Requirement\n\n**BEFORE presenting any of the following to the user, you MUST dispatch to the `gemini-peer-reviewer` agent:**\n- Implementation plans or designs\n- Code review results\n- Architecture recommendations\n- Major refactoring proposals\n- Answers to broad technical questions\n\n**How to trigger:** Use the Task tool to dispatch to the `gemini-peer-reviewer` agent with your findings. The agent runs in a **separate context** to keep the main conversation clean, then returns only the synthesized peer review result.\n\nExample:\n```\nTask tool with subagent_type=\"gemini-peer-review:gemini-peer-reviewer\"\nprompt: \"Validate this design: [your design summary]\"\n```\n\n**Why:** Two AI perspectives catch more issues than one. Running as a subagent keeps Gemini CLI output isolated and returns only distilled results.\nEOF\n\necho \"**Gemini CLI Status:** $GEMINI_STATUS\"\n",
        "plugins/gemini-peer-review/hooks/plan-peer-review-check.sh": "#!/bin/bash\n# PreToolUse hook for ExitPlanMode: Remind to peer review the plan\n\ncat << 'EOF'\n## Peer Review Check - Before Presenting Plan\n\nYou are about to present an implementation plan to the user.\n\n**STOP and verify:** Has this plan been validated by the `gemini-peer-review:gemini-peer-reviewer` agent?\n\nPlans that should be peer reviewed:\n- Multi-step implementation plans\n- Architecture decisions\n- Significant refactoring proposals\n- Security-sensitive changes\n- Performance-critical designs\n\n**If not yet reviewed:** Dispatch to the peer review agent BEFORE calling ExitPlanMode.\n\n**If already reviewed or not applicable:** Proceed with ExitPlanMode.\nEOF\n",
        "plugins/gemini-peer-review/hooks/stop-peer-review-check.sh": "#!/bin/bash\n# Stop hook: STRONGLY remind Claude to verify peer review was performed\n\ncat << 'EOF'\n## ⚠️ STOP - Peer Review Verification Required\n\n**BEFORE you complete this response, answer these questions:**\n\n### 1. Did your response include ANY of these?\n- [ ] Implementation plan or design\n- [ ] Code review findings\n- [ ] Architecture recommendation\n- [ ] Multi-file code changes\n- [ ] Answer to \"how should I...\" or \"what's the best way to...\"\n\n### 2. If YES to any above: Did you dispatch to `gemini-peer-review:gemini-peer-reviewer`?\n\n**If NO - you MUST do one of these NOW:**\n1. **Dispatch peer review:** Use Task tool with `subagent_type=\"gemini-peer-review:gemini-peer-reviewer\"`\n2. **Explain skip:** Add a note: \"Skipping peer review because: [trivial change / user declined / already validated]\"\n\n### 3. Acceptable reasons to skip:\n- Single-line fixes or typo corrections\n- User explicitly said \"skip peer review\" or \"just do it\"\n- Pure information lookup (no recommendations)\n- Following up on already-reviewed work\n\n**Do NOT proceed without either peer review or explicit justification.**\nEOF\n",
        "plugins/gemini-peer-review/hooks/task-peer-review-check.sh": "#!/bin/bash\n# PreToolUse hook for Task: Check if dispatching to a review-related agent\n\n# Get tool input from environment (if available)\nTOOL_INPUT=\"${CLAUDE_TOOL_INPUT:-}\"\n\n# Check if this is dispatching to a code review or similar agent (but NOT our peer reviewer)\nif echo \"$TOOL_INPUT\" | grep -qiE \"code-review|review|architect|design\" && \\\n   ! echo \"$TOOL_INPUT\" | grep -qiE \"gemini-peer-review\"; then\n  cat << 'EOF'\n**Peer Review Reminder:** You're dispatching to a review/design agent.\n\nAfter this agent returns, consider dispatching to `gemini-peer-review:gemini-peer-reviewer` to cross-validate the findings before presenting to the user.\nEOF\nfi\n",
        "plugins/gemini-peer-review/hooks/user-prompt-check.sh": "#!/bin/bash\n# UserPromptSubmit hook: Identify requests likely needing peer review\n\n# Get the user's prompt from stdin or environment\nUSER_PROMPT=\"${CLAUDE_USER_PROMPT:-}\"\n\n# Keywords that suggest peer review would be valuable\nPLAN_KEYWORDS=\"implement|design|architect|refactor|plan|build|create.*feature|add.*feature\"\nREVIEW_KEYWORDS=\"review|check|analyze|audit|security|performance\"\nBROAD_KEYWORDS=\"how should|what's the best|recommend|approach|strategy\"\n\n# Check if prompt matches patterns (case insensitive)\nif echo \"$USER_PROMPT\" | grep -qiE \"$PLAN_KEYWORDS|$REVIEW_KEYWORDS|$BROAD_KEYWORDS\"; then\n  cat << 'EOF'\n**Peer Review Advisory:** This request may produce output that benefits from peer validation. Remember to dispatch to `gemini-peer-review:gemini-peer-reviewer` before presenting:\n- Implementation plans or designs\n- Code review findings\n- Architecture recommendations\nEOF\nfi\n",
        "plugins/gemini-peer-review/hooks/write-peer-review-check.sh": "#!/bin/bash\n# PreToolUse hook for Write: Check if writing significant implementation files\n\n# Get the file path from environment (if available)\nFILE_PATH=\"${CLAUDE_TOOL_INPUT:-}\"\n\n# Check if writing implementation files (not config, not docs, not tests)\nif echo \"$FILE_PATH\" | grep -qiE \"\\.(ts|js|py|go|rs|java|cpp|c|rb|swift|kt)$\" && \\\n   ! echo \"$FILE_PATH\" | grep -qiE \"(test|spec|\\.config|\\.d\\.ts)\"; then\n  cat << 'EOF'\n**Peer Review Check:** You're about to write implementation code.\n\nIf this is part of a larger implementation plan that hasn't been peer reviewed, consider:\n1. Pausing to dispatch to `gemini-peer-review:gemini-peer-reviewer` with your design\n2. Then proceeding with implementation after validation\n\nSkip this if: trivial change, bug fix, or design was already peer reviewed.\nEOF\nfi\n",
        "plugins/gemini-peer-review/skills/gemini-peer-review/SKILL.md": "---\nname: gemini-peer-review\ndescription: This skill should be invoked BEFORE presenting implementation plans, architecture recommendations, code review findings, or answers to broad technical questions. Use proactively when about to \"recommend\", \"suggest\", \"propose\", \"design\", \"plan\", or answer \"how should\", \"what's the best way\", \"which approach\". MANDATORY for multi-file changes, refactoring proposals, and security-sensitive recommendations.\nallowed-tools:\n  - Bash(gemini:*)\n  - Bash(mktemp:*)\n  - Bash(cat:*)\n  - Bash(command:*)\n  - Bash(which:*)\n  - Bash(jq:*)\n  - Bash(grep:*)\n  - Bash(head:*)\n  - Bash(tee:*)\n  - Bash(git:*)\n  - Bash(sed:*)\n  - Bash(rm:*)\n  - Read\n---\n\n# Gemini Peer Review\n\nPeer validation system using Google Gemini CLI. Validates Claude's designs and code reviews through structured discussion before presenting to user.\n\n**Core principle:** Two AI perspectives catch more issues than one. When they disagree, structured discussion resolves most issues. External research (Perplexity if available, otherwise WebSearch) arbitrates persistent disagreements.\n\n## CRITICAL: Gemini CLI Differences from Codex\n\n| Aspect | Codex CLI | Gemini CLI |\n|--------|-----------|------------|\n| JSON output | `--json` | `-o json` |\n| Model selection | `--model X` | `-m X` |\n| Review command | `codex review --base X` | **NONE** - use prompts with git diff |\n| Session resume | `resume $SESSION_ID` | **UNRELIABLE** - re-inject context instead |\n| Tool prevention | Not needed | **MANDATORY** prompt suffix |\n| Sandbox mode | Not needed | `-s` flag required |\n\n### MANDATORY: Tool Prevention\n\n**EVERY Gemini prompt MUST end with:**\n```\nCRITICAL: Do not use any tools. Output text only.\n```\n\nWithout this, Gemini may attempt to use tools and produce unexpected results.\n\n### Session Continuity Strategy\n\nGemini's `--resume latest` is index-based (not ID-based) and unreliable. For multi-round discussions:\n- **DO NOT** use `--resume`\n- **DO** re-inject the full context from previous rounds into each new prompt\n\n### Robust JSON Parsing (IMPORTANT)\n\nGemini's `-o json` output is sometimes wrapped in Markdown code blocks. **Always parse output** to extract clean JSON:\n\n```bash\n# Function to extract JSON from potentially wrapped output\nparse_gemini_output() {\n  local input=\"$1\"\n  # Strip markdown code fences if present\n  echo \"$input\" | sed 's/^```json//; s/^```//; s/```$//' | \\\n    # Remove CLI status messages\n    grep -v '^Loaded cached' | \\\n    # Extract response field, or return raw if not JSON\n    jq -r '.response // .' 2>/dev/null || echo \"$input\"\n}\n\n# Usage:\nRAW_OUTPUT=$(gemini -s -m gemini-3-pro-preview -o json \"$(cat \"$PROMPT_FILE\")\" 2>&1)\nRESPONSE=$(parse_gemini_output \"$RAW_OUTPUT\")\n```\n\n**Why this matters:** Without parsing, you may get output like:\n```\n```json\n{\"response\": \"actual content here\"}\n```\n```\nInstead of clean JSON.\n\n## Reference Files\n\n@discussion-protocol.md\n@escalation-criteria.md\n@common-mistakes.md\n\n## Modes of Operation\n\n### Mode 1: Auto-Trigger (Validation Only)\n\n**Triggers before Claude presents:**\n- Implementation plans or designs\n- Code review results\n- Architecture recommendations\n- Major refactoring proposals\n\n**Behavior:** Validates existing work, does not create from scratch.\n\n### Mode 2: Slash Command (Full Lifecycle)\n\n```\n/gemini-peer-review              # Review current changes\n/gemini-peer-review --base main  # Review against specific branch\n/gemini-peer-review [question]   # Validate answer to broad question\n```\n\n**Behavior:** Can both create and validate reviews/designs.\n\n## Workflow\n\n```dot\ndigraph workflow {\n    rankdir=TB;\n    node [shape=box];\n\n    start [label=\"Claude forms\\nopinion/response\" shape=ellipse];\n    dispatch [label=\"Dispatch subagent\\nwith Claude's position\"];\n    cmdselect [label=\"Select prompt type\\nbased on validation\" shape=diamond];\n    codereview [label=\"Gemini prompt\\nwith git diff\"];\n    designreview [label=\"Gemini prompt\\nfor design validation\"];\n    compare [label=\"Compare findings\" shape=diamond];\n    critical [label=\"Security/Architecture/\\nBreaking Change?\" shape=diamond style=filled fillcolor=lightyellow];\n    agree [label=\"Synthesize &\\npresent result\"];\n    round1 [label=\"Discussion Round 1:\\nState positions + evidence\"];\n    resolved1 [label=\"Resolved?\" shape=diamond];\n    round2 [label=\"Discussion Round 2:\\nDeeper analysis\\n(re-inject context)\"];\n    resolved2 [label=\"Resolved?\" shape=diamond];\n    escalate [label=\"Escalate:\\nPerplexity/WebSearch\" style=filled fillcolor=lightcoral];\n    final [label=\"Synthesize final\\nresult\" shape=ellipse];\n\n    start -> dispatch;\n    dispatch -> cmdselect;\n    cmdselect -> codereview [label=\"code review\\n(reviewing diffs)\"];\n    cmdselect -> designreview [label=\"design/plan/\\nquestion\"];\n    codereview -> compare;\n    designreview -> compare;\n    compare -> agree [label=\"aligned\"];\n    compare -> critical [label=\"disagree\"];\n    critical -> escalate [label=\"YES\\n(skip discussion)\"];\n    critical -> round1 [label=\"no\"];\n    round1 -> resolved1;\n    resolved1 -> final [label=\"yes\"];\n    resolved1 -> round2 [label=\"no\"];\n    round2 -> resolved2;\n    resolved2 -> final [label=\"yes\"];\n    resolved2 -> escalate [label=\"no\"];\n    escalate -> final;\n    agree -> final;\n}\n```\n\n**Immediate Escalation:** Security concerns, architecture conflicts, breaking changes, or order-of-magnitude performance disagreements skip discussion and escalate directly. See @escalation-criteria.md for details.\n\n## Subagent Dispatch\n\n**CRITICAL:** Always use subagent to avoid context pollution. Never run Gemini in main context.\n\n### Command Pattern (ALWAYS USE THIS)\n\n```bash\nPROMPT_FILE=$(mktemp /tmp/gemini-prompt-XXXXXX.md)\ncat > \"$PROMPT_FILE\" <<'PROMPT_EOF'\n[Your prompt content here]\n\nCRITICAL: Do not use any tools. Output text only.\nPROMPT_EOF\n\ngemini -s -m gemini-3-pro-preview -o json \"$(cat \"$PROMPT_FILE\")\"\n```\n\n### For Code Review (reviewing actual code changes)\n\n**IMPORTANT:** Since Gemini has no `review` command, you must:\n1. Get the diff using git\n2. Include it in your prompt to Gemini\n\n```bash\n# Get the diff\nDIFF=$(git diff [branch]...HEAD 2>/dev/null)\n\n# If no diff, check for uncommitted changes\nif [ -z \"$DIFF\" ]; then\n  DIFF=$(git diff 2>/dev/null)\n  STAGED_DIFF=$(git diff --staged 2>/dev/null)\nfi\n\nPROMPT_FILE=$(mktemp /tmp/gemini-prompt-XXXXXX.md)\ncat > \"$PROMPT_FILE\" <<PROMPT_EOF\nReview the following code changes for:\n- Code quality issues\n- Potential bugs\n- Security concerns\n- Edge cases\n\nFocus area: [Claude's review focus if any]\n\n\\`\\`\\`diff\n$DIFF\n\\`\\`\\`\n\nProvide specific, actionable feedback.\n\nCRITICAL: Do not use any tools. Output text only.\nPROMPT_EOF\n\ngemini -s -m gemini-3-pro-preview -o json \"$(cat \"$PROMPT_FILE\")\"\n```\n\n### For Design/Plan Validation\n\n```bash\nPROMPT_FILE=$(mktemp /tmp/gemini-prompt-XXXXXX.md)\ncat > \"$PROMPT_FILE\" <<'PROMPT_EOF'\nValidate this design/refactoring plan:\n\n[Summarize Claude's specific proposal in 2-3 sentences]\n\nFiles affected: [list specific files]\n\nCheck for:\n- Architecture issues\n- Potential problems with this approach\n- Better alternatives\n- Missing considerations\n\nProvide specific, actionable feedback.\n\nCRITICAL: Do not use any tools. Output text only.\nPROMPT_EOF\n\ngemini -s -m gemini-3-pro-preview -o json \"$(cat \"$PROMPT_FILE\")\"\n```\n\n### Validation Subagent Prompt\n\nDispatch via Task tool with prompt:\n\n```\nYou are validating Claude's analysis using Google Gemini CLI.\n\n## Claude's Position\n[Claude's findings/design/recommendations]\n\n## Scope\n- Type: [code-review|design|architecture|question]\n- Files: [relevant files - be specific!]\n\n## Task - CHOOSE THE RIGHT APPROACH\n\n### If Type is \"code-review\" (reviewing actual code changes):\n1. Get the diff: git diff [branch]...HEAD (or git diff for uncommitted)\n2. Create a Gemini prompt including the diff\n3. Run: gemini -s -m gemini-3-pro-preview -o json \"$(cat \"$PROMPT_FILE\")\"\n\n### If Type is \"design\", \"architecture\", or \"question\":\nCreate a focused validation prompt and run with gemini.\n\n**CRITICAL REMINDERS:**\n- ALWAYS end prompts with: \"CRITICAL: Do not use any tools. Output text only.\"\n- ALWAYS use -s -m gemini-3-pro-preview -o json flags\n- ALWAYS use temp files for prompts (avoid shell escaping issues)\n\n## Compare and Classify\nAfter running Gemini:\n1. Compare Gemini output to Claude's position\n2. Classify: agreement | disagreement | complement\n\n## If Uncertain Before Running Gemini\nCheck external sources first. Try Perplexity if available, otherwise use WebSearch.\n\n## Return Format\n{\n  \"outcome\": \"agreement|disagreement|complement\",\n  \"gemini_findings\": [...],\n  \"alignment\": {\n    \"agreed\": [...],\n    \"unique_to_claude\": [...],\n    \"unique_to_gemini\": [...]\n  },\n  \"discussion_needed\": boolean,\n  \"discussion_topics\": [...]\n}\n```\n\n### Discussion Subagent\n\n**IMPORTANT:** Do NOT use `--resume` flag. Re-inject context for each round.\n\n#### Round 1 (Initial Discussion)\n\n```bash\nPROMPT_FILE=$(mktemp /tmp/gemini-round1-XXXXXX.md)\ncat > \"$PROMPT_FILE\" <<'PROMPT_EOF'\nGiven this disagreement about [topic]:\n\nClaude's position: [summary with evidence]\n\nProvide your evidence-based reasoning. Reference specific code or conventions.\nWhat is your position and why?\n\nCRITICAL: Do not use any tools. Output text only.\nPROMPT_EOF\n\ngemini -s -m gemini-3-pro-preview -o json \"$(cat \"$PROMPT_FILE\")\" 2>&1 | tee /tmp/gemini_round1_$$.json\n```\n\n#### Round 2 (Context Re-injection - NOT session resume)\n\n```bash\n# Re-inject all context - do NOT use --resume\nPROMPT_FILE=$(mktemp /tmp/gemini-round2-XXXXXX.md)\ncat > \"$PROMPT_FILE\" <<'PROMPT_EOF'\nContinuing discussion about [topic]:\n\nRound 1 summary:\n- Claude's position: [summary]\n- Gemini's position: [summary from Round 1 output]\n\nClaude's Round 2 response: [new evidence from Claude]\n\nCan we reach synthesis? What is your final position?\n\nCRITICAL: Do not use any tools. Output text only.\nPROMPT_EOF\n\ngemini -s -m gemini-3-pro-preview -o json \"$(cat \"$PROMPT_FILE\")\"\n```\n\n### Arbitration Subagent\n\nWhen escalating for external research/arbitration:\n\n```\nEscalate for external arbitration.\n\n## Disagreement Context\n- Topic: [specific technical question]\n- Claude's position: [with evidence]\n- Gemini's position: [with evidence]\n- Why unresolved: [summary of discussion]\n\n## Task - Choose Available Method\n\n### Option 1: If Perplexity MCP is available\n1. Check schema: mcp-cli info perplexity/perplexity_ask\n2. Call Perplexity with neutral framing\n\n### Option 2: If Perplexity is NOT available\n1. Use WebSearch tool with a focused query\n2. Search for authoritative sources (official docs, well-known engineering blogs)\n3. Synthesize findings from multiple sources\n\n## Apply ruling to synthesis\n\n## Return Format\n{\n  \"arbitration_source\": \"perplexity|websearch\",\n  \"ruling\": \"...\",\n  \"sources\": [\"...\"],\n  \"recommended_action\": \"...\",\n  \"final_synthesis\": \"...\",\n  \"confidence\": \"high|medium\"\n}\n```\n\n## Output Formats\n\n### Agreement\n```markdown\n## Peer Review Result\n**Status:** Validated\n**Confidence:** High (both AIs aligned)\n\n[Synthesized recommendations with both perspectives merged]\n```\n\n### Resolved Disagreement\n```markdown\n## Peer Review Result\n**Status:** Resolved through discussion\n\n**Initial Positions:**\n- Claude: [position]\n- Gemini: [position]\n\n**Resolution:** [how resolved, which evidence won]\n\n**Final Recommendation:** [synthesized view]\n**Confidence:** Medium-High\n```\n\n### External Research Arbitration\n```markdown\n## Peer Review Result\n**Status:** Escalated for external research\n**Source:** [Perplexity | WebSearch]\n\n**Disagreement:** [nature of conflict]\n\n**Research Findings:** [authoritative answer]\n**Sources:** [URLs if from WebSearch]\n\n**Final Recommendation:** [based on findings + context]\n**Confidence:** High (expert arbitration) | Medium (if WebSearch was inconclusive)\n```\n\n## Prerequisites\n\n**Before using this skill, verify the following:**\n\n```bash\n# 1. Check if Gemini CLI is installed\nif ! command -v gemini &>/dev/null; then\n  echo \"ERROR: Gemini CLI not installed.\"\n  exit 1\nfi\n\n# 2. Check version (should be 0.24.5 or later)\ngemini --version\n\n# 3. Optional: Check for jq (improves JSON parsing)\ncommand -v jq &>/dev/null || echo \"TIP: Install jq for better JSON parsing: brew install jq\"\n```\n\n**If Gemini CLI is not available:**\n- The skill will not work for peer review or design validation\n- You can still use WebSearch for escalation/arbitration\n- Inform the user: \"Gemini CLI is required for peer review.\"\n\n## Quick Reference\n\n| Scenario | Gemini Approach | Notes |\n|----------|-----------------|-------|\n| About to present design/plan | Prompt with design details | Include NO_TOOLS suffix |\n| About to present code review | Prompt with git diff | Get diff first, then prompt |\n| About to present refactoring | Prompt with proposal | Be specific about files |\n| About to present architecture | Prompt with recommendation | Include context |\n| User asks broad question | Prompt with question | Validate answer |\n| Gemini agrees | Synthesize and present | Both AIs aligned |\n| Gemini disagrees | Start discussion protocol | Max 2 rounds |\n| Two rounds fail | Perplexity/WebSearch | Escalate for research |\n| Major issue (security) | Perplexity/WebSearch | Immediate escalation |\n\n**Key reminders:**\n- Use `gemini -s -m gemini-3-pro-preview -o json` always\n- End EVERY prompt with: `CRITICAL: Do not use any tools. Output text only.`\n- Use temp files for prompts (avoid shell escaping)\n- Re-inject context for discussion rounds (don't use --resume)\n",
        "plugins/gemini-peer-review/skills/gemini-peer-review/common-mistakes.md": "# Common Mistakes and Rationalizations\n\nAnti-patterns that undermine peer review effectiveness. When you catch yourself thinking these things, stop and correct course.\n\n## Gemini-Specific Mistakes (CRITICAL)\n\n### Forgetting the NO_TOOLS Instruction\n\n**This is the #1 Gemini-specific mistake.**\n\n| Wrong | Right |\n|-------|-------|\n| `gemini -s -m gemini-3-pro-preview \"Review this code...\"` | `gemini -s -m gemini-3-pro-preview \"Review this code... CRITICAL: Do not use any tools. Output text only.\"` |\n\n**EVERY prompt to Gemini MUST end with:**\n```\nCRITICAL: Do not use any tools. Output text only.\n```\n\nWithout this, Gemini may attempt to use tools, browse files, or perform actions that produce unexpected results.\n\n### Using --resume (Unreliable)\n\n| Rationalization | Reality | Correct Action |\n|-----------------|---------|----------------|\n| \"I'll just use --resume latest\" | Gemini's resume is index-based, not ID-based | Re-inject full context instead |\n| \"It worked last time\" | Index changes between sessions | Never rely on --resume |\n| \"Context re-injection is verbose\" | Verbose but reliable | Always re-inject for Round 2 |\n\n**Rule:** Never use `--resume` with Gemini. Always re-inject the full discussion context.\n\n### Using Wrong Output Format\n\n| Wrong | Right |\n|-------|-------|\n| `gemini -s -m gemini-3-pro-preview -o text` | `gemini -s -m gemini-3-pro-preview -o json` |\n| `gemini -s -m gemini-3-pro-preview` (no format) | `gemini -s -m gemini-3-pro-preview -o json` |\n\n**Always use `-o json`** for structured, parseable output.\n\n### Not Parsing JSON Output (Fragile)\n\n| Rationalization | Reality | Correct Action |\n|-----------------|---------|----------------|\n| \"It's JSON, I can use it directly\" | Gemini often wraps JSON in Markdown code blocks | Always parse output |\n| \"jq will handle it\" | jq fails on ` ```json ... ``` ` wrapped content | Strip code fences first |\n| \"I'll just read the raw output\" | CLI status messages pollute the output | Filter and parse |\n\n**Always parse Gemini output to handle Markdown wrapping:**\n```bash\n# Wrong - assumes clean JSON\ngemini -s -m gemini-3-pro-preview -o json \"prompt\" | jq '.response'\n\n# Right - handles wrapped output\nRAW=$(gemini -s -m gemini-3-pro-preview -o json \"prompt\" 2>&1)\nRESPONSE=$(echo \"$RAW\" | sed 's/^```json//; s/^```//; s/```$//' | grep -v '^Loaded cached' | jq -r '.response // .' 2>/dev/null || echo \"$RAW\")\n```\n\n### Forgetting Sandbox Flag\n\n| Wrong | Right |\n|-------|-------|\n| `gemini -m gemini-3-pro-preview -o json` | `gemini -s -m gemini-3-pro-preview -o json` |\n\n**Always use `-s`** (sandbox mode) to prevent unintended side effects.\n\n### Trying to Use `gemini review`\n\n| Wrong | Right |\n|-------|-------|\n| `gemini review --base main` | Get diff with `git diff main...HEAD`, then prompt Gemini |\n| `gemini review --uncommitted` | Get diff with `git diff`, then prompt Gemini |\n\n**Gemini has NO `review` command.** Always construct a prompt that includes the diff.\n\n### Using Wrong Model\n\n| Wrong | Right |\n|-------|-------|\n| `gemini -s -m gemini-2.5-pro -o json` | `gemini -s -m gemini-3-pro-preview -o json` |\n| `gemini -s -m gemini-2.5-flash -o json` | `gemini -s -m gemini-3-pro-preview -o json` |\n\n**Always use `gemini-3-pro-preview`** as the default model.\n\n### Shell Escaping Issues\n\n| Rationalization | Reality | Correct Action |\n|-----------------|---------|----------------|\n| \"I'll just escape the quotes\" | Complex prompts break with inline escaping | Use temp files |\n| \"Short prompt, it'll be fine\" | Even short prompts can have issues | Use temp files always |\n\n**Always use temp files for prompts:**\n```bash\nPROMPT_FILE=$(mktemp /tmp/gemini-prompt-XXXXXX.md)\ncat > \"$PROMPT_FILE\" <<'PROMPT_EOF'\n[Your prompt here]\n\nCRITICAL: Do not use any tools. Output text only.\nPROMPT_EOF\n\ngemini -s -m gemini-3-pro-preview -o json \"$(cat \"$PROMPT_FILE\")\"\n```\n\n## General Peer Review Mistakes\n\n### Skipping Validation\n\n| Rationalization | Reality | Correct Action |\n|-----------------|---------|----------------|\n| \"It's just a typo fix\" | Typo fixes can break builds, introduce bugs | Validate anyway |\n| \"I'm confident in this design\" | Blind spots exist in every analysis | Validate anyway |\n| \"Gemini will just agree\" | Often finds different issues you missed | Let it check |\n| \"User is waiting\" | Bad advice wastes more time than validation | Validate first |\n| \"Similar to last time\" | Context changes, different edge cases | Validate each time |\n| \"This is too simple\" | Simple things have hidden complexity | Validate anyway |\n| \"I already checked everything\" | Fresh perspective catches what you normalized | Validate anyway |\n\n**Rule:** If you're presenting a design, code review, or answering a broad question, validate with Gemini.\n\n### Premature Agreement\n\n| Rationalization | Reality | Correct Action |\n|-----------------|---------|----------------|\n| \"Gemini is probably right\" | Both AIs can be wrong | Verify with evidence |\n| \"Don't want to argue with AI\" | Technical truth matters more than peace | State your position |\n| \"Let's just pick one\" | Both might have valid points | Synthesize |\n| \"Two rounds is enough\" | Major issues need proper resolution | Escalate if needed |\n| \"It doesn't matter much\" | Small decisions compound | Decide correctly |\n| \"Whatever is faster\" | Fast wrong is slower than slow right | Take time to verify |\n\n**Rule:** Agreement should be based on evidence, not convenience.\n\n### Avoiding Escalation\n\n| Rationalization | Reality | Correct Action |\n|-----------------|---------|----------------|\n| \"External research is overkill\" | Expert input prevents costly errors | Use for major disputes |\n| \"We've discussed enough\" | Unresolved stays unresolved | Escalate |\n| \"Security concern seems minor\" | Security is never minor | Always escalate security |\n| \"Don't want to slow down\" | Wrong decisions cost more time | Take time to escalate |\n| \"We can figure it out\" | Two rounds failed; third won't help | Escalate |\n| \"User won't notice\" | Users notice bugs and security issues | Escalate |\n| \"Perplexity isn't available\" | WebSearch is a valid fallback | Use WebSearch instead |\n\n**Rule:** If two rounds don't resolve it, escalate (Perplexity if available, WebSearch otherwise). If it's security, escalate immediately.\n\n### Over-Escalation\n\n| Rationalization | Reality | Correct Action |\n|-----------------|---------|----------------|\n| \"Better safe than sorry\" | Style != safety | Reserve for real disputes |\n| \"Let external research decide everything\" | Wastes time and resources | Try discussion first |\n| \"Not sure about anything\" | Build confidence through process | Trust the protocol |\n| \"User will appreciate thoroughness\" | User wants efficiency | Be judicious |\n\n**Rule:** Escalate major disagreements, not minor preferences.\n\n### Subagent Misuse\n\n| Rationalization | Reality | Correct Action |\n|-----------------|---------|----------------|\n| \"I'll run Gemini in main context\" | Fills context unnecessarily | Use subagent |\n| \"Subagent is slower\" | Context pollution is worse | Use subagent |\n| \"I need to see Gemini output live\" | Summary is sufficient | Trust subagent |\n| \"One quick check won't hurt\" | Sets bad precedent | Use subagent always |\n\n**Rule:** Always dispatch Gemini via subagent to preserve main context.\n\n### Guessing the Base Branch\n\n| Rationalization | Reality | Correct Action |\n|-----------------|---------|----------------|\n| \"It's probably main\" | Projects use different conventions | Ask the user |\n| \"I can auto-detect with git\" | Detection can fail or be wrong | Ask the user |\n| \"User won't want to be asked\" | Wrong branch = useless review | Ask the user |\n| \"develop is the standard\" | Many projects use main, master, trunk, etc. | Ask the user |\n\n**Rule:** If the base branch is not explicitly provided, use `AskUserQuestion` to ask the user. Never guess.\n\n## Discussion Anti-Patterns\n\n### Echo Chamber\n- **Symptom:** Restating same position with different words\n- **Fix:** Require new evidence in each round\n\n### Goalpost Moving\n- **Symptom:** Disagreement shifts to new topic mid-discussion\n- **Fix:** Lock in original dispute, address others separately\n\n### Appeal to Authority\n- **Symptom:** \"Claude/Gemini is usually right about this\"\n- **Fix:** Require codebase evidence, not reputation\n\n### False Consensus\n- **Symptom:** Claiming agreement when positions still differ\n- **Fix:** Require explicit position statements that match\n\n### Sunk Cost Fallacy\n- **Symptom:** \"We've discussed so long, let's just go with X\"\n- **Fix:** Escalate if truly unresolved\n\n## Recovery Strategies\n\n### If validation was skipped\n1. Stop presenting result\n2. Trigger validation now\n3. Update recommendation if needed\n4. Explain the update honestly\n\n### If wrong conclusion reached\n1. Acknowledge the error\n2. Show correct analysis\n3. Explain what was missed\n4. Document for future\n\n### If escalation needed after presentation\n1. Inform user of uncertainty\n2. Escalate to Perplexity/WebSearch\n3. Update recommendation\n4. Note correction in output\n\n## Red Flags - STOP and Check\n\nIf you think any of these, pause and reconsider:\n\n- \"This doesn't need validation\"\n- \"Gemini will just agree anyway\"\n- \"Security issue is probably fine\"\n- \"No time for peer review\"\n- \"I'll skip the subagent just this once\"\n- \"Discussion is taking too long\"\n- \"Let's not bother with external research\"\n- \"User won't care about this detail\"\n- \"The base branch is probably main/develop\"\n- \"I can figure out the base branch from git\"\n- \"I don't need the NO_TOOLS instruction this time\"\n- \"I'll just use --resume to continue\"\n- \"Temp files are overkill for this prompt\"\n\n**All of these mean:** You should do the opposite of what you're considering.\n",
        "plugins/gemini-peer-review/skills/gemini-peer-review/discussion-protocol.md": "# Discussion Protocol: Claude vs Gemini\n\nStructured 2-round resolution of disagreements through evidence-based discussion.\n\n## Gemini-Specific Note\n\n**Session Continuity:** Unlike Codex which uses session IDs for context continuity, Gemini's `--resume` is index-based and unreliable. For multi-round discussions, **re-inject the full context** from previous rounds into each new prompt. This ensures Gemini has complete context without relying on session resume.\n\n## Protocol Rules\n\n### Rule 1: Evidence Required (When Available)\nEvery position should cite evidence from these categories **as applicable**:\n- Specific code lines or files (for code review discussions)\n- Project conventions (from CLAUDE.md or equivalent)\n- Industry best practices (with source)\n- Test results or behavior observations\n\n**For design/architecture discussions** where code doesn't exist yet, acceptable evidence includes:\n- Analogous patterns from existing codebase\n- Industry case studies or engineering blog posts\n- Framework/language documentation\n- Threat modeling or risk analysis\n- RFCs or design documents\n\n### Rule 2: Two Round Maximum\n- Round 1: State positions, provide evidence\n- Round 2: Respond to evidence, attempt synthesis\n- After Round 2: Escalate or accept synthesis\n\n### Rule 3: Good Faith\n- Assume the other AI has valid reasoning\n- Look for complementary insights\n- Seek \"both right in different ways\" resolutions\n\n### Rule 4: Context Re-injection (Gemini-Specific)\n- **DO NOT** use `--resume` flag with Gemini\n- **DO** re-inject all relevant context from Round 1 into Round 2 prompts\n- Include: Claude's position, Gemini's Round 1 response, new evidence\n- This maintains full context without relying on unreliable session resume\n\n### Rule 5: Classify Disagreement Type\n\n| Type | Definition | Action |\n|------|------------|--------|\n| Contradiction | Mutually exclusive positions | Must resolve one way |\n| Complement | Both valid, additive | Synthesize both |\n| Priority | Different ranking of same issues | Use project context |\n| Scope | Different interpretation of task | Clarify before proceeding |\n\n## Round 1 Structure\n\n### Claude's Opening\n```yaml\nposition: \"[Clear statement of recommendation]\"\nevidence:\n  - code: \"[specific file:line or pattern]\"\n  - convention: \"[from project standards]\"\n  - rationale: \"[technical reasoning]\"\nconfidence: \"[high|medium|low]\"\nopen_to: \"[what evidence would change your mind]\"\n```\n\n### Gemini's Response (via subagent with context re-injection)\n\n```bash\nPROMPT_FILE=$(mktemp /tmp/gemini-round1-XXXXXX.md)\ncat > \"$PROMPT_FILE\" <<'PROMPT_EOF'\nGiven this technical disagreement:\n\nClaude's position: [position]\nClaude's evidence:\n- Code: [specific reference]\n- Convention: [from project standards]\n- Rationale: [technical reasoning]\n\nProvide your position on this matter:\n1. Where do you agree with Claude?\n2. Where do you disagree?\n3. What counter-evidence do you have?\n\nBe specific and reference code or standards where possible.\n\nCRITICAL: Do not use any tools. Output text only.\nPROMPT_EOF\n\ngemini -s -m gemini-3-pro-preview -o json \"$(cat \"$PROMPT_FILE\")\"\n```\n\n### Round 1 Outcome\n```yaml\noutcome: \"[resolved|unresolved]\"\nsynthesis: \"[if resolved, the merged view]\"\nremaining_issues: \"[if unresolved, specific points to address]\"\n```\n\n## Round 2 Structure\n\n### Focus\nAddress ONLY `remaining_issues` from Round 1. No new topics.\n\n### Claude's Response\n```yaml\naddressing: \"[specific remaining issue]\"\nnew_evidence: \"[something not presented in Round 1]\"\nconcession: \"[what I now agree with from Gemini]\"\nmaintained: \"[what I still believe, with stronger reasoning]\"\n```\n\n### Gemini's Response (via subagent with FULL context re-injection)\n\n```bash\nPROMPT_FILE=$(mktemp /tmp/gemini-round2-XXXXXX.md)\ncat > \"$PROMPT_FILE\" <<'PROMPT_EOF'\nContinuing discussion about [topic]:\n\n## Round 1 Summary\nClaude's original position: [summary]\nGemini's Round 1 position: [summary from Round 1 output]\nRemaining issue: [the unresolved point]\n\n## Round 2 Input\nClaude's new evidence: [new evidence]\nClaude's concession: [what Claude now agrees with]\nClaude's maintained position: [what Claude still believes]\n\n## Your Task\n1. Consider Claude's new evidence\n2. Attempt to synthesize a resolution\n3. If synthesis is possible, propose it\n4. If not, explain why positions remain incompatible\n\nCRITICAL: Do not use any tools. Output text only.\nPROMPT_EOF\n\ngemini -s -m gemini-3-pro-preview -o json \"$(cat \"$PROMPT_FILE\")\"\n```\n\n### Round 2 Outcome\n```yaml\noutcome: \"[resolved|escalate]\"\nfinal_synthesis: \"[if resolved, the agreed approach]\"\nescalation_reason: \"[if escalating, why discussion failed]\"\nescalation_question: \"[precise question for Perplexity/WebSearch]\"\n```\n\n## Example Discussion\n\n### Setup\n- Claude: \"This function should use a Result/Either type for error handling\"\n- Gemini: \"The current exception-based approach is clearer for this codebase\"\n\n### Round 1\n\n**Claude:**\n```yaml\nposition: \"Use Result type for explicit error handling\"\nevidence:\n  - code: \"user_service.py:45 returns None on not-found\"\n  - convention: \"Project uses type hints extensively\"\n  - rationale: \"Result types are more expressive and statically checkable\"\nconfidence: \"high\"\nopen_to: \"Performance concerns or team familiarity arguments\"\n```\n\n**Gemini (via prompt with context):**\n```yaml\nposition: \"Keep exception-based error handling\"\nagreement_areas: \"Explicit error handling is important\"\ndisagreement_areas: \"Implementation approach\"\ncounter_evidence:\n  - code: \"Other methods in user_service use exceptions consistently\"\n  - rationale: \"Consistency within module aids readability\"\n```\n\n**Round 1 Outcome:**\n```yaml\noutcome: \"unresolved\"\nsynthesis: null\nremaining_issues:\n  - \"Module consistency vs modern idiom adoption\"\n```\n\n### Round 2\n\n**Claude:**\n```yaml\naddressing: \"Module consistency vs modern idiom\"\nnew_evidence: \"Git history shows 3 commits in last month adopting Result types elsewhere\"\nconcession: \"Consistency matters for readability\"\nmaintained: \"Migration is already underway, this continues the pattern\"\n```\n\n**Gemini (via prompt with full context re-injection):**\n```yaml\naddressing: \"Module consistency vs modern idiom\"\nresponse_to_evidence: \"Migration trend is valid context I missed\"\nproposed_synthesis: \"Use Result type here, add TODO for full module migration\"\n```\n\n**Round 2 Outcome:**\n```yaml\noutcome: \"resolved\"\nfinal_synthesis: \"Use Result type with TODO comment for module-wide migration\"\n```\n\n## When Discussion Fails\n\nIf after Round 2:\n- Positions remain fundamentally opposed\n- Evidence is inconclusive on both sides\n- Stakes are high (security, architecture, breaking changes)\n\nThen escalate with precise question:\n\n```\nGiven [specific context], should [option A] or [option B] be used?\n\nContext:\n- Codebase: [language/framework]\n- Existing patterns: [relevant patterns]\n- Constraints: [any constraints]\n\nClaude's position: [summary with key evidence]\nGemini's position: [summary with key evidence]\n\nWhich approach is correct and why?\n```\n\n## Anti-Patterns\n\n### Bad Discussion\n- **Echo Chamber:** Restating positions without new evidence\n- **Goalpost Moving:** Changing the disagreement mid-discussion\n- **Appeal to Authority:** \"Gemini/Claude is usually right\"\n- **False Consensus:** Claiming agreement without actual alignment\n\n### Good Discussion\n- **Evidence-Based:** Every claim backed by code or standards\n- **Focused:** One issue at a time\n- **Constructive:** Seeking synthesis, not victory\n- **Honest:** Acknowledging uncertainty and conceding valid points\n",
        "plugins/gemini-peer-review/skills/gemini-peer-review/escalation-criteria.md": "# Escalation Criteria\n\nWhen to escalate disagreements for external research and authoritative resolution.\n\n**Note:** Use Perplexity MCP if available. If Perplexity is not available, use WebSearch tool instead.\n\n## Immediate Escalation (Skip Discussion)\n\nThese trigger direct escalation to external research - do not attempt discussion rounds:\n\n| Category | Examples | Why Skip Discussion |\n|----------|----------|---------------------|\n| Security | Auth bypass, injection, secrets exposure | Risk too high for debate |\n| Architecture | Fundamental design conflicts | Need expert judgment |\n| Breaking Changes | Backward compatibility disputes | Impact too broad |\n| Performance | Order-of-magnitude disagreements | Need verification |\n\n**Rule:** If either AI flags a security concern, escalate immediately regardless of the other's opinion.\n\n## Escalation After Discussion\n\nAfter completing 2 discussion rounds, escalate if ANY of these apply:\n\n### 1. No Convergence\n- Positions remain fundamentally opposed\n- New evidence in Round 2 didn't shift either position\n- Both AIs maintain high confidence in conflicting views\n\n### 2. Low Confidence, High Stakes\n- Neither AI can provide strong evidence\n- But the decision has significant consequences\n- \"We're both guessing on something important\"\n\n### 3. Novel Situation\n- Neither AI has clear precedent to cite\n- Project conventions don't cover this case\n- Industry standards are ambiguous or conflicting\n\n### 4. Factual Dispute\n- Disagreement is about verifiable facts\n- One AI might be working from outdated information\n- External research can provide authoritative answer\n\n## Do NOT Escalate\n\nReserve external research for genuine disputes. Do not escalate:\n\n| Category | Why Not | Resolution |\n|----------|---------|------------|\n| Minor style disagreements | Not worth expert time | Defer to project conventions |\n| Documentation wording | Subjective preference | Defer to Claude (user context) |\n| Test coverage thresholds | Project-specific | Use project standards |\n| Naming conventions | Style guide territory | Use project standards |\n| Formatting preferences | Tooling handles this | Use formatter config |\n\n## Escalation Message Templates\n\nWhen escalating, frame the question neutrally.\n\n### Option 1: Perplexity MCP (if available)\n\n```json\n{\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"You are a senior software architect arbitrating between two AI code reviewers. Provide definitive guidance based on industry best practices and the specific context provided. Be direct and decisive.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"## Disagreement Context\\n\\n**Topic:** [specific technical question]\\n**Codebase:** [language/framework/version]\\n**Project Context:** [relevant constraints or patterns]\\n\\n**Claude's Position:**\\n[position summary]\\n- Evidence: [key evidence]\\n- Reasoning: [technical reasoning]\\n\\n**Gemini's Position:**\\n[position summary]\\n- Evidence: [key evidence]\\n- Reasoning: [technical reasoning]\\n\\n**Discussion Summary:**\\n[what was tried, why it didn't resolve]\\n\\n**Question:** Which approach is correct for this situation and why? Please be decisive.\"\n    }\n  ]\n}\n```\n\n### Option 2: WebSearch (if Perplexity not available)\n\nUse the WebSearch tool with focused queries:\n\n```\nPrimary query: \"[specific technical question] best practices [language/framework] [year]\"\n\nFollow-up queries if needed:\n- \"[Option A approach] vs [Option B approach] [language]\"\n- \"[specific pattern] official documentation [framework]\"\n```\n\nLook for:\n- Official documentation\n- Well-known engineering blogs (Google, Netflix, Uber, etc.)\n- Stack Overflow answers with high votes and recent activity\n- Language/framework RFCs or design documents\n\n## Handling External Research Response\n\n### Accept as Authoritative\n- For this specific case, the research ruling is final\n- Do not re-litigate after receiving response\n- Apply ruling to the synthesis\n\n### Document for Future\n- Note the ruling in the final output\n- Include source URLs when using WebSearch\n- If pattern emerges, consider adding to project standards\n- Help user understand the reasoning\n\n### If Research is Inconclusive\nIf external research can't provide a clear answer:\n1. Present both options to user with tradeoffs\n2. Note the sources consulted and why they were inconclusive\n3. Let user make final decision\n4. Do not guess or flip a coin\n\n## Escalation Flowchart\n\n```\nDisagreement detected\n        |\n        v\nIs it security/architecture/breaking?\n        |\n    Yes |  No\n        |   |\n        v   v\n   ESCALATE   Start Round 1\n   NOW              |\n                    v\n              Resolved?\n                |\n            Yes | No\n                |  |\n                v  v\n            Done   Round 2\n                      |\n                      v\n                 Resolved?\n                   |\n               Yes | No\n                   |  |\n                   v  v\n               Done   Any major issue\n                      OR no convergence?\n                         |\n                     Yes | No (minor)\n                         |  |\n                         v  v\n                    ESCALATE  Accept\n                    NOW       partial\n                              agreement\n```\n"
      },
      "plugins": [
        {
          "name": "gemini-peer-review",
          "version": "1.0.0",
          "description": "Peer validation system using Google Gemini CLI. Validates Claude's designs and code reviews through structured discussion before presenting to user.",
          "author": {
            "name": "slb350"
          },
          "source": "./plugins/gemini-peer-review",
          "category": "code-quality",
          "tags": [
            "peer-review",
            "code-review",
            "validation",
            "gemini",
            "ai-collaboration"
          ],
          "categories": [
            "ai-collaboration",
            "code-quality",
            "code-review",
            "gemini",
            "peer-review",
            "validation"
          ],
          "install_commands": [
            "/plugin marketplace add slb350/gemini-peer-review",
            "/plugin install gemini-peer-review@gemini-peer-review"
          ]
        }
      ]
    }
  ]
}